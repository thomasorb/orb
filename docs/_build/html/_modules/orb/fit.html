<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>orb.fit &#8212; orb 3.0.1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '3.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for orb.fit</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/python</span>
<span class="c1"># *-* coding: utf-8 *-*</span>
<span class="c1"># Author: Thomas Martin &lt;thomas.martin.1@ulaval.ca&gt;</span>
<span class="c1"># File: fit.py</span>

<span class="c1">## Copyright (c) 2010-2016 Thomas Martin &lt;thomas.martin.1@ulaval.ca&gt;</span>
<span class="c1">## </span>
<span class="c1">## This file is part of ORB</span>
<span class="c1">##</span>
<span class="c1">## ORB is free software: you can redistribute it and/or modify it</span>
<span class="c1">## under the terms of the GNU General Public License as published by</span>
<span class="c1">## the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1">## (at your option) any later version.</span>
<span class="c1">##</span>
<span class="c1">## ORB is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="c1">## ANY WARRANTY; without even the implied warranty of MERCHANTABILITY</span>
<span class="c1">## or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public</span>
<span class="c1">## License for more details.</span>
<span class="c1">##</span>
<span class="c1">## You should have received a copy of the GNU General Public License</span>
<span class="c1">## along with ORB.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="sd">&quot;&quot;&quot;Fit module of ORB.</span>

<span class="sd">Defines the general Fitting classes and the fitting models. </span>

<span class="sd">Best accessed through fit_lines_in_*() functions (defined at the end</span>
<span class="sd">of the file)</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Thomas Martin&quot;</span>
<span class="n">__licence__</span> <span class="o">=</span> <span class="s2">&quot;Thomas Martin (thomas.martin.1@ulaval.ca)&quot;</span>       


<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span>
<span class="kn">import</span> <span class="nn">scipy.interpolate</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">emcee</span>

<span class="kn">import</span> <span class="nn">utils.fft</span>
<span class="kn">import</span> <span class="nn">cutils</span>
<span class="kn">import</span> <span class="nn">constants</span>
<span class="kn">import</span> <span class="nn">utils.spectrum</span>
<span class="kn">import</span> <span class="nn">utils.fit</span>

<span class="kn">import</span> <span class="nn">gvar</span>
<span class="kn">import</span> <span class="nn">lsqfit</span>

<span class="kn">from</span> <span class="nn">core</span> <span class="k">import</span> <span class="n">Lines</span>

<div class="viewcode-block" id="FitVector"><a class="viewcode-back" href="../../orb.html#orb.fit.FitVector">[docs]</a><span class="k">class</span> <span class="nc">FitVector</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    General fitting class for a 1d array of data based on</span>
<span class="sd">    Levenberg-Marquardt least square fit algorithm.</span>

<span class="sd">    Accept any combination of models (based on :py:class:`fit.Model`)</span>

<span class="sd">    .. note:: This class is a wrapper around</span>
<span class="sd">      :py:meth:`scipy.optimize.leastsq`. Most of its purpose consists</span>
<span class="sd">      in passing an array of purely free parameters to</span>
<span class="sd">      :py:meth:`scipy.optimize.leastsq` and creating the objective</span>
<span class="sd">      function from free and fixed parameters by combining the</span>
<span class="sd">      different models. </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">models</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">models_operation</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">models_operations</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="s1">&#39;mult&#39;</span><span class="p">]</span>
    <span class="n">vector</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">priors_list</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">priors_keys_list</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">max_fev</span> <span class="o">=</span> <span class="mi">5000</span>
    <span class="n">fit_tol</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vector</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">snr_guess</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">fit_tol</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">signal_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">classic</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Init class.</span>

<span class="sd">        :param vector: Vector to fit</span>
<span class="sd">        </span>
<span class="sd">        :param models: list of models to combine. Must be a list of</span>
<span class="sd">          couples (models, model_operation). A model must be a class</span>
<span class="sd">          which derives from :py:class:`orb.fit.Model`. Model</span>
<span class="sd">          operation mist be &#39;add&#39; if the model has to be added to the</span>
<span class="sd">          others or &#39;mult&#39; if it has to be multiplied with the</span>
<span class="sd">          others. Models are combined in the order of the</span>
<span class="sd">          list. e.g. [(Model1, &#39;add&#39;), (Model2, &#39;mult&#39;), ...].</span>

<span class="sd">        :param params: list of parameters dictionaries for each</span>
<span class="sd">          model. Needed parameters are defined in each model.</span>

<span class="sd">        :param snr_guess: (Optional) Guess on the SNR of the given</span>
<span class="sd">          vector of data (default None).</span>

<span class="sd">        :param fit_tol: (Optional) Fit tolerance (default 1e-10)</span>

<span class="sd">        :param signal_range: (Optional) couple (min, max) defining the</span>
<span class="sd">          range of values considered in the fitting process.</span>

<span class="sd">        :param classic: (Optional) If True, fit is forced to be</span>
<span class="sd">          classic. i.e. It makes no use of the priors std (default False).</span>
<span class="sd">        &quot;&quot;&quot;</span>       
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;models must be a tuple of (model, model_operation).&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;params must be a tuple of parameter dictionaries.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;there must be exactly one parameter dictionary by model&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vector</span> <span class="o">=</span> <span class="n">gvar</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">vector</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_tol</span> <span class="o">=</span> <span class="n">fit_tol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalization_coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vector</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vector</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vector</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalization_coeff</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">classic</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">classic</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">classic</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">snr_guess</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">snr_guess</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">classic</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No SNR guess given. Fit mode is classic.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">snr_guess</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">snr_guess</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;SNR guess is </span><span class="si">{}</span><span class="s1"> but it must be a single number&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">snr_guess</span><span class="p">)))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">snr_guess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">snr_guess</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">snr_guess</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">retry_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models_operation</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priors_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">priors_keys_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">)):</span>
            <span class="c1"># init each model</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">](</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models_operations</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">models_operation</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Model operation must be in </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">models_operations</span><span class="p">))</span>
            <span class="c1"># guess nan values for each model</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">make_guess</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vector</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">priors_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_priors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">classic</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">priors_keys_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">priors_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">all_keys_index</span> <span class="o">=</span> <span class="kc">None</span>

        
        <span class="k">if</span> <span class="n">signal_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">signal_range</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span>
                <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">signal_range</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">signal_range</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">signal_range</span><span class="p">)),</span>
                                     <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">signal_range</span><span class="p">))]</span>
            
            <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Bad signal range: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">signal_range</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">signal_range</span> <span class="o">=</span> <span class="kc">None</span>    

    <span class="k">def</span> <span class="nf">_all_p_list2dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Concatenate a list of free parameters into a dictionary</span>
<span class="sd">        ready to be passed to the fit function.</span>

<span class="sd">        :param p_list: List of free parameters. This list is a list of</span>
<span class="sd">          tuple of parameters. Each tuple defining the free parameters</span>
<span class="sd">          for each model, i.e. : ([free_params_model1],</span>
<span class="sd">          [free_params_model2], ...)</span>

<span class="sd">        .. seealso:: :py:meth:`fit.FitVector._all_p_dict2list`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">all_p</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">p_list</span><span class="p">:</span>
            <span class="c1"># check if two parameters have the same key</span>
            <span class="k">for</span> <span class="n">_k</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">_k</span> <span class="ow">in</span> <span class="n">all_p</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Two parameters are sharing the same key: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_k</span><span class="p">))</span>
            <span class="n">all_p</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">all_p</span>

    <span class="k">def</span> <span class="nf">_all_p_dict2list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_vect</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Transform a dictionnary of free parameters as returned by</span>
<span class="sd">        the fit function into a list of free parameters (see</span>
<span class="sd">        :py:meth:`fit.FitVector._all_p_list2dict`)</span>

<span class="sd">        :param p_vect: dictionnary of free parameters.</span>

<span class="sd">        .. seealso:: :py:meth:`fit.FitVector._all_p_list2dict`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p_vect</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">p_vect</span> <span class="o">=</span> <span class="n">p_vect</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">p_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">last_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">keys_list</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">priors_keys_list</span><span class="p">:</span>
            <span class="n">ip_list</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys_list</span><span class="p">:</span>
                <span class="c1"># remove log(prior), sqrt(prior) from the list</span>
                <span class="k">if</span> <span class="s1">&#39;log&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                    <span class="n">ip_list</span><span class="p">[</span><span class="n">key</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">p_vect</span><span class="p">[</span><span class="n">key</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
                <span class="k">elif</span> <span class="s1">&#39;sqrt&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                    <span class="n">ip_list</span><span class="p">[</span><span class="n">key</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">p_vect</span><span class="p">[</span><span class="n">key</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
                <span class="k">elif</span> <span class="s1">&#39;erfinv&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                    <span class="n">ip_list</span><span class="p">[</span><span class="n">key</span><span class="p">[</span><span class="mi">7</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">p_vect</span><span class="p">[</span><span class="n">key</span><span class="p">[</span><span class="mi">7</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ip_list</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_vect</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">p_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ip_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">p_list</span>

    <span class="k">def</span> <span class="nf">_all_p_dict2arr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a 1d array of free parameters from a dictionary of</span>
<span class="sd">        free parameters.</span>

<span class="sd">        :param p_dict: Free parameters dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">classic</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Fit must be in classic mode&#39;</span><span class="p">)</span>

        <span class="c1"># check keys and create all_keys_index</span>
        <span class="n">all_keys_index</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">keys_list</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">priors_keys_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys_list</span><span class="p">:</span>
                <span class="n">all_keys_index</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span>
                <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">all_keys_index</span><span class="o">.</span><span class="n">viewkeys</span><span class="p">()</span> <span class="o">!=</span> <span class="n">p_dict</span><span class="o">.</span><span class="n">viewkeys</span><span class="p">():</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
            <span class="s1">&#39;Badly formatted input dict&#39;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">all_keys_index</span> <span class="o">=</span> <span class="n">all_keys_index</span> <span class="c1"># save keys--index dict</span>

        <span class="n">p_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_keys_index</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_keys_index</span><span class="p">:</span>
            <span class="n">p_arr</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">all_keys_index</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span> <span class="o">=</span> <span class="n">gvar</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">p_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            
        <span class="k">return</span> <span class="n">p_arr</span>

    <span class="k">def</span> <span class="nf">_all_p_arr2dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_arr</span><span class="p">,</span> <span class="n">keep_gvar</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a dict of free parameters from a 1d array of</span>
<span class="sd">        free parameters.</span>

<span class="sd">        :param p_arr: Free parameters array</span>

<span class="sd">        :param keep_gvar: (Optional) If True, gvar values of the</span>
<span class="sd">          parameters are kept. Else they are converted to float</span>
<span class="sd">          (default False).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_keys_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;self._all_p_dict2arr() must be called first&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">classic</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Fit must be in classic mode&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">p_arr</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_keys_index</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Badly formatted input array of free parameters&#39;</span><span class="p">)</span>

        <span class="n">p_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_keys_index</span><span class="p">:</span>
            <span class="n">ival</span> <span class="o">=</span> <span class="n">p_arr</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">all_keys_index</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_gvar</span><span class="p">:</span> <span class="n">ival</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">gvar</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ival</span><span class="p">))</span>
            <span class="n">p_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ival</span>

        <span class="k">return</span> <span class="n">p_dict</span>
        
<div class="viewcode-block" id="FitVector.get_model"><a class="viewcode-back" href="../../orb.html#orb.fit.FitVector.get_model">[docs]</a>    <span class="k">def</span> <span class="nf">get_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">all_p_free</span><span class="p">,</span> <span class="n">return_models</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the combined model of the vector given a set of free</span>
<span class="sd">        parameters.</span>

<span class="sd">        This function is typically called to compute the objective</span>
<span class="sd">        function. It can also be called to obtain the final model</span>
<span class="sd">        based on fitted parameters.</span>

<span class="sd">        :param all_p_free: Vector of free parameters.</span>

<span class="sd">        :param return_models: (Optional) If True return also</span>
<span class="sd">          individual models (default False)</span>

<span class="sd">        :param x: (Optional) array of data points on which model is</span>
<span class="sd">          computed instead of a typical np.arange(step_nb) (default</span>
<span class="sd">          None).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">all_p_free</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">all_p_free</span> <span class="o">=</span> <span class="n">all_p_free</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">step_nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">step_nb</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
       
        <span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">return_models</span><span class="p">:</span>
            <span class="n">models</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">models</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">all_p_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_p_dict2list</span><span class="p">(</span><span class="n">all_p_free</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">)):</span>
            <span class="n">model_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">all_p_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">return_models</span><span class="o">=</span><span class="n">return_models</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">return_models</span><span class="p">:</span>
                <span class="n">model_to_append</span><span class="p">,</span> <span class="n">models_to_append</span> <span class="o">=</span> <span class="n">model_list</span>
                <span class="n">models</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">models_to_append</span>
                
            <span class="k">else</span><span class="p">:</span>
                <span class="n">model_to_append</span> <span class="o">=</span> <span class="n">model_list</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">models_operation</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;add&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">model</span> <span class="o">=</span> <span class="n">model_to_append</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">model</span> <span class="o">+=</span> <span class="n">model_to_append</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">models_operation</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;mult&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">model</span> <span class="o">=</span> <span class="n">model_to_append</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">model</span> <span class="o">*=</span> <span class="n">model_to_append</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Bad model operation. Model operation must be in </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models_operations</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">return_models</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">models</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">model</span></div>
    
    <span class="k">def</span> <span class="nf">_get_model_onrange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">all_p_free</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the part of the model contained in the signal</span>
<span class="sd">        range.</span>

<span class="sd">        .. note:: This function has been defined only to be used with</span>
<span class="sd">          scipy.optimize.curve_fit.</span>

<span class="sd">        :param x: x vector on which model is computed</span>

<span class="sd">        :param *all_p_free: Vector of free parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">classic</span><span class="p">:</span>
            <span class="n">all_p_free</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_p_arr2dict</span><span class="p">(</span><span class="n">all_p_free</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">all_p_free</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">)[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signal_range</span><span class="p">):</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signal_range</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">_get_vector_onrange</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the part of the vector contained in the signal</span>
<span class="sd">        range.</span>

<span class="sd">        .. note:: This function has been defined only to be used with</span>
<span class="sd">          scipy.optimize.curve_fit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector</span><span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signal_range</span><span class="p">):</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signal_range</span><span class="p">)]</span>


<div class="viewcode-block" id="FitVector.fit"><a class="viewcode-back" href="../../orb.html#orb.fit.FitVector.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compute_mcmc_error</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fit data vector.</span>

<span class="sd">        This is the central function of the class.</span>

<span class="sd">        :param compute_mcmc_error: (Optional) Compute Markov chain</span>
<span class="sd">          Monte-Carlo error on the fit parameters (Uncertainty</span>
<span class="sd">          estimates might be slighly better constrained but computing</span>
<span class="sd">          time can be orders of magnitude longer) (default False).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">all_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">locals</span><span class="p">())</span> <span class="c1"># used in case fit is retried (must stay</span>
                                  <span class="c1"># at the very beginning of the</span>
                                  <span class="c1"># function ;)</span>
        <span class="k">def</span> <span class="nf">fit_args</span><span class="p">(</span><span class="n">snr</span><span class="p">):</span>
            <span class="n">vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_vector_onrange</span><span class="p">()</span>
            <span class="n">err</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">vector</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">vector</span><span class="p">))</span> <span class="o">/</span> <span class="n">snr</span>
            <span class="n">vector</span> <span class="o">=</span> <span class="n">gvar</span><span class="o">.</span><span class="n">gvar</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">vector</span><span class="p">)</span> <span class="o">*</span> <span class="n">err</span><span class="p">)</span> 
            <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">udata</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                       <span class="n">vector</span><span class="p">),</span>
                <span class="n">prior</span><span class="o">=</span><span class="n">priors_dict</span><span class="p">,</span>
                <span class="n">fcn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_model_onrange</span><span class="p">,</span>
                <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">tol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_tol</span><span class="p">)</span>


        <span class="n">MCMC_RANDOM_COEFF</span> <span class="o">=</span> <span class="mf">1e-2</span>
        
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">priors_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_p_list2dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">priors_list</span><span class="p">)</span>

        <span class="c1">### CLASSIC MODE ##################</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">classic</span><span class="p">:</span>
            <span class="n">priors_arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_p_dict2arr</span><span class="p">(</span><span class="n">priors_dict</span><span class="p">)</span>

            <span class="n">fit_classic</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">curve_fit</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_get_model_onrange</span><span class="p">,</span>
                <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_get_vector_onrange</span><span class="p">(),</span>
                <span class="n">p0</span><span class="o">=</span><span class="n">priors_arr</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="s1">&#39;lm&#39;</span><span class="p">,</span>
                <span class="n">full_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">fit</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="s1">&#39;fit&#39;</span><span class="p">,</span> <span class="p">(),</span> <span class="p">{})</span>

            <span class="n">last_diff</span> <span class="o">=</span> <span class="n">fit_classic</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s1">&#39;fvec&#39;</span><span class="p">]</span>
            <span class="n">fit</span><span class="o">.</span><span class="n">chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">last_diff</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>
            <span class="n">fit</span><span class="o">.</span><span class="n">dof</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">fit_classic</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="c1"># compute uncertainties</span>
            <span class="n">cov_x</span> <span class="o">=</span> <span class="n">fit_classic</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">cov_x</span><span class="p">)):</span>
                <span class="n">p_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cov_x</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">fit_classic</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">p_err</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                
            <span class="n">fit</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_p_arr2dict</span><span class="p">(</span><span class="n">gvar</span><span class="o">.</span><span class="n">gvar</span><span class="p">(</span><span class="n">fit_classic</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p_err</span><span class="p">),</span>
                                         <span class="n">keep_gvar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">fit_classic</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="n">fit</span><span class="o">.</span><span class="n">stopping_criterion</span> <span class="o">=</span> <span class="n">fit_classic</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">fit</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fit</span><span class="o">.</span><span class="n">stopping_criterion</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">fit</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">fit</span><span class="o">.</span><span class="n">fitter_results</span> <span class="o">=</span> <span class="n">fit_classic</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1">### LSQFIT MODE ##################</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">snr_guess</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;No SNR guess. This fit must be made in classic mode&#39;</span><span class="p">)</span>
            
            <span class="n">fit</span> <span class="o">=</span> <span class="n">lsqfit</span><span class="o">.</span><span class="n">nonlinear_fit</span><span class="p">(</span><span class="o">**</span><span class="n">fit_args</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">snr_guess</span><span class="p">))</span>
            
        <span class="k">if</span> <span class="n">fit</span><span class="o">.</span><span class="n">error</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fit_p</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">p</span>
            
            <span class="c1"># correct for normalization coeff</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">fit_p</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="s1">&#39;amp&#39;</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">or</span> <span class="s1">&#39;cont_p&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                    <span class="n">fit_p</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_p</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalization_coeff</span>
                    
            <span class="k">if</span> <span class="n">fit</span><span class="o">.</span><span class="n">stopping_criterion</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Did not converge&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">[]</span>

            <span class="n">returned_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">returned_data</span><span class="p">[</span><span class="s1">&#39;iter_nb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">fitter_results</span><span class="p">[</span><span class="s1">&#39;nfev&#39;</span><span class="p">]</span>

            <span class="c1">## get fit model</span>
            <span class="p">(</span><span class="n">returned_data</span><span class="p">[</span><span class="s1">&#39;fitted_vector_gvar&#39;</span><span class="p">],</span>
             <span class="n">returned_data</span><span class="p">[</span><span class="s1">&#39;fitted_models_gvar&#39;</span><span class="p">])</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span>
                <span class="n">fit_p</span><span class="p">,</span>
                <span class="n">return_models</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">returned_data</span><span class="p">[</span><span class="s1">&#39;fitted_vector&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gvar</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">returned_data</span><span class="p">[</span><span class="s1">&#39;fitted_vector_gvar&#39;</span><span class="p">])</span>
            <span class="n">returned_data</span><span class="p">[</span><span class="s1">&#39;fitted_models&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">imod</span> <span class="ow">in</span> <span class="n">returned_data</span><span class="p">[</span><span class="s1">&#39;fitted_models_gvar&#39;</span><span class="p">]:</span>
                <span class="n">returned_data</span><span class="p">[</span><span class="s1">&#39;fitted_models&#39;</span><span class="p">][</span><span class="n">imod</span><span class="p">]</span> <span class="o">=</span> <span class="n">gvar</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                    <span class="n">returned_data</span><span class="p">[</span><span class="s1">&#39;fitted_models_gvar&#39;</span><span class="p">][</span><span class="n">imod</span><span class="p">])</span>

            <span class="c1">## return fitted parameters of each models</span>
            <span class="n">full_p_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="n">full_p_list_err</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="n">full_p_list_gvar</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            
            
            <span class="n">p_fit_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_p_dict2list</span><span class="p">(</span><span class="n">fit_p</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">)):</span>
                <span class="c1"># recompute p_val from new p_free</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_p_free</span><span class="p">(</span><span class="n">p_fit_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">_ipval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_p_val</span><span class="p">()</span>
                <span class="n">full_p_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gvar</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">_ipval</span><span class="p">))</span>
                <span class="n">full_p_list_err</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gvar</span><span class="o">.</span><span class="n">sdev</span><span class="p">(</span><span class="n">_ipval</span><span class="p">))</span>
                <span class="n">full_p_list_gvar</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_ipval</span><span class="p">)</span>
                
            <span class="n">returned_data</span><span class="p">[</span><span class="s1">&#39;fit_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_p_list</span>
            <span class="n">returned_data</span><span class="p">[</span><span class="s1">&#39;fit_params_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_p_list_err</span>
            <span class="n">returned_data</span><span class="p">[</span><span class="s1">&#39;fit_params_gvar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_p_list_gvar</span>

            
            <span class="c1">## compute error on parameters</span>
            <span class="c1"># compute reduced chi square</span>
            <span class="n">returned_data</span><span class="p">[</span><span class="s1">&#39;reduced_chi_square&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">chi2</span> <span class="o">/</span> <span class="n">fit</span><span class="o">.</span><span class="n">dof</span>
            <span class="n">returned_data</span><span class="p">[</span><span class="s1">&#39;chi_square&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">chi2</span>
            <span class="c1">#returned_data[&#39;residual&#39;] = self.vector - returned_data[&#39;fitted-vector-gvar&#39;]</span>

            <span class="c1"># compute MCMC uncertainty estimates</span>
            <span class="k">if</span> <span class="n">compute_mcmc_error</span><span class="p">:</span>
                <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">last_diff</span><span class="p">)</span>
                <span class="n">returned_data</span><span class="p">[</span><span class="s1">&#39;fit_params_err_mcmc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_mcmc_error</span><span class="p">(</span>
                    <span class="n">fit</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cov_diag</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>


            <span class="n">returned_data</span><span class="p">[</span><span class="s1">&#39;fit_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="k">return</span> <span class="n">returned_data</span></div></div>
        


<div class="viewcode-block" id="Model"><a class="viewcode-back" href="../../orb.html#orb.fit.Model">[docs]</a><span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Template class for fit models. This class cannot be used directly.</span>

<span class="sd">    The main purpose of a Model class is to output a model given a set</span>
<span class="sd">    of parameters.</span>

<span class="sd">    Methods that must be implemented by real classes:</span>

<span class="sd">      * :py:meth:`fit.Model.parse_dict`</span>
<span class="sd">      * :py:meth:`fit.Model.check_input`</span>
<span class="sd">      * :py:meth:`fit.Model.make_guess`</span>
<span class="sd">      * :py:meth:`fit.Model.get_model`</span>


<span class="sd">    .. note:: A model is computed from a given set of parameters</span>
<span class="sd">      stored in :py:attr:`fit.Model.p_val`. From this set some</span>
<span class="sd">      parameters are **free**, some are **fixed** and some are</span>
<span class="sd">      **covarying**, i.e. the value of a subset of parameters can be</span>
<span class="sd">      computed from 1 free parameter.</span>

<span class="sd">      Taking the definition of the parameters (free, fixed or</span>
<span class="sd">      covarying, stored in :py:attr:`fit.Model.p_def`) into account,</span>
<span class="sd">      the reduced free parameter set is stored in</span>
<span class="sd">      :py:attr:`fit.Model.p_free`, the reduced set of fixed parameters</span>
<span class="sd">      is stored in :py:attr:`fit.Model.p_fixed`, the set of covarying</span>
<span class="sd">      parameters is stored in :py:attr:`fit.Model.p_cov` and when the</span>
<span class="sd">      model needs to be computed, the full set of model parameters</span>
<span class="sd">      (:py:attr:`fit.Model.p_val`) is computed again from set.p_free`,</span>
<span class="sd">      :py:attr:`fit.Model.p_fixed`, :py:attr:`fit.Model.p_cov` and</span>
<span class="sd">      :py:attr:`fit.Model.p_def`.</span>

<span class="sd">      A group of covarying parameters is defined by the same label. If</span>
<span class="sd">      :py:attr:`fit.Model.p_def` is::</span>

<span class="sd">        [&#39;free&#39;, &#39;fixed&#39;, &#39;1&#39;, &#39;2&#39;, &#39;free&#39;, &#39;fixed&#39;, &#39;2&#39;, &#39;1&#39;, &#39;2&#39;, &#39;free&#39;]</span>

<span class="sd">      It means that we have 3 free parameters, 2 fixed parameters and</span>
<span class="sd">      2 groups of covarying parameters. The first group contains 2</span>
<span class="sd">      parameters and the second group contains 3 parameters. In this</span>
<span class="sd">      case the real number of free parameters will be 3 + 2 (one free</span>
<span class="sd">      parameter for each group of covarying parameters) = 5 and the</span>
<span class="sd">      real number of fixed parameters will be 2 + 5 (one fixed</span>
<span class="sd">      parameter for each covarying parameters) = 7.</span>
<span class="sd">      </span>

<span class="sd">      A Model class works this way :</span>

<span class="sd">      1. Init: the dictionary defining the parameters (free, fixed,</span>
<span class="sd">         covarying) and their values is parsed with</span>
<span class="sd">         :py:meth:`fit.Model.parse_dict`: :py:attr:`fit.Model.p_def`,</span>
<span class="sd">         :py:attr:`fit.Model.p_val` and :py:attr:`fit.Model.p_cov` are</span>
<span class="sd">         created. Then :py:meth:`fit.Model.val2free` is called to</span>
<span class="sd">         create :py:attr:`fit.Model.p_free` and</span>
<span class="sd">         :py:attr:`fit.Model.p_fixed`.</span>
<span class="sd">      </span>
<span class="sd">      2. the set of free parameters can then be changed with</span>
<span class="sd">         :py:meth:`fit.Model.set_p_free` before calling</span>
<span class="sd">         :py:meth:`fit.Model.get_model`. the updated values of</span>
<span class="sd">         :py:attr:`fit.Model.p_val` are computed before the model is created via</span>
<span class="sd">         :py:meth:`fit.Model.free2val`. A new set of free parameters</span>
<span class="sd">         can also be passed to :py:meth:`fit.Model.get_model`.</span>
<span class="sd">      </span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">accepted_keys</span> <span class="o">=</span> <span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;Accepted keys of the input dictionary (see</span>
<span class="sd">    :py:attr:`fit.Model.p_dict`)&quot;&quot;&quot;</span>

    <span class="n">p_free</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;Up to date value of the free parameters. Its size is always</span>
<span class="sd">    less or equal to the size of the full set of parameters used</span>
<span class="sd">    directly to compute the model. It reflects the real number of</span>
<span class="sd">    fitted parameters. For each group of covarying parameters one free</span>
<span class="sd">    parameter is added. &quot;&quot;&quot;</span>

    <span class="n">p_fixed</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;Array of fixed parameters. Each covarying parameter is stored</span>
<span class="sd">    as fixed. And one free parameter is added for each group of</span>
<span class="sd">    covarying parameters.&quot;&quot;&quot;</span>
    
    <span class="n">p_dict</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;Input dictionary defining the parameters. Contains the initial</span>
<span class="sd">    values of the parameters&quot;&quot;&quot;</span>
    
    <span class="n">p_def</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;Definition the full set of parameters (fixed, free or</span>
<span class="sd">    covarying). This array as the same shape as :py:attr:`fit.Model.p_val`&quot;&quot;&quot;</span>
    
    <span class="n">p_val</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;Up to date values of the full set of parameters used by the model</span>
<span class="sd">    (initial guess before fit, fitted value after fit). This array as</span>
<span class="sd">    the same shape as :py:attr:`fit.Model.p_def`. It does not reflect the real number</span>
<span class="sd">    of fitted parameters.&quot;&quot;&quot;</span>

    <span class="n">p_cov</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;dict that stores the groups of covarying parameters by label</span>
<span class="sd">    and their associated value and covarying operation (a pointer to a</span>
<span class="sd">    function), i.e.::</span>

<span class="sd">      {[&#39;cov_label_1&#39;: (value1, cov_operation1)],</span>
<span class="sd">       [&#39;cov_label_2&#39;: (value2, cov_operation2)],</span>
<span class="sd">       ...}</span>
<span class="sd">     &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Initialize model</span>

<span class="sd">        :param p_dict: Input dictionary defining the parameters of the</span>
<span class="sd">          model.</span>
<span class="sd">        </span>
<span class="sd">        parameters definition can be : &#39;free&#39;, &#39;fixed&#39; or covarying</span>
<span class="sd">        (in this case any string label can be used to define a group</span>
<span class="sd">        of covarying parameters)</span>

<span class="sd">        During init p_dict is parsed with</span>
<span class="sd">        :py:meth:`fit.Model.parse_dict`: :py:attr:`fit.Model.p_def`,</span>
<span class="sd">        :py:attr:`fit.Model.p_val` and :py:attr:`fit.Model.p_cov` are</span>
<span class="sd">        created. Then :py:meth:`fit.Model.val2free` is called to create</span>
<span class="sd">        :py:attr:`fit.Model.p_free` and :py:attr:`fit.Model.p_fixed`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># parse input dict</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p_dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">p_dict</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">accepted_keys</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Input dictionary contains unknown key: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parse_dict</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;p must be a dict&#39;</span><span class="p">)</span>

        <span class="c1"># check input parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_input</span><span class="p">()</span>
        
        <span class="c1"># create free and fixed vectors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">val2free</span><span class="p">()</span>
        


<div class="viewcode-block" id="Model.parse_dict"><a class="viewcode-back" href="../../orb.html#orb.fit.Model.parse_dict">[docs]</a>    <span class="k">def</span> <span class="nf">parse_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse input dictionary to create :py:attr:`fit.Model.p_def`, :py:attr:`fit.Model.p_val` and</span>
<span class="sd">        :py:attr:`fit.Model.p_cov`&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Not implemented&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.check_input"><a class="viewcode-back" href="../../orb.html#orb.fit.Model.check_input">[docs]</a>    <span class="k">def</span> <span class="nf">check_input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check input parameters&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Not implemented&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.make_guess"><a class="viewcode-back" href="../../orb.html#orb.fit.Model.make_guess">[docs]</a>    <span class="k">def</span> <span class="nf">make_guess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;If a parameter value at init is a NaN this value is guessed.</span>

<span class="sd">        :param v: Data vector from which the guess is made.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Not implemented&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.get_model"><a class="viewcode-back" href="../../orb.html#orb.fit.Model.get_model">[docs]</a>    <span class="k">def</span> <span class="nf">get_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">return_models</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute a model M(x, p) for all passed x positions. p are</span>
<span class="sd">        the parameter values stored in :py:attr:`fit.Model.p_val`</span>

<span class="sd">        :param x: Positions where the model M(x, p) is computed.</span>

<span class="sd">        :param return_models: (Optional) If True return also</span>
<span class="sd">          individual models (default False)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Not implemented&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.get_p_free"><a class="viewcode-back" href="../../orb.html#orb.fit.Model.get_p_free">[docs]</a>    <span class="k">def</span> <span class="nf">get_p_free</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the vector of free parameters :py:attr:`fit.Model.p_free`&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_free</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.get_priors"><a class="viewcode-back" href="../../orb.html#orb.fit.Model.get_priors">[docs]</a>    <span class="k">def</span> <span class="nf">get_priors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">classic</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return priors</span>

<span class="sd">        :param classic: If True, return classic priors (e.g. no log distribution)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">classic</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_p_free</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">priors</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_p_free</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">priors</span><span class="p">:</span>
                <span class="n">priors</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">gvar</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">priors</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">priors</span></div>
        
<div class="viewcode-block" id="Model.set_p_free"><a class="viewcode-back" href="../../orb.html#orb.fit.Model.set_p_free">[docs]</a>    <span class="k">def</span> <span class="nf">set_p_free</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_free</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the vector of free parameters :py:attr:`fit.Model.p_free`</span>

<span class="sd">        :param p_free: New vector of free parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_free</span><span class="o">.</span><span class="n">viewkeys</span><span class="p">()</span> <span class="o">==</span> <span class="n">p_free</span><span class="o">.</span><span class="n">viewkeys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p_free</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">p_free</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">free2val</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;bad format of passed free parameters&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.get_p_val"><a class="viewcode-back" href="../../orb.html#orb.fit.Model.get_p_val">[docs]</a>    <span class="k">def</span> <span class="nf">get_p_val</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return :py:attr:`fit.Model.p_val` &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_val</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.set_p_val"><a class="viewcode-back" href="../../orb.html#orb.fit.Model.set_p_val">[docs]</a>    <span class="k">def</span> <span class="nf">set_p_val</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_val</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set :py:attr:`fit.Model.p_val`</span>

<span class="sd">        .. warning:: This method is used to bypass all the initialized</span>
<span class="sd">          parameters and reuse an already initialized model with</span>
<span class="sd">          another full set of parameters. Note that you might want to</span>
<span class="sd">          call :py:meth:`fit.Model.get_model` directly after this</span>
<span class="sd">          method because any call to :py:meth:`fit.Model.set_p_free`</span>
<span class="sd">          or :py:meth:`fit.Model.free2val` will recompute</span>
<span class="sd">          :py:attr:`fit.Model.p_val` from the init values and the</span>
<span class="sd">          actual :py:attr:`fit.Model.p_free`.</span>
<span class="sd">        </span>
<span class="sd">        :param p_val: New full set of parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">p_val</span><span class="o">.</span><span class="n">viewkeys</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_val</span><span class="o">.</span><span class="n">viewkeys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p_val</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">p_val</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">val2free</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;bad format of passed val parameters&#39;</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="Model.val2free"><a class="viewcode-back" href="../../orb.html#orb.fit.Model.val2free">[docs]</a>    <span class="k">def</span> <span class="nf">val2free</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Recompute the set of free parameters</span>
<span class="sd">        :py:attr:`fit.Model.p_free` with the updated values of</span>
<span class="sd">        :py:attr:`fit.Model.p_val`&quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_val</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_def</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_cov</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;class has not been well initialized: p_val, p_def and p_cov must be defined&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p_free</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p_fixed</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">passed_cov</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">idef</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_def</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_def</span><span class="p">[</span><span class="n">idef</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;free&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">p_free</span><span class="p">[</span><span class="n">idef</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_val</span><span class="p">[</span><span class="n">idef</span><span class="p">]</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_def</span><span class="p">[</span><span class="n">idef</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;fixed&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">p_fixed</span><span class="p">[</span><span class="n">idef</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_val</span><span class="p">[</span><span class="n">idef</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_def</span><span class="p">[</span><span class="n">idef</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">passed_cov</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">p_free</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">p_def</span><span class="p">[</span><span class="n">idef</span><span class="p">]]</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_cov</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">p_def</span><span class="p">[</span><span class="n">idef</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">p_fixed</span><span class="p">[</span><span class="n">idef</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_val</span><span class="p">[</span><span class="n">idef</span><span class="p">]</span>
                <span class="n">passed_cov</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">p_def</span><span class="p">[</span><span class="n">idef</span><span class="p">]])</span>
                
        <span class="c1"># check if p_free has a sdev</span>
        <span class="k">for</span> <span class="n">idef</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_free</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_free</span><span class="p">[</span><span class="n">idef</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">gvar</span><span class="o">.</span><span class="n">sdev</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_free</span><span class="p">[</span><span class="n">idef</span><span class="p">])</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">p_free</span><span class="p">[</span><span class="n">idef</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_estimate_sdev</span><span class="p">(</span>
                        <span class="n">idef</span><span class="p">,</span> <span class="n">gvar</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_free</span><span class="p">[</span><span class="n">idef</span><span class="p">]))</span>

        <span class="c1"># remove sdev from p_fixed </span>
        <span class="k">for</span> <span class="n">idef</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_fixed</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_fixed</span><span class="p">[</span><span class="n">idef</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">gvar</span><span class="o">.</span><span class="n">sdev</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_fixed</span><span class="p">[</span><span class="n">idef</span><span class="p">])</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">p_fixed</span><span class="p">[</span><span class="n">idef</span><span class="p">]</span> <span class="o">=</span> <span class="n">gvar</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_fixed</span><span class="p">[</span><span class="n">idef</span><span class="p">])</span> </div>
        
<div class="viewcode-block" id="Model.free2val"><a class="viewcode-back" href="../../orb.html#orb.fit.Model.free2val">[docs]</a>    <span class="k">def</span> <span class="nf">free2val</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read the array of parameters definition</span>
<span class="sd">        :py:attr:`fit.Model.p_def` and update the parameter values</span>
<span class="sd">        based on the new set of free parameters</span>
<span class="sd">        :py:attr:`fit.Model.p_free`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_free</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_fixed</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_def</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_cov</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;class has not been well initialized, p_free, p_fixed, p_def and p_cov must be defined&#39;</span><span class="p">)</span>
        <span class="n">passed_cov</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">p_val</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">idef</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_def</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_def</span><span class="p">[</span><span class="n">idef</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;free&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">p_val</span><span class="p">[</span><span class="n">idef</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_free</span><span class="p">[</span><span class="n">idef</span><span class="p">]</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_def</span><span class="p">[</span><span class="n">idef</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;fixed&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">p_val</span><span class="p">[</span><span class="n">idef</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_fixed</span><span class="p">[</span><span class="n">idef</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># covarying parameter</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_def</span><span class="p">[</span><span class="n">idef</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">passed_cov</span><span class="p">:</span>
                    <span class="c1"># if not already taken into account                    </span>
                    <span class="n">passed_cov</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">p_def</span><span class="p">[</span><span class="n">idef</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_free</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">p_def</span><span class="p">[</span><span class="n">idef</span><span class="p">]]</span>
                <span class="c1"># covarying operation</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">p_val</span><span class="p">[</span><span class="n">idef</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_cov</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">p_def</span><span class="p">[</span><span class="n">idef</span><span class="p">]][</span><span class="mi">1</span><span class="p">](</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">p_fixed</span><span class="p">[</span><span class="n">idef</span><span class="p">],</span> <span class="n">passed_cov</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">p_def</span><span class="p">[</span><span class="n">idef</span><span class="p">]])</span></div></div>
                    
                
<div class="viewcode-block" id="FilterModel"><a class="viewcode-back" href="../../orb.html#orb.fit.FilterModel">[docs]</a><span class="k">class</span> <span class="nc">FilterModel</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple model of filter based on a real filter shape. The only</span>
<span class="sd">    possible free parameter is a wavelength/wavenumber shift.</span>

<span class="sd">    Input dictionary :py:attr:`fit.Model.p_dict`::</span>

<span class="sd">      {&#39;filter_function&#39;:,</span>
<span class="sd">       &#39;shift_guess&#39;:,</span>
<span class="sd">       &#39;shift_def&#39;:}</span>

<span class="sd">    :keyword filter_function: Transmission of the filter over the</span>
<span class="sd">      fitted spectral range (axis must be exactly the same).</span>
<span class="sd">      </span>
<span class="sd">    :keyword shift_guess: Guess on the filter shift in pixels.</span>
<span class="sd">    </span>
<span class="sd">    :keyword shift_def: Definition of the shift parameter, can be</span>
<span class="sd">      &#39;free&#39; or &#39;fixed&#39;</span>

<span class="sd">    .. note:: This model must be multiplied with the other and used</span>
<span class="sd">      last.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">accepted_keys</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;filter_function&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;shift_guess&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;shift_def&#39;</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;Accepted keys of the input dictionary (see</span>
<span class="sd">    :py:attr:`fit.Model.p_dict`)&quot;&quot;&quot;</span>

<div class="viewcode-block" id="FilterModel.parse_dict"><a class="viewcode-back" href="../../orb.html#orb.fit.FilterModel.parse_dict">[docs]</a>    <span class="k">def</span> <span class="nf">parse_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse input dictionary :py:attr:`fit.Model.p_dict`&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;filter_function&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_dict</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filter_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;filter_function&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filter_function</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_function</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filter_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_function</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filter_function</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">UnivariateSpline</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">filter_axis</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_function</span><span class="p">,</span>
                <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;filter_function must be given&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;shift_guess&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_dict</span><span class="p">:</span>
            <span class="n">shift_guess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;shift_guess&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">shift_guess</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p_val</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;filter_shift&#39;</span><span class="p">:</span> <span class="n">shift_guess</span><span class="p">}</span>
        
        <span class="k">if</span> <span class="s1">&#39;shift_def&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_dict</span><span class="p">:</span>
            <span class="n">shift_def</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;shift_def&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shift_def</span> <span class="o">=</span> <span class="s1">&#39;free&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p_def</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;filter_shift&#39;</span><span class="p">:</span> <span class="n">shift_def</span><span class="p">}</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">p_cov</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span></div>

<div class="viewcode-block" id="FilterModel.check_input"><a class="viewcode-back" href="../../orb.html#orb.fit.FilterModel.check_input">[docs]</a>    <span class="k">def</span> <span class="nf">check_input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="FilterModel.make_guess"><a class="viewcode-back" href="../../orb.html#orb.fit.FilterModel.make_guess">[docs]</a>    <span class="k">def</span> <span class="nf">make_guess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">pass</span></div>

    <span class="k">def</span> <span class="nf">_estimate_sdev</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idef</span><span class="p">,</span> <span class="n">mean</span><span class="p">):</span>
        <span class="n">SHIFT_SDEV</span> <span class="o">=</span> <span class="mi">3</span> <span class="c1"># channels</span>
        <span class="k">return</span> <span class="n">gvar</span><span class="o">.</span><span class="n">gvar</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">SHIFT_SDEV</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_axis</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">20</span><span class="p">))</span>

<div class="viewcode-block" id="FilterModel.get_model"><a class="viewcode-back" href="../../orb.html#orb.fit.FilterModel.get_model">[docs]</a>    <span class="k">def</span> <span class="nf">get_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">p_free</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_models</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return model M(x, p).</span>

<span class="sd">        :param x: Positions where the model M(x, p) is computed.</span>

<span class="sd">        :param p_free: (Optional) New values of the free parameters</span>
<span class="sd">          (default None).</span>
<span class="sd">          </span>
<span class="sd">        :param return_models: (Optional) If True return also</span>
<span class="sd">          individual models (default False)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">p_free</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_p_free</span><span class="p">(</span><span class="n">p_free</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">free2val</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_free</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mod</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_axis</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mod</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_function</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">filter_axis</span>
                <span class="o">+</span> <span class="n">gvar</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_free</span><span class="p">[</span><span class="s1">&#39;filter_shift&#39;</span><span class="p">])))</span>
        <span class="k">if</span> <span class="n">return_models</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mod</span><span class="p">,</span> <span class="p">(</span><span class="n">mod</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mod</span></div></div>


<div class="viewcode-block" id="ContinuumModel"><a class="viewcode-back" href="../../orb.html#orb.fit.ContinuumModel">[docs]</a><span class="k">class</span> <span class="nc">ContinuumModel</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Polynomial continuum model.</span>

<span class="sd">    Input dictionary :py:attr:`fit.Model.p_dict`::</span>

<span class="sd">      {&#39;poly_order&#39;:</span>
<span class="sd">       &#39;poly_guess&#39;:}</span>

<span class="sd">    :keyword poly_order: Order of the polynomial to fit (be careful</span>
<span class="sd">      with high order polynomials).</span>

<span class="sd">    :keyword poly_guess: Initial guess on the coefficient values :</span>
<span class="sd">      must be a tuple of length poly_order + 1.</span>

<span class="sd">    .. note:: This model must be added to the others.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">accepted_keys</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;poly_order&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;poly_guess&#39;</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;Accepted keys of the input dictionary (see</span>
<span class="sd">    :py:attr:`fit.Model.p_dict`)&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_get_ikey</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ip</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return key corresponding to a coefficient of order ip</span>

<span class="sd">        :param ip: order of the coefficient</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;cont_p</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_get_order_from_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the line nb of a given key</span>

<span class="sd">        :param key: Key to get line number from.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">6</span><span class="p">:])</span>
        
<div class="viewcode-block" id="ContinuumModel.get_p_val_as_array"><a class="viewcode-back" href="../../orb.html#orb.fit.ContinuumModel.get_p_val_as_array">[docs]</a>    <span class="k">def</span> <span class="nf">get_p_val_as_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_val</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">p_val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p_val</span><span class="o">.</span><span class="n">viewkeys</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_val</span><span class="o">.</span><span class="n">viewkeys</span><span class="p">():</span>
                <span class="n">p_val</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_val</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Badly formatted p_val&#39;</span><span class="p">)</span>

        <span class="n">ans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">poly_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ipar</span> <span class="ow">in</span> <span class="n">p_val</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_order_from_key</span><span class="p">(</span><span class="n">ipar</span><span class="p">)</span>
            <span class="n">ans</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_val</span><span class="p">[</span><span class="n">ipar</span><span class="p">]</span>
            
        <span class="k">return</span> <span class="n">ans</span></div>
    
    
<div class="viewcode-block" id="ContinuumModel.parse_dict"><a class="viewcode-back" href="../../orb.html#orb.fit.ContinuumModel.parse_dict">[docs]</a>    <span class="k">def</span> <span class="nf">parse_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse input dictionary :py:attr:`fit.Model.p_dict`&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;poly_order&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_dict</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">poly_order</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;poly_order&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">poly_order</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">p_val</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p_def</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>    
        <span class="bp">self</span><span class="o">.</span><span class="n">p_cov</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span> <span class="c1"># no covarying parameters</span>

        <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">poly_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p_val</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ikey</span><span class="p">(</span><span class="n">ip</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.</span>                
            <span class="bp">self</span><span class="o">.</span><span class="n">p_def</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ikey</span><span class="p">(</span><span class="n">ip</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;free&#39;</span>

        <span class="k">if</span> <span class="s1">&#39;poly_guess&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_dict</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;poly_guess&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;poly_guess&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">poly_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">poly_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">p_val</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ikey</span><span class="p">(</span><span class="n">ip</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;poly_guess&#39;</span><span class="p">][</span><span class="n">ip</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;poly_guess must be an array of size equal to poly_order + 1&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ContinuumModel.check_input"><a class="viewcode-back" href="../../orb.html#orb.fit.ContinuumModel.check_input">[docs]</a>    <span class="k">def</span> <span class="nf">check_input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="ContinuumModel.make_guess"><a class="viewcode-back" href="../../orb.html#orb.fit.ContinuumModel.make_guess">[docs]</a>    <span class="k">def</span> <span class="nf">make_guess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_val</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_val</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_order_from_key</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">p_val</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">order</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span></div>


    <span class="k">def</span> <span class="nf">_estimate_sdev</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idef</span><span class="p">,</span> <span class="n">mean</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Estimate standard deviation of a free parameter is none is given</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">PSDEV</span> <span class="o">=</span> <span class="mf">1e3</span>
        <span class="k">if</span> <span class="n">mean</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">gvar</span><span class="o">.</span><span class="n">gvar</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">PSDEV</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">gvar</span><span class="o">.</span><span class="n">gvar</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">mean</span><span class="o">*</span><span class="mf">10.</span><span class="p">)</span>


<div class="viewcode-block" id="ContinuumModel.get_model"><a class="viewcode-back" href="../../orb.html#orb.fit.ContinuumModel.get_model">[docs]</a>    <span class="k">def</span> <span class="nf">get_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">p_free</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_models</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return model M(x, p).</span>

<span class="sd">        :param x: Positions where the model M(x, p) is computed.</span>

<span class="sd">        :param p_free: (Optional) New values of the free parameters</span>
<span class="sd">          (default None).</span>
<span class="sd">          </span>
<span class="sd">        :param return_models: (Optional) If True return also</span>
<span class="sd">          individual models (default False)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">p_free</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_p_free</span><span class="p">(</span><span class="n">p_free</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">free2val</span><span class="p">()</span>
        <span class="n">coeffs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">p_val</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ikey</span><span class="p">(</span><span class="n">ip</span><span class="p">)]</span> <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">poly_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">coeffs</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_models</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mod</span><span class="p">,</span> <span class="p">(</span><span class="n">mod</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mod</span></div></div>
        
<div class="viewcode-block" id="LinesModel"><a class="viewcode-back" href="../../orb.html#orb.fit.LinesModel">[docs]</a><span class="k">class</span> <span class="nc">LinesModel</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Emission/absorption lines model with a channel unity in pixels.</span>

<span class="sd">    .. note:: This class is best seen as a basic class implemented</span>
<span class="sd">      with more physical unities by :py:class:`fit.Cm1LinesModel` or</span>
<span class="sd">      :py:class:`fit.NmLinesModel`.</span>

<span class="sd">    .. note:: Each line is built on 3 (or more) parameters : amplitude,</span>
<span class="sd">      FWHM, position and sigma/alpha (the 4th and 5th parameters are used only for some models -- see</span>
<span class="sd">      below for details on the different models).</span>

<span class="sd">      Some lines can have one or more covarying parameters: FWHM can</span>
<span class="sd">      be the same for all the lines (this is True if lines are not</span>
<span class="sd">      resolved), lines issued from the same ion can have the same</span>
<span class="sd">      speed (e.g. [NII] doublet, [SII] doublet, [OIII] doublet), and</span>
<span class="sd">      some fixed transition ratios between lines can also be set</span>
<span class="sd">      (e.g. [NII]6584/[NII]6548 can be set to 2.89, when [NII]6548 is</span>
<span class="sd">      likely to be really noisy).</span>
<span class="sd">    </span>
<span class="sd">    Input dictionary :py:attr:`fit.Model.p_dict`::</span>

<span class="sd">      {&#39;line_nb&#39;:,</span>
<span class="sd">       &#39;fmodel&#39;:,</span>
<span class="sd">       &#39;amp_def&#39;:,</span>
<span class="sd">       &#39;pos_def&#39;:,</span>
<span class="sd">       &#39;fwhm_def&#39;:,</span>
<span class="sd">       &#39;sigma_def&#39;:, # only for sincgauss fmodel</span>
<span class="sd">       &#39;alpha_def&#39;:, # only for sincphased fmode</span>
<span class="sd">       &#39;amp_cov&#39;:,</span>
<span class="sd">       &#39;pos_cov&#39;:,</span>
<span class="sd">       &#39;fwhm_cov&#39;:,</span>
<span class="sd">       &#39;sigma_cov&#39;:, # only for sincgauss fmodel</span>
<span class="sd">       &#39;alpha_cov&#39;:, # only for sincphased fmodel</span>
<span class="sd">       &#39;amp_guess&#39;:,</span>
<span class="sd">       &#39;pos_guess&#39;:,</span>
<span class="sd">       &#39;fwhm_guess&#39;:,</span>
<span class="sd">       &#39;sigma_guess&#39;:, # only for sincgauss fmodel</span>
<span class="sd">       &#39;alpha_guess&#39;:} #  only for sincphased fmodel</span>

<span class="sd">    :keyword line_nb: Number of lines.</span>

<span class="sd">    :keyword fmodel: Line shape, can be &#39;gaussian&#39;, &#39;sinc&#39;, &#39;sinc2&#39; or</span>
<span class="sd">      &#39;sincgauss&#39;.</span>

<span class="sd">    :keyword amp_def: Definition of the amplitude parameter, can be</span>
<span class="sd">      &#39;free&#39;, &#39;fixed&#39; or set to a label that defines its covarying</span>
<span class="sd">      group.</span>

<span class="sd">    :keyword pos_def: Definition of the position parameter in pixels,</span>
<span class="sd">      can be &#39;free&#39;, &#39;fixed&#39; or set to a label that defines its</span>
<span class="sd">      covarying group.</span>

<span class="sd">    :keyword fwhm_def: Definition of the FWHM parameter in pixels, can</span>
<span class="sd">      be &#39;free&#39;, &#39;fixed&#39; or set to a label that defines its covarying</span>
<span class="sd">      group.</span>

<span class="sd">    :keyword sigma_def: Definition of the sigma parameter in pixels,</span>
<span class="sd">      can be &#39;free&#39;, &#39;fixed&#39; or set to a label that defines its</span>
<span class="sd">      covarying group.</span>

<span class="sd">    :keyword amp_cov: Guess on the covariant value of the amplitude</span>
<span class="sd">      (best set to 0 in general). There must be as many values as</span>
<span class="sd">      covarying amplitude groups or only one value if it is the same</span>
<span class="sd">      for all groups.</span>

<span class="sd">    :keyword pos_cov: Guess on the covariant value of the velocity (in</span>
<span class="sd">      pixels). There must be as many values as covarying amplitude</span>
<span class="sd">      groups or only one value if it is the same</span>
<span class="sd">      for all groups.</span>

<span class="sd">    :keyword fwhm_cov: Guess on the covariant value of the FWHM</span>
<span class="sd">      (best set to 0 in general). There must be as many values as</span>
<span class="sd">      covarying amplitude groups or only one value if it is the same</span>
<span class="sd">      for all groups.</span>

<span class="sd">    :keyword sigma_cov: Guess on the covariant value of sigma (best</span>
<span class="sd">       set to 0 in general). There must be as many values as covarying</span>
<span class="sd">       amplitude groups or only one value if it is the same for all</span>
<span class="sd">       groups.</span>

<span class="sd">    :keyword amp_guess: Initial guess on the amplitude value of the</span>
<span class="sd">       lines. Best set to a NaN in general (it can be automatically</span>
<span class="sd">       guessed with good robusteness). But if lines have a covarying</span>
<span class="sd">       amplitude the initial guess fixes their ratio.</span>

<span class="sd">    :keyword pos_guess: Initial guess on the position of the lines:</span>
<span class="sd">       the PRECISE rest frame position must be given here, especially</span>
<span class="sd">       if lines share a covarying position, because their relative</span>
<span class="sd">       position will be fixed.</span>

<span class="sd">    :keyword fwhm_guess: Initial guess on the FWHM of the lines. This</span>
<span class="sd">      guess must be the MOST PRECISE possible (to a few 10%), it is by</span>
<span class="sd">      far the most unstable parameter especially for sinc lines.</span>
<span class="sd">     </span>
<span class="sd">    :keyword sigma_guess: Initial guess on the value of sigma. Best</span>
<span class="sd">      set to 0. in general</span>


<span class="sd">    Example: A red spectrum containing [NII]6548, Halpha, [NII]6584,</span>
<span class="sd">    [SII]6716 and [SII]6731, with a mean velocity of 1500 km/s (which</span>
<span class="sd">    translates in a pixel shift of 5.5), with a fixed amplitude ratio</span>
<span class="sd">    netween [NII] lines, the same speed for lines issued from the same</span>
<span class="sd">    ions and a shared FWHM between everybody but Halpha would be</span>
<span class="sd">    defined this way::</span>
<span class="sd">    </span>
<span class="sd">      {&#39;line_nb&#39; : 5,</span>
<span class="sd">       &#39;amp_def&#39; : (&#39;1&#39;, &#39;free&#39;, &#39;1&#39;, &#39;free&#39;, &#39;free&#39;),</span>
<span class="sd">       &#39;pos_def&#39; : (&#39;1&#39;, &#39;2&#39;, &#39;1&#39;, &#39;3&#39;, &#39;3&#39;), </span>
<span class="sd">       &#39;fwhm_def&#39;: (&#39;1&#39;, &#39;2&#39;, &#39;1&#39;, &#39;1&#39;, &#39;1&#39;),</span>
<span class="sd">       &#39;amp_cov&#39;: 0.,</span>
<span class="sd">       &#39;pos_cov&#39;: 5.5,</span>
<span class="sd">       &#39;fwhm_cov&#39;: 0.,</span>
<span class="sd">       &#39;amp_guess&#39;: (1., np.nan, 2.89, np.nan, np.nan), # here the amplitude ratio between covarying [NII] lines is fixed.</span>
<span class="sd">       &#39;pos_guess&#39;: (40,60,80,120,140), # positions are given in pixel and are purely arbitrary in this example</span>
<span class="sd">       &#39;fwhm_guess&#39;: 2.43}</span>

<span class="sd">    .. note::</span>
<span class="sd">      Line shapes (fmodel keyword):</span>
<span class="sd">      </span>
<span class="sd">      * **gaussian**: A classical gaussian line shape. See :py:meth:`cutils.gaussian1d`.</span>
<span class="sd">      </span>
<span class="sd">      * **sinc**: A pure sinc line shape, True interferometric line shape</span>
<span class="sd">        if lines are strongly unresolved and if the interferometer has</span>
<span class="sd">        no assymetry (generally good on SITELLE/SpIOMM low res cubes</span>
<span class="sd">        --i.e. less than 500 steps-- if the line SNR is not too high</span>
<span class="sd">        --i.e. &lt; 50--). See :py:meth:`cutils.sinc1d`.</span>
<span class="sd">      </span>
<span class="sd">      * **sinc2**: sinc2 = sqrt(sinc**2.). Can be used for spectra not</span>
<span class="sd">        corrected in phase (where the absolute value of the complex</span>
<span class="sd">        spectrum is taken).</span>
<span class="sd">      </span>
<span class="sd">      * **sincgauss**: Convolution of a Gaussian (of width **sigma**) and</span>
<span class="sd">        a sinc (FWHM). This line shape has a 4th parameter:</span>
<span class="sd">        sigma. This is much closer to the true line shape, but it</span>
<span class="sd">        takes much more time to compute because of the generally very</span>
<span class="sd">        small value of sigma. This can be used to fit resolved lines,</span>
<span class="sd">        like e.g. Halpha in absorption or active nucleus with broader</span>
<span class="sd">        emission. See :py:meth:`cutils.sincgauss1d`.</span>
<span class="sd">      </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">accepted_keys</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;line_nb&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;fmodel&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;amp_def&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;pos_def&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;fwhm_def&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;sigma_def&#39;</span><span class="p">,</span> <span class="c1"># only for sincgauss fmodel</span>
                     <span class="s1">&#39;alpha_def&#39;</span><span class="p">,</span> <span class="c1"># only for sincphased fmode</span>
                     <span class="s1">&#39;amp_cov&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;pos_cov&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;fwhm_cov&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;sigma_cov&#39;</span><span class="p">,</span> <span class="c1"># only for sincgauss fmodel</span>
                     <span class="s1">&#39;alpha_cov&#39;</span><span class="p">,</span> <span class="c1"># only for sincphased fmodel</span>
                     <span class="s1">&#39;amp_guess&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;pos_guess&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;fwhm_guess&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;sigma_guess&#39;</span><span class="p">,</span> <span class="c1"># only for sincgauss fmodel</span>
                     <span class="s1">&#39;alpha_guess&#39;</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;Accepted keys of the input dictionary (see</span>
<span class="sd">    :py:attr:`fit.Model.p_dict`)&quot;&quot;&quot;</span>

    <span class="n">p_array</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;equivalent of :py:attr:`fit.Model.p_val` but presented as an</span>
<span class="sd">    array with each row corresponding to a line which is easier to</span>
<span class="sd">    handle.&quot;&quot;&quot;</span>


    <span class="n">param_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;amp&#39;</span><span class="p">,</span> <span class="s1">&#39;pos&#39;</span><span class="p">,</span> <span class="s1">&#39;fwhm&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Parameter keys&quot;&quot;&quot;</span>

    <span class="n">log_param_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fwhm&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Parameter keys that have a lognormal distribution&quot;&quot;&quot;</span>

    <span class="n">same_param_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fwhm&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot;Parameter keys which must be the same if covarying&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_get_ikey</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">iline</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return key for a given line nb in</span>
<span class="sd">        :py:attr:`fit.Model.p_val` and :py:attr:`fit.Model.p_def`</span>
<span class="sd">        dictionnaries</span>

<span class="sd">        :param key: may be &#39;amp&#39;, &#39;pos&#39;, &#39;fwhm&#39;, &#39;sigma&#39;, &#39;alpha&#39;</span>
<span class="sd">        :param iline: line number.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">iline</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_line_nb</span><span class="p">():</span>
                <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{}{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">iline</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Invalid line index, must be &gt;=0 and &lt; </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_line_nb</span><span class="p">()))</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Invalid paramter key. Must be in </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param_keys</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_get_iline_from_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the line nb of a given key</span>

<span class="sd">        :param key: Key to get line number from.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">_k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_k</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">_k</span><span class="p">):])</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Invalid format for key&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="LinesModel.get_p_val_as_array"><a class="viewcode-back" href="../../orb.html#orb.fit.LinesModel.get_p_val_as_array">[docs]</a>    <span class="k">def</span> <span class="nf">get_p_val_as_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_val</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">p_val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p_val</span><span class="o">.</span><span class="n">viewkeys</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_val</span><span class="o">.</span><span class="n">viewkeys</span><span class="p">():</span>
                <span class="n">p_val</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_val</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Badly formatted p_val&#39;</span><span class="p">)</span>

        <span class="n">ans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_line_nb</span><span class="p">(),</span>
                       <span class="nb">len</span><span class="p">(</span><span class="n">p_val</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_line_nb</span><span class="p">()))</span>

        <span class="k">for</span> <span class="n">ipar</span> <span class="ow">in</span> <span class="n">p_val</span><span class="p">:</span>
            <span class="n">iline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_iline_from_key</span><span class="p">(</span><span class="n">ipar</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;amp&#39;</span> <span class="ow">in</span> <span class="n">ipar</span><span class="p">:</span>
                <span class="n">ans</span><span class="p">[</span><span class="n">iline</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_val</span><span class="p">[</span><span class="n">ipar</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;pos&#39;</span> <span class="ow">in</span> <span class="n">ipar</span><span class="p">:</span>
                <span class="n">ans</span><span class="p">[</span><span class="n">iline</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_val</span><span class="p">[</span><span class="n">ipar</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;fwhm&#39;</span> <span class="ow">in</span> <span class="n">ipar</span><span class="p">:</span>
                <span class="n">ans</span><span class="p">[</span><span class="n">iline</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_val</span><span class="p">[</span><span class="n">ipar</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fmodel</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;sincgauss&#39;</span><span class="p">,</span> <span class="s1">&#39;sincgaussphased&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="s1">&#39;sigma&#39;</span> <span class="ow">in</span> <span class="n">ipar</span><span class="p">:</span>
                    <span class="n">ans</span><span class="p">[</span><span class="n">iline</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_val</span><span class="p">[</span><span class="n">ipar</span><span class="p">]</span>    
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fmodel</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;sincphased&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="s1">&#39;alpha&#39;</span> <span class="ow">in</span> <span class="n">ipar</span><span class="p">:</span>
                    <span class="n">ans</span><span class="p">[</span><span class="n">iline</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_val</span><span class="p">[</span><span class="n">ipar</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fmodel</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;sincgaussphased&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="s1">&#39;alpha&#39;</span> <span class="ow">in</span> <span class="n">ipar</span><span class="p">:</span>
                    <span class="n">ans</span><span class="p">[</span><span class="n">iline</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_val</span><span class="p">[</span><span class="n">ipar</span><span class="p">]</span>
            
        <span class="k">return</span> <span class="n">ans</span>    </div>

<div class="viewcode-block" id="LinesModel.get_priors"><a class="viewcode-back" href="../../orb.html#orb.fit.LinesModel.get_priors">[docs]</a>    <span class="k">def</span> <span class="nf">get_priors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">classic</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return priors. Replace gaussian distribution by lognormal</span>
<span class="sd">        distribution for some parameters.</span>

<span class="sd">        :param classic: If True, return classic priors (e.g. no log</span>
<span class="sd">          distribution)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">classic</span><span class="p">:</span>
            <span class="n">priors</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_p_free</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">priors</span><span class="p">:</span>
                <span class="n">priors</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">gvar</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">priors</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">priors</span>

        <span class="n">priors</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">p_free</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_p_free</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">p_free</span><span class="p">:</span>
            <span class="n">priors</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">=</span> <span class="n">gvar</span><span class="o">.</span><span class="n">gvar</span><span class="p">(</span><span class="n">p_free</span><span class="p">[</span><span class="n">ip</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">ilog</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_param_keys</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ilog</span> <span class="ow">in</span> <span class="n">ip</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">gvar</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">p_free</span><span class="p">[</span><span class="n">ip</span><span class="p">])</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">:</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="mf">1e-10</span>
                    <span class="k">else</span><span class="p">:</span> <span class="n">val</span> <span class="o">=</span> <span class="n">gvar</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">p_free</span><span class="p">[</span><span class="n">ip</span><span class="p">])</span>
                    <span class="n">priors</span><span class="p">[</span><span class="s1">&#39;log(</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ip</span><span class="p">)]</span> <span class="o">=</span> <span class="n">gvar</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">gvar</span><span class="o">.</span><span class="n">gvar</span><span class="p">(</span>
                        <span class="n">val</span><span class="p">,</span> <span class="n">gvar</span><span class="o">.</span><span class="n">sdev</span><span class="p">(</span><span class="n">p_free</span><span class="p">[</span><span class="n">ip</span><span class="p">])))</span>
                    <span class="c1">## priors[&#39;sqrt({})&#39;.format(ip)] = gvar.sqrt(gvar.gvar(</span>
                    <span class="c1">##     val, gvar.sdev(p_free[ip])))</span>
                    <span class="c1">## priors[&#39;erfinv({})&#39;.format(ip)] = gvar.gvar(</span>
                    <span class="c1">##     val, gvar.sdev(p_free[ip])) / gvar.sqrt(2)</span>
                                
                    <span class="k">del</span> <span class="n">priors</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span>
                    <span class="k">continue</span>

        <span class="k">return</span> <span class="n">priors</span></div>
    
        
<div class="viewcode-block" id="LinesModel.parse_dict"><a class="viewcode-back" href="../../orb.html#orb.fit.LinesModel.parse_dict">[docs]</a>    <span class="k">def</span> <span class="nf">parse_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse input dictionary :py:attr:`fit.Model.p_dict`&quot;&quot;&quot;</span>
        
        <span class="k">def</span> <span class="nf">parse_param</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">cov_operation</span><span class="p">):</span>
            <span class="n">key_guess</span> <span class="o">=</span> <span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;_guess&#39;</span>
            <span class="n">key_def</span> <span class="o">=</span> <span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;_def&#39;</span>
            <span class="n">key_cov</span> <span class="o">=</span> <span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;_cov&#39;</span>
            <span class="c1">## parse guess</span>
            <span class="n">p_guess</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">key_guess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">p_dict</span><span class="p">[</span><span class="n">key_guess</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_dict</span><span class="p">[</span><span class="n">key_guess</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">iline</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">line_nb</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_dict</span><span class="p">[</span><span class="n">key_guess</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_dict</span><span class="p">[</span><span class="n">key_guess</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        
                    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_dict</span><span class="p">[</span><span class="n">key_guess</span><span class="p">])</span> <span class="o">!=</span> <span class="n">line_nb</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> must have the same size as the number of lines or it must be a float&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key_guess</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_dict</span><span class="p">[</span><span class="n">key_guess</span><span class="p">][</span><span class="n">iline</span><span class="p">]</span>
                    <span class="n">p_guess</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ikey</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">iline</span><span class="p">)]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">iline</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">line_nb</span><span class="p">):</span>
                    <span class="n">p_guess</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ikey</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">iline</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">None</span>
                            
            <span class="c1">## parse cov  </span>
            <span class="k">if</span> <span class="n">key_cov</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_dict</span><span class="p">:</span>
                <span class="n">p_cov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_dict</span><span class="p">[</span><span class="n">key_cov</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p_cov</span> <span class="o">=</span> <span class="p">()</span>

            <span class="c1">## parse def</span>
            <span class="n">p_cov_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">p_def</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">key_def</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_dict</span><span class="p">:</span> <span class="c1"># gives the definition of the parameter</span>
                <span class="k">for</span> <span class="n">iline</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">line_nb</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_dict</span><span class="p">[</span><span class="n">key_def</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_dict</span><span class="p">[</span><span class="n">key_def</span><span class="p">])</span>
                        
                    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_dict</span><span class="p">[</span><span class="n">key_def</span><span class="p">])</span> <span class="o">!=</span> <span class="n">line_nb</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> must have the same size as the number of lines or it must be a float&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key_def</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_dict</span><span class="p">[</span><span class="n">key_def</span><span class="p">][</span><span class="n">iline</span><span class="p">]</span>
                    <span class="n">p_def</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ikey</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">iline</span><span class="p">)]</span> <span class="o">=</span> <span class="n">value</span>
                    
                <span class="c1"># manage cov values</span>
                <span class="n">cov_index</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">iline</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">line_nb</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">p_def</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ikey</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">iline</span><span class="p">)]</span> <span class="ow">not</span> <span class="ow">in</span>  <span class="p">[</span><span class="s1">&#39;free&#39;</span><span class="p">,</span> <span class="s1">&#39;fixed&#39;</span><span class="p">]:</span>
                        <span class="n">cov_symbol</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key_def</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p_def</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ikey</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">iline</span><span class="p">)]))</span>
                        
                        <span class="c1"># create singular symbol</span>
                        <span class="n">p_def</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ikey</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">iline</span><span class="p">)]</span> <span class="o">=</span> <span class="n">cov_symbol</span>
                        
                        <span class="c1"># fill cov dict</span>
                        <span class="k">if</span> <span class="n">cov_symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p_cov_dict</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">p_cov</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">cov_value</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">p_cov</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">cov_value</span> <span class="o">=</span> <span class="n">p_cov</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">cov_index</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">p_cov</span><span class="p">):</span>
                                    <span class="n">cov_value</span> <span class="o">=</span> <span class="n">p_cov</span><span class="p">[</span><span class="n">cov_index</span><span class="p">]</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> must have the same size as the number of covarying parameters or it must be a float&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key_cov</span><span class="p">))</span>
                                <span class="n">cov_index</span> <span class="o">+=</span> <span class="mi">1</span>

                                
                            <span class="n">p_cov_dict</span><span class="p">[</span><span class="n">cov_symbol</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">cov_value</span><span class="p">),</span> <span class="n">cov_operation</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">iline</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">line_nb</span><span class="p">):</span>
                    <span class="n">p_def</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ikey</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">iline</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;free&#39;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">p_def</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">p_def</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p_val</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">p_guess</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p_cov</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">p_cov_dict</span><span class="p">)</span>

        <span class="n">line_nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_line_nb</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p_def</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p_val</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p_cov</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">parse_param</span><span class="p">(</span><span class="s1">&#39;amp&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_amp_cov_operation</span><span class="p">())</span>
        <span class="n">parse_param</span><span class="p">(</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pos_cov_operation</span><span class="p">())</span>
        <span class="n">parse_param</span><span class="p">(</span><span class="s1">&#39;fwhm&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fwhm_cov_operation</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fmodel</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;sincgauss&#39;</span><span class="p">,</span> <span class="s1">&#39;sincgaussphased&#39;</span><span class="p">]:</span>
            <span class="n">parse_param</span><span class="p">(</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_sigma_cov_operation</span><span class="p">())</span>            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fmodel</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;sincphased&#39;</span><span class="p">,</span> <span class="s1">&#39;sincgaussphased&#39;</span><span class="p">]:</span>
            <span class="n">parse_param</span><span class="p">(</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_alpha_cov_operation</span><span class="p">())</span>    

        
        <span class="c1"># check cov values and def for log parameters sigma and fwhm</span>
        <span class="k">for</span> <span class="n">key_cov</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_cov</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">same_param_keys</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">key_cov</span><span class="p">:</span>
                    <span class="n">keys_def</span> <span class="o">=</span> <span class="p">[</span><span class="n">key_def</span> <span class="k">for</span> <span class="n">key_def</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_def</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_def</span><span class="p">[</span><span class="n">key_def</span><span class="p">]</span> <span class="o">==</span> <span class="n">key_cov</span><span class="p">]</span>
                    <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">p_val</span><span class="p">[</span><span class="n">ikey_def</span><span class="p">]</span> <span class="k">for</span> <span class="n">ikey_def</span> <span class="ow">in</span> <span class="n">keys_def</span><span class="p">]</span>
                    <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">vals</span> <span class="o">-</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> parameter must be the same for all the lines of the one covarying group&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">ikey_def</span> <span class="ow">in</span> <span class="n">keys_def</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">p_val</span><span class="p">[</span><span class="n">ikey_def</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">p_cov</span><span class="p">[</span><span class="n">key_cov</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_cov</span><span class="p">[</span><span class="n">key_cov</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_cov</span><span class="p">[</span><span class="n">key_cov</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span></div>

        
    <span class="k">def</span> <span class="nf">_get_amp_cov_operation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return covarying amplitude operation&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span>

    <span class="k">def</span> <span class="nf">_get_fwhm_cov_operation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return covarying FWHM operation&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

    <span class="k">def</span> <span class="nf">_get_pos_cov_operation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return covarying position operation&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

    <span class="k">def</span> <span class="nf">_get_sigma_cov_operation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return covarying sigma operation&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

    <span class="k">def</span> <span class="nf">_get_alpha_cov_operation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return covarying alpha operation&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>


<div class="viewcode-block" id="LinesModel.check_input"><a class="viewcode-back" href="../../orb.html#orb.fit.LinesModel.check_input">[docs]</a>    <span class="k">def</span> <span class="nf">check_input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check input parameters&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_val</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_val</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;pos&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No initial position given&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;fwhm&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No initial fwhm given&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fmodel</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;sincgauss&#39;</span><span class="p">,</span> <span class="s1">&#39;sincgaussphased&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="s1">&#39;sigma&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No initial sigma given&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fmodel</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;sincphased&#39;</span><span class="p">,</span> <span class="s1">&#39;sincgaussphased&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="s1">&#39;alpha&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No initial alpha given&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="LinesModel.make_guess"><a class="viewcode-back" href="../../orb.html#orb.fit.LinesModel.make_guess">[docs]</a>    <span class="k">def</span> <span class="nf">make_guess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;If a parameter value at init is a NaN this value is guessed.</span>

<span class="sd">        :param v: Data vector from which the guess is made.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">FWHM_INIT</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">constants</span><span class="o">.</span><span class="n">FWHM_SINC_COEFF</span>
        <span class="n">FWHM_COEFF</span> <span class="o">=</span> <span class="mf">6.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_p_val2array</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_array</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_array</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
                <span class="k">if</span> <span class="s1">&#39;pos&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;initial guess on lines position must be given, no automatic lines detection is implemented at this level.&#39;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="s1">&#39;fwhm&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">p_array</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">FWHM_INIT</span>
                    
                <span class="k">if</span> <span class="s1">&#39;sigma&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">p_array</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-8</span>

                <span class="k">if</span> <span class="s1">&#39;alpha&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">p_array</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-8</span>

        <span class="c1"># amp must be checked after the others</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_array</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_array</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;amp&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                    <span class="c1">## iline = self._get_iline_from_key(key)</span>

                    <span class="c1">## pos = gvar.mean(self.p_array[self._get_ikey(&#39;pos&#39;, iline)])</span>
                    <span class="c1">## fwhm = gvar.mean(self.p_array[self._get_ikey(&#39;fwhm&#39;, iline)])</span>
                    
                    <span class="c1">## pos_min = pos - fwhm * FWHM_COEFF</span>
                    <span class="c1">## pos_max = pos + fwhm * FWHM_COEFF + 1</span>
                    <span class="c1">## if pos_min &lt; 0: pos_min = 0</span>
                    <span class="c1">## if pos_max &gt;= np.size(v): pos_max = np.size(v) - 1</span>
                    <span class="c1">## if pos_min &lt; pos_max:</span>
                    <span class="c1">##     val_max = np.nanmax(gvar.mean(v)[</span>
                    <span class="c1">##         int(pos_min):int(pos_max)])</span>
                    <span class="c1">## else: val_max = 0.</span>
                    <span class="c1">## self.p_array[key] = val_max</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">p_array</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">gvar</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_p_array2val</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">val2free</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">_get_line_nb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the number of lines&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;line_nb&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_dict</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;line_nb&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;&#39;line_nb&#39; must be set&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_fmodel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the line model&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;fmodel&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_dict</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;fmodel&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;gaussian&#39;</span>

    <span class="k">def</span> <span class="nf">_estimate_sdev</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idef</span><span class="p">,</span> <span class="n">mean</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Estimate standard deviation of a free parameter</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">FWHM_SDEV</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># channels</span>
        <span class="n">SIGMA_SDEV</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># channels</span>

        <span class="c1"># get reference line if idef is a covariant parameter</span>
        <span class="k">if</span> <span class="s1">&#39;def&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">idef</span><span class="p">:</span>
            <span class="n">iline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_iline_from_key</span><span class="p">(</span><span class="n">idef</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">iline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_iline_from_key</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">p_def</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="bp">self</span><span class="o">.</span><span class="n">p_def</span><span class="o">.</span><span class="n">values</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">idef</span><span class="p">)])</span>

        <span class="k">if</span> <span class="s1">&#39;amp&#39;</span> <span class="ow">in</span> <span class="n">idef</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">gvar</span><span class="o">.</span><span class="n">gvar</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">mean</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;pos&#39;</span> <span class="ow">in</span> <span class="n">idef</span><span class="p">:</span>
            <span class="n">fwhm</span> <span class="o">=</span> <span class="n">gvar</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_val</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ikey</span><span class="p">(</span><span class="s1">&#39;fwhm&#39;</span><span class="p">,</span> <span class="n">iline</span><span class="p">)])</span>
            <span class="k">return</span> <span class="n">gvar</span><span class="o">.</span><span class="n">gvar</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;fwhm&#39;</span> <span class="ow">in</span> <span class="n">idef</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">gvar</span><span class="o">.</span><span class="n">gvar</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">FWHM_SDEV</span><span class="p">))</span>
        <span class="k">elif</span> <span class="s1">&#39;sigma&#39;</span> <span class="ow">in</span> <span class="n">idef</span><span class="p">:</span>            
            <span class="k">return</span> <span class="n">gvar</span><span class="o">.</span><span class="n">gvar</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">SIGMA_SDEV</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;not implemented for </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idef</span><span class="p">))</span>
        
    <span class="k">def</span> <span class="nf">_p_val2array</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p_array</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_val</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_p_array2val</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_array</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Transform :py:attr:`fit.LinesModel.p_array` to :py:attr:`fit.Model.p_val`.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">p_array</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p_val</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_array</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p_val</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">p_array</span><span class="p">)</span>


<div class="viewcode-block" id="LinesModel.get_model"><a class="viewcode-back" href="../../orb.html#orb.fit.LinesModel.get_model">[docs]</a>    <span class="k">def</span> <span class="nf">get_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">p_free</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_models</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return model M(x, p).</span>

<span class="sd">        :param x: Positions where the model M(x, p) is computed.</span>

<span class="sd">        :param p_free: (Optional) New values of the free parameters</span>
<span class="sd">          (default None).</span>
<span class="sd">          </span>
<span class="sd">        :param return_models: (Optional) If True return also</span>
<span class="sd">          individual models (default False)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">p_free</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_p_free</span><span class="p">(</span><span class="n">p_free</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">free2val</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_p_val2array</span><span class="p">()</span>

        <span class="n">line_nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_line_nb</span><span class="p">()</span>
        <span class="n">fmodel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fmodel</span><span class="p">()</span>
        
        <span class="n">mod</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">models</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">iline</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">line_nb</span><span class="p">):</span>
            
            <span class="k">if</span> <span class="n">fmodel</span> <span class="o">==</span> <span class="s1">&#39;sinc&#39;</span><span class="p">:</span>
                <span class="n">line_mod</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">sinc1d</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">p_array</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ikey</span><span class="p">(</span><span class="s1">&#39;amp&#39;</span><span class="p">,</span> <span class="n">iline</span><span class="p">)],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">p_array</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ikey</span><span class="p">(</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span> <span class="n">iline</span><span class="p">)],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">p_array</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ikey</span><span class="p">(</span><span class="s1">&#39;fwhm&#39;</span><span class="p">,</span> <span class="n">iline</span><span class="p">)])</span>
                
            <span class="k">elif</span> <span class="n">fmodel</span> <span class="o">==</span> <span class="s1">&#39;sincgauss&#39;</span><span class="p">:</span>
                <span class="n">line_mod</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">sincgauss1d</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">p_array</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ikey</span><span class="p">(</span><span class="s1">&#39;amp&#39;</span><span class="p">,</span> <span class="n">iline</span><span class="p">)],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">p_array</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ikey</span><span class="p">(</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span> <span class="n">iline</span><span class="p">)],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">p_array</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ikey</span><span class="p">(</span><span class="s1">&#39;fwhm&#39;</span><span class="p">,</span> <span class="n">iline</span><span class="p">)],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">p_array</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ikey</span><span class="p">(</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="n">iline</span><span class="p">)])</span>

            <span class="k">elif</span> <span class="n">fmodel</span> <span class="o">==</span> <span class="s1">&#39;sincphased&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;not implemented&#39;</span><span class="p">)</span>
                <span class="n">line_mod</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">sinc1d_phased</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_array</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ikey</span><span class="p">(</span><span class="s1">&#39;amp&#39;</span><span class="p">,</span> <span class="n">iline</span><span class="p">)],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">p_array</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ikey</span><span class="p">(</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span> <span class="n">iline</span><span class="p">)],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">p_array</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ikey</span><span class="p">(</span><span class="s1">&#39;fwhm&#39;</span><span class="p">,</span> <span class="n">iline</span><span class="p">)],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">p_array</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ikey</span><span class="p">(</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="n">iline</span><span class="p">)])</span>

            <span class="k">elif</span> <span class="n">fmodel</span> <span class="o">==</span> <span class="s1">&#39;sincgaussphased&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;not implemented&#39;</span><span class="p">)</span>
                <span class="n">line_mod</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">sincgauss1d_phased</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">p_array</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ikey</span><span class="p">(</span><span class="s1">&#39;amp&#39;</span><span class="p">,</span> <span class="n">iline</span><span class="p">)],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">p_array</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ikey</span><span class="p">(</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span> <span class="n">iline</span><span class="p">)],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">p_array</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ikey</span><span class="p">(</span><span class="s1">&#39;fwhm&#39;</span><span class="p">,</span> <span class="n">iline</span><span class="p">)],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">p_array</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ikey</span><span class="p">(</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="n">iline</span><span class="p">)],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">p_array</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ikey</span><span class="p">(</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="n">iline</span><span class="p">)])</span>

            <span class="k">elif</span> <span class="n">fmodel</span> <span class="o">==</span> <span class="s1">&#39;sinc2&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Not implemented&#39;</span><span class="p">)</span>
                <span class="c1">## line_mod =  np.sqrt(utils.spectrum.sinc1d(</span>
                <span class="c1">##     x, 0., p_array[iline, 0],</span>
                <span class="c1">##     p_array[iline, 1], p_array[iline, 2])**2.)</span>
                
            <span class="k">elif</span> <span class="n">fmodel</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
                <span class="n">line_mod</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">gaussian1d</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">p_array</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ikey</span><span class="p">(</span><span class="s1">&#39;amp&#39;</span><span class="p">,</span> <span class="n">iline</span><span class="p">)],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">p_array</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ikey</span><span class="p">(</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span> <span class="n">iline</span><span class="p">)],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">p_array</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ikey</span><span class="p">(</span><span class="s1">&#39;fwhm&#39;</span><span class="p">,</span> <span class="n">iline</span><span class="p">)])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;fmodel must be set to &#39;sinc&#39;, &#39;gaussian&#39;, &#39;sincgauss&#39;, &#39;sincphased&#39;, &#39;sincgaussphased&#39; or &#39;sinc2&#39;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mod</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">mod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">line_mod</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mod</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">line_mod</span><span class="p">)</span>
                
            <span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line_mod</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_models</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mod</span><span class="p">,</span> <span class="n">models</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mod</span></div></div>

<div class="viewcode-block" id="Cm1LinesModel"><a class="viewcode-back" href="../../orb.html#orb.fit.Cm1LinesModel">[docs]</a><span class="k">class</span> <span class="nc">Cm1LinesModel</span><span class="p">(</span><span class="n">LinesModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Emission/absorption lines model with a channel unity in cm-1.</span>

<span class="sd">    Reimplements :py:class:`fit.LinesModel` to use more physical units</span>
<span class="sd">    : channels are translated to cm-1 and velocity to km/s in input</span>
<span class="sd">    and output.</span>

<span class="sd">    .. seealso:: For more information please refer to</span>
<span class="sd">      :py:class:`fit.LinesModel`</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">accepted_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">LinesModel</span><span class="o">.</span><span class="n">accepted_keys</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">((</span>
        <span class="s1">&#39;step_nb&#39;</span><span class="p">,</span>
        <span class="s1">&#39;step&#39;</span><span class="p">,</span>
        <span class="s1">&#39;order&#39;</span><span class="p">,</span>
        <span class="s1">&#39;nm_laser&#39;</span><span class="p">,</span>
        <span class="s1">&#39;nm_laser_obs&#39;</span><span class="p">))</span>
    <span class="sd">&quot;&quot;&quot;Accepted keys of the input dictionary (see</span>
<span class="sd">    :py:attr:`fit.Model.p_dict`)&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_w2pix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Translate wavenumber to pixels&quot;&quot;&quot;</span>        
        <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">fast_w2pix</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis_step</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_pix2w</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pix</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Translate pixel to wavenumber&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">fast_pix2w</span><span class="p">(</span><span class="n">pix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis_step</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_pos_cov_operation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return covarying position operation for an input velocity in km/s&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">lines</span><span class="p">,</span> <span class="n">vel</span><span class="p">:</span> <span class="n">lines</span> <span class="o">*</span> <span class="n">gvar</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">vel</span> <span class="o">/</span> <span class="n">constants</span><span class="o">.</span><span class="n">LIGHT_VEL_KMS</span><span class="p">)</span>
                                                    <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">vel</span> <span class="o">/</span> <span class="n">constants</span><span class="o">.</span><span class="n">LIGHT_VEL_KMS</span><span class="p">))</span>
         
    <span class="k">def</span> <span class="nf">_p_val2array</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Transform :py:attr:`fit.Model.p_val` to :py:attr:`fit.LinesModel.p_array`&quot;&quot;&quot;</span>
        <span class="c1"># get lines pos / fwhm</span>
        <span class="c1"># convert pos cm-1-&gt;pix</span>
        <span class="c1"># convert fwhm cm-1-&gt;pix</span>
        <span class="n">lines_cm1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">fwhm_cm1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">sigma_kms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">iline</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_line_nb</span><span class="p">()):</span>
            <span class="n">lines_cm1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_val</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ikey</span><span class="p">(</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span> <span class="n">iline</span><span class="p">)])</span>
            <span class="n">fwhm_cm1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_val</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ikey</span><span class="p">(</span><span class="s1">&#39;fwhm&#39;</span><span class="p">,</span> <span class="n">iline</span><span class="p">)])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fmodel</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;sincgauss&#39;</span><span class="p">,</span> <span class="s1">&#39;sincgaussphased&#39;</span><span class="p">]:</span>
                <span class="n">sigma_kms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_val</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ikey</span><span class="p">(</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="n">iline</span><span class="p">)])</span>
        <span class="n">lines_pix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_w2pix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lines_cm1</span><span class="p">))</span>
        <span class="n">fwhm_pix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fwhm_cm1</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis_step</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fmodel</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;sincgauss&#39;</span><span class="p">,</span> <span class="s1">&#39;sincgaussphased&#39;</span><span class="p">]:</span>
            <span class="n">sigma_pix</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">fit</span><span class="o">.</span><span class="n">vel2sigma</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sigma_kms</span><span class="p">),</span> <span class="n">gvar</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">lines_cm1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis_step</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">p_array</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_val</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">iline</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_line_nb</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p_array</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ikey</span><span class="p">(</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span> <span class="n">iline</span><span class="p">)]</span> <span class="o">=</span> <span class="n">lines_pix</span><span class="p">[</span><span class="n">iline</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p_array</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ikey</span><span class="p">(</span><span class="s1">&#39;fwhm&#39;</span><span class="p">,</span> <span class="n">iline</span><span class="p">)]</span> <span class="o">=</span> <span class="n">fwhm_pix</span><span class="p">[</span><span class="n">iline</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fmodel</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;sincgauss&#39;</span><span class="p">,</span> <span class="s1">&#39;sincgaussphased&#39;</span><span class="p">]:</span>
                <span class="c1"># convert sigma km/s-&gt;pix</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">p_array</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ikey</span><span class="p">(</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="n">iline</span><span class="p">)]</span> <span class="o">=</span> <span class="n">sigma_pix</span><span class="p">[</span><span class="n">iline</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_array</span>

    <span class="k">def</span> <span class="nf">_p_array2val</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_array</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Transform :py:attr:`fit.LinesModel.p_array` to :py:attr:`fit.Model.p_val`.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">p_array</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">p_array</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_array</span><span class="p">)</span>
            
        <span class="c1"># get lines cm1 / fwhm</span>
        <span class="c1"># convert pos pix-&gt;cm-1</span>
        <span class="c1"># convert fwhm pix-&gt;cm-1</span>
        <span class="n">lines_pix</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">fwhm_pix</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">sigma_pix</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">iline</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_line_nb</span><span class="p">()):</span>
            <span class="n">lines_pix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_array</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ikey</span><span class="p">(</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span> <span class="n">iline</span><span class="p">)])</span>
            <span class="n">fwhm_pix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_array</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ikey</span><span class="p">(</span><span class="s1">&#39;fwhm&#39;</span><span class="p">,</span> <span class="n">iline</span><span class="p">)])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fmodel</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;sincgauss&#39;</span><span class="p">,</span> <span class="s1">&#39;sincgaussphased&#39;</span><span class="p">]:</span>
                <span class="n">sigma_pix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_array</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ikey</span><span class="p">(</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="n">iline</span><span class="p">)])</span>
            
        <span class="n">lines_cm1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pix2w</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lines_pix</span><span class="p">))</span>
        <span class="n">fwhm_cm1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fwhm_pix</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis_step</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fmodel</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;sincgauss&#39;</span><span class="p">,</span> <span class="s1">&#39;sincgaussphased&#39;</span><span class="p">]:</span>
            <span class="n">sigma_kms</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">fit</span><span class="o">.</span><span class="n">sigma2vel</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sigma_pix</span><span class="p">),</span> <span class="n">gvar</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">lines_cm1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis_step</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">p_val</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">p_array</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">iline</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_line_nb</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p_val</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ikey</span><span class="p">(</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span> <span class="n">iline</span><span class="p">)]</span> <span class="o">=</span> <span class="n">lines_cm1</span><span class="p">[</span><span class="n">iline</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p_val</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ikey</span><span class="p">(</span><span class="s1">&#39;fwhm&#39;</span><span class="p">,</span> <span class="n">iline</span><span class="p">)]</span> <span class="o">=</span> <span class="n">fwhm_cm1</span><span class="p">[</span><span class="n">iline</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fmodel</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;sincgauss&#39;</span><span class="p">,</span> <span class="s1">&#39;sincgaussphased&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">p_val</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ikey</span><span class="p">(</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="n">iline</span><span class="p">)]</span> <span class="o">=</span> <span class="n">sigma_kms</span><span class="p">[</span><span class="n">iline</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_val</span>
      

    <span class="k">def</span> <span class="nf">_estimate_sdev</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idef</span><span class="p">,</span> <span class="n">mean</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Estimate standard deviation of a free parameter</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">FWHM_SDEV</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># channels</span>
        <span class="n">SIGMA_SDEV</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># channels</span>

        <span class="n">fwhm_sdev_cm1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis_step</span> <span class="o">*</span> <span class="n">FWHM_SDEV</span>
        
        <span class="c1"># get reference line if idef is a covariant parameter</span>
        <span class="k">if</span> <span class="s1">&#39;def&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">idef</span><span class="p">:</span>
            <span class="n">iline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_iline_from_key</span><span class="p">(</span><span class="n">idef</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">iline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_iline_from_key</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">p_def</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="bp">self</span><span class="o">.</span><span class="n">p_def</span><span class="o">.</span><span class="n">values</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">idef</span><span class="p">)])</span>

        <span class="k">if</span> <span class="s1">&#39;amp&#39;</span> <span class="ow">in</span> <span class="n">idef</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">gvar</span><span class="o">.</span><span class="n">gvar</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">mean</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;pos&#39;</span> <span class="ow">in</span> <span class="n">idef</span><span class="p">:</span>
            <span class="n">fwhm</span> <span class="o">=</span> <span class="n">gvar</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_val</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ikey</span><span class="p">(</span><span class="s1">&#39;fwhm&#39;</span><span class="p">,</span> <span class="n">iline</span><span class="p">)])</span>
            <span class="k">return</span> <span class="n">gvar</span><span class="o">.</span><span class="n">gvar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">mean</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">fwhm_sdev_cm1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="s1">&#39;fwhm&#39;</span> <span class="ow">in</span> <span class="n">idef</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">gvar</span><span class="o">.</span><span class="n">gvar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">mean</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">fwhm_sdev_cm1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="s1">&#39;sigma&#39;</span> <span class="ow">in</span> <span class="n">idef</span><span class="p">:</span>
            <span class="n">lines_cm1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_val</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ikey</span><span class="p">(</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span> <span class="n">iline</span><span class="p">)]</span>
            <span class="n">sigma_sdev_kms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">fit</span><span class="o">.</span><span class="n">sigma2vel</span><span class="p">(</span>
                <span class="n">SIGMA_SDEV</span><span class="p">,</span> <span class="n">lines_cm1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis_step</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">gvar</span><span class="o">.</span><span class="n">gvar</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">gvar</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sigma_sdev_kms</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;not implemented for </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idef</span><span class="p">))</span>
        


<div class="viewcode-block" id="Cm1LinesModel.parse_dict"><a class="viewcode-back" href="../../orb.html#orb.fit.Cm1LinesModel.parse_dict">[docs]</a>    <span class="k">def</span> <span class="nf">parse_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse input dictionary :py:attr:`fit.Model.p_dict`&quot;&quot;&quot;</span>
        <span class="n">LinesModel</span><span class="o">.</span><span class="n">parse_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;step_nb&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_dict</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;step_nb keyword must be set&#39;</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_nb</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;step_nb&#39;</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="s1">&#39;step&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_dict</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;step keyword must be set&#39;</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="s1">&#39;order&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_dict</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;order keyword must be set&#39;</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="s1">&#39;nm_laser&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_dict</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;nm_laser keyword must be set&#39;</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nm_laser</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;nm_laser&#39;</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="s1">&#39;nm_laser_obs&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_dict</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;nm_laser_obs keyword must be set&#39;</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nm_laser_obs</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;nm_laser_obs&#39;</span><span class="p">])</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">correction_coeff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nm_laser_obs</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nm_laser</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">axis_min</span> <span class="o">=</span> <span class="n">cutils</span><span class="o">.</span><span class="n">get_cm1_axis_min</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step_nb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">,</span>
            <span class="n">corr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">correction_coeff</span><span class="p">)</span>
    
        <span class="bp">self</span><span class="o">.</span><span class="n">axis_step</span> <span class="o">=</span> <span class="n">cutils</span><span class="o">.</span><span class="n">get_cm1_axis_step</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step_nb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="n">corr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">correction_coeff</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="NmLinesModel"><a class="viewcode-back" href="../../orb.html#orb.fit.NmLinesModel">[docs]</a><span class="k">class</span> <span class="nc">NmLinesModel</span><span class="p">(</span><span class="n">Cm1LinesModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Emission/absorption lines model with a channel unity in nm.</span>

<span class="sd">    Reimplements :py:class:`fit.Cm1LinesModel` to use nm instead of</span>
<span class="sd">    cm-1. Channels are translated to cm-1 and velocity to km/s in</span>
<span class="sd">    input and output.</span>

<span class="sd">    .. seealso:: For more information please refer to</span>
<span class="sd">      :py:class:`fit.Cm1LinesModel` and :py:class:`fit.LinesModel`</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_get_pos_cov_operation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return covarying position operation for an input velocity in km/s&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">lines</span><span class="p">,</span> <span class="n">vel</span><span class="p">:</span> <span class="n">lines</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">vel</span> <span class="o">/</span> <span class="n">constants</span><span class="o">.</span><span class="n">LIGHT_VEL_KMS</span><span class="p">)</span>
                                                  <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">vel</span> <span class="o">/</span> <span class="n">constants</span><span class="o">.</span><span class="n">LIGHT_VEL_KMS</span><span class="p">))</span>

    
<div class="viewcode-block" id="NmLinesModel.parse_dict"><a class="viewcode-back" href="../../orb.html#orb.fit.NmLinesModel.parse_dict">[docs]</a>    <span class="k">def</span> <span class="nf">parse_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse input dictionary :py:attr:`fit.Model.p_dict`&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Not re-implemented&#39;</span><span class="p">)</span>
        <span class="n">Cm1LinesModel</span><span class="o">.</span><span class="n">parse_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">axis_min</span> <span class="o">=</span> <span class="n">cutils</span><span class="o">.</span><span class="n">get_nm_axis_min</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step_nb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">,</span>
            <span class="n">corr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">correction_coeff</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axis_step</span> <span class="o">=</span> <span class="n">cutils</span><span class="o">.</span><span class="n">get_nm_axis_step</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step_nb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">,</span>
            <span class="n">corr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">correction_coeff</span><span class="p">)</span></div></div>

<span class="c1">################################################</span>
<span class="c1">#### CLASS Params ##############################</span>
<span class="c1">################################################</span>
<div class="viewcode-block" id="Params"><a class="viewcode-back" href="../../orb.html#orb.fit.Params">[docs]</a><span class="k">class</span> <span class="nc">Params</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Manage a set of parameters as a special dictionary which</span>
<span class="sd">    elements can be accessed like attributes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="fm">__getattr__</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="fm">__getitem__</span>
    <span class="fm">__delattr__</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="fm">__delitem__</span>

    <span class="c1"># parameters cannot be modified when accessed by attribute</span>
    <span class="k">def</span> <span class="nf">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Parameter is read-only&#39;</span><span class="p">)</span></div>

<span class="c1">################################################</span>
<span class="c1">##### CLASS RawInputParams #####################</span>
<span class="c1">################################################</span>
<div class="viewcode-block" id="RawInputParams"><a class="viewcode-back" href="../../orb.html#orb.fit.RawInputParams">[docs]</a><span class="k">class</span> <span class="nc">RawInputParams</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">pass</span></div>
    

<span class="c1">################################################</span>
<span class="c1">#### CLASS InputParams ######################</span>
<span class="c1">################################################</span>
<div class="viewcode-block" id="InputParams"><a class="viewcode-back" href="../../orb.html#orb.fit.InputParams">[docs]</a><span class="k">class</span> <span class="nc">InputParams</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>


    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step_nb</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">base_params</span> <span class="o">=</span> <span class="n">Params</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_params</span><span class="p">[</span><span class="s1">&#39;step_nb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">step_nb</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">allparams</span> <span class="o">=</span> <span class="n">Params</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allparams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_params</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">axis_min</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axis_step</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axis_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_params</span><span class="o">.</span><span class="n">step_nb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_signal_range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axis_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis_max</span><span class="p">)</span>
        
<div class="viewcode-block" id="InputParams.append_model"><a class="viewcode-back" href="../../orb.html#orb.fit.InputParams.append_model">[docs]</a>    <span class="k">def</span> <span class="nf">append_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_model</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> already added&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">model</span><span class="p">,</span> <span class="n">operation</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_signal_range</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allparams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">params</span><span class="p">)</span></div>

<div class="viewcode-block" id="InputParams.set_signal_range"><a class="viewcode-back" href="../../orb.html#orb.fit.InputParams.set_signal_range">[docs]</a>    <span class="k">def</span> <span class="nf">set_signal_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rmin</span><span class="p">,</span> <span class="n">rmax</span><span class="p">):</span>    
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axis_min</span> <span class="o">&lt;=</span> <span class="n">rmin</span> <span class="o">&lt;</span> <span class="n">rmax</span><span class="p">)</span>
            <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span><span class="n">rmin</span> <span class="o">&lt;</span> <span class="n">rmax</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis_max</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Check rmin and rmax values. Must be between </span><span class="si">{}</span><span class="s1"> and </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">axis_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis_max</span><span class="p">))</span>
        
        <span class="n">signal_range_pix</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">fast_w2pix</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">rmin</span><span class="p">,</span> <span class="n">rmax</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">axis_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis_step</span><span class="p">)</span>
        <span class="n">minx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">signal_range_pix</span><span class="p">)))</span>
        <span class="n">maxx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_params</span><span class="o">.</span><span class="n">step_nb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                   <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">signal_range_pix</span><span class="p">))))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signal_range</span> <span class="o">=</span> <span class="p">(</span><span class="n">minx</span><span class="p">,</span> <span class="n">maxx</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_signal_range</span><span class="p">()</span></div>

<div class="viewcode-block" id="InputParams.has_model"><a class="viewcode-back" href="../../orb.html#orb.fit.InputParams.has_model">[docs]</a>    <span class="k">def</span> <span class="nf">has_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">imod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="n">imod</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="InputParams.check_signal_range"><a class="viewcode-back" href="../../orb.html#orb.fit.InputParams.check_signal_range">[docs]</a>    <span class="k">def</span> <span class="nf">check_signal_range</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="InputParams.convert"><a class="viewcode-back" href="../../orb.html#orb.fit.InputParams.convert">[docs]</a>    <span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert class to a raw pickable format</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="n">RawInputParams</span><span class="p">()</span>
        <span class="n">raw</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">)</span>
        <span class="n">raw</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">_iparams</span><span class="p">)</span> <span class="k">for</span> <span class="n">_iparams</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">]</span>
        <span class="n">raw</span><span class="o">.</span><span class="n">allparams</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">raw</span><span class="o">.</span><span class="n">signal_range</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signal_range</span><span class="p">)</span>
        <span class="n">raw</span><span class="o">.</span><span class="n">base_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_params</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_iparams</span> <span class="ow">in</span> <span class="n">raw</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
            <span class="n">raw</span><span class="o">.</span><span class="n">allparams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_iparams</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">raw</span></div>
   
<div class="viewcode-block" id="InputParams.add_continuum_model"><a class="viewcode-back" href="../../orb.html#orb.fit.InputParams.add_continuum_model">[docs]</a>    <span class="k">def</span> <span class="nf">add_continuum_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">poly_order</span><span class="p">,</span> <span class="n">cont_guess</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">Params</span><span class="p">()</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;poly_order&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">poly_order</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;poly_guess&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cont_guess</span>

        <span class="c1"># remove bad keys in case</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ContinuumModel</span><span class="o">.</span><span class="n">accepted_keys</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">append_model</span><span class="p">(</span><span class="n">ContinuumModel</span><span class="p">,</span> <span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span></div>

<div class="viewcode-block" id="InputParams.add_lines_model"><a class="viewcode-back" href="../../orb.html#orb.fit.InputParams.add_lines_model">[docs]</a>    <span class="k">def</span> <span class="nf">add_lines_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">fwhm_guess</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="n">SIGMA_COV_VEL</span> <span class="o">=</span> <span class="mf">1e-2</span> <span class="c1"># covariant sigma in channels, must be &gt; 0.</span>
        <span class="n">SIGMA_SDEV</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># channels</span>
        <span class="n">FWHM_SDEV</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># channels</span>
        <span class="n">SHIFT_SDEV</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># channels</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">gvar</span><span class="o">.</span><span class="n">sdev</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">):</span>
            <span class="n">lines_sdev</span> <span class="o">=</span> <span class="n">SHIFT_SDEV</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis_step</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">gvar</span><span class="o">.</span><span class="n">gvar</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">*</span> <span class="n">lines_sdev</span><span class="p">)</span>

        <span class="c1"># guess fwhm</span>
        <span class="n">fwhm_sdev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis_step</span> <span class="o">*</span> <span class="n">FWHM_SDEV</span>
        <span class="n">fwhm_guess</span> <span class="o">=</span> <span class="n">gvar</span><span class="o">.</span><span class="n">gvar</span><span class="p">(</span><span class="n">gvar</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">fwhm_guess</span><span class="p">),</span> <span class="n">fwhm_sdev</span><span class="p">)</span>


        <span class="n">sigma_guess</span> <span class="o">=</span> <span class="n">gvar</span><span class="o">.</span><span class="n">gvar</span><span class="p">(</span>
            <span class="mf">0.</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis_step</span> <span class="o">*</span> <span class="n">FWHM_SDEV</span><span class="p">)</span>


        <span class="n">default_params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;line_nb&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span>
            <span class="s1">&#39;amp_def&#39;</span><span class="p">:</span><span class="s1">&#39;free&#39;</span><span class="p">,</span>
            <span class="s1">&#39;amp_guess&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;amp_cov&#39;</span><span class="p">:</span><span class="mf">0.</span><span class="p">,</span>
            <span class="s1">&#39;fwhm_def&#39;</span><span class="p">:</span><span class="s1">&#39;free&#39;</span><span class="p">,</span>
            <span class="s1">&#39;fwhm_guess&#39;</span><span class="p">:</span><span class="n">fwhm_guess</span><span class="p">,</span>
            <span class="s1">&#39;fwhm_cov&#39;</span><span class="p">:</span><span class="n">gvar</span><span class="o">.</span><span class="n">gvar</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">gvar</span><span class="o">.</span><span class="n">sdev</span><span class="p">(</span><span class="n">fwhm_guess</span><span class="p">)),</span>
            <span class="s1">&#39;pos_def&#39;</span><span class="p">:</span><span class="s1">&#39;free&#39;</span><span class="p">,</span>
            <span class="s1">&#39;pos_guess&#39;</span><span class="p">:</span><span class="n">lines</span><span class="p">,</span>
            <span class="s1">&#39;pos_cov&#39;</span><span class="p">:</span><span class="n">gvar</span><span class="o">.</span><span class="n">gvar</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">gvar</span><span class="o">.</span><span class="n">sdev</span><span class="p">(</span><span class="n">lines</span><span class="p">))),</span>
            <span class="s1">&#39;fmodel&#39;</span><span class="p">:</span><span class="s1">&#39;gaussian&#39;</span><span class="p">,</span>
            <span class="s1">&#39;sigma_def&#39;</span><span class="p">:</span><span class="s1">&#39;free&#39;</span><span class="p">,</span>
            <span class="s1">&#39;sigma_guess&#39;</span><span class="p">:</span><span class="n">sigma_guess</span><span class="p">,</span>
            <span class="s1">&#39;sigma_cov&#39;</span><span class="p">:</span><span class="n">gvar</span><span class="o">.</span><span class="n">gvar</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">gvar</span><span class="o">.</span><span class="n">sdev</span><span class="p">(</span><span class="n">sigma_guess</span><span class="p">)),</span>
            <span class="s1">&#39;alpha_def&#39;</span><span class="p">:</span><span class="s1">&#39;free&#39;</span><span class="p">,</span>
            <span class="s1">&#39;alpha_guess&#39;</span><span class="p">:</span><span class="mf">0.</span><span class="p">,</span>
            <span class="s1">&#39;alpha_cov&#39;</span><span class="p">:</span><span class="mf">0.</span><span class="p">}</span>

        <span class="c1"># check and update default params with user kwargs</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">Params</span><span class="p">()</span>
        <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;fmodel&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">fmodel</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;sincgauss&#39;</span><span class="p">,</span> <span class="s1">&#39;sincgaussphased&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="s1">&#39;fwhm_def&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">fwhm_def</span> <span class="o">!=</span> <span class="s1">&#39;fixed&#39;</span><span class="p">:</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;fmodel is a sincgauss and FWHM is not fixed&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;fwhm_def&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;fixed&#39;</span>
                    
                <span class="k">if</span> <span class="s1">&#39;sigma_def&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">sigma_def</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;free&#39;</span><span class="p">,</span> <span class="s1">&#39;fixed&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="s1">&#39;sigma_guess&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                            <span class="c1"># sigma cov vel is adjusted to the initial guess + apodization</span>
                            <span class="n">sigma_guess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sigma_guess</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="n">params</span><span class="o">.</span><span class="n">sigma_guess</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>
                        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;sigma_guess&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span> <span class="c1"># must be set to 0 if covarying    </span>

                        <span class="k">if</span> <span class="s1">&#39;sigma_cov&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;sigma_cov&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigma_guess</span>
                    
        <span class="k">if</span> <span class="s1">&#39;fwhm_guess&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;This parameter must be defined with the non-keyword parameter fwhm_guess&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;line_nb&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">params</span><span class="o">.</span><span class="n">line_nb</span> <span class="c1"># this parameter cannot be changed</span>

        <span class="k">if</span> <span class="s1">&#39;pos_guess&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Line position must be defined with the &#39;lines&#39; parameter&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;pos_cov&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;pos_def&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">pos_def</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;free&#39;</span><span class="p">,</span> <span class="s1">&#39;fixed&#39;</span><span class="p">]:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;pos_def must not be fixed or free if a velocity shift (pos_cov) is given&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">pos_cov</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;The velocity shift (pos_cov) must be only one floating number if the covariance definition (pos_def) is not given&#39;</span><span class="p">)</span>
                <span class="n">params</span><span class="p">[</span><span class="s1">&#39;pos_def&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
        
       
        <span class="n">default_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

        <span class="n">all_params</span> <span class="o">=</span> <span class="n">Params</span><span class="p">()</span>
        <span class="n">all_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_params</span><span class="p">)</span>
        <span class="n">all_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">default_params</span><span class="p">)</span>

        <span class="c1"># remove bad keys in case</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">all_params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">LinesModel</span><span class="o">.</span><span class="n">accepted_keys</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">all_params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">append_model</span><span class="p">(</span><span class="n">LinesModel</span><span class="p">,</span> <span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="n">all_params</span><span class="p">)</span>
        
        <span class="c1"># continuum model is automatically added</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_continuum_model</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div></div>


<span class="c1">################################################</span>
<span class="c1">#### CLASS Cm1InputParams ######################</span>
<span class="c1">################################################</span>
<div class="viewcode-block" id="Cm1InputParams"><a class="viewcode-back" href="../../orb.html#orb.fit.Cm1InputParams">[docs]</a><span class="k">class</span> <span class="nc">Cm1InputParams</span><span class="p">(</span><span class="n">InputParams</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Manage the input parameters for :py:class:`orb.fit.FitVector`</span>
<span class="sd">    and :py:meth:`orb.fit.fit_lines_in_spectrum`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">step_nb</span><span class="p">,</span> <span class="n">nm_laser</span><span class="p">,</span>
                 <span class="n">axis_corr</span><span class="p">,</span> <span class="n">apodization</span><span class="p">,</span> <span class="n">zpd_index</span><span class="p">,</span> <span class="n">filter_file_path</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">base_params</span> <span class="o">=</span> <span class="n">Params</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_params</span><span class="p">[</span><span class="s1">&#39;step_nb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">step_nb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_params</span><span class="p">[</span><span class="s1">&#39;step&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_params</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_params</span><span class="p">[</span><span class="s1">&#39;nm_laser&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">nm_laser</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_params</span><span class="p">[</span><span class="s1">&#39;apodization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">apodization</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_params</span><span class="p">[</span><span class="s1">&#39;axis_corr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">axis_corr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_params</span><span class="p">[</span><span class="s1">&#39;zpd_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">zpd_index</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_params</span><span class="p">[</span><span class="s1">&#39;nm_laser_obs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_params</span><span class="o">.</span><span class="n">nm_laser</span>
                                            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_params</span><span class="o">.</span><span class="n">axis_corr</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">base_params</span><span class="p">[</span><span class="s1">&#39;filter_file_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">filter_file_path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">allparams</span> <span class="o">=</span> <span class="n">Params</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allparams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_params</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">axis_min</span> <span class="o">=</span> <span class="n">cutils</span><span class="o">.</span><span class="n">get_cm1_axis_min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_params</span><span class="o">.</span><span class="n">step_nb</span><span class="p">,</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">base_params</span><span class="o">.</span><span class="n">step</span><span class="p">,</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">base_params</span><span class="o">.</span><span class="n">order</span><span class="p">,</span>
                                                <span class="n">corr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_params</span><span class="o">.</span><span class="n">axis_corr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axis_step</span> <span class="o">=</span> <span class="n">cutils</span><span class="o">.</span><span class="n">get_cm1_axis_step</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_params</span><span class="o">.</span><span class="n">step_nb</span><span class="p">,</span>
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">base_params</span><span class="o">.</span><span class="n">step</span><span class="p">,</span>
                                                   <span class="n">corr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_params</span><span class="o">.</span><span class="n">axis_corr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axis_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis_min</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_params</span><span class="o">.</span><span class="n">step_nb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis_step</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_params</span><span class="o">.</span><span class="n">step_nb</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis_step</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis_min</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">set_signal_range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axis_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis_max</span><span class="p">)</span>
        
<div class="viewcode-block" id="Cm1InputParams.add_lines_model"><a class="viewcode-back" href="../../orb.html#orb.fit.Cm1InputParams.add_lines_model">[docs]</a>    <span class="k">def</span> <span class="nf">add_lines_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="n">SIGMA_COV_VEL</span> <span class="o">=</span> <span class="mf">1e-2</span> <span class="c1"># covariant sigma in km/s, must be &gt; 0.</span>
        <span class="n">SIGMA_SDEV</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># channels</span>
        <span class="n">FWHM_SDEV</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># channels</span>
        <span class="n">SHIFT_SDEV</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># channels</span>

    
        <span class="c1"># guess lines</span>
        <span class="n">lines_cm1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">iline</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">iline</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">iline</span> <span class="o">=</span> <span class="n">Lines</span><span class="p">()</span><span class="o">.</span><span class="n">get_line_cm1</span><span class="p">(</span><span class="n">iline</span><span class="p">)</span>
            <span class="n">lines_cm1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iline</span><span class="p">)</span>

        <span class="n">lines_cm1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lines_cm1</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">gvar</span><span class="o">.</span><span class="n">sdev</span><span class="p">(</span><span class="n">lines_cm1</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">):</span>            
            <span class="n">lines_cm1_sdev</span> <span class="o">=</span> <span class="n">SHIFT_SDEV</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis_step</span>
            <span class="n">lines_cm1</span> <span class="o">=</span> <span class="n">gvar</span><span class="o">.</span><span class="n">gvar</span><span class="p">(</span><span class="n">lines_cm1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">lines_cm1</span><span class="p">)</span> <span class="o">*</span> <span class="n">lines_cm1_sdev</span><span class="p">)</span>

        <span class="c1"># guess fwhm</span>
        <span class="n">fwhm_guess_cm1</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">compute_line_fwhm</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_params</span><span class="o">.</span><span class="n">step_nb</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_params</span><span class="o">.</span><span class="n">zpd_index</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_params</span><span class="o">.</span><span class="n">step</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_params</span><span class="o">.</span><span class="n">order</span><span class="p">,</span>
            <span class="n">apod_coeff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_params</span><span class="o">.</span><span class="n">apodization</span><span class="p">,</span>
            <span class="n">corr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_params</span><span class="o">.</span><span class="n">axis_corr</span><span class="p">,</span>
            <span class="n">wavenumber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">fwhm_sdev_cm1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis_step</span> <span class="o">*</span> <span class="n">FWHM_SDEV</span>
        <span class="n">fwhm_guess_cm1</span> <span class="o">=</span> <span class="n">gvar</span><span class="o">.</span><span class="n">gvar</span><span class="p">(</span><span class="n">fwhm_guess_cm1</span><span class="p">,</span> <span class="n">fwhm_sdev_cm1</span><span class="p">)</span>


        <span class="c1"># guess sigma from apodization</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_params</span><span class="o">.</span><span class="n">apodization</span> <span class="o">==</span> <span class="mf">1.</span><span class="p">:</span>
            <span class="n">sigma_cov_vel</span> <span class="o">=</span> <span class="n">SIGMA_COV_VEL</span> <span class="c1"># km/s</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sigma_cov_vel</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">fit</span><span class="o">.</span><span class="n">sigma2vel</span><span class="p">(</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">apod2sigma</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_params</span><span class="o">.</span><span class="n">apodization</span><span class="p">,</span>
                                     <span class="n">fwhm_guess_cm1</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis_step</span><span class="p">,</span>
                <span class="n">lines_cm1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis_step</span><span class="p">)</span>

        <span class="n">sigma_sdev_kms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">fit</span><span class="o">.</span><span class="n">sigma2vel</span><span class="p">(</span>
            <span class="n">SIGMA_SDEV</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lines_cm1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis_step</span><span class="p">))</span>

        <span class="n">sigma_cov_vel</span> <span class="o">=</span> <span class="n">gvar</span><span class="o">.</span><span class="n">gvar</span><span class="p">(</span><span class="n">sigma_cov_vel</span><span class="p">,</span> <span class="n">gvar</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sigma_sdev_kms</span><span class="p">))</span>


        <span class="n">default_params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;line_nb&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span>
            <span class="s1">&#39;amp_def&#39;</span><span class="p">:</span><span class="s1">&#39;free&#39;</span><span class="p">,</span>
            <span class="s1">&#39;amp_guess&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;amp_cov&#39;</span><span class="p">:</span><span class="mf">0.</span><span class="p">,</span>
            <span class="s1">&#39;fwhm_def&#39;</span><span class="p">:</span><span class="s1">&#39;free&#39;</span><span class="p">,</span>
            <span class="s1">&#39;fwhm_guess&#39;</span><span class="p">:</span><span class="n">fwhm_guess_cm1</span><span class="p">,</span>
            <span class="s1">&#39;fwhm_cov&#39;</span><span class="p">:</span><span class="n">gvar</span><span class="o">.</span><span class="n">gvar</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">gvar</span><span class="o">.</span><span class="n">sdev</span><span class="p">(</span><span class="n">fwhm_guess_cm1</span><span class="p">)),</span>
            <span class="s1">&#39;pos_def&#39;</span><span class="p">:</span><span class="s1">&#39;free&#39;</span><span class="p">,</span>
            <span class="s1">&#39;pos_guess&#39;</span><span class="p">:</span><span class="n">lines_cm1</span><span class="p">,</span>
            <span class="s1">&#39;pos_cov&#39;</span><span class="p">:</span><span class="n">gvar</span><span class="o">.</span><span class="n">gvar</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">gvar</span><span class="o">.</span><span class="n">sdev</span><span class="p">(</span><span class="n">lines_cm1</span><span class="p">))),</span>
            <span class="s1">&#39;fmodel&#39;</span><span class="p">:</span><span class="s1">&#39;gaussian&#39;</span><span class="p">,</span>
            <span class="s1">&#39;sigma_def&#39;</span><span class="p">:</span><span class="s1">&#39;free&#39;</span><span class="p">,</span>
            <span class="s1">&#39;sigma_guess&#39;</span><span class="p">:</span><span class="n">sigma_cov_vel</span><span class="p">,</span>
            <span class="s1">&#39;sigma_cov&#39;</span><span class="p">:</span><span class="n">gvar</span><span class="o">.</span><span class="n">gvar</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">gvar</span><span class="o">.</span><span class="n">sdev</span><span class="p">(</span><span class="n">sigma_cov_vel</span><span class="p">)),</span>
            <span class="s1">&#39;alpha_def&#39;</span><span class="p">:</span><span class="s1">&#39;free&#39;</span><span class="p">,</span>
            <span class="s1">&#39;alpha_guess&#39;</span><span class="p">:</span><span class="mf">0.</span><span class="p">,</span>
            <span class="s1">&#39;alpha_cov&#39;</span><span class="p">:</span><span class="mf">0.</span><span class="p">}</span>

        <span class="c1"># check and update default params with user kwargs</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">Params</span><span class="p">()</span>
        <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;fmodel&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">fmodel</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;sincgauss&#39;</span><span class="p">,</span> <span class="s1">&#39;sincgaussphased&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="s1">&#39;fwhm_def&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">fwhm_def</span> <span class="o">!=</span> <span class="s1">&#39;fixed&#39;</span><span class="p">:</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;fmodel is a sincgauss and FWHM is not fixed&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;fwhm_def&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;fixed&#39;</span>
                    
                <span class="k">if</span> <span class="s1">&#39;sigma_def&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">sigma_def</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;free&#39;</span><span class="p">,</span> <span class="s1">&#39;fixed&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="s1">&#39;sigma_guess&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                            <span class="c1"># sigma cov vel is adjusted to the initial guess + apodization</span>
                            <span class="n">sigma_cov_vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sigma_cov_vel</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="n">params</span><span class="o">.</span><span class="n">sigma_guess</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>
                        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;sigma_guess&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span> <span class="c1"># must be set to 0 if covarying    </span>

                        <span class="k">if</span> <span class="s1">&#39;sigma_cov&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;sigma_cov&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigma_cov_vel</span>
                    
                    

        <span class="k">if</span> <span class="s1">&#39;line_nb&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">params</span><span class="o">.</span><span class="n">line_nb</span> <span class="c1"># this parameter cannot be changed</span>

        <span class="k">if</span> <span class="s1">&#39;pos_guess&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Line position must be defined with the &#39;lines&#39; parameter&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;pos_cov&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;pos_def&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">pos_def</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;free&#39;</span><span class="p">,</span> <span class="s1">&#39;fixed&#39;</span><span class="p">]:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;pos_def must not be fixed or free if a velocity shift (pos_cov) is given&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">pos_cov</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;The velocity shift (pos_cov) must be only one floating number if the covariance definition (pos_def) is not given&#39;</span><span class="p">)</span>
                <span class="n">params</span><span class="p">[</span><span class="s1">&#39;pos_def&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
        
       
        <span class="n">default_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>


        <span class="n">all_params</span> <span class="o">=</span> <span class="n">Params</span><span class="p">()</span>
        <span class="n">all_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_params</span><span class="p">)</span>
        <span class="n">all_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">default_params</span><span class="p">)</span>

        <span class="c1"># remove bad keys in case</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">all_params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Cm1LinesModel</span><span class="o">.</span><span class="n">accepted_keys</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">all_params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">append_model</span><span class="p">(</span><span class="n">Cm1LinesModel</span><span class="p">,</span> <span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="n">all_params</span><span class="p">)</span>
        
        <span class="c1"># continuum model is automatically added</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_continuum_model</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="Cm1InputParams.add_filter_model"><a class="viewcode-back" href="../../orb.html#orb.fit.Cm1InputParams.add_filter_model">[docs]</a>    <span class="k">def</span> <span class="nf">add_filter_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_params</span><span class="o">.</span><span class="n">filter_file_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;filter_file_path is None&#39;</span><span class="p">)</span>
        
        <span class="n">filter_spline_nm</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">read_filter_file</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_params</span><span class="o">.</span><span class="n">filter_file_path</span><span class="p">,</span> <span class="n">return_spline</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">nm_axis_ireg</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">create_nm_axis_ireg</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_params</span><span class="o">.</span><span class="n">step_nb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_params</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_params</span><span class="o">.</span><span class="n">order</span><span class="p">,</span>
            <span class="n">corr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_params</span><span class="o">.</span><span class="n">axis_corr</span><span class="p">)</span>
        <span class="n">filter_function</span> <span class="o">=</span> <span class="n">filter_spline_nm</span><span class="p">(</span><span class="n">nm_axis_ireg</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span> <span class="o">/</span> <span class="mf">100.</span>
        

        <span class="n">default_params</span> <span class="o">=</span> <span class="n">Params</span><span class="p">()</span>
        <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;filter_function&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filter_function</span>
        <span class="n">default_params</span><span class="p">[</span><span class="s1">&#39;shift_def&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;free&#39;</span>

        <span class="c1"># load user params</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">Params</span><span class="p">()</span>
        <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;filter_function&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;filter function must be defined via the filter file path at the init of the class&#39;</span><span class="p">)</span>

        <span class="n">default_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

        <span class="n">all_params</span> <span class="o">=</span> <span class="n">Params</span><span class="p">()</span>
        <span class="n">all_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_params</span><span class="p">)</span>
        <span class="n">all_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">default_params</span><span class="p">)</span>

        <span class="c1"># remove bad keys in case</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">all_params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">FilterModel</span><span class="o">.</span><span class="n">accepted_keys</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">all_params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">append_model</span><span class="p">(</span><span class="n">FilterModel</span><span class="p">,</span> <span class="s1">&#39;mult&#39;</span><span class="p">,</span> <span class="n">all_params</span><span class="p">)</span></div>
        
        
<div class="viewcode-block" id="Cm1InputParams.check_signal_range"><a class="viewcode-back" href="../../orb.html#orb.fit.Cm1InputParams.check_signal_range">[docs]</a>    <span class="k">def</span> <span class="nf">check_signal_range</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_model</span><span class="p">(</span><span class="n">FilterModel</span><span class="p">):</span>
            <span class="n">filter_bandpass</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">nm2cm1</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">get_filter_bandpass</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">base_params</span><span class="o">.</span><span class="n">filter_file_path</span><span class="p">))</span>

            <span class="k">if</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signal_range_cm1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">min</span><span class="p">(</span><span class="n">filter_bandpass</span><span class="p">)</span>
                <span class="ow">or</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signal_range_cm1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">max</span><span class="p">(</span><span class="n">filter_bandpass</span><span class="p">)):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Filter model might be badly constrained with such a signal range&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cm1InputParams.set_signal_range"><a class="viewcode-back" href="../../orb.html#orb.fit.Cm1InputParams.set_signal_range">[docs]</a>    <span class="k">def</span> <span class="nf">set_signal_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rmin</span><span class="p">,</span> <span class="n">rmax</span><span class="p">):</span>
        <span class="n">InputParams</span><span class="o">.</span><span class="n">set_signal_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rmin</span><span class="p">,</span> <span class="n">rmax</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signal_range_cm1</span> <span class="o">=</span> <span class="p">(</span><span class="n">rmin</span><span class="p">,</span> <span class="n">rmax</span><span class="p">)</span></div>


<div class="viewcode-block" id="Cm1InputParams.convert"><a class="viewcode-back" href="../../orb.html#orb.fit.Cm1InputParams.convert">[docs]</a>    <span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="n">InputParams</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">raw</span><span class="o">.</span><span class="n">signal_range_cm1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">signal_range_cm1</span>
        <span class="k">return</span> <span class="n">raw</span></div></div>


<span class="c1">################################################</span>
<span class="c1">#### CLASS OutputParams ########################</span>
<span class="c1">################################################</span>

<div class="viewcode-block" id="OutputParams"><a class="viewcode-back" href="../../orb.html#orb.fit.OutputParams">[docs]</a><span class="k">class</span> <span class="nc">OutputParams</span><span class="p">(</span><span class="n">Params</span><span class="p">):</span>


<div class="viewcode-block" id="OutputParams.translate"><a class="viewcode-back" href="../../orb.html#orb.fit.OutputParams.translate">[docs]</a>    <span class="k">def</span> <span class="nf">translate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputparams</span><span class="p">,</span> <span class="n">fitvector</span><span class="p">):</span>

        <span class="n">all_inputparams</span> <span class="o">=</span> <span class="n">Params</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">iparams</span> <span class="ow">in</span> <span class="n">inputparams</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
            <span class="n">all_inputparams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">iparams</span><span class="p">)</span>
        <span class="n">all_inputparams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">inputparams</span><span class="o">.</span><span class="n">base_params</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inputparams</span><span class="p">,</span> <span class="n">Cm1InputParams</span><span class="p">):</span>
            <span class="n">wavenumber</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inputparams</span><span class="p">,</span> <span class="n">InputParams</span><span class="p">):</span>
            <span class="n">wavenumber</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Not implemented yet&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fitvector</span><span class="p">,</span> <span class="n">FitVector</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;fitvector must be an instance of FitVector&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;fit_params_err_mcmc&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">fit_params_err_key</span> <span class="o">=</span> <span class="s1">&#39;fit_params_err_mcmc&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fit_params_err_key</span> <span class="o">=</span> <span class="s1">&#39;fit_params_err&#39;</span>

        <span class="c1">## create a formated version of the parameters:</span>
        <span class="c1">## [N_LINES, (H, A, DX, FWHM, SIGMA, ALPHA)]</span>

        <span class="n">line_nb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">all_inputparams</span><span class="o">.</span><span class="n">pos_guess</span><span class="p">)</span>
        <span class="n">line_params</span> <span class="o">=</span> <span class="n">fitvector</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_p_val_as_array</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;fit_params&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">all_inputparams</span><span class="o">.</span><span class="n">fmodel</span> <span class="o">==</span> <span class="s1">&#39;sincgauss&#39;</span><span class="p">:</span>
            <span class="n">line_params</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">line_params</span><span class="p">[:,</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nan_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">line_nb</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="n">nan_col</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">line_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line_params</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">nan_col</span><span class="p">)</span>
            <span class="n">line_params</span> <span class="o">=</span> <span class="n">line_params</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="n">line_params</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">line_nb</span><span class="p">,</span> <span class="n">line_nb</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># evaluate continuum level at each position</span>
        <span class="n">cont_params</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;fit_params&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">wavenumber</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pos_pix</span> <span class="o">=</span> <span class="n">line_params</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pos_pix</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">fast_w2pix</span><span class="p">(</span>
                <span class="n">line_params</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">inputparams</span><span class="o">.</span><span class="n">axis_min</span><span class="p">,</span>
                <span class="n">inputparams</span><span class="o">.</span><span class="n">axis_step</span><span class="p">)</span>

        <span class="n">cont_model</span> <span class="o">=</span> <span class="n">fitvector</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">cont_model</span><span class="o">.</span><span class="n">set_p_val</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;fit_params&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">cont_level</span> <span class="o">=</span> <span class="n">cont_model</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">pos_pix</span><span class="p">)</span>
        <span class="n">all_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cont_level</span><span class="p">,</span> <span class="n">line_params</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">line_params</span> <span class="o">=</span> <span class="n">all_params</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
            <span class="p">(</span><span class="n">all_params</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">line_nb</span><span class="p">,</span> <span class="n">line_nb</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>


        <span class="c1"># compute vel err</span>
        <span class="n">line_params_err</span> <span class="o">=</span> <span class="n">fitvector</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_p_val_as_array</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">fit_params_err_key</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">all_inputparams</span><span class="o">.</span><span class="n">fmodel</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;sincgauss&#39;</span><span class="p">,</span> <span class="s1">&#39;sincgaussphased&#39;</span><span class="p">]:</span>
            <span class="n">line_params_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line_params_err</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">nan_col</span><span class="p">)</span>
            <span class="n">line_params_err</span> <span class="o">=</span> <span class="n">line_params_err</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="n">line_params_err</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">line_nb</span><span class="p">,</span> <span class="n">line_nb</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># evaluate error on continuum level at each position</span>
        <span class="n">cont_params_err</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">fit_params_err_key</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">cont_params_err_max</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">cont_params_err_min</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">cont_params</span><span class="p">:</span>
            <span class="n">cont_params_err_max</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">cont_params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+</span> <span class="n">cont_params_err</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.</span>
            <span class="n">cont_params_err_min</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">cont_params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">-</span> <span class="n">cont_params_err</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">cont_model</span><span class="o">.</span><span class="n">set_p_val</span><span class="p">(</span><span class="n">cont_params_err_max</span><span class="p">)</span>
        <span class="n">cont_level_max</span> <span class="o">=</span> <span class="n">cont_model</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">pos_pix</span><span class="p">)</span>
        <span class="n">cont_model</span><span class="o">.</span><span class="n">set_p_val</span><span class="p">(</span><span class="n">cont_params_err_min</span><span class="p">)</span>
        <span class="n">cont_level_min</span> <span class="o">=</span> <span class="n">cont_model</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">pos_pix</span><span class="p">)</span>
        <span class="n">cont_level_err</span> <span class="o">=</span> <span class="n">gvar</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">cont_level_max</span> <span class="o">-</span> <span class="n">cont_level_min</span><span class="p">)</span>
        <span class="n">all_params_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cont_level_err</span><span class="p">,</span> <span class="n">line_params_err</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">line_params_err</span> <span class="o">=</span> <span class="n">all_params_err</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
            <span class="p">(</span><span class="n">all_params_err</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">line_nb</span><span class="p">,</span> <span class="n">line_nb</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>


        <span class="c1"># set 0 sigma to nan</span>
        <span class="k">if</span> <span class="n">all_inputparams</span><span class="o">.</span><span class="n">fmodel</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;sincgauss&#39;</span><span class="p">,</span> <span class="s1">&#39;sincgaussphased&#39;</span><span class="p">]:</span>
            <span class="n">line_params</span><span class="p">[:,</span><span class="mi">4</span><span class="p">][</span><span class="n">line_params</span><span class="p">[:,</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">if</span> <span class="n">fit_params_err_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="n">line_params_err</span><span class="p">[:,</span><span class="mi">4</span><span class="p">][</span><span class="n">line_params_err</span><span class="p">[:,</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>


        <span class="c1">## compute errors</span>
        <span class="n">line_params</span> <span class="o">=</span> <span class="n">gvar</span><span class="o">.</span><span class="n">gvar</span><span class="p">(</span><span class="n">gvar</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">line_params</span><span class="p">),</span>
                                <span class="n">gvar</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">line_params_err</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">wavenumber</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># compute velocity</span>
            <span class="n">pos_wave</span> <span class="o">=</span> <span class="n">line_params</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">velocity</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">compute_radial_velocity</span><span class="p">(</span>
                <span class="n">pos_wave</span><span class="p">,</span> <span class="n">gvar</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">all_inputparams</span><span class="o">.</span><span class="n">pos_guess</span><span class="p">),</span>
                <span class="n">wavenumber</span><span class="o">=</span><span class="n">wavenumber</span><span class="p">)</span>

            <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;velocity_gvar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">velocity</span>
            <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;velocity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gvar</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">velocity</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;velocity_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gvar</span><span class="o">.</span><span class="n">sdev</span><span class="p">(</span><span class="n">velocity</span><span class="p">)</span>

            <span class="c1"># compute broadening</span>
            <span class="n">sigma_total_kms</span> <span class="o">=</span> <span class="n">line_params</span><span class="p">[:,</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">sigma_apod_kms</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">fit</span><span class="o">.</span><span class="n">sigma2vel</span><span class="p">(</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">apod2sigma</span><span class="p">(</span>
                    <span class="n">all_inputparams</span><span class="o">.</span><span class="n">apodization</span><span class="p">,</span> <span class="n">line_params</span><span class="p">[:,</span><span class="mi">3</span><span class="p">])</span> <span class="o">/</span> <span class="n">inputparams</span><span class="o">.</span><span class="n">axis_step</span><span class="p">,</span>
                <span class="n">pos_wave</span><span class="p">,</span> <span class="n">inputparams</span><span class="o">.</span><span class="n">axis_step</span><span class="p">)</span>

            <span class="n">broadening</span> <span class="o">=</span> <span class="p">(</span><span class="n">gvar</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">sigma_total_kms</span><span class="o">**</span><span class="mi">2</span>
                                    <span class="o">-</span> <span class="n">sigma_apod_kms</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span>
            
            <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;broadening_gvar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">broadening</span>
            <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;broadening&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gvar</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">broadening</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;broadening_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gvar</span><span class="o">.</span><span class="n">sdev</span><span class="p">(</span><span class="n">broadening</span><span class="p">)</span>

            <span class="c1"># compute fwhm in Angstroms to get flux</span>
            <span class="c1"># If calibrated, amplitude unit must be in erg/cm2/s/A, then</span>
            <span class="c1"># fwhm/width units must be in Angstrms</span>
            <span class="k">if</span> <span class="n">wavenumber</span><span class="p">:</span>
                <span class="n">fwhm</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">fwhm_cm12nm</span><span class="p">(</span>
                    <span class="n">line_params</span><span class="p">[:,</span><span class="mi">3</span><span class="p">],</span> <span class="n">line_params</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="mf">10.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fwhm</span> <span class="o">=</span> <span class="n">line_params</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="mf">10.</span>

            <span class="c1"># compute sigma in Angstroms to get flux</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">fwhm_cm12nm</span><span class="p">(</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">fit</span><span class="o">.</span><span class="n">vel2sigma</span><span class="p">(</span>
                    <span class="n">line_params</span><span class="p">[:,</span><span class="mi">4</span><span class="p">],</span> <span class="n">line_params</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span>
                    <span class="n">inputparams</span><span class="o">.</span><span class="n">axis_step</span><span class="p">)</span> <span class="o">*</span> <span class="n">inputparams</span><span class="o">.</span><span class="n">axis_step</span><span class="p">,</span>
                <span class="n">line_params</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="mf">10.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fwhm</span> <span class="o">=</span> <span class="n">line_params</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">line_params</span><span class="p">[:,</span><span class="mi">4</span><span class="p">]</span>


        <span class="c1">## compute flux</span>
        <span class="k">if</span> <span class="n">all_inputparams</span><span class="o">.</span><span class="n">fmodel</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;sincgauss&#39;</span><span class="p">,</span> <span class="s1">&#39;sincgaussphased&#39;</span><span class="p">]:</span>
            <span class="n">flux</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">sincgauss1d_flux</span><span class="p">(</span>
                <span class="n">line_params</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">fwhm</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">all_inputparams</span><span class="o">.</span><span class="n">fmodel</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
            <span class="n">flux</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">gaussian1d_flux</span><span class="p">(</span>
                <span class="n">line_params</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">fwhm</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">all_inputparams</span><span class="o">.</span><span class="n">fmodel</span> <span class="o">==</span> <span class="s1">&#39;sinc&#39;</span><span class="p">:</span>
            <span class="n">flux</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">sinc1d_flux</span><span class="p">(</span>
                <span class="n">line_params</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">fwhm</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">all_inputparams</span><span class="o">.</span><span class="n">fmodel</span> <span class="o">==</span> <span class="s1">&#39;sincphased&#39;</span><span class="p">:</span>
            <span class="n">flux</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">sinc1d_flux</span><span class="p">(</span>
                <span class="n">line_params</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">fwhm</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">flux</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">flux</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;flux_gvar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flux</span>
            <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gvar</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;flux_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gvar</span><span class="o">.</span><span class="n">sdev</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span>

        <span class="c1"># compute SNR</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;snr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gvar</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">line_params</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">gvar</span><span class="o">.</span><span class="n">sdev</span><span class="p">(</span><span class="n">line_params</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># store lines-params</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;lines_params_gvar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line_params</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;lines_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gvar</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">line_params</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;lines_params_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">gvar</span><span class="o">.</span><span class="n">sdev</span><span class="p">(</span><span class="n">line_params</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span></div></div>

        
        

<span class="c1">################################################</span>
<span class="c1">#### Functions #################################</span>
<span class="c1">################################################</span>


<span class="k">def</span> <span class="nf">_fit_lines_in_spectrum</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">fit_tol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span>
                           <span class="n">compute_mcmc_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">snr_guess</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;raw function for spectrum fitting. Need the InputParams</span>
<span class="sd">    class to be defined before call.</span>

<span class="sd">    :param spectrum: The spectrum to fit (1d vector).</span>

<span class="sd">    :param ip: InputParams instance (can be created with</span>
<span class="sd">      fit._prepare_input_params())</span>

<span class="sd">    :param fit_tol: (Optional) Tolerance on the fit value (default</span>
<span class="sd">      1e-10).</span>

<span class="sd">    :param compute_mcmc_error: (Optional) If True, uncertainty</span>
<span class="sd">      estimates are computed from a Markov chain Monte-Carlo</span>
<span class="sd">      algorithm. If the estimates can be better constrained, the</span>
<span class="sd">      fitting time is orders of magnitude longer (default False).</span>

<span class="sd">    :param snr_guess: (Optional) Guess on the SNR.</span>

<span class="sd">    :param kwargs: (Optional) Model parameters that must be changed in</span>
<span class="sd">      the InputParams instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">InputParams</span><span class="p">):</span>
        <span class="n">rawip</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">convert</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">iparams</span> <span class="ow">in</span> <span class="n">rawip</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">iparams</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">iparams</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="n">fv</span> <span class="o">=</span> <span class="n">FitVector</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span>
                   <span class="n">rawip</span><span class="o">.</span><span class="n">models</span><span class="p">,</span> <span class="n">rawip</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
                   <span class="n">signal_range</span><span class="o">=</span><span class="n">rawip</span><span class="o">.</span><span class="n">signal_range</span><span class="p">,</span>
                   <span class="n">fit_tol</span><span class="o">=</span><span class="n">fit_tol</span><span class="p">,</span>
                   <span class="n">snr_guess</span><span class="o">=</span><span class="n">snr_guess</span><span class="p">)</span>

    <span class="n">fit</span> <span class="o">=</span> <span class="n">fv</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">compute_mcmc_error</span><span class="o">=</span><span class="n">compute_mcmc_error</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">fit</span> <span class="o">!=</span> <span class="p">[]:</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="n">OutputParams</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fit</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">fv</span><span class="p">)</span>
    
    <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">_prepare_input_params</span><span class="p">(</span><span class="n">step_nb</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">nm_laser</span><span class="p">,</span>
                          <span class="n">axis_corr</span><span class="p">,</span> <span class="n">zpd_index</span><span class="p">,</span> <span class="n">wavenumber</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">filter_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">apodization</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> 
                          <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>    
    <span class="sd">&quot;&quot;&quot;Fit lines in spectrum</span>

<span class="sd">    .. warning:: If spectrum is in wavenumber (option wavenumber set</span>
<span class="sd">      to True) input and output unit will be in cm-1. If spectrum is</span>
<span class="sd">      in wavelength (option wavenumber set to False) input and output</span>
<span class="sd">      unit will be in nm.</span>

<span class="sd">    :param step_nb: Number of steps of the spectrum</span>
<span class="sd">    </span>
<span class="sd">    :param lines: Positions of the lines in nm/cm-1</span>

<span class="sd">    :param step: Step size in nm</span>

<span class="sd">    :param order: Folding order</span>

<span class="sd">    :param nm_laser: Calibration laser wavelength in nm.</span>

<span class="sd">    :param axis_corr: Calibration coefficient</span>

<span class="sd">    :param zpd_index: Index of the ZPD in the interferogram.</span>
<span class="sd">    </span>
<span class="sd">    :param apodization: (Optional) Apodization level. Permit to separate the</span>
<span class="sd">      broadening due to the apodization and the real line broadening</span>
<span class="sd">      (see &#39;broadening&#39; output parameter, default 1.).</span>

<span class="sd">    :param filter_file_path: (Optional) Filter file path (default</span>
<span class="sd">      None).</span>

<span class="sd">    :param kwargs: (Optional) Fitting parameters of</span>
<span class="sd">      :py:class:`orb.fit.Cm1LinesInput` or</span>
<span class="sd">      :py:class:`orb.fit.FitVector`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">wavenumber</span><span class="p">:</span>
        <span class="n">inputparams</span> <span class="o">=</span> <span class="n">Cm1InputParams</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;NmInputParams not implemented yet&#39;</span><span class="p">)</span>
            
    <span class="n">ip</span> <span class="o">=</span> <span class="n">inputparams</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">step_nb</span><span class="p">,</span>
                     <span class="n">nm_laser</span><span class="p">,</span> <span class="n">axis_corr</span><span class="p">,</span> <span class="n">apodization</span><span class="p">,</span>
                     <span class="n">zpd_index</span><span class="p">,</span> <span class="n">filter_file_path</span><span class="p">)</span>

    <span class="n">ip</span><span class="o">.</span><span class="n">add_lines_model</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">filter_file_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ip</span><span class="o">.</span><span class="n">add_filter_model</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="s1">&#39;signal_range&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;signal_range&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ip</span><span class="o">.</span><span class="n">set_signal_range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;signal_range&#39;</span><span class="p">]),</span>
                                <span class="nb">max</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;signal_range&#39;</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">ip</span>

<div class="viewcode-block" id="fit_lines_in_spectrum"><a class="viewcode-back" href="../../orb.html#orb.fit.fit_lines_in_spectrum">[docs]</a><span class="k">def</span> <span class="nf">fit_lines_in_spectrum</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">nm_laser</span><span class="p">,</span>
                          <span class="n">axis_corr</span><span class="p">,</span> <span class="n">zpd_index</span><span class="p">,</span> <span class="n">wavenumber</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">filter_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">apodization</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span>
                          <span class="n">fit_tol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span>
                          <span class="n">velocity_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">compute_mcmc_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">snr_guess</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Fit lines in spectrum</span>

<span class="sd">    .. warning:: If spectrum is in wavenumber (option wavenumber set</span>
<span class="sd">      to True) input and output unit will be in cm-1. If spectrum is</span>
<span class="sd">      in wavelength (option wavenumber set to False) input and output</span>
<span class="sd">      unit will be in nm.</span>

<span class="sd">    :param spectrum: Spectrum to fit</span>

<span class="sd">    :param lines: Positions of the lines in nm/cm-1</span>

<span class="sd">    :param step: Step size in nm</span>

<span class="sd">    :param order: Folding order</span>

<span class="sd">    :param nm_laser: Calibration laser wavelength in nm.</span>

<span class="sd">    :param axis_corr: Calibration coefficient</span>

<span class="sd">    :param zpd_index: Index of the ZPD in the interferogram.</span>
<span class="sd">    </span>
<span class="sd">    :param apodization: (Optional) Apodization level. Permit to separate the</span>
<span class="sd">      broadening due to the apodization and the real line broadening</span>
<span class="sd">      (see &#39;broadening&#39; output parameter, default 1.).</span>

<span class="sd">    :param fit_tol: (Optional) Tolerance on the fit value (default</span>
<span class="sd">      1e-10).</span>

<span class="sd">    :param filter_file_path: (Optional) Filter file path (default</span>
<span class="sd">      None).</span>

<span class="sd">    :param velocity_range: (Optional) Range of velocity to check</span>
<span class="sd">      around the shift_guess value. If not None, a brute force</span>
<span class="sd">      algorithm is used to find the best velocity value. If more than</span>
<span class="sd">      one shift_guess is given (e.g. if lines are have different</span>
<span class="sd">      velocities, the mean velocity will be used as an initial</span>
<span class="sd">      velocity guess). The quality of this guess depends strongly on</span>
<span class="sd">      the spectrum noise. Try avoid using it with low a SNR spectrum.</span>

<span class="sd">    :param compute_mcmc_error: (Optional) If True, uncertainty</span>
<span class="sd">      estimates are computed from a Markov chain Monte-Carlo</span>
<span class="sd">      algorithm. If the estimates can be better constrained, the</span>
<span class="sd">      fitting time is orders of magnitude longer (default False).</span>

<span class="sd">    :param snr_guess: (Optional) Guess on the SNR.</span>

<span class="sd">    :param kwargs: (Optional) Fitting parameters of</span>
<span class="sd">      :py:class:`orb.fit.Cm1LinesInput` or</span>
<span class="sd">      :py:class:`orb.fit.FitVector`.</span>

<span class="sd">    :return: a dictionary containing:</span>

<span class="sd">      * all the fit parameters [key: &#39;fit_params&#39;]</span>
<span class="sd">    </span>
<span class="sd">      * lines parameters [key: &#39;lines_params&#39;] Lines parameters are</span>
<span class="sd">        given as an array of shape (lines_nb, 4). The order of the 4</span>
<span class="sd">        parameters for each lines is [height at the center of the</span>
<span class="sd">        line, amplitude, position, fwhm]. Position and FWHM are given</span>
<span class="sd">        in nm/cm-1 depending on the input unit (i.e. nm if wavenumber</span>
<span class="sd">        is False and cm-1 if wavenumber is True)</span>
<span class="sd">      </span>
<span class="sd">      * lines parameters errors [key: &#39;lines_params_err&#39;]</span>

<span class="sd">      * velocity [key: &#39;velocity&#39;] Velocity of the lines in km/s</span>

<span class="sd">      * velocity error [key: &#39;velocity_err&#39;] Error on the velocity of</span>
<span class="sd">        the lines in km/s</span>

<span class="sd">      * residual [key: &#39;residual&#39;]</span>
<span class="sd">      </span>
<span class="sd">      * chi-square [key: &#39;chi_square&#39;]</span>

<span class="sd">      * reduced chi-square [key: &#39;reduced_chi_square&#39;]</span>

<span class="sd">      * SNR [key: &#39;snr&#39;]</span>

<span class="sd">      * continuum parameters [key: &#39;cont_params&#39;]</span>

<span class="sd">      * fitted spectrum [key: &#39;fitted_vector&#39;]</span>
<span class="sd">   </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">all_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">locals</span><span class="p">())</span> <span class="c1"># used in case fit is retried (must stay</span>
                              <span class="c1"># at the very beginning of the function</span>
                              <span class="c1"># ;)</span>

    <span class="k">if</span> <span class="n">velocity_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Velocity range not implemented yet&#39;</span><span class="p">)</span>

    <span class="c1"># brute force over the velocity range to find the best lines position</span>
    <span class="c1">## if velocity_range is not None:</span>
    <span class="c1">##     raise Exception(&#39;Must be reimplemented&#39;)</span>
    <span class="c1">##     # velocity step of one channel</span>
    <span class="c1">##     bf_step_kms = axis_step / lines[0] * constants.LIGHT_VEL_KMS</span>
    <span class="c1">##     bf_flux = list()</span>
    <span class="c1">##     mean_shift_guess = np.nanmean(shift_guess)</span>
    <span class="c1">##     bf_range = np.arange(mean_shift_guess - velocity_range,</span>
    <span class="c1">##                          mean_shift_guess + velocity_range,</span>
    <span class="c1">##                          bf_step_kms)</span>
    <span class="c1">##     if np.size(bf_range) &gt; 1:</span>
    <span class="c1">##         # get the total flux in the lines channels for each velocity</span>
    <span class="c1">##         for ivel in bf_range:</span>
    <span class="c1">##             ilines_wav = utils.spectrum.line_shift(</span>
    <span class="c1">##                 ivel, lines, wavenumber=wavenumber)</span>
    <span class="c1">##             ilines_pix = utils.spectrum.fast_w2pix(</span>
    <span class="c1">##                 np.array(lines + ilines_wav, dtype=float),</span>
    <span class="c1">##                 axis_min, axis_step)</span>
    <span class="c1">##             bf_flux.append(np.nansum(spectrum[np.array(</span>
    <span class="c1">##                 np.round(ilines_pix), dtype=int)]))</span>
    <span class="c1">##         shift_guess = bf_range[np.nanargmax(bf_flux)]</span>
                              

    <span class="n">ip</span> <span class="o">=</span> <span class="n">_prepare_input_params</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lines</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">nm_laser</span><span class="p">,</span>
                               <span class="n">axis_corr</span><span class="p">,</span> <span class="n">zpd_index</span><span class="p">,</span> <span class="n">wavenumber</span><span class="o">=</span><span class="n">wavenumber</span><span class="p">,</span>
                               <span class="n">filter_file_path</span><span class="o">=</span><span class="n">filter_file_path</span><span class="p">,</span>
                               <span class="n">apodization</span><span class="o">=</span><span class="n">apodization</span><span class="p">,</span>
                               <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    
    <span class="n">fit</span> <span class="o">=</span> <span class="n">_fit_lines_in_spectrum</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span>
                                 <span class="n">fit_tol</span><span class="o">=</span><span class="n">fit_tol</span><span class="p">,</span>
                                 <span class="n">compute_mcmc_error</span><span class="o">=</span><span class="n">compute_mcmc_error</span><span class="p">,</span>
                                 <span class="n">snr_guess</span><span class="o">=</span><span class="n">snr_guess</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">fit</span> <span class="o">!=</span> <span class="p">[]:</span>
        <span class="k">return</span> <span class="n">fit</span>
    
    <span class="k">elif</span> <span class="n">ip</span><span class="o">.</span><span class="n">allparams</span><span class="o">.</span><span class="n">fmodel</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;sincgauss&#39;</span><span class="p">,</span> <span class="s1">&#39;sincgaussphased&#39;</span><span class="p">]:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;bad fit, fmodel replaced by a normal sinc&#39;</span><span class="p">)</span>
        <span class="n">all_args</span><span class="p">[</span><span class="s1">&#39;fmodel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;sinc&#39;</span>
        <span class="k">return</span> <span class="n">fit_lines_in_spectrum</span><span class="p">(</span><span class="o">**</span><span class="n">all_args</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="p">[]</span></div>
    


<div class="viewcode-block" id="fit_lines_in_vector"><a class="viewcode-back" href="../../orb.html#orb.fit.fit_lines_in_vector">[docs]</a><span class="k">def</span> <span class="nf">fit_lines_in_vector</span><span class="p">(</span> <span class="n">vector</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">fwhm_guess</span><span class="p">,</span> <span class="n">fit_tol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span>
    <span class="n">compute_mcmc_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">snr_guess</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Fit lines in a vector</span>

<span class="sd">    Use this function only if little is known about the vector. A</span>
<span class="sd">    vector resulting from an interferogram FFT is assumed :</span>
<span class="sd">    i.e. regular axis, symmetrical line shape.</span>

<span class="sd">    .. warning:: All position units are in channels</span>

<span class="sd">    :param vector: vector to fit</span>

<span class="sd">    :param lines: Positions of the lines in channels</span>

<span class="sd">    :param fwhm_guess: Initial guess on the lines FWHM (in channels).</span>

<span class="sd">    :param fit_tol: (Optional) Tolerance on the fit value (default</span>
<span class="sd">      1e-10).</span>

<span class="sd">    :param compute_mcmc_error: (Optional) If True, uncertainty</span>
<span class="sd">      estimates are computed from a Markov chain Monte-Carlo</span>
<span class="sd">      algorithm. If the estimates can be better constrained, the</span>
<span class="sd">      fitting time is orders of magnitude longer (default False).</span>

<span class="sd">    :snr_guess: (Optional) Guess on the SNR.</span>

<span class="sd">    :param kwargs: (Optional) Fitting parameters of</span>
<span class="sd">      :py:class:`orb.fit.LinesInput` or</span>
<span class="sd">      :py:class:`orb.fit.FitVector`.</span>


<span class="sd">    :return: a dictionary containing:</span>

<span class="sd">      * all the fit parameters [key: &#39;fit_params&#39;]</span>
<span class="sd">    </span>
<span class="sd">      * lines parameters [key: &#39;lines_params&#39;] Lines parameters are</span>
<span class="sd">        given as an array of shape (lines_nb, 4). The order of the 4</span>
<span class="sd">        parameters for each lines is [height at the center of the</span>
<span class="sd">        line, amplitude, position, fwhm]. Postion and FWHM are given</span>
<span class="sd">        in channels.</span>
<span class="sd">      </span>
<span class="sd">      * lines parameters errors [key: &#39;lines_params_err&#39;]</span>

<span class="sd">      * residual [key: &#39;residual&#39;]</span>
<span class="sd">      </span>
<span class="sd">      * chi-square [key: &#39;chi_square&#39;]</span>

<span class="sd">      * reduced chi-square [key: &#39;reduced_chi_square&#39;]</span>

<span class="sd">      * SNR [key: &#39;snr&#39;]</span>

<span class="sd">      * continuum parameters [key: &#39;cont_params&#39;]</span>

<span class="sd">      * fitted spectrum [key: &#39;fitted_vector&#39;]</span>
<span class="sd">   </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ip</span> <span class="o">=</span> <span class="n">InputParams</span><span class="p">(</span><span class="n">vector</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    
    <span class="n">ip</span><span class="o">.</span><span class="n">add_lines_model</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">fwhm_guess</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;signal_range&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;signal_range&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;signal_range&#39;</span><span class="p">]</span>
            <span class="n">ip</span><span class="o">.</span><span class="n">set_signal_range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;signal_range&#39;</span><span class="p">]),</span>
                                <span class="nb">max</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;signal_range&#39;</span><span class="p">]))</span>
    
    <span class="n">fv</span> <span class="o">=</span> <span class="n">FitVector</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span>
                   <span class="n">ip</span><span class="o">.</span><span class="n">models</span><span class="p">,</span> <span class="n">ip</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
                   <span class="n">signal_range</span><span class="o">=</span><span class="n">ip</span><span class="o">.</span><span class="n">signal_range</span><span class="p">,</span>
                   <span class="n">fit_tol</span><span class="o">=</span><span class="n">fit_tol</span><span class="p">,</span>
                   <span class="n">snr_guess</span><span class="o">=</span><span class="n">snr_guess</span><span class="p">)</span>
    
    <span class="n">fit</span> <span class="o">=</span> <span class="n">fv</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">compute_mcmc_error</span><span class="o">=</span><span class="n">compute_mcmc_error</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">fit</span> <span class="o">!=</span> <span class="p">[]:</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="n">OutputParams</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fit</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">fv</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">[]</span></div>



<div class="viewcode-block" id="create_cm1_lines_model"><a class="viewcode-back" href="../../orb.html#orb.fit.create_cm1_lines_model">[docs]</a><span class="k">def</span> <span class="nf">create_cm1_lines_model</span><span class="p">(</span><span class="n">lines_cm1</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span>
                           <span class="n">theta</span><span class="p">,</span> <span class="n">vel</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                           <span class="n">fmodel</span><span class="o">=</span><span class="s1">&#39;sincgauss&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a simple emission-line spectrum model in cm-1</span>

<span class="sd">    :param lines: lines in cm-1</span>
<span class="sd">    </span>
<span class="sd">    :param amp: Amplitude (must have the same size as lines)</span>
<span class="sd">    </span>
<span class="sd">    :param step: Step size</span>

<span class="sd">    :param order: Folding order</span>

<span class="sd">    :param resolution: Resolution of the spectrum</span>

<span class="sd">    :param theta: Incident angle</span>

<span class="sd">    :param step_nb: Number of steps of the spectrum.</span>
<span class="sd">    </span>
<span class="sd">    :param vel: (Optional) Global velocity shift applied to all the</span>
<span class="sd">      lines (in km/s, default 0.)</span>
<span class="sd">    </span>
<span class="sd">    :param sigma: (Optional) Line broadening (in km/s, default 0.)</span>

<span class="sd">    :param alpha: (Optional) Phase coefficient of the lines (default</span>
<span class="sd">      0.)</span>

<span class="sd">    :param fmodel: (Optional) Lines model. Can be &#39;gaussian&#39;, &#39;sinc&#39;,</span>
<span class="sd">      &#39;sincgauss&#39;, &#39;sincphased&#39;, &#39;sincgaussphased&#39; (default sincgauss).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">amp</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">lines_cm1</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;The number of lines and the length of the amplitude vector must be the same&#39;</span><span class="p">)</span>

    <span class="n">nm_laser</span> <span class="o">=</span> <span class="mf">543.5</span> <span class="c1"># can be anything</span>
    <span class="n">nm_laser_obs</span> <span class="o">=</span> <span class="n">nm_laser</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span>
    
    <span class="n">step_nb</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">compute_step_nb</span><span class="p">(</span><span class="n">resolution</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
    <span class="n">fwhm_guess</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">compute_line_fwhm</span><span class="p">(</span>
        <span class="n">step_nb</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">nm_laser_obs</span> <span class="o">/</span> <span class="n">nm_laser</span><span class="p">,</span> <span class="n">wavenumber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">lines_model</span> <span class="o">=</span> <span class="n">Cm1LinesModel</span><span class="p">(</span>    
        <span class="p">{</span><span class="s1">&#39;step_nb&#39;</span><span class="p">:</span><span class="n">step_nb</span><span class="p">,</span>
         <span class="s1">&#39;step&#39;</span><span class="p">:</span><span class="n">step</span><span class="p">,</span>
         <span class="s1">&#39;order&#39;</span><span class="p">:</span><span class="n">order</span><span class="p">,</span>
         <span class="s1">&#39;nm_laser&#39;</span><span class="p">:</span><span class="n">nm_laser</span><span class="p">,</span>
         <span class="s1">&#39;nm_laser_obs&#39;</span><span class="p">:</span><span class="n">nm_laser_obs</span><span class="p">,</span>
         <span class="s1">&#39;line_nb&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">lines_cm1</span><span class="p">),</span>
         <span class="s1">&#39;amp_def&#39;</span><span class="p">:</span><span class="s1">&#39;free&#39;</span><span class="p">,</span>
         <span class="s1">&#39;fwhm_def&#39;</span><span class="p">:</span><span class="s1">&#39;1&#39;</span><span class="p">,</span>
         <span class="s1">&#39;pos_guess&#39;</span><span class="p">:</span><span class="n">lines_cm1</span><span class="p">,</span>
         <span class="s1">&#39;pos_cov&#39;</span><span class="p">:</span><span class="n">vel</span><span class="p">,</span>
         <span class="s1">&#39;pos_def&#39;</span><span class="p">:</span><span class="s1">&#39;1&#39;</span><span class="p">,</span>
         <span class="s1">&#39;fmodel&#39;</span><span class="p">:</span><span class="n">fmodel</span><span class="p">,</span>
         <span class="s1">&#39;fwhm_guess&#39;</span><span class="p">:</span><span class="n">fwhm_guess</span><span class="p">,</span>
         <span class="s1">&#39;sigma_def&#39;</span><span class="p">:</span><span class="s1">&#39;1&#39;</span><span class="p">,</span>
         <span class="s1">&#39;sigma_guess&#39;</span><span class="p">:</span><span class="n">sigma</span><span class="p">,</span>
         <span class="s1">&#39;sigma_cov&#39;</span><span class="p">:</span><span class="mf">0.</span><span class="p">,</span> <span class="c1"># never more than 0.</span>
         <span class="s1">&#39;alpha_def&#39;</span><span class="p">:</span><span class="s1">&#39;1&#39;</span><span class="p">,</span>
         <span class="s1">&#39;alpha_guess&#39;</span><span class="p">:</span><span class="n">alpha</span><span class="p">,</span>
         <span class="s1">&#39;alpha_cov&#39;</span><span class="p">:</span><span class="mf">0.</span><span class="p">})</span> <span class="c1"># never more than 0.})</span>

    <span class="n">p_free</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">lines_model</span><span class="o">.</span><span class="n">p_free</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">iline</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">lines_cm1</span><span class="p">)):</span>
        <span class="n">p_free</span><span class="p">[</span><span class="n">lines_model</span><span class="o">.</span><span class="n">_get_ikey</span><span class="p">(</span><span class="s1">&#39;amp&#39;</span><span class="p">,</span> <span class="n">iline</span><span class="p">)]</span> <span class="o">=</span> <span class="n">amp</span><span class="p">[</span><span class="n">iline</span><span class="p">]</span>
    <span class="n">lines_model</span><span class="o">.</span><span class="n">set_p_free</span><span class="p">(</span><span class="n">p_free</span><span class="p">)</span>
    <span class="n">spectrum</span> <span class="o">=</span> <span class="n">lines_model</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">step_nb</span><span class="p">))</span>
    
    <span class="c1">#model, models = lines_model.get_model(np.arange(step_nb), return_models=True)</span>
    <span class="k">return</span> <span class="n">gvar</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span></div>

<div class="viewcode-block" id="create_lines_model"><a class="viewcode-back" href="../../orb.html#orb.fit.create_lines_model">[docs]</a><span class="k">def</span> <span class="nf">create_lines_model</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">,</span> <span class="n">step_nb</span><span class="p">,</span> <span class="n">line_shift</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                       <span class="n">sigma</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">fmodel</span><span class="o">=</span><span class="s1">&#39;sincgauss&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a simple emission-line spectrum model with no physical units.</span>

<span class="sd">    :param lines: lines channels.</span>
<span class="sd">    </span>
<span class="sd">    :param amp: Amplitude (must have the same size as lines).</span>
<span class="sd">    </span>
<span class="sd">    :param fwhm: lines FWHM (in channels).</span>
<span class="sd">    </span>
<span class="sd">    :param step_nb: Number of steps of the spectrum.</span>
<span class="sd">    </span>
<span class="sd">    :param line_shift: (Optional) Global shift applied to all the</span>
<span class="sd">      lines (in channels, default 0.)</span>
<span class="sd">    </span>
<span class="sd">    :param sigma: (Optional) Sigma of the lines (in channels, default</span>
<span class="sd">      0.)</span>

<span class="sd">    :param alpha: (Optional) Phase coefficient of the lines (default</span>
<span class="sd">      0.)</span>

<span class="sd">    :param fmodel: (Optional) Lines model. Can be &#39;gaussian&#39;, &#39;sinc&#39;,</span>
<span class="sd">      &#39;sincgauss&#39;, &#39;sincphased&#39;, &#39;sincgaussphased&#39; (default sincgauss).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">amp</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;The number of lines and the length of the amplitude vector must be the same&#39;</span><span class="p">)</span>

    <span class="n">lines_model</span> <span class="o">=</span> <span class="n">LinesModel</span><span class="p">(</span>    
        <span class="p">{</span><span class="s1">&#39;line_nb&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span>
         <span class="s1">&#39;amp_def&#39;</span><span class="p">:</span><span class="s1">&#39;free&#39;</span><span class="p">,</span>
         <span class="s1">&#39;fwhm_def&#39;</span><span class="p">:</span><span class="s1">&#39;1&#39;</span><span class="p">,</span>
         <span class="s1">&#39;pos_guess&#39;</span><span class="p">:</span><span class="n">lines</span><span class="p">,</span>
         <span class="s1">&#39;pos_cov&#39;</span><span class="p">:</span><span class="n">line_shift</span><span class="p">,</span>
         <span class="s1">&#39;pos_def&#39;</span><span class="p">:</span><span class="s1">&#39;1&#39;</span><span class="p">,</span>
         <span class="s1">&#39;fmodel&#39;</span><span class="p">:</span><span class="n">fmodel</span><span class="p">,</span>
         <span class="s1">&#39;fwhm_guess&#39;</span><span class="p">:</span><span class="n">fwhm</span><span class="p">,</span>
         <span class="s1">&#39;sigma_def&#39;</span><span class="p">:</span><span class="s1">&#39;1&#39;</span><span class="p">,</span>
         <span class="s1">&#39;sigma_guess&#39;</span><span class="p">:</span><span class="n">sigma</span><span class="p">,</span>
         <span class="s1">&#39;sigma_cov&#39;</span><span class="p">:</span><span class="mf">0.</span><span class="p">,</span> <span class="c1"># never more than 0.</span>
         <span class="s1">&#39;alpha_def&#39;</span><span class="p">:</span><span class="s1">&#39;1&#39;</span><span class="p">,</span>
         <span class="s1">&#39;alpha_guess&#39;</span><span class="p">:</span><span class="n">alpha</span><span class="p">,</span>
         <span class="s1">&#39;alpha_cov&#39;</span><span class="p">:</span><span class="mf">0.</span><span class="p">})</span> <span class="c1"># never more than 0.</span>
    <span class="n">p_free</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">lines_model</span><span class="o">.</span><span class="n">p_free</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">iline</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">lines</span><span class="p">)):</span>
        <span class="n">p_free</span><span class="p">[</span><span class="n">lines_model</span><span class="o">.</span><span class="n">_get_ikey</span><span class="p">(</span><span class="s1">&#39;amp&#39;</span><span class="p">,</span> <span class="n">iline</span><span class="p">)]</span> <span class="o">=</span> <span class="n">amp</span><span class="p">[</span><span class="n">iline</span><span class="p">]</span>
    <span class="n">lines_model</span><span class="o">.</span><span class="n">set_p_free</span><span class="p">(</span><span class="n">p_free</span><span class="p">)</span>
    <span class="n">spectrum</span> <span class="o">=</span> <span class="n">lines_model</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">step_nb</span><span class="p">))</span>
    <span class="c1">#model, models = lines_model.get_model(np.arange(step_nb), return_models=True)</span>
    <span class="k">return</span> <span class="n">gvar</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span></div>




<div class="viewcode-block" id="check_fit_cm1"><a class="viewcode-back" href="../../orb.html#orb.fit.check_fit_cm1">[docs]</a><span class="k">def</span> <span class="nf">check_fit_cm1</span><span class="p">(</span><span class="n">lines_cm1</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span>
                  <span class="n">snr</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vel</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">fmodel</span><span class="o">=</span><span class="s1">&#39;sincgauss&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a model and fit it.</span>

<span class="sd">    This is a good way to check the quality and the internal coherency</span>
<span class="sd">    of the fitting routine.</span>

<span class="sd">    :param lines_cm1: Lines rest wavenumber in cm-1</span>

<span class="sd">    :param amp: Amplitude of the lines</span>

<span class="sd">    :param step: Step size in nm</span>

<span class="sd">    :param oder: Folding order</span>

<span class="sd">    :param resolution: Resolution</span>

<span class="sd">    :param theta: Incident angle</span>

<span class="sd">    :param snr: SNR of the strongest line</span>

<span class="sd">    :param sigma: (Optional) Line broadening in km/s (default 0.)</span>

<span class="sd">    :param vel: (Optional) Velocity in km/s (default 0.)</span>

<span class="sd">    :param alpha: (Optional) Phase coefficient of the lines (default</span>
<span class="sd">      0.)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">SIGMA_SDEV</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># channels</span>
    <span class="n">FWHM_SDEV</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># channels</span>
    <span class="n">SHIFT_SDEV</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># channels</span>

    <span class="n">spectrum</span> <span class="o">=</span> <span class="n">create_cm1_lines_model</span><span class="p">(</span><span class="n">lines_cm1</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span>
                                      <span class="n">order</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span>
                                      <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">vel</span><span class="o">=</span><span class="n">vel</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
                                      <span class="n">fmodel</span><span class="o">=</span><span class="n">fmodel</span><span class="p">)</span>

    <span class="c1">## import pylab as pl</span>
    <span class="c1">## pl.plot(gvar.mean(spectrum))</span>
    <span class="c1">## pl.show()</span>
    <span class="c1">## quit()</span>
    
    <span class="c1"># add noise</span>
    <span class="k">if</span> <span class="n">snr</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="n">spectrum</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">standard_normal</span><span class="p">(</span>
            <span class="n">spectrum</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">amp</span><span class="p">)</span><span class="o">/</span><span class="n">snr</span>

    <span class="n">cos_theta</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span>
    <span class="n">step_nb</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">corr</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">cos_theta</span>
    <span class="n">fwhm_guess</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">compute_line_fwhm</span><span class="p">(</span>
        <span class="n">step_nb</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">corr</span><span class="p">,</span> <span class="n">wavenumber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 

    <span class="n">cm1_axis</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">create_cm1_axis</span><span class="p">(</span><span class="n">step_nb</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">corr</span><span class="o">=</span><span class="n">corr</span><span class="p">)</span>
    <span class="n">cm1_axis_step</span> <span class="o">=</span> <span class="n">cm1_axis</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cm1_axis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">fwhm_sdev_cm1</span> <span class="o">=</span> <span class="n">cm1_axis_step</span> <span class="o">*</span> <span class="n">FWHM_SDEV</span>
    <span class="n">sigma_sdev_kms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">fit</span><span class="o">.</span><span class="n">sigma2vel</span><span class="p">(</span>
        <span class="n">SIGMA_SDEV</span><span class="p">,</span> <span class="n">lines_cm1</span><span class="p">,</span> <span class="n">cm1_axis_step</span><span class="p">))</span>
    <span class="n">lines_cm1_sdev</span> <span class="o">=</span> <span class="n">SHIFT_SDEV</span> <span class="o">*</span> <span class="n">cm1_axis_step</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">gvar</span><span class="o">.</span><span class="n">sdev</span><span class="p">(</span><span class="n">fwhm_guess</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">):</span>
        <span class="n">fwhm_guess</span> <span class="o">=</span> <span class="n">gvar</span><span class="o">.</span><span class="n">gvar</span><span class="p">(</span><span class="n">fwhm_guess</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">fwhm_guess</span><span class="p">)</span> <span class="o">*</span> <span class="n">fwhm_sdev_cm1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">gvar</span><span class="o">.</span><span class="n">sdev</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">gvar</span><span class="o">.</span><span class="n">gvar</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma_sdev_kms</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">gvar</span><span class="o">.</span><span class="n">sdev</span><span class="p">(</span><span class="n">lines_cm1</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">):</span>
        <span class="n">lines_cm1</span> <span class="o">=</span> <span class="n">gvar</span><span class="o">.</span><span class="n">gvar</span><span class="p">(</span><span class="n">lines_cm1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">lines_cm1</span><span class="p">)</span> <span class="o">*</span> <span class="n">lines_cm1_sdev</span><span class="p">)</span>

    <span class="n">fit</span> <span class="o">=</span> <span class="n">fit_lines_in_spectrum</span><span class="p">(</span>
        <span class="n">spectrum</span><span class="p">,</span> <span class="n">lines_cm1</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="mf">543.5</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="n">cos_theta</span><span class="p">,</span>
        <span class="mi">0</span><span class="p">,</span> <span class="n">wavenumber</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
        <span class="n">fmodel</span><span class="o">=</span><span class="n">fmodel</span><span class="p">,</span> <span class="n">pos_cov</span><span class="o">=</span><span class="n">vel</span><span class="p">,</span> <span class="n">pos_def</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">,</span>
        <span class="n">fwhm_guess</span><span class="o">=</span><span class="n">fwhm_guess</span><span class="p">,</span> <span class="n">fwhm_def</span><span class="o">=</span><span class="s1">&#39;fixed&#39;</span><span class="p">,</span>
        <span class="n">sigma_def</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="n">sigma_cov</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span>
        <span class="n">alpha_def</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="n">alpha_cov</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">snr_guess</span><span class="o">=</span><span class="n">snr</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fit</span><span class="p">,</span> <span class="n">gvar</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span></div>


<div class="viewcode-block" id="check_fit"><a class="viewcode-back" href="../../orb.html#orb.fit.check_fit">[docs]</a><span class="k">def</span> <span class="nf">check_fit</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">,</span> <span class="n">step_nb</span><span class="p">,</span> <span class="n">snr</span><span class="p">,</span>
              <span class="n">line_shift</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fmodel</span><span class="o">=</span><span class="s1">&#39;sincgauss&#39;</span><span class="p">,</span>
              <span class="n">compute_mcmc_error</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a model and fit it.</span>

<span class="sd">    This is a good way to check the quality and the internal coherency</span>
<span class="sd">    of the fitting routine.</span>

<span class="sd">    :param lines: lines channels</span>
<span class="sd">    </span>
<span class="sd">    :param amp: Amplitude (must have the same size as lines)</span>
<span class="sd">    </span>
<span class="sd">    :param fwhm: lines FWHM (in channels)</span>
<span class="sd">    </span>
<span class="sd">    :param step_nb: Number of steps of the spectrum.</span>

<span class="sd">    :param snr: SNR of the strongest line</span>
<span class="sd">    </span>
<span class="sd">    :param line_shift: (Optional) Global shift applied to all the</span>
<span class="sd">      lines (in channels, default 0.)</span>
<span class="sd">    </span>
<span class="sd">    :param sigma: (Optional) Sigma of the lines (in channels, default</span>
<span class="sd">      0.)</span>

<span class="sd">    :param alpha: (Optional) Phase coefficient of the lines (default</span>
<span class="sd">      0.)</span>

<span class="sd">    :param fmodel: (Optional) Lines model. Can be &#39;gaussian&#39;, &#39;sinc&#39;,</span>
<span class="sd">      &#39;sincgauss&#39;, &#39;sincphased&#39;, &#39;sincgaussphased&#39; (default sincgauss).</span>

<span class="sd">    :param compute_mcmc_error: (Optional) If True error is estimated</span>
<span class="sd">      with the distribution obtained via a Monte-Carlo Markov Chain</span>
<span class="sd">      algorithm (default False).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">SIGMA_SDEV</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">FWHM_SDEV</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">SHIFT_SDEV</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">spectrum</span> <span class="o">=</span> <span class="n">create_lines_model</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">,</span> <span class="n">step_nb</span><span class="p">,</span>
                                  <span class="n">line_shift</span><span class="o">=</span><span class="n">line_shift</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span>
                                  <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">fmodel</span><span class="o">=</span><span class="n">fmodel</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">gvar</span><span class="o">.</span><span class="n">sdev</span><span class="p">(</span><span class="n">fwhm</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">):</span>
        <span class="n">fwhm</span> <span class="o">=</span> <span class="n">gvar</span><span class="o">.</span><span class="n">gvar</span><span class="p">(</span><span class="n">fwhm</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">fwhm</span><span class="p">)</span> <span class="o">*</span> <span class="n">FWHM_SDEV</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">gvar</span><span class="o">.</span><span class="n">sdev</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">gvar</span><span class="o">.</span><span class="n">gvar</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="n">SIGMA_SDEV</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">gvar</span><span class="o">.</span><span class="n">sdev</span><span class="p">(</span><span class="n">line_shift</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="n">line_shift</span> <span class="o">=</span> <span class="n">gvar</span><span class="o">.</span><span class="n">gvar</span><span class="p">(</span><span class="n">line_shift</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">line_shift</span><span class="p">)</span> <span class="o">*</span> <span class="n">SHIFT_SDEV</span><span class="p">)</span>
    
    <span class="c1"># add noise</span>
    <span class="k">if</span> <span class="n">snr</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="n">spectrum</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">standard_normal</span><span class="p">(</span>
            <span class="n">spectrum</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">amp</span><span class="p">)</span> <span class="o">/</span> <span class="n">snr</span>

    <span class="n">fit</span> <span class="o">=</span> <span class="n">fit_lines_in_vector</span><span class="p">(</span>
        <span class="n">spectrum</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">,</span>
        <span class="n">fmodel</span><span class="o">=</span><span class="n">fmodel</span><span class="p">,</span>
        <span class="n">pos_def</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">,</span>
        <span class="n">pos_cov</span><span class="o">=</span><span class="n">line_shift</span><span class="p">,</span>
        <span class="n">sigma_guess</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span>
        <span class="n">compute_mcmc_error</span><span class="o">=</span><span class="n">compute_mcmc_error</span><span class="p">,</span>
        <span class="n">alpha_guess</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">snr_guess</span><span class="o">=</span><span class="n">snr</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fit</span><span class="p">,</span> <span class="n">gvar</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Thomas Martin (thomas.martin.1@ulaval.ca).
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.8</a>
      
    </div>

    

    
  </body>
</html>