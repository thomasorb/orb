/* Generated by Cython 0.24.1 */

#define PY_SSIZE_T_CLEAN
#include "Python.h"
#ifndef Py_PYTHON_H
    #error Python headers needed to compile C extensions, please install development version of Python.
#elif PY_VERSION_HEX < 0x02060000 || (0x03000000 <= PY_VERSION_HEX && PY_VERSION_HEX < 0x03020000)
    #error Cython requires Python 2.6+ or Python 3.2+.
#else
#define CYTHON_ABI "0_24_1"
#include <stddef.h>
#ifndef offsetof
  #define offsetof(type, member) ( (size_t) & ((type*)0) -> member )
#endif
#if !defined(WIN32) && !defined(MS_WINDOWS)
  #ifndef __stdcall
    #define __stdcall
  #endif
  #ifndef __cdecl
    #define __cdecl
  #endif
  #ifndef __fastcall
    #define __fastcall
  #endif
#endif
#ifndef DL_IMPORT
  #define DL_IMPORT(t) t
#endif
#ifndef DL_EXPORT
  #define DL_EXPORT(t) t
#endif
#ifndef PY_LONG_LONG
  #define PY_LONG_LONG LONG_LONG
#endif
#ifndef Py_HUGE_VAL
  #define Py_HUGE_VAL HUGE_VAL
#endif
#ifdef PYPY_VERSION
  #define CYTHON_COMPILING_IN_PYPY 1
  #define CYTHON_COMPILING_IN_CPYTHON 0
#else
  #define CYTHON_COMPILING_IN_PYPY 0
  #define CYTHON_COMPILING_IN_CPYTHON 1
#endif
#if !defined(CYTHON_USE_PYLONG_INTERNALS) && CYTHON_COMPILING_IN_CPYTHON && PY_VERSION_HEX >= 0x02070000
  #define CYTHON_USE_PYLONG_INTERNALS 1
#endif
#if CYTHON_USE_PYLONG_INTERNALS
  #include "longintrepr.h"
  #undef SHIFT
  #undef BASE
  #undef MASK
#endif
#if CYTHON_COMPILING_IN_PYPY && PY_VERSION_HEX < 0x02070600 && !defined(Py_OptimizeFlag)
  #define Py_OptimizeFlag 0
#endif
#define __PYX_BUILD_PY_SSIZE_T "n"
#define CYTHON_FORMAT_SSIZE_T "z"
#if PY_MAJOR_VERSION < 3
  #define __Pyx_BUILTIN_MODULE_NAME "__builtin__"
  #define __Pyx_PyCode_New(a, k, l, s, f, code, c, n, v, fv, cell, fn, name, fline, lnos)\
          PyCode_New(a+k, l, s, f, code, c, n, v, fv, cell, fn, name, fline, lnos)
  #define __Pyx_DefaultClassType PyClass_Type
#else
  #define __Pyx_BUILTIN_MODULE_NAME "builtins"
  #define __Pyx_PyCode_New(a, k, l, s, f, code, c, n, v, fv, cell, fn, name, fline, lnos)\
          PyCode_New(a, k, l, s, f, code, c, n, v, fv, cell, fn, name, fline, lnos)
  #define __Pyx_DefaultClassType PyType_Type
#endif
#ifndef Py_TPFLAGS_CHECKTYPES
  #define Py_TPFLAGS_CHECKTYPES 0
#endif
#ifndef Py_TPFLAGS_HAVE_INDEX
  #define Py_TPFLAGS_HAVE_INDEX 0
#endif
#ifndef Py_TPFLAGS_HAVE_NEWBUFFER
  #define Py_TPFLAGS_HAVE_NEWBUFFER 0
#endif
#ifndef Py_TPFLAGS_HAVE_FINALIZE
  #define Py_TPFLAGS_HAVE_FINALIZE 0
#endif
#if PY_VERSION_HEX > 0x03030000 && defined(PyUnicode_KIND)
  #define CYTHON_PEP393_ENABLED 1
  #define __Pyx_PyUnicode_READY(op)       (likely(PyUnicode_IS_READY(op)) ?\
                                              0 : _PyUnicode_Ready((PyObject *)(op)))
  #define __Pyx_PyUnicode_GET_LENGTH(u)   PyUnicode_GET_LENGTH(u)
  #define __Pyx_PyUnicode_READ_CHAR(u, i) PyUnicode_READ_CHAR(u, i)
  #define __Pyx_PyUnicode_KIND(u)         PyUnicode_KIND(u)
  #define __Pyx_PyUnicode_DATA(u)         PyUnicode_DATA(u)
  #define __Pyx_PyUnicode_READ(k, d, i)   PyUnicode_READ(k, d, i)
  #define __Pyx_PyUnicode_IS_TRUE(u)      (0 != (likely(PyUnicode_IS_READY(u)) ? PyUnicode_GET_LENGTH(u) : PyUnicode_GET_SIZE(u)))
#else
  #define CYTHON_PEP393_ENABLED 0
  #define __Pyx_PyUnicode_READY(op)       (0)
  #define __Pyx_PyUnicode_GET_LENGTH(u)   PyUnicode_GET_SIZE(u)
  #define __Pyx_PyUnicode_READ_CHAR(u, i) ((Py_UCS4)(PyUnicode_AS_UNICODE(u)[i]))
  #define __Pyx_PyUnicode_KIND(u)         (sizeof(Py_UNICODE))
  #define __Pyx_PyUnicode_DATA(u)         ((void*)PyUnicode_AS_UNICODE(u))
  #define __Pyx_PyUnicode_READ(k, d, i)   ((void)(k), (Py_UCS4)(((Py_UNICODE*)d)[i]))
  #define __Pyx_PyUnicode_IS_TRUE(u)      (0 != PyUnicode_GET_SIZE(u))
#endif
#if CYTHON_COMPILING_IN_PYPY
  #define __Pyx_PyUnicode_Concat(a, b)      PyNumber_Add(a, b)
  #define __Pyx_PyUnicode_ConcatSafe(a, b)  PyNumber_Add(a, b)
#else
  #define __Pyx_PyUnicode_Concat(a, b)      PyUnicode_Concat(a, b)
  #define __Pyx_PyUnicode_ConcatSafe(a, b)  ((unlikely((a) == Py_None) || unlikely((b) == Py_None)) ?\
      PyNumber_Add(a, b) : __Pyx_PyUnicode_Concat(a, b))
#endif
#if CYTHON_COMPILING_IN_PYPY && !defined(PyUnicode_Contains)
  #define PyUnicode_Contains(u, s)  PySequence_Contains(u, s)
#endif
#if CYTHON_COMPILING_IN_PYPY && !defined(PyByteArray_Check)
  #define PyByteArray_Check(obj)  PyObject_TypeCheck(obj, &PyByteArray_Type)
#endif
#if CYTHON_COMPILING_IN_PYPY && !defined(PyObject_Format)
  #define PyObject_Format(obj, fmt)  PyObject_CallMethod(obj, "__format__", "O", fmt)
#endif
#if CYTHON_COMPILING_IN_PYPY && !defined(PyObject_Malloc)
  #define PyObject_Malloc(s)   PyMem_Malloc(s)
  #define PyObject_Free(p)     PyMem_Free(p)
  #define PyObject_Realloc(p)  PyMem_Realloc(p)
#endif
#define __Pyx_PyString_FormatSafe(a, b)   ((unlikely((a) == Py_None)) ? PyNumber_Remainder(a, b) : __Pyx_PyString_Format(a, b))
#define __Pyx_PyUnicode_FormatSafe(a, b)  ((unlikely((a) == Py_None)) ? PyNumber_Remainder(a, b) : PyUnicode_Format(a, b))
#if PY_MAJOR_VERSION >= 3
  #define __Pyx_PyString_Format(a, b)  PyUnicode_Format(a, b)
#else
  #define __Pyx_PyString_Format(a, b)  PyString_Format(a, b)
#endif
#if PY_MAJOR_VERSION < 3 && !defined(PyObject_ASCII)
  #define PyObject_ASCII(o)            PyObject_Repr(o)
#endif
#if PY_MAJOR_VERSION >= 3
  #define PyBaseString_Type            PyUnicode_Type
  #define PyStringObject               PyUnicodeObject
  #define PyString_Type                PyUnicode_Type
  #define PyString_Check               PyUnicode_Check
  #define PyString_CheckExact          PyUnicode_CheckExact
#endif
#if PY_MAJOR_VERSION >= 3
  #define __Pyx_PyBaseString_Check(obj) PyUnicode_Check(obj)
  #define __Pyx_PyBaseString_CheckExact(obj) PyUnicode_CheckExact(obj)
#else
  #define __Pyx_PyBaseString_Check(obj) (PyString_Check(obj) || PyUnicode_Check(obj))
  #define __Pyx_PyBaseString_CheckExact(obj) (PyString_CheckExact(obj) || PyUnicode_CheckExact(obj))
#endif
#ifndef PySet_CheckExact
  #define PySet_CheckExact(obj)        (Py_TYPE(obj) == &PySet_Type)
#endif
#define __Pyx_TypeCheck(obj, type) PyObject_TypeCheck(obj, (PyTypeObject *)type)
#if PY_MAJOR_VERSION >= 3
  #define PyIntObject                  PyLongObject
  #define PyInt_Type                   PyLong_Type
  #define PyInt_Check(op)              PyLong_Check(op)
  #define PyInt_CheckExact(op)         PyLong_CheckExact(op)
  #define PyInt_FromString             PyLong_FromString
  #define PyInt_FromUnicode            PyLong_FromUnicode
  #define PyInt_FromLong               PyLong_FromLong
  #define PyInt_FromSize_t             PyLong_FromSize_t
  #define PyInt_FromSsize_t            PyLong_FromSsize_t
  #define PyInt_AsLong                 PyLong_AsLong
  #define PyInt_AS_LONG                PyLong_AS_LONG
  #define PyInt_AsSsize_t              PyLong_AsSsize_t
  #define PyInt_AsUnsignedLongMask     PyLong_AsUnsignedLongMask
  #define PyInt_AsUnsignedLongLongMask PyLong_AsUnsignedLongLongMask
  #define PyNumber_Int                 PyNumber_Long
#endif
#if PY_MAJOR_VERSION >= 3
  #define PyBoolObject                 PyLongObject
#endif
#if PY_MAJOR_VERSION >= 3 && CYTHON_COMPILING_IN_PYPY
  #ifndef PyUnicode_InternFromString
    #define PyUnicode_InternFromString(s) PyUnicode_FromString(s)
  #endif
#endif
#if PY_VERSION_HEX < 0x030200A4
  typedef long Py_hash_t;
  #define __Pyx_PyInt_FromHash_t PyInt_FromLong
  #define __Pyx_PyInt_AsHash_t   PyInt_AsLong
#else
  #define __Pyx_PyInt_FromHash_t PyInt_FromSsize_t
  #define __Pyx_PyInt_AsHash_t   PyInt_AsSsize_t
#endif
#if PY_MAJOR_VERSION >= 3
  #define __Pyx_PyMethod_New(func, self, klass) ((self) ? PyMethod_New(func, self) : PyInstanceMethod_New(func))
#else
  #define __Pyx_PyMethod_New(func, self, klass) PyMethod_New(func, self, klass)
#endif
#if PY_VERSION_HEX >= 0x030500B1
#define __Pyx_PyAsyncMethodsStruct PyAsyncMethods
#define __Pyx_PyType_AsAsync(obj) (Py_TYPE(obj)->tp_as_async)
#elif CYTHON_COMPILING_IN_CPYTHON && PY_MAJOR_VERSION >= 3
typedef struct {
    unaryfunc am_await;
    unaryfunc am_aiter;
    unaryfunc am_anext;
} __Pyx_PyAsyncMethodsStruct;
#define __Pyx_PyType_AsAsync(obj) ((__Pyx_PyAsyncMethodsStruct*) (Py_TYPE(obj)->tp_reserved))
#else
#define __Pyx_PyType_AsAsync(obj) NULL
#endif
#ifndef CYTHON_RESTRICT
  #if defined(__GNUC__)
    #define CYTHON_RESTRICT __restrict__
  #elif defined(_MSC_VER) && _MSC_VER >= 1400
    #define CYTHON_RESTRICT __restrict
  #elif defined (__STDC_VERSION__) && __STDC_VERSION__ >= 199901L
    #define CYTHON_RESTRICT restrict
  #else
    #define CYTHON_RESTRICT
  #endif
#endif
#define __Pyx_void_to_None(void_result) ((void)(void_result), Py_INCREF(Py_None), Py_None)

#ifndef CYTHON_INLINE
  #if defined(__GNUC__)
    #define CYTHON_INLINE __inline__
  #elif defined(_MSC_VER)
    #define CYTHON_INLINE __inline
  #elif defined (__STDC_VERSION__) && __STDC_VERSION__ >= 199901L
    #define CYTHON_INLINE inline
  #else
    #define CYTHON_INLINE
  #endif
#endif

#if defined(WIN32) || defined(MS_WINDOWS)
  #define _USE_MATH_DEFINES
#endif
#include <math.h>
#ifdef NAN
#define __PYX_NAN() ((float) NAN)
#else
static CYTHON_INLINE float __PYX_NAN() {
  float value;
  memset(&value, 0xFF, sizeof(value));
  return value;
}
#endif
#if defined(__CYGWIN__) && defined(_LDBL_EQ_DBL)
#define __Pyx_truncl trunc
#else
#define __Pyx_truncl truncl
#endif


#define __PYX_ERR(f_index, lineno, Ln_error) \
{ \
  __pyx_filename = __pyx_f[f_index]; __pyx_lineno = lineno; __pyx_clineno = __LINE__; goto Ln_error; \
}

#if PY_MAJOR_VERSION >= 3
  #define __Pyx_PyNumber_Divide(x,y)         PyNumber_TrueDivide(x,y)
  #define __Pyx_PyNumber_InPlaceDivide(x,y)  PyNumber_InPlaceTrueDivide(x,y)
#else
  #define __Pyx_PyNumber_Divide(x,y)         PyNumber_Divide(x,y)
  #define __Pyx_PyNumber_InPlaceDivide(x,y)  PyNumber_InPlaceDivide(x,y)
#endif

#ifndef __PYX_EXTERN_C
  #ifdef __cplusplus
    #define __PYX_EXTERN_C extern "C"
  #else
    #define __PYX_EXTERN_C extern
  #endif
#endif

#define __PYX_HAVE__orb__cutils
#define __PYX_HAVE_API__orb__cutils
#include "string.h"
#include "stdio.h"
#include "stdlib.h"
#include "numpy/arrayobject.h"
#include "numpy/ufuncobject.h"
#include "math.h"
#include "pythread.h"
#ifdef _OPENMP
#include <omp.h>
#endif /* _OPENMP */

#ifdef PYREX_WITHOUT_ASSERTIONS
#define CYTHON_WITHOUT_ASSERTIONS
#endif

#ifndef CYTHON_UNUSED
# if defined(__GNUC__)
#   if !(defined(__cplusplus)) || (__GNUC__ > 3 || (__GNUC__ == 3 && __GNUC_MINOR__ >= 4))
#     define CYTHON_UNUSED __attribute__ ((__unused__))
#   else
#     define CYTHON_UNUSED
#   endif
# elif defined(__ICC) || (defined(__INTEL_COMPILER) && !defined(_MSC_VER))
#   define CYTHON_UNUSED __attribute__ ((__unused__))
# else
#   define CYTHON_UNUSED
# endif
#endif
#ifndef CYTHON_NCP_UNUSED
# if CYTHON_COMPILING_IN_CPYTHON
#  define CYTHON_NCP_UNUSED
# else
#  define CYTHON_NCP_UNUSED CYTHON_UNUSED
# endif
#endif
typedef struct {PyObject **p; const char *s; const Py_ssize_t n; const char* encoding;
                const char is_unicode; const char is_str; const char intern; } __Pyx_StringTabEntry;

#define __PYX_DEFAULT_STRING_ENCODING_IS_ASCII 0
#define __PYX_DEFAULT_STRING_ENCODING_IS_DEFAULT 0
#define __PYX_DEFAULT_STRING_ENCODING ""
#define __Pyx_PyObject_FromString __Pyx_PyBytes_FromString
#define __Pyx_PyObject_FromStringAndSize __Pyx_PyBytes_FromStringAndSize
#define __Pyx_uchar_cast(c) ((unsigned char)c)
#define __Pyx_long_cast(x) ((long)x)
#define __Pyx_fits_Py_ssize_t(v, type, is_signed)  (\
    (sizeof(type) < sizeof(Py_ssize_t))  ||\
    (sizeof(type) > sizeof(Py_ssize_t) &&\
          likely(v < (type)PY_SSIZE_T_MAX ||\
                 v == (type)PY_SSIZE_T_MAX)  &&\
          (!is_signed || likely(v > (type)PY_SSIZE_T_MIN ||\
                                v == (type)PY_SSIZE_T_MIN)))  ||\
    (sizeof(type) == sizeof(Py_ssize_t) &&\
          (is_signed || likely(v < (type)PY_SSIZE_T_MAX ||\
                               v == (type)PY_SSIZE_T_MAX)))  )
#if defined (__cplusplus) && __cplusplus >= 201103L
    #include <cstdlib>
    #define __Pyx_sst_abs(value) std::abs(value)
#elif SIZEOF_INT >= SIZEOF_SIZE_T
    #define __Pyx_sst_abs(value) abs(value)
#elif SIZEOF_LONG >= SIZEOF_SIZE_T
    #define __Pyx_sst_abs(value) labs(value)
#elif defined (_MSC_VER) && defined (_M_X64)
    #define __Pyx_sst_abs(value) _abs64(value)
#elif defined (__STDC_VERSION__) && __STDC_VERSION__ >= 199901L
    #define __Pyx_sst_abs(value) llabs(value)
#elif defined (__GNUC__)
    #define __Pyx_sst_abs(value) __builtin_llabs(value)
#else
    #define __Pyx_sst_abs(value) ((value<0) ? -value : value)
#endif
static CYTHON_INLINE char* __Pyx_PyObject_AsString(PyObject*);
static CYTHON_INLINE char* __Pyx_PyObject_AsStringAndSize(PyObject*, Py_ssize_t* length);
#define __Pyx_PyByteArray_FromString(s) PyByteArray_FromStringAndSize((const char*)s, strlen((const char*)s))
#define __Pyx_PyByteArray_FromStringAndSize(s, l) PyByteArray_FromStringAndSize((const char*)s, l)
#define __Pyx_PyBytes_FromString        PyBytes_FromString
#define __Pyx_PyBytes_FromStringAndSize PyBytes_FromStringAndSize
static CYTHON_INLINE PyObject* __Pyx_PyUnicode_FromString(const char*);
#if PY_MAJOR_VERSION < 3
    #define __Pyx_PyStr_FromString        __Pyx_PyBytes_FromString
    #define __Pyx_PyStr_FromStringAndSize __Pyx_PyBytes_FromStringAndSize
#else
    #define __Pyx_PyStr_FromString        __Pyx_PyUnicode_FromString
    #define __Pyx_PyStr_FromStringAndSize __Pyx_PyUnicode_FromStringAndSize
#endif
#define __Pyx_PyObject_AsSString(s)    ((signed char*) __Pyx_PyObject_AsString(s))
#define __Pyx_PyObject_AsUString(s)    ((unsigned char*) __Pyx_PyObject_AsString(s))
#define __Pyx_PyObject_FromCString(s)  __Pyx_PyObject_FromString((const char*)s)
#define __Pyx_PyBytes_FromCString(s)   __Pyx_PyBytes_FromString((const char*)s)
#define __Pyx_PyByteArray_FromCString(s)   __Pyx_PyByteArray_FromString((const char*)s)
#define __Pyx_PyStr_FromCString(s)     __Pyx_PyStr_FromString((const char*)s)
#define __Pyx_PyUnicode_FromCString(s) __Pyx_PyUnicode_FromString((const char*)s)
#if PY_MAJOR_VERSION < 3
static CYTHON_INLINE size_t __Pyx_Py_UNICODE_strlen(const Py_UNICODE *u)
{
    const Py_UNICODE *u_end = u;
    while (*u_end++) ;
    return (size_t)(u_end - u - 1);
}
#else
#define __Pyx_Py_UNICODE_strlen Py_UNICODE_strlen
#endif
#define __Pyx_PyUnicode_FromUnicode(u)       PyUnicode_FromUnicode(u, __Pyx_Py_UNICODE_strlen(u))
#define __Pyx_PyUnicode_FromUnicodeAndLength PyUnicode_FromUnicode
#define __Pyx_PyUnicode_AsUnicode            PyUnicode_AsUnicode
#define __Pyx_NewRef(obj) (Py_INCREF(obj), obj)
#define __Pyx_Owned_Py_None(b) __Pyx_NewRef(Py_None)
#define __Pyx_PyBool_FromLong(b) ((b) ? __Pyx_NewRef(Py_True) : __Pyx_NewRef(Py_False))
static CYTHON_INLINE int __Pyx_PyObject_IsTrue(PyObject*);
static CYTHON_INLINE PyObject* __Pyx_PyNumber_IntOrLong(PyObject* x);
static CYTHON_INLINE Py_ssize_t __Pyx_PyIndex_AsSsize_t(PyObject*);
static CYTHON_INLINE PyObject * __Pyx_PyInt_FromSize_t(size_t);
#if CYTHON_COMPILING_IN_CPYTHON
#define __pyx_PyFloat_AsDouble(x) (PyFloat_CheckExact(x) ? PyFloat_AS_DOUBLE(x) : PyFloat_AsDouble(x))
#else
#define __pyx_PyFloat_AsDouble(x) PyFloat_AsDouble(x)
#endif
#define __pyx_PyFloat_AsFloat(x) ((float) __pyx_PyFloat_AsDouble(x))
#if PY_MAJOR_VERSION >= 3
#define __Pyx_PyNumber_Int(x) (PyLong_CheckExact(x) ? __Pyx_NewRef(x) : PyNumber_Long(x))
#else
#define __Pyx_PyNumber_Int(x) (PyInt_CheckExact(x) ? __Pyx_NewRef(x) : PyNumber_Int(x))
#endif
#define __Pyx_PyNumber_Float(x) (PyFloat_CheckExact(x) ? __Pyx_NewRef(x) : PyNumber_Float(x))
#if PY_MAJOR_VERSION < 3 && __PYX_DEFAULT_STRING_ENCODING_IS_ASCII
static int __Pyx_sys_getdefaultencoding_not_ascii;
static int __Pyx_init_sys_getdefaultencoding_params(void) {
    PyObject* sys;
    PyObject* default_encoding = NULL;
    PyObject* ascii_chars_u = NULL;
    PyObject* ascii_chars_b = NULL;
    const char* default_encoding_c;
    sys = PyImport_ImportModule("sys");
    if (!sys) goto bad;
    default_encoding = PyObject_CallMethod(sys, (char*) "getdefaultencoding", NULL);
    Py_DECREF(sys);
    if (!default_encoding) goto bad;
    default_encoding_c = PyBytes_AsString(default_encoding);
    if (!default_encoding_c) goto bad;
    if (strcmp(default_encoding_c, "ascii") == 0) {
        __Pyx_sys_getdefaultencoding_not_ascii = 0;
    } else {
        char ascii_chars[128];
        int c;
        for (c = 0; c < 128; c++) {
            ascii_chars[c] = c;
        }
        __Pyx_sys_getdefaultencoding_not_ascii = 1;
        ascii_chars_u = PyUnicode_DecodeASCII(ascii_chars, 128, NULL);
        if (!ascii_chars_u) goto bad;
        ascii_chars_b = PyUnicode_AsEncodedString(ascii_chars_u, default_encoding_c, NULL);
        if (!ascii_chars_b || !PyBytes_Check(ascii_chars_b) || memcmp(ascii_chars, PyBytes_AS_STRING(ascii_chars_b), 128) != 0) {
            PyErr_Format(
                PyExc_ValueError,
                "This module compiled with c_string_encoding=ascii, but default encoding '%.200s' is not a superset of ascii.",
                default_encoding_c);
            goto bad;
        }
        Py_DECREF(ascii_chars_u);
        Py_DECREF(ascii_chars_b);
    }
    Py_DECREF(default_encoding);
    return 0;
bad:
    Py_XDECREF(default_encoding);
    Py_XDECREF(ascii_chars_u);
    Py_XDECREF(ascii_chars_b);
    return -1;
}
#endif
#if __PYX_DEFAULT_STRING_ENCODING_IS_DEFAULT && PY_MAJOR_VERSION >= 3
#define __Pyx_PyUnicode_FromStringAndSize(c_str, size) PyUnicode_DecodeUTF8(c_str, size, NULL)
#else
#define __Pyx_PyUnicode_FromStringAndSize(c_str, size) PyUnicode_Decode(c_str, size, __PYX_DEFAULT_STRING_ENCODING, NULL)
#if __PYX_DEFAULT_STRING_ENCODING_IS_DEFAULT
static char* __PYX_DEFAULT_STRING_ENCODING;
static int __Pyx_init_sys_getdefaultencoding_params(void) {
    PyObject* sys;
    PyObject* default_encoding = NULL;
    char* default_encoding_c;
    sys = PyImport_ImportModule("sys");
    if (!sys) goto bad;
    default_encoding = PyObject_CallMethod(sys, (char*) (const char*) "getdefaultencoding", NULL);
    Py_DECREF(sys);
    if (!default_encoding) goto bad;
    default_encoding_c = PyBytes_AsString(default_encoding);
    if (!default_encoding_c) goto bad;
    __PYX_DEFAULT_STRING_ENCODING = (char*) malloc(strlen(default_encoding_c));
    if (!__PYX_DEFAULT_STRING_ENCODING) goto bad;
    strcpy(__PYX_DEFAULT_STRING_ENCODING, default_encoding_c);
    Py_DECREF(default_encoding);
    return 0;
bad:
    Py_XDECREF(default_encoding);
    return -1;
}
#endif
#endif


/* Test for GCC > 2.95 */
#if defined(__GNUC__)     && (__GNUC__ > 2 || (__GNUC__ == 2 && (__GNUC_MINOR__ > 95)))
  #define likely(x)   __builtin_expect(!!(x), 1)
  #define unlikely(x) __builtin_expect(!!(x), 0)
#else /* !__GNUC__ or GCC < 2.95 */
  #define likely(x)   (x)
  #define unlikely(x) (x)
#endif /* __GNUC__ */

static PyObject *__pyx_m;
static PyObject *__pyx_d;
static PyObject *__pyx_b;
static PyObject *__pyx_empty_tuple;
static PyObject *__pyx_empty_bytes;
static PyObject *__pyx_empty_unicode;
static int __pyx_lineno;
static int __pyx_clineno = 0;
static const char * __pyx_cfilenm= __FILE__;
static const char *__pyx_filename;

/* None.proto */
#if !defined(CYTHON_CCOMPLEX)
  #if defined(__cplusplus)
    #define CYTHON_CCOMPLEX 1
  #elif defined(_Complex_I)
    #define CYTHON_CCOMPLEX 1
  #else
    #define CYTHON_CCOMPLEX 0
  #endif
#endif
#if CYTHON_CCOMPLEX
  #ifdef __cplusplus
    #include <complex>
  #else
    #include <complex.h>
  #endif
#endif
#if CYTHON_CCOMPLEX && !defined(__cplusplus) && defined(__sun__) && defined(__GNUC__)
  #undef _Complex_I
  #define _Complex_I 1.0fj
#endif


static const char *__pyx_f[] = {
  "orb/cutils.pyx",
  "__init__.pxd",
  "type.pxd",
  "bool.pxd",
  "complex.pxd",
};
/* BufferFormatStructs.proto */
#define IS_UNSIGNED(type) (((type) -1) > 0)
struct __Pyx_StructField_;
#define __PYX_BUF_FLAGS_PACKED_STRUCT (1 << 0)
typedef struct {
  const char* name;
  struct __Pyx_StructField_* fields;
  size_t size;
  size_t arraysize[8];
  int ndim;
  char typegroup;
  char is_unsigned;
  int flags;
} __Pyx_TypeInfo;
typedef struct __Pyx_StructField_ {
  __Pyx_TypeInfo* type;
  const char* name;
  size_t offset;
} __Pyx_StructField;
typedef struct {
  __Pyx_StructField* field;
  size_t parent_offset;
} __Pyx_BufFmt_StackElem;
typedef struct {
  __Pyx_StructField root;
  __Pyx_BufFmt_StackElem* head;
  size_t fmt_offset;
  size_t new_count, enc_count;
  size_t struct_alignment;
  int is_complex;
  char enc_type;
  char new_packmode;
  char enc_packmode;
  char is_valid_array;
} __Pyx_BufFmt_Context;


/* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":725
 * # in Cython to enable them only on the right systems.
 * 
 * ctypedef npy_int8       int8_t             # <<<<<<<<<<<<<<
 * ctypedef npy_int16      int16_t
 * ctypedef npy_int32      int32_t
 */
typedef npy_int8 __pyx_t_5numpy_int8_t;

/* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":726
 * 
 * ctypedef npy_int8       int8_t
 * ctypedef npy_int16      int16_t             # <<<<<<<<<<<<<<
 * ctypedef npy_int32      int32_t
 * ctypedef npy_int64      int64_t
 */
typedef npy_int16 __pyx_t_5numpy_int16_t;

/* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":727
 * ctypedef npy_int8       int8_t
 * ctypedef npy_int16      int16_t
 * ctypedef npy_int32      int32_t             # <<<<<<<<<<<<<<
 * ctypedef npy_int64      int64_t
 * #ctypedef npy_int96      int96_t
 */
typedef npy_int32 __pyx_t_5numpy_int32_t;

/* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":728
 * ctypedef npy_int16      int16_t
 * ctypedef npy_int32      int32_t
 * ctypedef npy_int64      int64_t             # <<<<<<<<<<<<<<
 * #ctypedef npy_int96      int96_t
 * #ctypedef npy_int128     int128_t
 */
typedef npy_int64 __pyx_t_5numpy_int64_t;

/* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":732
 * #ctypedef npy_int128     int128_t
 * 
 * ctypedef npy_uint8      uint8_t             # <<<<<<<<<<<<<<
 * ctypedef npy_uint16     uint16_t
 * ctypedef npy_uint32     uint32_t
 */
typedef npy_uint8 __pyx_t_5numpy_uint8_t;

/* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":733
 * 
 * ctypedef npy_uint8      uint8_t
 * ctypedef npy_uint16     uint16_t             # <<<<<<<<<<<<<<
 * ctypedef npy_uint32     uint32_t
 * ctypedef npy_uint64     uint64_t
 */
typedef npy_uint16 __pyx_t_5numpy_uint16_t;

/* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":734
 * ctypedef npy_uint8      uint8_t
 * ctypedef npy_uint16     uint16_t
 * ctypedef npy_uint32     uint32_t             # <<<<<<<<<<<<<<
 * ctypedef npy_uint64     uint64_t
 * #ctypedef npy_uint96     uint96_t
 */
typedef npy_uint32 __pyx_t_5numpy_uint32_t;

/* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":735
 * ctypedef npy_uint16     uint16_t
 * ctypedef npy_uint32     uint32_t
 * ctypedef npy_uint64     uint64_t             # <<<<<<<<<<<<<<
 * #ctypedef npy_uint96     uint96_t
 * #ctypedef npy_uint128    uint128_t
 */
typedef npy_uint64 __pyx_t_5numpy_uint64_t;

/* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":739
 * #ctypedef npy_uint128    uint128_t
 * 
 * ctypedef npy_float32    float32_t             # <<<<<<<<<<<<<<
 * ctypedef npy_float64    float64_t
 * #ctypedef npy_float80    float80_t
 */
typedef npy_float32 __pyx_t_5numpy_float32_t;

/* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":740
 * 
 * ctypedef npy_float32    float32_t
 * ctypedef npy_float64    float64_t             # <<<<<<<<<<<<<<
 * #ctypedef npy_float80    float80_t
 * #ctypedef npy_float128   float128_t
 */
typedef npy_float64 __pyx_t_5numpy_float64_t;

/* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":749
 * # The int types are mapped a bit surprising --
 * # numpy.int corresponds to 'l' and numpy.long to 'q'
 * ctypedef npy_long       int_t             # <<<<<<<<<<<<<<
 * ctypedef npy_longlong   long_t
 * ctypedef npy_longlong   longlong_t
 */
typedef npy_long __pyx_t_5numpy_int_t;

/* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":750
 * # numpy.int corresponds to 'l' and numpy.long to 'q'
 * ctypedef npy_long       int_t
 * ctypedef npy_longlong   long_t             # <<<<<<<<<<<<<<
 * ctypedef npy_longlong   longlong_t
 * 
 */
typedef npy_longlong __pyx_t_5numpy_long_t;

/* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":751
 * ctypedef npy_long       int_t
 * ctypedef npy_longlong   long_t
 * ctypedef npy_longlong   longlong_t             # <<<<<<<<<<<<<<
 * 
 * ctypedef npy_ulong      uint_t
 */
typedef npy_longlong __pyx_t_5numpy_longlong_t;

/* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":753
 * ctypedef npy_longlong   longlong_t
 * 
 * ctypedef npy_ulong      uint_t             # <<<<<<<<<<<<<<
 * ctypedef npy_ulonglong  ulong_t
 * ctypedef npy_ulonglong  ulonglong_t
 */
typedef npy_ulong __pyx_t_5numpy_uint_t;

/* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":754
 * 
 * ctypedef npy_ulong      uint_t
 * ctypedef npy_ulonglong  ulong_t             # <<<<<<<<<<<<<<
 * ctypedef npy_ulonglong  ulonglong_t
 * 
 */
typedef npy_ulonglong __pyx_t_5numpy_ulong_t;

/* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":755
 * ctypedef npy_ulong      uint_t
 * ctypedef npy_ulonglong  ulong_t
 * ctypedef npy_ulonglong  ulonglong_t             # <<<<<<<<<<<<<<
 * 
 * ctypedef npy_intp       intp_t
 */
typedef npy_ulonglong __pyx_t_5numpy_ulonglong_t;

/* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":757
 * ctypedef npy_ulonglong  ulonglong_t
 * 
 * ctypedef npy_intp       intp_t             # <<<<<<<<<<<<<<
 * ctypedef npy_uintp      uintp_t
 * 
 */
typedef npy_intp __pyx_t_5numpy_intp_t;

/* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":758
 * 
 * ctypedef npy_intp       intp_t
 * ctypedef npy_uintp      uintp_t             # <<<<<<<<<<<<<<
 * 
 * ctypedef npy_double     float_t
 */
typedef npy_uintp __pyx_t_5numpy_uintp_t;

/* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":760
 * ctypedef npy_uintp      uintp_t
 * 
 * ctypedef npy_double     float_t             # <<<<<<<<<<<<<<
 * ctypedef npy_double     double_t
 * ctypedef npy_longdouble longdouble_t
 */
typedef npy_double __pyx_t_5numpy_float_t;

/* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":761
 * 
 * ctypedef npy_double     float_t
 * ctypedef npy_double     double_t             # <<<<<<<<<<<<<<
 * ctypedef npy_longdouble longdouble_t
 * 
 */
typedef npy_double __pyx_t_5numpy_double_t;

/* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":762
 * ctypedef npy_double     float_t
 * ctypedef npy_double     double_t
 * ctypedef npy_longdouble longdouble_t             # <<<<<<<<<<<<<<
 * 
 * ctypedef npy_cfloat      cfloat_t
 */
typedef npy_longdouble __pyx_t_5numpy_longdouble_t;

/* "orb/cutils.pyx":64
 * 
 * # define long double for numpy arrays
 * ctypedef long double float128_t             # <<<<<<<<<<<<<<
 * 
 * def radians(double deg):
 */
typedef long double __pyx_t_3orb_6cutils_float128_t;
/* None.proto */
#if CYTHON_CCOMPLEX
  #ifdef __cplusplus
    typedef ::std::complex< double > __pyx_t_double_complex;
  #else
    typedef double _Complex __pyx_t_double_complex;
  #endif
#else
    typedef struct { double real, imag; } __pyx_t_double_complex;
#endif

/* None.proto */
#if CYTHON_CCOMPLEX
  #ifdef __cplusplus
    typedef ::std::complex< float > __pyx_t_float_complex;
  #else
    typedef float _Complex __pyx_t_float_complex;
  #endif
#else
    typedef struct { float real, imag; } __pyx_t_float_complex;
#endif


/*--- Type declarations ---*/
struct __pyx_obj_3orb_6cutils___pyx_scope_struct__multi_fit_stars;

/* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":764
 * ctypedef npy_longdouble longdouble_t
 * 
 * ctypedef npy_cfloat      cfloat_t             # <<<<<<<<<<<<<<
 * ctypedef npy_cdouble     cdouble_t
 * ctypedef npy_clongdouble clongdouble_t
 */
typedef npy_cfloat __pyx_t_5numpy_cfloat_t;

/* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":765
 * 
 * ctypedef npy_cfloat      cfloat_t
 * ctypedef npy_cdouble     cdouble_t             # <<<<<<<<<<<<<<
 * ctypedef npy_clongdouble clongdouble_t
 * 
 */
typedef npy_cdouble __pyx_t_5numpy_cdouble_t;

/* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":766
 * ctypedef npy_cfloat      cfloat_t
 * ctypedef npy_cdouble     cdouble_t
 * ctypedef npy_clongdouble clongdouble_t             # <<<<<<<<<<<<<<
 * 
 * ctypedef npy_cdouble     complex_t
 */
typedef npy_clongdouble __pyx_t_5numpy_clongdouble_t;

/* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":768
 * ctypedef npy_clongdouble clongdouble_t
 * 
 * ctypedef npy_cdouble     complex_t             # <<<<<<<<<<<<<<
 * 
 * cdef inline object PyArray_MultiIterNew1(a):
 */
typedef npy_cdouble __pyx_t_5numpy_complex_t;

/* "orb/cutils.pyx":1208
 *     return inside
 * 
 * def multi_fit_stars(np.ndarray[np.float64_t, ndim=2] frame,             # <<<<<<<<<<<<<<
 *                     np.ndarray[np.float64_t, ndim=2] pos,
 *                     int box_size,
 */
struct __pyx_obj_3orb_6cutils___pyx_scope_struct__multi_fit_stars {
  PyObject_HEAD
  PyObject *__pyx_v_model_diff;
  PyObject *__pyx_v_params_vect2arrays;
};


/* --- Runtime support code (head) --- */
/* Refnanny.proto */
#ifndef CYTHON_REFNANNY
  #define CYTHON_REFNANNY 0
#endif
#if CYTHON_REFNANNY
  typedef struct {
    void (*INCREF)(void*, PyObject*, int);
    void (*DECREF)(void*, PyObject*, int);
    void (*GOTREF)(void*, PyObject*, int);
    void (*GIVEREF)(void*, PyObject*, int);
    void* (*SetupContext)(const char*, int, const char*);
    void (*FinishContext)(void**);
  } __Pyx_RefNannyAPIStruct;
  static __Pyx_RefNannyAPIStruct *__Pyx_RefNanny = NULL;
  static __Pyx_RefNannyAPIStruct *__Pyx_RefNannyImportAPI(const char *modname);
  #define __Pyx_RefNannyDeclarations void *__pyx_refnanny = NULL;
#ifdef WITH_THREAD
  #define __Pyx_RefNannySetupContext(name, acquire_gil)\
          if (acquire_gil) {\
              PyGILState_STATE __pyx_gilstate_save = PyGILState_Ensure();\
              __pyx_refnanny = __Pyx_RefNanny->SetupContext((name), __LINE__, __FILE__);\
              PyGILState_Release(__pyx_gilstate_save);\
          } else {\
              __pyx_refnanny = __Pyx_RefNanny->SetupContext((name), __LINE__, __FILE__);\
          }
#else
  #define __Pyx_RefNannySetupContext(name, acquire_gil)\
          __pyx_refnanny = __Pyx_RefNanny->SetupContext((name), __LINE__, __FILE__)
#endif
  #define __Pyx_RefNannyFinishContext()\
          __Pyx_RefNanny->FinishContext(&__pyx_refnanny)
  #define __Pyx_INCREF(r)  __Pyx_RefNanny->INCREF(__pyx_refnanny, (PyObject *)(r), __LINE__)
  #define __Pyx_DECREF(r)  __Pyx_RefNanny->DECREF(__pyx_refnanny, (PyObject *)(r), __LINE__)
  #define __Pyx_GOTREF(r)  __Pyx_RefNanny->GOTREF(__pyx_refnanny, (PyObject *)(r), __LINE__)
  #define __Pyx_GIVEREF(r) __Pyx_RefNanny->GIVEREF(__pyx_refnanny, (PyObject *)(r), __LINE__)
  #define __Pyx_XINCREF(r)  do { if((r) != NULL) {__Pyx_INCREF(r); }} while(0)
  #define __Pyx_XDECREF(r)  do { if((r) != NULL) {__Pyx_DECREF(r); }} while(0)
  #define __Pyx_XGOTREF(r)  do { if((r) != NULL) {__Pyx_GOTREF(r); }} while(0)
  #define __Pyx_XGIVEREF(r) do { if((r) != NULL) {__Pyx_GIVEREF(r);}} while(0)
#else
  #define __Pyx_RefNannyDeclarations
  #define __Pyx_RefNannySetupContext(name, acquire_gil)
  #define __Pyx_RefNannyFinishContext()
  #define __Pyx_INCREF(r) Py_INCREF(r)
  #define __Pyx_DECREF(r) Py_DECREF(r)
  #define __Pyx_GOTREF(r)
  #define __Pyx_GIVEREF(r)
  #define __Pyx_XINCREF(r) Py_XINCREF(r)
  #define __Pyx_XDECREF(r) Py_XDECREF(r)
  #define __Pyx_XGOTREF(r)
  #define __Pyx_XGIVEREF(r)
#endif
#define __Pyx_XDECREF_SET(r, v) do {\
        PyObject *tmp = (PyObject *) r;\
        r = v; __Pyx_XDECREF(tmp);\
    } while (0)
#define __Pyx_DECREF_SET(r, v) do {\
        PyObject *tmp = (PyObject *) r;\
        r = v; __Pyx_DECREF(tmp);\
    } while (0)
#define __Pyx_CLEAR(r)    do { PyObject* tmp = ((PyObject*)(r)); r = NULL; __Pyx_DECREF(tmp);} while(0)
#define __Pyx_XCLEAR(r)   do { if((r) != NULL) {PyObject* tmp = ((PyObject*)(r)); r = NULL; __Pyx_DECREF(tmp);}} while(0)

/* PyObjectGetAttrStr.proto */
#if CYTHON_COMPILING_IN_CPYTHON
static CYTHON_INLINE PyObject* __Pyx_PyObject_GetAttrStr(PyObject* obj, PyObject* attr_name) {
    PyTypeObject* tp = Py_TYPE(obj);
    if (likely(tp->tp_getattro))
        return tp->tp_getattro(obj, attr_name);
#if PY_MAJOR_VERSION < 3
    if (likely(tp->tp_getattr))
        return tp->tp_getattr(obj, PyString_AS_STRING(attr_name));
#endif
    return PyObject_GetAttr(obj, attr_name);
}
#else
#define __Pyx_PyObject_GetAttrStr(o,n) PyObject_GetAttr(o,n)
#endif

/* GetBuiltinName.proto */
static PyObject *__Pyx_GetBuiltinName(PyObject *name);

/* RaiseArgTupleInvalid.proto */
static void __Pyx_RaiseArgtupleInvalid(const char* func_name, int exact,
    Py_ssize_t num_min, Py_ssize_t num_max, Py_ssize_t num_found);

/* RaiseDoubleKeywords.proto */
static void __Pyx_RaiseDoubleKeywordsError(const char* func_name, PyObject* kw_name);

/* ParseKeywords.proto */
static int __Pyx_ParseOptionalKeywords(PyObject *kwds, PyObject **argnames[],\
    PyObject *kwds2, PyObject *values[], Py_ssize_t num_pos_args,\
    const char* function_name);

/* GetModuleGlobalName.proto */
static CYTHON_INLINE PyObject *__Pyx_GetModuleGlobalName(PyObject *name);

/* PyObjectCall.proto */
#if CYTHON_COMPILING_IN_CPYTHON
static CYTHON_INLINE PyObject* __Pyx_PyObject_Call(PyObject *func, PyObject *arg, PyObject *kw);
#else
#define __Pyx_PyObject_Call(func, arg, kw) PyObject_Call(func, arg, kw)
#endif

/* PyObjectCallMethO.proto */
#if CYTHON_COMPILING_IN_CPYTHON
static CYTHON_INLINE PyObject* __Pyx_PyObject_CallMethO(PyObject *func, PyObject *arg);
#endif

/* PyObjectCallOneArg.proto */
static CYTHON_INLINE PyObject* __Pyx_PyObject_CallOneArg(PyObject *func, PyObject *arg);

/* ArgTypeTest.proto */
static CYTHON_INLINE int __Pyx_ArgTypeTest(PyObject *obj, PyTypeObject *type, int none_allowed,
    const char *name, int exact);

/* BufferFormatCheck.proto */
static CYTHON_INLINE int  __Pyx_GetBufferAndValidate(Py_buffer* buf, PyObject* obj,
    __Pyx_TypeInfo* dtype, int flags, int nd, int cast, __Pyx_BufFmt_StackElem* stack);
static CYTHON_INLINE void __Pyx_SafeReleaseBuffer(Py_buffer* info);
static const char* __Pyx_BufFmt_CheckString(__Pyx_BufFmt_Context* ctx, const char* ts);
static void __Pyx_BufFmt_Init(__Pyx_BufFmt_Context* ctx,
                              __Pyx_BufFmt_StackElem* stack,
                              __Pyx_TypeInfo* type); // PROTO

/* ExtTypeTest.proto */
static CYTHON_INLINE int __Pyx_TypeTest(PyObject *obj, PyTypeObject *type);

/* RaiseTooManyValuesToUnpack.proto */
static CYTHON_INLINE void __Pyx_RaiseTooManyValuesError(Py_ssize_t expected);

/* RaiseNeedMoreValuesToUnpack.proto */
static CYTHON_INLINE void __Pyx_RaiseNeedMoreValuesError(Py_ssize_t index);

/* IterFinish.proto */
static CYTHON_INLINE int __Pyx_IterFinish(void);

/* UnpackItemEndCheck.proto */
static int __Pyx_IternextUnpackEndCheck(PyObject *retval, Py_ssize_t expected);

/* BufferFallbackError.proto */
static void __Pyx_RaiseBufferFallbackError(void);

/* PyThreadStateGet.proto */
#if CYTHON_COMPILING_IN_CPYTHON
#define __Pyx_PyThreadState_declare  PyThreadState *__pyx_tstate;
#define __Pyx_PyThreadState_assign  __pyx_tstate = PyThreadState_GET();
#else
#define __Pyx_PyThreadState_declare
#define __Pyx_PyThreadState_assign
#endif

/* PyErrFetchRestore.proto */
#if CYTHON_COMPILING_IN_CPYTHON
#define __Pyx_ErrRestoreWithState(type, value, tb)  __Pyx_ErrRestoreInState(PyThreadState_GET(), type, value, tb)
#define __Pyx_ErrFetchWithState(type, value, tb)    __Pyx_ErrFetchInState(PyThreadState_GET(), type, value, tb)
#define __Pyx_ErrRestore(type, value, tb)  __Pyx_ErrRestoreInState(__pyx_tstate, type, value, tb)
#define __Pyx_ErrFetch(type, value, tb)    __Pyx_ErrFetchInState(__pyx_tstate, type, value, tb)
static CYTHON_INLINE void __Pyx_ErrRestoreInState(PyThreadState *tstate, PyObject *type, PyObject *value, PyObject *tb);
static CYTHON_INLINE void __Pyx_ErrFetchInState(PyThreadState *tstate, PyObject **type, PyObject **value, PyObject **tb);
#else
#define __Pyx_ErrRestoreWithState(type, value, tb)  PyErr_Restore(type, value, tb)
#define __Pyx_ErrFetchWithState(type, value, tb)  PyErr_Fetch(type, value, tb)
#define __Pyx_ErrRestore(type, value, tb)  PyErr_Restore(type, value, tb)
#define __Pyx_ErrFetch(type, value, tb)  PyErr_Fetch(type, value, tb)
#endif

/* PyObjectCallNoArg.proto */
#if CYTHON_COMPILING_IN_CPYTHON
static CYTHON_INLINE PyObject* __Pyx_PyObject_CallNoArg(PyObject *func);
#else
#define __Pyx_PyObject_CallNoArg(func) __Pyx_PyObject_Call(func, __pyx_empty_tuple, NULL)
#endif

#define __Pyx_BufPtrStrided2d(type, buf, i0, s0, i1, s1) (type)((char*)buf + i0 * s0 + i1 * s1)
/* ForceInitThreads.proto */
#ifndef __PYX_FORCE_INIT_THREADS
  #define __PYX_FORCE_INIT_THREADS 0
#endif

/* None.proto */
static CYTHON_INLINE void __Pyx_RaiseUnboundLocalError(const char *varname);

/* BufferIndexError.proto */
static void __Pyx_RaiseBufferIndexError(int axis);

#define __Pyx_BufPtrStrided1d(type, buf, i0, s0) (type)((char*)buf + i0 * s0)
/* SliceObject.proto */
static CYTHON_INLINE PyObject* __Pyx_PyObject_GetSlice(
        PyObject* obj, Py_ssize_t cstart, Py_ssize_t cstop,
        PyObject** py_start, PyObject** py_stop, PyObject** py_slice,
        int has_cstart, int has_cstop, int wraparound);

/* RaiseException.proto */
static void __Pyx_Raise(PyObject *type, PyObject *value, PyObject *tb, PyObject *cause);

/* GetItemInt.proto */
#define __Pyx_GetItemInt(o, i, type, is_signed, to_py_func, is_list, wraparound, boundscheck)\
    (__Pyx_fits_Py_ssize_t(i, type, is_signed) ?\
    __Pyx_GetItemInt_Fast(o, (Py_ssize_t)i, is_list, wraparound, boundscheck) :\
    (is_list ? (PyErr_SetString(PyExc_IndexError, "list index out of range"), (PyObject*)NULL) :\
               __Pyx_GetItemInt_Generic(o, to_py_func(i))))
#define __Pyx_GetItemInt_List(o, i, type, is_signed, to_py_func, is_list, wraparound, boundscheck)\
    (__Pyx_fits_Py_ssize_t(i, type, is_signed) ?\
    __Pyx_GetItemInt_List_Fast(o, (Py_ssize_t)i, wraparound, boundscheck) :\
    (PyErr_SetString(PyExc_IndexError, "list index out of range"), (PyObject*)NULL))
static CYTHON_INLINE PyObject *__Pyx_GetItemInt_List_Fast(PyObject *o, Py_ssize_t i,
                                                              int wraparound, int boundscheck);
#define __Pyx_GetItemInt_Tuple(o, i, type, is_signed, to_py_func, is_list, wraparound, boundscheck)\
    (__Pyx_fits_Py_ssize_t(i, type, is_signed) ?\
    __Pyx_GetItemInt_Tuple_Fast(o, (Py_ssize_t)i, wraparound, boundscheck) :\
    (PyErr_SetString(PyExc_IndexError, "tuple index out of range"), (PyObject*)NULL))
static CYTHON_INLINE PyObject *__Pyx_GetItemInt_Tuple_Fast(PyObject *o, Py_ssize_t i,
                                                              int wraparound, int boundscheck);
static CYTHON_INLINE PyObject *__Pyx_GetItemInt_Generic(PyObject *o, PyObject* j);
static CYTHON_INLINE PyObject *__Pyx_GetItemInt_Fast(PyObject *o, Py_ssize_t i,
                                                     int is_list, int wraparound, int boundscheck);

/* PyIntBinop.proto */
#if CYTHON_COMPILING_IN_CPYTHON
static PyObject* __Pyx_PyInt_AddObjC(PyObject *op1, PyObject *op2, long intval, int inplace);
#else
#define __Pyx_PyInt_AddObjC(op1, op2, intval, inplace)\
    (inplace ? PyNumber_InPlaceAdd(op1, op2) : PyNumber_Add(op1, op2))
#endif

/* IncludeStringH.proto */
#include <string.h>

/* BytesEquals.proto */
static CYTHON_INLINE int __Pyx_PyBytes_Equals(PyObject* s1, PyObject* s2, int equals);

/* UnicodeEquals.proto */
static CYTHON_INLINE int __Pyx_PyUnicode_Equals(PyObject* s1, PyObject* s2, int equals);

/* StrEquals.proto */
#if PY_MAJOR_VERSION >= 3
#define __Pyx_PyString_Equals __Pyx_PyUnicode_Equals
#else
#define __Pyx_PyString_Equals __Pyx_PyBytes_Equals
#endif

/* SliceObject.proto */
#define __Pyx_PyObject_DelSlice(obj, cstart, cstop, py_start, py_stop, py_slice, has_cstart, has_cstop, wraparound)\
    __Pyx_PyObject_SetSlice(obj, (PyObject*)NULL, cstart, cstop, py_start, py_stop, py_slice, has_cstart, has_cstop, wraparound)
static CYTHON_INLINE int __Pyx_PyObject_SetSlice(
        PyObject* obj, PyObject* value, Py_ssize_t cstart, Py_ssize_t cstop,
        PyObject** py_start, PyObject** py_stop, PyObject** py_slice,
        int has_cstart, int has_cstop, int wraparound);

/* PyFloatBinop.proto */
#if CYTHON_COMPILING_IN_CPYTHON
static PyObject* __Pyx_PyFloat_AddObjC(PyObject *op1, PyObject *op2, double floatval, int inplace);
#else
#define __Pyx_PyFloat_AddObjC(op1, op2, floatval, inplace)\
    (inplace ? PyNumber_InPlaceAdd(op1, op2) : PyNumber_Add(op1, op2))
#endif

/* None.proto */
static CYTHON_INLINE long __Pyx_mod_long(long, long);

/* None.proto */
static CYTHON_INLINE int __Pyx_mod_int(int, int);

/* None.proto */
static CYTHON_INLINE void __Pyx_RaiseClosureNameError(const char *varname);

/* FetchCommonType.proto */
static PyTypeObject* __Pyx_FetchCommonType(PyTypeObject* type);

/* CythonFunction.proto */
#define __Pyx_CyFunction_USED 1
#include <structmember.h>
#define __Pyx_CYFUNCTION_STATICMETHOD  0x01
#define __Pyx_CYFUNCTION_CLASSMETHOD   0x02
#define __Pyx_CYFUNCTION_CCLASS        0x04
#define __Pyx_CyFunction_GetClosure(f)\
    (((__pyx_CyFunctionObject *) (f))->func_closure)
#define __Pyx_CyFunction_GetClassObj(f)\
    (((__pyx_CyFunctionObject *) (f))->func_classobj)
#define __Pyx_CyFunction_Defaults(type, f)\
    ((type *)(((__pyx_CyFunctionObject *) (f))->defaults))
#define __Pyx_CyFunction_SetDefaultsGetter(f, g)\
    ((__pyx_CyFunctionObject *) (f))->defaults_getter = (g)
typedef struct {
    PyCFunctionObject func;
#if PY_VERSION_HEX < 0x030500A0
    PyObject *func_weakreflist;
#endif
    PyObject *func_dict;
    PyObject *func_name;
    PyObject *func_qualname;
    PyObject *func_doc;
    PyObject *func_globals;
    PyObject *func_code;
    PyObject *func_closure;
    PyObject *func_classobj;
    void *defaults;
    int defaults_pyobjects;
    int flags;
    PyObject *defaults_tuple;
    PyObject *defaults_kwdict;
    PyObject *(*defaults_getter)(PyObject *);
    PyObject *func_annotations;
} __pyx_CyFunctionObject;
static PyTypeObject *__pyx_CyFunctionType = 0;
#define __Pyx_CyFunction_NewEx(ml, flags, qualname, self, module, globals, code)\
    __Pyx_CyFunction_New(__pyx_CyFunctionType, ml, flags, qualname, self, module, globals, code)
static PyObject *__Pyx_CyFunction_New(PyTypeObject *, PyMethodDef *ml,
                                      int flags, PyObject* qualname,
                                      PyObject *self,
                                      PyObject *module, PyObject *globals,
                                      PyObject* code);
static CYTHON_INLINE void *__Pyx_CyFunction_InitDefaults(PyObject *m,
                                                         size_t size,
                                                         int pyobjects);
static CYTHON_INLINE void __Pyx_CyFunction_SetDefaultsTuple(PyObject *m,
                                                            PyObject *tuple);
static CYTHON_INLINE void __Pyx_CyFunction_SetDefaultsKwDict(PyObject *m,
                                                             PyObject *dict);
static CYTHON_INLINE void __Pyx_CyFunction_SetAnnotationsDict(PyObject *m,
                                                              PyObject *dict);
static int __pyx_CyFunction_init(void);

/* PyIntBinop.proto */
#if CYTHON_COMPILING_IN_CPYTHON
static PyObject* __Pyx_PyInt_EqObjC(PyObject *op1, PyObject *op2, long intval, int inplace);
#else
#define __Pyx_PyInt_EqObjC(op1, op2, intval, inplace)\
    PyObject_RichCompare(op1, op2, Py_EQ)
    #endif

/* SaveResetException.proto */
#if CYTHON_COMPILING_IN_CPYTHON
#define __Pyx_ExceptionSave(type, value, tb)  __Pyx__ExceptionSave(__pyx_tstate, type, value, tb)
static CYTHON_INLINE void __Pyx__ExceptionSave(PyThreadState *tstate, PyObject **type, PyObject **value, PyObject **tb);
#define __Pyx_ExceptionReset(type, value, tb)  __Pyx__ExceptionReset(__pyx_tstate, type, value, tb)
static CYTHON_INLINE void __Pyx__ExceptionReset(PyThreadState *tstate, PyObject *type, PyObject *value, PyObject *tb);
#else
#define __Pyx_ExceptionSave(type, value, tb)   PyErr_GetExcInfo(type, value, tb)
#define __Pyx_ExceptionReset(type, value, tb)  PyErr_SetExcInfo(type, value, tb)
#endif

/* PyErrExceptionMatches.proto */
#if CYTHON_COMPILING_IN_CPYTHON
#define __Pyx_PyErr_ExceptionMatches(err) __Pyx_PyErr_ExceptionMatchesInState(__pyx_tstate, err)
static CYTHON_INLINE int __Pyx_PyErr_ExceptionMatchesInState(PyThreadState* tstate, PyObject* err);
#else
#define __Pyx_PyErr_ExceptionMatches(err)  PyErr_ExceptionMatches(err)
#endif

/* GetException.proto */
#if CYTHON_COMPILING_IN_CPYTHON
#define __Pyx_GetException(type, value, tb)  __Pyx__GetException(__pyx_tstate, type, value, tb)
static int __Pyx__GetException(PyThreadState *tstate, PyObject **type, PyObject **value, PyObject **tb);
#else
static int __Pyx_GetException(PyObject **type, PyObject **value, PyObject **tb);
#endif

/* DictGetItem.proto */
#if PY_MAJOR_VERSION >= 3 && !CYTHON_COMPILING_IN_PYPY
static PyObject *__Pyx_PyDict_GetItem(PyObject *d, PyObject* key) {
    PyObject *value;
    value = PyDict_GetItemWithError(d, key);
    if (unlikely(!value)) {
        if (!PyErr_Occurred()) {
            PyObject* args = PyTuple_Pack(1, key);
            if (likely(args))
                PyErr_SetObject(PyExc_KeyError, args);
            Py_XDECREF(args);
        }
        return NULL;
    }
    Py_INCREF(value);
    return value;
}
#else
    #define __Pyx_PyDict_GetItem(d, key) PyObject_GetItem(d, key)
#endif

/* ListCompAppend.proto */
#if CYTHON_COMPILING_IN_CPYTHON
static CYTHON_INLINE int __Pyx_ListComp_Append(PyObject* list, PyObject* x) {
    PyListObject* L = (PyListObject*) list;
    Py_ssize_t len = Py_SIZE(list);
    if (likely(L->allocated > len)) {
        Py_INCREF(x);
        PyList_SET_ITEM(list, len, x);
        Py_SIZE(list) = len+1;
        return 0;
    }
    return PyList_Append(list, x);
}
#else
#define __Pyx_ListComp_Append(L,x) PyList_Append(L,x)
#endif

/* PyIntBinop.proto */
#if CYTHON_COMPILING_IN_CPYTHON
static PyObject* __Pyx_PyInt_SubtractObjC(PyObject *op1, PyObject *op2, long intval, int inplace);
#else
#define __Pyx_PyInt_SubtractObjC(op1, op2, intval, inplace)\
    (inplace ? PyNumber_InPlaceSubtract(op1, op2) : PyNumber_Subtract(op1, op2))
#endif

/* PyObjectSetAttrStr.proto */
#if CYTHON_COMPILING_IN_CPYTHON
#define __Pyx_PyObject_DelAttrStr(o,n) __Pyx_PyObject_SetAttrStr(o,n,NULL)
static CYTHON_INLINE int __Pyx_PyObject_SetAttrStr(PyObject* obj, PyObject* attr_name, PyObject* value) {
    PyTypeObject* tp = Py_TYPE(obj);
    if (likely(tp->tp_setattro))
        return tp->tp_setattro(obj, attr_name, value);
#if PY_MAJOR_VERSION < 3
    if (likely(tp->tp_setattr))
        return tp->tp_setattr(obj, PyString_AS_STRING(attr_name), value);
#endif
    return PyObject_SetAttr(obj, attr_name, value);
}
#else
#define __Pyx_PyObject_DelAttrStr(o,n)   PyObject_DelAttr(o,n)
#define __Pyx_PyObject_SetAttrStr(o,n,v) PyObject_SetAttr(o,n,v)
#endif

/* None.proto */
static CYTHON_INLINE npy_intp __Pyx_div_npy_intp(npy_intp, npy_intp);

/* UnaryNegOverflows.proto */
#define UNARY_NEG_WOULD_OVERFLOW(x)\
        (((x) < 0) & ((unsigned long)(x) == 0-(unsigned long)(x)))

/* None.proto */
static CYTHON_INLINE int __Pyx_div_int(int, int);

#define __Pyx_BufPtrStrided3d(type, buf, i0, s0, i1, s1, i2, s2) (type)((char*)buf + i0 * s0 + i1 * s1 + i2 * s2)
/* None.proto */
static CYTHON_INLINE long __Pyx_div_long(long, long);

/* PyFloatBinop.proto */
#if CYTHON_COMPILING_IN_CPYTHON
static PyObject* __Pyx_PyFloat_DivideCObj(PyObject *op1, PyObject *op2, double floatval, int inplace);
#else
#define __Pyx_PyFloat_DivideCObj(op1, op2, floatval, inplace)\
    ((inplace ? __Pyx_PyNumber_InPlaceDivide(op1, op2) : __Pyx_PyNumber_Divide(op1, op2)))
    #endif

/* RaiseNoneIterError.proto */
static CYTHON_INLINE void __Pyx_RaiseNoneNotIterableError(void);

/* Import.proto */
static PyObject *__Pyx_Import(PyObject *name, PyObject *from_list, int level);

/* CodeObjectCache.proto */
typedef struct {
    PyCodeObject* code_object;
    int code_line;
} __Pyx_CodeObjectCacheEntry;
struct __Pyx_CodeObjectCache {
    int count;
    int max_count;
    __Pyx_CodeObjectCacheEntry* entries;
};
static struct __Pyx_CodeObjectCache __pyx_code_cache = {0,0,NULL};
static int __pyx_bisect_code_objects(__Pyx_CodeObjectCacheEntry* entries, int count, int code_line);
static PyCodeObject *__pyx_find_code_object(int code_line);
static void __pyx_insert_code_object(int code_line, PyCodeObject* code_object);

/* AddTraceback.proto */
static void __Pyx_AddTraceback(const char *funcname, int c_line,
                               int py_line, const char *filename);

/* None.proto */
#if CYTHON_CCOMPLEX
  #ifdef __cplusplus
    #define __Pyx_CREAL(z) ((z).real())
    #define __Pyx_CIMAG(z) ((z).imag())
  #else
    #define __Pyx_CREAL(z) (__real__(z))
    #define __Pyx_CIMAG(z) (__imag__(z))
  #endif
#else
    #define __Pyx_CREAL(z) ((z).real)
    #define __Pyx_CIMAG(z) ((z).imag)
#endif
#if defined(__cplusplus) && CYTHON_CCOMPLEX         && (defined(_WIN32) || defined(__clang__) || (defined(__GNUC__) && (__GNUC__ >= 5 || __GNUC__ == 4 && __GNUC_MINOR__ >= 4 )) || __cplusplus >= 201103)
    #define __Pyx_SET_CREAL(z,x) ((z).real(x))
    #define __Pyx_SET_CIMAG(z,y) ((z).imag(y))
#else
    #define __Pyx_SET_CREAL(z,x) __Pyx_CREAL(z) = (x)
    #define __Pyx_SET_CIMAG(z,y) __Pyx_CIMAG(z) = (y)
#endif

/* None.proto */
static CYTHON_INLINE __pyx_t_double_complex __pyx_t_double_complex_from_parts(double, double);

/* None.proto */
#if CYTHON_CCOMPLEX
    #define __Pyx_c_eq(a, b)   ((a)==(b))
    #define __Pyx_c_sum(a, b)  ((a)+(b))
    #define __Pyx_c_diff(a, b) ((a)-(b))
    #define __Pyx_c_prod(a, b) ((a)*(b))
    #define __Pyx_c_quot(a, b) ((a)/(b))
    #define __Pyx_c_neg(a)     (-(a))
  #ifdef __cplusplus
    #define __Pyx_c_is_zero(z) ((z)==(double)0)
    #define __Pyx_c_conj(z)    (::std::conj(z))
    #if 1
        #define __Pyx_c_abs(z)     (::std::abs(z))
        #define __Pyx_c_pow(a, b)  (::std::pow(a, b))
    #endif
  #else
    #define __Pyx_c_is_zero(z) ((z)==0)
    #define __Pyx_c_conj(z)    (conj(z))
    #if 1
        #define __Pyx_c_abs(z)     (cabs(z))
        #define __Pyx_c_pow(a, b)  (cpow(a, b))
    #endif
 #endif
#else
    static CYTHON_INLINE int __Pyx_c_eq(__pyx_t_double_complex, __pyx_t_double_complex);
    static CYTHON_INLINE __pyx_t_double_complex __Pyx_c_sum(__pyx_t_double_complex, __pyx_t_double_complex);
    static CYTHON_INLINE __pyx_t_double_complex __Pyx_c_diff(__pyx_t_double_complex, __pyx_t_double_complex);
    static CYTHON_INLINE __pyx_t_double_complex __Pyx_c_prod(__pyx_t_double_complex, __pyx_t_double_complex);
    static CYTHON_INLINE __pyx_t_double_complex __Pyx_c_quot(__pyx_t_double_complex, __pyx_t_double_complex);
    static CYTHON_INLINE __pyx_t_double_complex __Pyx_c_neg(__pyx_t_double_complex);
    static CYTHON_INLINE int __Pyx_c_is_zero(__pyx_t_double_complex);
    static CYTHON_INLINE __pyx_t_double_complex __Pyx_c_conj(__pyx_t_double_complex);
    #if 1
        static CYTHON_INLINE double __Pyx_c_abs(__pyx_t_double_complex);
        static CYTHON_INLINE __pyx_t_double_complex __Pyx_c_pow(__pyx_t_double_complex, __pyx_t_double_complex);
    #endif
#endif

/* BufferStructDeclare.proto */
typedef struct {
  Py_ssize_t shape, strides, suboffsets;
} __Pyx_Buf_DimInfo;
typedef struct {
  size_t refcount;
  Py_buffer pybuffer;
} __Pyx_Buffer;
typedef struct {
  __Pyx_Buffer *rcbuffer;
  char *data;
  __Pyx_Buf_DimInfo diminfo[8];
} __Pyx_LocalBuf_ND;

#if PY_MAJOR_VERSION < 3
    static int __Pyx_GetBuffer(PyObject *obj, Py_buffer *view, int flags);
    static void __Pyx_ReleaseBuffer(Py_buffer *view);
#else
    #define __Pyx_GetBuffer PyObject_GetBuffer
    #define __Pyx_ReleaseBuffer PyBuffer_Release
#endif


/* None.proto */
static Py_ssize_t __Pyx_zeros[] = {0, 0, 0, 0, 0, 0, 0, 0};
static Py_ssize_t __Pyx_minusones[] = {-1, -1, -1, -1, -1, -1, -1, -1};

/* CIntToPy.proto */
static CYTHON_INLINE PyObject* __Pyx_PyInt_From_Py_intptr_t(Py_intptr_t value);

/* CIntToPy.proto */
static CYTHON_INLINE PyObject* __Pyx_PyInt_From_int(int value);

/* CIntToPy.proto */
static CYTHON_INLINE PyObject* __Pyx_PyInt_From_long(long value);

/* None.proto */
#define __pyx_PyComplex_FromComplex(z) \
        PyComplex_FromDoubles((double)__Pyx_CREAL(z), \
                              (double)__Pyx_CIMAG(z))

/* Print.proto */
static int __Pyx_Print(PyObject*, PyObject *, int);
#if CYTHON_COMPILING_IN_PYPY || PY_MAJOR_VERSION >= 3
static PyObject* __pyx_print = 0;
static PyObject* __pyx_print_kwargs = 0;
#endif

/* None.proto */
static CYTHON_INLINE __pyx_t_float_complex __pyx_t_float_complex_from_parts(float, float);

/* None.proto */
#if CYTHON_CCOMPLEX
    #define __Pyx_c_eqf(a, b)   ((a)==(b))
    #define __Pyx_c_sumf(a, b)  ((a)+(b))
    #define __Pyx_c_difff(a, b) ((a)-(b))
    #define __Pyx_c_prodf(a, b) ((a)*(b))
    #define __Pyx_c_quotf(a, b) ((a)/(b))
    #define __Pyx_c_negf(a)     (-(a))
  #ifdef __cplusplus
    #define __Pyx_c_is_zerof(z) ((z)==(float)0)
    #define __Pyx_c_conjf(z)    (::std::conj(z))
    #if 1
        #define __Pyx_c_absf(z)     (::std::abs(z))
        #define __Pyx_c_powf(a, b)  (::std::pow(a, b))
    #endif
  #else
    #define __Pyx_c_is_zerof(z) ((z)==0)
    #define __Pyx_c_conjf(z)    (conjf(z))
    #if 1
        #define __Pyx_c_absf(z)     (cabsf(z))
        #define __Pyx_c_powf(a, b)  (cpowf(a, b))
    #endif
 #endif
#else
    static CYTHON_INLINE int __Pyx_c_eqf(__pyx_t_float_complex, __pyx_t_float_complex);
    static CYTHON_INLINE __pyx_t_float_complex __Pyx_c_sumf(__pyx_t_float_complex, __pyx_t_float_complex);
    static CYTHON_INLINE __pyx_t_float_complex __Pyx_c_difff(__pyx_t_float_complex, __pyx_t_float_complex);
    static CYTHON_INLINE __pyx_t_float_complex __Pyx_c_prodf(__pyx_t_float_complex, __pyx_t_float_complex);
    static CYTHON_INLINE __pyx_t_float_complex __Pyx_c_quotf(__pyx_t_float_complex, __pyx_t_float_complex);
    static CYTHON_INLINE __pyx_t_float_complex __Pyx_c_negf(__pyx_t_float_complex);
    static CYTHON_INLINE int __Pyx_c_is_zerof(__pyx_t_float_complex);
    static CYTHON_INLINE __pyx_t_float_complex __Pyx_c_conjf(__pyx_t_float_complex);
    #if 1
        static CYTHON_INLINE float __Pyx_c_absf(__pyx_t_float_complex);
        static CYTHON_INLINE __pyx_t_float_complex __Pyx_c_powf(__pyx_t_float_complex, __pyx_t_float_complex);
    #endif
#endif

/* CIntToPy.proto */
static CYTHON_INLINE PyObject* __Pyx_PyInt_From_enum__NPY_TYPES(enum NPY_TYPES value);

/* CIntFromPy.proto */
static CYTHON_INLINE int __Pyx_PyInt_As_int(PyObject *);

/* CIntFromPy.proto */
static CYTHON_INLINE long __Pyx_PyInt_As_long(PyObject *);

/* CheckBinaryVersion.proto */
static int __Pyx_check_binary_version(void);

/* PyIdentifierFromString.proto */
#if !defined(__Pyx_PyIdentifier_FromString)
#if PY_MAJOR_VERSION < 3
  #define __Pyx_PyIdentifier_FromString(s) PyString_FromString(s)
#else
  #define __Pyx_PyIdentifier_FromString(s) PyUnicode_FromString(s)
#endif
#endif

/* ModuleImport.proto */
static PyObject *__Pyx_ImportModule(const char *name);

/* TypeImport.proto */
static PyTypeObject *__Pyx_ImportType(const char *module_name, const char *class_name, size_t size, int strict);

/* InitStrings.proto */
static int __Pyx_InitStrings(__Pyx_StringTabEntry *t);


/* Module declarations from 'cython' */

/* Module declarations from 'cpython.buffer' */

/* Module declarations from 'libc.string' */

/* Module declarations from 'libc.stdio' */

/* Module declarations from '__builtin__' */

/* Module declarations from 'cpython.type' */
static PyTypeObject *__pyx_ptype_7cpython_4type_type = 0;

/* Module declarations from 'cpython.version' */

/* Module declarations from 'cpython.exc' */

/* Module declarations from 'cpython.module' */

/* Module declarations from 'cpython.mem' */

/* Module declarations from 'cpython.tuple' */

/* Module declarations from 'cpython.list' */

/* Module declarations from 'cpython.sequence' */

/* Module declarations from 'cpython.mapping' */

/* Module declarations from 'cpython.iterator' */

/* Module declarations from 'cpython.number' */

/* Module declarations from 'cpython.int' */

/* Module declarations from '__builtin__' */

/* Module declarations from 'cpython.bool' */
static PyTypeObject *__pyx_ptype_7cpython_4bool_bool = 0;

/* Module declarations from 'cpython.long' */

/* Module declarations from 'cpython.float' */

/* Module declarations from '__builtin__' */

/* Module declarations from 'cpython.complex' */
static PyTypeObject *__pyx_ptype_7cpython_7complex_complex = 0;

/* Module declarations from 'cpython.string' */

/* Module declarations from 'cpython.unicode' */

/* Module declarations from 'cpython.dict' */

/* Module declarations from 'cpython.instance' */

/* Module declarations from 'cpython.function' */

/* Module declarations from 'cpython.method' */

/* Module declarations from 'cpython.weakref' */

/* Module declarations from 'cpython.getargs' */

/* Module declarations from 'cpython.pythread' */

/* Module declarations from 'cpython.pystate' */

/* Module declarations from 'cpython.cobject' */

/* Module declarations from 'cpython.oldbuffer' */

/* Module declarations from 'cpython.set' */

/* Module declarations from 'cpython.bytes' */

/* Module declarations from 'cpython.pycapsule' */

/* Module declarations from 'cpython' */

/* Module declarations from 'cpython.object' */

/* Module declarations from 'cpython.ref' */

/* Module declarations from 'libc.stdlib' */

/* Module declarations from 'numpy' */

/* Module declarations from 'numpy' */
static PyTypeObject *__pyx_ptype_5numpy_dtype = 0;
static PyTypeObject *__pyx_ptype_5numpy_flatiter = 0;
static PyTypeObject *__pyx_ptype_5numpy_broadcast = 0;
static PyTypeObject *__pyx_ptype_5numpy_ndarray = 0;
static PyTypeObject *__pyx_ptype_5numpy_ufunc = 0;
static CYTHON_INLINE char *__pyx_f_5numpy__util_dtypestring(PyArray_Descr *, char *, char *, int *); /*proto*/

/* Module declarations from 'orb.cutils' */
static PyTypeObject *__pyx_ptype_3orb_6cutils___pyx_scope_struct__multi_fit_stars = 0;
static __Pyx_TypeInfo __Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t = { "float64_t", NULL, sizeof(__pyx_t_5numpy_float64_t), { 0 }, 0, 'R', 0, 0 };
static __Pyx_TypeInfo __Pyx_TypeInfo_nn___pyx_t_5numpy_int64_t = { "int64_t", NULL, sizeof(__pyx_t_5numpy_int64_t), { 0 }, 0, IS_UNSIGNED(__pyx_t_5numpy_int64_t) ? 'U' : 'I', IS_UNSIGNED(__pyx_t_5numpy_int64_t), 0 };
static __Pyx_TypeInfo __Pyx_TypeInfo_nn___pyx_t_5numpy_uint8_t = { "uint8_t", NULL, sizeof(__pyx_t_5numpy_uint8_t), { 0 }, 0, IS_UNSIGNED(__pyx_t_5numpy_uint8_t) ? 'U' : 'I', IS_UNSIGNED(__pyx_t_5numpy_uint8_t), 0 };
static __Pyx_TypeInfo __Pyx_TypeInfo_nn___pyx_t_5numpy_int8_t = { "int8_t", NULL, sizeof(__pyx_t_5numpy_int8_t), { 0 }, 0, IS_UNSIGNED(__pyx_t_5numpy_int8_t) ? 'U' : 'I', IS_UNSIGNED(__pyx_t_5numpy_int8_t), 0 };
static __Pyx_TypeInfo __Pyx_TypeInfo_nn___pyx_t_5numpy_uint16_t = { "uint16_t", NULL, sizeof(__pyx_t_5numpy_uint16_t), { 0 }, 0, IS_UNSIGNED(__pyx_t_5numpy_uint16_t) ? 'U' : 'I', IS_UNSIGNED(__pyx_t_5numpy_uint16_t), 0 };
#define __Pyx_MODULE_NAME "orb.cutils"
int __pyx_module_is_main_orb__cutils = 0;

/* Implementation of 'orb.cutils' */
static PyObject *__pyx_builtin_range;
static PyObject *__pyx_builtin_Exception;
static PyObject *__pyx_builtin_ValueError;
static PyObject *__pyx_builtin_xrange;
static PyObject *__pyx_builtin_RuntimeError;
static const char __pyx_k_M[] = "M";
static const char __pyx_k_N[] = "N";
static const char __pyx_k_S[] = "S";
static const char __pyx_k_T[] = "T";
static const char __pyx_k_X[] = "X";
static const char __pyx_k_a[] = "a";
static const char __pyx_k_b[] = "b";
static const char __pyx_k_c[] = "c";
static const char __pyx_k_d[] = "d";
static const char __pyx_k_e[] = "e";
static const char __pyx_k_f[] = "f";
static const char __pyx_k_h[] = "h";
static const char __pyx_k_i[] = "i";
static const char __pyx_k_j[] = "j";
static const char __pyx_k_k[] = "k";
static const char __pyx_k_m[] = "m";
static const char __pyx_k_n[] = "n";
static const char __pyx_k_r[] = "r";
static const char __pyx_k_w[] = "w";
static const char __pyx_k_x[] = "x";
static const char __pyx_k_y[] = "y";
static const char __pyx_k_bn[] = "bn";
static const char __pyx_k_da[] = "da";
static const char __pyx_k_db[] = "db";
static const char __pyx_k_dr[] = "dr";
static const char __pyx_k_dx[] = "dx";
static const char __pyx_k_dy[] = "dy";
static const char __pyx_k_fn[] = "fn";
static const char __pyx_k_ii[] = "ii";
static const char __pyx_k_ij[] = "ij";
static const char __pyx_k_ik[] = "ik";
static const char __pyx_k_im[] = "im";
static const char __pyx_k_ip[] = "ip";
static const char __pyx_k_ir[] = "ir";
static const char __pyx_k_ix[] = "ix";
static const char __pyx_k_iy[] = "iy";
static const char __pyx_k_me[] = "me";
static const char __pyx_k_nb[] = "nb";
static const char __pyx_k_np[] = "np";
static const char __pyx_k_nx[] = "nx";
static const char __pyx_k_ny[] = "ny";
static const char __pyx_k_sz[] = "sz";
static const char __pyx_k_x1[] = "x1";
static const char __pyx_k_x2[] = "x2";
static const char __pyx_k_xc[] = "xc";
static const char __pyx_k_y1[] = "y1";
static const char __pyx_k_y2[] = "y2";
static const char __pyx_k_yc[] = "yc";
static const char __pyx_k_zx[] = "zx";
static const char __pyx_k_zy[] = "zy";
static const char __pyx_k__45[] = "|";
static const char __pyx_k_abs[] = "abs";
static const char __pyx_k_all[] = "all";
static const char __pyx_k_any[] = "any";
static const char __pyx_k_arr[] = "arr";
static const char __pyx_k_box[] = "box";
static const char __pyx_k_dcl[] = "dcl";
static const char __pyx_k_deg[] = "deg";
static const char __pyx_k_dft[] = "dft";
static const char __pyx_k_end[] = "end";
static const char __pyx_k_exp[] = "exp";
static const char __pyx_k_fft[] = "fft";
static const char __pyx_k_fit[] = "fit";
static const char __pyx_k_hsz[] = "hsz";
static const char __pyx_k_icr[] = "icr";
static const char __pyx_k_max[] = "max";
static const char __pyx_k_med[] = "med";
static const char __pyx_k_min[] = "min";
static const char __pyx_k_nan[] = "nan";
static const char __pyx_k_nzi[] = "nzi";
static const char __pyx_k_nzj[] = "nzj";
static const char __pyx_k_out[] = "out";
static const char __pyx_k_p1x[] = "p1x";
static const char __pyx_k_p1y[] = "p1y";
static const char __pyx_k_p2x[] = "p2x";
static const char __pyx_k_p2y[] = "p2y";
static const char __pyx_k_pix[] = "pix";
static const char __pyx_k_plx[] = "plx";
static const char __pyx_k_ply[] = "ply";
static const char __pyx_k_pos[] = "pos";
static const char __pyx_k_q11[] = "q11";
static const char __pyx_k_q12[] = "q12";
static const char __pyx_k_q21[] = "q21";
static const char __pyx_k_q22[] = "q22";
static const char __pyx_k_rcx[] = "rcx";
static const char __pyx_k_rcy[] = "rcy";
static const char __pyx_k_res[] = "res";
static const char __pyx_k_ron[] = "ron";
static const char __pyx_k_sip[] = "sip";
static const char __pyx_k_std[] = "std";
static const char __pyx_k_sum[] = "sum";
static const char __pyx_k_val[] = "val";
static const char __pyx_k_x1d[] = "x1d";
static const char __pyx_k_x2d[] = "x2d";
static const char __pyx_k_xrc[] = "xrc";
static const char __pyx_k_y1d[] = "y1d";
static const char __pyx_k_y2d[] = "y2d";
static const char __pyx_k_yrc[] = "yrc";
static const char __pyx_k_args[] = "args";
static const char __pyx_k_arr8[] = "arr8";
static const char __pyx_k_axis[] = "axis";
static const char __pyx_k_back[] = "back";
static const char __pyx_k_beta[] = "beta";
static const char __pyx_k_binx[] = "binx";
static const char __pyx_k_biny[] = "biny";
static const char __pyx_k_copy[] = "copy";
static const char __pyx_k_corr[] = "corr";
static const char __pyx_k_data[] = "data";
static const char __pyx_k_ddeg[] = "ddeg";
static const char __pyx_k_diff[] = "diff";
static const char __pyx_k_dimx[] = "dimx";
static const char __pyx_k_dimy[] = "dimy";
static const char __pyx_k_dimz[] = "dimz";
static const char __pyx_k_file[] = "file";
static const char __pyx_k_fill[] = "fill";
static const char __pyx_k_flag[] = "flag";
static const char __pyx_k_fvec[] = "fvec";
static const char __pyx_k_fwhm[] = "fwhm";
static const char __pyx_k_icol[] = "icol";
static const char __pyx_k_icut[] = "icut";
static const char __pyx_k_ideg[] = "ideg";
static const char __pyx_k_ifft[] = "ifft";
static const char __pyx_k_imag[] = "imag";
static const char __pyx_k_imax[] = "imax";
static const char __pyx_k_imin[] = "imin";
static const char __pyx_k_inan[] = "inan";
static const char __pyx_k_int8[] = "int8";
static const char __pyx_k_isub[] = "isub";
static const char __pyx_k_jsub[] = "jsub";
static const char __pyx_k_line[] = "line";
static const char __pyx_k_main[] = "__main__";
static const char __pyx_k_maxs[] = "maxs";
static const char __pyx_k_maxx[] = "maxx";
static const char __pyx_k_minx[] = "minx";
static const char __pyx_k_mode[] = "mode";
static const char __pyx_k_nans[] = "nans";
static const char __pyx_k_ones[] = "ones";
static const char __pyx_k_outx[] = "outx";
static const char __pyx_k_outy[] = "outy";
static const char __pyx_k_poly[] = "poly";
static const char __pyx_k_real[] = "real";
static const char __pyx_k_rmax[] = "rmax";
static const char __pyx_k_rmin[] = "rmin";
static const char __pyx_k_sign[] = "sign";
static const char __pyx_k_sinc[] = "sinc";
static const char __pyx_k_size[] = "size";
static const char __pyx_k_sort[] = "sort";
static const char __pyx_k_sqrt[] = "sqrt";
static const char __pyx_k_star[] = "star";
static const char __pyx_k_step[] = "step";
static const char __pyx_k_test[] = "__test__";
static const char __pyx_k_time[] = "time";
static const char __pyx_k_vmax[] = "vmax";
static const char __pyx_k_vmin[] = "vmin";
static const char __pyx_k_wlen[] = "wlen";
static const char __pyx_k_xmax[] = "xmax";
static const char __pyx_k_xmin[] = "xmin";
static const char __pyx_k_xtol[] = "xtol";
static const char __pyx_k_ymax[] = "ymax";
static const char __pyx_k_ymin[] = "ymin";
static const char __pyx_k_S_sky[] = "S_sky";
static const char __pyx_k_a_err[] = "a_err";
static const char __pyx_k_alpha[] = "alpha";
static const char __pyx_k_angle[] = "angle";
static const char __pyx_k_array[] = "array";
static const char __pyx_k_b_err[] = "b_err";
static const char __pyx_k_box_s[] = "box_s";
static const char __pyx_k_bytes[] = "bytes";
static const char __pyx_k_c_err[] = "c_err";
static const char __pyx_k_chisq[] = "chisq";
static const char __pyx_k_coeff[] = "coeff";
static const char __pyx_k_cov_p[] = "cov_p";
static const char __pyx_k_d_err[] = "d_err";
static const char __pyx_k_dtype[] = "dtype";
static const char __pyx_k_empty[] = "empty";
static const char __pyx_k_fimag[] = "fimag";
static const char __pyx_k_flagw[] = "flagw";
static const char __pyx_k_flagx[] = "flagx";
static const char __pyx_k_frame[] = "frame";
static const char __pyx_k_freal[] = "freal";
static const char __pyx_k_iline[] = "iline";
static const char __pyx_k_index[] = "index";
static const char __pyx_k_indft[] = "indft";
static const char __pyx_k_int64[] = "int64";
static const char __pyx_k_isinf[] = "isinf";
static const char __pyx_k_isnan[] = "isnan";
static const char __pyx_k_istar[] = "istar";
static const char __pyx_k_max2d[] = "max2d";
static const char __pyx_k_mgrid[] = "mgrid";
static const char __pyx_k_new_x[] = "new_x";
static const char __pyx_k_nkeep[] = "nkeep";
static const char __pyx_k_noise[] = "noise";
static const char __pyx_k_numpy[] = "numpy";
static const char __pyx_k_order[] = "order";
static const char __pyx_k_print[] = "print";
static const char __pyx_k_range[] = "range";
static const char __pyx_k_scipy[] = "scipy";
static const char __pyx_k_shape[] = "shape";
static const char __pyx_k_sigma[] = "sigma";
static const char __pyx_k_sip_A[] = "sip_A";
static const char __pyx_k_sip_B[] = "sip_B";
static const char __pyx_k_std2d[] = "std2d";
static const char __pyx_k_std_x[] = "std_x";
static const char __pyx_k_uint8[] = "uint8";
static const char __pyx_k_value[] = "value";
static const char __pyx_k_width[] = "width";
static const char __pyx_k_wsize[] = "wsize";
static const char __pyx_k_x_max[] = "x_max";
static const char __pyx_k_x_min[] = "x_min";
static const char __pyx_k_xaxis[] = "xaxis";
static const char __pyx_k_xmaxb[] = "xmaxb";
static const char __pyx_k_xminb[] = "xminb";
static const char __pyx_k_y_max[] = "y_max";
static const char __pyx_k_y_min[] = "y_min";
static const char __pyx_k_yaxis[] = "yaxis";
static const char __pyx_k_ymaxb[] = "ymaxb";
static const char __pyx_k_yminb[] = "yminb";
static const char __pyx_k_zeros[] = "zeros";
static const char __pyx_k_anynan[] = "anynan";
static const char __pyx_k_arange[] = "arange";
static const char __pyx_k_argmax[] = "argmax";
static const char __pyx_k_astype[] = "astype";
static const char __pyx_k_boxmed[] = "boxmed";
static const char __pyx_k_boxstd[] = "boxstd";
static const char __pyx_k_coaxis[] = "coaxis";
static const char __pyx_k_coords[] = "coords";
static const char __pyx_k_cov_dx[] = "cov_dx";
static const char __pyx_k_cov_dy[] = "cov_dy";
static const char __pyx_k_cov_zx[] = "cov_zx";
static const char __pyx_k_cov_zy[] = "cov_zy";
static const char __pyx_k_cr_map[] = "cr_map";
static const char __pyx_k_cutoff[] = "cutoff";
static const char __pyx_k_dr_err[] = "dr_err";
static const char __pyx_k_dx_err[] = "dx_err";
static const char __pyx_k_dy_err[] = "dy_err";
static const char __pyx_k_frames[] = "frames";
static const char __pyx_k_free_p[] = "free_p";
static const char __pyx_k_hstack[] = "hstack";
static const char __pyx_k_import[] = "__import__";
static const char __pyx_k_inewcr[] = "inewcr";
static const char __pyx_k_inside[] = "inside";
static const char __pyx_k_interf[] = "interf";
static const char __pyx_k_kernel[] = "kernel";
static const char __pyx_k_map_me[] = "map_me";
static const char __pyx_k_mask2d[] = "mask2d";
static const char __pyx_k_maxfev[] = "maxfev";
static const char __pyx_k_mean2d[] = "mean2d";
static const char __pyx_k_median[] = "median";
static const char __pyx_k_nanmax[] = "nanmax";
static const char __pyx_k_nanmin[] = "nanmin";
static const char __pyx_k_nanstd[] = "nanstd";
static const char __pyx_k_nansum[] = "nansum";
static const char __pyx_k_new_sz[] = "new_sz";
static const char __pyx_k_params[] = "params";
static const char __pyx_k_rejpix[] = "rejpix";
static const char __pyx_k_result[] = "result";
static const char __pyx_k_sinc1d[] = "sinc1d";
static const char __pyx_k_test_p[] = "test_p";
static const char __pyx_k_test_x[] = "test_x";
static const char __pyx_k_test_y[] = "test_y";
static const char __pyx_k_uint16[] = "uint16";
static const char __pyx_k_window[] = "window";
static const char __pyx_k_x1_err[] = "x1_err";
static const char __pyx_k_x2_err[] = "x2_err";
static const char __pyx_k_xcoord[] = "xcoord";
static const char __pyx_k_xrange[] = "xrange";
static const char __pyx_k_y1_err[] = "y1_err";
static const char __pyx_k_y2_err[] = "y2_err";
static const char __pyx_k_ycoord[] = "ycoord";
static const char __pyx_k_zx_err[] = "zx_err";
static const char __pyx_k_zy_err[] = "zy_err";
static const char __pyx_k_SUB_DIV[] = "SUB_DIV";
static const char __pyx_k_binning[] = "binning";
static const char __pyx_k_cm1_max[] = "cm1_max";
static const char __pyx_k_cm1_min[] = "cm1_min";
static const char __pyx_k_cov_err[] = "cov_err";
static const char __pyx_k_cov_pos[] = "cov_pos";
static const char __pyx_k_distrib[] = "distrib";
static const char __pyx_k_filters[] = "filters";
static const char __pyx_k_fit_tol[] = "fit_tol";
static const char __pyx_k_fix_pos[] = "fix_pos";
static const char __pyx_k_fixed_p[] = "fixed_p";
static const char __pyx_k_flatten[] = "flatten";
static const char __pyx_k_float64[] = "float64";
static const char __pyx_k_hwindow[] = "hwindow";
static const char __pyx_k_im2rgba[] = "im2rgba";
static const char __pyx_k_leastsq[] = "leastsq";
static const char __pyx_k_lowpass[] = "lowpass";
static const char __pyx_k_nanmean[] = "nanmean";
static const char __pyx_k_ndimage[] = "ndimage";
static const char __pyx_k_nearest[] = "nearest";
static const char __pyx_k_new_pos[] = "new_pos";
static const char __pyx_k_nonzero[] = "nonzero";
static const char __pyx_k_radians[] = "radians";
static const char __pyx_k_reshape[] = "reshape";
static const char __pyx_k_star_nb[] = "star_nb";
static const char __pyx_k_stars_p[] = "stars_p";
static const char __pyx_k_sub_div[] = "sub_div";
static const char __pyx_k_to_rgba[] = "to_rgba";
static const char __pyx_k_x1_orig[] = "x1_orig";
static const char __pyx_k_x_range[] = "x_range";
static const char __pyx_k_xinters[] = "xinters";
static const char __pyx_k_y1_orig[] = "y1_orig";
static const char __pyx_k_y_range[] = "y_range";
static const char __pyx_k_argmax2d[] = "argmax2d";
static const char __pyx_k_axis_min[] = "axis_min";
static const char __pyx_k_box_size[] = "box_size";
static const char __pyx_k_convolve[] = "convolve";
static const char __pyx_k_cov_diag[] = "cov_diag";
static const char __pyx_k_cov_fwhm[] = "cov_fwhm";
static const char __pyx_k_crs_list[] = "crs_list";
static const char __pyx_k_dsub_div[] = "dsub_div";
static const char __pyx_k_dx_guess[] = "dx_guess";
static const char __pyx_k_dy_guess[] = "dy_guess";
static const char __pyx_k_final_im[] = "final_im";
static const char __pyx_k_fix_fwhm[] = "fix_fwhm";
static const char __pyx_k_fwhm_pix[] = "fwhm_pix";
static const char __pyx_k_gradient[] = "gradient";
static const char __pyx_k_int_posx[] = "int_posx";
static const char __pyx_k_int_posy[] = "int_posy";
static const char __pyx_k_large_sz[] = "large_sz";
static const char __pyx_k_linspace[] = "linspace";
static const char __pyx_k_max_mask[] = "max_mask";
static const char __pyx_k_mean_box[] = "mean_box";
static const char __pyx_k_median2d[] = "median2d";
static const char __pyx_k_median_a[] = "median_a";
static const char __pyx_k_min_mask[] = "min_mask";
static const char __pyx_k_new_nans[] = "new_nans";
static const char __pyx_k_optimize[] = "optimize";
static const char __pyx_k_pos_mask[] = "pos_mask";
static const char __pyx_k_sigmacut[] = "sigmacut";
static const char __pyx_k_spectrum[] = "spectrum";
static const char __pyx_k_sub_dimx[] = "sub_dimx";
static const char __pyx_k_sub_dimy[] = "sub_dimy";
static const char __pyx_k_Exception[] = "Exception";
static const char __pyx_k_PARAMS_NB[] = "PARAMS_NB";
static const char __pyx_k_amp_guess[] = "amp_guess";
static const char __pyx_k_axis_step[] = "axis_step";
static const char __pyx_k_back_size[] = "back_size";
static const char __pyx_k_byteorder[] = "byteorder";
static const char __pyx_k_central_x[] = "central_x";
static const char __pyx_k_constants[] = "constants";
static const char __pyx_k_cov_angle[] = "cov_angle";
static const char __pyx_k_frame_min[] = "frame_min";
static const char __pyx_k_im_coords[] = "im_coords";
static const char __pyx_k_last_arr8[] = "last_arr8";
static const char __pyx_k_last_diff[] = "last_diff";
static const char __pyx_k_nanargmax[] = "nanargmax";
static const char __pyx_k_nanmedian[] = "nanmedian";
static const char __pyx_k_normalize[] = "normalize";
static const char __pyx_k_partition[] = "partition";
static const char __pyx_k_real_nans[] = "real_nans";
static const char __pyx_k_red_chisq[] = "red_chisq";
static const char __pyx_k_rejects2d[] = "rejects2d";
static const char __pyx_k_sigmaclip[] = "sigmaclip";
static const char __pyx_k_star_list[] = "star_list";
static const char __pyx_k_stars_err[] = "stars_err";
static const char __pyx_k_tolerance[] = "tolerance";
static const char __pyx_k_transpose[] = "transpose";
static const char __pyx_k_workframe[] = "workframe";
static const char __pyx_k_x_lim_max[] = "x_lim_max";
static const char __pyx_k_x_lim_min[] = "x_lim_min";
static const char __pyx_k_y_lim_max[] = "y_lim_max";
static const char __pyx_k_y_lim_min[] = "y_lim_min";
static const char __pyx_k_ValueError[] = "ValueError";
static const char __pyx_k_bottleneck[] = "bottleneck";
static const char __pyx_k_chi_square[] = "chi-square";
static const char __pyx_k_cov_height[] = "cov_height";
static const char __pyx_k_cov_matrix[] = "cov_matrix";
static const char __pyx_k_cov_p_mask[] = "cov_p_mask";
static const char __pyx_k_empty_like[] = "empty_like";
static const char __pyx_k_energy_sum[] = "energy_sum";
static const char __pyx_k_fast_pix2w[] = "fast_pix2w";
static const char __pyx_k_fast_w2pix[] = "fast_w2pix";
static const char __pyx_k_fft_filter[] = "fft_filter";
static const char __pyx_k_fix_height[] = "fix_height";
static const char __pyx_k_frame_mask[] = "frame_mask";
static const char __pyx_k_framesdiff[] = "framesdiff";
static const char __pyx_k_fwhm_guess[] = "fwhm_guess";
static const char __pyx_k_gaussian1d[] = "gaussian1d";
static const char __pyx_k_index_list[] = "index_list";
static const char __pyx_k_kernel_mod[] = "kernel_mod";
static const char __pyx_k_min_values[] = "min_values";
static const char __pyx_k_model_diff[] = "model_diff";
static const char __pyx_k_orb_cutils[] = "orb.cutils";
static const char __pyx_k_part_value[] = "part_value";
static const char __pyx_k_pix_coords[] = "pix_coords";
static const char __pyx_k_return_err[] = "return_err";
static const char __pyx_k_robust_std[] = "robust_std";
static const char __pyx_k_robust_sum[] = "robust_sum";
static const char __pyx_k_saturation[] = "saturation";
static const char __pyx_k_sip_im2pix[] = "sip_im2pix";
static const char __pyx_k_sip_pix2im[] = "sip_pix2im";
static const char __pyx_k_sky_pixels[] = "sky_pixels";
static const char __pyx_k_sqrtmean2d[] = "sqrtmean2d";
static const char __pyx_k_total_flux[] = "total_flux";
static const char __pyx_k_zeros_like[] = "zeros_like";
static const char __pyx_k_complexflag[] = "complexflag";
static const char __pyx_k_concatenate[] = "concatenate";
static const char __pyx_k_cr_list_len[] = "cr_list_len";
static const char __pyx_k_enable_zoom[] = "enable_zoom";
static const char __pyx_k_full_output[] = "full_output";
static const char __pyx_k_logical_and[] = "logical_and";
static const char __pyx_k_median_back[] = "median_back";
static const char __pyx_k_new_stars_p[] = "new_stars_p";
static const char __pyx_k_noise_guess[] = "noise_guess";
static const char __pyx_k_reject_mode[] = "reject_mode";
static const char __pyx_k_robust_mean[] = "robust_mean";
static const char __pyx_k_unbin_image[] = "unbin_image";
static const char __pyx_k_RuntimeError[] = "RuntimeError";
static const char __pyx_k_added_height[] = "added_height";
static const char __pyx_k_color_mapper[] = "color_mapper";
static const char __pyx_k_color_values[] = "color_values";
static const char __pyx_k_combine_mode[] = "combine_mode";
static const char __pyx_k_complexflagw[] = "complexflagw";
static const char __pyx_k_complexflagx[] = "complexflagx";
static const char __pyx_k_detect_coeff[] = "detect_coeff";
static const char __pyx_k_dx_guess_arg[] = "dx_guess_arg";
static const char __pyx_k_dy_guess_arg[] = "dy_guess_arg";
static const char __pyx_k_height_guess[] = "height_guess";
static const char __pyx_k_iscomplexobj[] = "iscomplexobj";
static const char __pyx_k_large_kernel[] = "large_kernel";
static const char __pyx_k_meansigcut2d[] = "meansigcut2d";
static const char __pyx_k_mpl_colorbar[] = "mpl_colorbar";
static const char __pyx_k_nanbin_image[] = "nanbin_image";
static const char __pyx_k_newbyteorder[] = "newbyteorder";
static const char __pyx_k_stars_p_mask[] = "stars_p_mask";
static const char __pyx_k_stars_params[] = "stars-params";
static const char __pyx_k_all_pix2world[] = "all_pix2world";
static const char __pyx_k_all_world2pix[] = "all_world2pix";
static const char __pyx_k_big_box_coeff[] = "big_box_coeff";
static const char __pyx_k_central_value[] = "central_value";
static const char __pyx_k_complexresult[] = "complexresult";
static const char __pyx_k_cov_free_p_nb[] = "cov_free_p_nb";
static const char __pyx_k_deg_must_be_0[] = "deg must be >= 0";
static const char __pyx_k_new_rejects2d[] = "new_rejects2d";
static const char __pyx_k_new_stars_err[] = "new_stars_err";
static const char __pyx_k_returned_data[] = "returned_data";
static const char __pyx_k_robust_format[] = "_robust_format";
static const char __pyx_k_robust_median[] = "robust_median";
static const char __pyx_k_scipy_special[] = "scipy.special";
static const char __pyx_k_surface_value[] = "surface_value";
static const char __pyx_k_wcs_pix2world[] = "wcs_pix2world";
static const char __pyx_k_wcs_world2pix[] = "wcs_world2pix";
static const char __pyx_k_FWHM_SKY_COEFF[] = "FWHM_SKY_COEFF";
static const char __pyx_k_get_box_coords[] = "get_box_coords";
static const char __pyx_k_master_combine[] = "master_combine";
static const char __pyx_k_moffat_array2d[] = "moffat_array2d";
static const char __pyx_k_pix_to_compute[] = "pix_to_compute";
static const char __pyx_k_robust_average[] = "robust_average";
static const char __pyx_k_scipy_optimize[] = "scipy.optimize";
static const char __pyx_k_stop_rejection[] = "stop_rejection";
static const char __pyx_k_PRECISION_COEFF[] = "PRECISION_COEFF";
static const char __pyx_k_cleaned_distrib[] = "cleaned_distrib";
static const char __pyx_k_computed_pixels[] = "computed_pixels";
static const char __pyx_k_enable_rotation[] = "enable_rotation";
static const char __pyx_k_gaussian_kernel[] = "gaussian_kernel";
static const char __pyx_k_get_nm_axis_max[] = "get_nm_axis_max";
static const char __pyx_k_get_nm_axis_min[] = "get_nm_axis_min";
static const char __pyx_k_multi_fit_stars[] = "multi_fit_stars";
static const char __pyx_k_stars_free_p_nb[] = "stars_free_p_nb";
static const char __pyx_k_still_rejection[] = "still_rejection";
static const char __pyx_k_brute_photometry[] = "brute_photometry";
static const char __pyx_k_gaussian_array2d[] = "gaussian_array2d";
static const char __pyx_k_get_cm1_axis_max[] = "get_cm1_axis_max";
static const char __pyx_k_get_cm1_axis_min[] = "get_cm1_axis_min";
static const char __pyx_k_get_nm_axis_step[] = "get_nm_axis_step";
static const char __pyx_k_return_std_frame[] = "return_std_frame";
static const char __pyx_k_stars_params_err[] = "stars-params-err";
static const char __pyx_k_transform_A_to_B[] = "transform_A_to_B";
static const char __pyx_k_transform_B_to_A[] = "transform_B_to_A";
static const char __pyx_k_filter_background[] = "filter_background";
static const char __pyx_k_get_cm1_axis_step[] = "get_cm1_axis_step";
static const char __pyx_k_return_index_list[] = "return_index_list";
static const char __pyx_k_scipy_interpolate[] = "scipy.interpolate";
static const char __pyx_k_use_central_value[] = "use_central_value";
static const char __pyx_k_detect_cosmic_rays[] = "detect_cosmic_rays";
static const char __pyx_k_interf_mean_energy[] = "interf_mean_energy";
static const char __pyx_k_params_arrays2vect[] = "params_arrays2vect";
static const char __pyx_k_params_vect2arrays[] = "params_vect2arrays";
static const char __pyx_k_reduced_chi_square[] = "reduced-chi-square";
static const char __pyx_k_estimate_local_noise[] = "estimate_local_noise";
static const char __pyx_k_fast_gaussian_kernel[] = "fast_gaussian_kernel";
static const char __pyx_k_point_inside_polygon[] = "point_inside_polygon";
static const char __pyx_k_spectrum_mean_energy[] = "spectrum_mean_energy";
static const char __pyx_k_create_transform_maps[] = "create_transform_maps";
static const char __pyx_k_low_pass_image_filter[] = "low_pass_image_filter";
static const char __pyx_k_scipy_ndimage_filters[] = "scipy.ndimage.filters";
static const char __pyx_k_multi_fit_stars_locals_diff[] = "multi_fit_stars.<locals>.diff";
static const char __pyx_k_ndarray_is_not_C_contiguous[] = "ndarray is not C contiguous";
static const char __pyx_k_multi_fit_stars_locals_sigma[] = "multi_fit_stars.<locals>.sigma";
static const char __pyx_k_width_must_be_between_0_and_1[] = "width must be between 0. and 1.";
static const char __pyx_k_CUtils_is_a_set_of_C_functions[] = "\nCUtils is a set of C functions coded in Cython_ to improve their speed.\n\n.. note:: This file must be compiled before it can be used::\n\n     cython cutils.pyx\n     \n     gcc -c -fPIC -I/usr/include/python2.7 cutils.c\n     \n     gcc -shared cutils.o -o cutils.so\n\n.. _Cython: http://cython.org/\n\n";
static const char __pyx_k_cutoff_must_be_between_0_and_1[] = "cutoff must be between 0. and 1.";
static const char __pyx_k_Bad_combining_mode_Must_be_0_or[] = "Bad combining mode. Must be 0 or 1";
static const char __pyx_k_Order_cannot_be_0_for_a_nm_axis[] = "Order cannot be 0 for a nm axis (minimum wavelength is infinite), use a cm-1 axis instead";
static const char __pyx_k_check_cosmic_rays_neighbourhood[] = "check_cosmic_rays_neighbourhood";
static const char __pyx_k_opt_orbs_orb_orb_code_orb_cutil[] = "/opt/orbs/orb-orb-code/orb/cutils.pyx";
static const char __pyx_k_unknown_dtype_code_in_numpy_pxd[] = "unknown dtype code in numpy.pxd (%d)";
static const char __pyx_k_Array_and_weights_must_have_same[] = "Array and weights must have same shape";
static const char __pyx_k_Bad_rejection_mode_Must_be_0_1_o[] = "Bad rejection mode. Must be 0, 1 or 2.";
static const char __pyx_k_Exception_raised_during_least_sq[] = "Exception raised during least square fit of cutils.multi_fit_stars:";
static const char __pyx_k_Format_string_allocated_too_shor[] = "Format string allocated too short, see comment in numpy.pxd";
static const char __pyx_k_Non_native_byte_order_not_suppor[] = "Non-native byte order not supported";
static const char __pyx_k_There_must_be_more_than_2_frames[] = "There must be more than 2 frames to combine";
static const char __pyx_k_multi_fit_stars_locals_model_dif[] = "multi_fit_stars.<locals>.model_diff";
static const char __pyx_k_multi_fit_stars_locals_params_ar[] = "multi_fit_stars.<locals>.params_arrays2vect";
static const char __pyx_k_multi_fit_stars_locals_params_ve[] = "multi_fit_stars.<locals>.params_vect2arrays";
static const char __pyx_k_ndarray_is_not_Fortran_contiguou[] = "ndarray is not Fortran contiguous";
static const char __pyx_k_Order_cannot_be_0_for_a_nm_axis_2[] = "Order cannot be 0 for a nm axis (stepsize is infinite), use a cm-1 axis instead";
static const char __pyx_k_Array_and_weights_must_have_same_2[] = "Array and weights must have same number of dimensions";
static const char __pyx_k_Format_string_allocated_too_shor_2[] = "Format string allocated too short.";
static PyObject *__pyx_kp_s_Array_and_weights_must_have_same;
static PyObject *__pyx_kp_s_Array_and_weights_must_have_same_2;
static PyObject *__pyx_kp_s_Bad_combining_mode_Must_be_0_or;
static PyObject *__pyx_kp_s_Bad_rejection_mode_Must_be_0_1_o;
static PyObject *__pyx_n_s_Exception;
static PyObject *__pyx_kp_s_Exception_raised_during_least_sq;
static PyObject *__pyx_n_s_FWHM_SKY_COEFF;
static PyObject *__pyx_kp_u_Format_string_allocated_too_shor;
static PyObject *__pyx_kp_u_Format_string_allocated_too_shor_2;
static PyObject *__pyx_n_s_M;
static PyObject *__pyx_n_s_N;
static PyObject *__pyx_kp_u_Non_native_byte_order_not_suppor;
static PyObject *__pyx_kp_s_Order_cannot_be_0_for_a_nm_axis;
static PyObject *__pyx_kp_s_Order_cannot_be_0_for_a_nm_axis_2;
static PyObject *__pyx_n_s_PARAMS_NB;
static PyObject *__pyx_n_s_PRECISION_COEFF;
static PyObject *__pyx_n_s_RuntimeError;
static PyObject *__pyx_n_s_S;
static PyObject *__pyx_n_s_SUB_DIV;
static PyObject *__pyx_n_s_S_sky;
static PyObject *__pyx_n_s_T;
static PyObject *__pyx_kp_s_There_must_be_more_than_2_frames;
static PyObject *__pyx_n_s_ValueError;
static PyObject *__pyx_n_s_X;
static PyObject *__pyx_kp_s__45;
static PyObject *__pyx_n_s_a;
static PyObject *__pyx_n_s_a_err;
static PyObject *__pyx_n_s_abs;
static PyObject *__pyx_n_s_added_height;
static PyObject *__pyx_n_s_all;
static PyObject *__pyx_n_s_all_pix2world;
static PyObject *__pyx_n_s_all_world2pix;
static PyObject *__pyx_n_s_alpha;
static PyObject *__pyx_n_s_amp_guess;
static PyObject *__pyx_n_s_angle;
static PyObject *__pyx_n_s_any;
static PyObject *__pyx_n_s_anynan;
static PyObject *__pyx_n_s_arange;
static PyObject *__pyx_n_s_argmax;
static PyObject *__pyx_n_s_argmax2d;
static PyObject *__pyx_n_s_args;
static PyObject *__pyx_n_s_arr;
static PyObject *__pyx_n_s_arr8;
static PyObject *__pyx_n_s_array;
static PyObject *__pyx_n_s_astype;
static PyObject *__pyx_n_s_axis;
static PyObject *__pyx_n_s_axis_min;
static PyObject *__pyx_n_s_axis_step;
static PyObject *__pyx_n_s_b;
static PyObject *__pyx_n_s_b_err;
static PyObject *__pyx_n_s_back;
static PyObject *__pyx_n_s_back_size;
static PyObject *__pyx_n_s_beta;
static PyObject *__pyx_n_s_big_box_coeff;
static PyObject *__pyx_n_s_binning;
static PyObject *__pyx_n_s_binx;
static PyObject *__pyx_n_s_biny;
static PyObject *__pyx_n_s_bn;
static PyObject *__pyx_n_s_bottleneck;
static PyObject *__pyx_n_s_box;
static PyObject *__pyx_n_s_box_s;
static PyObject *__pyx_n_s_box_size;
static PyObject *__pyx_n_s_boxmed;
static PyObject *__pyx_n_s_boxstd;
static PyObject *__pyx_n_s_brute_photometry;
static PyObject *__pyx_n_s_byteorder;
static PyObject *__pyx_n_s_bytes;
static PyObject *__pyx_n_s_c;
static PyObject *__pyx_n_s_c_err;
static PyObject *__pyx_n_s_central_value;
static PyObject *__pyx_n_s_central_x;
static PyObject *__pyx_n_s_check_cosmic_rays_neighbourhood;
static PyObject *__pyx_kp_s_chi_square;
static PyObject *__pyx_n_s_chisq;
static PyObject *__pyx_n_s_cleaned_distrib;
static PyObject *__pyx_n_s_cm1_max;
static PyObject *__pyx_n_s_cm1_min;
static PyObject *__pyx_n_s_coaxis;
static PyObject *__pyx_n_s_coeff;
static PyObject *__pyx_n_s_color_mapper;
static PyObject *__pyx_n_s_color_values;
static PyObject *__pyx_n_s_combine_mode;
static PyObject *__pyx_n_s_complexflag;
static PyObject *__pyx_n_s_complexflagw;
static PyObject *__pyx_n_s_complexflagx;
static PyObject *__pyx_n_s_complexresult;
static PyObject *__pyx_n_s_computed_pixels;
static PyObject *__pyx_n_s_concatenate;
static PyObject *__pyx_n_s_constants;
static PyObject *__pyx_n_s_convolve;
static PyObject *__pyx_n_s_coords;
static PyObject *__pyx_n_s_copy;
static PyObject *__pyx_n_s_corr;
static PyObject *__pyx_n_s_cov_angle;
static PyObject *__pyx_n_s_cov_diag;
static PyObject *__pyx_n_s_cov_dx;
static PyObject *__pyx_n_s_cov_dy;
static PyObject *__pyx_n_s_cov_err;
static PyObject *__pyx_n_s_cov_free_p_nb;
static PyObject *__pyx_n_s_cov_fwhm;
static PyObject *__pyx_n_s_cov_height;
static PyObject *__pyx_n_s_cov_matrix;
static PyObject *__pyx_n_s_cov_p;
static PyObject *__pyx_n_s_cov_p_mask;
static PyObject *__pyx_n_s_cov_pos;
static PyObject *__pyx_n_s_cov_zx;
static PyObject *__pyx_n_s_cov_zy;
static PyObject *__pyx_n_s_cr_list_len;
static PyObject *__pyx_n_s_cr_map;
static PyObject *__pyx_n_s_create_transform_maps;
static PyObject *__pyx_n_s_crs_list;
static PyObject *__pyx_n_s_cutoff;
static PyObject *__pyx_kp_s_cutoff_must_be_between_0_and_1;
static PyObject *__pyx_n_s_d;
static PyObject *__pyx_n_s_d_err;
static PyObject *__pyx_n_s_da;
static PyObject *__pyx_n_s_data;
static PyObject *__pyx_n_s_db;
static PyObject *__pyx_n_s_dcl;
static PyObject *__pyx_n_s_ddeg;
static PyObject *__pyx_n_s_deg;
static PyObject *__pyx_kp_s_deg_must_be_0;
static PyObject *__pyx_n_s_detect_coeff;
static PyObject *__pyx_n_s_detect_cosmic_rays;
static PyObject *__pyx_n_s_dft;
static PyObject *__pyx_n_s_diff;
static PyObject *__pyx_n_s_dimx;
static PyObject *__pyx_n_s_dimy;
static PyObject *__pyx_n_s_dimz;
static PyObject *__pyx_n_s_distrib;
static PyObject *__pyx_n_s_dr;
static PyObject *__pyx_n_s_dr_err;
static PyObject *__pyx_n_s_dsub_div;
static PyObject *__pyx_n_s_dtype;
static PyObject *__pyx_n_s_dx;
static PyObject *__pyx_n_s_dx_err;
static PyObject *__pyx_n_s_dx_guess;
static PyObject *__pyx_n_s_dx_guess_arg;
static PyObject *__pyx_n_s_dy;
static PyObject *__pyx_n_s_dy_err;
static PyObject *__pyx_n_s_dy_guess;
static PyObject *__pyx_n_s_dy_guess_arg;
static PyObject *__pyx_n_s_e;
static PyObject *__pyx_n_s_empty;
static PyObject *__pyx_n_s_empty_like;
static PyObject *__pyx_n_s_enable_rotation;
static PyObject *__pyx_n_s_enable_zoom;
static PyObject *__pyx_n_s_end;
static PyObject *__pyx_n_s_energy_sum;
static PyObject *__pyx_n_s_estimate_local_noise;
static PyObject *__pyx_n_s_exp;
static PyObject *__pyx_n_s_f;
static PyObject *__pyx_n_s_fast_gaussian_kernel;
static PyObject *__pyx_n_s_fast_pix2w;
static PyObject *__pyx_n_s_fast_w2pix;
static PyObject *__pyx_n_s_fft;
static PyObject *__pyx_n_s_fft_filter;
static PyObject *__pyx_n_s_file;
static PyObject *__pyx_n_s_fill;
static PyObject *__pyx_n_s_filter_background;
static PyObject *__pyx_n_s_filters;
static PyObject *__pyx_n_s_fimag;
static PyObject *__pyx_n_s_final_im;
static PyObject *__pyx_n_s_fit;
static PyObject *__pyx_n_s_fit_tol;
static PyObject *__pyx_n_s_fix_fwhm;
static PyObject *__pyx_n_s_fix_height;
static PyObject *__pyx_n_s_fix_pos;
static PyObject *__pyx_n_s_fixed_p;
static PyObject *__pyx_n_s_flag;
static PyObject *__pyx_n_s_flagw;
static PyObject *__pyx_n_s_flagx;
static PyObject *__pyx_n_s_flatten;
static PyObject *__pyx_n_s_float64;
static PyObject *__pyx_n_s_fn;
static PyObject *__pyx_n_s_frame;
static PyObject *__pyx_n_s_frame_mask;
static PyObject *__pyx_n_s_frame_min;
static PyObject *__pyx_n_s_frames;
static PyObject *__pyx_n_s_framesdiff;
static PyObject *__pyx_n_s_freal;
static PyObject *__pyx_n_s_free_p;
static PyObject *__pyx_n_s_full_output;
static PyObject *__pyx_n_s_fvec;
static PyObject *__pyx_n_s_fwhm;
static PyObject *__pyx_n_s_fwhm_guess;
static PyObject *__pyx_n_s_fwhm_pix;
static PyObject *__pyx_n_s_gaussian1d;
static PyObject *__pyx_n_s_gaussian_array2d;
static PyObject *__pyx_n_s_gaussian_kernel;
static PyObject *__pyx_n_s_get_box_coords;
static PyObject *__pyx_n_s_get_cm1_axis_max;
static PyObject *__pyx_n_s_get_cm1_axis_min;
static PyObject *__pyx_n_s_get_cm1_axis_step;
static PyObject *__pyx_n_s_get_nm_axis_max;
static PyObject *__pyx_n_s_get_nm_axis_min;
static PyObject *__pyx_n_s_get_nm_axis_step;
static PyObject *__pyx_n_s_gradient;
static PyObject *__pyx_n_s_h;
static PyObject *__pyx_n_s_height_guess;
static PyObject *__pyx_n_s_hstack;
static PyObject *__pyx_n_s_hsz;
static PyObject *__pyx_n_s_hwindow;
static PyObject *__pyx_n_s_i;
static PyObject *__pyx_n_s_icol;
static PyObject *__pyx_n_s_icr;
static PyObject *__pyx_n_s_icut;
static PyObject *__pyx_n_s_ideg;
static PyObject *__pyx_n_s_ifft;
static PyObject *__pyx_n_s_ii;
static PyObject *__pyx_n_s_ij;
static PyObject *__pyx_n_s_ik;
static PyObject *__pyx_n_s_iline;
static PyObject *__pyx_n_s_im;
static PyObject *__pyx_n_s_im2rgba;
static PyObject *__pyx_n_s_im_coords;
static PyObject *__pyx_n_s_imag;
static PyObject *__pyx_n_s_imax;
static PyObject *__pyx_n_s_imin;
static PyObject *__pyx_n_s_import;
static PyObject *__pyx_n_s_inan;
static PyObject *__pyx_n_s_index;
static PyObject *__pyx_n_s_index_list;
static PyObject *__pyx_n_s_indft;
static PyObject *__pyx_n_s_inewcr;
static PyObject *__pyx_n_s_inside;
static PyObject *__pyx_n_s_int64;
static PyObject *__pyx_n_s_int8;
static PyObject *__pyx_n_s_int_posx;
static PyObject *__pyx_n_s_int_posy;
static PyObject *__pyx_n_s_interf;
static PyObject *__pyx_n_s_interf_mean_energy;
static PyObject *__pyx_n_s_ip;
static PyObject *__pyx_n_s_ir;
static PyObject *__pyx_n_s_iscomplexobj;
static PyObject *__pyx_n_s_isinf;
static PyObject *__pyx_n_s_isnan;
static PyObject *__pyx_n_s_istar;
static PyObject *__pyx_n_s_isub;
static PyObject *__pyx_n_s_ix;
static PyObject *__pyx_n_s_iy;
static PyObject *__pyx_n_s_j;
static PyObject *__pyx_n_s_jsub;
static PyObject *__pyx_n_s_k;
static PyObject *__pyx_n_s_kernel;
static PyObject *__pyx_n_s_kernel_mod;
static PyObject *__pyx_n_s_large_kernel;
static PyObject *__pyx_n_s_large_sz;
static PyObject *__pyx_n_s_last_arr8;
static PyObject *__pyx_n_s_last_diff;
static PyObject *__pyx_n_s_leastsq;
static PyObject *__pyx_n_s_line;
static PyObject *__pyx_n_s_linspace;
static PyObject *__pyx_n_s_logical_and;
static PyObject *__pyx_n_s_low_pass_image_filter;
static PyObject *__pyx_n_s_lowpass;
static PyObject *__pyx_n_s_m;
static PyObject *__pyx_n_s_main;
static PyObject *__pyx_n_s_map_me;
static PyObject *__pyx_n_s_mask2d;
static PyObject *__pyx_n_s_master_combine;
static PyObject *__pyx_n_s_max;
static PyObject *__pyx_n_s_max2d;
static PyObject *__pyx_n_s_max_mask;
static PyObject *__pyx_n_s_maxfev;
static PyObject *__pyx_n_s_maxs;
static PyObject *__pyx_n_s_maxx;
static PyObject *__pyx_n_s_me;
static PyObject *__pyx_n_s_mean2d;
static PyObject *__pyx_n_s_mean_box;
static PyObject *__pyx_n_s_meansigcut2d;
static PyObject *__pyx_n_s_med;
static PyObject *__pyx_n_s_median;
static PyObject *__pyx_n_s_median2d;
static PyObject *__pyx_n_s_median_a;
static PyObject *__pyx_n_s_median_back;
static PyObject *__pyx_n_s_mgrid;
static PyObject *__pyx_n_s_min;
static PyObject *__pyx_n_s_min_mask;
static PyObject *__pyx_n_s_min_values;
static PyObject *__pyx_n_s_minx;
static PyObject *__pyx_n_s_mode;
static PyObject *__pyx_n_s_model_diff;
static PyObject *__pyx_n_s_moffat_array2d;
static PyObject *__pyx_n_s_mpl_colorbar;
static PyObject *__pyx_n_s_multi_fit_stars;
static PyObject *__pyx_n_s_multi_fit_stars_locals_diff;
static PyObject *__pyx_n_s_multi_fit_stars_locals_model_dif;
static PyObject *__pyx_n_s_multi_fit_stars_locals_params_ar;
static PyObject *__pyx_n_s_multi_fit_stars_locals_params_ve;
static PyObject *__pyx_n_s_multi_fit_stars_locals_sigma;
static PyObject *__pyx_n_s_n;
static PyObject *__pyx_n_s_nan;
static PyObject *__pyx_n_s_nanargmax;
static PyObject *__pyx_n_s_nanbin_image;
static PyObject *__pyx_n_s_nanmax;
static PyObject *__pyx_n_s_nanmean;
static PyObject *__pyx_n_s_nanmedian;
static PyObject *__pyx_n_s_nanmin;
static PyObject *__pyx_n_s_nans;
static PyObject *__pyx_n_s_nanstd;
static PyObject *__pyx_n_s_nansum;
static PyObject *__pyx_n_s_nb;
static PyObject *__pyx_kp_u_ndarray_is_not_C_contiguous;
static PyObject *__pyx_kp_u_ndarray_is_not_Fortran_contiguou;
static PyObject *__pyx_n_s_ndimage;
static PyObject *__pyx_n_s_nearest;
static PyObject *__pyx_n_s_new_nans;
static PyObject *__pyx_n_s_new_pos;
static PyObject *__pyx_n_s_new_rejects2d;
static PyObject *__pyx_n_s_new_stars_err;
static PyObject *__pyx_n_s_new_stars_p;
static PyObject *__pyx_n_s_new_sz;
static PyObject *__pyx_n_s_new_x;
static PyObject *__pyx_n_s_newbyteorder;
static PyObject *__pyx_n_s_nkeep;
static PyObject *__pyx_n_s_noise;
static PyObject *__pyx_n_s_noise_guess;
static PyObject *__pyx_n_s_nonzero;
static PyObject *__pyx_n_s_normalize;
static PyObject *__pyx_n_s_np;
static PyObject *__pyx_n_s_numpy;
static PyObject *__pyx_n_s_nx;
static PyObject *__pyx_n_s_ny;
static PyObject *__pyx_n_s_nzi;
static PyObject *__pyx_n_s_nzj;
static PyObject *__pyx_n_s_ones;
static PyObject *__pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil;
static PyObject *__pyx_n_s_optimize;
static PyObject *__pyx_n_s_orb_cutils;
static PyObject *__pyx_n_s_order;
static PyObject *__pyx_n_s_out;
static PyObject *__pyx_n_s_outx;
static PyObject *__pyx_n_s_outy;
static PyObject *__pyx_n_s_p1x;
static PyObject *__pyx_n_s_p1y;
static PyObject *__pyx_n_s_p2x;
static PyObject *__pyx_n_s_p2y;
static PyObject *__pyx_n_s_params;
static PyObject *__pyx_n_s_params_arrays2vect;
static PyObject *__pyx_n_s_params_vect2arrays;
static PyObject *__pyx_n_s_part_value;
static PyObject *__pyx_n_s_partition;
static PyObject *__pyx_n_s_pix;
static PyObject *__pyx_n_s_pix_coords;
static PyObject *__pyx_n_s_pix_to_compute;
static PyObject *__pyx_n_s_plx;
static PyObject *__pyx_n_s_ply;
static PyObject *__pyx_n_s_point_inside_polygon;
static PyObject *__pyx_n_s_poly;
static PyObject *__pyx_n_s_pos;
static PyObject *__pyx_n_s_pos_mask;
static PyObject *__pyx_n_s_print;
static PyObject *__pyx_n_s_q11;
static PyObject *__pyx_n_s_q12;
static PyObject *__pyx_n_s_q21;
static PyObject *__pyx_n_s_q22;
static PyObject *__pyx_n_s_r;
static PyObject *__pyx_n_s_radians;
static PyObject *__pyx_n_s_range;
static PyObject *__pyx_n_s_rcx;
static PyObject *__pyx_n_s_rcy;
static PyObject *__pyx_n_s_real;
static PyObject *__pyx_n_s_real_nans;
static PyObject *__pyx_n_s_red_chisq;
static PyObject *__pyx_kp_s_reduced_chi_square;
static PyObject *__pyx_n_s_reject_mode;
static PyObject *__pyx_n_s_rejects2d;
static PyObject *__pyx_n_s_rejpix;
static PyObject *__pyx_n_s_res;
static PyObject *__pyx_n_s_reshape;
static PyObject *__pyx_n_s_result;
static PyObject *__pyx_n_s_return_err;
static PyObject *__pyx_n_s_return_index_list;
static PyObject *__pyx_n_s_return_std_frame;
static PyObject *__pyx_n_s_returned_data;
static PyObject *__pyx_n_s_rmax;
static PyObject *__pyx_n_s_rmin;
static PyObject *__pyx_n_s_robust_average;
static PyObject *__pyx_n_s_robust_format;
static PyObject *__pyx_n_s_robust_mean;
static PyObject *__pyx_n_s_robust_median;
static PyObject *__pyx_n_s_robust_std;
static PyObject *__pyx_n_s_robust_sum;
static PyObject *__pyx_n_s_ron;
static PyObject *__pyx_n_s_saturation;
static PyObject *__pyx_n_s_scipy;
static PyObject *__pyx_n_s_scipy_interpolate;
static PyObject *__pyx_n_s_scipy_ndimage_filters;
static PyObject *__pyx_n_s_scipy_optimize;
static PyObject *__pyx_n_s_scipy_special;
static PyObject *__pyx_n_s_shape;
static PyObject *__pyx_n_s_sigma;
static PyObject *__pyx_n_s_sigmaclip;
static PyObject *__pyx_n_s_sigmacut;
static PyObject *__pyx_n_s_sign;
static PyObject *__pyx_n_s_sinc;
static PyObject *__pyx_n_s_sinc1d;
static PyObject *__pyx_n_s_sip;
static PyObject *__pyx_n_s_sip_A;
static PyObject *__pyx_n_s_sip_B;
static PyObject *__pyx_n_s_sip_im2pix;
static PyObject *__pyx_n_s_sip_pix2im;
static PyObject *__pyx_n_s_size;
static PyObject *__pyx_n_s_sky_pixels;
static PyObject *__pyx_n_s_sort;
static PyObject *__pyx_n_s_spectrum;
static PyObject *__pyx_n_s_spectrum_mean_energy;
static PyObject *__pyx_n_s_sqrt;
static PyObject *__pyx_n_s_sqrtmean2d;
static PyObject *__pyx_n_s_star;
static PyObject *__pyx_n_s_star_list;
static PyObject *__pyx_n_s_star_nb;
static PyObject *__pyx_n_s_stars_err;
static PyObject *__pyx_n_s_stars_free_p_nb;
static PyObject *__pyx_n_s_stars_p;
static PyObject *__pyx_n_s_stars_p_mask;
static PyObject *__pyx_kp_s_stars_params;
static PyObject *__pyx_kp_s_stars_params_err;
static PyObject *__pyx_n_s_std;
static PyObject *__pyx_n_s_std2d;
static PyObject *__pyx_n_s_std_x;
static PyObject *__pyx_n_s_step;
static PyObject *__pyx_n_s_still_rejection;
static PyObject *__pyx_n_s_stop_rejection;
static PyObject *__pyx_n_s_sub_dimx;
static PyObject *__pyx_n_s_sub_dimy;
static PyObject *__pyx_n_s_sub_div;
static PyObject *__pyx_n_s_sum;
static PyObject *__pyx_n_s_surface_value;
static PyObject *__pyx_n_s_sz;
static PyObject *__pyx_n_s_test;
static PyObject *__pyx_n_s_test_p;
static PyObject *__pyx_n_s_test_x;
static PyObject *__pyx_n_s_test_y;
static PyObject *__pyx_n_s_time;
static PyObject *__pyx_n_s_to_rgba;
static PyObject *__pyx_n_s_tolerance;
static PyObject *__pyx_n_s_total_flux;
static PyObject *__pyx_n_s_transform_A_to_B;
static PyObject *__pyx_n_s_transform_B_to_A;
static PyObject *__pyx_n_s_transpose;
static PyObject *__pyx_n_s_uint16;
static PyObject *__pyx_n_s_uint8;
static PyObject *__pyx_n_s_unbin_image;
static PyObject *__pyx_kp_u_unknown_dtype_code_in_numpy_pxd;
static PyObject *__pyx_n_s_use_central_value;
static PyObject *__pyx_n_s_val;
static PyObject *__pyx_n_s_value;
static PyObject *__pyx_n_s_vmax;
static PyObject *__pyx_n_s_vmin;
static PyObject *__pyx_n_s_w;
static PyObject *__pyx_n_s_wcs_pix2world;
static PyObject *__pyx_n_s_wcs_world2pix;
static PyObject *__pyx_n_s_width;
static PyObject *__pyx_kp_s_width_must_be_between_0_and_1;
static PyObject *__pyx_n_s_window;
static PyObject *__pyx_n_s_wlen;
static PyObject *__pyx_n_s_workframe;
static PyObject *__pyx_n_s_wsize;
static PyObject *__pyx_n_s_x;
static PyObject *__pyx_n_s_x1;
static PyObject *__pyx_n_s_x1_err;
static PyObject *__pyx_n_s_x1_orig;
static PyObject *__pyx_n_s_x1d;
static PyObject *__pyx_n_s_x2;
static PyObject *__pyx_n_s_x2_err;
static PyObject *__pyx_n_s_x2d;
static PyObject *__pyx_n_s_x_lim_max;
static PyObject *__pyx_n_s_x_lim_min;
static PyObject *__pyx_n_s_x_max;
static PyObject *__pyx_n_s_x_min;
static PyObject *__pyx_n_s_x_range;
static PyObject *__pyx_n_s_xaxis;
static PyObject *__pyx_n_s_xc;
static PyObject *__pyx_n_s_xcoord;
static PyObject *__pyx_n_s_xinters;
static PyObject *__pyx_n_s_xmax;
static PyObject *__pyx_n_s_xmaxb;
static PyObject *__pyx_n_s_xmin;
static PyObject *__pyx_n_s_xminb;
static PyObject *__pyx_n_s_xrange;
static PyObject *__pyx_n_s_xrc;
static PyObject *__pyx_n_s_xtol;
static PyObject *__pyx_n_s_y;
static PyObject *__pyx_n_s_y1;
static PyObject *__pyx_n_s_y1_err;
static PyObject *__pyx_n_s_y1_orig;
static PyObject *__pyx_n_s_y1d;
static PyObject *__pyx_n_s_y2;
static PyObject *__pyx_n_s_y2_err;
static PyObject *__pyx_n_s_y2d;
static PyObject *__pyx_n_s_y_lim_max;
static PyObject *__pyx_n_s_y_lim_min;
static PyObject *__pyx_n_s_y_max;
static PyObject *__pyx_n_s_y_min;
static PyObject *__pyx_n_s_y_range;
static PyObject *__pyx_n_s_yaxis;
static PyObject *__pyx_n_s_yc;
static PyObject *__pyx_n_s_ycoord;
static PyObject *__pyx_n_s_ymax;
static PyObject *__pyx_n_s_ymaxb;
static PyObject *__pyx_n_s_ymin;
static PyObject *__pyx_n_s_yminb;
static PyObject *__pyx_n_s_yrc;
static PyObject *__pyx_n_s_zeros;
static PyObject *__pyx_n_s_zeros_like;
static PyObject *__pyx_n_s_zx;
static PyObject *__pyx_n_s_zx_err;
static PyObject *__pyx_n_s_zy;
static PyObject *__pyx_n_s_zy_err;
static PyObject *__pyx_pf_3orb_6cutils_radians(CYTHON_UNUSED PyObject *__pyx_self, double __pyx_v_deg); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_2transform_B_to_A(CYTHON_UNUSED PyObject *__pyx_self, double __pyx_v_x1, double __pyx_v_y1, double __pyx_v_dx, double __pyx_v_dy, double __pyx_v_dr, double __pyx_v_da, double __pyx_v_db, double __pyx_v_xrc, double __pyx_v_yrc, double __pyx_v_zx, double __pyx_v_zy); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_4transform_A_to_B(CYTHON_UNUSED PyObject *__pyx_self, double __pyx_v_x1, double __pyx_v_y1, double __pyx_v_dx, double __pyx_v_dy, double __pyx_v_dr, double __pyx_v_da, double __pyx_v_db, double __pyx_v_xrc, double __pyx_v_yrc, double __pyx_v_zx, double __pyx_v_zy, double __pyx_v_x1_err, double __pyx_v_y1_err, double __pyx_v_dx_err, double __pyx_v_dy_err, double __pyx_v_dr_err, double __pyx_v_zx_err, double __pyx_v_zy_err, PyBoolObject *__pyx_v_return_err); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_6sip_im2pix(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_im_coords, PyObject *__pyx_v_sip, PyObject *__pyx_v_tolerance); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_8sip_pix2im(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_pix_coords, PyObject *__pyx_v_sip); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_10create_transform_maps(CYTHON_UNUSED PyObject *__pyx_self, int __pyx_v_nx, int __pyx_v_ny, double __pyx_v_dx, double __pyx_v_dy, double __pyx_v_dr, double __pyx_v_da, double __pyx_v_db, double __pyx_v_xrc, double __pyx_v_yrc, double __pyx_v_zx, double __pyx_v_zy, PyObject *__pyx_v_sip_A, PyObject *__pyx_v_sip_B); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_12gaussian_array2d(CYTHON_UNUSED PyObject *__pyx_self, double __pyx_v_h, double __pyx_v_a, double __pyx_v_dx, double __pyx_v_dy, double __pyx_v_fwhm, int __pyx_v_nx, int __pyx_v_ny); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_14moffat_array2d(CYTHON_UNUSED PyObject *__pyx_self, double __pyx_v_h, double __pyx_v_a, double __pyx_v_dx, double __pyx_v_dy, double __pyx_v_fwhm, double __pyx_v_beta, int __pyx_v_nx, int __pyx_v_ny); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_16surface_value(CYTHON_UNUSED PyObject *__pyx_self, int __pyx_v_dimx, int __pyx_v_dimy, double __pyx_v_xc, double __pyx_v_yc, double __pyx_v_rmin, double __pyx_v_rmax, long __pyx_v_sub_div); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_18sigmacut(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_x, double __pyx_v_central_value, int __pyx_v_use_central_value, double __pyx_v_sigma, int __pyx_v_min_values, PyObject *__pyx_v_return_index_list); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_20meansigcut2d(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_x, double __pyx_v_sigma, int __pyx_v_min_values, int __pyx_v_axis); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_22sigmaclip(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_x, double __pyx_v_sigma, int __pyx_v_min_values); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_24master_combine(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_frames, double __pyx_v_sigma, int __pyx_v_nkeep, int __pyx_v_combine_mode, int __pyx_v_reject_mode, PyObject *__pyx_v_return_std_frame); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_26_robust_format(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_x); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_28robust_mean(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_x); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_30robust_median(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_x); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_32robust_sum(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_x); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_34robust_std(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_x); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_36robust_average(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_x, PyArrayObject *__pyx_v_w); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_38gaussian1d(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_x, double __pyx_v_h, double __pyx_v_a, double __pyx_v_dx, double __pyx_v_fwhm); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_40sinc1d(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_x, double __pyx_v_h, double __pyx_v_a, double __pyx_v_dx, double __pyx_v_fwhm); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_42interf_mean_energy(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_interf); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_44spectrum_mean_energy(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_spectrum); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_46fft_filter(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_a, double __pyx_v_cutoff, double __pyx_v_width, PyBoolObject *__pyx_v_lowpass); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_48low_pass_image_filter(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_im, int __pyx_v_deg); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_50fast_gaussian_kernel(CYTHON_UNUSED PyObject *__pyx_self, int __pyx_v_deg); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_52gaussian_kernel(CYTHON_UNUSED PyObject *__pyx_self, double __pyx_v_deg); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_54get_box_coords(CYTHON_UNUSED PyObject *__pyx_self, int __pyx_v_ix, int __pyx_v_iy, int __pyx_v_box_size, int __pyx_v_x_lim_min, int __pyx_v_x_lim_max, int __pyx_v_y_lim_min, int __pyx_v_y_lim_max); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_56point_inside_polygon(CYTHON_UNUSED PyObject *__pyx_self, double __pyx_v_x, double __pyx_v_y, PyObject *__pyx_v_poly); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_15multi_fit_stars_params_arrays2vect(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_stars_p, PyArrayObject *__pyx_v_stars_p_mask, PyArrayObject *__pyx_v_cov_p, PyArrayObject *__pyx_v_cov_p_mask); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_15multi_fit_stars_2params_vect2arrays(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_free_p, PyArrayObject *__pyx_v_fixed_p, PyArrayObject *__pyx_v_stars_p_mask, PyArrayObject *__pyx_v_cov_p_mask, int __pyx_v_star_nb); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_15multi_fit_stars_4sigma(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_data, double __pyx_v_noise, double __pyx_v_dcl); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_15multi_fit_stars_6model_diff(CYTHON_UNUSED PyObject *__pyx_self, int __pyx_v_dimx, int __pyx_v_dimy, PyArrayObject *__pyx_v_params, int __pyx_v_box_size, PyArrayObject *__pyx_v_frame, CYTHON_UNUSED PyArrayObject *__pyx_v_noise, CYTHON_UNUSED double __pyx_v_dcl, double __pyx_v_saturation, PyObject *__pyx_v_transpose, PyObject *__pyx_v_normalize); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_15multi_fit_stars_8diff(PyObject *__pyx_self, PyArrayObject *__pyx_v_free_p, PyArrayObject *__pyx_v_fixed_p, PyArrayObject *__pyx_v_stars_p_mask, PyArrayObject *__pyx_v_cov_p_mask, PyArrayObject *__pyx_v_frame, int __pyx_v_box_size, int __pyx_v_star_nb, PyArrayObject *__pyx_v_noise, double __pyx_v_dcl, double __pyx_v_saturation, PyObject *__pyx_v_sip); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_58multi_fit_stars(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_frame, PyArrayObject *__pyx_v_pos, int __pyx_v_box_size, double __pyx_v_height_guess, PyArrayObject *__pyx_v_fwhm_guess, PyBoolObject *__pyx_v_cov_height, PyBoolObject *__pyx_v_cov_pos, PyBoolObject *__pyx_v_cov_fwhm, PyBoolObject *__pyx_v_fix_height, PyBoolObject *__pyx_v_fix_pos, PyBoolObject *__pyx_v_fix_fwhm, double __pyx_v_fit_tol, double __pyx_v_ron, double __pyx_v_dcl, PyBoolObject *__pyx_v_enable_zoom, PyBoolObject *__pyx_v_enable_rotation, PyBoolObject *__pyx_v_estimate_local_noise, double __pyx_v_saturation, PyObject *__pyx_v_sip); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_60part_value(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_distrib, double __pyx_v_coeff); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_62indft(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_a, PyArrayObject *__pyx_v_x); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_64dft(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_a, PyArrayObject *__pyx_v_x); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_66map_me(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_frame); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_68nanbin_image(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_im, int __pyx_v_binning); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_70unbin_image(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_im, int __pyx_v_nx, int __pyx_v_ny); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_72im2rgba(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_im, PyObject *__pyx_v_mpl_colorbar, double __pyx_v_vmin, double __pyx_v_vmax, int __pyx_v_xmin, int __pyx_v_xmax, int __pyx_v_ymin, int __pyx_v_ymax, PyArrayObject *__pyx_v_computed_pixels, PyObject *__pyx_v_last_arr8, int __pyx_v_res); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_74brute_photometry(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_im, PyArrayObject *__pyx_v_star_list, PyArrayObject *__pyx_v_kernel, int __pyx_v_box_size); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_76detect_cosmic_rays(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_frame, PyObject *__pyx_v_crs_list, int __pyx_v_box_size, double __pyx_v_detect_coeff); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_78check_cosmic_rays_neighbourhood(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_frame, PyArrayObject *__pyx_v_cr_map, int __pyx_v_box_size, double __pyx_v_detect_coeff); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_80fast_w2pix(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_w, double __pyx_v_axis_min, double __pyx_v_axis_step); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_82fast_pix2w(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_pix, double __pyx_v_axis_min, double __pyx_v_axis_step); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_84get_cm1_axis_min(CYTHON_UNUSED PyObject *__pyx_self, int __pyx_v_n, double __pyx_v_step, int __pyx_v_order, double __pyx_v_corr); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_86get_cm1_axis_max(CYTHON_UNUSED PyObject *__pyx_self, int __pyx_v_n, double __pyx_v_step, int __pyx_v_order, double __pyx_v_corr); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_88get_cm1_axis_step(CYTHON_UNUSED PyObject *__pyx_self, int __pyx_v_n, double __pyx_v_step, double __pyx_v_corr); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_90get_nm_axis_min(CYTHON_UNUSED PyObject *__pyx_self, int __pyx_v_n, double __pyx_v_step, int __pyx_v_order, double __pyx_v_corr); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_92get_nm_axis_max(CYTHON_UNUSED PyObject *__pyx_self, int __pyx_v_n, double __pyx_v_step, int __pyx_v_order, double __pyx_v_corr); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_94get_nm_axis_step(CYTHON_UNUSED PyObject *__pyx_self, int __pyx_v_n, double __pyx_v_step, int __pyx_v_order, double __pyx_v_corr); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_96filter_background(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_frame, int __pyx_v_box_size, int __pyx_v_big_box_coeff); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_98mean2d(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_box); /* proto */
static PyObject *__pyx_pf_3orb_6cutils_100median2d(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_box); /* proto */
static int __pyx_pf_5numpy_7ndarray___getbuffer__(PyArrayObject *__pyx_v_self, Py_buffer *__pyx_v_info, int __pyx_v_flags); /* proto */
static void __pyx_pf_5numpy_7ndarray_2__releasebuffer__(PyArrayObject *__pyx_v_self, Py_buffer *__pyx_v_info); /* proto */
static PyObject *__pyx_tp_new_3orb_6cutils___pyx_scope_struct__multi_fit_stars(PyTypeObject *t, PyObject *a, PyObject *k); /*proto*/
static PyObject *__pyx_float_0_;
static PyObject *__pyx_float_1_;
static PyObject *__pyx_float_2_;
static PyObject *__pyx_float_1e7;
static PyObject *__pyx_float_1eneg_8;
static PyObject *__pyx_int_0;
static PyObject *__pyx_int_1;
static PyObject *__pyx_int_2;
static PyObject *__pyx_int_3;
static PyObject *__pyx_int_4;
static PyObject *__pyx_int_5;
static PyObject *__pyx_int_6;
static PyObject *__pyx_int_7;
static PyObject *__pyx_int_255;
static PyObject *__pyx_int_500;
static PyObject *__pyx_int_neg_1;
static PyObject *__pyx_int_neg_3;
static PyArrayObject *__pyx_k__56;
static double __pyx_k__57;
static double __pyx_k__58;
static double __pyx_k__59;
static PyObject *__pyx_slice_;
static PyObject *__pyx_slice__3;
static PyObject *__pyx_slice__5;
static PyObject *__pyx_slice__7;
static PyObject *__pyx_slice__9;
static PyObject *__pyx_tuple__2;
static PyObject *__pyx_tuple__4;
static PyObject *__pyx_tuple__6;
static PyObject *__pyx_tuple__8;
static PyObject *__pyx_slice__11;
static PyObject *__pyx_slice__13;
static PyObject *__pyx_slice__15;
static PyObject *__pyx_slice__17;
static PyObject *__pyx_slice__19;
static PyObject *__pyx_slice__21;
static PyObject *__pyx_slice__23;
static PyObject *__pyx_slice__25;
static PyObject *__pyx_slice__26;
static PyObject *__pyx_slice__27;
static PyObject *__pyx_slice__28;
static PyObject *__pyx_slice__30;
static PyObject *__pyx_slice__31;
static PyObject *__pyx_slice__32;
static PyObject *__pyx_slice__34;
static PyObject *__pyx_slice__35;
static PyObject *__pyx_slice__36;
static PyObject *__pyx_slice__38;
static PyObject *__pyx_slice__39;
static PyObject *__pyx_slice__40;
static PyObject *__pyx_slice__51;
static PyObject *__pyx_slice__52;
static PyObject *__pyx_slice__60;
static PyObject *__pyx_slice__61;
static PyObject *__pyx_slice__62;
static PyObject *__pyx_slice__63;
static PyObject *__pyx_slice__64;
static PyObject *__pyx_slice__65;
static PyObject *__pyx_slice__66;
static PyObject *__pyx_slice__67;
static PyObject *__pyx_slice__68;
static PyObject *__pyx_slice__70;
static PyObject *__pyx_slice__72;
static PyObject *__pyx_slice__74;
static PyObject *__pyx_slice__75;
static PyObject *__pyx_slice__77;
static PyObject *__pyx_slice__78;
static PyObject *__pyx_slice__92;
static PyObject *__pyx_slice__94;
static PyObject *__pyx_slice__95;
static PyObject *__pyx_slice__97;
static PyObject *__pyx_slice__99;
static PyObject *__pyx_tuple__10;
static PyObject *__pyx_tuple__12;
static PyObject *__pyx_tuple__14;
static PyObject *__pyx_tuple__16;
static PyObject *__pyx_tuple__18;
static PyObject *__pyx_tuple__20;
static PyObject *__pyx_tuple__22;
static PyObject *__pyx_tuple__24;
static PyObject *__pyx_tuple__29;
static PyObject *__pyx_tuple__33;
static PyObject *__pyx_tuple__37;
static PyObject *__pyx_tuple__41;
static PyObject *__pyx_tuple__42;
static PyObject *__pyx_tuple__43;
static PyObject *__pyx_tuple__44;
static PyObject *__pyx_tuple__46;
static PyObject *__pyx_tuple__47;
static PyObject *__pyx_tuple__48;
static PyObject *__pyx_tuple__49;
static PyObject *__pyx_tuple__50;
static PyObject *__pyx_tuple__53;
static PyObject *__pyx_tuple__54;
static PyObject *__pyx_tuple__55;
static PyObject *__pyx_tuple__69;
static PyObject *__pyx_tuple__71;
static PyObject *__pyx_tuple__73;
static PyObject *__pyx_tuple__76;
static PyObject *__pyx_tuple__79;
static PyObject *__pyx_tuple__80;
static PyObject *__pyx_tuple__82;
static PyObject *__pyx_tuple__84;
static PyObject *__pyx_tuple__86;
static PyObject *__pyx_tuple__88;
static PyObject *__pyx_tuple__89;
static PyObject *__pyx_tuple__91;
static PyObject *__pyx_tuple__93;
static PyObject *__pyx_tuple__96;
static PyObject *__pyx_tuple__98;
static PyObject *__pyx_slice__101;
static PyObject *__pyx_slice__103;
static PyObject *__pyx_slice__104;
static PyObject *__pyx_slice__105;
static PyObject *__pyx_slice__107;
static PyObject *__pyx_slice__109;
static PyObject *__pyx_slice__113;
static PyObject *__pyx_slice__114;
static PyObject *__pyx_slice__115;
static PyObject *__pyx_slice__116;
static PyObject *__pyx_slice__117;
static PyObject *__pyx_slice__119;
static PyObject *__pyx_slice__121;
static PyObject *__pyx_slice__123;
static PyObject *__pyx_slice__124;
static PyObject *__pyx_slice__126;
static PyObject *__pyx_slice__127;
static PyObject *__pyx_slice__130;
static PyObject *__pyx_slice__132;
static PyObject *__pyx_slice__134;
static PyObject *__pyx_slice__135;
static PyObject *__pyx_slice__137;
static PyObject *__pyx_slice__138;
static PyObject *__pyx_slice__140;
static PyObject *__pyx_slice__141;
static PyObject *__pyx_slice__142;
static PyObject *__pyx_tuple__100;
static PyObject *__pyx_tuple__102;
static PyObject *__pyx_tuple__106;
static PyObject *__pyx_tuple__108;
static PyObject *__pyx_tuple__110;
static PyObject *__pyx_tuple__111;
static PyObject *__pyx_tuple__112;
static PyObject *__pyx_tuple__118;
static PyObject *__pyx_tuple__120;
static PyObject *__pyx_tuple__122;
static PyObject *__pyx_tuple__125;
static PyObject *__pyx_tuple__128;
static PyObject *__pyx_tuple__129;
static PyObject *__pyx_tuple__131;
static PyObject *__pyx_tuple__133;
static PyObject *__pyx_tuple__136;
static PyObject *__pyx_tuple__139;
static PyObject *__pyx_tuple__143;
static PyObject *__pyx_tuple__144;
static PyObject *__pyx_tuple__145;
static PyObject *__pyx_tuple__146;
static PyObject *__pyx_tuple__147;
static PyObject *__pyx_tuple__148;
static PyObject *__pyx_tuple__149;
static PyObject *__pyx_tuple__150;
static PyObject *__pyx_tuple__151;
static PyObject *__pyx_tuple__152;
static PyObject *__pyx_tuple__154;
static PyObject *__pyx_tuple__156;
static PyObject *__pyx_tuple__158;
static PyObject *__pyx_tuple__160;
static PyObject *__pyx_tuple__162;
static PyObject *__pyx_tuple__164;
static PyObject *__pyx_tuple__166;
static PyObject *__pyx_tuple__168;
static PyObject *__pyx_tuple__170;
static PyObject *__pyx_tuple__172;
static PyObject *__pyx_tuple__174;
static PyObject *__pyx_tuple__176;
static PyObject *__pyx_tuple__178;
static PyObject *__pyx_tuple__180;
static PyObject *__pyx_tuple__182;
static PyObject *__pyx_tuple__184;
static PyObject *__pyx_tuple__186;
static PyObject *__pyx_tuple__188;
static PyObject *__pyx_tuple__190;
static PyObject *__pyx_tuple__192;
static PyObject *__pyx_tuple__194;
static PyObject *__pyx_tuple__196;
static PyObject *__pyx_tuple__198;
static PyObject *__pyx_tuple__200;
static PyObject *__pyx_tuple__202;
static PyObject *__pyx_tuple__204;
static PyObject *__pyx_tuple__206;
static PyObject *__pyx_tuple__208;
static PyObject *__pyx_tuple__210;
static PyObject *__pyx_tuple__212;
static PyObject *__pyx_tuple__214;
static PyObject *__pyx_tuple__216;
static PyObject *__pyx_tuple__218;
static PyObject *__pyx_tuple__220;
static PyObject *__pyx_tuple__222;
static PyObject *__pyx_tuple__224;
static PyObject *__pyx_tuple__226;
static PyObject *__pyx_tuple__228;
static PyObject *__pyx_tuple__230;
static PyObject *__pyx_tuple__232;
static PyObject *__pyx_tuple__234;
static PyObject *__pyx_tuple__236;
static PyObject *__pyx_tuple__238;
static PyObject *__pyx_tuple__240;
static PyObject *__pyx_tuple__242;
static PyObject *__pyx_tuple__244;
static PyObject *__pyx_tuple__246;
static PyObject *__pyx_tuple__248;
static PyObject *__pyx_tuple__250;
static PyObject *__pyx_tuple__252;
static PyObject *__pyx_codeobj__81;
static PyObject *__pyx_codeobj__83;
static PyObject *__pyx_codeobj__85;
static PyObject *__pyx_codeobj__87;
static PyObject *__pyx_codeobj__90;
static PyObject *__pyx_codeobj__153;
static PyObject *__pyx_codeobj__155;
static PyObject *__pyx_codeobj__157;
static PyObject *__pyx_codeobj__159;
static PyObject *__pyx_codeobj__161;
static PyObject *__pyx_codeobj__163;
static PyObject *__pyx_codeobj__165;
static PyObject *__pyx_codeobj__167;
static PyObject *__pyx_codeobj__169;
static PyObject *__pyx_codeobj__171;
static PyObject *__pyx_codeobj__173;
static PyObject *__pyx_codeobj__175;
static PyObject *__pyx_codeobj__177;
static PyObject *__pyx_codeobj__179;
static PyObject *__pyx_codeobj__181;
static PyObject *__pyx_codeobj__183;
static PyObject *__pyx_codeobj__185;
static PyObject *__pyx_codeobj__187;
static PyObject *__pyx_codeobj__189;
static PyObject *__pyx_codeobj__191;
static PyObject *__pyx_codeobj__193;
static PyObject *__pyx_codeobj__195;
static PyObject *__pyx_codeobj__197;
static PyObject *__pyx_codeobj__199;
static PyObject *__pyx_codeobj__201;
static PyObject *__pyx_codeobj__203;
static PyObject *__pyx_codeobj__205;
static PyObject *__pyx_codeobj__207;
static PyObject *__pyx_codeobj__209;
static PyObject *__pyx_codeobj__211;
static PyObject *__pyx_codeobj__213;
static PyObject *__pyx_codeobj__215;
static PyObject *__pyx_codeobj__217;
static PyObject *__pyx_codeobj__219;
static PyObject *__pyx_codeobj__221;
static PyObject *__pyx_codeobj__223;
static PyObject *__pyx_codeobj__225;
static PyObject *__pyx_codeobj__227;
static PyObject *__pyx_codeobj__229;
static PyObject *__pyx_codeobj__231;
static PyObject *__pyx_codeobj__233;
static PyObject *__pyx_codeobj__235;
static PyObject *__pyx_codeobj__237;
static PyObject *__pyx_codeobj__239;
static PyObject *__pyx_codeobj__241;
static PyObject *__pyx_codeobj__243;
static PyObject *__pyx_codeobj__245;
static PyObject *__pyx_codeobj__247;
static PyObject *__pyx_codeobj__249;
static PyObject *__pyx_codeobj__251;
static PyObject *__pyx_codeobj__253;

/* "orb/cutils.pyx":66
 * ctypedef long double float128_t
 * 
 * def radians(double deg):             # <<<<<<<<<<<<<<
 *     """Convert degrees to radians
 *     """
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_1radians(PyObject *__pyx_self, PyObject *__pyx_arg_deg); /*proto*/
static char __pyx_doc_3orb_6cutils_radians[] = "radians(double deg)\nConvert degrees to radians\n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_1radians = {"radians", (PyCFunction)__pyx_pw_3orb_6cutils_1radians, METH_O, __pyx_doc_3orb_6cutils_radians};
static PyObject *__pyx_pw_3orb_6cutils_1radians(PyObject *__pyx_self, PyObject *__pyx_arg_deg) {
  double __pyx_v_deg;
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("radians (wrapper)", 0);
  assert(__pyx_arg_deg); {
    __pyx_v_deg = __pyx_PyFloat_AsDouble(__pyx_arg_deg); if (unlikely((__pyx_v_deg == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 66, __pyx_L3_error)
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L3_error:;
  __Pyx_AddTraceback("orb.cutils.radians", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __Pyx_RefNannyFinishContext();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  __pyx_r = __pyx_pf_3orb_6cutils_radians(__pyx_self, ((double)__pyx_v_deg));

  /* function exit code */
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_radians(CYTHON_UNUSED PyObject *__pyx_self, double __pyx_v_deg) {
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  PyObject *__pyx_t_1 = NULL;
  __Pyx_RefNannySetupContext("radians", 0);

  /* "orb/cutils.pyx":69
 *     """Convert degrees to radians
 *     """
 *     return deg * M_PI / 180.             # <<<<<<<<<<<<<<
 * 
 * 
 */
  __Pyx_XDECREF(__pyx_r);
  __pyx_t_1 = PyFloat_FromDouble(((__pyx_v_deg * M_PI) / 180.)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 69, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_r = __pyx_t_1;
  __pyx_t_1 = 0;
  goto __pyx_L0;

  /* "orb/cutils.pyx":66
 * ctypedef long double float128_t
 * 
 * def radians(double deg):             # <<<<<<<<<<<<<<
 *     """Convert degrees to radians
 *     """
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_1);
  __Pyx_AddTraceback("orb.cutils.radians", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":72
 * 
 * 
 * def transform_B_to_A(double x1, double y1, double dx, double dy, double dr,             # <<<<<<<<<<<<<<
 *                      double da, double db, double xrc, double yrc, double zx,
 *                      double zy):
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_3transform_B_to_A(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_3orb_6cutils_2transform_B_to_A[] = "transform_B_to_A(double x1, double y1, double dx, double dy, double dr, double da, double db, double xrc, double yrc, double zx, double zy)\nTransform star positions in camera B to the same star position\n       in camera A given the transformation parameters.\n\n    .. warning:: this function is meant to be the inverse of\n      transform_A_to_B. Given the output of transform_A_to_B and the\n      **SAME transformation parameters** the initial positions must be\n      returned by this function within the numerical error. i.e. if\n      (Xb, Yb) = A_to_B(Xi,Yi,p) and (Xa, Ya) = B_to_A(Xb, Yb, p) then\n      Xa - Xi ~ 1e-13 and Ya - Yi ~ 1e-13 (for float64 numbers)\n\n    :param x1: x coordinate to transform\n    :param y1: y coordinate to transform\n    :param dx: translation along x\n    :param dy: translation along y\n    :param dr: rotation in the plane of the image\n    :param da: tip angle\n    :param db: tilt angle\n    :param xrc: x coordinate of the rotation center\n    :param yrc: y coordinate of the rotation center\n    :param zx: zoom coefficient along x\n    :param zy: zoom coefficient along y\n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_3transform_B_to_A = {"transform_B_to_A", (PyCFunction)__pyx_pw_3orb_6cutils_3transform_B_to_A, METH_VARARGS|METH_KEYWORDS, __pyx_doc_3orb_6cutils_2transform_B_to_A};
static PyObject *__pyx_pw_3orb_6cutils_3transform_B_to_A(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  double __pyx_v_x1;
  double __pyx_v_y1;
  double __pyx_v_dx;
  double __pyx_v_dy;
  double __pyx_v_dr;
  double __pyx_v_da;
  double __pyx_v_db;
  double __pyx_v_xrc;
  double __pyx_v_yrc;
  double __pyx_v_zx;
  double __pyx_v_zy;
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("transform_B_to_A (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_x1,&__pyx_n_s_y1,&__pyx_n_s_dx,&__pyx_n_s_dy,&__pyx_n_s_dr,&__pyx_n_s_da,&__pyx_n_s_db,&__pyx_n_s_xrc,&__pyx_n_s_yrc,&__pyx_n_s_zx,&__pyx_n_s_zy,0};
    PyObject* values[11] = {0,0,0,0,0,0,0,0,0,0,0};
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
      switch (pos_args) {
        case 11: values[10] = PyTuple_GET_ITEM(__pyx_args, 10);
        case 10: values[9] = PyTuple_GET_ITEM(__pyx_args, 9);
        case  9: values[8] = PyTuple_GET_ITEM(__pyx_args, 8);
        case  8: values[7] = PyTuple_GET_ITEM(__pyx_args, 7);
        case  7: values[6] = PyTuple_GET_ITEM(__pyx_args, 6);
        case  6: values[5] = PyTuple_GET_ITEM(__pyx_args, 5);
        case  5: values[4] = PyTuple_GET_ITEM(__pyx_args, 4);
        case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = PyDict_Size(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_x1)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        case  1:
        if (likely((values[1] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_y1)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("transform_B_to_A", 1, 11, 11, 1); __PYX_ERR(0, 72, __pyx_L3_error)
        }
        case  2:
        if (likely((values[2] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_dx)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("transform_B_to_A", 1, 11, 11, 2); __PYX_ERR(0, 72, __pyx_L3_error)
        }
        case  3:
        if (likely((values[3] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_dy)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("transform_B_to_A", 1, 11, 11, 3); __PYX_ERR(0, 72, __pyx_L3_error)
        }
        case  4:
        if (likely((values[4] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_dr)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("transform_B_to_A", 1, 11, 11, 4); __PYX_ERR(0, 72, __pyx_L3_error)
        }
        case  5:
        if (likely((values[5] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_da)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("transform_B_to_A", 1, 11, 11, 5); __PYX_ERR(0, 72, __pyx_L3_error)
        }
        case  6:
        if (likely((values[6] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_db)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("transform_B_to_A", 1, 11, 11, 6); __PYX_ERR(0, 72, __pyx_L3_error)
        }
        case  7:
        if (likely((values[7] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_xrc)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("transform_B_to_A", 1, 11, 11, 7); __PYX_ERR(0, 72, __pyx_L3_error)
        }
        case  8:
        if (likely((values[8] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_yrc)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("transform_B_to_A", 1, 11, 11, 8); __PYX_ERR(0, 72, __pyx_L3_error)
        }
        case  9:
        if (likely((values[9] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_zx)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("transform_B_to_A", 1, 11, 11, 9); __PYX_ERR(0, 72, __pyx_L3_error)
        }
        case 10:
        if (likely((values[10] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_zy)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("transform_B_to_A", 1, 11, 11, 10); __PYX_ERR(0, 72, __pyx_L3_error)
        }
      }
      if (unlikely(kw_args > 0)) {
        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "transform_B_to_A") < 0)) __PYX_ERR(0, 72, __pyx_L3_error)
      }
    } else if (PyTuple_GET_SIZE(__pyx_args) != 11) {
      goto __pyx_L5_argtuple_error;
    } else {
      values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
      values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
      values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
      values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
      values[4] = PyTuple_GET_ITEM(__pyx_args, 4);
      values[5] = PyTuple_GET_ITEM(__pyx_args, 5);
      values[6] = PyTuple_GET_ITEM(__pyx_args, 6);
      values[7] = PyTuple_GET_ITEM(__pyx_args, 7);
      values[8] = PyTuple_GET_ITEM(__pyx_args, 8);
      values[9] = PyTuple_GET_ITEM(__pyx_args, 9);
      values[10] = PyTuple_GET_ITEM(__pyx_args, 10);
    }
    __pyx_v_x1 = __pyx_PyFloat_AsDouble(values[0]); if (unlikely((__pyx_v_x1 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 72, __pyx_L3_error)
    __pyx_v_y1 = __pyx_PyFloat_AsDouble(values[1]); if (unlikely((__pyx_v_y1 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 72, __pyx_L3_error)
    __pyx_v_dx = __pyx_PyFloat_AsDouble(values[2]); if (unlikely((__pyx_v_dx == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 72, __pyx_L3_error)
    __pyx_v_dy = __pyx_PyFloat_AsDouble(values[3]); if (unlikely((__pyx_v_dy == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 72, __pyx_L3_error)
    __pyx_v_dr = __pyx_PyFloat_AsDouble(values[4]); if (unlikely((__pyx_v_dr == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 72, __pyx_L3_error)
    __pyx_v_da = __pyx_PyFloat_AsDouble(values[5]); if (unlikely((__pyx_v_da == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 73, __pyx_L3_error)
    __pyx_v_db = __pyx_PyFloat_AsDouble(values[6]); if (unlikely((__pyx_v_db == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 73, __pyx_L3_error)
    __pyx_v_xrc = __pyx_PyFloat_AsDouble(values[7]); if (unlikely((__pyx_v_xrc == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 73, __pyx_L3_error)
    __pyx_v_yrc = __pyx_PyFloat_AsDouble(values[8]); if (unlikely((__pyx_v_yrc == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 73, __pyx_L3_error)
    __pyx_v_zx = __pyx_PyFloat_AsDouble(values[9]); if (unlikely((__pyx_v_zx == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 73, __pyx_L3_error)
    __pyx_v_zy = __pyx_PyFloat_AsDouble(values[10]); if (unlikely((__pyx_v_zy == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 74, __pyx_L3_error)
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  __Pyx_RaiseArgtupleInvalid("transform_B_to_A", 1, 11, 11, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 72, __pyx_L3_error)
  __pyx_L3_error:;
  __Pyx_AddTraceback("orb.cutils.transform_B_to_A", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __Pyx_RefNannyFinishContext();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  __pyx_r = __pyx_pf_3orb_6cutils_2transform_B_to_A(__pyx_self, __pyx_v_x1, __pyx_v_y1, __pyx_v_dx, __pyx_v_dy, __pyx_v_dr, __pyx_v_da, __pyx_v_db, __pyx_v_xrc, __pyx_v_yrc, __pyx_v_zx, __pyx_v_zy);

  /* function exit code */
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_2transform_B_to_A(CYTHON_UNUSED PyObject *__pyx_self, double __pyx_v_x1, double __pyx_v_y1, double __pyx_v_dx, double __pyx_v_dy, double __pyx_v_dr, double __pyx_v_da, double __pyx_v_db, double __pyx_v_xrc, double __pyx_v_yrc, double __pyx_v_zx, double __pyx_v_zy) {
  CYTHON_UNUSED double __pyx_v_x1_orig;
  CYTHON_UNUSED double __pyx_v_y1_orig;
  CYTHON_UNUSED double __pyx_v_x2_err;
  CYTHON_UNUSED double __pyx_v_y2_err;
  double __pyx_v_x2;
  double __pyx_v_y2;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  PyObject *__pyx_t_1 = NULL;
  PyObject *__pyx_t_2 = NULL;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  PyObject *__pyx_t_5 = NULL;
  double __pyx_t_6;
  __Pyx_RefNannySetupContext("transform_B_to_A", 0);

  /* "orb/cutils.pyx":97
 *     :param zy: zoom coefficient along y
 *     """
 *     cdef double x1_orig = x1             # <<<<<<<<<<<<<<
 *     cdef double y1_orig = y1
 *     cdef double x2_err = 0.
 */
  __pyx_v_x1_orig = __pyx_v_x1;

  /* "orb/cutils.pyx":98
 *     """
 *     cdef double x1_orig = x1
 *     cdef double y1_orig = y1             # <<<<<<<<<<<<<<
 *     cdef double x2_err = 0.
 *     cdef double y2_err = 0.
 */
  __pyx_v_y1_orig = __pyx_v_y1;

  /* "orb/cutils.pyx":99
 *     cdef double x1_orig = x1
 *     cdef double y1_orig = y1
 *     cdef double x2_err = 0.             # <<<<<<<<<<<<<<
 *     cdef double y2_err = 0.
 *     cdef double a, b, c, d, a_err, b_err, c_err, d_err
 */
  __pyx_v_x2_err = 0.;

  /* "orb/cutils.pyx":100
 *     cdef double y1_orig = y1
 *     cdef double x2_err = 0.
 *     cdef double y2_err = 0.             # <<<<<<<<<<<<<<
 *     cdef double a, b, c, d, a_err, b_err, c_err, d_err
 *     cdef double x2 = 0.
 */
  __pyx_v_y2_err = 0.;

  /* "orb/cutils.pyx":102
 *     cdef double y2_err = 0.
 *     cdef double a, b, c, d, a_err, b_err, c_err, d_err
 *     cdef double x2 = 0.             # <<<<<<<<<<<<<<
 *     cdef double y2 = 0.
 * 
 */
  __pyx_v_x2 = 0.;

  /* "orb/cutils.pyx":103
 *     cdef double a, b, c, d, a_err, b_err, c_err, d_err
 *     cdef double x2 = 0.
 *     cdef double y2 = 0.             # <<<<<<<<<<<<<<
 * 
 *     dr = radians(dr)
 */
  __pyx_v_y2 = 0.;

  /* "orb/cutils.pyx":105
 *     cdef double y2 = 0.
 * 
 *     dr = radians(dr)             # <<<<<<<<<<<<<<
 *     da = radians(da)
 *     db = radians(db)
 */
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_radians); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 105, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_3 = PyFloat_FromDouble(__pyx_v_dr); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 105, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_4 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_2))) {
    __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_2);
    if (likely(__pyx_t_4)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
      __Pyx_INCREF(__pyx_t_4);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_2, function);
    }
  }
  if (!__pyx_t_4) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_2, __pyx_t_3); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 105, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_5 = PyTuple_New(1+1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 105, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_4); __pyx_t_4 = NULL;
    __Pyx_GIVEREF(__pyx_t_3);
    PyTuple_SET_ITEM(__pyx_t_5, 0+1, __pyx_t_3);
    __pyx_t_3 = 0;
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_5, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 105, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  }
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_6 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_6 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 105, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_v_dr = __pyx_t_6;

  /* "orb/cutils.pyx":106
 * 
 *     dr = radians(dr)
 *     da = radians(da)             # <<<<<<<<<<<<<<
 *     db = radians(db)
 * 
 */
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_radians); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 106, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_5 = PyFloat_FromDouble(__pyx_v_da); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 106, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_3 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_2))) {
    __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_2);
    if (likely(__pyx_t_3)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
      __Pyx_INCREF(__pyx_t_3);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_2, function);
    }
  }
  if (!__pyx_t_3) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_2, __pyx_t_5); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 106, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_4 = PyTuple_New(1+1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 106, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_3); __pyx_t_3 = NULL;
    __Pyx_GIVEREF(__pyx_t_5);
    PyTuple_SET_ITEM(__pyx_t_4, 0+1, __pyx_t_5);
    __pyx_t_5 = 0;
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_4, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 106, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  }
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_6 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_6 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 106, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_v_da = __pyx_t_6;

  /* "orb/cutils.pyx":107
 *     dr = radians(dr)
 *     da = radians(da)
 *     db = radians(db)             # <<<<<<<<<<<<<<
 * 
 *     # rotation
 */
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_radians); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 107, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_4 = PyFloat_FromDouble(__pyx_v_db); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 107, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_5 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_2))) {
    __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_2);
    if (likely(__pyx_t_5)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
      __Pyx_INCREF(__pyx_t_5);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_2, function);
    }
  }
  if (!__pyx_t_5) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_2, __pyx_t_4); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 107, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_3 = PyTuple_New(1+1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 107, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_5); __pyx_t_5 = NULL;
    __Pyx_GIVEREF(__pyx_t_4);
    PyTuple_SET_ITEM(__pyx_t_3, 0+1, __pyx_t_4);
    __pyx_t_4 = 0;
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_3, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 107, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  }
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_6 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_6 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 107, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_v_db = __pyx_t_6;

  /* "orb/cutils.pyx":110
 * 
 *     # rotation
 *     x2 = (x1 - xrc) * cos(dr) - (y1 - yrc) * sin(dr) + xrc             # <<<<<<<<<<<<<<
 *     y2 = (y1 - yrc) * cos(dr) + (x1 - xrc) * sin(dr) + yrc
 * 
 */
  __pyx_v_x2 = ((((__pyx_v_x1 - __pyx_v_xrc) * cos(__pyx_v_dr)) - ((__pyx_v_y1 - __pyx_v_yrc) * sin(__pyx_v_dr))) + __pyx_v_xrc);

  /* "orb/cutils.pyx":111
 *     # rotation
 *     x2 = (x1 - xrc) * cos(dr) - (y1 - yrc) * sin(dr) + xrc
 *     y2 = (y1 - yrc) * cos(dr) + (x1 - xrc) * sin(dr) + yrc             # <<<<<<<<<<<<<<
 * 
 *     # da, db, zx, zy
 */
  __pyx_v_y2 = ((((__pyx_v_y1 - __pyx_v_yrc) * cos(__pyx_v_dr)) + ((__pyx_v_x1 - __pyx_v_xrc) * sin(__pyx_v_dr))) + __pyx_v_yrc);

  /* "orb/cutils.pyx":114
 * 
 *     # da, db, zx, zy
 *     x2 = x2 + dx             # <<<<<<<<<<<<<<
 *     y2 = y2 + dy
 * 
 */
  __pyx_v_x2 = (__pyx_v_x2 + __pyx_v_dx);

  /* "orb/cutils.pyx":115
 *     # da, db, zx, zy
 *     x2 = x2 + dx
 *     y2 = y2 + dy             # <<<<<<<<<<<<<<
 * 
 *     x2 = x2 * cos(da) * zx
 */
  __pyx_v_y2 = (__pyx_v_y2 + __pyx_v_dy);

  /* "orb/cutils.pyx":117
 *     y2 = y2 + dy
 * 
 *     x2 = x2 * cos(da) * zx             # <<<<<<<<<<<<<<
 *     y2 = y2 * cos(db) * zy
 * 
 */
  __pyx_v_x2 = ((__pyx_v_x2 * cos(__pyx_v_da)) * __pyx_v_zx);

  /* "orb/cutils.pyx":118
 * 
 *     x2 = x2 * cos(da) * zx
 *     y2 = y2 * cos(db) * zy             # <<<<<<<<<<<<<<
 * 
 *     return x2, y2
 */
  __pyx_v_y2 = ((__pyx_v_y2 * cos(__pyx_v_db)) * __pyx_v_zy);

  /* "orb/cutils.pyx":120
 *     y2 = y2 * cos(db) * zy
 * 
 *     return x2, y2             # <<<<<<<<<<<<<<
 * 
 * def transform_A_to_B(double x1, double y1, double dx, double dy, double dr,
 */
  __Pyx_XDECREF(__pyx_r);
  __pyx_t_1 = PyFloat_FromDouble(__pyx_v_x2); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 120, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_2 = PyFloat_FromDouble(__pyx_v_y2); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 120, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_3 = PyTuple_New(2); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 120, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_GIVEREF(__pyx_t_1);
  PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_1);
  __Pyx_GIVEREF(__pyx_t_2);
  PyTuple_SET_ITEM(__pyx_t_3, 1, __pyx_t_2);
  __pyx_t_1 = 0;
  __pyx_t_2 = 0;
  __pyx_r = __pyx_t_3;
  __pyx_t_3 = 0;
  goto __pyx_L0;

  /* "orb/cutils.pyx":72
 * 
 * 
 * def transform_B_to_A(double x1, double y1, double dx, double dy, double dr,             # <<<<<<<<<<<<<<
 *                      double da, double db, double xrc, double yrc, double zx,
 *                      double zy):
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_1);
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_XDECREF(__pyx_t_5);
  __Pyx_AddTraceback("orb.cutils.transform_B_to_A", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":122
 *     return x2, y2
 * 
 * def transform_A_to_B(double x1, double y1, double dx, double dy, double dr,             # <<<<<<<<<<<<<<
 *                      double da, double db, double xrc, double yrc, double zx,
 *                      double zy,
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_5transform_A_to_B(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_3orb_6cutils_4transform_A_to_B[] = "transform_A_to_B(double x1, double y1, double dx, double dy, double dr, double da, double db, double xrc, double yrc, double zx, double zy, double x1_err=0.0, double y1_err=0.0, double dx_err=0.0, double dy_err=0.0, double dr_err=0.0, double zx_err=0.0, double zy_err=0.0, bool return_err=False)\nTransform star positions in camera A to the same star position\n    in camera B given the transformation parameters\n\n    :param x1: x coordinate to transform\n    :param y1: y coordinate to transform\n    :param dx: translation along x\n    :param dy: translation along y\n    :param dr: rotation in the plane of the image\n    :param da: tip angle\n    :param db: tilt angle\n    :param xrc: x coordinate of the rotation center\n    :param yrc: y coordinate of the rotation center\n    :param zx: zoom coefficient along x\n    :param zy: zoom coefficient along y\n    :param x1_err: (Optional) Error on x1 estimate (default 0.)\n    :param y1_err: (Optional) Error on y1 estimate (default 0.)\n    :param dx_err: (Optional) Error on dx estimate (default 0.)\n    :param dy_err: (Optional) Error on dy estimate (default 0.)\n    :param dr_err: (Optional) Error on dr estimate (default 0.)\n    :param zx_err: (Optional) Error on zx estimate (default 0.)\n    :param zy_err: (Optional) Error on zy estimate (default 0.)  \n    :param return_err: (Optional) If True, the error on the estimate\n      of x2 and y2 is returned.\n\n    :return: (x2, y2) = f(x1, y1). (x2, y2, x2_err, y2_err) if\n      return_err is True.\n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_5transform_A_to_B = {"transform_A_to_B", (PyCFunction)__pyx_pw_3orb_6cutils_5transform_A_to_B, METH_VARARGS|METH_KEYWORDS, __pyx_doc_3orb_6cutils_4transform_A_to_B};
static PyObject *__pyx_pw_3orb_6cutils_5transform_A_to_B(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  double __pyx_v_x1;
  double __pyx_v_y1;
  double __pyx_v_dx;
  double __pyx_v_dy;
  double __pyx_v_dr;
  double __pyx_v_da;
  double __pyx_v_db;
  double __pyx_v_xrc;
  double __pyx_v_yrc;
  double __pyx_v_zx;
  double __pyx_v_zy;
  double __pyx_v_x1_err;
  double __pyx_v_y1_err;
  double __pyx_v_dx_err;
  double __pyx_v_dy_err;
  double __pyx_v_dr_err;
  double __pyx_v_zx_err;
  double __pyx_v_zy_err;
  PyBoolObject *__pyx_v_return_err = 0;
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("transform_A_to_B (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_x1,&__pyx_n_s_y1,&__pyx_n_s_dx,&__pyx_n_s_dy,&__pyx_n_s_dr,&__pyx_n_s_da,&__pyx_n_s_db,&__pyx_n_s_xrc,&__pyx_n_s_yrc,&__pyx_n_s_zx,&__pyx_n_s_zy,&__pyx_n_s_x1_err,&__pyx_n_s_y1_err,&__pyx_n_s_dx_err,&__pyx_n_s_dy_err,&__pyx_n_s_dr_err,&__pyx_n_s_zx_err,&__pyx_n_s_zy_err,&__pyx_n_s_return_err,0};
    PyObject* values[19] = {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};

    /* "orb/cutils.pyx":132
 *                      double zx_err=0.,
 *                      double zy_err=0.,
 *                      bool return_err=False):             # <<<<<<<<<<<<<<
 *     """Transform star positions in camera A to the same star position
 *     in camera B given the transformation parameters
 */
    values[18] = (PyObject *)((PyBoolObject *)Py_False);
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
      switch (pos_args) {
        case 19: values[18] = PyTuple_GET_ITEM(__pyx_args, 18);
        case 18: values[17] = PyTuple_GET_ITEM(__pyx_args, 17);
        case 17: values[16] = PyTuple_GET_ITEM(__pyx_args, 16);
        case 16: values[15] = PyTuple_GET_ITEM(__pyx_args, 15);
        case 15: values[14] = PyTuple_GET_ITEM(__pyx_args, 14);
        case 14: values[13] = PyTuple_GET_ITEM(__pyx_args, 13);
        case 13: values[12] = PyTuple_GET_ITEM(__pyx_args, 12);
        case 12: values[11] = PyTuple_GET_ITEM(__pyx_args, 11);
        case 11: values[10] = PyTuple_GET_ITEM(__pyx_args, 10);
        case 10: values[9] = PyTuple_GET_ITEM(__pyx_args, 9);
        case  9: values[8] = PyTuple_GET_ITEM(__pyx_args, 8);
        case  8: values[7] = PyTuple_GET_ITEM(__pyx_args, 7);
        case  7: values[6] = PyTuple_GET_ITEM(__pyx_args, 6);
        case  6: values[5] = PyTuple_GET_ITEM(__pyx_args, 5);
        case  5: values[4] = PyTuple_GET_ITEM(__pyx_args, 4);
        case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = PyDict_Size(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_x1)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        case  1:
        if (likely((values[1] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_y1)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("transform_A_to_B", 0, 11, 19, 1); __PYX_ERR(0, 122, __pyx_L3_error)
        }
        case  2:
        if (likely((values[2] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_dx)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("transform_A_to_B", 0, 11, 19, 2); __PYX_ERR(0, 122, __pyx_L3_error)
        }
        case  3:
        if (likely((values[3] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_dy)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("transform_A_to_B", 0, 11, 19, 3); __PYX_ERR(0, 122, __pyx_L3_error)
        }
        case  4:
        if (likely((values[4] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_dr)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("transform_A_to_B", 0, 11, 19, 4); __PYX_ERR(0, 122, __pyx_L3_error)
        }
        case  5:
        if (likely((values[5] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_da)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("transform_A_to_B", 0, 11, 19, 5); __PYX_ERR(0, 122, __pyx_L3_error)
        }
        case  6:
        if (likely((values[6] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_db)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("transform_A_to_B", 0, 11, 19, 6); __PYX_ERR(0, 122, __pyx_L3_error)
        }
        case  7:
        if (likely((values[7] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_xrc)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("transform_A_to_B", 0, 11, 19, 7); __PYX_ERR(0, 122, __pyx_L3_error)
        }
        case  8:
        if (likely((values[8] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_yrc)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("transform_A_to_B", 0, 11, 19, 8); __PYX_ERR(0, 122, __pyx_L3_error)
        }
        case  9:
        if (likely((values[9] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_zx)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("transform_A_to_B", 0, 11, 19, 9); __PYX_ERR(0, 122, __pyx_L3_error)
        }
        case 10:
        if (likely((values[10] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_zy)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("transform_A_to_B", 0, 11, 19, 10); __PYX_ERR(0, 122, __pyx_L3_error)
        }
        case 11:
        if (kw_args > 0) {
          PyObject* value = PyDict_GetItem(__pyx_kwds, __pyx_n_s_x1_err);
          if (value) { values[11] = value; kw_args--; }
        }
        case 12:
        if (kw_args > 0) {
          PyObject* value = PyDict_GetItem(__pyx_kwds, __pyx_n_s_y1_err);
          if (value) { values[12] = value; kw_args--; }
        }
        case 13:
        if (kw_args > 0) {
          PyObject* value = PyDict_GetItem(__pyx_kwds, __pyx_n_s_dx_err);
          if (value) { values[13] = value; kw_args--; }
        }
        case 14:
        if (kw_args > 0) {
          PyObject* value = PyDict_GetItem(__pyx_kwds, __pyx_n_s_dy_err);
          if (value) { values[14] = value; kw_args--; }
        }
        case 15:
        if (kw_args > 0) {
          PyObject* value = PyDict_GetItem(__pyx_kwds, __pyx_n_s_dr_err);
          if (value) { values[15] = value; kw_args--; }
        }
        case 16:
        if (kw_args > 0) {
          PyObject* value = PyDict_GetItem(__pyx_kwds, __pyx_n_s_zx_err);
          if (value) { values[16] = value; kw_args--; }
        }
        case 17:
        if (kw_args > 0) {
          PyObject* value = PyDict_GetItem(__pyx_kwds, __pyx_n_s_zy_err);
          if (value) { values[17] = value; kw_args--; }
        }
        case 18:
        if (kw_args > 0) {
          PyObject* value = PyDict_GetItem(__pyx_kwds, __pyx_n_s_return_err);
          if (value) { values[18] = value; kw_args--; }
        }
      }
      if (unlikely(kw_args > 0)) {
        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "transform_A_to_B") < 0)) __PYX_ERR(0, 122, __pyx_L3_error)
      }
    } else {
      switch (PyTuple_GET_SIZE(__pyx_args)) {
        case 19: values[18] = PyTuple_GET_ITEM(__pyx_args, 18);
        case 18: values[17] = PyTuple_GET_ITEM(__pyx_args, 17);
        case 17: values[16] = PyTuple_GET_ITEM(__pyx_args, 16);
        case 16: values[15] = PyTuple_GET_ITEM(__pyx_args, 15);
        case 15: values[14] = PyTuple_GET_ITEM(__pyx_args, 14);
        case 14: values[13] = PyTuple_GET_ITEM(__pyx_args, 13);
        case 13: values[12] = PyTuple_GET_ITEM(__pyx_args, 12);
        case 12: values[11] = PyTuple_GET_ITEM(__pyx_args, 11);
        case 11: values[10] = PyTuple_GET_ITEM(__pyx_args, 10);
        values[9] = PyTuple_GET_ITEM(__pyx_args, 9);
        values[8] = PyTuple_GET_ITEM(__pyx_args, 8);
        values[7] = PyTuple_GET_ITEM(__pyx_args, 7);
        values[6] = PyTuple_GET_ITEM(__pyx_args, 6);
        values[5] = PyTuple_GET_ITEM(__pyx_args, 5);
        values[4] = PyTuple_GET_ITEM(__pyx_args, 4);
        values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
        values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        break;
        default: goto __pyx_L5_argtuple_error;
      }
    }
    __pyx_v_x1 = __pyx_PyFloat_AsDouble(values[0]); if (unlikely((__pyx_v_x1 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 122, __pyx_L3_error)
    __pyx_v_y1 = __pyx_PyFloat_AsDouble(values[1]); if (unlikely((__pyx_v_y1 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 122, __pyx_L3_error)
    __pyx_v_dx = __pyx_PyFloat_AsDouble(values[2]); if (unlikely((__pyx_v_dx == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 122, __pyx_L3_error)
    __pyx_v_dy = __pyx_PyFloat_AsDouble(values[3]); if (unlikely((__pyx_v_dy == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 122, __pyx_L3_error)
    __pyx_v_dr = __pyx_PyFloat_AsDouble(values[4]); if (unlikely((__pyx_v_dr == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 122, __pyx_L3_error)
    __pyx_v_da = __pyx_PyFloat_AsDouble(values[5]); if (unlikely((__pyx_v_da == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 123, __pyx_L3_error)
    __pyx_v_db = __pyx_PyFloat_AsDouble(values[6]); if (unlikely((__pyx_v_db == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 123, __pyx_L3_error)
    __pyx_v_xrc = __pyx_PyFloat_AsDouble(values[7]); if (unlikely((__pyx_v_xrc == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 123, __pyx_L3_error)
    __pyx_v_yrc = __pyx_PyFloat_AsDouble(values[8]); if (unlikely((__pyx_v_yrc == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 123, __pyx_L3_error)
    __pyx_v_zx = __pyx_PyFloat_AsDouble(values[9]); if (unlikely((__pyx_v_zx == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 123, __pyx_L3_error)
    __pyx_v_zy = __pyx_PyFloat_AsDouble(values[10]); if (unlikely((__pyx_v_zy == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 124, __pyx_L3_error)
    if (values[11]) {
      __pyx_v_x1_err = __pyx_PyFloat_AsDouble(values[11]); if (unlikely((__pyx_v_x1_err == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 125, __pyx_L3_error)
    } else {
      __pyx_v_x1_err = ((double)0.);
    }
    if (values[12]) {
      __pyx_v_y1_err = __pyx_PyFloat_AsDouble(values[12]); if (unlikely((__pyx_v_y1_err == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 126, __pyx_L3_error)
    } else {
      __pyx_v_y1_err = ((double)0.);
    }
    if (values[13]) {
      __pyx_v_dx_err = __pyx_PyFloat_AsDouble(values[13]); if (unlikely((__pyx_v_dx_err == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 127, __pyx_L3_error)
    } else {
      __pyx_v_dx_err = ((double)0.);
    }
    if (values[14]) {
      __pyx_v_dy_err = __pyx_PyFloat_AsDouble(values[14]); if (unlikely((__pyx_v_dy_err == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 128, __pyx_L3_error)
    } else {
      __pyx_v_dy_err = ((double)0.);
    }
    if (values[15]) {
      __pyx_v_dr_err = __pyx_PyFloat_AsDouble(values[15]); if (unlikely((__pyx_v_dr_err == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 129, __pyx_L3_error)
    } else {
      __pyx_v_dr_err = ((double)0.);
    }
    if (values[16]) {
      __pyx_v_zx_err = __pyx_PyFloat_AsDouble(values[16]); if (unlikely((__pyx_v_zx_err == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 130, __pyx_L3_error)
    } else {
      __pyx_v_zx_err = ((double)0.);
    }
    if (values[17]) {
      __pyx_v_zy_err = __pyx_PyFloat_AsDouble(values[17]); if (unlikely((__pyx_v_zy_err == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 131, __pyx_L3_error)
    } else {
      __pyx_v_zy_err = ((double)0.);
    }
    __pyx_v_return_err = ((PyBoolObject *)values[18]);
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  __Pyx_RaiseArgtupleInvalid("transform_A_to_B", 0, 11, 19, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 122, __pyx_L3_error)
  __pyx_L3_error:;
  __Pyx_AddTraceback("orb.cutils.transform_A_to_B", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __Pyx_RefNannyFinishContext();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_return_err), __pyx_ptype_7cpython_4bool_bool, 1, "return_err", 0))) __PYX_ERR(0, 132, __pyx_L1_error)
  __pyx_r = __pyx_pf_3orb_6cutils_4transform_A_to_B(__pyx_self, __pyx_v_x1, __pyx_v_y1, __pyx_v_dx, __pyx_v_dy, __pyx_v_dr, __pyx_v_da, __pyx_v_db, __pyx_v_xrc, __pyx_v_yrc, __pyx_v_zx, __pyx_v_zy, __pyx_v_x1_err, __pyx_v_y1_err, __pyx_v_dx_err, __pyx_v_dy_err, __pyx_v_dr_err, __pyx_v_zx_err, __pyx_v_zy_err, __pyx_v_return_err);

  /* "orb/cutils.pyx":122
 *     return x2, y2
 * 
 * def transform_A_to_B(double x1, double y1, double dx, double dy, double dr,             # <<<<<<<<<<<<<<
 *                      double da, double db, double xrc, double yrc, double zx,
 *                      double zy,
 */

  /* function exit code */
  goto __pyx_L0;
  __pyx_L1_error:;
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_4transform_A_to_B(CYTHON_UNUSED PyObject *__pyx_self, double __pyx_v_x1, double __pyx_v_y1, double __pyx_v_dx, double __pyx_v_dy, double __pyx_v_dr, double __pyx_v_da, double __pyx_v_db, double __pyx_v_xrc, double __pyx_v_yrc, double __pyx_v_zx, double __pyx_v_zy, double __pyx_v_x1_err, double __pyx_v_y1_err, double __pyx_v_dx_err, double __pyx_v_dy_err, double __pyx_v_dr_err, double __pyx_v_zx_err, double __pyx_v_zy_err, PyBoolObject *__pyx_v_return_err) {
  double __pyx_v_x1_orig;
  double __pyx_v_y1_orig;
  double __pyx_v_x2_err;
  double __pyx_v_y2_err;
  double __pyx_v_a;
  double __pyx_v_b;
  double __pyx_v_c;
  double __pyx_v_d;
  double __pyx_v_a_err;
  double __pyx_v_b_err;
  double __pyx_v_c_err;
  double __pyx_v_d_err;
  double __pyx_v_x2;
  double __pyx_v_y2;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  PyObject *__pyx_t_1 = NULL;
  PyObject *__pyx_t_2 = NULL;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  PyObject *__pyx_t_5 = NULL;
  double __pyx_t_6;
  double __pyx_t_7;
  int __pyx_t_8;
  __Pyx_RefNannySetupContext("transform_A_to_B", 0);

  /* "orb/cutils.pyx":160
 *       return_err is True.
 *     """
 *     cdef double x1_orig = x1             # <<<<<<<<<<<<<<
 *     cdef double y1_orig = y1
 *     cdef double x2_err = 0.
 */
  __pyx_v_x1_orig = __pyx_v_x1;

  /* "orb/cutils.pyx":161
 *     """
 *     cdef double x1_orig = x1
 *     cdef double y1_orig = y1             # <<<<<<<<<<<<<<
 *     cdef double x2_err = 0.
 *     cdef double y2_err = 0.
 */
  __pyx_v_y1_orig = __pyx_v_y1;

  /* "orb/cutils.pyx":162
 *     cdef double x1_orig = x1
 *     cdef double y1_orig = y1
 *     cdef double x2_err = 0.             # <<<<<<<<<<<<<<
 *     cdef double y2_err = 0.
 *     cdef double a, b, c, d, a_err, b_err, c_err, d_err
 */
  __pyx_v_x2_err = 0.;

  /* "orb/cutils.pyx":163
 *     cdef double y1_orig = y1
 *     cdef double x2_err = 0.
 *     cdef double y2_err = 0.             # <<<<<<<<<<<<<<
 *     cdef double a, b, c, d, a_err, b_err, c_err, d_err
 *     cdef double x2 = 0.
 */
  __pyx_v_y2_err = 0.;

  /* "orb/cutils.pyx":165
 *     cdef double y2_err = 0.
 *     cdef double a, b, c, d, a_err, b_err, c_err, d_err
 *     cdef double x2 = 0.             # <<<<<<<<<<<<<<
 *     cdef double y2 = 0.
 * 
 */
  __pyx_v_x2 = 0.;

  /* "orb/cutils.pyx":166
 *     cdef double a, b, c, d, a_err, b_err, c_err, d_err
 *     cdef double x2 = 0.
 *     cdef double y2 = 0.             # <<<<<<<<<<<<<<
 * 
 *     dr = radians(dr)
 */
  __pyx_v_y2 = 0.;

  /* "orb/cutils.pyx":168
 *     cdef double y2 = 0.
 * 
 *     dr = radians(dr)             # <<<<<<<<<<<<<<
 *     da = radians(da)
 *     db = radians(db)
 */
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_radians); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 168, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_3 = PyFloat_FromDouble(__pyx_v_dr); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 168, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_4 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_2))) {
    __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_2);
    if (likely(__pyx_t_4)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
      __Pyx_INCREF(__pyx_t_4);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_2, function);
    }
  }
  if (!__pyx_t_4) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_2, __pyx_t_3); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 168, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_5 = PyTuple_New(1+1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 168, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_4); __pyx_t_4 = NULL;
    __Pyx_GIVEREF(__pyx_t_3);
    PyTuple_SET_ITEM(__pyx_t_5, 0+1, __pyx_t_3);
    __pyx_t_3 = 0;
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_5, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 168, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  }
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_6 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_6 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 168, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_v_dr = __pyx_t_6;

  /* "orb/cutils.pyx":169
 * 
 *     dr = radians(dr)
 *     da = radians(da)             # <<<<<<<<<<<<<<
 *     db = radians(db)
 * 
 */
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_radians); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 169, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_5 = PyFloat_FromDouble(__pyx_v_da); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 169, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_3 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_2))) {
    __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_2);
    if (likely(__pyx_t_3)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
      __Pyx_INCREF(__pyx_t_3);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_2, function);
    }
  }
  if (!__pyx_t_3) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_2, __pyx_t_5); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 169, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_4 = PyTuple_New(1+1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 169, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_3); __pyx_t_3 = NULL;
    __Pyx_GIVEREF(__pyx_t_5);
    PyTuple_SET_ITEM(__pyx_t_4, 0+1, __pyx_t_5);
    __pyx_t_5 = 0;
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_4, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 169, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  }
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_6 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_6 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 169, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_v_da = __pyx_t_6;

  /* "orb/cutils.pyx":170
 *     dr = radians(dr)
 *     da = radians(da)
 *     db = radians(db)             # <<<<<<<<<<<<<<
 * 
 *     # da, db, zx, zy
 */
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_radians); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 170, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_4 = PyFloat_FromDouble(__pyx_v_db); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 170, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_5 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_2))) {
    __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_2);
    if (likely(__pyx_t_5)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
      __Pyx_INCREF(__pyx_t_5);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_2, function);
    }
  }
  if (!__pyx_t_5) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_2, __pyx_t_4); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 170, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_3 = PyTuple_New(1+1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 170, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_5); __pyx_t_5 = NULL;
    __Pyx_GIVEREF(__pyx_t_4);
    PyTuple_SET_ITEM(__pyx_t_3, 0+1, __pyx_t_4);
    __pyx_t_4 = 0;
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_3, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 170, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  }
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_6 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_6 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 170, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_v_db = __pyx_t_6;

  /* "orb/cutils.pyx":173
 * 
 *     # da, db, zx, zy
 *     x1 = x1 / cos(da) / zx             # <<<<<<<<<<<<<<
 *     y1 = y1 / cos(db) / zy
 * 
 */
  __pyx_t_6 = cos(__pyx_v_da);
  if (unlikely(__pyx_t_6 == 0)) {
    PyErr_SetString(PyExc_ZeroDivisionError, "float division");
    __PYX_ERR(0, 173, __pyx_L1_error)
  }
  __pyx_t_7 = (__pyx_v_x1 / __pyx_t_6);
  if (unlikely(__pyx_v_zx == 0)) {
    PyErr_SetString(PyExc_ZeroDivisionError, "float division");
    __PYX_ERR(0, 173, __pyx_L1_error)
  }
  __pyx_v_x1 = (__pyx_t_7 / __pyx_v_zx);

  /* "orb/cutils.pyx":174
 *     # da, db, zx, zy
 *     x1 = x1 / cos(da) / zx
 *     y1 = y1 / cos(db) / zy             # <<<<<<<<<<<<<<
 * 
 * 
 */
  __pyx_t_7 = cos(__pyx_v_db);
  if (unlikely(__pyx_t_7 == 0)) {
    PyErr_SetString(PyExc_ZeroDivisionError, "float division");
    __PYX_ERR(0, 174, __pyx_L1_error)
  }
  __pyx_t_6 = (__pyx_v_y1 / __pyx_t_7);
  if (unlikely(__pyx_v_zy == 0)) {
    PyErr_SetString(PyExc_ZeroDivisionError, "float division");
    __PYX_ERR(0, 174, __pyx_L1_error)
  }
  __pyx_v_y1 = (__pyx_t_6 / __pyx_v_zy);

  /* "orb/cutils.pyx":177
 * 
 * 
 *     if return_err:             # <<<<<<<<<<<<<<
 *         x1_err = x1 * sqrt((zx_err / zx)**2. + (x1_err / x1_orig)**2.)
 *         y1_err = y1 * sqrt((zy_err / zy)**2. + (y1_err / y1_orig)**2.)
 */
  __pyx_t_8 = __Pyx_PyObject_IsTrue(((PyObject *)__pyx_v_return_err)); if (unlikely(__pyx_t_8 < 0)) __PYX_ERR(0, 177, __pyx_L1_error)
  if (__pyx_t_8) {

    /* "orb/cutils.pyx":178
 * 
 *     if return_err:
 *         x1_err = x1 * sqrt((zx_err / zx)**2. + (x1_err / x1_orig)**2.)             # <<<<<<<<<<<<<<
 *         y1_err = y1 * sqrt((zy_err / zy)**2. + (y1_err / y1_orig)**2.)
 * 
 */
    if (unlikely(__pyx_v_zx == 0)) {
      PyErr_SetString(PyExc_ZeroDivisionError, "float division");
      __PYX_ERR(0, 178, __pyx_L1_error)
    }
    if (unlikely(__pyx_v_x1_orig == 0)) {
      PyErr_SetString(PyExc_ZeroDivisionError, "float division");
      __PYX_ERR(0, 178, __pyx_L1_error)
    }
    __pyx_v_x1_err = (__pyx_v_x1 * sqrt((pow((__pyx_v_zx_err / __pyx_v_zx), 2.) + pow((__pyx_v_x1_err / __pyx_v_x1_orig), 2.))));

    /* "orb/cutils.pyx":179
 *     if return_err:
 *         x1_err = x1 * sqrt((zx_err / zx)**2. + (x1_err / x1_orig)**2.)
 *         y1_err = y1 * sqrt((zy_err / zy)**2. + (y1_err / y1_orig)**2.)             # <<<<<<<<<<<<<<
 * 
 *     x1 = x1 - dx
 */
    if (unlikely(__pyx_v_zy == 0)) {
      PyErr_SetString(PyExc_ZeroDivisionError, "float division");
      __PYX_ERR(0, 179, __pyx_L1_error)
    }
    if (unlikely(__pyx_v_y1_orig == 0)) {
      PyErr_SetString(PyExc_ZeroDivisionError, "float division");
      __PYX_ERR(0, 179, __pyx_L1_error)
    }
    __pyx_v_y1_err = (__pyx_v_y1 * sqrt((pow((__pyx_v_zy_err / __pyx_v_zy), 2.) + pow((__pyx_v_y1_err / __pyx_v_y1_orig), 2.))));

    /* "orb/cutils.pyx":177
 * 
 * 
 *     if return_err:             # <<<<<<<<<<<<<<
 *         x1_err = x1 * sqrt((zx_err / zx)**2. + (x1_err / x1_orig)**2.)
 *         y1_err = y1 * sqrt((zy_err / zy)**2. + (y1_err / y1_orig)**2.)
 */
  }

  /* "orb/cutils.pyx":181
 *         y1_err = y1 * sqrt((zy_err / zy)**2. + (y1_err / y1_orig)**2.)
 * 
 *     x1 = x1 - dx             # <<<<<<<<<<<<<<
 *     y1 = y1 - dy
 * 
 */
  __pyx_v_x1 = (__pyx_v_x1 - __pyx_v_dx);

  /* "orb/cutils.pyx":182
 * 
 *     x1 = x1 - dx
 *     y1 = y1 - dy             # <<<<<<<<<<<<<<
 * 
 *     if return_err:
 */
  __pyx_v_y1 = (__pyx_v_y1 - __pyx_v_dy);

  /* "orb/cutils.pyx":184
 *     y1 = y1 - dy
 * 
 *     if return_err:             # <<<<<<<<<<<<<<
 *         x1_err = sqrt(x1_err**2. + dx_err**2.)
 *         y1_err = sqrt(y1_err**2. + dy_err**2.)
 */
  __pyx_t_8 = __Pyx_PyObject_IsTrue(((PyObject *)__pyx_v_return_err)); if (unlikely(__pyx_t_8 < 0)) __PYX_ERR(0, 184, __pyx_L1_error)
  if (__pyx_t_8) {

    /* "orb/cutils.pyx":185
 * 
 *     if return_err:
 *         x1_err = sqrt(x1_err**2. + dx_err**2.)             # <<<<<<<<<<<<<<
 *         y1_err = sqrt(y1_err**2. + dy_err**2.)
 * 
 */
    __pyx_v_x1_err = sqrt((pow(__pyx_v_x1_err, 2.) + pow(__pyx_v_dx_err, 2.)));

    /* "orb/cutils.pyx":186
 *     if return_err:
 *         x1_err = sqrt(x1_err**2. + dx_err**2.)
 *         y1_err = sqrt(y1_err**2. + dy_err**2.)             # <<<<<<<<<<<<<<
 * 
 *     # rotation
 */
    __pyx_v_y1_err = sqrt((pow(__pyx_v_y1_err, 2.) + pow(__pyx_v_dy_err, 2.)));

    /* "orb/cutils.pyx":184
 *     y1 = y1 - dy
 * 
 *     if return_err:             # <<<<<<<<<<<<<<
 *         x1_err = sqrt(x1_err**2. + dx_err**2.)
 *         y1_err = sqrt(y1_err**2. + dy_err**2.)
 */
  }

  /* "orb/cutils.pyx":189
 * 
 *     # rotation
 *     x2 = (x1 - xrc) * cos(-dr) - (y1 - yrc) * sin(-dr) + xrc             # <<<<<<<<<<<<<<
 *     y2 = (y1 - yrc) * cos(-dr) + (x1 - xrc) * sin(-dr) + yrc
 * 
 */
  __pyx_v_x2 = ((((__pyx_v_x1 - __pyx_v_xrc) * cos((-__pyx_v_dr))) - ((__pyx_v_y1 - __pyx_v_yrc) * sin((-__pyx_v_dr)))) + __pyx_v_xrc);

  /* "orb/cutils.pyx":190
 *     # rotation
 *     x2 = (x1 - xrc) * cos(-dr) - (y1 - yrc) * sin(-dr) + xrc
 *     y2 = (y1 - yrc) * cos(-dr) + (x1 - xrc) * sin(-dr) + yrc             # <<<<<<<<<<<<<<
 * 
 *     if return_err:
 */
  __pyx_v_y2 = ((((__pyx_v_y1 - __pyx_v_yrc) * cos((-__pyx_v_dr))) + ((__pyx_v_x1 - __pyx_v_xrc) * sin((-__pyx_v_dr)))) + __pyx_v_yrc);

  /* "orb/cutils.pyx":192
 *     y2 = (y1 - yrc) * cos(-dr) + (x1 - xrc) * sin(-dr) + yrc
 * 
 *     if return_err:             # <<<<<<<<<<<<<<
 *         dr_err = radians(dr_err)
 *         a = (x1 - xrc) ; a_err = x1_err
 */
  __pyx_t_8 = __Pyx_PyObject_IsTrue(((PyObject *)__pyx_v_return_err)); if (unlikely(__pyx_t_8 < 0)) __PYX_ERR(0, 192, __pyx_L1_error)
  if (__pyx_t_8) {

    /* "orb/cutils.pyx":193
 * 
 *     if return_err:
 *         dr_err = radians(dr_err)             # <<<<<<<<<<<<<<
 *         a = (x1 - xrc) ; a_err = x1_err
 *         b = cos(-dr) ; b_err = dr_err * sin(-dr)
 */
    __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_radians); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 193, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __pyx_t_3 = PyFloat_FromDouble(__pyx_v_dr_err); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 193, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __pyx_t_4 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_2))) {
      __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_2);
      if (likely(__pyx_t_4)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
        __Pyx_INCREF(__pyx_t_4);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_2, function);
      }
    }
    if (!__pyx_t_4) {
      __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_2, __pyx_t_3); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 193, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      __Pyx_GOTREF(__pyx_t_1);
    } else {
      __pyx_t_5 = PyTuple_New(1+1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 193, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_4); __pyx_t_4 = NULL;
      __Pyx_GIVEREF(__pyx_t_3);
      PyTuple_SET_ITEM(__pyx_t_5, 0+1, __pyx_t_3);
      __pyx_t_3 = 0;
      __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_5, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 193, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    }
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __pyx_t_6 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_6 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 193, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    __pyx_v_dr_err = __pyx_t_6;

    /* "orb/cutils.pyx":194
 *     if return_err:
 *         dr_err = radians(dr_err)
 *         a = (x1 - xrc) ; a_err = x1_err             # <<<<<<<<<<<<<<
 *         b = cos(-dr) ; b_err = dr_err * sin(-dr)
 *         c = (y1 - yrc) ; c_err = y1_err
 */
    __pyx_v_a = (__pyx_v_x1 - __pyx_v_xrc);
    __pyx_v_a_err = __pyx_v_x1_err;

    /* "orb/cutils.pyx":195
 *         dr_err = radians(dr_err)
 *         a = (x1 - xrc) ; a_err = x1_err
 *         b = cos(-dr) ; b_err = dr_err * sin(-dr)             # <<<<<<<<<<<<<<
 *         c = (y1 - yrc) ; c_err = y1_err
 *         d = sin(-dr) ; d_err = dr_err * cos(-dr)
 */
    __pyx_v_b = cos((-__pyx_v_dr));
    __pyx_v_b_err = (__pyx_v_dr_err * sin((-__pyx_v_dr)));

    /* "orb/cutils.pyx":196
 *         a = (x1 - xrc) ; a_err = x1_err
 *         b = cos(-dr) ; b_err = dr_err * sin(-dr)
 *         c = (y1 - yrc) ; c_err = y1_err             # <<<<<<<<<<<<<<
 *         d = sin(-dr) ; d_err = dr_err * cos(-dr)
 *         x2_err = sqrt((sqrt((a_err*b)**2. + (b_err*a)**2.))**2.
 */
    __pyx_v_c = (__pyx_v_y1 - __pyx_v_yrc);
    __pyx_v_c_err = __pyx_v_y1_err;

    /* "orb/cutils.pyx":197
 *         b = cos(-dr) ; b_err = dr_err * sin(-dr)
 *         c = (y1 - yrc) ; c_err = y1_err
 *         d = sin(-dr) ; d_err = dr_err * cos(-dr)             # <<<<<<<<<<<<<<
 *         x2_err = sqrt((sqrt((a_err*b)**2. + (b_err*a)**2.))**2.
 *                       + (sqrt((c_err*d)**2. + (d_err*c)**2.))**2.)
 */
    __pyx_v_d = sin((-__pyx_v_dr));
    __pyx_v_d_err = (__pyx_v_dr_err * cos((-__pyx_v_dr)));

    /* "orb/cutils.pyx":198
 *         c = (y1 - yrc) ; c_err = y1_err
 *         d = sin(-dr) ; d_err = dr_err * cos(-dr)
 *         x2_err = sqrt((sqrt((a_err*b)**2. + (b_err*a)**2.))**2.             # <<<<<<<<<<<<<<
 *                       + (sqrt((c_err*d)**2. + (d_err*c)**2.))**2.)
 * 
 */
    __pyx_v_x2_err = sqrt((pow(sqrt((pow((__pyx_v_a_err * __pyx_v_b), 2.) + pow((__pyx_v_b_err * __pyx_v_a), 2.))), 2.) + pow(sqrt((pow((__pyx_v_c_err * __pyx_v_d), 2.) + pow((__pyx_v_d_err * __pyx_v_c), 2.))), 2.)));

    /* "orb/cutils.pyx":201
 *                       + (sqrt((c_err*d)**2. + (d_err*c)**2.))**2.)
 * 
 *         a = (y1 - yrc) ; a_err = y1_err             # <<<<<<<<<<<<<<
 *         b = cos(-dr) ; b_err = dr_err * sin(-dr)
 *         c = (x1 - xrc) ; c_err = x1_err
 */
    __pyx_v_a = (__pyx_v_y1 - __pyx_v_yrc);
    __pyx_v_a_err = __pyx_v_y1_err;

    /* "orb/cutils.pyx":202
 * 
 *         a = (y1 - yrc) ; a_err = y1_err
 *         b = cos(-dr) ; b_err = dr_err * sin(-dr)             # <<<<<<<<<<<<<<
 *         c = (x1 - xrc) ; c_err = x1_err
 *         d = sin(-dr) ; d_err = dr_err * cos(-dr)
 */
    __pyx_v_b = cos((-__pyx_v_dr));
    __pyx_v_b_err = (__pyx_v_dr_err * sin((-__pyx_v_dr)));

    /* "orb/cutils.pyx":203
 *         a = (y1 - yrc) ; a_err = y1_err
 *         b = cos(-dr) ; b_err = dr_err * sin(-dr)
 *         c = (x1 - xrc) ; c_err = x1_err             # <<<<<<<<<<<<<<
 *         d = sin(-dr) ; d_err = dr_err * cos(-dr)
 *         y2_err = sqrt((sqrt((a_err*b)**2. + (b_err*a)**2.))**2.
 */
    __pyx_v_c = (__pyx_v_x1 - __pyx_v_xrc);
    __pyx_v_c_err = __pyx_v_x1_err;

    /* "orb/cutils.pyx":204
 *         b = cos(-dr) ; b_err = dr_err * sin(-dr)
 *         c = (x1 - xrc) ; c_err = x1_err
 *         d = sin(-dr) ; d_err = dr_err * cos(-dr)             # <<<<<<<<<<<<<<
 *         y2_err = sqrt((sqrt((a_err*b)**2. + (b_err*a)**2.))**2.
 *                       + (sqrt((c_err*d)**2. + (d_err*c)**2.))**2.)
 */
    __pyx_v_d = sin((-__pyx_v_dr));
    __pyx_v_d_err = (__pyx_v_dr_err * cos((-__pyx_v_dr)));

    /* "orb/cutils.pyx":205
 *         c = (x1 - xrc) ; c_err = x1_err
 *         d = sin(-dr) ; d_err = dr_err * cos(-dr)
 *         y2_err = sqrt((sqrt((a_err*b)**2. + (b_err*a)**2.))**2.             # <<<<<<<<<<<<<<
 *                       + (sqrt((c_err*d)**2. + (d_err*c)**2.))**2.)
 * 
 */
    __pyx_v_y2_err = sqrt((pow(sqrt((pow((__pyx_v_a_err * __pyx_v_b), 2.) + pow((__pyx_v_b_err * __pyx_v_a), 2.))), 2.) + pow(sqrt((pow((__pyx_v_c_err * __pyx_v_d), 2.) + pow((__pyx_v_d_err * __pyx_v_c), 2.))), 2.)));

    /* "orb/cutils.pyx":208
 *                       + (sqrt((c_err*d)**2. + (d_err*c)**2.))**2.)
 * 
 *         return x2, y2, x2_err, y2_err             # <<<<<<<<<<<<<<
 * 
 *     return x2, y2
 */
    __Pyx_XDECREF(__pyx_r);
    __pyx_t_1 = PyFloat_FromDouble(__pyx_v_x2); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 208, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __pyx_t_2 = PyFloat_FromDouble(__pyx_v_y2); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 208, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __pyx_t_5 = PyFloat_FromDouble(__pyx_v_x2_err); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 208, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __pyx_t_3 = PyFloat_FromDouble(__pyx_v_y2_err); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 208, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __pyx_t_4 = PyTuple_New(4); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 208, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_GIVEREF(__pyx_t_1);
    PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_1);
    __Pyx_GIVEREF(__pyx_t_2);
    PyTuple_SET_ITEM(__pyx_t_4, 1, __pyx_t_2);
    __Pyx_GIVEREF(__pyx_t_5);
    PyTuple_SET_ITEM(__pyx_t_4, 2, __pyx_t_5);
    __Pyx_GIVEREF(__pyx_t_3);
    PyTuple_SET_ITEM(__pyx_t_4, 3, __pyx_t_3);
    __pyx_t_1 = 0;
    __pyx_t_2 = 0;
    __pyx_t_5 = 0;
    __pyx_t_3 = 0;
    __pyx_r = __pyx_t_4;
    __pyx_t_4 = 0;
    goto __pyx_L0;

    /* "orb/cutils.pyx":192
 *     y2 = (y1 - yrc) * cos(-dr) + (x1 - xrc) * sin(-dr) + yrc
 * 
 *     if return_err:             # <<<<<<<<<<<<<<
 *         dr_err = radians(dr_err)
 *         a = (x1 - xrc) ; a_err = x1_err
 */
  }

  /* "orb/cutils.pyx":210
 *         return x2, y2, x2_err, y2_err
 * 
 *     return x2, y2             # <<<<<<<<<<<<<<
 * 
 * def sip_im2pix(np.ndarray[np.float64_t, ndim=2] im_coords, sip,
 */
  __Pyx_XDECREF(__pyx_r);
  __pyx_t_4 = PyFloat_FromDouble(__pyx_v_x2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 210, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_3 = PyFloat_FromDouble(__pyx_v_y2); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 210, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_5 = PyTuple_New(2); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 210, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_GIVEREF(__pyx_t_4);
  PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_4);
  __Pyx_GIVEREF(__pyx_t_3);
  PyTuple_SET_ITEM(__pyx_t_5, 1, __pyx_t_3);
  __pyx_t_4 = 0;
  __pyx_t_3 = 0;
  __pyx_r = __pyx_t_5;
  __pyx_t_5 = 0;
  goto __pyx_L0;

  /* "orb/cutils.pyx":122
 *     return x2, y2
 * 
 * def transform_A_to_B(double x1, double y1, double dx, double dy, double dr,             # <<<<<<<<<<<<<<
 *                      double da, double db, double xrc, double yrc, double zx,
 *                      double zy,
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_1);
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_XDECREF(__pyx_t_5);
  __Pyx_AddTraceback("orb.cutils.transform_A_to_B", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":212
 *     return x2, y2
 * 
 * def sip_im2pix(np.ndarray[np.float64_t, ndim=2] im_coords, sip,             # <<<<<<<<<<<<<<
 *                tolerance=1e-8):
 *     """Transform perfect pixel positions to distorded pixels positions
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_7sip_im2pix(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_3orb_6cutils_6sip_im2pix[] = "sip_im2pix(ndarray im_coords, sip, tolerance=1e-08)\nTransform perfect pixel positions to distorded pixels positions \n\n    :param im_coords: perfect pixel positions as an Nx2 array of floats.\n    :param sip: pywcs.WCS() instance containing SIP parameters.\n    :param tolerance: tolerance on the iterative method.\n\n    .. warning:: SIP.foc2pix must be used instead\n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_7sip_im2pix = {"sip_im2pix", (PyCFunction)__pyx_pw_3orb_6cutils_7sip_im2pix, METH_VARARGS|METH_KEYWORDS, __pyx_doc_3orb_6cutils_6sip_im2pix};
static PyObject *__pyx_pw_3orb_6cutils_7sip_im2pix(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  PyArrayObject *__pyx_v_im_coords = 0;
  PyObject *__pyx_v_sip = 0;
  PyObject *__pyx_v_tolerance = 0;
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("sip_im2pix (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_im_coords,&__pyx_n_s_sip,&__pyx_n_s_tolerance,0};
    PyObject* values[3] = {0,0,0};
    values[2] = ((PyObject *)__pyx_float_1eneg_8);
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
      switch (pos_args) {
        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = PyDict_Size(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_im_coords)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        case  1:
        if (likely((values[1] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_sip)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("sip_im2pix", 0, 2, 3, 1); __PYX_ERR(0, 212, __pyx_L3_error)
        }
        case  2:
        if (kw_args > 0) {
          PyObject* value = PyDict_GetItem(__pyx_kwds, __pyx_n_s_tolerance);
          if (value) { values[2] = value; kw_args--; }
        }
      }
      if (unlikely(kw_args > 0)) {
        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "sip_im2pix") < 0)) __PYX_ERR(0, 212, __pyx_L3_error)
      }
    } else {
      switch (PyTuple_GET_SIZE(__pyx_args)) {
        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        break;
        default: goto __pyx_L5_argtuple_error;
      }
    }
    __pyx_v_im_coords = ((PyArrayObject *)values[0]);
    __pyx_v_sip = values[1];
    __pyx_v_tolerance = values[2];
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  __Pyx_RaiseArgtupleInvalid("sip_im2pix", 0, 2, 3, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 212, __pyx_L3_error)
  __pyx_L3_error:;
  __Pyx_AddTraceback("orb.cutils.sip_im2pix", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __Pyx_RefNannyFinishContext();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_im_coords), __pyx_ptype_5numpy_ndarray, 1, "im_coords", 0))) __PYX_ERR(0, 212, __pyx_L1_error)
  __pyx_r = __pyx_pf_3orb_6cutils_6sip_im2pix(__pyx_self, __pyx_v_im_coords, __pyx_v_sip, __pyx_v_tolerance);

  /* function exit code */
  goto __pyx_L0;
  __pyx_L1_error:;
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_6sip_im2pix(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_im_coords, PyObject *__pyx_v_sip, PyObject *__pyx_v_tolerance) {
  PyArrayObject *__pyx_v_xcoord = 0;
  PyArrayObject *__pyx_v_ycoord = 0;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_im_coords;
  __Pyx_Buffer __pyx_pybuffer_im_coords;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_xcoord;
  __Pyx_Buffer __pyx_pybuffer_xcoord;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_ycoord;
  __Pyx_Buffer __pyx_pybuffer_ycoord;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  PyObject *__pyx_t_1 = NULL;
  PyObject *__pyx_t_2 = NULL;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  PyObject *__pyx_t_5 = NULL;
  PyArrayObject *__pyx_t_6 = NULL;
  PyArrayObject *__pyx_t_7 = NULL;
  Py_ssize_t __pyx_t_8;
  PyObject *__pyx_t_9 = NULL;
  PyObject *(*__pyx_t_10)(PyObject *);
  int __pyx_t_11;
  PyObject *__pyx_t_12 = NULL;
  PyObject *__pyx_t_13 = NULL;
  PyObject *__pyx_t_14 = NULL;
  __Pyx_RefNannySetupContext("sip_im2pix", 0);
  __pyx_pybuffer_xcoord.pybuffer.buf = NULL;
  __pyx_pybuffer_xcoord.refcount = 0;
  __pyx_pybuffernd_xcoord.data = NULL;
  __pyx_pybuffernd_xcoord.rcbuffer = &__pyx_pybuffer_xcoord;
  __pyx_pybuffer_ycoord.pybuffer.buf = NULL;
  __pyx_pybuffer_ycoord.refcount = 0;
  __pyx_pybuffernd_ycoord.data = NULL;
  __pyx_pybuffernd_ycoord.rcbuffer = &__pyx_pybuffer_ycoord;
  __pyx_pybuffer_im_coords.pybuffer.buf = NULL;
  __pyx_pybuffer_im_coords.refcount = 0;
  __pyx_pybuffernd_im_coords.data = NULL;
  __pyx_pybuffernd_im_coords.rcbuffer = &__pyx_pybuffer_im_coords;
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_im_coords.rcbuffer->pybuffer, (PyObject*)__pyx_v_im_coords, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) __PYX_ERR(0, 212, __pyx_L1_error)
  }
  __pyx_pybuffernd_im_coords.diminfo[0].strides = __pyx_pybuffernd_im_coords.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_im_coords.diminfo[0].shape = __pyx_pybuffernd_im_coords.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_im_coords.diminfo[1].strides = __pyx_pybuffernd_im_coords.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_im_coords.diminfo[1].shape = __pyx_pybuffernd_im_coords.rcbuffer->pybuffer.shape[1];

  /* "orb/cutils.pyx":222
 *     .. warning:: SIP.foc2pix must be used instead
 *     """
 *     cdef np.ndarray[np.float64_t, ndim=1] xcoord = np.empty(             # <<<<<<<<<<<<<<
 *         im_coords.shape[0], dtype=np.float64)
 *     cdef np.ndarray[np.float64_t, ndim=1] ycoord = np.empty(
 */
  __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 222, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_empty); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 222, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":223
 *     """
 *     cdef np.ndarray[np.float64_t, ndim=1] xcoord = np.empty(
 *         im_coords.shape[0], dtype=np.float64)             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.float64_t, ndim=1] ycoord = np.empty(
 *         im_coords.shape[0], dtype=np.float64)
 */
  __pyx_t_1 = __Pyx_PyInt_From_Py_intptr_t((__pyx_v_im_coords->dimensions[0])); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 223, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);

  /* "orb/cutils.pyx":222
 *     .. warning:: SIP.foc2pix must be used instead
 *     """
 *     cdef np.ndarray[np.float64_t, ndim=1] xcoord = np.empty(             # <<<<<<<<<<<<<<
 *         im_coords.shape[0], dtype=np.float64)
 *     cdef np.ndarray[np.float64_t, ndim=1] ycoord = np.empty(
 */
  __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 222, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_GIVEREF(__pyx_t_1);
  PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_1);
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":223
 *     """
 *     cdef np.ndarray[np.float64_t, ndim=1] xcoord = np.empty(
 *         im_coords.shape[0], dtype=np.float64)             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.float64_t, ndim=1] ycoord = np.empty(
 *         im_coords.shape[0], dtype=np.float64)
 */
  __pyx_t_1 = PyDict_New(); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 223, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 223, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_float64); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 223, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  if (PyDict_SetItem(__pyx_t_1, __pyx_n_s_dtype, __pyx_t_5) < 0) __PYX_ERR(0, 223, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

  /* "orb/cutils.pyx":222
 *     .. warning:: SIP.foc2pix must be used instead
 *     """
 *     cdef np.ndarray[np.float64_t, ndim=1] xcoord = np.empty(             # <<<<<<<<<<<<<<
 *         im_coords.shape[0], dtype=np.float64)
 *     cdef np.ndarray[np.float64_t, ndim=1] ycoord = np.empty(
 */
  __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_3, __pyx_t_1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 222, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  if (!(likely(((__pyx_t_5) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_5, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 222, __pyx_L1_error)
  __pyx_t_6 = ((PyArrayObject *)__pyx_t_5);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_xcoord.rcbuffer->pybuffer, (PyObject*)__pyx_t_6, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
      __pyx_v_xcoord = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_xcoord.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 222, __pyx_L1_error)
    } else {__pyx_pybuffernd_xcoord.diminfo[0].strides = __pyx_pybuffernd_xcoord.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_xcoord.diminfo[0].shape = __pyx_pybuffernd_xcoord.rcbuffer->pybuffer.shape[0];
    }
  }
  __pyx_t_6 = 0;
  __pyx_v_xcoord = ((PyArrayObject *)__pyx_t_5);
  __pyx_t_5 = 0;

  /* "orb/cutils.pyx":224
 *     cdef np.ndarray[np.float64_t, ndim=1] xcoord = np.empty(
 *         im_coords.shape[0], dtype=np.float64)
 *     cdef np.ndarray[np.float64_t, ndim=1] ycoord = np.empty(             # <<<<<<<<<<<<<<
 *         im_coords.shape[0], dtype=np.float64)
 * 
 */
  __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 224, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_empty); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 224, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

  /* "orb/cutils.pyx":225
 *         im_coords.shape[0], dtype=np.float64)
 *     cdef np.ndarray[np.float64_t, ndim=1] ycoord = np.empty(
 *         im_coords.shape[0], dtype=np.float64)             # <<<<<<<<<<<<<<
 * 
 *     xcoord, ycoord = sip.wcs_pix2world(im_coords[:,1], im_coords[:,0], 0)
 */
  __pyx_t_5 = __Pyx_PyInt_From_Py_intptr_t((__pyx_v_im_coords->dimensions[0])); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 225, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);

  /* "orb/cutils.pyx":224
 *     cdef np.ndarray[np.float64_t, ndim=1] xcoord = np.empty(
 *         im_coords.shape[0], dtype=np.float64)
 *     cdef np.ndarray[np.float64_t, ndim=1] ycoord = np.empty(             # <<<<<<<<<<<<<<
 *         im_coords.shape[0], dtype=np.float64)
 * 
 */
  __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 224, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_GIVEREF(__pyx_t_5);
  PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_5);
  __pyx_t_5 = 0;

  /* "orb/cutils.pyx":225
 *         im_coords.shape[0], dtype=np.float64)
 *     cdef np.ndarray[np.float64_t, ndim=1] ycoord = np.empty(
 *         im_coords.shape[0], dtype=np.float64)             # <<<<<<<<<<<<<<
 * 
 *     xcoord, ycoord = sip.wcs_pix2world(im_coords[:,1], im_coords[:,0], 0)
 */
  __pyx_t_5 = PyDict_New(); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 225, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 225, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_float64); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 225, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  if (PyDict_SetItem(__pyx_t_5, __pyx_n_s_dtype, __pyx_t_4) < 0) __PYX_ERR(0, 225, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;

  /* "orb/cutils.pyx":224
 *     cdef np.ndarray[np.float64_t, ndim=1] xcoord = np.empty(
 *         im_coords.shape[0], dtype=np.float64)
 *     cdef np.ndarray[np.float64_t, ndim=1] ycoord = np.empty(             # <<<<<<<<<<<<<<
 *         im_coords.shape[0], dtype=np.float64)
 * 
 */
  __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_1, __pyx_t_3, __pyx_t_5); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 224, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  if (!(likely(((__pyx_t_4) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_4, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 224, __pyx_L1_error)
  __pyx_t_7 = ((PyArrayObject *)__pyx_t_4);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_ycoord.rcbuffer->pybuffer, (PyObject*)__pyx_t_7, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
      __pyx_v_ycoord = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_ycoord.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 224, __pyx_L1_error)
    } else {__pyx_pybuffernd_ycoord.diminfo[0].strides = __pyx_pybuffernd_ycoord.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_ycoord.diminfo[0].shape = __pyx_pybuffernd_ycoord.rcbuffer->pybuffer.shape[0];
    }
  }
  __pyx_t_7 = 0;
  __pyx_v_ycoord = ((PyArrayObject *)__pyx_t_4);
  __pyx_t_4 = 0;

  /* "orb/cutils.pyx":227
 *         im_coords.shape[0], dtype=np.float64)
 * 
 *     xcoord, ycoord = sip.wcs_pix2world(im_coords[:,1], im_coords[:,0], 0)             # <<<<<<<<<<<<<<
 *     xcoord, ycoord = sip.all_world2pix(xcoord, ycoord, 0, tolerance=tolerance)
 * 
 */
  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_v_sip, __pyx_n_s_wcs_pix2world); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 227, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_3 = PyObject_GetItem(((PyObject *)__pyx_v_im_coords), __pyx_tuple__2); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 227, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_1 = PyObject_GetItem(((PyObject *)__pyx_v_im_coords), __pyx_tuple__4); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 227, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_2 = NULL;
  __pyx_t_8 = 0;
  if (CYTHON_COMPILING_IN_CPYTHON && likely(PyMethod_Check(__pyx_t_5))) {
    __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_5);
    if (likely(__pyx_t_2)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_5);
      __Pyx_INCREF(__pyx_t_2);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_5, function);
      __pyx_t_8 = 1;
    }
  }
  __pyx_t_9 = PyTuple_New(3+__pyx_t_8); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 227, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_9);
  if (__pyx_t_2) {
    __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_9, 0, __pyx_t_2); __pyx_t_2 = NULL;
  }
  __Pyx_GIVEREF(__pyx_t_3);
  PyTuple_SET_ITEM(__pyx_t_9, 0+__pyx_t_8, __pyx_t_3);
  __Pyx_GIVEREF(__pyx_t_1);
  PyTuple_SET_ITEM(__pyx_t_9, 1+__pyx_t_8, __pyx_t_1);
  __Pyx_INCREF(__pyx_int_0);
  __Pyx_GIVEREF(__pyx_int_0);
  PyTuple_SET_ITEM(__pyx_t_9, 2+__pyx_t_8, __pyx_int_0);
  __pyx_t_3 = 0;
  __pyx_t_1 = 0;
  __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_9, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 227, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  if ((likely(PyTuple_CheckExact(__pyx_t_4))) || (PyList_CheckExact(__pyx_t_4))) {
    PyObject* sequence = __pyx_t_4;
    #if CYTHON_COMPILING_IN_CPYTHON
    Py_ssize_t size = Py_SIZE(sequence);
    #else
    Py_ssize_t size = PySequence_Size(sequence);
    #endif
    if (unlikely(size != 2)) {
      if (size > 2) __Pyx_RaiseTooManyValuesError(2);
      else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
      __PYX_ERR(0, 227, __pyx_L1_error)
    }
    #if CYTHON_COMPILING_IN_CPYTHON
    if (likely(PyTuple_CheckExact(sequence))) {
      __pyx_t_5 = PyTuple_GET_ITEM(sequence, 0); 
      __pyx_t_9 = PyTuple_GET_ITEM(sequence, 1); 
    } else {
      __pyx_t_5 = PyList_GET_ITEM(sequence, 0); 
      __pyx_t_9 = PyList_GET_ITEM(sequence, 1); 
    }
    __Pyx_INCREF(__pyx_t_5);
    __Pyx_INCREF(__pyx_t_9);
    #else
    __pyx_t_5 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 227, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __pyx_t_9 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 227, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_9);
    #endif
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  } else {
    Py_ssize_t index = -1;
    __pyx_t_1 = PyObject_GetIter(__pyx_t_4); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 227, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_t_10 = Py_TYPE(__pyx_t_1)->tp_iternext;
    index = 0; __pyx_t_5 = __pyx_t_10(__pyx_t_1); if (unlikely(!__pyx_t_5)) goto __pyx_L3_unpacking_failed;
    __Pyx_GOTREF(__pyx_t_5);
    index = 1; __pyx_t_9 = __pyx_t_10(__pyx_t_1); if (unlikely(!__pyx_t_9)) goto __pyx_L3_unpacking_failed;
    __Pyx_GOTREF(__pyx_t_9);
    if (__Pyx_IternextUnpackEndCheck(__pyx_t_10(__pyx_t_1), 2) < 0) __PYX_ERR(0, 227, __pyx_L1_error)
    __pyx_t_10 = NULL;
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    goto __pyx_L4_unpacking_done;
    __pyx_L3_unpacking_failed:;
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    __pyx_t_10 = NULL;
    if (__Pyx_IterFinish() == 0) __Pyx_RaiseNeedMoreValuesError(index);
    __PYX_ERR(0, 227, __pyx_L1_error)
    __pyx_L4_unpacking_done:;
  }
  if (!(likely(((__pyx_t_5) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_5, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 227, __pyx_L1_error)
  if (!(likely(((__pyx_t_9) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_9, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 227, __pyx_L1_error)
  __pyx_t_6 = ((PyArrayObject *)__pyx_t_5);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_xcoord.rcbuffer->pybuffer);
    __pyx_t_11 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_xcoord.rcbuffer->pybuffer, (PyObject*)__pyx_t_6, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack);
    if (unlikely(__pyx_t_11 < 0)) {
      PyErr_Fetch(&__pyx_t_12, &__pyx_t_13, &__pyx_t_14);
      if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_xcoord.rcbuffer->pybuffer, (PyObject*)__pyx_v_xcoord, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_12); Py_XDECREF(__pyx_t_13); Py_XDECREF(__pyx_t_14);
        __Pyx_RaiseBufferFallbackError();
      } else {
        PyErr_Restore(__pyx_t_12, __pyx_t_13, __pyx_t_14);
      }
    }
    __pyx_pybuffernd_xcoord.diminfo[0].strides = __pyx_pybuffernd_xcoord.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_xcoord.diminfo[0].shape = __pyx_pybuffernd_xcoord.rcbuffer->pybuffer.shape[0];
    if (unlikely(__pyx_t_11 < 0)) __PYX_ERR(0, 227, __pyx_L1_error)
  }
  __pyx_t_6 = 0;
  __Pyx_DECREF_SET(__pyx_v_xcoord, ((PyArrayObject *)__pyx_t_5));
  __pyx_t_5 = 0;
  __pyx_t_7 = ((PyArrayObject *)__pyx_t_9);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_ycoord.rcbuffer->pybuffer);
    __pyx_t_11 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_ycoord.rcbuffer->pybuffer, (PyObject*)__pyx_t_7, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack);
    if (unlikely(__pyx_t_11 < 0)) {
      PyErr_Fetch(&__pyx_t_14, &__pyx_t_13, &__pyx_t_12);
      if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_ycoord.rcbuffer->pybuffer, (PyObject*)__pyx_v_ycoord, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_14); Py_XDECREF(__pyx_t_13); Py_XDECREF(__pyx_t_12);
        __Pyx_RaiseBufferFallbackError();
      } else {
        PyErr_Restore(__pyx_t_14, __pyx_t_13, __pyx_t_12);
      }
    }
    __pyx_pybuffernd_ycoord.diminfo[0].strides = __pyx_pybuffernd_ycoord.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_ycoord.diminfo[0].shape = __pyx_pybuffernd_ycoord.rcbuffer->pybuffer.shape[0];
    if (unlikely(__pyx_t_11 < 0)) __PYX_ERR(0, 227, __pyx_L1_error)
  }
  __pyx_t_7 = 0;
  __Pyx_DECREF_SET(__pyx_v_ycoord, ((PyArrayObject *)__pyx_t_9));
  __pyx_t_9 = 0;

  /* "orb/cutils.pyx":228
 * 
 *     xcoord, ycoord = sip.wcs_pix2world(im_coords[:,1], im_coords[:,0], 0)
 *     xcoord, ycoord = sip.all_world2pix(xcoord, ycoord, 0, tolerance=tolerance)             # <<<<<<<<<<<<<<
 * 
 *     return np.array([ycoord, xcoord]).T
 */
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_v_sip, __pyx_n_s_all_world2pix); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 228, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_9 = PyTuple_New(3); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 228, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_9);
  __Pyx_INCREF(((PyObject *)__pyx_v_xcoord));
  __Pyx_GIVEREF(((PyObject *)__pyx_v_xcoord));
  PyTuple_SET_ITEM(__pyx_t_9, 0, ((PyObject *)__pyx_v_xcoord));
  __Pyx_INCREF(((PyObject *)__pyx_v_ycoord));
  __Pyx_GIVEREF(((PyObject *)__pyx_v_ycoord));
  PyTuple_SET_ITEM(__pyx_t_9, 1, ((PyObject *)__pyx_v_ycoord));
  __Pyx_INCREF(__pyx_int_0);
  __Pyx_GIVEREF(__pyx_int_0);
  PyTuple_SET_ITEM(__pyx_t_9, 2, __pyx_int_0);
  __pyx_t_5 = PyDict_New(); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 228, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  if (PyDict_SetItem(__pyx_t_5, __pyx_n_s_tolerance, __pyx_v_tolerance) < 0) __PYX_ERR(0, 228, __pyx_L1_error)
  __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_9, __pyx_t_5); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 228, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  if ((likely(PyTuple_CheckExact(__pyx_t_1))) || (PyList_CheckExact(__pyx_t_1))) {
    PyObject* sequence = __pyx_t_1;
    #if CYTHON_COMPILING_IN_CPYTHON
    Py_ssize_t size = Py_SIZE(sequence);
    #else
    Py_ssize_t size = PySequence_Size(sequence);
    #endif
    if (unlikely(size != 2)) {
      if (size > 2) __Pyx_RaiseTooManyValuesError(2);
      else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
      __PYX_ERR(0, 228, __pyx_L1_error)
    }
    #if CYTHON_COMPILING_IN_CPYTHON
    if (likely(PyTuple_CheckExact(sequence))) {
      __pyx_t_5 = PyTuple_GET_ITEM(sequence, 0); 
      __pyx_t_9 = PyTuple_GET_ITEM(sequence, 1); 
    } else {
      __pyx_t_5 = PyList_GET_ITEM(sequence, 0); 
      __pyx_t_9 = PyList_GET_ITEM(sequence, 1); 
    }
    __Pyx_INCREF(__pyx_t_5);
    __Pyx_INCREF(__pyx_t_9);
    #else
    __pyx_t_5 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 228, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __pyx_t_9 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 228, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_9);
    #endif
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  } else {
    Py_ssize_t index = -1;
    __pyx_t_4 = PyObject_GetIter(__pyx_t_1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 228, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    __pyx_t_10 = Py_TYPE(__pyx_t_4)->tp_iternext;
    index = 0; __pyx_t_5 = __pyx_t_10(__pyx_t_4); if (unlikely(!__pyx_t_5)) goto __pyx_L5_unpacking_failed;
    __Pyx_GOTREF(__pyx_t_5);
    index = 1; __pyx_t_9 = __pyx_t_10(__pyx_t_4); if (unlikely(!__pyx_t_9)) goto __pyx_L5_unpacking_failed;
    __Pyx_GOTREF(__pyx_t_9);
    if (__Pyx_IternextUnpackEndCheck(__pyx_t_10(__pyx_t_4), 2) < 0) __PYX_ERR(0, 228, __pyx_L1_error)
    __pyx_t_10 = NULL;
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    goto __pyx_L6_unpacking_done;
    __pyx_L5_unpacking_failed:;
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_t_10 = NULL;
    if (__Pyx_IterFinish() == 0) __Pyx_RaiseNeedMoreValuesError(index);
    __PYX_ERR(0, 228, __pyx_L1_error)
    __pyx_L6_unpacking_done:;
  }
  if (!(likely(((__pyx_t_5) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_5, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 228, __pyx_L1_error)
  if (!(likely(((__pyx_t_9) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_9, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 228, __pyx_L1_error)
  __pyx_t_6 = ((PyArrayObject *)__pyx_t_5);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_xcoord.rcbuffer->pybuffer);
    __pyx_t_11 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_xcoord.rcbuffer->pybuffer, (PyObject*)__pyx_t_6, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack);
    if (unlikely(__pyx_t_11 < 0)) {
      PyErr_Fetch(&__pyx_t_12, &__pyx_t_13, &__pyx_t_14);
      if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_xcoord.rcbuffer->pybuffer, (PyObject*)__pyx_v_xcoord, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_12); Py_XDECREF(__pyx_t_13); Py_XDECREF(__pyx_t_14);
        __Pyx_RaiseBufferFallbackError();
      } else {
        PyErr_Restore(__pyx_t_12, __pyx_t_13, __pyx_t_14);
      }
    }
    __pyx_pybuffernd_xcoord.diminfo[0].strides = __pyx_pybuffernd_xcoord.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_xcoord.diminfo[0].shape = __pyx_pybuffernd_xcoord.rcbuffer->pybuffer.shape[0];
    if (unlikely(__pyx_t_11 < 0)) __PYX_ERR(0, 228, __pyx_L1_error)
  }
  __pyx_t_6 = 0;
  __Pyx_DECREF_SET(__pyx_v_xcoord, ((PyArrayObject *)__pyx_t_5));
  __pyx_t_5 = 0;
  __pyx_t_7 = ((PyArrayObject *)__pyx_t_9);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_ycoord.rcbuffer->pybuffer);
    __pyx_t_11 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_ycoord.rcbuffer->pybuffer, (PyObject*)__pyx_t_7, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack);
    if (unlikely(__pyx_t_11 < 0)) {
      PyErr_Fetch(&__pyx_t_14, &__pyx_t_13, &__pyx_t_12);
      if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_ycoord.rcbuffer->pybuffer, (PyObject*)__pyx_v_ycoord, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_14); Py_XDECREF(__pyx_t_13); Py_XDECREF(__pyx_t_12);
        __Pyx_RaiseBufferFallbackError();
      } else {
        PyErr_Restore(__pyx_t_14, __pyx_t_13, __pyx_t_12);
      }
    }
    __pyx_pybuffernd_ycoord.diminfo[0].strides = __pyx_pybuffernd_ycoord.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_ycoord.diminfo[0].shape = __pyx_pybuffernd_ycoord.rcbuffer->pybuffer.shape[0];
    if (unlikely(__pyx_t_11 < 0)) __PYX_ERR(0, 228, __pyx_L1_error)
  }
  __pyx_t_7 = 0;
  __Pyx_DECREF_SET(__pyx_v_ycoord, ((PyArrayObject *)__pyx_t_9));
  __pyx_t_9 = 0;

  /* "orb/cutils.pyx":230
 *     xcoord, ycoord = sip.all_world2pix(xcoord, ycoord, 0, tolerance=tolerance)
 * 
 *     return np.array([ycoord, xcoord]).T             # <<<<<<<<<<<<<<
 * 
 * def sip_pix2im(np.ndarray[np.float64_t, ndim=2] pix_coords, sip):
 */
  __Pyx_XDECREF(__pyx_r);
  __pyx_t_9 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 230, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_9);
  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_9, __pyx_n_s_array); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 230, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
  __pyx_t_9 = PyList_New(2); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 230, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_9);
  __Pyx_INCREF(((PyObject *)__pyx_v_ycoord));
  __Pyx_GIVEREF(((PyObject *)__pyx_v_ycoord));
  PyList_SET_ITEM(__pyx_t_9, 0, ((PyObject *)__pyx_v_ycoord));
  __Pyx_INCREF(((PyObject *)__pyx_v_xcoord));
  __Pyx_GIVEREF(((PyObject *)__pyx_v_xcoord));
  PyList_SET_ITEM(__pyx_t_9, 1, ((PyObject *)__pyx_v_xcoord));
  __pyx_t_4 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_5))) {
    __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_5);
    if (likely(__pyx_t_4)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_5);
      __Pyx_INCREF(__pyx_t_4);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_5, function);
    }
  }
  if (!__pyx_t_4) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_5, __pyx_t_9); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 230, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_3 = PyTuple_New(1+1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 230, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_4); __pyx_t_4 = NULL;
    __Pyx_GIVEREF(__pyx_t_9);
    PyTuple_SET_ITEM(__pyx_t_3, 0+1, __pyx_t_9);
    __pyx_t_9 = 0;
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_3, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 230, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  }
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_T); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 230, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_r = __pyx_t_5;
  __pyx_t_5 = 0;
  goto __pyx_L0;

  /* "orb/cutils.pyx":212
 *     return x2, y2
 * 
 * def sip_im2pix(np.ndarray[np.float64_t, ndim=2] im_coords, sip,             # <<<<<<<<<<<<<<
 *                tolerance=1e-8):
 *     """Transform perfect pixel positions to distorded pixels positions
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_1);
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_XDECREF(__pyx_t_5);
  __Pyx_XDECREF(__pyx_t_9);
  { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
    __Pyx_PyThreadState_declare
    __Pyx_PyThreadState_assign
    __Pyx_ErrFetch(&__pyx_type, &__pyx_value, &__pyx_tb);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_im_coords.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_xcoord.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_ycoord.rcbuffer->pybuffer);
  __Pyx_ErrRestore(__pyx_type, __pyx_value, __pyx_tb);}
  __Pyx_AddTraceback("orb.cutils.sip_im2pix", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  goto __pyx_L2;
  __pyx_L0:;
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_im_coords.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_xcoord.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_ycoord.rcbuffer->pybuffer);
  __pyx_L2:;
  __Pyx_XDECREF((PyObject *)__pyx_v_xcoord);
  __Pyx_XDECREF((PyObject *)__pyx_v_ycoord);
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":232
 *     return np.array([ycoord, xcoord]).T
 * 
 * def sip_pix2im(np.ndarray[np.float64_t, ndim=2] pix_coords, sip):             # <<<<<<<<<<<<<<
 *     """Transform distorded pixel positions to perfect pixels positions
 * 
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_9sip_pix2im(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_3orb_6cutils_8sip_pix2im[] = "sip_pix2im(ndarray pix_coords, sip)\nTransform distorded pixel positions to perfect pixels positions \n\n    :param pix_coords: distorded pixel positions as an Nx2 array of floats.\n    :param sip: pywcs.WCS() instance containing SIP parameters.\n\n    .. warning:: SIP.pix2foc must be used instead\n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_9sip_pix2im = {"sip_pix2im", (PyCFunction)__pyx_pw_3orb_6cutils_9sip_pix2im, METH_VARARGS|METH_KEYWORDS, __pyx_doc_3orb_6cutils_8sip_pix2im};
static PyObject *__pyx_pw_3orb_6cutils_9sip_pix2im(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  PyArrayObject *__pyx_v_pix_coords = 0;
  PyObject *__pyx_v_sip = 0;
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("sip_pix2im (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_pix_coords,&__pyx_n_s_sip,0};
    PyObject* values[2] = {0,0};
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
      switch (pos_args) {
        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = PyDict_Size(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_pix_coords)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        case  1:
        if (likely((values[1] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_sip)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("sip_pix2im", 1, 2, 2, 1); __PYX_ERR(0, 232, __pyx_L3_error)
        }
      }
      if (unlikely(kw_args > 0)) {
        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "sip_pix2im") < 0)) __PYX_ERR(0, 232, __pyx_L3_error)
      }
    } else if (PyTuple_GET_SIZE(__pyx_args) != 2) {
      goto __pyx_L5_argtuple_error;
    } else {
      values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
      values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
    }
    __pyx_v_pix_coords = ((PyArrayObject *)values[0]);
    __pyx_v_sip = values[1];
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  __Pyx_RaiseArgtupleInvalid("sip_pix2im", 1, 2, 2, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 232, __pyx_L3_error)
  __pyx_L3_error:;
  __Pyx_AddTraceback("orb.cutils.sip_pix2im", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __Pyx_RefNannyFinishContext();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_pix_coords), __pyx_ptype_5numpy_ndarray, 1, "pix_coords", 0))) __PYX_ERR(0, 232, __pyx_L1_error)
  __pyx_r = __pyx_pf_3orb_6cutils_8sip_pix2im(__pyx_self, __pyx_v_pix_coords, __pyx_v_sip);

  /* function exit code */
  goto __pyx_L0;
  __pyx_L1_error:;
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_8sip_pix2im(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_pix_coords, PyObject *__pyx_v_sip) {
  PyArrayObject *__pyx_v_xcoord = 0;
  PyArrayObject *__pyx_v_ycoord = 0;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_pix_coords;
  __Pyx_Buffer __pyx_pybuffer_pix_coords;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_xcoord;
  __Pyx_Buffer __pyx_pybuffer_xcoord;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_ycoord;
  __Pyx_Buffer __pyx_pybuffer_ycoord;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  PyObject *__pyx_t_1 = NULL;
  PyObject *__pyx_t_2 = NULL;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  PyObject *__pyx_t_5 = NULL;
  PyArrayObject *__pyx_t_6 = NULL;
  PyArrayObject *__pyx_t_7 = NULL;
  Py_ssize_t __pyx_t_8;
  PyObject *__pyx_t_9 = NULL;
  PyObject *(*__pyx_t_10)(PyObject *);
  int __pyx_t_11;
  PyObject *__pyx_t_12 = NULL;
  PyObject *__pyx_t_13 = NULL;
  PyObject *__pyx_t_14 = NULL;
  __Pyx_RefNannySetupContext("sip_pix2im", 0);
  __pyx_pybuffer_xcoord.pybuffer.buf = NULL;
  __pyx_pybuffer_xcoord.refcount = 0;
  __pyx_pybuffernd_xcoord.data = NULL;
  __pyx_pybuffernd_xcoord.rcbuffer = &__pyx_pybuffer_xcoord;
  __pyx_pybuffer_ycoord.pybuffer.buf = NULL;
  __pyx_pybuffer_ycoord.refcount = 0;
  __pyx_pybuffernd_ycoord.data = NULL;
  __pyx_pybuffernd_ycoord.rcbuffer = &__pyx_pybuffer_ycoord;
  __pyx_pybuffer_pix_coords.pybuffer.buf = NULL;
  __pyx_pybuffer_pix_coords.refcount = 0;
  __pyx_pybuffernd_pix_coords.data = NULL;
  __pyx_pybuffernd_pix_coords.rcbuffer = &__pyx_pybuffer_pix_coords;
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_pix_coords.rcbuffer->pybuffer, (PyObject*)__pyx_v_pix_coords, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) __PYX_ERR(0, 232, __pyx_L1_error)
  }
  __pyx_pybuffernd_pix_coords.diminfo[0].strides = __pyx_pybuffernd_pix_coords.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_pix_coords.diminfo[0].shape = __pyx_pybuffernd_pix_coords.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_pix_coords.diminfo[1].strides = __pyx_pybuffernd_pix_coords.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_pix_coords.diminfo[1].shape = __pyx_pybuffernd_pix_coords.rcbuffer->pybuffer.shape[1];

  /* "orb/cutils.pyx":240
 *     .. warning:: SIP.pix2foc must be used instead
 *     """
 *     cdef np.ndarray[np.float64_t, ndim=1] xcoord = np.empty(             # <<<<<<<<<<<<<<
 *         pix_coords.shape[0], dtype=np.float64)
 *     cdef np.ndarray[np.float64_t, ndim=1] ycoord = np.empty(
 */
  __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 240, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_empty); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 240, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":241
 *     """
 *     cdef np.ndarray[np.float64_t, ndim=1] xcoord = np.empty(
 *         pix_coords.shape[0], dtype=np.float64)             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.float64_t, ndim=1] ycoord = np.empty(
 *         pix_coords.shape[0], dtype=np.float64)
 */
  __pyx_t_1 = __Pyx_PyInt_From_Py_intptr_t((__pyx_v_pix_coords->dimensions[0])); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 241, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);

  /* "orb/cutils.pyx":240
 *     .. warning:: SIP.pix2foc must be used instead
 *     """
 *     cdef np.ndarray[np.float64_t, ndim=1] xcoord = np.empty(             # <<<<<<<<<<<<<<
 *         pix_coords.shape[0], dtype=np.float64)
 *     cdef np.ndarray[np.float64_t, ndim=1] ycoord = np.empty(
 */
  __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 240, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_GIVEREF(__pyx_t_1);
  PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_1);
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":241
 *     """
 *     cdef np.ndarray[np.float64_t, ndim=1] xcoord = np.empty(
 *         pix_coords.shape[0], dtype=np.float64)             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.float64_t, ndim=1] ycoord = np.empty(
 *         pix_coords.shape[0], dtype=np.float64)
 */
  __pyx_t_1 = PyDict_New(); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 241, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 241, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_float64); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 241, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  if (PyDict_SetItem(__pyx_t_1, __pyx_n_s_dtype, __pyx_t_5) < 0) __PYX_ERR(0, 241, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

  /* "orb/cutils.pyx":240
 *     .. warning:: SIP.pix2foc must be used instead
 *     """
 *     cdef np.ndarray[np.float64_t, ndim=1] xcoord = np.empty(             # <<<<<<<<<<<<<<
 *         pix_coords.shape[0], dtype=np.float64)
 *     cdef np.ndarray[np.float64_t, ndim=1] ycoord = np.empty(
 */
  __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_3, __pyx_t_1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 240, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  if (!(likely(((__pyx_t_5) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_5, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 240, __pyx_L1_error)
  __pyx_t_6 = ((PyArrayObject *)__pyx_t_5);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_xcoord.rcbuffer->pybuffer, (PyObject*)__pyx_t_6, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
      __pyx_v_xcoord = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_xcoord.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 240, __pyx_L1_error)
    } else {__pyx_pybuffernd_xcoord.diminfo[0].strides = __pyx_pybuffernd_xcoord.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_xcoord.diminfo[0].shape = __pyx_pybuffernd_xcoord.rcbuffer->pybuffer.shape[0];
    }
  }
  __pyx_t_6 = 0;
  __pyx_v_xcoord = ((PyArrayObject *)__pyx_t_5);
  __pyx_t_5 = 0;

  /* "orb/cutils.pyx":242
 *     cdef np.ndarray[np.float64_t, ndim=1] xcoord = np.empty(
 *         pix_coords.shape[0], dtype=np.float64)
 *     cdef np.ndarray[np.float64_t, ndim=1] ycoord = np.empty(             # <<<<<<<<<<<<<<
 *         pix_coords.shape[0], dtype=np.float64)
 * 
 */
  __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 242, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_empty); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 242, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

  /* "orb/cutils.pyx":243
 *         pix_coords.shape[0], dtype=np.float64)
 *     cdef np.ndarray[np.float64_t, ndim=1] ycoord = np.empty(
 *         pix_coords.shape[0], dtype=np.float64)             # <<<<<<<<<<<<<<
 * 
 *     xcoord, ycoord = sip.all_pix2world(pix_coords[:,1], pix_coords[:,0], 0)
 */
  __pyx_t_5 = __Pyx_PyInt_From_Py_intptr_t((__pyx_v_pix_coords->dimensions[0])); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 243, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);

  /* "orb/cutils.pyx":242
 *     cdef np.ndarray[np.float64_t, ndim=1] xcoord = np.empty(
 *         pix_coords.shape[0], dtype=np.float64)
 *     cdef np.ndarray[np.float64_t, ndim=1] ycoord = np.empty(             # <<<<<<<<<<<<<<
 *         pix_coords.shape[0], dtype=np.float64)
 * 
 */
  __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 242, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_GIVEREF(__pyx_t_5);
  PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_5);
  __pyx_t_5 = 0;

  /* "orb/cutils.pyx":243
 *         pix_coords.shape[0], dtype=np.float64)
 *     cdef np.ndarray[np.float64_t, ndim=1] ycoord = np.empty(
 *         pix_coords.shape[0], dtype=np.float64)             # <<<<<<<<<<<<<<
 * 
 *     xcoord, ycoord = sip.all_pix2world(pix_coords[:,1], pix_coords[:,0], 0)
 */
  __pyx_t_5 = PyDict_New(); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 243, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 243, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_float64); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 243, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  if (PyDict_SetItem(__pyx_t_5, __pyx_n_s_dtype, __pyx_t_4) < 0) __PYX_ERR(0, 243, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;

  /* "orb/cutils.pyx":242
 *     cdef np.ndarray[np.float64_t, ndim=1] xcoord = np.empty(
 *         pix_coords.shape[0], dtype=np.float64)
 *     cdef np.ndarray[np.float64_t, ndim=1] ycoord = np.empty(             # <<<<<<<<<<<<<<
 *         pix_coords.shape[0], dtype=np.float64)
 * 
 */
  __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_1, __pyx_t_3, __pyx_t_5); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 242, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  if (!(likely(((__pyx_t_4) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_4, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 242, __pyx_L1_error)
  __pyx_t_7 = ((PyArrayObject *)__pyx_t_4);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_ycoord.rcbuffer->pybuffer, (PyObject*)__pyx_t_7, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
      __pyx_v_ycoord = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_ycoord.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 242, __pyx_L1_error)
    } else {__pyx_pybuffernd_ycoord.diminfo[0].strides = __pyx_pybuffernd_ycoord.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_ycoord.diminfo[0].shape = __pyx_pybuffernd_ycoord.rcbuffer->pybuffer.shape[0];
    }
  }
  __pyx_t_7 = 0;
  __pyx_v_ycoord = ((PyArrayObject *)__pyx_t_4);
  __pyx_t_4 = 0;

  /* "orb/cutils.pyx":245
 *         pix_coords.shape[0], dtype=np.float64)
 * 
 *     xcoord, ycoord = sip.all_pix2world(pix_coords[:,1], pix_coords[:,0], 0)             # <<<<<<<<<<<<<<
 *     xcoord, ycoord = sip.wcs_world2pix(xcoord, ycoord, 0)
 * 
 */
  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_v_sip, __pyx_n_s_all_pix2world); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 245, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_3 = PyObject_GetItem(((PyObject *)__pyx_v_pix_coords), __pyx_tuple__6); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 245, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_1 = PyObject_GetItem(((PyObject *)__pyx_v_pix_coords), __pyx_tuple__8); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 245, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_2 = NULL;
  __pyx_t_8 = 0;
  if (CYTHON_COMPILING_IN_CPYTHON && likely(PyMethod_Check(__pyx_t_5))) {
    __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_5);
    if (likely(__pyx_t_2)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_5);
      __Pyx_INCREF(__pyx_t_2);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_5, function);
      __pyx_t_8 = 1;
    }
  }
  __pyx_t_9 = PyTuple_New(3+__pyx_t_8); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 245, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_9);
  if (__pyx_t_2) {
    __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_9, 0, __pyx_t_2); __pyx_t_2 = NULL;
  }
  __Pyx_GIVEREF(__pyx_t_3);
  PyTuple_SET_ITEM(__pyx_t_9, 0+__pyx_t_8, __pyx_t_3);
  __Pyx_GIVEREF(__pyx_t_1);
  PyTuple_SET_ITEM(__pyx_t_9, 1+__pyx_t_8, __pyx_t_1);
  __Pyx_INCREF(__pyx_int_0);
  __Pyx_GIVEREF(__pyx_int_0);
  PyTuple_SET_ITEM(__pyx_t_9, 2+__pyx_t_8, __pyx_int_0);
  __pyx_t_3 = 0;
  __pyx_t_1 = 0;
  __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_9, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 245, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  if ((likely(PyTuple_CheckExact(__pyx_t_4))) || (PyList_CheckExact(__pyx_t_4))) {
    PyObject* sequence = __pyx_t_4;
    #if CYTHON_COMPILING_IN_CPYTHON
    Py_ssize_t size = Py_SIZE(sequence);
    #else
    Py_ssize_t size = PySequence_Size(sequence);
    #endif
    if (unlikely(size != 2)) {
      if (size > 2) __Pyx_RaiseTooManyValuesError(2);
      else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
      __PYX_ERR(0, 245, __pyx_L1_error)
    }
    #if CYTHON_COMPILING_IN_CPYTHON
    if (likely(PyTuple_CheckExact(sequence))) {
      __pyx_t_5 = PyTuple_GET_ITEM(sequence, 0); 
      __pyx_t_9 = PyTuple_GET_ITEM(sequence, 1); 
    } else {
      __pyx_t_5 = PyList_GET_ITEM(sequence, 0); 
      __pyx_t_9 = PyList_GET_ITEM(sequence, 1); 
    }
    __Pyx_INCREF(__pyx_t_5);
    __Pyx_INCREF(__pyx_t_9);
    #else
    __pyx_t_5 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 245, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __pyx_t_9 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 245, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_9);
    #endif
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  } else {
    Py_ssize_t index = -1;
    __pyx_t_1 = PyObject_GetIter(__pyx_t_4); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 245, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_t_10 = Py_TYPE(__pyx_t_1)->tp_iternext;
    index = 0; __pyx_t_5 = __pyx_t_10(__pyx_t_1); if (unlikely(!__pyx_t_5)) goto __pyx_L3_unpacking_failed;
    __Pyx_GOTREF(__pyx_t_5);
    index = 1; __pyx_t_9 = __pyx_t_10(__pyx_t_1); if (unlikely(!__pyx_t_9)) goto __pyx_L3_unpacking_failed;
    __Pyx_GOTREF(__pyx_t_9);
    if (__Pyx_IternextUnpackEndCheck(__pyx_t_10(__pyx_t_1), 2) < 0) __PYX_ERR(0, 245, __pyx_L1_error)
    __pyx_t_10 = NULL;
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    goto __pyx_L4_unpacking_done;
    __pyx_L3_unpacking_failed:;
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    __pyx_t_10 = NULL;
    if (__Pyx_IterFinish() == 0) __Pyx_RaiseNeedMoreValuesError(index);
    __PYX_ERR(0, 245, __pyx_L1_error)
    __pyx_L4_unpacking_done:;
  }
  if (!(likely(((__pyx_t_5) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_5, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 245, __pyx_L1_error)
  if (!(likely(((__pyx_t_9) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_9, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 245, __pyx_L1_error)
  __pyx_t_6 = ((PyArrayObject *)__pyx_t_5);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_xcoord.rcbuffer->pybuffer);
    __pyx_t_11 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_xcoord.rcbuffer->pybuffer, (PyObject*)__pyx_t_6, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack);
    if (unlikely(__pyx_t_11 < 0)) {
      PyErr_Fetch(&__pyx_t_12, &__pyx_t_13, &__pyx_t_14);
      if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_xcoord.rcbuffer->pybuffer, (PyObject*)__pyx_v_xcoord, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_12); Py_XDECREF(__pyx_t_13); Py_XDECREF(__pyx_t_14);
        __Pyx_RaiseBufferFallbackError();
      } else {
        PyErr_Restore(__pyx_t_12, __pyx_t_13, __pyx_t_14);
      }
    }
    __pyx_pybuffernd_xcoord.diminfo[0].strides = __pyx_pybuffernd_xcoord.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_xcoord.diminfo[0].shape = __pyx_pybuffernd_xcoord.rcbuffer->pybuffer.shape[0];
    if (unlikely(__pyx_t_11 < 0)) __PYX_ERR(0, 245, __pyx_L1_error)
  }
  __pyx_t_6 = 0;
  __Pyx_DECREF_SET(__pyx_v_xcoord, ((PyArrayObject *)__pyx_t_5));
  __pyx_t_5 = 0;
  __pyx_t_7 = ((PyArrayObject *)__pyx_t_9);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_ycoord.rcbuffer->pybuffer);
    __pyx_t_11 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_ycoord.rcbuffer->pybuffer, (PyObject*)__pyx_t_7, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack);
    if (unlikely(__pyx_t_11 < 0)) {
      PyErr_Fetch(&__pyx_t_14, &__pyx_t_13, &__pyx_t_12);
      if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_ycoord.rcbuffer->pybuffer, (PyObject*)__pyx_v_ycoord, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_14); Py_XDECREF(__pyx_t_13); Py_XDECREF(__pyx_t_12);
        __Pyx_RaiseBufferFallbackError();
      } else {
        PyErr_Restore(__pyx_t_14, __pyx_t_13, __pyx_t_12);
      }
    }
    __pyx_pybuffernd_ycoord.diminfo[0].strides = __pyx_pybuffernd_ycoord.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_ycoord.diminfo[0].shape = __pyx_pybuffernd_ycoord.rcbuffer->pybuffer.shape[0];
    if (unlikely(__pyx_t_11 < 0)) __PYX_ERR(0, 245, __pyx_L1_error)
  }
  __pyx_t_7 = 0;
  __Pyx_DECREF_SET(__pyx_v_ycoord, ((PyArrayObject *)__pyx_t_9));
  __pyx_t_9 = 0;

  /* "orb/cutils.pyx":246
 * 
 *     xcoord, ycoord = sip.all_pix2world(pix_coords[:,1], pix_coords[:,0], 0)
 *     xcoord, ycoord = sip.wcs_world2pix(xcoord, ycoord, 0)             # <<<<<<<<<<<<<<
 * 
 *     return np.array([ycoord, xcoord]).T
 */
  __pyx_t_9 = __Pyx_PyObject_GetAttrStr(__pyx_v_sip, __pyx_n_s_wcs_world2pix); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 246, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_9);
  __pyx_t_5 = NULL;
  __pyx_t_8 = 0;
  if (CYTHON_COMPILING_IN_CPYTHON && likely(PyMethod_Check(__pyx_t_9))) {
    __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_9);
    if (likely(__pyx_t_5)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_9);
      __Pyx_INCREF(__pyx_t_5);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_9, function);
      __pyx_t_8 = 1;
    }
  }
  __pyx_t_1 = PyTuple_New(3+__pyx_t_8); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 246, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if (__pyx_t_5) {
    __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_1, 0, __pyx_t_5); __pyx_t_5 = NULL;
  }
  __Pyx_INCREF(((PyObject *)__pyx_v_xcoord));
  __Pyx_GIVEREF(((PyObject *)__pyx_v_xcoord));
  PyTuple_SET_ITEM(__pyx_t_1, 0+__pyx_t_8, ((PyObject *)__pyx_v_xcoord));
  __Pyx_INCREF(((PyObject *)__pyx_v_ycoord));
  __Pyx_GIVEREF(((PyObject *)__pyx_v_ycoord));
  PyTuple_SET_ITEM(__pyx_t_1, 1+__pyx_t_8, ((PyObject *)__pyx_v_ycoord));
  __Pyx_INCREF(__pyx_int_0);
  __Pyx_GIVEREF(__pyx_int_0);
  PyTuple_SET_ITEM(__pyx_t_1, 2+__pyx_t_8, __pyx_int_0);
  __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_9, __pyx_t_1, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 246, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
  if ((likely(PyTuple_CheckExact(__pyx_t_4))) || (PyList_CheckExact(__pyx_t_4))) {
    PyObject* sequence = __pyx_t_4;
    #if CYTHON_COMPILING_IN_CPYTHON
    Py_ssize_t size = Py_SIZE(sequence);
    #else
    Py_ssize_t size = PySequence_Size(sequence);
    #endif
    if (unlikely(size != 2)) {
      if (size > 2) __Pyx_RaiseTooManyValuesError(2);
      else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
      __PYX_ERR(0, 246, __pyx_L1_error)
    }
    #if CYTHON_COMPILING_IN_CPYTHON
    if (likely(PyTuple_CheckExact(sequence))) {
      __pyx_t_9 = PyTuple_GET_ITEM(sequence, 0); 
      __pyx_t_1 = PyTuple_GET_ITEM(sequence, 1); 
    } else {
      __pyx_t_9 = PyList_GET_ITEM(sequence, 0); 
      __pyx_t_1 = PyList_GET_ITEM(sequence, 1); 
    }
    __Pyx_INCREF(__pyx_t_9);
    __Pyx_INCREF(__pyx_t_1);
    #else
    __pyx_t_9 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 246, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_9);
    __pyx_t_1 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 246, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    #endif
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  } else {
    Py_ssize_t index = -1;
    __pyx_t_5 = PyObject_GetIter(__pyx_t_4); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 246, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_t_10 = Py_TYPE(__pyx_t_5)->tp_iternext;
    index = 0; __pyx_t_9 = __pyx_t_10(__pyx_t_5); if (unlikely(!__pyx_t_9)) goto __pyx_L5_unpacking_failed;
    __Pyx_GOTREF(__pyx_t_9);
    index = 1; __pyx_t_1 = __pyx_t_10(__pyx_t_5); if (unlikely(!__pyx_t_1)) goto __pyx_L5_unpacking_failed;
    __Pyx_GOTREF(__pyx_t_1);
    if (__Pyx_IternextUnpackEndCheck(__pyx_t_10(__pyx_t_5), 2) < 0) __PYX_ERR(0, 246, __pyx_L1_error)
    __pyx_t_10 = NULL;
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    goto __pyx_L6_unpacking_done;
    __pyx_L5_unpacking_failed:;
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    __pyx_t_10 = NULL;
    if (__Pyx_IterFinish() == 0) __Pyx_RaiseNeedMoreValuesError(index);
    __PYX_ERR(0, 246, __pyx_L1_error)
    __pyx_L6_unpacking_done:;
  }
  if (!(likely(((__pyx_t_9) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_9, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 246, __pyx_L1_error)
  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 246, __pyx_L1_error)
  __pyx_t_6 = ((PyArrayObject *)__pyx_t_9);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_xcoord.rcbuffer->pybuffer);
    __pyx_t_11 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_xcoord.rcbuffer->pybuffer, (PyObject*)__pyx_t_6, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack);
    if (unlikely(__pyx_t_11 < 0)) {
      PyErr_Fetch(&__pyx_t_12, &__pyx_t_13, &__pyx_t_14);
      if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_xcoord.rcbuffer->pybuffer, (PyObject*)__pyx_v_xcoord, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_12); Py_XDECREF(__pyx_t_13); Py_XDECREF(__pyx_t_14);
        __Pyx_RaiseBufferFallbackError();
      } else {
        PyErr_Restore(__pyx_t_12, __pyx_t_13, __pyx_t_14);
      }
    }
    __pyx_pybuffernd_xcoord.diminfo[0].strides = __pyx_pybuffernd_xcoord.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_xcoord.diminfo[0].shape = __pyx_pybuffernd_xcoord.rcbuffer->pybuffer.shape[0];
    if (unlikely(__pyx_t_11 < 0)) __PYX_ERR(0, 246, __pyx_L1_error)
  }
  __pyx_t_6 = 0;
  __Pyx_DECREF_SET(__pyx_v_xcoord, ((PyArrayObject *)__pyx_t_9));
  __pyx_t_9 = 0;
  __pyx_t_7 = ((PyArrayObject *)__pyx_t_1);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_ycoord.rcbuffer->pybuffer);
    __pyx_t_11 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_ycoord.rcbuffer->pybuffer, (PyObject*)__pyx_t_7, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack);
    if (unlikely(__pyx_t_11 < 0)) {
      PyErr_Fetch(&__pyx_t_14, &__pyx_t_13, &__pyx_t_12);
      if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_ycoord.rcbuffer->pybuffer, (PyObject*)__pyx_v_ycoord, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_14); Py_XDECREF(__pyx_t_13); Py_XDECREF(__pyx_t_12);
        __Pyx_RaiseBufferFallbackError();
      } else {
        PyErr_Restore(__pyx_t_14, __pyx_t_13, __pyx_t_12);
      }
    }
    __pyx_pybuffernd_ycoord.diminfo[0].strides = __pyx_pybuffernd_ycoord.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_ycoord.diminfo[0].shape = __pyx_pybuffernd_ycoord.rcbuffer->pybuffer.shape[0];
    if (unlikely(__pyx_t_11 < 0)) __PYX_ERR(0, 246, __pyx_L1_error)
  }
  __pyx_t_7 = 0;
  __Pyx_DECREF_SET(__pyx_v_ycoord, ((PyArrayObject *)__pyx_t_1));
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":248
 *     xcoord, ycoord = sip.wcs_world2pix(xcoord, ycoord, 0)
 * 
 *     return np.array([ycoord, xcoord]).T             # <<<<<<<<<<<<<<
 * 
 * @cython.boundscheck(False)
 */
  __Pyx_XDECREF(__pyx_r);
  __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 248, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_9 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_array); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 248, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_9);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_1 = PyList_New(2); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 248, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_INCREF(((PyObject *)__pyx_v_ycoord));
  __Pyx_GIVEREF(((PyObject *)__pyx_v_ycoord));
  PyList_SET_ITEM(__pyx_t_1, 0, ((PyObject *)__pyx_v_ycoord));
  __Pyx_INCREF(((PyObject *)__pyx_v_xcoord));
  __Pyx_GIVEREF(((PyObject *)__pyx_v_xcoord));
  PyList_SET_ITEM(__pyx_t_1, 1, ((PyObject *)__pyx_v_xcoord));
  __pyx_t_5 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_9))) {
    __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_9);
    if (likely(__pyx_t_5)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_9);
      __Pyx_INCREF(__pyx_t_5);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_9, function);
    }
  }
  if (!__pyx_t_5) {
    __pyx_t_4 = __Pyx_PyObject_CallOneArg(__pyx_t_9, __pyx_t_1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 248, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    __Pyx_GOTREF(__pyx_t_4);
  } else {
    __pyx_t_3 = PyTuple_New(1+1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 248, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_5); __pyx_t_5 = NULL;
    __Pyx_GIVEREF(__pyx_t_1);
    PyTuple_SET_ITEM(__pyx_t_3, 0+1, __pyx_t_1);
    __pyx_t_1 = 0;
    __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_9, __pyx_t_3, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 248, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  }
  __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
  __pyx_t_9 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_T); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 248, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_9);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_r = __pyx_t_9;
  __pyx_t_9 = 0;
  goto __pyx_L0;

  /* "orb/cutils.pyx":232
 *     return np.array([ycoord, xcoord]).T
 * 
 * def sip_pix2im(np.ndarray[np.float64_t, ndim=2] pix_coords, sip):             # <<<<<<<<<<<<<<
 *     """Transform distorded pixel positions to perfect pixels positions
 * 
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_1);
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_XDECREF(__pyx_t_5);
  __Pyx_XDECREF(__pyx_t_9);
  { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
    __Pyx_PyThreadState_declare
    __Pyx_PyThreadState_assign
    __Pyx_ErrFetch(&__pyx_type, &__pyx_value, &__pyx_tb);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_pix_coords.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_xcoord.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_ycoord.rcbuffer->pybuffer);
  __Pyx_ErrRestore(__pyx_type, __pyx_value, __pyx_tb);}
  __Pyx_AddTraceback("orb.cutils.sip_pix2im", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  goto __pyx_L2;
  __pyx_L0:;
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_pix_coords.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_xcoord.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_ycoord.rcbuffer->pybuffer);
  __pyx_L2:;
  __Pyx_XDECREF((PyObject *)__pyx_v_xcoord);
  __Pyx_XDECREF((PyObject *)__pyx_v_ycoord);
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":252
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def create_transform_maps(int nx, int ny, double dx, double dy,             # <<<<<<<<<<<<<<
 *                           double dr, double da, double db, double xrc,
 *                           double yrc, double zx, double zy, sip_A, sip_B):
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_11create_transform_maps(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_3orb_6cutils_10create_transform_maps[] = "create_transform_maps(int nx, int ny, double dx, double dy, double dr, double da, double db, double xrc, double yrc, double zx, double zy, sip_A, sip_B)\nCreate the 2 transformation maps used to compute the\n    geometrical transformation.\n\n    :param nx: size of the frame along x axis\n    :param ny: size of the frame along y axis\n    :param dx: translation along x\n    :param dy: translation along y\n    :param dr: rotation in the plane of the image\n    :param da: tip angle\n    :param db: tilt angle\n    :param xrc: x coordinate of the rotation center\n    :param yrc: y coordinate of the rotation center\n    :param zx: zoom coefficient along x\n    :param zy: zoom coefficient along y\n    \n    :param sip_A: pywcs.WCS() instance containing SIP parameters of\n      the output image.\n    :param sip_B: pywcs.WCS() instance containing SIP parameters of\n      the input image.\n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_11create_transform_maps = {"create_transform_maps", (PyCFunction)__pyx_pw_3orb_6cutils_11create_transform_maps, METH_VARARGS|METH_KEYWORDS, __pyx_doc_3orb_6cutils_10create_transform_maps};
static PyObject *__pyx_pw_3orb_6cutils_11create_transform_maps(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  int __pyx_v_nx;
  int __pyx_v_ny;
  double __pyx_v_dx;
  double __pyx_v_dy;
  double __pyx_v_dr;
  double __pyx_v_da;
  double __pyx_v_db;
  double __pyx_v_xrc;
  double __pyx_v_yrc;
  double __pyx_v_zx;
  double __pyx_v_zy;
  PyObject *__pyx_v_sip_A = 0;
  PyObject *__pyx_v_sip_B = 0;
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("create_transform_maps (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_nx,&__pyx_n_s_ny,&__pyx_n_s_dx,&__pyx_n_s_dy,&__pyx_n_s_dr,&__pyx_n_s_da,&__pyx_n_s_db,&__pyx_n_s_xrc,&__pyx_n_s_yrc,&__pyx_n_s_zx,&__pyx_n_s_zy,&__pyx_n_s_sip_A,&__pyx_n_s_sip_B,0};
    PyObject* values[13] = {0,0,0,0,0,0,0,0,0,0,0,0,0};
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
      switch (pos_args) {
        case 13: values[12] = PyTuple_GET_ITEM(__pyx_args, 12);
        case 12: values[11] = PyTuple_GET_ITEM(__pyx_args, 11);
        case 11: values[10] = PyTuple_GET_ITEM(__pyx_args, 10);
        case 10: values[9] = PyTuple_GET_ITEM(__pyx_args, 9);
        case  9: values[8] = PyTuple_GET_ITEM(__pyx_args, 8);
        case  8: values[7] = PyTuple_GET_ITEM(__pyx_args, 7);
        case  7: values[6] = PyTuple_GET_ITEM(__pyx_args, 6);
        case  6: values[5] = PyTuple_GET_ITEM(__pyx_args, 5);
        case  5: values[4] = PyTuple_GET_ITEM(__pyx_args, 4);
        case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = PyDict_Size(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_nx)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        case  1:
        if (likely((values[1] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_ny)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("create_transform_maps", 1, 13, 13, 1); __PYX_ERR(0, 252, __pyx_L3_error)
        }
        case  2:
        if (likely((values[2] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_dx)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("create_transform_maps", 1, 13, 13, 2); __PYX_ERR(0, 252, __pyx_L3_error)
        }
        case  3:
        if (likely((values[3] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_dy)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("create_transform_maps", 1, 13, 13, 3); __PYX_ERR(0, 252, __pyx_L3_error)
        }
        case  4:
        if (likely((values[4] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_dr)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("create_transform_maps", 1, 13, 13, 4); __PYX_ERR(0, 252, __pyx_L3_error)
        }
        case  5:
        if (likely((values[5] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_da)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("create_transform_maps", 1, 13, 13, 5); __PYX_ERR(0, 252, __pyx_L3_error)
        }
        case  6:
        if (likely((values[6] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_db)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("create_transform_maps", 1, 13, 13, 6); __PYX_ERR(0, 252, __pyx_L3_error)
        }
        case  7:
        if (likely((values[7] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_xrc)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("create_transform_maps", 1, 13, 13, 7); __PYX_ERR(0, 252, __pyx_L3_error)
        }
        case  8:
        if (likely((values[8] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_yrc)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("create_transform_maps", 1, 13, 13, 8); __PYX_ERR(0, 252, __pyx_L3_error)
        }
        case  9:
        if (likely((values[9] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_zx)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("create_transform_maps", 1, 13, 13, 9); __PYX_ERR(0, 252, __pyx_L3_error)
        }
        case 10:
        if (likely((values[10] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_zy)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("create_transform_maps", 1, 13, 13, 10); __PYX_ERR(0, 252, __pyx_L3_error)
        }
        case 11:
        if (likely((values[11] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_sip_A)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("create_transform_maps", 1, 13, 13, 11); __PYX_ERR(0, 252, __pyx_L3_error)
        }
        case 12:
        if (likely((values[12] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_sip_B)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("create_transform_maps", 1, 13, 13, 12); __PYX_ERR(0, 252, __pyx_L3_error)
        }
      }
      if (unlikely(kw_args > 0)) {
        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "create_transform_maps") < 0)) __PYX_ERR(0, 252, __pyx_L3_error)
      }
    } else if (PyTuple_GET_SIZE(__pyx_args) != 13) {
      goto __pyx_L5_argtuple_error;
    } else {
      values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
      values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
      values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
      values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
      values[4] = PyTuple_GET_ITEM(__pyx_args, 4);
      values[5] = PyTuple_GET_ITEM(__pyx_args, 5);
      values[6] = PyTuple_GET_ITEM(__pyx_args, 6);
      values[7] = PyTuple_GET_ITEM(__pyx_args, 7);
      values[8] = PyTuple_GET_ITEM(__pyx_args, 8);
      values[9] = PyTuple_GET_ITEM(__pyx_args, 9);
      values[10] = PyTuple_GET_ITEM(__pyx_args, 10);
      values[11] = PyTuple_GET_ITEM(__pyx_args, 11);
      values[12] = PyTuple_GET_ITEM(__pyx_args, 12);
    }
    __pyx_v_nx = __Pyx_PyInt_As_int(values[0]); if (unlikely((__pyx_v_nx == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 252, __pyx_L3_error)
    __pyx_v_ny = __Pyx_PyInt_As_int(values[1]); if (unlikely((__pyx_v_ny == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 252, __pyx_L3_error)
    __pyx_v_dx = __pyx_PyFloat_AsDouble(values[2]); if (unlikely((__pyx_v_dx == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 252, __pyx_L3_error)
    __pyx_v_dy = __pyx_PyFloat_AsDouble(values[3]); if (unlikely((__pyx_v_dy == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 252, __pyx_L3_error)
    __pyx_v_dr = __pyx_PyFloat_AsDouble(values[4]); if (unlikely((__pyx_v_dr == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 253, __pyx_L3_error)
    __pyx_v_da = __pyx_PyFloat_AsDouble(values[5]); if (unlikely((__pyx_v_da == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 253, __pyx_L3_error)
    __pyx_v_db = __pyx_PyFloat_AsDouble(values[6]); if (unlikely((__pyx_v_db == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 253, __pyx_L3_error)
    __pyx_v_xrc = __pyx_PyFloat_AsDouble(values[7]); if (unlikely((__pyx_v_xrc == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 253, __pyx_L3_error)
    __pyx_v_yrc = __pyx_PyFloat_AsDouble(values[8]); if (unlikely((__pyx_v_yrc == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 254, __pyx_L3_error)
    __pyx_v_zx = __pyx_PyFloat_AsDouble(values[9]); if (unlikely((__pyx_v_zx == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 254, __pyx_L3_error)
    __pyx_v_zy = __pyx_PyFloat_AsDouble(values[10]); if (unlikely((__pyx_v_zy == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 254, __pyx_L3_error)
    __pyx_v_sip_A = values[11];
    __pyx_v_sip_B = values[12];
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  __Pyx_RaiseArgtupleInvalid("create_transform_maps", 1, 13, 13, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 252, __pyx_L3_error)
  __pyx_L3_error:;
  __Pyx_AddTraceback("orb.cutils.create_transform_maps", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __Pyx_RefNannyFinishContext();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  __pyx_r = __pyx_pf_3orb_6cutils_10create_transform_maps(__pyx_self, __pyx_v_nx, __pyx_v_ny, __pyx_v_dx, __pyx_v_dy, __pyx_v_dr, __pyx_v_da, __pyx_v_db, __pyx_v_xrc, __pyx_v_yrc, __pyx_v_zx, __pyx_v_zy, __pyx_v_sip_A, __pyx_v_sip_B);

  /* function exit code */
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_10create_transform_maps(CYTHON_UNUSED PyObject *__pyx_self, int __pyx_v_nx, int __pyx_v_ny, double __pyx_v_dx, double __pyx_v_dy, double __pyx_v_dr, double __pyx_v_da, double __pyx_v_db, double __pyx_v_xrc, double __pyx_v_yrc, double __pyx_v_zx, double __pyx_v_zy, PyObject *__pyx_v_sip_A, PyObject *__pyx_v_sip_B) {
  PyArrayObject *__pyx_v_outx = 0;
  PyArrayObject *__pyx_v_outy = 0;
  PyArrayObject *__pyx_v_coords = 0;
  int __pyx_v_ii;
  int __pyx_v_ij;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_coords;
  __Pyx_Buffer __pyx_pybuffer_coords;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_outx;
  __Pyx_Buffer __pyx_pybuffer_outx;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_outy;
  __Pyx_Buffer __pyx_pybuffer_outy;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  PyObject *__pyx_t_1 = NULL;
  PyObject *__pyx_t_2 = NULL;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  PyObject *__pyx_t_5 = NULL;
  PyArrayObject *__pyx_t_6 = NULL;
  PyArrayObject *__pyx_t_7 = NULL;
  PyArrayObject *__pyx_t_8 = NULL;
  int __pyx_t_9;
  int __pyx_t_10;
  PyObject *(*__pyx_t_11)(PyObject *);
  int __pyx_t_12;
  PyObject *__pyx_t_13 = NULL;
  PyObject *__pyx_t_14 = NULL;
  PyObject *__pyx_t_15 = NULL;
  Py_ssize_t __pyx_t_16;
  PyObject *__pyx_t_17 = NULL;
  int __pyx_t_18;
  int __pyx_t_19;
  int __pyx_t_20;
  PyObject *__pyx_t_21 = NULL;
  PyObject *__pyx_t_22 = NULL;
  PyObject *__pyx_t_23 = NULL;
  PyObject *__pyx_t_24 = NULL;
  PyObject *__pyx_t_25 = NULL;
  PyObject *__pyx_t_26 = NULL;
  PyObject *__pyx_t_27 = NULL;
  PyObject *__pyx_t_28 = NULL;
  PyObject *__pyx_t_29 = NULL;
  __pyx_t_5numpy_float64_t __pyx_t_30;
  __pyx_t_5numpy_float64_t __pyx_t_31;
  Py_ssize_t __pyx_t_32;
  Py_ssize_t __pyx_t_33;
  Py_ssize_t __pyx_t_34;
  Py_ssize_t __pyx_t_35;
  Py_ssize_t __pyx_t_36;
  Py_ssize_t __pyx_t_37;
  Py_ssize_t __pyx_t_38;
  Py_ssize_t __pyx_t_39;
  Py_ssize_t __pyx_t_40;
  Py_ssize_t __pyx_t_41;
  Py_ssize_t __pyx_t_42;
  Py_ssize_t __pyx_t_43;
  __Pyx_RefNannySetupContext("create_transform_maps", 0);
  __pyx_pybuffer_outx.pybuffer.buf = NULL;
  __pyx_pybuffer_outx.refcount = 0;
  __pyx_pybuffernd_outx.data = NULL;
  __pyx_pybuffernd_outx.rcbuffer = &__pyx_pybuffer_outx;
  __pyx_pybuffer_outy.pybuffer.buf = NULL;
  __pyx_pybuffer_outy.refcount = 0;
  __pyx_pybuffernd_outy.data = NULL;
  __pyx_pybuffernd_outy.rcbuffer = &__pyx_pybuffer_outy;
  __pyx_pybuffer_coords.pybuffer.buf = NULL;
  __pyx_pybuffer_coords.refcount = 0;
  __pyx_pybuffernd_coords.data = NULL;
  __pyx_pybuffernd_coords.rcbuffer = &__pyx_pybuffer_coords;

  /* "orb/cutils.pyx":276
 *     """
 * 
 *     cdef np.ndarray[np.float64_t, ndim=2] outx = np.zeros(             # <<<<<<<<<<<<<<
 *         (nx, ny), dtype=np.float64)
 *     cdef np.ndarray[np.float64_t, ndim=2] outy = np.zeros(
 */
  __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 276, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_zeros); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 276, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":277
 * 
 *     cdef np.ndarray[np.float64_t, ndim=2] outx = np.zeros(
 *         (nx, ny), dtype=np.float64)             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.float64_t, ndim=2] outy = np.zeros(
 *         (nx, ny), dtype=np.float64)
 */
  __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_nx); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 277, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_3 = __Pyx_PyInt_From_int(__pyx_v_ny); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 277, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_4 = PyTuple_New(2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 277, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_GIVEREF(__pyx_t_1);
  PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_1);
  __Pyx_GIVEREF(__pyx_t_3);
  PyTuple_SET_ITEM(__pyx_t_4, 1, __pyx_t_3);
  __pyx_t_1 = 0;
  __pyx_t_3 = 0;

  /* "orb/cutils.pyx":276
 *     """
 * 
 *     cdef np.ndarray[np.float64_t, ndim=2] outx = np.zeros(             # <<<<<<<<<<<<<<
 *         (nx, ny), dtype=np.float64)
 *     cdef np.ndarray[np.float64_t, ndim=2] outy = np.zeros(
 */
  __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 276, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_GIVEREF(__pyx_t_4);
  PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_4);
  __pyx_t_4 = 0;

  /* "orb/cutils.pyx":277
 * 
 *     cdef np.ndarray[np.float64_t, ndim=2] outx = np.zeros(
 *         (nx, ny), dtype=np.float64)             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.float64_t, ndim=2] outy = np.zeros(
 *         (nx, ny), dtype=np.float64)
 */
  __pyx_t_4 = PyDict_New(); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 277, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 277, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_float64); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 277, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  if (PyDict_SetItem(__pyx_t_4, __pyx_n_s_dtype, __pyx_t_5) < 0) __PYX_ERR(0, 277, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

  /* "orb/cutils.pyx":276
 *     """
 * 
 *     cdef np.ndarray[np.float64_t, ndim=2] outx = np.zeros(             # <<<<<<<<<<<<<<
 *         (nx, ny), dtype=np.float64)
 *     cdef np.ndarray[np.float64_t, ndim=2] outy = np.zeros(
 */
  __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_3, __pyx_t_4); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 276, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  if (!(likely(((__pyx_t_5) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_5, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 276, __pyx_L1_error)
  __pyx_t_6 = ((PyArrayObject *)__pyx_t_5);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_outx.rcbuffer->pybuffer, (PyObject*)__pyx_t_6, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 2, 0, __pyx_stack) == -1)) {
      __pyx_v_outx = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_outx.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 276, __pyx_L1_error)
    } else {__pyx_pybuffernd_outx.diminfo[0].strides = __pyx_pybuffernd_outx.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_outx.diminfo[0].shape = __pyx_pybuffernd_outx.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_outx.diminfo[1].strides = __pyx_pybuffernd_outx.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_outx.diminfo[1].shape = __pyx_pybuffernd_outx.rcbuffer->pybuffer.shape[1];
    }
  }
  __pyx_t_6 = 0;
  __pyx_v_outx = ((PyArrayObject *)__pyx_t_5);
  __pyx_t_5 = 0;

  /* "orb/cutils.pyx":278
 *     cdef np.ndarray[np.float64_t, ndim=2] outx = np.zeros(
 *         (nx, ny), dtype=np.float64)
 *     cdef np.ndarray[np.float64_t, ndim=2] outy = np.zeros(             # <<<<<<<<<<<<<<
 *         (nx, ny), dtype=np.float64)
 * 
 */
  __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 278, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_zeros); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 278, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

  /* "orb/cutils.pyx":279
 *         (nx, ny), dtype=np.float64)
 *     cdef np.ndarray[np.float64_t, ndim=2] outy = np.zeros(
 *         (nx, ny), dtype=np.float64)             # <<<<<<<<<<<<<<
 * 
 *     cdef np.ndarray[np.float64_t, ndim=2] coords = np.zeros(
 */
  __pyx_t_5 = __Pyx_PyInt_From_int(__pyx_v_nx); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 279, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_3 = __Pyx_PyInt_From_int(__pyx_v_ny); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 279, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_2 = PyTuple_New(2); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 279, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_GIVEREF(__pyx_t_5);
  PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_5);
  __Pyx_GIVEREF(__pyx_t_3);
  PyTuple_SET_ITEM(__pyx_t_2, 1, __pyx_t_3);
  __pyx_t_5 = 0;
  __pyx_t_3 = 0;

  /* "orb/cutils.pyx":278
 *     cdef np.ndarray[np.float64_t, ndim=2] outx = np.zeros(
 *         (nx, ny), dtype=np.float64)
 *     cdef np.ndarray[np.float64_t, ndim=2] outy = np.zeros(             # <<<<<<<<<<<<<<
 *         (nx, ny), dtype=np.float64)
 * 
 */
  __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 278, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_GIVEREF(__pyx_t_2);
  PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_2);
  __pyx_t_2 = 0;

  /* "orb/cutils.pyx":279
 *         (nx, ny), dtype=np.float64)
 *     cdef np.ndarray[np.float64_t, ndim=2] outy = np.zeros(
 *         (nx, ny), dtype=np.float64)             # <<<<<<<<<<<<<<
 * 
 *     cdef np.ndarray[np.float64_t, ndim=2] coords = np.zeros(
 */
  __pyx_t_2 = PyDict_New(); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 279, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 279, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_float64); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 279, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  if (PyDict_SetItem(__pyx_t_2, __pyx_n_s_dtype, __pyx_t_1) < 0) __PYX_ERR(0, 279, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":278
 *     cdef np.ndarray[np.float64_t, ndim=2] outx = np.zeros(
 *         (nx, ny), dtype=np.float64)
 *     cdef np.ndarray[np.float64_t, ndim=2] outy = np.zeros(             # <<<<<<<<<<<<<<
 *         (nx, ny), dtype=np.float64)
 * 
 */
  __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_3, __pyx_t_2); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 278, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 278, __pyx_L1_error)
  __pyx_t_7 = ((PyArrayObject *)__pyx_t_1);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_outy.rcbuffer->pybuffer, (PyObject*)__pyx_t_7, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 2, 0, __pyx_stack) == -1)) {
      __pyx_v_outy = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_outy.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 278, __pyx_L1_error)
    } else {__pyx_pybuffernd_outy.diminfo[0].strides = __pyx_pybuffernd_outy.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_outy.diminfo[0].shape = __pyx_pybuffernd_outy.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_outy.diminfo[1].strides = __pyx_pybuffernd_outy.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_outy.diminfo[1].shape = __pyx_pybuffernd_outy.rcbuffer->pybuffer.shape[1];
    }
  }
  __pyx_t_7 = 0;
  __pyx_v_outy = ((PyArrayObject *)__pyx_t_1);
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":281
 *         (nx, ny), dtype=np.float64)
 * 
 *     cdef np.ndarray[np.float64_t, ndim=2] coords = np.zeros(             # <<<<<<<<<<<<<<
 *         (nx*ny, 2), dtype=np.float64)
 * 
 */
  __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 281, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_zeros); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 281, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":282
 * 
 *     cdef np.ndarray[np.float64_t, ndim=2] coords = np.zeros(
 *         (nx*ny, 2), dtype=np.float64)             # <<<<<<<<<<<<<<
 * 
 *     cdef int ii, ij
 */
  __pyx_t_1 = __Pyx_PyInt_From_int((__pyx_v_nx * __pyx_v_ny)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 282, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_3 = PyTuple_New(2); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 282, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_GIVEREF(__pyx_t_1);
  PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_1);
  __Pyx_INCREF(__pyx_int_2);
  __Pyx_GIVEREF(__pyx_int_2);
  PyTuple_SET_ITEM(__pyx_t_3, 1, __pyx_int_2);
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":281
 *         (nx, ny), dtype=np.float64)
 * 
 *     cdef np.ndarray[np.float64_t, ndim=2] coords = np.zeros(             # <<<<<<<<<<<<<<
 *         (nx*ny, 2), dtype=np.float64)
 * 
 */
  __pyx_t_1 = PyTuple_New(1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 281, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_GIVEREF(__pyx_t_3);
  PyTuple_SET_ITEM(__pyx_t_1, 0, __pyx_t_3);
  __pyx_t_3 = 0;

  /* "orb/cutils.pyx":282
 * 
 *     cdef np.ndarray[np.float64_t, ndim=2] coords = np.zeros(
 *         (nx*ny, 2), dtype=np.float64)             # <<<<<<<<<<<<<<
 * 
 *     cdef int ii, ij
 */
  __pyx_t_3 = PyDict_New(); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 282, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 282, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_float64); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 282, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  if (PyDict_SetItem(__pyx_t_3, __pyx_n_s_dtype, __pyx_t_5) < 0) __PYX_ERR(0, 282, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

  /* "orb/cutils.pyx":281
 *         (nx, ny), dtype=np.float64)
 * 
 *     cdef np.ndarray[np.float64_t, ndim=2] coords = np.zeros(             # <<<<<<<<<<<<<<
 *         (nx*ny, 2), dtype=np.float64)
 * 
 */
  __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_1, __pyx_t_3); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 281, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  if (!(likely(((__pyx_t_5) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_5, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 281, __pyx_L1_error)
  __pyx_t_8 = ((PyArrayObject *)__pyx_t_5);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_coords.rcbuffer->pybuffer, (PyObject*)__pyx_t_8, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
      __pyx_v_coords = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_coords.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 281, __pyx_L1_error)
    } else {__pyx_pybuffernd_coords.diminfo[0].strides = __pyx_pybuffernd_coords.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_coords.diminfo[0].shape = __pyx_pybuffernd_coords.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_coords.diminfo[1].strides = __pyx_pybuffernd_coords.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_coords.diminfo[1].shape = __pyx_pybuffernd_coords.rcbuffer->pybuffer.shape[1];
    }
  }
  __pyx_t_8 = 0;
  __pyx_v_coords = ((PyArrayObject *)__pyx_t_5);
  __pyx_t_5 = 0;

  /* "orb/cutils.pyx":287
 * 
 * 
 *     if sip_A is not None:             # <<<<<<<<<<<<<<
 *         outx, outy = np.mgrid[0:nx:1, 0:ny:1].astype(np.float64)
 *         coords[:,0] = outx.flatten()
 */
  __pyx_t_9 = (__pyx_v_sip_A != Py_None);
  __pyx_t_10 = (__pyx_t_9 != 0);
  if (__pyx_t_10) {

    /* "orb/cutils.pyx":288
 * 
 *     if sip_A is not None:
 *         outx, outy = np.mgrid[0:nx:1, 0:ny:1].astype(np.float64)             # <<<<<<<<<<<<<<
 *         coords[:,0] = outx.flatten()
 *         coords[:,1] = outy.flatten()
 */
    __pyx_t_3 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 288, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_mgrid); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 288, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __pyx_t_3 = __Pyx_PyInt_From_int(__pyx_v_nx); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 288, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __pyx_t_2 = PySlice_New(__pyx_int_0, __pyx_t_3, __pyx_int_1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 288, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __pyx_t_3 = __Pyx_PyInt_From_int(__pyx_v_ny); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 288, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __pyx_t_4 = PySlice_New(__pyx_int_0, __pyx_t_3, __pyx_int_1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 288, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __pyx_t_3 = PyTuple_New(2); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 288, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_GIVEREF(__pyx_t_2);
    PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_2);
    __Pyx_GIVEREF(__pyx_t_4);
    PyTuple_SET_ITEM(__pyx_t_3, 1, __pyx_t_4);
    __pyx_t_2 = 0;
    __pyx_t_4 = 0;
    __pyx_t_4 = PyObject_GetItem(__pyx_t_1, __pyx_t_3); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 288, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_astype); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 288, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 288, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_float64); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 288, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_t_4 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && likely(PyMethod_Check(__pyx_t_3))) {
      __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_3);
      if (likely(__pyx_t_4)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
        __Pyx_INCREF(__pyx_t_4);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_3, function);
      }
    }
    if (!__pyx_t_4) {
      __pyx_t_5 = __Pyx_PyObject_CallOneArg(__pyx_t_3, __pyx_t_1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 288, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
      __Pyx_GOTREF(__pyx_t_5);
    } else {
      __pyx_t_2 = PyTuple_New(1+1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 288, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_4); __pyx_t_4 = NULL;
      __Pyx_GIVEREF(__pyx_t_1);
      PyTuple_SET_ITEM(__pyx_t_2, 0+1, __pyx_t_1);
      __pyx_t_1 = 0;
      __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_2, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 288, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    }
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    if ((likely(PyTuple_CheckExact(__pyx_t_5))) || (PyList_CheckExact(__pyx_t_5))) {
      PyObject* sequence = __pyx_t_5;
      #if CYTHON_COMPILING_IN_CPYTHON
      Py_ssize_t size = Py_SIZE(sequence);
      #else
      Py_ssize_t size = PySequence_Size(sequence);
      #endif
      if (unlikely(size != 2)) {
        if (size > 2) __Pyx_RaiseTooManyValuesError(2);
        else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
        __PYX_ERR(0, 288, __pyx_L1_error)
      }
      #if CYTHON_COMPILING_IN_CPYTHON
      if (likely(PyTuple_CheckExact(sequence))) {
        __pyx_t_3 = PyTuple_GET_ITEM(sequence, 0); 
        __pyx_t_2 = PyTuple_GET_ITEM(sequence, 1); 
      } else {
        __pyx_t_3 = PyList_GET_ITEM(sequence, 0); 
        __pyx_t_2 = PyList_GET_ITEM(sequence, 1); 
      }
      __Pyx_INCREF(__pyx_t_3);
      __Pyx_INCREF(__pyx_t_2);
      #else
      __pyx_t_3 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 288, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __pyx_t_2 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 288, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      #endif
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    } else {
      Py_ssize_t index = -1;
      __pyx_t_1 = PyObject_GetIter(__pyx_t_5); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 288, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
      __pyx_t_11 = Py_TYPE(__pyx_t_1)->tp_iternext;
      index = 0; __pyx_t_3 = __pyx_t_11(__pyx_t_1); if (unlikely(!__pyx_t_3)) goto __pyx_L4_unpacking_failed;
      __Pyx_GOTREF(__pyx_t_3);
      index = 1; __pyx_t_2 = __pyx_t_11(__pyx_t_1); if (unlikely(!__pyx_t_2)) goto __pyx_L4_unpacking_failed;
      __Pyx_GOTREF(__pyx_t_2);
      if (__Pyx_IternextUnpackEndCheck(__pyx_t_11(__pyx_t_1), 2) < 0) __PYX_ERR(0, 288, __pyx_L1_error)
      __pyx_t_11 = NULL;
      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
      goto __pyx_L5_unpacking_done;
      __pyx_L4_unpacking_failed:;
      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
      __pyx_t_11 = NULL;
      if (__Pyx_IterFinish() == 0) __Pyx_RaiseNeedMoreValuesError(index);
      __PYX_ERR(0, 288, __pyx_L1_error)
      __pyx_L5_unpacking_done:;
    }
    if (!(likely(((__pyx_t_3) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_3, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 288, __pyx_L1_error)
    if (!(likely(((__pyx_t_2) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_2, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 288, __pyx_L1_error)
    __pyx_t_6 = ((PyArrayObject *)__pyx_t_3);
    {
      __Pyx_BufFmt_StackElem __pyx_stack[1];
      __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_outx.rcbuffer->pybuffer);
      __pyx_t_12 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_outx.rcbuffer->pybuffer, (PyObject*)__pyx_t_6, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 2, 0, __pyx_stack);
      if (unlikely(__pyx_t_12 < 0)) {
        PyErr_Fetch(&__pyx_t_13, &__pyx_t_14, &__pyx_t_15);
        if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_outx.rcbuffer->pybuffer, (PyObject*)__pyx_v_outx, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 2, 0, __pyx_stack) == -1)) {
          Py_XDECREF(__pyx_t_13); Py_XDECREF(__pyx_t_14); Py_XDECREF(__pyx_t_15);
          __Pyx_RaiseBufferFallbackError();
        } else {
          PyErr_Restore(__pyx_t_13, __pyx_t_14, __pyx_t_15);
        }
      }
      __pyx_pybuffernd_outx.diminfo[0].strides = __pyx_pybuffernd_outx.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_outx.diminfo[0].shape = __pyx_pybuffernd_outx.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_outx.diminfo[1].strides = __pyx_pybuffernd_outx.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_outx.diminfo[1].shape = __pyx_pybuffernd_outx.rcbuffer->pybuffer.shape[1];
      if (unlikely(__pyx_t_12 < 0)) __PYX_ERR(0, 288, __pyx_L1_error)
    }
    __pyx_t_6 = 0;
    __Pyx_DECREF_SET(__pyx_v_outx, ((PyArrayObject *)__pyx_t_3));
    __pyx_t_3 = 0;
    __pyx_t_7 = ((PyArrayObject *)__pyx_t_2);
    {
      __Pyx_BufFmt_StackElem __pyx_stack[1];
      __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_outy.rcbuffer->pybuffer);
      __pyx_t_12 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_outy.rcbuffer->pybuffer, (PyObject*)__pyx_t_7, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 2, 0, __pyx_stack);
      if (unlikely(__pyx_t_12 < 0)) {
        PyErr_Fetch(&__pyx_t_15, &__pyx_t_14, &__pyx_t_13);
        if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_outy.rcbuffer->pybuffer, (PyObject*)__pyx_v_outy, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 2, 0, __pyx_stack) == -1)) {
          Py_XDECREF(__pyx_t_15); Py_XDECREF(__pyx_t_14); Py_XDECREF(__pyx_t_13);
          __Pyx_RaiseBufferFallbackError();
        } else {
          PyErr_Restore(__pyx_t_15, __pyx_t_14, __pyx_t_13);
        }
      }
      __pyx_pybuffernd_outy.diminfo[0].strides = __pyx_pybuffernd_outy.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_outy.diminfo[0].shape = __pyx_pybuffernd_outy.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_outy.diminfo[1].strides = __pyx_pybuffernd_outy.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_outy.diminfo[1].shape = __pyx_pybuffernd_outy.rcbuffer->pybuffer.shape[1];
      if (unlikely(__pyx_t_12 < 0)) __PYX_ERR(0, 288, __pyx_L1_error)
    }
    __pyx_t_7 = 0;
    __Pyx_DECREF_SET(__pyx_v_outy, ((PyArrayObject *)__pyx_t_2));
    __pyx_t_2 = 0;

    /* "orb/cutils.pyx":289
 *     if sip_A is not None:
 *         outx, outy = np.mgrid[0:nx:1, 0:ny:1].astype(np.float64)
 *         coords[:,0] = outx.flatten()             # <<<<<<<<<<<<<<
 *         coords[:,1] = outy.flatten()
 *         coords = sip_pix2im(coords, sip_A)
 */
    __pyx_t_2 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_outx), __pyx_n_s_flatten); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 289, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __pyx_t_3 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && likely(PyMethod_Check(__pyx_t_2))) {
      __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_2);
      if (likely(__pyx_t_3)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
        __Pyx_INCREF(__pyx_t_3);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_2, function);
      }
    }
    if (__pyx_t_3) {
      __pyx_t_5 = __Pyx_PyObject_CallOneArg(__pyx_t_2, __pyx_t_3); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 289, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    } else {
      __pyx_t_5 = __Pyx_PyObject_CallNoArg(__pyx_t_2); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 289, __pyx_L1_error)
    }
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    if (unlikely(PyObject_SetItem(((PyObject *)__pyx_v_coords), __pyx_tuple__10, __pyx_t_5) < 0)) __PYX_ERR(0, 289, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

    /* "orb/cutils.pyx":290
 *         outx, outy = np.mgrid[0:nx:1, 0:ny:1].astype(np.float64)
 *         coords[:,0] = outx.flatten()
 *         coords[:,1] = outy.flatten()             # <<<<<<<<<<<<<<
 *         coords = sip_pix2im(coords, sip_A)
 *         outx = np.reshape(coords[:,0], [outx.shape[0], outx.shape[1]])
 */
    __pyx_t_2 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_outy), __pyx_n_s_flatten); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 290, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __pyx_t_3 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && likely(PyMethod_Check(__pyx_t_2))) {
      __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_2);
      if (likely(__pyx_t_3)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
        __Pyx_INCREF(__pyx_t_3);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_2, function);
      }
    }
    if (__pyx_t_3) {
      __pyx_t_5 = __Pyx_PyObject_CallOneArg(__pyx_t_2, __pyx_t_3); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 290, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    } else {
      __pyx_t_5 = __Pyx_PyObject_CallNoArg(__pyx_t_2); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 290, __pyx_L1_error)
    }
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    if (unlikely(PyObject_SetItem(((PyObject *)__pyx_v_coords), __pyx_tuple__12, __pyx_t_5) < 0)) __PYX_ERR(0, 290, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

    /* "orb/cutils.pyx":291
 *         coords[:,0] = outx.flatten()
 *         coords[:,1] = outy.flatten()
 *         coords = sip_pix2im(coords, sip_A)             # <<<<<<<<<<<<<<
 *         outx = np.reshape(coords[:,0], [outx.shape[0], outx.shape[1]])
 *         outy = np.reshape(coords[:,1], [outy.shape[0], outy.shape[1]])
 */
    __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_sip_pix2im); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 291, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __pyx_t_3 = NULL;
    __pyx_t_16 = 0;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_2))) {
      __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_2);
      if (likely(__pyx_t_3)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
        __Pyx_INCREF(__pyx_t_3);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_2, function);
        __pyx_t_16 = 1;
      }
    }
    __pyx_t_1 = PyTuple_New(2+__pyx_t_16); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 291, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    if (__pyx_t_3) {
      __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_1, 0, __pyx_t_3); __pyx_t_3 = NULL;
    }
    __Pyx_INCREF(((PyObject *)__pyx_v_coords));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_coords));
    PyTuple_SET_ITEM(__pyx_t_1, 0+__pyx_t_16, ((PyObject *)__pyx_v_coords));
    __Pyx_INCREF(__pyx_v_sip_A);
    __Pyx_GIVEREF(__pyx_v_sip_A);
    PyTuple_SET_ITEM(__pyx_t_1, 1+__pyx_t_16, __pyx_v_sip_A);
    __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_1, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 291, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    if (!(likely(((__pyx_t_5) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_5, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 291, __pyx_L1_error)
    __pyx_t_8 = ((PyArrayObject *)__pyx_t_5);
    {
      __Pyx_BufFmt_StackElem __pyx_stack[1];
      __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_coords.rcbuffer->pybuffer);
      __pyx_t_12 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_coords.rcbuffer->pybuffer, (PyObject*)__pyx_t_8, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
      if (unlikely(__pyx_t_12 < 0)) {
        PyErr_Fetch(&__pyx_t_13, &__pyx_t_14, &__pyx_t_15);
        if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_coords.rcbuffer->pybuffer, (PyObject*)__pyx_v_coords, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
          Py_XDECREF(__pyx_t_13); Py_XDECREF(__pyx_t_14); Py_XDECREF(__pyx_t_15);
          __Pyx_RaiseBufferFallbackError();
        } else {
          PyErr_Restore(__pyx_t_13, __pyx_t_14, __pyx_t_15);
        }
      }
      __pyx_pybuffernd_coords.diminfo[0].strides = __pyx_pybuffernd_coords.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_coords.diminfo[0].shape = __pyx_pybuffernd_coords.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_coords.diminfo[1].strides = __pyx_pybuffernd_coords.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_coords.diminfo[1].shape = __pyx_pybuffernd_coords.rcbuffer->pybuffer.shape[1];
      if (unlikely(__pyx_t_12 < 0)) __PYX_ERR(0, 291, __pyx_L1_error)
    }
    __pyx_t_8 = 0;
    __Pyx_DECREF_SET(__pyx_v_coords, ((PyArrayObject *)__pyx_t_5));
    __pyx_t_5 = 0;

    /* "orb/cutils.pyx":292
 *         coords[:,1] = outy.flatten()
 *         coords = sip_pix2im(coords, sip_A)
 *         outx = np.reshape(coords[:,0], [outx.shape[0], outx.shape[1]])             # <<<<<<<<<<<<<<
 *         outy = np.reshape(coords[:,1], [outy.shape[0], outy.shape[1]])
 * 
 */
    __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 292, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_reshape); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 292, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __pyx_t_2 = PyObject_GetItem(((PyObject *)__pyx_v_coords), __pyx_tuple__14); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 292, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __pyx_t_3 = __Pyx_PyInt_From_Py_intptr_t((__pyx_v_outx->dimensions[0])); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 292, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __pyx_t_4 = __Pyx_PyInt_From_Py_intptr_t((__pyx_v_outx->dimensions[1])); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 292, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __pyx_t_17 = PyList_New(2); if (unlikely(!__pyx_t_17)) __PYX_ERR(0, 292, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_17);
    __Pyx_GIVEREF(__pyx_t_3);
    PyList_SET_ITEM(__pyx_t_17, 0, __pyx_t_3);
    __Pyx_GIVEREF(__pyx_t_4);
    PyList_SET_ITEM(__pyx_t_17, 1, __pyx_t_4);
    __pyx_t_3 = 0;
    __pyx_t_4 = 0;
    __pyx_t_4 = NULL;
    __pyx_t_16 = 0;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_1))) {
      __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_1);
      if (likely(__pyx_t_4)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_1);
        __Pyx_INCREF(__pyx_t_4);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_1, function);
        __pyx_t_16 = 1;
      }
    }
    __pyx_t_3 = PyTuple_New(2+__pyx_t_16); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 292, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    if (__pyx_t_4) {
      __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_4); __pyx_t_4 = NULL;
    }
    __Pyx_GIVEREF(__pyx_t_2);
    PyTuple_SET_ITEM(__pyx_t_3, 0+__pyx_t_16, __pyx_t_2);
    __Pyx_GIVEREF(__pyx_t_17);
    PyTuple_SET_ITEM(__pyx_t_3, 1+__pyx_t_16, __pyx_t_17);
    __pyx_t_2 = 0;
    __pyx_t_17 = 0;
    __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_1, __pyx_t_3, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 292, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    if (!(likely(((__pyx_t_5) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_5, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 292, __pyx_L1_error)
    __pyx_t_6 = ((PyArrayObject *)__pyx_t_5);
    {
      __Pyx_BufFmt_StackElem __pyx_stack[1];
      __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_outx.rcbuffer->pybuffer);
      __pyx_t_12 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_outx.rcbuffer->pybuffer, (PyObject*)__pyx_t_6, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 2, 0, __pyx_stack);
      if (unlikely(__pyx_t_12 < 0)) {
        PyErr_Fetch(&__pyx_t_15, &__pyx_t_14, &__pyx_t_13);
        if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_outx.rcbuffer->pybuffer, (PyObject*)__pyx_v_outx, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 2, 0, __pyx_stack) == -1)) {
          Py_XDECREF(__pyx_t_15); Py_XDECREF(__pyx_t_14); Py_XDECREF(__pyx_t_13);
          __Pyx_RaiseBufferFallbackError();
        } else {
          PyErr_Restore(__pyx_t_15, __pyx_t_14, __pyx_t_13);
        }
      }
      __pyx_pybuffernd_outx.diminfo[0].strides = __pyx_pybuffernd_outx.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_outx.diminfo[0].shape = __pyx_pybuffernd_outx.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_outx.diminfo[1].strides = __pyx_pybuffernd_outx.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_outx.diminfo[1].shape = __pyx_pybuffernd_outx.rcbuffer->pybuffer.shape[1];
      if (unlikely(__pyx_t_12 < 0)) __PYX_ERR(0, 292, __pyx_L1_error)
    }
    __pyx_t_6 = 0;
    __Pyx_DECREF_SET(__pyx_v_outx, ((PyArrayObject *)__pyx_t_5));
    __pyx_t_5 = 0;

    /* "orb/cutils.pyx":293
 *         coords = sip_pix2im(coords, sip_A)
 *         outx = np.reshape(coords[:,0], [outx.shape[0], outx.shape[1]])
 *         outy = np.reshape(coords[:,1], [outy.shape[0], outy.shape[1]])             # <<<<<<<<<<<<<<
 * 
 * 
 */
    __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 293, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_reshape); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 293, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    __pyx_t_1 = PyObject_GetItem(((PyObject *)__pyx_v_coords), __pyx_tuple__16); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 293, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __pyx_t_17 = __Pyx_PyInt_From_Py_intptr_t((__pyx_v_outy->dimensions[0])); if (unlikely(!__pyx_t_17)) __PYX_ERR(0, 293, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_17);
    __pyx_t_2 = __Pyx_PyInt_From_Py_intptr_t((__pyx_v_outy->dimensions[1])); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 293, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __pyx_t_4 = PyList_New(2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 293, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_GIVEREF(__pyx_t_17);
    PyList_SET_ITEM(__pyx_t_4, 0, __pyx_t_17);
    __Pyx_GIVEREF(__pyx_t_2);
    PyList_SET_ITEM(__pyx_t_4, 1, __pyx_t_2);
    __pyx_t_17 = 0;
    __pyx_t_2 = 0;
    __pyx_t_2 = NULL;
    __pyx_t_16 = 0;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_3))) {
      __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_3);
      if (likely(__pyx_t_2)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
        __Pyx_INCREF(__pyx_t_2);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_3, function);
        __pyx_t_16 = 1;
      }
    }
    __pyx_t_17 = PyTuple_New(2+__pyx_t_16); if (unlikely(!__pyx_t_17)) __PYX_ERR(0, 293, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_17);
    if (__pyx_t_2) {
      __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_17, 0, __pyx_t_2); __pyx_t_2 = NULL;
    }
    __Pyx_GIVEREF(__pyx_t_1);
    PyTuple_SET_ITEM(__pyx_t_17, 0+__pyx_t_16, __pyx_t_1);
    __Pyx_GIVEREF(__pyx_t_4);
    PyTuple_SET_ITEM(__pyx_t_17, 1+__pyx_t_16, __pyx_t_4);
    __pyx_t_1 = 0;
    __pyx_t_4 = 0;
    __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_17, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 293, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_DECREF(__pyx_t_17); __pyx_t_17 = 0;
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    if (!(likely(((__pyx_t_5) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_5, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 293, __pyx_L1_error)
    __pyx_t_7 = ((PyArrayObject *)__pyx_t_5);
    {
      __Pyx_BufFmt_StackElem __pyx_stack[1];
      __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_outy.rcbuffer->pybuffer);
      __pyx_t_12 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_outy.rcbuffer->pybuffer, (PyObject*)__pyx_t_7, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 2, 0, __pyx_stack);
      if (unlikely(__pyx_t_12 < 0)) {
        PyErr_Fetch(&__pyx_t_13, &__pyx_t_14, &__pyx_t_15);
        if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_outy.rcbuffer->pybuffer, (PyObject*)__pyx_v_outy, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 2, 0, __pyx_stack) == -1)) {
          Py_XDECREF(__pyx_t_13); Py_XDECREF(__pyx_t_14); Py_XDECREF(__pyx_t_15);
          __Pyx_RaiseBufferFallbackError();
        } else {
          PyErr_Restore(__pyx_t_13, __pyx_t_14, __pyx_t_15);
        }
      }
      __pyx_pybuffernd_outy.diminfo[0].strides = __pyx_pybuffernd_outy.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_outy.diminfo[0].shape = __pyx_pybuffernd_outy.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_outy.diminfo[1].strides = __pyx_pybuffernd_outy.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_outy.diminfo[1].shape = __pyx_pybuffernd_outy.rcbuffer->pybuffer.shape[1];
      if (unlikely(__pyx_t_12 < 0)) __PYX_ERR(0, 293, __pyx_L1_error)
    }
    __pyx_t_7 = 0;
    __Pyx_DECREF_SET(__pyx_v_outy, ((PyArrayObject *)__pyx_t_5));
    __pyx_t_5 = 0;

    /* "orb/cutils.pyx":287
 * 
 * 
 *     if sip_A is not None:             # <<<<<<<<<<<<<<
 *         outx, outy = np.mgrid[0:nx:1, 0:ny:1].astype(np.float64)
 *         coords[:,0] = outx.flatten()
 */
  }

  /* "orb/cutils.pyx":296
 * 
 * 
 *     for ii in range(nx):             # <<<<<<<<<<<<<<
 *         for ij in range(ny):
 *             if sip_A is None:
 */
  __pyx_t_12 = __pyx_v_nx;
  for (__pyx_t_18 = 0; __pyx_t_18 < __pyx_t_12; __pyx_t_18+=1) {
    __pyx_v_ii = __pyx_t_18;

    /* "orb/cutils.pyx":297
 * 
 *     for ii in range(nx):
 *         for ij in range(ny):             # <<<<<<<<<<<<<<
 *             if sip_A is None:
 *                 outx[ii,ij], outy[ii,ij] = transform_A_to_B(
 */
    __pyx_t_19 = __pyx_v_ny;
    for (__pyx_t_20 = 0; __pyx_t_20 < __pyx_t_19; __pyx_t_20+=1) {
      __pyx_v_ij = __pyx_t_20;

      /* "orb/cutils.pyx":298
 *     for ii in range(nx):
 *         for ij in range(ny):
 *             if sip_A is None:             # <<<<<<<<<<<<<<
 *                 outx[ii,ij], outy[ii,ij] = transform_A_to_B(
 *                     ii, ij, dx, dy, dr, da, db, xrc, yrc, zx, zy)
 */
      __pyx_t_10 = (__pyx_v_sip_A == Py_None);
      __pyx_t_9 = (__pyx_t_10 != 0);
      if (__pyx_t_9) {

        /* "orb/cutils.pyx":299
 *         for ij in range(ny):
 *             if sip_A is None:
 *                 outx[ii,ij], outy[ii,ij] = transform_A_to_B(             # <<<<<<<<<<<<<<
 *                     ii, ij, dx, dy, dr, da, db, xrc, yrc, zx, zy)
 *             else:
 */
        __pyx_t_3 = __Pyx_GetModuleGlobalName(__pyx_n_s_transform_A_to_B); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 299, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_3);

        /* "orb/cutils.pyx":300
 *             if sip_A is None:
 *                 outx[ii,ij], outy[ii,ij] = transform_A_to_B(
 *                     ii, ij, dx, dy, dr, da, db, xrc, yrc, zx, zy)             # <<<<<<<<<<<<<<
 *             else:
 *                 outx[ii,ij], outy[ii,ij] = transform_A_to_B(
 */
        __pyx_t_17 = __Pyx_PyInt_From_int(__pyx_v_ii); if (unlikely(!__pyx_t_17)) __PYX_ERR(0, 300, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_17);
        __pyx_t_4 = __Pyx_PyInt_From_int(__pyx_v_ij); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 300, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_4);
        __pyx_t_1 = PyFloat_FromDouble(__pyx_v_dx); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 300, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_1);
        __pyx_t_2 = PyFloat_FromDouble(__pyx_v_dy); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 300, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_2);
        __pyx_t_21 = PyFloat_FromDouble(__pyx_v_dr); if (unlikely(!__pyx_t_21)) __PYX_ERR(0, 300, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_21);
        __pyx_t_22 = PyFloat_FromDouble(__pyx_v_da); if (unlikely(!__pyx_t_22)) __PYX_ERR(0, 300, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_22);
        __pyx_t_23 = PyFloat_FromDouble(__pyx_v_db); if (unlikely(!__pyx_t_23)) __PYX_ERR(0, 300, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_23);
        __pyx_t_24 = PyFloat_FromDouble(__pyx_v_xrc); if (unlikely(!__pyx_t_24)) __PYX_ERR(0, 300, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_24);
        __pyx_t_25 = PyFloat_FromDouble(__pyx_v_yrc); if (unlikely(!__pyx_t_25)) __PYX_ERR(0, 300, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_25);
        __pyx_t_26 = PyFloat_FromDouble(__pyx_v_zx); if (unlikely(!__pyx_t_26)) __PYX_ERR(0, 300, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_26);
        __pyx_t_27 = PyFloat_FromDouble(__pyx_v_zy); if (unlikely(!__pyx_t_27)) __PYX_ERR(0, 300, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_27);
        __pyx_t_28 = NULL;
        __pyx_t_16 = 0;
        if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_3))) {
          __pyx_t_28 = PyMethod_GET_SELF(__pyx_t_3);
          if (likely(__pyx_t_28)) {
            PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
            __Pyx_INCREF(__pyx_t_28);
            __Pyx_INCREF(function);
            __Pyx_DECREF_SET(__pyx_t_3, function);
            __pyx_t_16 = 1;
          }
        }
        __pyx_t_29 = PyTuple_New(11+__pyx_t_16); if (unlikely(!__pyx_t_29)) __PYX_ERR(0, 299, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_29);
        if (__pyx_t_28) {
          __Pyx_GIVEREF(__pyx_t_28); PyTuple_SET_ITEM(__pyx_t_29, 0, __pyx_t_28); __pyx_t_28 = NULL;
        }
        __Pyx_GIVEREF(__pyx_t_17);
        PyTuple_SET_ITEM(__pyx_t_29, 0+__pyx_t_16, __pyx_t_17);
        __Pyx_GIVEREF(__pyx_t_4);
        PyTuple_SET_ITEM(__pyx_t_29, 1+__pyx_t_16, __pyx_t_4);
        __Pyx_GIVEREF(__pyx_t_1);
        PyTuple_SET_ITEM(__pyx_t_29, 2+__pyx_t_16, __pyx_t_1);
        __Pyx_GIVEREF(__pyx_t_2);
        PyTuple_SET_ITEM(__pyx_t_29, 3+__pyx_t_16, __pyx_t_2);
        __Pyx_GIVEREF(__pyx_t_21);
        PyTuple_SET_ITEM(__pyx_t_29, 4+__pyx_t_16, __pyx_t_21);
        __Pyx_GIVEREF(__pyx_t_22);
        PyTuple_SET_ITEM(__pyx_t_29, 5+__pyx_t_16, __pyx_t_22);
        __Pyx_GIVEREF(__pyx_t_23);
        PyTuple_SET_ITEM(__pyx_t_29, 6+__pyx_t_16, __pyx_t_23);
        __Pyx_GIVEREF(__pyx_t_24);
        PyTuple_SET_ITEM(__pyx_t_29, 7+__pyx_t_16, __pyx_t_24);
        __Pyx_GIVEREF(__pyx_t_25);
        PyTuple_SET_ITEM(__pyx_t_29, 8+__pyx_t_16, __pyx_t_25);
        __Pyx_GIVEREF(__pyx_t_26);
        PyTuple_SET_ITEM(__pyx_t_29, 9+__pyx_t_16, __pyx_t_26);
        __Pyx_GIVEREF(__pyx_t_27);
        PyTuple_SET_ITEM(__pyx_t_29, 10+__pyx_t_16, __pyx_t_27);
        __pyx_t_17 = 0;
        __pyx_t_4 = 0;
        __pyx_t_1 = 0;
        __pyx_t_2 = 0;
        __pyx_t_21 = 0;
        __pyx_t_22 = 0;
        __pyx_t_23 = 0;
        __pyx_t_24 = 0;
        __pyx_t_25 = 0;
        __pyx_t_26 = 0;
        __pyx_t_27 = 0;
        __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_29, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 299, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_5);
        __Pyx_DECREF(__pyx_t_29); __pyx_t_29 = 0;
        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
        if ((likely(PyTuple_CheckExact(__pyx_t_5))) || (PyList_CheckExact(__pyx_t_5))) {
          PyObject* sequence = __pyx_t_5;
          #if CYTHON_COMPILING_IN_CPYTHON
          Py_ssize_t size = Py_SIZE(sequence);
          #else
          Py_ssize_t size = PySequence_Size(sequence);
          #endif
          if (unlikely(size != 2)) {
            if (size > 2) __Pyx_RaiseTooManyValuesError(2);
            else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
            __PYX_ERR(0, 299, __pyx_L1_error)
          }
          #if CYTHON_COMPILING_IN_CPYTHON
          if (likely(PyTuple_CheckExact(sequence))) {
            __pyx_t_3 = PyTuple_GET_ITEM(sequence, 0); 
            __pyx_t_29 = PyTuple_GET_ITEM(sequence, 1); 
          } else {
            __pyx_t_3 = PyList_GET_ITEM(sequence, 0); 
            __pyx_t_29 = PyList_GET_ITEM(sequence, 1); 
          }
          __Pyx_INCREF(__pyx_t_3);
          __Pyx_INCREF(__pyx_t_29);
          #else
          __pyx_t_3 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 299, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_3);
          __pyx_t_29 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_29)) __PYX_ERR(0, 299, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_29);
          #endif
          __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
        } else {
          Py_ssize_t index = -1;
          __pyx_t_27 = PyObject_GetIter(__pyx_t_5); if (unlikely(!__pyx_t_27)) __PYX_ERR(0, 299, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_27);
          __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
          __pyx_t_11 = Py_TYPE(__pyx_t_27)->tp_iternext;
          index = 0; __pyx_t_3 = __pyx_t_11(__pyx_t_27); if (unlikely(!__pyx_t_3)) goto __pyx_L11_unpacking_failed;
          __Pyx_GOTREF(__pyx_t_3);
          index = 1; __pyx_t_29 = __pyx_t_11(__pyx_t_27); if (unlikely(!__pyx_t_29)) goto __pyx_L11_unpacking_failed;
          __Pyx_GOTREF(__pyx_t_29);
          if (__Pyx_IternextUnpackEndCheck(__pyx_t_11(__pyx_t_27), 2) < 0) __PYX_ERR(0, 299, __pyx_L1_error)
          __pyx_t_11 = NULL;
          __Pyx_DECREF(__pyx_t_27); __pyx_t_27 = 0;
          goto __pyx_L12_unpacking_done;
          __pyx_L11_unpacking_failed:;
          __Pyx_DECREF(__pyx_t_27); __pyx_t_27 = 0;
          __pyx_t_11 = NULL;
          if (__Pyx_IterFinish() == 0) __Pyx_RaiseNeedMoreValuesError(index);
          __PYX_ERR(0, 299, __pyx_L1_error)
          __pyx_L12_unpacking_done:;
        }

        /* "orb/cutils.pyx":299
 *         for ij in range(ny):
 *             if sip_A is None:
 *                 outx[ii,ij], outy[ii,ij] = transform_A_to_B(             # <<<<<<<<<<<<<<
 *                     ii, ij, dx, dy, dr, da, db, xrc, yrc, zx, zy)
 *             else:
 */
        __pyx_t_30 = __pyx_PyFloat_AsDouble(__pyx_t_3); if (unlikely((__pyx_t_30 == (npy_float64)-1) && PyErr_Occurred())) __PYX_ERR(0, 299, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
        __pyx_t_31 = __pyx_PyFloat_AsDouble(__pyx_t_29); if (unlikely((__pyx_t_31 == (npy_float64)-1) && PyErr_Occurred())) __PYX_ERR(0, 299, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_29); __pyx_t_29 = 0;
        __pyx_t_32 = __pyx_v_ii;
        __pyx_t_33 = __pyx_v_ij;
        *__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_outx.rcbuffer->pybuffer.buf, __pyx_t_32, __pyx_pybuffernd_outx.diminfo[0].strides, __pyx_t_33, __pyx_pybuffernd_outx.diminfo[1].strides) = __pyx_t_30;
        __pyx_t_34 = __pyx_v_ii;
        __pyx_t_35 = __pyx_v_ij;
        *__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_outy.rcbuffer->pybuffer.buf, __pyx_t_34, __pyx_pybuffernd_outy.diminfo[0].strides, __pyx_t_35, __pyx_pybuffernd_outy.diminfo[1].strides) = __pyx_t_31;

        /* "orb/cutils.pyx":298
 *     for ii in range(nx):
 *         for ij in range(ny):
 *             if sip_A is None:             # <<<<<<<<<<<<<<
 *                 outx[ii,ij], outy[ii,ij] = transform_A_to_B(
 *                     ii, ij, dx, dy, dr, da, db, xrc, yrc, zx, zy)
 */
        goto __pyx_L10;
      }

      /* "orb/cutils.pyx":302
 *                     ii, ij, dx, dy, dr, da, db, xrc, yrc, zx, zy)
 *             else:
 *                 outx[ii,ij], outy[ii,ij] = transform_A_to_B(             # <<<<<<<<<<<<<<
 *                     outx[ii,ij], outy[ii,ij],
 *                     dx, dy, dr, da, db, xrc, yrc, zx, zy)
 */
      /*else*/ {
        __pyx_t_29 = __Pyx_GetModuleGlobalName(__pyx_n_s_transform_A_to_B); if (unlikely(!__pyx_t_29)) __PYX_ERR(0, 302, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_29);

        /* "orb/cutils.pyx":303
 *             else:
 *                 outx[ii,ij], outy[ii,ij] = transform_A_to_B(
 *                     outx[ii,ij], outy[ii,ij],             # <<<<<<<<<<<<<<
 *                     dx, dy, dr, da, db, xrc, yrc, zx, zy)
 * 
 */
        __pyx_t_36 = __pyx_v_ii;
        __pyx_t_37 = __pyx_v_ij;
        __pyx_t_3 = PyFloat_FromDouble((*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_outx.rcbuffer->pybuffer.buf, __pyx_t_36, __pyx_pybuffernd_outx.diminfo[0].strides, __pyx_t_37, __pyx_pybuffernd_outx.diminfo[1].strides))); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 303, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_3);
        __pyx_t_38 = __pyx_v_ii;
        __pyx_t_39 = __pyx_v_ij;
        __pyx_t_27 = PyFloat_FromDouble((*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_outy.rcbuffer->pybuffer.buf, __pyx_t_38, __pyx_pybuffernd_outy.diminfo[0].strides, __pyx_t_39, __pyx_pybuffernd_outy.diminfo[1].strides))); if (unlikely(!__pyx_t_27)) __PYX_ERR(0, 303, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_27);

        /* "orb/cutils.pyx":304
 *                 outx[ii,ij], outy[ii,ij] = transform_A_to_B(
 *                     outx[ii,ij], outy[ii,ij],
 *                     dx, dy, dr, da, db, xrc, yrc, zx, zy)             # <<<<<<<<<<<<<<
 * 
 *     if sip_B is not None:
 */
        __pyx_t_26 = PyFloat_FromDouble(__pyx_v_dx); if (unlikely(!__pyx_t_26)) __PYX_ERR(0, 304, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_26);
        __pyx_t_25 = PyFloat_FromDouble(__pyx_v_dy); if (unlikely(!__pyx_t_25)) __PYX_ERR(0, 304, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_25);
        __pyx_t_24 = PyFloat_FromDouble(__pyx_v_dr); if (unlikely(!__pyx_t_24)) __PYX_ERR(0, 304, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_24);
        __pyx_t_23 = PyFloat_FromDouble(__pyx_v_da); if (unlikely(!__pyx_t_23)) __PYX_ERR(0, 304, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_23);
        __pyx_t_22 = PyFloat_FromDouble(__pyx_v_db); if (unlikely(!__pyx_t_22)) __PYX_ERR(0, 304, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_22);
        __pyx_t_21 = PyFloat_FromDouble(__pyx_v_xrc); if (unlikely(!__pyx_t_21)) __PYX_ERR(0, 304, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_21);
        __pyx_t_2 = PyFloat_FromDouble(__pyx_v_yrc); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 304, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_2);
        __pyx_t_1 = PyFloat_FromDouble(__pyx_v_zx); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 304, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_1);
        __pyx_t_4 = PyFloat_FromDouble(__pyx_v_zy); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 304, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_4);
        __pyx_t_17 = NULL;
        __pyx_t_16 = 0;
        if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_29))) {
          __pyx_t_17 = PyMethod_GET_SELF(__pyx_t_29);
          if (likely(__pyx_t_17)) {
            PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_29);
            __Pyx_INCREF(__pyx_t_17);
            __Pyx_INCREF(function);
            __Pyx_DECREF_SET(__pyx_t_29, function);
            __pyx_t_16 = 1;
          }
        }
        __pyx_t_28 = PyTuple_New(11+__pyx_t_16); if (unlikely(!__pyx_t_28)) __PYX_ERR(0, 302, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_28);
        if (__pyx_t_17) {
          __Pyx_GIVEREF(__pyx_t_17); PyTuple_SET_ITEM(__pyx_t_28, 0, __pyx_t_17); __pyx_t_17 = NULL;
        }
        __Pyx_GIVEREF(__pyx_t_3);
        PyTuple_SET_ITEM(__pyx_t_28, 0+__pyx_t_16, __pyx_t_3);
        __Pyx_GIVEREF(__pyx_t_27);
        PyTuple_SET_ITEM(__pyx_t_28, 1+__pyx_t_16, __pyx_t_27);
        __Pyx_GIVEREF(__pyx_t_26);
        PyTuple_SET_ITEM(__pyx_t_28, 2+__pyx_t_16, __pyx_t_26);
        __Pyx_GIVEREF(__pyx_t_25);
        PyTuple_SET_ITEM(__pyx_t_28, 3+__pyx_t_16, __pyx_t_25);
        __Pyx_GIVEREF(__pyx_t_24);
        PyTuple_SET_ITEM(__pyx_t_28, 4+__pyx_t_16, __pyx_t_24);
        __Pyx_GIVEREF(__pyx_t_23);
        PyTuple_SET_ITEM(__pyx_t_28, 5+__pyx_t_16, __pyx_t_23);
        __Pyx_GIVEREF(__pyx_t_22);
        PyTuple_SET_ITEM(__pyx_t_28, 6+__pyx_t_16, __pyx_t_22);
        __Pyx_GIVEREF(__pyx_t_21);
        PyTuple_SET_ITEM(__pyx_t_28, 7+__pyx_t_16, __pyx_t_21);
        __Pyx_GIVEREF(__pyx_t_2);
        PyTuple_SET_ITEM(__pyx_t_28, 8+__pyx_t_16, __pyx_t_2);
        __Pyx_GIVEREF(__pyx_t_1);
        PyTuple_SET_ITEM(__pyx_t_28, 9+__pyx_t_16, __pyx_t_1);
        __Pyx_GIVEREF(__pyx_t_4);
        PyTuple_SET_ITEM(__pyx_t_28, 10+__pyx_t_16, __pyx_t_4);
        __pyx_t_3 = 0;
        __pyx_t_27 = 0;
        __pyx_t_26 = 0;
        __pyx_t_25 = 0;
        __pyx_t_24 = 0;
        __pyx_t_23 = 0;
        __pyx_t_22 = 0;
        __pyx_t_21 = 0;
        __pyx_t_2 = 0;
        __pyx_t_1 = 0;
        __pyx_t_4 = 0;
        __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_29, __pyx_t_28, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 302, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_5);
        __Pyx_DECREF(__pyx_t_28); __pyx_t_28 = 0;
        __Pyx_DECREF(__pyx_t_29); __pyx_t_29 = 0;
        if ((likely(PyTuple_CheckExact(__pyx_t_5))) || (PyList_CheckExact(__pyx_t_5))) {
          PyObject* sequence = __pyx_t_5;
          #if CYTHON_COMPILING_IN_CPYTHON
          Py_ssize_t size = Py_SIZE(sequence);
          #else
          Py_ssize_t size = PySequence_Size(sequence);
          #endif
          if (unlikely(size != 2)) {
            if (size > 2) __Pyx_RaiseTooManyValuesError(2);
            else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
            __PYX_ERR(0, 302, __pyx_L1_error)
          }
          #if CYTHON_COMPILING_IN_CPYTHON
          if (likely(PyTuple_CheckExact(sequence))) {
            __pyx_t_29 = PyTuple_GET_ITEM(sequence, 0); 
            __pyx_t_28 = PyTuple_GET_ITEM(sequence, 1); 
          } else {
            __pyx_t_29 = PyList_GET_ITEM(sequence, 0); 
            __pyx_t_28 = PyList_GET_ITEM(sequence, 1); 
          }
          __Pyx_INCREF(__pyx_t_29);
          __Pyx_INCREF(__pyx_t_28);
          #else
          __pyx_t_29 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_29)) __PYX_ERR(0, 302, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_29);
          __pyx_t_28 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_28)) __PYX_ERR(0, 302, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_28);
          #endif
          __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
        } else {
          Py_ssize_t index = -1;
          __pyx_t_4 = PyObject_GetIter(__pyx_t_5); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 302, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_4);
          __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
          __pyx_t_11 = Py_TYPE(__pyx_t_4)->tp_iternext;
          index = 0; __pyx_t_29 = __pyx_t_11(__pyx_t_4); if (unlikely(!__pyx_t_29)) goto __pyx_L13_unpacking_failed;
          __Pyx_GOTREF(__pyx_t_29);
          index = 1; __pyx_t_28 = __pyx_t_11(__pyx_t_4); if (unlikely(!__pyx_t_28)) goto __pyx_L13_unpacking_failed;
          __Pyx_GOTREF(__pyx_t_28);
          if (__Pyx_IternextUnpackEndCheck(__pyx_t_11(__pyx_t_4), 2) < 0) __PYX_ERR(0, 302, __pyx_L1_error)
          __pyx_t_11 = NULL;
          __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
          goto __pyx_L14_unpacking_done;
          __pyx_L13_unpacking_failed:;
          __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
          __pyx_t_11 = NULL;
          if (__Pyx_IterFinish() == 0) __Pyx_RaiseNeedMoreValuesError(index);
          __PYX_ERR(0, 302, __pyx_L1_error)
          __pyx_L14_unpacking_done:;
        }

        /* "orb/cutils.pyx":302
 *                     ii, ij, dx, dy, dr, da, db, xrc, yrc, zx, zy)
 *             else:
 *                 outx[ii,ij], outy[ii,ij] = transform_A_to_B(             # <<<<<<<<<<<<<<
 *                     outx[ii,ij], outy[ii,ij],
 *                     dx, dy, dr, da, db, xrc, yrc, zx, zy)
 */
        __pyx_t_31 = __pyx_PyFloat_AsDouble(__pyx_t_29); if (unlikely((__pyx_t_31 == (npy_float64)-1) && PyErr_Occurred())) __PYX_ERR(0, 302, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_29); __pyx_t_29 = 0;
        __pyx_t_30 = __pyx_PyFloat_AsDouble(__pyx_t_28); if (unlikely((__pyx_t_30 == (npy_float64)-1) && PyErr_Occurred())) __PYX_ERR(0, 302, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_28); __pyx_t_28 = 0;
        __pyx_t_40 = __pyx_v_ii;
        __pyx_t_41 = __pyx_v_ij;
        *__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_outx.rcbuffer->pybuffer.buf, __pyx_t_40, __pyx_pybuffernd_outx.diminfo[0].strides, __pyx_t_41, __pyx_pybuffernd_outx.diminfo[1].strides) = __pyx_t_31;
        __pyx_t_42 = __pyx_v_ii;
        __pyx_t_43 = __pyx_v_ij;
        *__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_outy.rcbuffer->pybuffer.buf, __pyx_t_42, __pyx_pybuffernd_outy.diminfo[0].strides, __pyx_t_43, __pyx_pybuffernd_outy.diminfo[1].strides) = __pyx_t_30;
      }
      __pyx_L10:;
    }
  }

  /* "orb/cutils.pyx":306
 *                     dx, dy, dr, da, db, xrc, yrc, zx, zy)
 * 
 *     if sip_B is not None:             # <<<<<<<<<<<<<<
 *         coords[:,0] = outx.flatten()
 *         coords[:,1] = outy.flatten()
 */
  __pyx_t_9 = (__pyx_v_sip_B != Py_None);
  __pyx_t_10 = (__pyx_t_9 != 0);
  if (__pyx_t_10) {

    /* "orb/cutils.pyx":307
 * 
 *     if sip_B is not None:
 *         coords[:,0] = outx.flatten()             # <<<<<<<<<<<<<<
 *         coords[:,1] = outy.flatten()
 *         coords = sip_im2pix(coords, sip_B)
 */
    __pyx_t_28 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_outx), __pyx_n_s_flatten); if (unlikely(!__pyx_t_28)) __PYX_ERR(0, 307, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_28);
    __pyx_t_29 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && likely(PyMethod_Check(__pyx_t_28))) {
      __pyx_t_29 = PyMethod_GET_SELF(__pyx_t_28);
      if (likely(__pyx_t_29)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_28);
        __Pyx_INCREF(__pyx_t_29);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_28, function);
      }
    }
    if (__pyx_t_29) {
      __pyx_t_5 = __Pyx_PyObject_CallOneArg(__pyx_t_28, __pyx_t_29); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 307, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_29); __pyx_t_29 = 0;
    } else {
      __pyx_t_5 = __Pyx_PyObject_CallNoArg(__pyx_t_28); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 307, __pyx_L1_error)
    }
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_DECREF(__pyx_t_28); __pyx_t_28 = 0;
    if (unlikely(PyObject_SetItem(((PyObject *)__pyx_v_coords), __pyx_tuple__18, __pyx_t_5) < 0)) __PYX_ERR(0, 307, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

    /* "orb/cutils.pyx":308
 *     if sip_B is not None:
 *         coords[:,0] = outx.flatten()
 *         coords[:,1] = outy.flatten()             # <<<<<<<<<<<<<<
 *         coords = sip_im2pix(coords, sip_B)
 *         outx = np.reshape(coords[:,0], [outx.shape[0], outx.shape[1]])
 */
    __pyx_t_28 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_outy), __pyx_n_s_flatten); if (unlikely(!__pyx_t_28)) __PYX_ERR(0, 308, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_28);
    __pyx_t_29 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && likely(PyMethod_Check(__pyx_t_28))) {
      __pyx_t_29 = PyMethod_GET_SELF(__pyx_t_28);
      if (likely(__pyx_t_29)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_28);
        __Pyx_INCREF(__pyx_t_29);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_28, function);
      }
    }
    if (__pyx_t_29) {
      __pyx_t_5 = __Pyx_PyObject_CallOneArg(__pyx_t_28, __pyx_t_29); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 308, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_29); __pyx_t_29 = 0;
    } else {
      __pyx_t_5 = __Pyx_PyObject_CallNoArg(__pyx_t_28); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 308, __pyx_L1_error)
    }
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_DECREF(__pyx_t_28); __pyx_t_28 = 0;
    if (unlikely(PyObject_SetItem(((PyObject *)__pyx_v_coords), __pyx_tuple__20, __pyx_t_5) < 0)) __PYX_ERR(0, 308, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

    /* "orb/cutils.pyx":309
 *         coords[:,0] = outx.flatten()
 *         coords[:,1] = outy.flatten()
 *         coords = sip_im2pix(coords, sip_B)             # <<<<<<<<<<<<<<
 *         outx = np.reshape(coords[:,0], [outx.shape[0], outx.shape[1]])
 *         outy = np.reshape(coords[:,1], [outy.shape[0], outy.shape[1]])
 */
    __pyx_t_28 = __Pyx_GetModuleGlobalName(__pyx_n_s_sip_im2pix); if (unlikely(!__pyx_t_28)) __PYX_ERR(0, 309, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_28);
    __pyx_t_29 = NULL;
    __pyx_t_16 = 0;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_28))) {
      __pyx_t_29 = PyMethod_GET_SELF(__pyx_t_28);
      if (likely(__pyx_t_29)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_28);
        __Pyx_INCREF(__pyx_t_29);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_28, function);
        __pyx_t_16 = 1;
      }
    }
    __pyx_t_4 = PyTuple_New(2+__pyx_t_16); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 309, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    if (__pyx_t_29) {
      __Pyx_GIVEREF(__pyx_t_29); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_29); __pyx_t_29 = NULL;
    }
    __Pyx_INCREF(((PyObject *)__pyx_v_coords));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_coords));
    PyTuple_SET_ITEM(__pyx_t_4, 0+__pyx_t_16, ((PyObject *)__pyx_v_coords));
    __Pyx_INCREF(__pyx_v_sip_B);
    __Pyx_GIVEREF(__pyx_v_sip_B);
    PyTuple_SET_ITEM(__pyx_t_4, 1+__pyx_t_16, __pyx_v_sip_B);
    __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_28, __pyx_t_4, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 309, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __Pyx_DECREF(__pyx_t_28); __pyx_t_28 = 0;
    if (!(likely(((__pyx_t_5) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_5, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 309, __pyx_L1_error)
    __pyx_t_8 = ((PyArrayObject *)__pyx_t_5);
    {
      __Pyx_BufFmt_StackElem __pyx_stack[1];
      __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_coords.rcbuffer->pybuffer);
      __pyx_t_12 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_coords.rcbuffer->pybuffer, (PyObject*)__pyx_t_8, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
      if (unlikely(__pyx_t_12 < 0)) {
        PyErr_Fetch(&__pyx_t_15, &__pyx_t_14, &__pyx_t_13);
        if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_coords.rcbuffer->pybuffer, (PyObject*)__pyx_v_coords, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
          Py_XDECREF(__pyx_t_15); Py_XDECREF(__pyx_t_14); Py_XDECREF(__pyx_t_13);
          __Pyx_RaiseBufferFallbackError();
        } else {
          PyErr_Restore(__pyx_t_15, __pyx_t_14, __pyx_t_13);
        }
      }
      __pyx_pybuffernd_coords.diminfo[0].strides = __pyx_pybuffernd_coords.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_coords.diminfo[0].shape = __pyx_pybuffernd_coords.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_coords.diminfo[1].strides = __pyx_pybuffernd_coords.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_coords.diminfo[1].shape = __pyx_pybuffernd_coords.rcbuffer->pybuffer.shape[1];
      if (unlikely(__pyx_t_12 < 0)) __PYX_ERR(0, 309, __pyx_L1_error)
    }
    __pyx_t_8 = 0;
    __Pyx_DECREF_SET(__pyx_v_coords, ((PyArrayObject *)__pyx_t_5));
    __pyx_t_5 = 0;

    /* "orb/cutils.pyx":310
 *         coords[:,1] = outy.flatten()
 *         coords = sip_im2pix(coords, sip_B)
 *         outx = np.reshape(coords[:,0], [outx.shape[0], outx.shape[1]])             # <<<<<<<<<<<<<<
 *         outy = np.reshape(coords[:,1], [outy.shape[0], outy.shape[1]])
 * 
 */
    __pyx_t_28 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_28)) __PYX_ERR(0, 310, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_28);
    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_28, __pyx_n_s_reshape); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 310, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_28); __pyx_t_28 = 0;
    __pyx_t_28 = PyObject_GetItem(((PyObject *)__pyx_v_coords), __pyx_tuple__22); if (unlikely(!__pyx_t_28)) __PYX_ERR(0, 310, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_28);
    __pyx_t_29 = __Pyx_PyInt_From_Py_intptr_t((__pyx_v_outx->dimensions[0])); if (unlikely(!__pyx_t_29)) __PYX_ERR(0, 310, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_29);
    __pyx_t_1 = __Pyx_PyInt_From_Py_intptr_t((__pyx_v_outx->dimensions[1])); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 310, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __pyx_t_2 = PyList_New(2); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 310, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_GIVEREF(__pyx_t_29);
    PyList_SET_ITEM(__pyx_t_2, 0, __pyx_t_29);
    __Pyx_GIVEREF(__pyx_t_1);
    PyList_SET_ITEM(__pyx_t_2, 1, __pyx_t_1);
    __pyx_t_29 = 0;
    __pyx_t_1 = 0;
    __pyx_t_1 = NULL;
    __pyx_t_16 = 0;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_4))) {
      __pyx_t_1 = PyMethod_GET_SELF(__pyx_t_4);
      if (likely(__pyx_t_1)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
        __Pyx_INCREF(__pyx_t_1);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_4, function);
        __pyx_t_16 = 1;
      }
    }
    __pyx_t_29 = PyTuple_New(2+__pyx_t_16); if (unlikely(!__pyx_t_29)) __PYX_ERR(0, 310, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_29);
    if (__pyx_t_1) {
      __Pyx_GIVEREF(__pyx_t_1); PyTuple_SET_ITEM(__pyx_t_29, 0, __pyx_t_1); __pyx_t_1 = NULL;
    }
    __Pyx_GIVEREF(__pyx_t_28);
    PyTuple_SET_ITEM(__pyx_t_29, 0+__pyx_t_16, __pyx_t_28);
    __Pyx_GIVEREF(__pyx_t_2);
    PyTuple_SET_ITEM(__pyx_t_29, 1+__pyx_t_16, __pyx_t_2);
    __pyx_t_28 = 0;
    __pyx_t_2 = 0;
    __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_29, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 310, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_DECREF(__pyx_t_29); __pyx_t_29 = 0;
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    if (!(likely(((__pyx_t_5) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_5, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 310, __pyx_L1_error)
    __pyx_t_6 = ((PyArrayObject *)__pyx_t_5);
    {
      __Pyx_BufFmt_StackElem __pyx_stack[1];
      __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_outx.rcbuffer->pybuffer);
      __pyx_t_12 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_outx.rcbuffer->pybuffer, (PyObject*)__pyx_t_6, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 2, 0, __pyx_stack);
      if (unlikely(__pyx_t_12 < 0)) {
        PyErr_Fetch(&__pyx_t_13, &__pyx_t_14, &__pyx_t_15);
        if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_outx.rcbuffer->pybuffer, (PyObject*)__pyx_v_outx, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 2, 0, __pyx_stack) == -1)) {
          Py_XDECREF(__pyx_t_13); Py_XDECREF(__pyx_t_14); Py_XDECREF(__pyx_t_15);
          __Pyx_RaiseBufferFallbackError();
        } else {
          PyErr_Restore(__pyx_t_13, __pyx_t_14, __pyx_t_15);
        }
      }
      __pyx_pybuffernd_outx.diminfo[0].strides = __pyx_pybuffernd_outx.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_outx.diminfo[0].shape = __pyx_pybuffernd_outx.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_outx.diminfo[1].strides = __pyx_pybuffernd_outx.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_outx.diminfo[1].shape = __pyx_pybuffernd_outx.rcbuffer->pybuffer.shape[1];
      if (unlikely(__pyx_t_12 < 0)) __PYX_ERR(0, 310, __pyx_L1_error)
    }
    __pyx_t_6 = 0;
    __Pyx_DECREF_SET(__pyx_v_outx, ((PyArrayObject *)__pyx_t_5));
    __pyx_t_5 = 0;

    /* "orb/cutils.pyx":311
 *         coords = sip_im2pix(coords, sip_B)
 *         outx = np.reshape(coords[:,0], [outx.shape[0], outx.shape[1]])
 *         outy = np.reshape(coords[:,1], [outy.shape[0], outy.shape[1]])             # <<<<<<<<<<<<<<
 * 
 *     return outx, outy
 */
    __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 311, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __pyx_t_29 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_reshape); if (unlikely(!__pyx_t_29)) __PYX_ERR(0, 311, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_29);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_t_4 = PyObject_GetItem(((PyObject *)__pyx_v_coords), __pyx_tuple__24); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 311, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __pyx_t_2 = __Pyx_PyInt_From_Py_intptr_t((__pyx_v_outy->dimensions[0])); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 311, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __pyx_t_28 = __Pyx_PyInt_From_Py_intptr_t((__pyx_v_outy->dimensions[1])); if (unlikely(!__pyx_t_28)) __PYX_ERR(0, 311, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_28);
    __pyx_t_1 = PyList_New(2); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 311, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_GIVEREF(__pyx_t_2);
    PyList_SET_ITEM(__pyx_t_1, 0, __pyx_t_2);
    __Pyx_GIVEREF(__pyx_t_28);
    PyList_SET_ITEM(__pyx_t_1, 1, __pyx_t_28);
    __pyx_t_2 = 0;
    __pyx_t_28 = 0;
    __pyx_t_28 = NULL;
    __pyx_t_16 = 0;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_29))) {
      __pyx_t_28 = PyMethod_GET_SELF(__pyx_t_29);
      if (likely(__pyx_t_28)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_29);
        __Pyx_INCREF(__pyx_t_28);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_29, function);
        __pyx_t_16 = 1;
      }
    }
    __pyx_t_2 = PyTuple_New(2+__pyx_t_16); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 311, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    if (__pyx_t_28) {
      __Pyx_GIVEREF(__pyx_t_28); PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_28); __pyx_t_28 = NULL;
    }
    __Pyx_GIVEREF(__pyx_t_4);
    PyTuple_SET_ITEM(__pyx_t_2, 0+__pyx_t_16, __pyx_t_4);
    __Pyx_GIVEREF(__pyx_t_1);
    PyTuple_SET_ITEM(__pyx_t_2, 1+__pyx_t_16, __pyx_t_1);
    __pyx_t_4 = 0;
    __pyx_t_1 = 0;
    __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_29, __pyx_t_2, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 311, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __Pyx_DECREF(__pyx_t_29); __pyx_t_29 = 0;
    if (!(likely(((__pyx_t_5) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_5, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 311, __pyx_L1_error)
    __pyx_t_7 = ((PyArrayObject *)__pyx_t_5);
    {
      __Pyx_BufFmt_StackElem __pyx_stack[1];
      __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_outy.rcbuffer->pybuffer);
      __pyx_t_12 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_outy.rcbuffer->pybuffer, (PyObject*)__pyx_t_7, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 2, 0, __pyx_stack);
      if (unlikely(__pyx_t_12 < 0)) {
        PyErr_Fetch(&__pyx_t_15, &__pyx_t_14, &__pyx_t_13);
        if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_outy.rcbuffer->pybuffer, (PyObject*)__pyx_v_outy, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 2, 0, __pyx_stack) == -1)) {
          Py_XDECREF(__pyx_t_15); Py_XDECREF(__pyx_t_14); Py_XDECREF(__pyx_t_13);
          __Pyx_RaiseBufferFallbackError();
        } else {
          PyErr_Restore(__pyx_t_15, __pyx_t_14, __pyx_t_13);
        }
      }
      __pyx_pybuffernd_outy.diminfo[0].strides = __pyx_pybuffernd_outy.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_outy.diminfo[0].shape = __pyx_pybuffernd_outy.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_outy.diminfo[1].strides = __pyx_pybuffernd_outy.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_outy.diminfo[1].shape = __pyx_pybuffernd_outy.rcbuffer->pybuffer.shape[1];
      if (unlikely(__pyx_t_12 < 0)) __PYX_ERR(0, 311, __pyx_L1_error)
    }
    __pyx_t_7 = 0;
    __Pyx_DECREF_SET(__pyx_v_outy, ((PyArrayObject *)__pyx_t_5));
    __pyx_t_5 = 0;

    /* "orb/cutils.pyx":306
 *                     dx, dy, dr, da, db, xrc, yrc, zx, zy)
 * 
 *     if sip_B is not None:             # <<<<<<<<<<<<<<
 *         coords[:,0] = outx.flatten()
 *         coords[:,1] = outy.flatten()
 */
  }

  /* "orb/cutils.pyx":313
 *         outy = np.reshape(coords[:,1], [outy.shape[0], outy.shape[1]])
 * 
 *     return outx, outy             # <<<<<<<<<<<<<<
 * 
 * 
 */
  __Pyx_XDECREF(__pyx_r);
  __pyx_t_5 = PyTuple_New(2); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 313, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_INCREF(((PyObject *)__pyx_v_outx));
  __Pyx_GIVEREF(((PyObject *)__pyx_v_outx));
  PyTuple_SET_ITEM(__pyx_t_5, 0, ((PyObject *)__pyx_v_outx));
  __Pyx_INCREF(((PyObject *)__pyx_v_outy));
  __Pyx_GIVEREF(((PyObject *)__pyx_v_outy));
  PyTuple_SET_ITEM(__pyx_t_5, 1, ((PyObject *)__pyx_v_outy));
  __pyx_r = __pyx_t_5;
  __pyx_t_5 = 0;
  goto __pyx_L0;

  /* "orb/cutils.pyx":252
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def create_transform_maps(int nx, int ny, double dx, double dy,             # <<<<<<<<<<<<<<
 *                           double dr, double da, double db, double xrc,
 *                           double yrc, double zx, double zy, sip_A, sip_B):
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_1);
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_XDECREF(__pyx_t_5);
  __Pyx_XDECREF(__pyx_t_17);
  __Pyx_XDECREF(__pyx_t_21);
  __Pyx_XDECREF(__pyx_t_22);
  __Pyx_XDECREF(__pyx_t_23);
  __Pyx_XDECREF(__pyx_t_24);
  __Pyx_XDECREF(__pyx_t_25);
  __Pyx_XDECREF(__pyx_t_26);
  __Pyx_XDECREF(__pyx_t_27);
  __Pyx_XDECREF(__pyx_t_28);
  __Pyx_XDECREF(__pyx_t_29);
  { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
    __Pyx_PyThreadState_declare
    __Pyx_PyThreadState_assign
    __Pyx_ErrFetch(&__pyx_type, &__pyx_value, &__pyx_tb);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_coords.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_outx.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_outy.rcbuffer->pybuffer);
  __Pyx_ErrRestore(__pyx_type, __pyx_value, __pyx_tb);}
  __Pyx_AddTraceback("orb.cutils.create_transform_maps", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  goto __pyx_L2;
  __pyx_L0:;
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_coords.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_outx.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_outy.rcbuffer->pybuffer);
  __pyx_L2:;
  __Pyx_XDECREF((PyObject *)__pyx_v_outx);
  __Pyx_XDECREF((PyObject *)__pyx_v_outy);
  __Pyx_XDECREF((PyObject *)__pyx_v_coords);
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":318
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def gaussian_array2d(double h, double a, double dx, double dy, double fwhm,             # <<<<<<<<<<<<<<
 *                      int nx, int ny):
 *     """Return the 2D profile of a gaussian
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_13gaussian_array2d(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_3orb_6cutils_12gaussian_array2d[] = "gaussian_array2d(double h, double a, double dx, double dy, double fwhm, int nx, int ny)\nReturn the 2D profile of a gaussian\n\n    :param h: Height\n    :param a: Amplitude\n    :param dx: X position\n    :param dy: Y position\n    :param fwhm: FWHM\n    :param nx: X dimension of the output array\n    :param ny: Y dimension of the output array\n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_13gaussian_array2d = {"gaussian_array2d", (PyCFunction)__pyx_pw_3orb_6cutils_13gaussian_array2d, METH_VARARGS|METH_KEYWORDS, __pyx_doc_3orb_6cutils_12gaussian_array2d};
static PyObject *__pyx_pw_3orb_6cutils_13gaussian_array2d(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  double __pyx_v_h;
  double __pyx_v_a;
  double __pyx_v_dx;
  double __pyx_v_dy;
  double __pyx_v_fwhm;
  int __pyx_v_nx;
  int __pyx_v_ny;
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("gaussian_array2d (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_h,&__pyx_n_s_a,&__pyx_n_s_dx,&__pyx_n_s_dy,&__pyx_n_s_fwhm,&__pyx_n_s_nx,&__pyx_n_s_ny,0};
    PyObject* values[7] = {0,0,0,0,0,0,0};
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
      switch (pos_args) {
        case  7: values[6] = PyTuple_GET_ITEM(__pyx_args, 6);
        case  6: values[5] = PyTuple_GET_ITEM(__pyx_args, 5);
        case  5: values[4] = PyTuple_GET_ITEM(__pyx_args, 4);
        case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = PyDict_Size(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_h)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        case  1:
        if (likely((values[1] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_a)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("gaussian_array2d", 1, 7, 7, 1); __PYX_ERR(0, 318, __pyx_L3_error)
        }
        case  2:
        if (likely((values[2] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_dx)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("gaussian_array2d", 1, 7, 7, 2); __PYX_ERR(0, 318, __pyx_L3_error)
        }
        case  3:
        if (likely((values[3] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_dy)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("gaussian_array2d", 1, 7, 7, 3); __PYX_ERR(0, 318, __pyx_L3_error)
        }
        case  4:
        if (likely((values[4] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_fwhm)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("gaussian_array2d", 1, 7, 7, 4); __PYX_ERR(0, 318, __pyx_L3_error)
        }
        case  5:
        if (likely((values[5] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_nx)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("gaussian_array2d", 1, 7, 7, 5); __PYX_ERR(0, 318, __pyx_L3_error)
        }
        case  6:
        if (likely((values[6] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_ny)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("gaussian_array2d", 1, 7, 7, 6); __PYX_ERR(0, 318, __pyx_L3_error)
        }
      }
      if (unlikely(kw_args > 0)) {
        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "gaussian_array2d") < 0)) __PYX_ERR(0, 318, __pyx_L3_error)
      }
    } else if (PyTuple_GET_SIZE(__pyx_args) != 7) {
      goto __pyx_L5_argtuple_error;
    } else {
      values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
      values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
      values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
      values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
      values[4] = PyTuple_GET_ITEM(__pyx_args, 4);
      values[5] = PyTuple_GET_ITEM(__pyx_args, 5);
      values[6] = PyTuple_GET_ITEM(__pyx_args, 6);
    }
    __pyx_v_h = __pyx_PyFloat_AsDouble(values[0]); if (unlikely((__pyx_v_h == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 318, __pyx_L3_error)
    __pyx_v_a = __pyx_PyFloat_AsDouble(values[1]); if (unlikely((__pyx_v_a == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 318, __pyx_L3_error)
    __pyx_v_dx = __pyx_PyFloat_AsDouble(values[2]); if (unlikely((__pyx_v_dx == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 318, __pyx_L3_error)
    __pyx_v_dy = __pyx_PyFloat_AsDouble(values[3]); if (unlikely((__pyx_v_dy == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 318, __pyx_L3_error)
    __pyx_v_fwhm = __pyx_PyFloat_AsDouble(values[4]); if (unlikely((__pyx_v_fwhm == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 318, __pyx_L3_error)
    __pyx_v_nx = __Pyx_PyInt_As_int(values[5]); if (unlikely((__pyx_v_nx == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 319, __pyx_L3_error)
    __pyx_v_ny = __Pyx_PyInt_As_int(values[6]); if (unlikely((__pyx_v_ny == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 319, __pyx_L3_error)
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  __Pyx_RaiseArgtupleInvalid("gaussian_array2d", 1, 7, 7, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 318, __pyx_L3_error)
  __pyx_L3_error:;
  __Pyx_AddTraceback("orb.cutils.gaussian_array2d", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __Pyx_RefNannyFinishContext();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  __pyx_r = __pyx_pf_3orb_6cutils_12gaussian_array2d(__pyx_self, __pyx_v_h, __pyx_v_a, __pyx_v_dx, __pyx_v_dy, __pyx_v_fwhm, __pyx_v_nx, __pyx_v_ny);

  /* function exit code */
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_12gaussian_array2d(CYTHON_UNUSED PyObject *__pyx_self, double __pyx_v_h, double __pyx_v_a, double __pyx_v_dx, double __pyx_v_dy, double __pyx_v_fwhm, int __pyx_v_nx, int __pyx_v_ny) {
  PyArrayObject *__pyx_v_arr = 0;
  double __pyx_v_r;
  double __pyx_v_w;
  int __pyx_v_ii;
  int __pyx_v_ij;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_arr;
  __Pyx_Buffer __pyx_pybuffer_arr;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  PyObject *__pyx_t_1 = NULL;
  PyObject *__pyx_t_2 = NULL;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  PyObject *__pyx_t_5 = NULL;
  PyArrayObject *__pyx_t_6 = NULL;
  double __pyx_t_7;
  int __pyx_t_8;
  int __pyx_t_9;
  int __pyx_t_10;
  int __pyx_t_11;
  double __pyx_t_12;
  Py_ssize_t __pyx_t_13;
  Py_ssize_t __pyx_t_14;
  __Pyx_RefNannySetupContext("gaussian_array2d", 0);
  __pyx_pybuffer_arr.pybuffer.buf = NULL;
  __pyx_pybuffer_arr.refcount = 0;
  __pyx_pybuffernd_arr.data = NULL;
  __pyx_pybuffernd_arr.rcbuffer = &__pyx_pybuffer_arr;

  /* "orb/cutils.pyx":330
 *     :param ny: Y dimension of the output array
 *     """
 *     cdef np.ndarray[np.float64_t, ndim=2] arr = np.zeros(             # <<<<<<<<<<<<<<
 *         (nx, ny), dtype=np.float64)
 *     cdef double r = 0.
 */
  __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 330, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_zeros); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 330, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":331
 *     """
 *     cdef np.ndarray[np.float64_t, ndim=2] arr = np.zeros(
 *         (nx, ny), dtype=np.float64)             # <<<<<<<<<<<<<<
 *     cdef double r = 0.
 *     cdef double w = fwhm / (2. * sqrt(2. * log(2.)))
 */
  __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_nx); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 331, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_3 = __Pyx_PyInt_From_int(__pyx_v_ny); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 331, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_4 = PyTuple_New(2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 331, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_GIVEREF(__pyx_t_1);
  PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_1);
  __Pyx_GIVEREF(__pyx_t_3);
  PyTuple_SET_ITEM(__pyx_t_4, 1, __pyx_t_3);
  __pyx_t_1 = 0;
  __pyx_t_3 = 0;

  /* "orb/cutils.pyx":330
 *     :param ny: Y dimension of the output array
 *     """
 *     cdef np.ndarray[np.float64_t, ndim=2] arr = np.zeros(             # <<<<<<<<<<<<<<
 *         (nx, ny), dtype=np.float64)
 *     cdef double r = 0.
 */
  __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 330, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_GIVEREF(__pyx_t_4);
  PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_4);
  __pyx_t_4 = 0;

  /* "orb/cutils.pyx":331
 *     """
 *     cdef np.ndarray[np.float64_t, ndim=2] arr = np.zeros(
 *         (nx, ny), dtype=np.float64)             # <<<<<<<<<<<<<<
 *     cdef double r = 0.
 *     cdef double w = fwhm / (2. * sqrt(2. * log(2.)))
 */
  __pyx_t_4 = PyDict_New(); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 331, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 331, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_float64); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 331, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  if (PyDict_SetItem(__pyx_t_4, __pyx_n_s_dtype, __pyx_t_5) < 0) __PYX_ERR(0, 331, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

  /* "orb/cutils.pyx":330
 *     :param ny: Y dimension of the output array
 *     """
 *     cdef np.ndarray[np.float64_t, ndim=2] arr = np.zeros(             # <<<<<<<<<<<<<<
 *         (nx, ny), dtype=np.float64)
 *     cdef double r = 0.
 */
  __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_3, __pyx_t_4); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 330, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  if (!(likely(((__pyx_t_5) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_5, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 330, __pyx_L1_error)
  __pyx_t_6 = ((PyArrayObject *)__pyx_t_5);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_arr.rcbuffer->pybuffer, (PyObject*)__pyx_t_6, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 2, 0, __pyx_stack) == -1)) {
      __pyx_v_arr = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_arr.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 330, __pyx_L1_error)
    } else {__pyx_pybuffernd_arr.diminfo[0].strides = __pyx_pybuffernd_arr.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_arr.diminfo[0].shape = __pyx_pybuffernd_arr.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_arr.diminfo[1].strides = __pyx_pybuffernd_arr.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_arr.diminfo[1].shape = __pyx_pybuffernd_arr.rcbuffer->pybuffer.shape[1];
    }
  }
  __pyx_t_6 = 0;
  __pyx_v_arr = ((PyArrayObject *)__pyx_t_5);
  __pyx_t_5 = 0;

  /* "orb/cutils.pyx":332
 *     cdef np.ndarray[np.float64_t, ndim=2] arr = np.zeros(
 *         (nx, ny), dtype=np.float64)
 *     cdef double r = 0.             # <<<<<<<<<<<<<<
 *     cdef double w = fwhm / (2. * sqrt(2. * log(2.)))
 *     cdef int ii, ij
 */
  __pyx_v_r = 0.;

  /* "orb/cutils.pyx":333
 *         (nx, ny), dtype=np.float64)
 *     cdef double r = 0.
 *     cdef double w = fwhm / (2. * sqrt(2. * log(2.)))             # <<<<<<<<<<<<<<
 *     cdef int ii, ij
 * 
 */
  __pyx_t_7 = (2. * sqrt((2. * log(2.))));
  if (unlikely(__pyx_t_7 == 0)) {
    PyErr_SetString(PyExc_ZeroDivisionError, "float division");
    __PYX_ERR(0, 333, __pyx_L1_error)
  }
  __pyx_v_w = (__pyx_v_fwhm / __pyx_t_7);

  /* "orb/cutils.pyx":336
 *     cdef int ii, ij
 * 
 *     with nogil:             # <<<<<<<<<<<<<<
 *         for ii in range(nx):
 *             for ij in range(ny):
 */
  {
      #ifdef WITH_THREAD
      PyThreadState *_save;
      Py_UNBLOCK_THREADS
      #endif
      /*try:*/ {

        /* "orb/cutils.pyx":337
 * 
 *     with nogil:
 *         for ii in range(nx):             # <<<<<<<<<<<<<<
 *             for ij in range(ny):
 *                 r = sqrt(((<double> ii) - dx)**2. + ((<double> ij) - dy)**2.)
 */
        __pyx_t_8 = __pyx_v_nx;
        for (__pyx_t_9 = 0; __pyx_t_9 < __pyx_t_8; __pyx_t_9+=1) {
          __pyx_v_ii = __pyx_t_9;

          /* "orb/cutils.pyx":338
 *     with nogil:
 *         for ii in range(nx):
 *             for ij in range(ny):             # <<<<<<<<<<<<<<
 *                 r = sqrt(((<double> ii) - dx)**2. + ((<double> ij) - dy)**2.)
 *                 arr[ii,ij] = h + a * exp((-r**2.)/(2.*(w**2.)))
 */
          __pyx_t_10 = __pyx_v_ny;
          for (__pyx_t_11 = 0; __pyx_t_11 < __pyx_t_10; __pyx_t_11+=1) {
            __pyx_v_ij = __pyx_t_11;

            /* "orb/cutils.pyx":339
 *         for ii in range(nx):
 *             for ij in range(ny):
 *                 r = sqrt(((<double> ii) - dx)**2. + ((<double> ij) - dy)**2.)             # <<<<<<<<<<<<<<
 *                 arr[ii,ij] = h + a * exp((-r**2.)/(2.*(w**2.)))
 * 
 */
            __pyx_v_r = sqrt((pow((((double)__pyx_v_ii) - __pyx_v_dx), 2.) + pow((((double)__pyx_v_ij) - __pyx_v_dy), 2.)));

            /* "orb/cutils.pyx":340
 *             for ij in range(ny):
 *                 r = sqrt(((<double> ii) - dx)**2. + ((<double> ij) - dy)**2.)
 *                 arr[ii,ij] = h + a * exp((-r**2.)/(2.*(w**2.)))             # <<<<<<<<<<<<<<
 * 
 *     return arr
 */
            __pyx_t_7 = (-pow(__pyx_v_r, 2.));
            __pyx_t_12 = (2. * pow(__pyx_v_w, 2.));
            if (unlikely(__pyx_t_12 == 0)) {
              #ifdef WITH_THREAD
              PyGILState_STATE __pyx_gilstate_save = PyGILState_Ensure();
              #endif
              PyErr_SetString(PyExc_ZeroDivisionError, "float division");
              #ifdef WITH_THREAD
              PyGILState_Release(__pyx_gilstate_save);
              #endif
              __PYX_ERR(0, 340, __pyx_L4_error)
            }
            __pyx_t_13 = __pyx_v_ii;
            __pyx_t_14 = __pyx_v_ij;
            *__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_arr.rcbuffer->pybuffer.buf, __pyx_t_13, __pyx_pybuffernd_arr.diminfo[0].strides, __pyx_t_14, __pyx_pybuffernd_arr.diminfo[1].strides) = (__pyx_v_h + (__pyx_v_a * exp((__pyx_t_7 / __pyx_t_12))));
          }
        }
      }

      /* "orb/cutils.pyx":336
 *     cdef int ii, ij
 * 
 *     with nogil:             # <<<<<<<<<<<<<<
 *         for ii in range(nx):
 *             for ij in range(ny):
 */
      /*finally:*/ {
        /*normal exit:*/{
          #ifdef WITH_THREAD
          Py_BLOCK_THREADS
          #endif
          goto __pyx_L5;
        }
        __pyx_L4_error: {
          #ifdef WITH_THREAD
          Py_BLOCK_THREADS
          #endif
          goto __pyx_L1_error;
        }
        __pyx_L5:;
      }
  }

  /* "orb/cutils.pyx":342
 *                 arr[ii,ij] = h + a * exp((-r**2.)/(2.*(w**2.)))
 * 
 *     return arr             # <<<<<<<<<<<<<<
 * 
 * def moffat_array2d(double h, double a, double dx, double dy,
 */
  __Pyx_XDECREF(__pyx_r);
  __Pyx_INCREF(((PyObject *)__pyx_v_arr));
  __pyx_r = ((PyObject *)__pyx_v_arr);
  goto __pyx_L0;

  /* "orb/cutils.pyx":318
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def gaussian_array2d(double h, double a, double dx, double dy, double fwhm,             # <<<<<<<<<<<<<<
 *                      int nx, int ny):
 *     """Return the 2D profile of a gaussian
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_1);
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_XDECREF(__pyx_t_5);
  { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
    __Pyx_PyThreadState_declare
    __Pyx_PyThreadState_assign
    __Pyx_ErrFetch(&__pyx_type, &__pyx_value, &__pyx_tb);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_arr.rcbuffer->pybuffer);
  __Pyx_ErrRestore(__pyx_type, __pyx_value, __pyx_tb);}
  __Pyx_AddTraceback("orb.cutils.gaussian_array2d", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  goto __pyx_L2;
  __pyx_L0:;
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_arr.rcbuffer->pybuffer);
  __pyx_L2:;
  __Pyx_XDECREF((PyObject *)__pyx_v_arr);
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":344
 *     return arr
 * 
 * def moffat_array2d(double h, double a, double dx, double dy,             # <<<<<<<<<<<<<<
 *                    double fwhm, double beta, int nx, int ny):
 * 
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_15moffat_array2d(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_3orb_6cutils_14moffat_array2d[] = "moffat_array2d(double h, double a, double dx, double dy, double fwhm, double beta, int nx, int ny)\nReturn the 2D profile of a moffat\n\n    :param h: Height\n    :param a: Amplitude\n    :param dx: X position\n    :param dy: Y position\n    :param fwhm: FWHM\n    :param beta: Beta\n    :param nx: X dimension of the output array\n    :param ny: Y dimension of the output array\n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_15moffat_array2d = {"moffat_array2d", (PyCFunction)__pyx_pw_3orb_6cutils_15moffat_array2d, METH_VARARGS|METH_KEYWORDS, __pyx_doc_3orb_6cutils_14moffat_array2d};
static PyObject *__pyx_pw_3orb_6cutils_15moffat_array2d(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  double __pyx_v_h;
  double __pyx_v_a;
  double __pyx_v_dx;
  double __pyx_v_dy;
  double __pyx_v_fwhm;
  double __pyx_v_beta;
  int __pyx_v_nx;
  int __pyx_v_ny;
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("moffat_array2d (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_h,&__pyx_n_s_a,&__pyx_n_s_dx,&__pyx_n_s_dy,&__pyx_n_s_fwhm,&__pyx_n_s_beta,&__pyx_n_s_nx,&__pyx_n_s_ny,0};
    PyObject* values[8] = {0,0,0,0,0,0,0,0};
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
      switch (pos_args) {
        case  8: values[7] = PyTuple_GET_ITEM(__pyx_args, 7);
        case  7: values[6] = PyTuple_GET_ITEM(__pyx_args, 6);
        case  6: values[5] = PyTuple_GET_ITEM(__pyx_args, 5);
        case  5: values[4] = PyTuple_GET_ITEM(__pyx_args, 4);
        case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = PyDict_Size(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_h)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        case  1:
        if (likely((values[1] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_a)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("moffat_array2d", 1, 8, 8, 1); __PYX_ERR(0, 344, __pyx_L3_error)
        }
        case  2:
        if (likely((values[2] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_dx)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("moffat_array2d", 1, 8, 8, 2); __PYX_ERR(0, 344, __pyx_L3_error)
        }
        case  3:
        if (likely((values[3] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_dy)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("moffat_array2d", 1, 8, 8, 3); __PYX_ERR(0, 344, __pyx_L3_error)
        }
        case  4:
        if (likely((values[4] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_fwhm)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("moffat_array2d", 1, 8, 8, 4); __PYX_ERR(0, 344, __pyx_L3_error)
        }
        case  5:
        if (likely((values[5] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_beta)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("moffat_array2d", 1, 8, 8, 5); __PYX_ERR(0, 344, __pyx_L3_error)
        }
        case  6:
        if (likely((values[6] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_nx)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("moffat_array2d", 1, 8, 8, 6); __PYX_ERR(0, 344, __pyx_L3_error)
        }
        case  7:
        if (likely((values[7] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_ny)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("moffat_array2d", 1, 8, 8, 7); __PYX_ERR(0, 344, __pyx_L3_error)
        }
      }
      if (unlikely(kw_args > 0)) {
        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "moffat_array2d") < 0)) __PYX_ERR(0, 344, __pyx_L3_error)
      }
    } else if (PyTuple_GET_SIZE(__pyx_args) != 8) {
      goto __pyx_L5_argtuple_error;
    } else {
      values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
      values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
      values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
      values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
      values[4] = PyTuple_GET_ITEM(__pyx_args, 4);
      values[5] = PyTuple_GET_ITEM(__pyx_args, 5);
      values[6] = PyTuple_GET_ITEM(__pyx_args, 6);
      values[7] = PyTuple_GET_ITEM(__pyx_args, 7);
    }
    __pyx_v_h = __pyx_PyFloat_AsDouble(values[0]); if (unlikely((__pyx_v_h == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 344, __pyx_L3_error)
    __pyx_v_a = __pyx_PyFloat_AsDouble(values[1]); if (unlikely((__pyx_v_a == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 344, __pyx_L3_error)
    __pyx_v_dx = __pyx_PyFloat_AsDouble(values[2]); if (unlikely((__pyx_v_dx == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 344, __pyx_L3_error)
    __pyx_v_dy = __pyx_PyFloat_AsDouble(values[3]); if (unlikely((__pyx_v_dy == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 344, __pyx_L3_error)
    __pyx_v_fwhm = __pyx_PyFloat_AsDouble(values[4]); if (unlikely((__pyx_v_fwhm == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 345, __pyx_L3_error)
    __pyx_v_beta = __pyx_PyFloat_AsDouble(values[5]); if (unlikely((__pyx_v_beta == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 345, __pyx_L3_error)
    __pyx_v_nx = __Pyx_PyInt_As_int(values[6]); if (unlikely((__pyx_v_nx == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 345, __pyx_L3_error)
    __pyx_v_ny = __Pyx_PyInt_As_int(values[7]); if (unlikely((__pyx_v_ny == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 345, __pyx_L3_error)
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  __Pyx_RaiseArgtupleInvalid("moffat_array2d", 1, 8, 8, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 344, __pyx_L3_error)
  __pyx_L3_error:;
  __Pyx_AddTraceback("orb.cutils.moffat_array2d", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __Pyx_RefNannyFinishContext();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  __pyx_r = __pyx_pf_3orb_6cutils_14moffat_array2d(__pyx_self, __pyx_v_h, __pyx_v_a, __pyx_v_dx, __pyx_v_dy, __pyx_v_fwhm, __pyx_v_beta, __pyx_v_nx, __pyx_v_ny);

  /* function exit code */
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_14moffat_array2d(CYTHON_UNUSED PyObject *__pyx_self, double __pyx_v_h, double __pyx_v_a, double __pyx_v_dx, double __pyx_v_dy, double __pyx_v_fwhm, double __pyx_v_beta, int __pyx_v_nx, int __pyx_v_ny) {
  PyArrayObject *__pyx_v_arr = 0;
  double __pyx_v_r;
  CYTHON_UNUSED double __pyx_v_w;
  double __pyx_v_alpha;
  PyObject *__pyx_v_ii = NULL;
  PyObject *__pyx_v_ij = NULL;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_arr;
  __Pyx_Buffer __pyx_pybuffer_arr;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  PyObject *__pyx_t_1 = NULL;
  PyObject *__pyx_t_2 = NULL;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  PyObject *__pyx_t_5 = NULL;
  PyArrayObject *__pyx_t_6 = NULL;
  double __pyx_t_7;
  int __pyx_t_8;
  Py_ssize_t __pyx_t_9;
  PyObject *(*__pyx_t_10)(PyObject *);
  Py_ssize_t __pyx_t_11;
  PyObject *(*__pyx_t_12)(PyObject *);
  __Pyx_RefNannySetupContext("moffat_array2d", 0);
  __pyx_pybuffer_arr.pybuffer.buf = NULL;
  __pyx_pybuffer_arr.refcount = 0;
  __pyx_pybuffernd_arr.data = NULL;
  __pyx_pybuffernd_arr.rcbuffer = &__pyx_pybuffer_arr;

  /* "orb/cutils.pyx":358
 *     :param ny: Y dimension of the output array
 *     """
 *     cdef np.ndarray[np.float64_t, ndim=2] arr = np.zeros((nx, ny))             # <<<<<<<<<<<<<<
 *     cdef double r = 0.
 *     cdef double w = fwhm / (2. * sqrt(2. * log(2.)))
 */
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 358, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_zeros); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 358, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = __Pyx_PyInt_From_int(__pyx_v_nx); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 358, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_4 = __Pyx_PyInt_From_int(__pyx_v_ny); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 358, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_5 = PyTuple_New(2); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 358, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_GIVEREF(__pyx_t_2);
  PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_2);
  __Pyx_GIVEREF(__pyx_t_4);
  PyTuple_SET_ITEM(__pyx_t_5, 1, __pyx_t_4);
  __pyx_t_2 = 0;
  __pyx_t_4 = 0;
  __pyx_t_4 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_3))) {
    __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_3);
    if (likely(__pyx_t_4)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
      __Pyx_INCREF(__pyx_t_4);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_3, function);
    }
  }
  if (!__pyx_t_4) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_3, __pyx_t_5); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 358, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_2 = PyTuple_New(1+1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 358, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_4); __pyx_t_4 = NULL;
    __Pyx_GIVEREF(__pyx_t_5);
    PyTuple_SET_ITEM(__pyx_t_2, 0+1, __pyx_t_5);
    __pyx_t_5 = 0;
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_2, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 358, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  }
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 358, __pyx_L1_error)
  __pyx_t_6 = ((PyArrayObject *)__pyx_t_1);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_arr.rcbuffer->pybuffer, (PyObject*)__pyx_t_6, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
      __pyx_v_arr = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_arr.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 358, __pyx_L1_error)
    } else {__pyx_pybuffernd_arr.diminfo[0].strides = __pyx_pybuffernd_arr.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_arr.diminfo[0].shape = __pyx_pybuffernd_arr.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_arr.diminfo[1].strides = __pyx_pybuffernd_arr.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_arr.diminfo[1].shape = __pyx_pybuffernd_arr.rcbuffer->pybuffer.shape[1];
    }
  }
  __pyx_t_6 = 0;
  __pyx_v_arr = ((PyArrayObject *)__pyx_t_1);
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":359
 *     """
 *     cdef np.ndarray[np.float64_t, ndim=2] arr = np.zeros((nx, ny))
 *     cdef double r = 0.             # <<<<<<<<<<<<<<
 *     cdef double w = fwhm / (2. * sqrt(2. * log(2.)))
 *     cdef double alpha
 */
  __pyx_v_r = 0.;

  /* "orb/cutils.pyx":360
 *     cdef np.ndarray[np.float64_t, ndim=2] arr = np.zeros((nx, ny))
 *     cdef double r = 0.
 *     cdef double w = fwhm / (2. * sqrt(2. * log(2.)))             # <<<<<<<<<<<<<<
 *     cdef double alpha
 * 
 */
  __pyx_t_7 = (2. * sqrt((2. * log(2.))));
  if (unlikely(__pyx_t_7 == 0)) {
    PyErr_SetString(PyExc_ZeroDivisionError, "float division");
    __PYX_ERR(0, 360, __pyx_L1_error)
  }
  __pyx_v_w = (__pyx_v_fwhm / __pyx_t_7);

  /* "orb/cutils.pyx":363
 *     cdef double alpha
 * 
 *     if beta > 0.:             # <<<<<<<<<<<<<<
 *         alpha = fwhm / (2. * sqrt(2**(1. / beta) - 1.))
 * 
 */
  __pyx_t_8 = ((__pyx_v_beta > 0.) != 0);
  if (__pyx_t_8) {

    /* "orb/cutils.pyx":364
 * 
 *     if beta > 0.:
 *         alpha = fwhm / (2. * sqrt(2**(1. / beta) - 1.))             # <<<<<<<<<<<<<<
 * 
 *         for ii in range(nx):
 */
    if (unlikely(__pyx_v_beta == 0)) {
      PyErr_SetString(PyExc_ZeroDivisionError, "float division");
      __PYX_ERR(0, 364, __pyx_L1_error)
    }
    __pyx_t_7 = (2. * sqrt((pow(2.0, (1. / __pyx_v_beta)) - 1.)));
    if (unlikely(__pyx_t_7 == 0)) {
      PyErr_SetString(PyExc_ZeroDivisionError, "float division");
      __PYX_ERR(0, 364, __pyx_L1_error)
    }
    __pyx_v_alpha = (__pyx_v_fwhm / __pyx_t_7);

    /* "orb/cutils.pyx":366
 *         alpha = fwhm / (2. * sqrt(2**(1. / beta) - 1.))
 * 
 *         for ii in range(nx):             # <<<<<<<<<<<<<<
 *             for ij in range(ny):
 *                 r = sqrt((ii - dx)**2. + (ij - dy)**2.)
 */
    __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_nx); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 366, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 366, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_GIVEREF(__pyx_t_1);
    PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_1);
    __pyx_t_1 = 0;
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_builtin_range, __pyx_t_3, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 366, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    if (likely(PyList_CheckExact(__pyx_t_1)) || PyTuple_CheckExact(__pyx_t_1)) {
      __pyx_t_3 = __pyx_t_1; __Pyx_INCREF(__pyx_t_3); __pyx_t_9 = 0;
      __pyx_t_10 = NULL;
    } else {
      __pyx_t_9 = -1; __pyx_t_3 = PyObject_GetIter(__pyx_t_1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 366, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __pyx_t_10 = Py_TYPE(__pyx_t_3)->tp_iternext; if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 366, __pyx_L1_error)
    }
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    for (;;) {
      if (likely(!__pyx_t_10)) {
        if (likely(PyList_CheckExact(__pyx_t_3))) {
          if (__pyx_t_9 >= PyList_GET_SIZE(__pyx_t_3)) break;
          #if CYTHON_COMPILING_IN_CPYTHON
          __pyx_t_1 = PyList_GET_ITEM(__pyx_t_3, __pyx_t_9); __Pyx_INCREF(__pyx_t_1); __pyx_t_9++; if (unlikely(0 < 0)) __PYX_ERR(0, 366, __pyx_L1_error)
          #else
          __pyx_t_1 = PySequence_ITEM(__pyx_t_3, __pyx_t_9); __pyx_t_9++; if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 366, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_1);
          #endif
        } else {
          if (__pyx_t_9 >= PyTuple_GET_SIZE(__pyx_t_3)) break;
          #if CYTHON_COMPILING_IN_CPYTHON
          __pyx_t_1 = PyTuple_GET_ITEM(__pyx_t_3, __pyx_t_9); __Pyx_INCREF(__pyx_t_1); __pyx_t_9++; if (unlikely(0 < 0)) __PYX_ERR(0, 366, __pyx_L1_error)
          #else
          __pyx_t_1 = PySequence_ITEM(__pyx_t_3, __pyx_t_9); __pyx_t_9++; if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 366, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_1);
          #endif
        }
      } else {
        __pyx_t_1 = __pyx_t_10(__pyx_t_3);
        if (unlikely(!__pyx_t_1)) {
          PyObject* exc_type = PyErr_Occurred();
          if (exc_type) {
            if (likely(exc_type == PyExc_StopIteration || PyErr_GivenExceptionMatches(exc_type, PyExc_StopIteration))) PyErr_Clear();
            else __PYX_ERR(0, 366, __pyx_L1_error)
          }
          break;
        }
        __Pyx_GOTREF(__pyx_t_1);
      }
      __Pyx_XDECREF_SET(__pyx_v_ii, __pyx_t_1);
      __pyx_t_1 = 0;

      /* "orb/cutils.pyx":367
 * 
 *         for ii in range(nx):
 *             for ij in range(ny):             # <<<<<<<<<<<<<<
 *                 r = sqrt((ii - dx)**2. + (ij - dy)**2.)
 *                 arr[ii,ij] = h + a * (1. + (r/alpha)**2.)**(-beta)
 */
      __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_ny); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 367, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);
      __pyx_t_2 = PyTuple_New(1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 367, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __Pyx_GIVEREF(__pyx_t_1);
      PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_1);
      __pyx_t_1 = 0;
      __pyx_t_1 = __Pyx_PyObject_Call(__pyx_builtin_range, __pyx_t_2, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 367, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);
      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
      if (likely(PyList_CheckExact(__pyx_t_1)) || PyTuple_CheckExact(__pyx_t_1)) {
        __pyx_t_2 = __pyx_t_1; __Pyx_INCREF(__pyx_t_2); __pyx_t_11 = 0;
        __pyx_t_12 = NULL;
      } else {
        __pyx_t_11 = -1; __pyx_t_2 = PyObject_GetIter(__pyx_t_1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 367, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_2);
        __pyx_t_12 = Py_TYPE(__pyx_t_2)->tp_iternext; if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 367, __pyx_L1_error)
      }
      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
      for (;;) {
        if (likely(!__pyx_t_12)) {
          if (likely(PyList_CheckExact(__pyx_t_2))) {
            if (__pyx_t_11 >= PyList_GET_SIZE(__pyx_t_2)) break;
            #if CYTHON_COMPILING_IN_CPYTHON
            __pyx_t_1 = PyList_GET_ITEM(__pyx_t_2, __pyx_t_11); __Pyx_INCREF(__pyx_t_1); __pyx_t_11++; if (unlikely(0 < 0)) __PYX_ERR(0, 367, __pyx_L1_error)
            #else
            __pyx_t_1 = PySequence_ITEM(__pyx_t_2, __pyx_t_11); __pyx_t_11++; if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 367, __pyx_L1_error)
            __Pyx_GOTREF(__pyx_t_1);
            #endif
          } else {
            if (__pyx_t_11 >= PyTuple_GET_SIZE(__pyx_t_2)) break;
            #if CYTHON_COMPILING_IN_CPYTHON
            __pyx_t_1 = PyTuple_GET_ITEM(__pyx_t_2, __pyx_t_11); __Pyx_INCREF(__pyx_t_1); __pyx_t_11++; if (unlikely(0 < 0)) __PYX_ERR(0, 367, __pyx_L1_error)
            #else
            __pyx_t_1 = PySequence_ITEM(__pyx_t_2, __pyx_t_11); __pyx_t_11++; if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 367, __pyx_L1_error)
            __Pyx_GOTREF(__pyx_t_1);
            #endif
          }
        } else {
          __pyx_t_1 = __pyx_t_12(__pyx_t_2);
          if (unlikely(!__pyx_t_1)) {
            PyObject* exc_type = PyErr_Occurred();
            if (exc_type) {
              if (likely(exc_type == PyExc_StopIteration || PyErr_GivenExceptionMatches(exc_type, PyExc_StopIteration))) PyErr_Clear();
              else __PYX_ERR(0, 367, __pyx_L1_error)
            }
            break;
          }
          __Pyx_GOTREF(__pyx_t_1);
        }
        __Pyx_XDECREF_SET(__pyx_v_ij, __pyx_t_1);
        __pyx_t_1 = 0;

        /* "orb/cutils.pyx":368
 *         for ii in range(nx):
 *             for ij in range(ny):
 *                 r = sqrt((ii - dx)**2. + (ij - dy)**2.)             # <<<<<<<<<<<<<<
 *                 arr[ii,ij] = h + a * (1. + (r/alpha)**2.)**(-beta)
 *     else:
 */
        __pyx_t_1 = PyFloat_FromDouble(__pyx_v_dx); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 368, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_1);
        __pyx_t_5 = PyNumber_Subtract(__pyx_v_ii, __pyx_t_1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 368, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_5);
        __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
        __pyx_t_1 = PyNumber_Power(__pyx_t_5, __pyx_float_2_, Py_None); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 368, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_1);
        __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
        __pyx_t_5 = PyFloat_FromDouble(__pyx_v_dy); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 368, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_5);
        __pyx_t_4 = PyNumber_Subtract(__pyx_v_ij, __pyx_t_5); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 368, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_4);
        __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
        __pyx_t_5 = PyNumber_Power(__pyx_t_4, __pyx_float_2_, Py_None); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 368, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_5);
        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
        __pyx_t_4 = PyNumber_Add(__pyx_t_1, __pyx_t_5); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 368, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_4);
        __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
        __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
        __pyx_t_7 = __pyx_PyFloat_AsDouble(__pyx_t_4); if (unlikely((__pyx_t_7 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 368, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
        __pyx_v_r = sqrt(__pyx_t_7);

        /* "orb/cutils.pyx":369
 *             for ij in range(ny):
 *                 r = sqrt((ii - dx)**2. + (ij - dy)**2.)
 *                 arr[ii,ij] = h + a * (1. + (r/alpha)**2.)**(-beta)             # <<<<<<<<<<<<<<
 *     else:
 *         arr.fill(np.nan)
 */
        if (unlikely(__pyx_v_alpha == 0)) {
          PyErr_SetString(PyExc_ZeroDivisionError, "float division");
          __PYX_ERR(0, 369, __pyx_L1_error)
        }
        __pyx_t_4 = PyFloat_FromDouble((__pyx_v_h + (__pyx_v_a * pow((1. + pow((__pyx_v_r / __pyx_v_alpha), 2.)), (-__pyx_v_beta))))); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 369, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_4);
        __pyx_t_5 = PyTuple_New(2); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 369, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_5);
        __Pyx_INCREF(__pyx_v_ii);
        __Pyx_GIVEREF(__pyx_v_ii);
        PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_v_ii);
        __Pyx_INCREF(__pyx_v_ij);
        __Pyx_GIVEREF(__pyx_v_ij);
        PyTuple_SET_ITEM(__pyx_t_5, 1, __pyx_v_ij);
        if (unlikely(PyObject_SetItem(((PyObject *)__pyx_v_arr), __pyx_t_5, __pyx_t_4) < 0)) __PYX_ERR(0, 369, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;

        /* "orb/cutils.pyx":367
 * 
 *         for ii in range(nx):
 *             for ij in range(ny):             # <<<<<<<<<<<<<<
 *                 r = sqrt((ii - dx)**2. + (ij - dy)**2.)
 *                 arr[ii,ij] = h + a * (1. + (r/alpha)**2.)**(-beta)
 */
      }
      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;

      /* "orb/cutils.pyx":366
 *         alpha = fwhm / (2. * sqrt(2**(1. / beta) - 1.))
 * 
 *         for ii in range(nx):             # <<<<<<<<<<<<<<
 *             for ij in range(ny):
 *                 r = sqrt((ii - dx)**2. + (ij - dy)**2.)
 */
    }
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;

    /* "orb/cutils.pyx":363
 *     cdef double alpha
 * 
 *     if beta > 0.:             # <<<<<<<<<<<<<<
 *         alpha = fwhm / (2. * sqrt(2**(1. / beta) - 1.))
 * 
 */
    goto __pyx_L3;
  }

  /* "orb/cutils.pyx":371
 *                 arr[ii,ij] = h + a * (1. + (r/alpha)**2.)**(-beta)
 *     else:
 *         arr.fill(np.nan)             # <<<<<<<<<<<<<<
 * 
 *     return arr
 */
  /*else*/ {
    __pyx_t_2 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_arr), __pyx_n_s_fill); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 371, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 371, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_nan); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 371, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_t_4 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && likely(PyMethod_Check(__pyx_t_2))) {
      __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_2);
      if (likely(__pyx_t_4)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
        __Pyx_INCREF(__pyx_t_4);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_2, function);
      }
    }
    if (!__pyx_t_4) {
      __pyx_t_3 = __Pyx_PyObject_CallOneArg(__pyx_t_2, __pyx_t_5); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 371, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
      __Pyx_GOTREF(__pyx_t_3);
    } else {
      __pyx_t_1 = PyTuple_New(1+1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 371, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);
      __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_1, 0, __pyx_t_4); __pyx_t_4 = NULL;
      __Pyx_GIVEREF(__pyx_t_5);
      PyTuple_SET_ITEM(__pyx_t_1, 0+1, __pyx_t_5);
      __pyx_t_5 = 0;
      __pyx_t_3 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_1, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 371, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    }
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  }
  __pyx_L3:;

  /* "orb/cutils.pyx":373
 *         arr.fill(np.nan)
 * 
 *     return arr             # <<<<<<<<<<<<<<
 * 
 * @cython.boundscheck(False)
 */
  __Pyx_XDECREF(__pyx_r);
  __Pyx_INCREF(((PyObject *)__pyx_v_arr));
  __pyx_r = ((PyObject *)__pyx_v_arr);
  goto __pyx_L0;

  /* "orb/cutils.pyx":344
 *     return arr
 * 
 * def moffat_array2d(double h, double a, double dx, double dy,             # <<<<<<<<<<<<<<
 *                    double fwhm, double beta, int nx, int ny):
 * 
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_1);
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_XDECREF(__pyx_t_5);
  { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
    __Pyx_PyThreadState_declare
    __Pyx_PyThreadState_assign
    __Pyx_ErrFetch(&__pyx_type, &__pyx_value, &__pyx_tb);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_arr.rcbuffer->pybuffer);
  __Pyx_ErrRestore(__pyx_type, __pyx_value, __pyx_tb);}
  __Pyx_AddTraceback("orb.cutils.moffat_array2d", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  goto __pyx_L2;
  __pyx_L0:;
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_arr.rcbuffer->pybuffer);
  __pyx_L2:;
  __Pyx_XDECREF((PyObject *)__pyx_v_arr);
  __Pyx_XDECREF(__pyx_v_ii);
  __Pyx_XDECREF(__pyx_v_ij);
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":377
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def surface_value(int dimx, int dimy, double xc, double yc, double rmin,             # <<<<<<<<<<<<<<
 *                   double rmax, long sub_div):
 *     """Return an approximation of the surface value of a pixel given
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_17surface_value(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_3orb_6cutils_16surface_value[] = "surface_value(int dimx, int dimy, double xc, double yc, double rmin, double rmax, long sub_div)\nReturn an approximation of the surface value of a pixel given\n    the min and max radius of an annulus in pixels.\n\n    :param dimx: dimension of the box along x\n    \n    :param dimy: dimension of the box along y\n    \n    :param xc: center of the annulus along x\n    \n    :param yc: center of the annulus along y\n    \n    :param rmin: min radius of the annulus\n    \n    :param rmax: max radius of the annulus\n    \n    :param sub_div: Number of subdivisions to make (the higher,the\n      better but the longer too)\n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_17surface_value = {"surface_value", (PyCFunction)__pyx_pw_3orb_6cutils_17surface_value, METH_VARARGS|METH_KEYWORDS, __pyx_doc_3orb_6cutils_16surface_value};
static PyObject *__pyx_pw_3orb_6cutils_17surface_value(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  int __pyx_v_dimx;
  int __pyx_v_dimy;
  double __pyx_v_xc;
  double __pyx_v_yc;
  double __pyx_v_rmin;
  double __pyx_v_rmax;
  long __pyx_v_sub_div;
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("surface_value (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_dimx,&__pyx_n_s_dimy,&__pyx_n_s_xc,&__pyx_n_s_yc,&__pyx_n_s_rmin,&__pyx_n_s_rmax,&__pyx_n_s_sub_div,0};
    PyObject* values[7] = {0,0,0,0,0,0,0};
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
      switch (pos_args) {
        case  7: values[6] = PyTuple_GET_ITEM(__pyx_args, 6);
        case  6: values[5] = PyTuple_GET_ITEM(__pyx_args, 5);
        case  5: values[4] = PyTuple_GET_ITEM(__pyx_args, 4);
        case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = PyDict_Size(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_dimx)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        case  1:
        if (likely((values[1] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_dimy)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("surface_value", 1, 7, 7, 1); __PYX_ERR(0, 377, __pyx_L3_error)
        }
        case  2:
        if (likely((values[2] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_xc)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("surface_value", 1, 7, 7, 2); __PYX_ERR(0, 377, __pyx_L3_error)
        }
        case  3:
        if (likely((values[3] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_yc)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("surface_value", 1, 7, 7, 3); __PYX_ERR(0, 377, __pyx_L3_error)
        }
        case  4:
        if (likely((values[4] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_rmin)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("surface_value", 1, 7, 7, 4); __PYX_ERR(0, 377, __pyx_L3_error)
        }
        case  5:
        if (likely((values[5] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_rmax)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("surface_value", 1, 7, 7, 5); __PYX_ERR(0, 377, __pyx_L3_error)
        }
        case  6:
        if (likely((values[6] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_sub_div)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("surface_value", 1, 7, 7, 6); __PYX_ERR(0, 377, __pyx_L3_error)
        }
      }
      if (unlikely(kw_args > 0)) {
        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "surface_value") < 0)) __PYX_ERR(0, 377, __pyx_L3_error)
      }
    } else if (PyTuple_GET_SIZE(__pyx_args) != 7) {
      goto __pyx_L5_argtuple_error;
    } else {
      values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
      values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
      values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
      values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
      values[4] = PyTuple_GET_ITEM(__pyx_args, 4);
      values[5] = PyTuple_GET_ITEM(__pyx_args, 5);
      values[6] = PyTuple_GET_ITEM(__pyx_args, 6);
    }
    __pyx_v_dimx = __Pyx_PyInt_As_int(values[0]); if (unlikely((__pyx_v_dimx == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 377, __pyx_L3_error)
    __pyx_v_dimy = __Pyx_PyInt_As_int(values[1]); if (unlikely((__pyx_v_dimy == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 377, __pyx_L3_error)
    __pyx_v_xc = __pyx_PyFloat_AsDouble(values[2]); if (unlikely((__pyx_v_xc == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 377, __pyx_L3_error)
    __pyx_v_yc = __pyx_PyFloat_AsDouble(values[3]); if (unlikely((__pyx_v_yc == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 377, __pyx_L3_error)
    __pyx_v_rmin = __pyx_PyFloat_AsDouble(values[4]); if (unlikely((__pyx_v_rmin == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 377, __pyx_L3_error)
    __pyx_v_rmax = __pyx_PyFloat_AsDouble(values[5]); if (unlikely((__pyx_v_rmax == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 378, __pyx_L3_error)
    __pyx_v_sub_div = __Pyx_PyInt_As_long(values[6]); if (unlikely((__pyx_v_sub_div == (long)-1) && PyErr_Occurred())) __PYX_ERR(0, 378, __pyx_L3_error)
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  __Pyx_RaiseArgtupleInvalid("surface_value", 1, 7, 7, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 377, __pyx_L3_error)
  __pyx_L3_error:;
  __Pyx_AddTraceback("orb.cutils.surface_value", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __Pyx_RefNannyFinishContext();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  __pyx_r = __pyx_pf_3orb_6cutils_16surface_value(__pyx_self, __pyx_v_dimx, __pyx_v_dimy, __pyx_v_xc, __pyx_v_yc, __pyx_v_rmin, __pyx_v_rmax, __pyx_v_sub_div);

  /* function exit code */
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_16surface_value(CYTHON_UNUSED PyObject *__pyx_self, int __pyx_v_dimx, int __pyx_v_dimy, double __pyx_v_xc, double __pyx_v_yc, double __pyx_v_rmin, double __pyx_v_rmax, long __pyx_v_sub_div) {
  double __pyx_v_dsub_div;
  double __pyx_v_value;
  int __pyx_v_isub;
  int __pyx_v_jsub;
  double __pyx_v_r;
  int __pyx_v_sub_dimx;
  int __pyx_v_sub_dimy;
  PyArrayObject *__pyx_v_S = 0;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_S;
  __Pyx_Buffer __pyx_pybuffer_S;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  double __pyx_t_1;
  PyObject *__pyx_t_2 = NULL;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  PyObject *__pyx_t_5 = NULL;
  PyObject *__pyx_t_6 = NULL;
  PyArrayObject *__pyx_t_7 = NULL;
  int __pyx_t_8;
  int __pyx_t_9;
  int __pyx_t_10;
  int __pyx_t_11;
  int __pyx_t_12;
  int __pyx_t_13;
  Py_ssize_t __pyx_t_14;
  Py_ssize_t __pyx_t_15;
  __Pyx_RefNannySetupContext("surface_value", 0);
  __pyx_pybuffer_S.pybuffer.buf = NULL;
  __pyx_pybuffer_S.refcount = 0;
  __pyx_pybuffernd_S.data = NULL;
  __pyx_pybuffernd_S.rcbuffer = &__pyx_pybuffer_S;

  /* "orb/cutils.pyx":397
 *       better but the longer too)
 *     """
 *     cdef double dsub_div = <double> sub_div             # <<<<<<<<<<<<<<
 *     cdef double value = 1. / dsub_div**2
 *     cdef int isub
 */
  __pyx_v_dsub_div = ((double)__pyx_v_sub_div);

  /* "orb/cutils.pyx":398
 *     """
 *     cdef double dsub_div = <double> sub_div
 *     cdef double value = 1. / dsub_div**2             # <<<<<<<<<<<<<<
 *     cdef int isub
 *     cdef int jsub
 */
  __pyx_t_1 = pow(__pyx_v_dsub_div, 2.0);
  if (unlikely(__pyx_t_1 == 0)) {
    PyErr_SetString(PyExc_ZeroDivisionError, "float division");
    __PYX_ERR(0, 398, __pyx_L1_error)
  }
  __pyx_v_value = (1. / __pyx_t_1);

  /* "orb/cutils.pyx":402
 *     cdef int jsub
 *     cdef double r
 *     cdef int sub_dimx = dimx * sub_div             # <<<<<<<<<<<<<<
 *     cdef int sub_dimy = dimy * sub_div
 *     cdef np.ndarray[np.float64_t, ndim=2] S = np.zeros((dimx, dimy))
 */
  __pyx_v_sub_dimx = (__pyx_v_dimx * __pyx_v_sub_div);

  /* "orb/cutils.pyx":403
 *     cdef double r
 *     cdef int sub_dimx = dimx * sub_div
 *     cdef int sub_dimy = dimy * sub_div             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.float64_t, ndim=2] S = np.zeros((dimx, dimy))
 * 
 */
  __pyx_v_sub_dimy = (__pyx_v_dimy * __pyx_v_sub_div);

  /* "orb/cutils.pyx":404
 *     cdef int sub_dimx = dimx * sub_div
 *     cdef int sub_dimy = dimy * sub_div
 *     cdef np.ndarray[np.float64_t, ndim=2] S = np.zeros((dimx, dimy))             # <<<<<<<<<<<<<<
 * 
 *     xc += 0.5
 */
  __pyx_t_3 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 404, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_zeros); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 404, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_3 = __Pyx_PyInt_From_int(__pyx_v_dimx); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 404, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_5 = __Pyx_PyInt_From_int(__pyx_v_dimy); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 404, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_6 = PyTuple_New(2); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 404, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __Pyx_GIVEREF(__pyx_t_3);
  PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_3);
  __Pyx_GIVEREF(__pyx_t_5);
  PyTuple_SET_ITEM(__pyx_t_6, 1, __pyx_t_5);
  __pyx_t_3 = 0;
  __pyx_t_5 = 0;
  __pyx_t_5 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_4))) {
    __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_4);
    if (likely(__pyx_t_5)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
      __Pyx_INCREF(__pyx_t_5);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_4, function);
    }
  }
  if (!__pyx_t_5) {
    __pyx_t_2 = __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_6); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 404, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
    __Pyx_GOTREF(__pyx_t_2);
  } else {
    __pyx_t_3 = PyTuple_New(1+1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 404, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_5); __pyx_t_5 = NULL;
    __Pyx_GIVEREF(__pyx_t_6);
    PyTuple_SET_ITEM(__pyx_t_3, 0+1, __pyx_t_6);
    __pyx_t_6 = 0;
    __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_3, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 404, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  }
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  if (!(likely(((__pyx_t_2) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_2, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 404, __pyx_L1_error)
  __pyx_t_7 = ((PyArrayObject *)__pyx_t_2);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_S.rcbuffer->pybuffer, (PyObject*)__pyx_t_7, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 2, 0, __pyx_stack) == -1)) {
      __pyx_v_S = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_S.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 404, __pyx_L1_error)
    } else {__pyx_pybuffernd_S.diminfo[0].strides = __pyx_pybuffernd_S.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_S.diminfo[0].shape = __pyx_pybuffernd_S.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_S.diminfo[1].strides = __pyx_pybuffernd_S.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_S.diminfo[1].shape = __pyx_pybuffernd_S.rcbuffer->pybuffer.shape[1];
    }
  }
  __pyx_t_7 = 0;
  __pyx_v_S = ((PyArrayObject *)__pyx_t_2);
  __pyx_t_2 = 0;

  /* "orb/cutils.pyx":406
 *     cdef np.ndarray[np.float64_t, ndim=2] S = np.zeros((dimx, dimy))
 * 
 *     xc += 0.5             # <<<<<<<<<<<<<<
 *     yc += 0.5
 * 
 */
  __pyx_v_xc = (__pyx_v_xc + 0.5);

  /* "orb/cutils.pyx":407
 * 
 *     xc += 0.5
 *     yc += 0.5             # <<<<<<<<<<<<<<
 * 
 *     with nogil:
 */
  __pyx_v_yc = (__pyx_v_yc + 0.5);

  /* "orb/cutils.pyx":409
 *     yc += 0.5
 * 
 *     with nogil:             # <<<<<<<<<<<<<<
 *         for isub in range(sub_dimx):
 *             for jsub in range(sub_dimy):
 */
  {
      #ifdef WITH_THREAD
      PyThreadState *_save;
      Py_UNBLOCK_THREADS
      #endif
      /*try:*/ {

        /* "orb/cutils.pyx":410
 * 
 *     with nogil:
 *         for isub in range(sub_dimx):             # <<<<<<<<<<<<<<
 *             for jsub in range(sub_dimy):
 *                 r = sqrt(((<double> isub) - (xc * dsub_div - 0.5))**2.
 */
        __pyx_t_8 = __pyx_v_sub_dimx;
        for (__pyx_t_9 = 0; __pyx_t_9 < __pyx_t_8; __pyx_t_9+=1) {
          __pyx_v_isub = __pyx_t_9;

          /* "orb/cutils.pyx":411
 *     with nogil:
 *         for isub in range(sub_dimx):
 *             for jsub in range(sub_dimy):             # <<<<<<<<<<<<<<
 *                 r = sqrt(((<double> isub) - (xc * dsub_div - 0.5))**2.
 *                          + ((<double> jsub) - (yc * dsub_div - 0.5))**2.)
 */
          __pyx_t_10 = __pyx_v_sub_dimy;
          for (__pyx_t_11 = 0; __pyx_t_11 < __pyx_t_10; __pyx_t_11+=1) {
            __pyx_v_jsub = __pyx_t_11;

            /* "orb/cutils.pyx":412
 *         for isub in range(sub_dimx):
 *             for jsub in range(sub_dimy):
 *                 r = sqrt(((<double> isub) - (xc * dsub_div - 0.5))**2.             # <<<<<<<<<<<<<<
 *                          + ((<double> jsub) - (yc * dsub_div - 0.5))**2.)
 *                 if r <= rmax * dsub_div and r >= rmin * dsub_div:
 */
            __pyx_v_r = sqrt((pow((((double)__pyx_v_isub) - ((__pyx_v_xc * __pyx_v_dsub_div) - 0.5)), 2.) + pow((((double)__pyx_v_jsub) - ((__pyx_v_yc * __pyx_v_dsub_div) - 0.5)), 2.)));

            /* "orb/cutils.pyx":414
 *                 r = sqrt(((<double> isub) - (xc * dsub_div - 0.5))**2.
 *                          + ((<double> jsub) - (yc * dsub_div - 0.5))**2.)
 *                 if r <= rmax * dsub_div and r >= rmin * dsub_div:             # <<<<<<<<<<<<<<
 *                     S[<int>((<double>isub)/dsub_div),
 *                       <int>((<double>jsub)/dsub_div)] += value
 */
            __pyx_t_13 = ((__pyx_v_r <= (__pyx_v_rmax * __pyx_v_dsub_div)) != 0);
            if (__pyx_t_13) {
            } else {
              __pyx_t_12 = __pyx_t_13;
              goto __pyx_L11_bool_binop_done;
            }
            __pyx_t_13 = ((__pyx_v_r >= (__pyx_v_rmin * __pyx_v_dsub_div)) != 0);
            __pyx_t_12 = __pyx_t_13;
            __pyx_L11_bool_binop_done:;
            if (__pyx_t_12) {

              /* "orb/cutils.pyx":415
 *                          + ((<double> jsub) - (yc * dsub_div - 0.5))**2.)
 *                 if r <= rmax * dsub_div and r >= rmin * dsub_div:
 *                     S[<int>((<double>isub)/dsub_div),             # <<<<<<<<<<<<<<
 *                       <int>((<double>jsub)/dsub_div)] += value
 * 
 */
              if (unlikely(__pyx_v_dsub_div == 0)) {
                #ifdef WITH_THREAD
                PyGILState_STATE __pyx_gilstate_save = PyGILState_Ensure();
                #endif
                PyErr_SetString(PyExc_ZeroDivisionError, "float division");
                #ifdef WITH_THREAD
                PyGILState_Release(__pyx_gilstate_save);
                #endif
                __PYX_ERR(0, 415, __pyx_L4_error)
              }

              /* "orb/cutils.pyx":416
 *                 if r <= rmax * dsub_div and r >= rmin * dsub_div:
 *                     S[<int>((<double>isub)/dsub_div),
 *                       <int>((<double>jsub)/dsub_div)] += value             # <<<<<<<<<<<<<<
 * 
 *     return S
 */
              if (unlikely(__pyx_v_dsub_div == 0)) {
                #ifdef WITH_THREAD
                PyGILState_STATE __pyx_gilstate_save = PyGILState_Ensure();
                #endif
                PyErr_SetString(PyExc_ZeroDivisionError, "float division");
                #ifdef WITH_THREAD
                PyGILState_Release(__pyx_gilstate_save);
                #endif
                __PYX_ERR(0, 416, __pyx_L4_error)
              }
              __pyx_t_14 = ((int)(((double)__pyx_v_isub) / __pyx_v_dsub_div));
              __pyx_t_15 = ((int)(((double)__pyx_v_jsub) / __pyx_v_dsub_div));
              *__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_S.rcbuffer->pybuffer.buf, __pyx_t_14, __pyx_pybuffernd_S.diminfo[0].strides, __pyx_t_15, __pyx_pybuffernd_S.diminfo[1].strides) += __pyx_v_value;

              /* "orb/cutils.pyx":414
 *                 r = sqrt(((<double> isub) - (xc * dsub_div - 0.5))**2.
 *                          + ((<double> jsub) - (yc * dsub_div - 0.5))**2.)
 *                 if r <= rmax * dsub_div and r >= rmin * dsub_div:             # <<<<<<<<<<<<<<
 *                     S[<int>((<double>isub)/dsub_div),
 *                       <int>((<double>jsub)/dsub_div)] += value
 */
            }
          }
        }
      }

      /* "orb/cutils.pyx":409
 *     yc += 0.5
 * 
 *     with nogil:             # <<<<<<<<<<<<<<
 *         for isub in range(sub_dimx):
 *             for jsub in range(sub_dimy):
 */
      /*finally:*/ {
        /*normal exit:*/{
          #ifdef WITH_THREAD
          Py_BLOCK_THREADS
          #endif
          goto __pyx_L5;
        }
        __pyx_L4_error: {
          #ifdef WITH_THREAD
          Py_BLOCK_THREADS
          #endif
          goto __pyx_L1_error;
        }
        __pyx_L5:;
      }
  }

  /* "orb/cutils.pyx":418
 *                       <int>((<double>jsub)/dsub_div)] += value
 * 
 *     return S             # <<<<<<<<<<<<<<
 * 
 * 
 */
  __Pyx_XDECREF(__pyx_r);
  __Pyx_INCREF(((PyObject *)__pyx_v_S));
  __pyx_r = ((PyObject *)__pyx_v_S);
  goto __pyx_L0;

  /* "orb/cutils.pyx":377
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def surface_value(int dimx, int dimy, double xc, double yc, double rmin,             # <<<<<<<<<<<<<<
 *                   double rmax, long sub_div):
 *     """Return an approximation of the surface value of a pixel given
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_XDECREF(__pyx_t_5);
  __Pyx_XDECREF(__pyx_t_6);
  { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
    __Pyx_PyThreadState_declare
    __Pyx_PyThreadState_assign
    __Pyx_ErrFetch(&__pyx_type, &__pyx_value, &__pyx_tb);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_S.rcbuffer->pybuffer);
  __Pyx_ErrRestore(__pyx_type, __pyx_value, __pyx_tb);}
  __Pyx_AddTraceback("orb.cutils.surface_value", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  goto __pyx_L2;
  __pyx_L0:;
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_S.rcbuffer->pybuffer);
  __pyx_L2:;
  __Pyx_XDECREF((PyObject *)__pyx_v_S);
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":421
 * 
 * 
 * def sigmacut(np.ndarray[np.float64_t, ndim=1] x, double central_value,             # <<<<<<<<<<<<<<
 *              int use_central_value, double sigma, int min_values,
 *              return_index_list=False):
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_19sigmacut(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_3orb_6cutils_18sigmacut[] = "sigmacut(ndarray x, double central_value, int use_central_value, double sigma, int min_values, return_index_list=False)\nReturn a distribution after a sigma cut rejection\n    of the too deviant values.\n\n    :param x: The distribution to cut\n    \n    :param sigma: Number of sigma above which values are considered as\n      deviant\n\n    :param min_values: Minimum number of values to return\n\n    :param central_value: If not none, this value is used as the\n      central value of the cut. Else the median of the distribution is\n      used as the central value\n\n    :param use_central_value: If True central value is used instead of\n      the median.\n\n    :param return_index_list: (Optional) If True the list of the non\n      rejected values is returned also (default False).\n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_19sigmacut = {"sigmacut", (PyCFunction)__pyx_pw_3orb_6cutils_19sigmacut, METH_VARARGS|METH_KEYWORDS, __pyx_doc_3orb_6cutils_18sigmacut};
static PyObject *__pyx_pw_3orb_6cutils_19sigmacut(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  PyArrayObject *__pyx_v_x = 0;
  double __pyx_v_central_value;
  int __pyx_v_use_central_value;
  double __pyx_v_sigma;
  int __pyx_v_min_values;
  PyObject *__pyx_v_return_index_list = 0;
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("sigmacut (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_x,&__pyx_n_s_central_value,&__pyx_n_s_use_central_value,&__pyx_n_s_sigma,&__pyx_n_s_min_values,&__pyx_n_s_return_index_list,0};
    PyObject* values[6] = {0,0,0,0,0,0};

    /* "orb/cutils.pyx":423
 * def sigmacut(np.ndarray[np.float64_t, ndim=1] x, double central_value,
 *              int use_central_value, double sigma, int min_values,
 *              return_index_list=False):             # <<<<<<<<<<<<<<
 *     """Return a distribution after a sigma cut rejection
 *     of the too deviant values.
 */
    values[5] = ((PyObject *)Py_False);
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
      switch (pos_args) {
        case  6: values[5] = PyTuple_GET_ITEM(__pyx_args, 5);
        case  5: values[4] = PyTuple_GET_ITEM(__pyx_args, 4);
        case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = PyDict_Size(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_x)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        case  1:
        if (likely((values[1] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_central_value)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("sigmacut", 0, 5, 6, 1); __PYX_ERR(0, 421, __pyx_L3_error)
        }
        case  2:
        if (likely((values[2] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_use_central_value)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("sigmacut", 0, 5, 6, 2); __PYX_ERR(0, 421, __pyx_L3_error)
        }
        case  3:
        if (likely((values[3] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_sigma)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("sigmacut", 0, 5, 6, 3); __PYX_ERR(0, 421, __pyx_L3_error)
        }
        case  4:
        if (likely((values[4] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_min_values)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("sigmacut", 0, 5, 6, 4); __PYX_ERR(0, 421, __pyx_L3_error)
        }
        case  5:
        if (kw_args > 0) {
          PyObject* value = PyDict_GetItem(__pyx_kwds, __pyx_n_s_return_index_list);
          if (value) { values[5] = value; kw_args--; }
        }
      }
      if (unlikely(kw_args > 0)) {
        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "sigmacut") < 0)) __PYX_ERR(0, 421, __pyx_L3_error)
      }
    } else {
      switch (PyTuple_GET_SIZE(__pyx_args)) {
        case  6: values[5] = PyTuple_GET_ITEM(__pyx_args, 5);
        case  5: values[4] = PyTuple_GET_ITEM(__pyx_args, 4);
        values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
        values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        break;
        default: goto __pyx_L5_argtuple_error;
      }
    }
    __pyx_v_x = ((PyArrayObject *)values[0]);
    __pyx_v_central_value = __pyx_PyFloat_AsDouble(values[1]); if (unlikely((__pyx_v_central_value == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 421, __pyx_L3_error)
    __pyx_v_use_central_value = __Pyx_PyInt_As_int(values[2]); if (unlikely((__pyx_v_use_central_value == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 422, __pyx_L3_error)
    __pyx_v_sigma = __pyx_PyFloat_AsDouble(values[3]); if (unlikely((__pyx_v_sigma == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 422, __pyx_L3_error)
    __pyx_v_min_values = __Pyx_PyInt_As_int(values[4]); if (unlikely((__pyx_v_min_values == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 422, __pyx_L3_error)
    __pyx_v_return_index_list = values[5];
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  __Pyx_RaiseArgtupleInvalid("sigmacut", 0, 5, 6, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 421, __pyx_L3_error)
  __pyx_L3_error:;
  __Pyx_AddTraceback("orb.cutils.sigmacut", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __Pyx_RefNannyFinishContext();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_x), __pyx_ptype_5numpy_ndarray, 1, "x", 0))) __PYX_ERR(0, 421, __pyx_L1_error)
  __pyx_r = __pyx_pf_3orb_6cutils_18sigmacut(__pyx_self, __pyx_v_x, __pyx_v_central_value, __pyx_v_use_central_value, __pyx_v_sigma, __pyx_v_min_values, __pyx_v_return_index_list);

  /* "orb/cutils.pyx":421
 * 
 * 
 * def sigmacut(np.ndarray[np.float64_t, ndim=1] x, double central_value,             # <<<<<<<<<<<<<<
 *              int use_central_value, double sigma, int min_values,
 *              return_index_list=False):
 */

  /* function exit code */
  goto __pyx_L0;
  __pyx_L1_error:;
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_18sigmacut(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_x, double __pyx_v_central_value, int __pyx_v_use_central_value, double __pyx_v_sigma, int __pyx_v_min_values, PyObject *__pyx_v_return_index_list) {
  int __pyx_v_still_rejection;
  double __pyx_v_central_x;
  int __pyx_v_new_sz;
  int __pyx_v_sz;
  PyObject *__pyx_v_index_list = NULL;
  PyObject *__pyx_v_std_x = NULL;
  PyObject *__pyx_v_new_x = NULL;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_x;
  __Pyx_Buffer __pyx_pybuffer_x;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  int __pyx_t_1;
  PyObject *__pyx_t_2 = NULL;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  PyObject *__pyx_t_5 = NULL;
  PyObject *__pyx_t_6 = NULL;
  PyObject *__pyx_t_7 = NULL;
  PyArrayObject *__pyx_t_8 = NULL;
  int __pyx_t_9;
  PyObject *__pyx_t_10 = NULL;
  PyObject *__pyx_t_11 = NULL;
  PyObject *__pyx_t_12 = NULL;
  double __pyx_t_13;
  int __pyx_t_14;
  __Pyx_RefNannySetupContext("sigmacut", 0);
  __Pyx_INCREF((PyObject *)__pyx_v_x);
  __pyx_pybuffer_x.pybuffer.buf = NULL;
  __pyx_pybuffer_x.refcount = 0;
  __pyx_pybuffernd_x.data = NULL;
  __pyx_pybuffernd_x.rcbuffer = &__pyx_pybuffer_x;
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_x.rcbuffer->pybuffer, (PyObject*)__pyx_v_x, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) __PYX_ERR(0, 421, __pyx_L1_error)
  }
  __pyx_pybuffernd_x.diminfo[0].strides = __pyx_pybuffernd_x.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_x.diminfo[0].shape = __pyx_pybuffernd_x.rcbuffer->pybuffer.shape[0];

  /* "orb/cutils.pyx":444
 *       rejected values is returned also (default False).
 *     """
 *     cdef int still_rejection = 1             # <<<<<<<<<<<<<<
 *     cdef double central_x
 *     cdef int new_sz
 */
  __pyx_v_still_rejection = 1;

  /* "orb/cutils.pyx":449
 *     cdef int sz
 * 
 *     if return_index_list:             # <<<<<<<<<<<<<<
 *         index_list = np.arange(np.size(x))
 * 
 */
  __pyx_t_1 = __Pyx_PyObject_IsTrue(__pyx_v_return_index_list); if (unlikely(__pyx_t_1 < 0)) __PYX_ERR(0, 449, __pyx_L1_error)
  if (__pyx_t_1) {

    /* "orb/cutils.pyx":450
 * 
 *     if return_index_list:
 *         index_list = np.arange(np.size(x))             # <<<<<<<<<<<<<<
 * 
 *     if bn.anynan(x):
 */
    __pyx_t_3 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 450, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_arange); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 450, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 450, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_size); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 450, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    __pyx_t_5 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_6))) {
      __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_6);
      if (likely(__pyx_t_5)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_6);
        __Pyx_INCREF(__pyx_t_5);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_6, function);
      }
    }
    if (!__pyx_t_5) {
      __pyx_t_3 = __Pyx_PyObject_CallOneArg(__pyx_t_6, ((PyObject *)__pyx_v_x)); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 450, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
    } else {
      __pyx_t_7 = PyTuple_New(1+1); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 450, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_7);
      __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_7, 0, __pyx_t_5); __pyx_t_5 = NULL;
      __Pyx_INCREF(((PyObject *)__pyx_v_x));
      __Pyx_GIVEREF(((PyObject *)__pyx_v_x));
      PyTuple_SET_ITEM(__pyx_t_7, 0+1, ((PyObject *)__pyx_v_x));
      __pyx_t_3 = __Pyx_PyObject_Call(__pyx_t_6, __pyx_t_7, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 450, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
    }
    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
    __pyx_t_6 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_4))) {
      __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_4);
      if (likely(__pyx_t_6)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
        __Pyx_INCREF(__pyx_t_6);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_4, function);
      }
    }
    if (!__pyx_t_6) {
      __pyx_t_2 = __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_3); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 450, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      __Pyx_GOTREF(__pyx_t_2);
    } else {
      __pyx_t_7 = PyTuple_New(1+1); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 450, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_7);
      __Pyx_GIVEREF(__pyx_t_6); PyTuple_SET_ITEM(__pyx_t_7, 0, __pyx_t_6); __pyx_t_6 = NULL;
      __Pyx_GIVEREF(__pyx_t_3);
      PyTuple_SET_ITEM(__pyx_t_7, 0+1, __pyx_t_3);
      __pyx_t_3 = 0;
      __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_7, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 450, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
    }
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_v_index_list = __pyx_t_2;
    __pyx_t_2 = 0;

    /* "orb/cutils.pyx":449
 *     cdef int sz
 * 
 *     if return_index_list:             # <<<<<<<<<<<<<<
 *         index_list = np.arange(np.size(x))
 * 
 */
  }

  /* "orb/cutils.pyx":452
 *         index_list = np.arange(np.size(x))
 * 
 *     if bn.anynan(x):             # <<<<<<<<<<<<<<
 *         x = x[np.nonzero(~np.isnan(x))]
 *         if return_index_list:
 */
  __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 452, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_7 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_anynan); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 452, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_7);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_4 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_7))) {
    __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_7);
    if (likely(__pyx_t_4)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_7);
      __Pyx_INCREF(__pyx_t_4);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_7, function);
    }
  }
  if (!__pyx_t_4) {
    __pyx_t_2 = __Pyx_PyObject_CallOneArg(__pyx_t_7, ((PyObject *)__pyx_v_x)); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 452, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
  } else {
    __pyx_t_3 = PyTuple_New(1+1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 452, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_4); __pyx_t_4 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_x));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_x));
    PyTuple_SET_ITEM(__pyx_t_3, 0+1, ((PyObject *)__pyx_v_x));
    __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_7, __pyx_t_3, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 452, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  }
  __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
  __pyx_t_1 = __Pyx_PyObject_IsTrue(__pyx_t_2); if (unlikely(__pyx_t_1 < 0)) __PYX_ERR(0, 452, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  if (__pyx_t_1) {

    /* "orb/cutils.pyx":453
 * 
 *     if bn.anynan(x):
 *         x = x[np.nonzero(~np.isnan(x))]             # <<<<<<<<<<<<<<
 *         if return_index_list:
 *             index_list = index_list[np.nonzero(~np.isnan(x))]
 */
    __pyx_t_7 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 453, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_7);
    __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_7, __pyx_n_s_nonzero); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 453, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
    __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 453, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_isnan); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 453, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_t_4 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_6))) {
      __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_6);
      if (likely(__pyx_t_4)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_6);
        __Pyx_INCREF(__pyx_t_4);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_6, function);
      }
    }
    if (!__pyx_t_4) {
      __pyx_t_7 = __Pyx_PyObject_CallOneArg(__pyx_t_6, ((PyObject *)__pyx_v_x)); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 453, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_7);
    } else {
      __pyx_t_5 = PyTuple_New(1+1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 453, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_4); __pyx_t_4 = NULL;
      __Pyx_INCREF(((PyObject *)__pyx_v_x));
      __Pyx_GIVEREF(((PyObject *)__pyx_v_x));
      PyTuple_SET_ITEM(__pyx_t_5, 0+1, ((PyObject *)__pyx_v_x));
      __pyx_t_7 = __Pyx_PyObject_Call(__pyx_t_6, __pyx_t_5, NULL); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 453, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_7);
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    }
    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
    __pyx_t_6 = PyNumber_Invert(__pyx_t_7); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 453, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
    __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
    __pyx_t_7 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_3))) {
      __pyx_t_7 = PyMethod_GET_SELF(__pyx_t_3);
      if (likely(__pyx_t_7)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
        __Pyx_INCREF(__pyx_t_7);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_3, function);
      }
    }
    if (!__pyx_t_7) {
      __pyx_t_2 = __Pyx_PyObject_CallOneArg(__pyx_t_3, __pyx_t_6); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 453, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
      __Pyx_GOTREF(__pyx_t_2);
    } else {
      __pyx_t_5 = PyTuple_New(1+1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 453, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __Pyx_GIVEREF(__pyx_t_7); PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_7); __pyx_t_7 = NULL;
      __Pyx_GIVEREF(__pyx_t_6);
      PyTuple_SET_ITEM(__pyx_t_5, 0+1, __pyx_t_6);
      __pyx_t_6 = 0;
      __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_5, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 453, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    }
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __pyx_t_3 = PyObject_GetItem(((PyObject *)__pyx_v_x), __pyx_t_2); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 453, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    if (!(likely(((__pyx_t_3) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_3, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 453, __pyx_L1_error)
    __pyx_t_8 = ((PyArrayObject *)__pyx_t_3);
    {
      __Pyx_BufFmt_StackElem __pyx_stack[1];
      __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_x.rcbuffer->pybuffer);
      __pyx_t_9 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_x.rcbuffer->pybuffer, (PyObject*)__pyx_t_8, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack);
      if (unlikely(__pyx_t_9 < 0)) {
        PyErr_Fetch(&__pyx_t_10, &__pyx_t_11, &__pyx_t_12);
        if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_x.rcbuffer->pybuffer, (PyObject*)__pyx_v_x, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
          Py_XDECREF(__pyx_t_10); Py_XDECREF(__pyx_t_11); Py_XDECREF(__pyx_t_12);
          __Pyx_RaiseBufferFallbackError();
        } else {
          PyErr_Restore(__pyx_t_10, __pyx_t_11, __pyx_t_12);
        }
      }
      __pyx_pybuffernd_x.diminfo[0].strides = __pyx_pybuffernd_x.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_x.diminfo[0].shape = __pyx_pybuffernd_x.rcbuffer->pybuffer.shape[0];
      if (unlikely(__pyx_t_9 < 0)) __PYX_ERR(0, 453, __pyx_L1_error)
    }
    __pyx_t_8 = 0;
    __Pyx_DECREF_SET(__pyx_v_x, ((PyArrayObject *)__pyx_t_3));
    __pyx_t_3 = 0;

    /* "orb/cutils.pyx":454
 *     if bn.anynan(x):
 *         x = x[np.nonzero(~np.isnan(x))]
 *         if return_index_list:             # <<<<<<<<<<<<<<
 *             index_list = index_list[np.nonzero(~np.isnan(x))]
 * 
 */
    __pyx_t_1 = __Pyx_PyObject_IsTrue(__pyx_v_return_index_list); if (unlikely(__pyx_t_1 < 0)) __PYX_ERR(0, 454, __pyx_L1_error)
    if (__pyx_t_1) {

      /* "orb/cutils.pyx":455
 *         x = x[np.nonzero(~np.isnan(x))]
 *         if return_index_list:
 *             index_list = index_list[np.nonzero(~np.isnan(x))]             # <<<<<<<<<<<<<<
 * 
 *     while still_rejection:
 */
      if (unlikely(!__pyx_v_index_list)) { __Pyx_RaiseUnboundLocalError("index_list"); __PYX_ERR(0, 455, __pyx_L1_error) }
      __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 455, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_nonzero); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 455, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
      __pyx_t_6 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 455, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_6);
      __pyx_t_7 = __Pyx_PyObject_GetAttrStr(__pyx_t_6, __pyx_n_s_isnan); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 455, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_7);
      __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
      __pyx_t_6 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_7))) {
        __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_7);
        if (likely(__pyx_t_6)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_7);
          __Pyx_INCREF(__pyx_t_6);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_7, function);
        }
      }
      if (!__pyx_t_6) {
        __pyx_t_2 = __Pyx_PyObject_CallOneArg(__pyx_t_7, ((PyObject *)__pyx_v_x)); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 455, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_2);
      } else {
        __pyx_t_4 = PyTuple_New(1+1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 455, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_4);
        __Pyx_GIVEREF(__pyx_t_6); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_6); __pyx_t_6 = NULL;
        __Pyx_INCREF(((PyObject *)__pyx_v_x));
        __Pyx_GIVEREF(((PyObject *)__pyx_v_x));
        PyTuple_SET_ITEM(__pyx_t_4, 0+1, ((PyObject *)__pyx_v_x));
        __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_7, __pyx_t_4, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 455, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_2);
        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      }
      __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
      __pyx_t_7 = PyNumber_Invert(__pyx_t_2); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 455, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_7);
      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
      __pyx_t_2 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_5))) {
        __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_5);
        if (likely(__pyx_t_2)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_5);
          __Pyx_INCREF(__pyx_t_2);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_5, function);
        }
      }
      if (!__pyx_t_2) {
        __pyx_t_3 = __Pyx_PyObject_CallOneArg(__pyx_t_5, __pyx_t_7); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 455, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
        __Pyx_GOTREF(__pyx_t_3);
      } else {
        __pyx_t_4 = PyTuple_New(1+1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 455, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_4);
        __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_2); __pyx_t_2 = NULL;
        __Pyx_GIVEREF(__pyx_t_7);
        PyTuple_SET_ITEM(__pyx_t_4, 0+1, __pyx_t_7);
        __pyx_t_7 = 0;
        __pyx_t_3 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_4, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 455, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_3);
        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      }
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
      __pyx_t_5 = PyObject_GetItem(__pyx_v_index_list, __pyx_t_3); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 455, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      __Pyx_XDECREF_SET(__pyx_v_index_list, __pyx_t_5);
      __pyx_t_5 = 0;

      /* "orb/cutils.pyx":454
 *     if bn.anynan(x):
 *         x = x[np.nonzero(~np.isnan(x))]
 *         if return_index_list:             # <<<<<<<<<<<<<<
 *             index_list = index_list[np.nonzero(~np.isnan(x))]
 * 
 */
    }

    /* "orb/cutils.pyx":452
 *         index_list = np.arange(np.size(x))
 * 
 *     if bn.anynan(x):             # <<<<<<<<<<<<<<
 *         x = x[np.nonzero(~np.isnan(x))]
 *         if return_index_list:
 */
  }

  /* "orb/cutils.pyx":457
 *             index_list = index_list[np.nonzero(~np.isnan(x))]
 * 
 *     while still_rejection:             # <<<<<<<<<<<<<<
 *         sz = np.size(x)
 *         if not use_central_value:
 */
  while (1) {
    __pyx_t_1 = (__pyx_v_still_rejection != 0);
    if (!__pyx_t_1) break;

    /* "orb/cutils.pyx":458
 * 
 *     while still_rejection:
 *         sz = np.size(x)             # <<<<<<<<<<<<<<
 *         if not use_central_value:
 *             central_x = bn.nanmedian(x)
 */
    __pyx_t_3 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 458, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_size); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 458, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __pyx_t_3 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_4))) {
      __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_4);
      if (likely(__pyx_t_3)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
        __Pyx_INCREF(__pyx_t_3);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_4, function);
      }
    }
    if (!__pyx_t_3) {
      __pyx_t_5 = __Pyx_PyObject_CallOneArg(__pyx_t_4, ((PyObject *)__pyx_v_x)); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 458, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
    } else {
      __pyx_t_7 = PyTuple_New(1+1); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 458, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_7);
      __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_7, 0, __pyx_t_3); __pyx_t_3 = NULL;
      __Pyx_INCREF(((PyObject *)__pyx_v_x));
      __Pyx_GIVEREF(((PyObject *)__pyx_v_x));
      PyTuple_SET_ITEM(__pyx_t_7, 0+1, ((PyObject *)__pyx_v_x));
      __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_7, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 458, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
    }
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_t_9 = __Pyx_PyInt_As_int(__pyx_t_5); if (unlikely((__pyx_t_9 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 458, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    __pyx_v_sz = __pyx_t_9;

    /* "orb/cutils.pyx":459
 *     while still_rejection:
 *         sz = np.size(x)
 *         if not use_central_value:             # <<<<<<<<<<<<<<
 *             central_x = bn.nanmedian(x)
 *         else:
 */
    __pyx_t_1 = ((!(__pyx_v_use_central_value != 0)) != 0);
    if (__pyx_t_1) {

      /* "orb/cutils.pyx":460
 *         sz = np.size(x)
 *         if not use_central_value:
 *             central_x = bn.nanmedian(x)             # <<<<<<<<<<<<<<
 *         else:
 *             central_x = central_value
 */
      __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 460, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __pyx_t_7 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_nanmedian); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 460, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_7);
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __pyx_t_4 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_7))) {
        __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_7);
        if (likely(__pyx_t_4)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_7);
          __Pyx_INCREF(__pyx_t_4);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_7, function);
        }
      }
      if (!__pyx_t_4) {
        __pyx_t_5 = __Pyx_PyObject_CallOneArg(__pyx_t_7, ((PyObject *)__pyx_v_x)); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 460, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_5);
      } else {
        __pyx_t_3 = PyTuple_New(1+1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 460, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_3);
        __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_4); __pyx_t_4 = NULL;
        __Pyx_INCREF(((PyObject *)__pyx_v_x));
        __Pyx_GIVEREF(((PyObject *)__pyx_v_x));
        PyTuple_SET_ITEM(__pyx_t_3, 0+1, ((PyObject *)__pyx_v_x));
        __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_7, __pyx_t_3, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 460, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_5);
        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      }
      __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
      __pyx_t_13 = __pyx_PyFloat_AsDouble(__pyx_t_5); if (unlikely((__pyx_t_13 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 460, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
      __pyx_v_central_x = __pyx_t_13;

      /* "orb/cutils.pyx":459
 *     while still_rejection:
 *         sz = np.size(x)
 *         if not use_central_value:             # <<<<<<<<<<<<<<
 *             central_x = bn.nanmedian(x)
 *         else:
 */
      goto __pyx_L8;
    }

    /* "orb/cutils.pyx":462
 *             central_x = bn.nanmedian(x)
 *         else:
 *             central_x = central_value             # <<<<<<<<<<<<<<
 * 
 *         std_x = bn.nanstd(x)
 */
    /*else*/ {
      __pyx_v_central_x = __pyx_v_central_value;
    }
    __pyx_L8:;

    /* "orb/cutils.pyx":464
 *             central_x = central_value
 * 
 *         std_x = bn.nanstd(x)             # <<<<<<<<<<<<<<
 *         new_x = x[np.nonzero((x < central_x + sigma * std_x)
 *                              * (x > central_x - sigma * std_x))]
 */
    __pyx_t_7 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 464, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_7);
    __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_7, __pyx_n_s_nanstd); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 464, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
    __pyx_t_7 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_3))) {
      __pyx_t_7 = PyMethod_GET_SELF(__pyx_t_3);
      if (likely(__pyx_t_7)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
        __Pyx_INCREF(__pyx_t_7);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_3, function);
      }
    }
    if (!__pyx_t_7) {
      __pyx_t_5 = __Pyx_PyObject_CallOneArg(__pyx_t_3, ((PyObject *)__pyx_v_x)); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 464, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
    } else {
      __pyx_t_4 = PyTuple_New(1+1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 464, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __Pyx_GIVEREF(__pyx_t_7); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_7); __pyx_t_7 = NULL;
      __Pyx_INCREF(((PyObject *)__pyx_v_x));
      __Pyx_GIVEREF(((PyObject *)__pyx_v_x));
      PyTuple_SET_ITEM(__pyx_t_4, 0+1, ((PyObject *)__pyx_v_x));
      __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_4, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 464, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    }
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __Pyx_XDECREF_SET(__pyx_v_std_x, __pyx_t_5);
    __pyx_t_5 = 0;

    /* "orb/cutils.pyx":465
 * 
 *         std_x = bn.nanstd(x)
 *         new_x = x[np.nonzero((x < central_x + sigma * std_x)             # <<<<<<<<<<<<<<
 *                              * (x > central_x - sigma * std_x))]
 *         if return_index_list:
 */
    __pyx_t_3 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 465, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_nonzero); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 465, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __pyx_t_3 = PyFloat_FromDouble(__pyx_v_central_x); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 465, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __pyx_t_7 = PyFloat_FromDouble(__pyx_v_sigma); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 465, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_7);
    __pyx_t_2 = PyNumber_Multiply(__pyx_t_7, __pyx_v_std_x); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 465, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
    __pyx_t_7 = PyNumber_Add(__pyx_t_3, __pyx_t_2); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 465, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_7);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __pyx_t_2 = PyObject_RichCompare(((PyObject *)__pyx_v_x), __pyx_t_7, Py_LT); __Pyx_XGOTREF(__pyx_t_2); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 465, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;

    /* "orb/cutils.pyx":466
 *         std_x = bn.nanstd(x)
 *         new_x = x[np.nonzero((x < central_x + sigma * std_x)
 *                              * (x > central_x - sigma * std_x))]             # <<<<<<<<<<<<<<
 *         if return_index_list:
 *             index_list = index_list[
 */
    __pyx_t_7 = PyFloat_FromDouble(__pyx_v_central_x); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 466, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_7);
    __pyx_t_3 = PyFloat_FromDouble(__pyx_v_sigma); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 466, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __pyx_t_6 = PyNumber_Multiply(__pyx_t_3, __pyx_v_std_x); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 466, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __pyx_t_3 = PyNumber_Subtract(__pyx_t_7, __pyx_t_6); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 466, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
    __pyx_t_6 = PyObject_RichCompare(((PyObject *)__pyx_v_x), __pyx_t_3, Py_GT); __Pyx_XGOTREF(__pyx_t_6); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 466, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __pyx_t_3 = PyNumber_Multiply(__pyx_t_2, __pyx_t_6); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 466, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
    __pyx_t_6 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_4))) {
      __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_4);
      if (likely(__pyx_t_6)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
        __Pyx_INCREF(__pyx_t_6);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_4, function);
      }
    }
    if (!__pyx_t_6) {
      __pyx_t_5 = __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_3); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 465, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      __Pyx_GOTREF(__pyx_t_5);
    } else {
      __pyx_t_2 = PyTuple_New(1+1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 465, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __Pyx_GIVEREF(__pyx_t_6); PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_6); __pyx_t_6 = NULL;
      __Pyx_GIVEREF(__pyx_t_3);
      PyTuple_SET_ITEM(__pyx_t_2, 0+1, __pyx_t_3);
      __pyx_t_3 = 0;
      __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_2, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 465, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    }
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;

    /* "orb/cutils.pyx":465
 * 
 *         std_x = bn.nanstd(x)
 *         new_x = x[np.nonzero((x < central_x + sigma * std_x)             # <<<<<<<<<<<<<<
 *                              * (x > central_x - sigma * std_x))]
 *         if return_index_list:
 */
    __pyx_t_4 = PyObject_GetItem(((PyObject *)__pyx_v_x), __pyx_t_5); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 465, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    __Pyx_XDECREF_SET(__pyx_v_new_x, __pyx_t_4);
    __pyx_t_4 = 0;

    /* "orb/cutils.pyx":467
 *         new_x = x[np.nonzero((x < central_x + sigma * std_x)
 *                              * (x > central_x - sigma * std_x))]
 *         if return_index_list:             # <<<<<<<<<<<<<<
 *             index_list = index_list[
 *                 np.nonzero((x < central_x + sigma * std_x)
 */
    __pyx_t_1 = __Pyx_PyObject_IsTrue(__pyx_v_return_index_list); if (unlikely(__pyx_t_1 < 0)) __PYX_ERR(0, 467, __pyx_L1_error)
    if (__pyx_t_1) {

      /* "orb/cutils.pyx":468
 *                              * (x > central_x - sigma * std_x))]
 *         if return_index_list:
 *             index_list = index_list[             # <<<<<<<<<<<<<<
 *                 np.nonzero((x < central_x + sigma * std_x)
 *                            * (x > central_x - sigma * std_x))]
 */
      if (unlikely(!__pyx_v_index_list)) { __Pyx_RaiseUnboundLocalError("index_list"); __PYX_ERR(0, 468, __pyx_L1_error) }

      /* "orb/cutils.pyx":469
 *         if return_index_list:
 *             index_list = index_list[
 *                 np.nonzero((x < central_x + sigma * std_x)             # <<<<<<<<<<<<<<
 *                            * (x > central_x - sigma * std_x))]
 * 
 */
      __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 469, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_nonzero); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 469, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
      __pyx_t_5 = PyFloat_FromDouble(__pyx_v_central_x); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 469, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __pyx_t_3 = PyFloat_FromDouble(__pyx_v_sigma); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 469, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __pyx_t_6 = PyNumber_Multiply(__pyx_t_3, __pyx_v_std_x); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 469, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_6);
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      __pyx_t_3 = PyNumber_Add(__pyx_t_5, __pyx_t_6); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 469, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
      __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
      __pyx_t_6 = PyObject_RichCompare(((PyObject *)__pyx_v_x), __pyx_t_3, Py_LT); __Pyx_XGOTREF(__pyx_t_6); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 469, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;

      /* "orb/cutils.pyx":470
 *             index_list = index_list[
 *                 np.nonzero((x < central_x + sigma * std_x)
 *                            * (x > central_x - sigma * std_x))]             # <<<<<<<<<<<<<<
 * 
 *         new_sz = np.size(new_x)
 */
      __pyx_t_3 = PyFloat_FromDouble(__pyx_v_central_x); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 470, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __pyx_t_5 = PyFloat_FromDouble(__pyx_v_sigma); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 470, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __pyx_t_7 = PyNumber_Multiply(__pyx_t_5, __pyx_v_std_x); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 470, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_7);
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
      __pyx_t_5 = PyNumber_Subtract(__pyx_t_3, __pyx_t_7); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 470, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
      __pyx_t_7 = PyObject_RichCompare(((PyObject *)__pyx_v_x), __pyx_t_5, Py_GT); __Pyx_XGOTREF(__pyx_t_7); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 470, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
      __pyx_t_5 = PyNumber_Multiply(__pyx_t_6, __pyx_t_7); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 470, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
      __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
      __pyx_t_7 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_2))) {
        __pyx_t_7 = PyMethod_GET_SELF(__pyx_t_2);
        if (likely(__pyx_t_7)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
          __Pyx_INCREF(__pyx_t_7);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_2, function);
        }
      }
      if (!__pyx_t_7) {
        __pyx_t_4 = __Pyx_PyObject_CallOneArg(__pyx_t_2, __pyx_t_5); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 469, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
        __Pyx_GOTREF(__pyx_t_4);
      } else {
        __pyx_t_6 = PyTuple_New(1+1); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 469, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_6);
        __Pyx_GIVEREF(__pyx_t_7); PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_7); __pyx_t_7 = NULL;
        __Pyx_GIVEREF(__pyx_t_5);
        PyTuple_SET_ITEM(__pyx_t_6, 0+1, __pyx_t_5);
        __pyx_t_5 = 0;
        __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_6, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 469, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_4);
        __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
      }
      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;

      /* "orb/cutils.pyx":468
 *                              * (x > central_x - sigma * std_x))]
 *         if return_index_list:
 *             index_list = index_list[             # <<<<<<<<<<<<<<
 *                 np.nonzero((x < central_x + sigma * std_x)
 *                            * (x > central_x - sigma * std_x))]
 */
      __pyx_t_2 = PyObject_GetItem(__pyx_v_index_list, __pyx_t_4); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 468, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __Pyx_XDECREF_SET(__pyx_v_index_list, __pyx_t_2);
      __pyx_t_2 = 0;

      /* "orb/cutils.pyx":467
 *         new_x = x[np.nonzero((x < central_x + sigma * std_x)
 *                              * (x > central_x - sigma * std_x))]
 *         if return_index_list:             # <<<<<<<<<<<<<<
 *             index_list = index_list[
 *                 np.nonzero((x < central_x + sigma * std_x)
 */
    }

    /* "orb/cutils.pyx":472
 *                            * (x > central_x - sigma * std_x))]
 * 
 *         new_sz = np.size(new_x)             # <<<<<<<<<<<<<<
 *         if new_sz == sz or new_sz <= min_values:
 *             still_rejection = 0
 */
    __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 472, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_size); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 472, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_t_4 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_6))) {
      __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_6);
      if (likely(__pyx_t_4)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_6);
        __Pyx_INCREF(__pyx_t_4);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_6, function);
      }
    }
    if (!__pyx_t_4) {
      __pyx_t_2 = __Pyx_PyObject_CallOneArg(__pyx_t_6, __pyx_v_new_x); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 472, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
    } else {
      __pyx_t_5 = PyTuple_New(1+1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 472, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_4); __pyx_t_4 = NULL;
      __Pyx_INCREF(__pyx_v_new_x);
      __Pyx_GIVEREF(__pyx_v_new_x);
      PyTuple_SET_ITEM(__pyx_t_5, 0+1, __pyx_v_new_x);
      __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_6, __pyx_t_5, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 472, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    }
    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
    __pyx_t_9 = __Pyx_PyInt_As_int(__pyx_t_2); if (unlikely((__pyx_t_9 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 472, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __pyx_v_new_sz = __pyx_t_9;

    /* "orb/cutils.pyx":473
 * 
 *         new_sz = np.size(new_x)
 *         if new_sz == sz or new_sz <= min_values:             # <<<<<<<<<<<<<<
 *             still_rejection = 0
 *         else:
 */
    __pyx_t_14 = ((__pyx_v_new_sz == __pyx_v_sz) != 0);
    if (!__pyx_t_14) {
    } else {
      __pyx_t_1 = __pyx_t_14;
      goto __pyx_L11_bool_binop_done;
    }
    __pyx_t_14 = ((__pyx_v_new_sz <= __pyx_v_min_values) != 0);
    __pyx_t_1 = __pyx_t_14;
    __pyx_L11_bool_binop_done:;
    if (__pyx_t_1) {

      /* "orb/cutils.pyx":474
 *         new_sz = np.size(new_x)
 *         if new_sz == sz or new_sz <= min_values:
 *             still_rejection = 0             # <<<<<<<<<<<<<<
 *         else:
 *             x = new_x
 */
      __pyx_v_still_rejection = 0;

      /* "orb/cutils.pyx":473
 * 
 *         new_sz = np.size(new_x)
 *         if new_sz == sz or new_sz <= min_values:             # <<<<<<<<<<<<<<
 *             still_rejection = 0
 *         else:
 */
      goto __pyx_L10;
    }

    /* "orb/cutils.pyx":476
 *             still_rejection = 0
 *         else:
 *             x = new_x             # <<<<<<<<<<<<<<
 *     if not return_index_list:
 *         return x
 */
    /*else*/ {
      if (!(likely(((__pyx_v_new_x) == Py_None) || likely(__Pyx_TypeTest(__pyx_v_new_x, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 476, __pyx_L1_error)
      __pyx_t_2 = __pyx_v_new_x;
      __Pyx_INCREF(__pyx_t_2);
      {
        __Pyx_BufFmt_StackElem __pyx_stack[1];
        __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_x.rcbuffer->pybuffer);
        __pyx_t_9 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_x.rcbuffer->pybuffer, (PyObject*)((PyArrayObject *)__pyx_t_2), &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack);
        if (unlikely(__pyx_t_9 < 0)) {
          PyErr_Fetch(&__pyx_t_12, &__pyx_t_11, &__pyx_t_10);
          if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_x.rcbuffer->pybuffer, (PyObject*)__pyx_v_x, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
            Py_XDECREF(__pyx_t_12); Py_XDECREF(__pyx_t_11); Py_XDECREF(__pyx_t_10);
            __Pyx_RaiseBufferFallbackError();
          } else {
            PyErr_Restore(__pyx_t_12, __pyx_t_11, __pyx_t_10);
          }
        }
        __pyx_pybuffernd_x.diminfo[0].strides = __pyx_pybuffernd_x.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_x.diminfo[0].shape = __pyx_pybuffernd_x.rcbuffer->pybuffer.shape[0];
        if (unlikely(__pyx_t_9 < 0)) __PYX_ERR(0, 476, __pyx_L1_error)
      }
      __Pyx_DECREF_SET(__pyx_v_x, ((PyArrayObject *)__pyx_t_2));
      __pyx_t_2 = 0;
    }
    __pyx_L10:;
  }

  /* "orb/cutils.pyx":477
 *         else:
 *             x = new_x
 *     if not return_index_list:             # <<<<<<<<<<<<<<
 *         return x
 *     else:
 */
  __pyx_t_1 = __Pyx_PyObject_IsTrue(__pyx_v_return_index_list); if (unlikely(__pyx_t_1 < 0)) __PYX_ERR(0, 477, __pyx_L1_error)
  __pyx_t_14 = ((!__pyx_t_1) != 0);
  if (__pyx_t_14) {

    /* "orb/cutils.pyx":478
 *             x = new_x
 *     if not return_index_list:
 *         return x             # <<<<<<<<<<<<<<
 *     else:
 *         return x, index_list
 */
    __Pyx_XDECREF(__pyx_r);
    __Pyx_INCREF(((PyObject *)__pyx_v_x));
    __pyx_r = ((PyObject *)__pyx_v_x);
    goto __pyx_L0;

    /* "orb/cutils.pyx":477
 *         else:
 *             x = new_x
 *     if not return_index_list:             # <<<<<<<<<<<<<<
 *         return x
 *     else:
 */
  }

  /* "orb/cutils.pyx":480
 *         return x
 *     else:
 *         return x, index_list             # <<<<<<<<<<<<<<
 * 
 * def meansigcut2d(np.ndarray[np.float64_t, ndim=2] x, double sigma=3,
 */
  /*else*/ {
    __Pyx_XDECREF(__pyx_r);
    if (unlikely(!__pyx_v_index_list)) { __Pyx_RaiseUnboundLocalError("index_list"); __PYX_ERR(0, 480, __pyx_L1_error) }
    __pyx_t_2 = PyTuple_New(2); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 480, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_INCREF(((PyObject *)__pyx_v_x));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_x));
    PyTuple_SET_ITEM(__pyx_t_2, 0, ((PyObject *)__pyx_v_x));
    __Pyx_INCREF(__pyx_v_index_list);
    __Pyx_GIVEREF(__pyx_v_index_list);
    PyTuple_SET_ITEM(__pyx_t_2, 1, __pyx_v_index_list);
    __pyx_r = __pyx_t_2;
    __pyx_t_2 = 0;
    goto __pyx_L0;
  }

  /* "orb/cutils.pyx":421
 * 
 * 
 * def sigmacut(np.ndarray[np.float64_t, ndim=1] x, double central_value,             # <<<<<<<<<<<<<<
 *              int use_central_value, double sigma, int min_values,
 *              return_index_list=False):
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_XDECREF(__pyx_t_5);
  __Pyx_XDECREF(__pyx_t_6);
  __Pyx_XDECREF(__pyx_t_7);
  { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
    __Pyx_PyThreadState_declare
    __Pyx_PyThreadState_assign
    __Pyx_ErrFetch(&__pyx_type, &__pyx_value, &__pyx_tb);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_x.rcbuffer->pybuffer);
  __Pyx_ErrRestore(__pyx_type, __pyx_value, __pyx_tb);}
  __Pyx_AddTraceback("orb.cutils.sigmacut", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  goto __pyx_L2;
  __pyx_L0:;
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_x.rcbuffer->pybuffer);
  __pyx_L2:;
  __Pyx_XDECREF(__pyx_v_index_list);
  __Pyx_XDECREF(__pyx_v_std_x);
  __Pyx_XDECREF(__pyx_v_new_x);
  __Pyx_XDECREF((PyObject *)__pyx_v_x);
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":482
 *         return x, index_list
 * 
 * def meansigcut2d(np.ndarray[np.float64_t, ndim=2] x, double sigma=3,             # <<<<<<<<<<<<<<
 *                  int min_values=3, int axis=0):
 *     """Return the sigma cut mean of a 2d array along a given axis.
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_21meansigcut2d(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_3orb_6cutils_20meansigcut2d[] = "meansigcut2d(ndarray x, double sigma=3, int min_values=3, int axis=0)\nReturn the sigma cut mean of a 2d array along a given axis.\n\n    :param x: The 2d array\n    \n    :param sigma: Number of sigma above which values are considered as\n      deviant\n\n    :param min_values: Minimum number of values to return\n\n    :param axis: Axis number. Must be 0 or 1.\n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_21meansigcut2d = {"meansigcut2d", (PyCFunction)__pyx_pw_3orb_6cutils_21meansigcut2d, METH_VARARGS|METH_KEYWORDS, __pyx_doc_3orb_6cutils_20meansigcut2d};
static PyObject *__pyx_pw_3orb_6cutils_21meansigcut2d(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  PyArrayObject *__pyx_v_x = 0;
  double __pyx_v_sigma;
  int __pyx_v_min_values;
  int __pyx_v_axis;
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("meansigcut2d (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_x,&__pyx_n_s_sigma,&__pyx_n_s_min_values,&__pyx_n_s_axis,0};
    PyObject* values[4] = {0,0,0,0};
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
      switch (pos_args) {
        case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = PyDict_Size(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_x)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        case  1:
        if (kw_args > 0) {
          PyObject* value = PyDict_GetItem(__pyx_kwds, __pyx_n_s_sigma);
          if (value) { values[1] = value; kw_args--; }
        }
        case  2:
        if (kw_args > 0) {
          PyObject* value = PyDict_GetItem(__pyx_kwds, __pyx_n_s_min_values);
          if (value) { values[2] = value; kw_args--; }
        }
        case  3:
        if (kw_args > 0) {
          PyObject* value = PyDict_GetItem(__pyx_kwds, __pyx_n_s_axis);
          if (value) { values[3] = value; kw_args--; }
        }
      }
      if (unlikely(kw_args > 0)) {
        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "meansigcut2d") < 0)) __PYX_ERR(0, 482, __pyx_L3_error)
      }
    } else {
      switch (PyTuple_GET_SIZE(__pyx_args)) {
        case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        break;
        default: goto __pyx_L5_argtuple_error;
      }
    }
    __pyx_v_x = ((PyArrayObject *)values[0]);
    if (values[1]) {
      __pyx_v_sigma = __pyx_PyFloat_AsDouble(values[1]); if (unlikely((__pyx_v_sigma == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 482, __pyx_L3_error)
    } else {
      __pyx_v_sigma = ((double)3.0);
    }
    if (values[2]) {
      __pyx_v_min_values = __Pyx_PyInt_As_int(values[2]); if (unlikely((__pyx_v_min_values == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 483, __pyx_L3_error)
    } else {
      __pyx_v_min_values = ((int)3);
    }
    if (values[3]) {
      __pyx_v_axis = __Pyx_PyInt_As_int(values[3]); if (unlikely((__pyx_v_axis == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 483, __pyx_L3_error)
    } else {
      __pyx_v_axis = ((int)0);
    }
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  __Pyx_RaiseArgtupleInvalid("meansigcut2d", 0, 1, 4, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 482, __pyx_L3_error)
  __pyx_L3_error:;
  __Pyx_AddTraceback("orb.cutils.meansigcut2d", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __Pyx_RefNannyFinishContext();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_x), __pyx_ptype_5numpy_ndarray, 1, "x", 0))) __PYX_ERR(0, 482, __pyx_L1_error)
  __pyx_r = __pyx_pf_3orb_6cutils_20meansigcut2d(__pyx_self, __pyx_v_x, __pyx_v_sigma, __pyx_v_min_values, __pyx_v_axis);

  /* function exit code */
  goto __pyx_L0;
  __pyx_L1_error:;
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_20meansigcut2d(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_x, double __pyx_v_sigma, int __pyx_v_min_values, int __pyx_v_axis) {
  int __pyx_v_i;
  int __pyx_v_coaxis;
  int __pyx_v_n;
  PyArrayObject *__pyx_v_line = 0;
  PyArrayObject *__pyx_v_iline = 0;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_iline;
  __Pyx_Buffer __pyx_pybuffer_iline;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_line;
  __Pyx_Buffer __pyx_pybuffer_line;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_x;
  __Pyx_Buffer __pyx_pybuffer_x;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  int __pyx_t_1;
  PyObject *__pyx_t_2 = NULL;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  PyObject *__pyx_t_5 = NULL;
  PyArrayObject *__pyx_t_6 = NULL;
  PyArrayObject *__pyx_t_7 = NULL;
  int __pyx_t_8;
  int __pyx_t_9;
  int __pyx_t_10;
  PyObject *__pyx_t_11 = NULL;
  PyObject *__pyx_t_12 = NULL;
  PyObject *__pyx_t_13 = NULL;
  PyObject *__pyx_t_14 = NULL;
  PyObject *__pyx_t_15 = NULL;
  __pyx_t_5numpy_float64_t __pyx_t_16;
  Py_ssize_t __pyx_t_17;
  __Pyx_RefNannySetupContext("meansigcut2d", 0);
  __pyx_pybuffer_line.pybuffer.buf = NULL;
  __pyx_pybuffer_line.refcount = 0;
  __pyx_pybuffernd_line.data = NULL;
  __pyx_pybuffernd_line.rcbuffer = &__pyx_pybuffer_line;
  __pyx_pybuffer_iline.pybuffer.buf = NULL;
  __pyx_pybuffer_iline.refcount = 0;
  __pyx_pybuffernd_iline.data = NULL;
  __pyx_pybuffernd_iline.rcbuffer = &__pyx_pybuffer_iline;
  __pyx_pybuffer_x.pybuffer.buf = NULL;
  __pyx_pybuffer_x.refcount = 0;
  __pyx_pybuffernd_x.data = NULL;
  __pyx_pybuffernd_x.rcbuffer = &__pyx_pybuffer_x;
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_x.rcbuffer->pybuffer, (PyObject*)__pyx_v_x, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) __PYX_ERR(0, 482, __pyx_L1_error)
  }
  __pyx_pybuffernd_x.diminfo[0].strides = __pyx_pybuffernd_x.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_x.diminfo[0].shape = __pyx_pybuffernd_x.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_x.diminfo[1].strides = __pyx_pybuffernd_x.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_x.diminfo[1].shape = __pyx_pybuffernd_x.rcbuffer->pybuffer.shape[1];

  /* "orb/cutils.pyx":495
 *     :param axis: Axis number. Must be 0 or 1.
 *     """
 *     cdef int i = 0             # <<<<<<<<<<<<<<
 *     cdef int coaxis
 *     if axis == 0: coaxis = 1
 */
  __pyx_v_i = 0;

  /* "orb/cutils.pyx":497
 *     cdef int i = 0
 *     cdef int coaxis
 *     if axis == 0: coaxis = 1             # <<<<<<<<<<<<<<
 *     else: coaxis = 0
 *     cdef int n = x.shape[coaxis]
 */
  __pyx_t_1 = ((__pyx_v_axis == 0) != 0);
  if (__pyx_t_1) {
    __pyx_v_coaxis = 1;
    goto __pyx_L3;
  }

  /* "orb/cutils.pyx":498
 *     cdef int coaxis
 *     if axis == 0: coaxis = 1
 *     else: coaxis = 0             # <<<<<<<<<<<<<<
 *     cdef int n = x.shape[coaxis]
 * 
 */
  /*else*/ {
    __pyx_v_coaxis = 0;
  }
  __pyx_L3:;

  /* "orb/cutils.pyx":499
 *     if axis == 0: coaxis = 1
 *     else: coaxis = 0
 *     cdef int n = x.shape[coaxis]             # <<<<<<<<<<<<<<
 * 
 *     cdef np.ndarray[np.float64_t, ndim=1] line = np.empty(n, dtype=float)
 */
  __pyx_v_n = (__pyx_v_x->dimensions[__pyx_v_coaxis]);

  /* "orb/cutils.pyx":501
 *     cdef int n = x.shape[coaxis]
 * 
 *     cdef np.ndarray[np.float64_t, ndim=1] line = np.empty(n, dtype=float)             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.float64_t, ndim=1] iline = np.empty(x.shape[axis],
 *                                                            dtype=float)
 */
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 501, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_empty); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 501, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = __Pyx_PyInt_From_int(__pyx_v_n); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 501, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_4 = PyTuple_New(1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 501, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_GIVEREF(__pyx_t_2);
  PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_2);
  __pyx_t_2 = 0;
  __pyx_t_2 = PyDict_New(); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 501, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  if (PyDict_SetItem(__pyx_t_2, __pyx_n_s_dtype, ((PyObject *)(&PyFloat_Type))) < 0) __PYX_ERR(0, 501, __pyx_L1_error)
  __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_4, __pyx_t_2); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 501, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  if (!(likely(((__pyx_t_5) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_5, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 501, __pyx_L1_error)
  __pyx_t_6 = ((PyArrayObject *)__pyx_t_5);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_line.rcbuffer->pybuffer, (PyObject*)__pyx_t_6, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 1, 0, __pyx_stack) == -1)) {
      __pyx_v_line = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_line.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 501, __pyx_L1_error)
    } else {__pyx_pybuffernd_line.diminfo[0].strides = __pyx_pybuffernd_line.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_line.diminfo[0].shape = __pyx_pybuffernd_line.rcbuffer->pybuffer.shape[0];
    }
  }
  __pyx_t_6 = 0;
  __pyx_v_line = ((PyArrayObject *)__pyx_t_5);
  __pyx_t_5 = 0;

  /* "orb/cutils.pyx":502
 * 
 *     cdef np.ndarray[np.float64_t, ndim=1] line = np.empty(n, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=1] iline = np.empty(x.shape[axis],             # <<<<<<<<<<<<<<
 *                                                            dtype=float)
 * 
 */
  __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 502, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_empty); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 502, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_5 = __Pyx_PyInt_From_Py_intptr_t((__pyx_v_x->dimensions[__pyx_v_axis])); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 502, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_4 = PyTuple_New(1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 502, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_GIVEREF(__pyx_t_5);
  PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_5);
  __pyx_t_5 = 0;

  /* "orb/cutils.pyx":503
 *     cdef np.ndarray[np.float64_t, ndim=1] line = np.empty(n, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=1] iline = np.empty(x.shape[axis],
 *                                                            dtype=float)             # <<<<<<<<<<<<<<
 * 
 *     for i in range(n):
 */
  __pyx_t_5 = PyDict_New(); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 503, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  if (PyDict_SetItem(__pyx_t_5, __pyx_n_s_dtype, ((PyObject *)(&PyFloat_Type))) < 0) __PYX_ERR(0, 503, __pyx_L1_error)

  /* "orb/cutils.pyx":502
 * 
 *     cdef np.ndarray[np.float64_t, ndim=1] line = np.empty(n, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=1] iline = np.empty(x.shape[axis],             # <<<<<<<<<<<<<<
 *                                                            dtype=float)
 * 
 */
  __pyx_t_3 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_4, __pyx_t_5); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 502, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  if (!(likely(((__pyx_t_3) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_3, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 502, __pyx_L1_error)
  __pyx_t_7 = ((PyArrayObject *)__pyx_t_3);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_iline.rcbuffer->pybuffer, (PyObject*)__pyx_t_7, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
      __pyx_v_iline = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_iline.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 502, __pyx_L1_error)
    } else {__pyx_pybuffernd_iline.diminfo[0].strides = __pyx_pybuffernd_iline.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_iline.diminfo[0].shape = __pyx_pybuffernd_iline.rcbuffer->pybuffer.shape[0];
    }
  }
  __pyx_t_7 = 0;
  __pyx_v_iline = ((PyArrayObject *)__pyx_t_3);
  __pyx_t_3 = 0;

  /* "orb/cutils.pyx":505
 *                                                            dtype=float)
 * 
 *     for i in range(n):             # <<<<<<<<<<<<<<
 *         if axis == 0:
 *             iline = x[:,i]
 */
  __pyx_t_8 = __pyx_v_n;
  for (__pyx_t_9 = 0; __pyx_t_9 < __pyx_t_8; __pyx_t_9+=1) {
    __pyx_v_i = __pyx_t_9;

    /* "orb/cutils.pyx":506
 * 
 *     for i in range(n):
 *         if axis == 0:             # <<<<<<<<<<<<<<
 *             iline = x[:,i]
 *         else:
 */
    __pyx_t_1 = ((__pyx_v_axis == 0) != 0);
    if (__pyx_t_1) {

      /* "orb/cutils.pyx":507
 *     for i in range(n):
 *         if axis == 0:
 *             iline = x[:,i]             # <<<<<<<<<<<<<<
 *         else:
 *             iline = x[i,:]
 */
      __pyx_t_3 = __Pyx_PyInt_From_int(__pyx_v_i); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 507, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __pyx_t_5 = PyTuple_New(2); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 507, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __Pyx_INCREF(__pyx_slice__25);
      __Pyx_GIVEREF(__pyx_slice__25);
      PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_slice__25);
      __Pyx_GIVEREF(__pyx_t_3);
      PyTuple_SET_ITEM(__pyx_t_5, 1, __pyx_t_3);
      __pyx_t_3 = 0;
      __pyx_t_3 = PyObject_GetItem(((PyObject *)__pyx_v_x), __pyx_t_5); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 507, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
      if (!(likely(((__pyx_t_3) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_3, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 507, __pyx_L1_error)
      __pyx_t_7 = ((PyArrayObject *)__pyx_t_3);
      {
        __Pyx_BufFmt_StackElem __pyx_stack[1];
        __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_iline.rcbuffer->pybuffer);
        __pyx_t_10 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_iline.rcbuffer->pybuffer, (PyObject*)__pyx_t_7, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack);
        if (unlikely(__pyx_t_10 < 0)) {
          PyErr_Fetch(&__pyx_t_11, &__pyx_t_12, &__pyx_t_13);
          if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_iline.rcbuffer->pybuffer, (PyObject*)__pyx_v_iline, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
            Py_XDECREF(__pyx_t_11); Py_XDECREF(__pyx_t_12); Py_XDECREF(__pyx_t_13);
            __Pyx_RaiseBufferFallbackError();
          } else {
            PyErr_Restore(__pyx_t_11, __pyx_t_12, __pyx_t_13);
          }
        }
        __pyx_pybuffernd_iline.diminfo[0].strides = __pyx_pybuffernd_iline.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_iline.diminfo[0].shape = __pyx_pybuffernd_iline.rcbuffer->pybuffer.shape[0];
        if (unlikely(__pyx_t_10 < 0)) __PYX_ERR(0, 507, __pyx_L1_error)
      }
      __pyx_t_7 = 0;
      __Pyx_DECREF_SET(__pyx_v_iline, ((PyArrayObject *)__pyx_t_3));
      __pyx_t_3 = 0;

      /* "orb/cutils.pyx":506
 * 
 *     for i in range(n):
 *         if axis == 0:             # <<<<<<<<<<<<<<
 *             iline = x[:,i]
 *         else:
 */
      goto __pyx_L6;
    }

    /* "orb/cutils.pyx":509
 *             iline = x[:,i]
 *         else:
 *             iline = x[i,:]             # <<<<<<<<<<<<<<
 *         line[i] = bn.nanmean(sigmacut(iline, 0, False,
 *                                       sigma, min_values,
 */
    /*else*/ {
      __pyx_t_3 = __Pyx_PyInt_From_int(__pyx_v_i); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 509, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __pyx_t_5 = PyTuple_New(2); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 509, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __Pyx_GIVEREF(__pyx_t_3);
      PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_3);
      __Pyx_INCREF(__pyx_slice__26);
      __Pyx_GIVEREF(__pyx_slice__26);
      PyTuple_SET_ITEM(__pyx_t_5, 1, __pyx_slice__26);
      __pyx_t_3 = 0;
      __pyx_t_3 = PyObject_GetItem(((PyObject *)__pyx_v_x), __pyx_t_5); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 509, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
      if (!(likely(((__pyx_t_3) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_3, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 509, __pyx_L1_error)
      __pyx_t_7 = ((PyArrayObject *)__pyx_t_3);
      {
        __Pyx_BufFmt_StackElem __pyx_stack[1];
        __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_iline.rcbuffer->pybuffer);
        __pyx_t_10 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_iline.rcbuffer->pybuffer, (PyObject*)__pyx_t_7, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack);
        if (unlikely(__pyx_t_10 < 0)) {
          PyErr_Fetch(&__pyx_t_13, &__pyx_t_12, &__pyx_t_11);
          if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_iline.rcbuffer->pybuffer, (PyObject*)__pyx_v_iline, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
            Py_XDECREF(__pyx_t_13); Py_XDECREF(__pyx_t_12); Py_XDECREF(__pyx_t_11);
            __Pyx_RaiseBufferFallbackError();
          } else {
            PyErr_Restore(__pyx_t_13, __pyx_t_12, __pyx_t_11);
          }
        }
        __pyx_pybuffernd_iline.diminfo[0].strides = __pyx_pybuffernd_iline.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_iline.diminfo[0].shape = __pyx_pybuffernd_iline.rcbuffer->pybuffer.shape[0];
        if (unlikely(__pyx_t_10 < 0)) __PYX_ERR(0, 509, __pyx_L1_error)
      }
      __pyx_t_7 = 0;
      __Pyx_DECREF_SET(__pyx_v_iline, ((PyArrayObject *)__pyx_t_3));
      __pyx_t_3 = 0;
    }
    __pyx_L6:;

    /* "orb/cutils.pyx":510
 *         else:
 *             iline = x[i,:]
 *         line[i] = bn.nanmean(sigmacut(iline, 0, False,             # <<<<<<<<<<<<<<
 *                                       sigma, min_values,
 *                                       return_index_list=False))
 */
    __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 510, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_nanmean); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 510, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_sigmacut); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 510, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);

    /* "orb/cutils.pyx":511
 *             iline = x[i,:]
 *         line[i] = bn.nanmean(sigmacut(iline, 0, False,
 *                                       sigma, min_values,             # <<<<<<<<<<<<<<
 *                                       return_index_list=False))
 *     return line
 */
    __pyx_t_2 = PyFloat_FromDouble(__pyx_v_sigma); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 511, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __pyx_t_14 = __Pyx_PyInt_From_int(__pyx_v_min_values); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 511, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_14);

    /* "orb/cutils.pyx":510
 *         else:
 *             iline = x[i,:]
 *         line[i] = bn.nanmean(sigmacut(iline, 0, False,             # <<<<<<<<<<<<<<
 *                                       sigma, min_values,
 *                                       return_index_list=False))
 */
    __pyx_t_15 = PyTuple_New(5); if (unlikely(!__pyx_t_15)) __PYX_ERR(0, 510, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_15);
    __Pyx_INCREF(((PyObject *)__pyx_v_iline));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_iline));
    PyTuple_SET_ITEM(__pyx_t_15, 0, ((PyObject *)__pyx_v_iline));
    __Pyx_INCREF(__pyx_int_0);
    __Pyx_GIVEREF(__pyx_int_0);
    PyTuple_SET_ITEM(__pyx_t_15, 1, __pyx_int_0);
    __Pyx_INCREF(Py_False);
    __Pyx_GIVEREF(Py_False);
    PyTuple_SET_ITEM(__pyx_t_15, 2, Py_False);
    __Pyx_GIVEREF(__pyx_t_2);
    PyTuple_SET_ITEM(__pyx_t_15, 3, __pyx_t_2);
    __Pyx_GIVEREF(__pyx_t_14);
    PyTuple_SET_ITEM(__pyx_t_15, 4, __pyx_t_14);
    __pyx_t_2 = 0;
    __pyx_t_14 = 0;

    /* "orb/cutils.pyx":512
 *         line[i] = bn.nanmean(sigmacut(iline, 0, False,
 *                                       sigma, min_values,
 *                                       return_index_list=False))             # <<<<<<<<<<<<<<
 *     return line
 * 
 */
    __pyx_t_14 = PyDict_New(); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 512, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_14);
    if (PyDict_SetItem(__pyx_t_14, __pyx_n_s_return_index_list, Py_False) < 0) __PYX_ERR(0, 512, __pyx_L1_error)

    /* "orb/cutils.pyx":510
 *         else:
 *             iline = x[i,:]
 *         line[i] = bn.nanmean(sigmacut(iline, 0, False,             # <<<<<<<<<<<<<<
 *                                       sigma, min_values,
 *                                       return_index_list=False))
 */
    __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_15, __pyx_t_14); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 510, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    __Pyx_DECREF(__pyx_t_15); __pyx_t_15 = 0;
    __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
    __pyx_t_14 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_4))) {
      __pyx_t_14 = PyMethod_GET_SELF(__pyx_t_4);
      if (likely(__pyx_t_14)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
        __Pyx_INCREF(__pyx_t_14);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_4, function);
      }
    }
    if (!__pyx_t_14) {
      __pyx_t_3 = __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_2); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 510, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
      __Pyx_GOTREF(__pyx_t_3);
    } else {
      __pyx_t_15 = PyTuple_New(1+1); if (unlikely(!__pyx_t_15)) __PYX_ERR(0, 510, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_15);
      __Pyx_GIVEREF(__pyx_t_14); PyTuple_SET_ITEM(__pyx_t_15, 0, __pyx_t_14); __pyx_t_14 = NULL;
      __Pyx_GIVEREF(__pyx_t_2);
      PyTuple_SET_ITEM(__pyx_t_15, 0+1, __pyx_t_2);
      __pyx_t_2 = 0;
      __pyx_t_3 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_15, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 510, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __Pyx_DECREF(__pyx_t_15); __pyx_t_15 = 0;
    }
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_t_16 = __pyx_PyFloat_AsDouble(__pyx_t_3); if (unlikely((__pyx_t_16 == (npy_float64)-1) && PyErr_Occurred())) __PYX_ERR(0, 510, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __pyx_t_17 = __pyx_v_i;
    __pyx_t_10 = -1;
    if (__pyx_t_17 < 0) {
      __pyx_t_17 += __pyx_pybuffernd_line.diminfo[0].shape;
      if (unlikely(__pyx_t_17 < 0)) __pyx_t_10 = 0;
    } else if (unlikely(__pyx_t_17 >= __pyx_pybuffernd_line.diminfo[0].shape)) __pyx_t_10 = 0;
    if (unlikely(__pyx_t_10 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_10);
      __PYX_ERR(0, 510, __pyx_L1_error)
    }
    *__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_line.rcbuffer->pybuffer.buf, __pyx_t_17, __pyx_pybuffernd_line.diminfo[0].strides) = __pyx_t_16;
  }

  /* "orb/cutils.pyx":513
 *                                       sigma, min_values,
 *                                       return_index_list=False))
 *     return line             # <<<<<<<<<<<<<<
 * 
 * 
 */
  __Pyx_XDECREF(__pyx_r);
  __Pyx_INCREF(((PyObject *)__pyx_v_line));
  __pyx_r = ((PyObject *)__pyx_v_line);
  goto __pyx_L0;

  /* "orb/cutils.pyx":482
 *         return x, index_list
 * 
 * def meansigcut2d(np.ndarray[np.float64_t, ndim=2] x, double sigma=3,             # <<<<<<<<<<<<<<
 *                  int min_values=3, int axis=0):
 *     """Return the sigma cut mean of a 2d array along a given axis.
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_XDECREF(__pyx_t_5);
  __Pyx_XDECREF(__pyx_t_14);
  __Pyx_XDECREF(__pyx_t_15);
  { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
    __Pyx_PyThreadState_declare
    __Pyx_PyThreadState_assign
    __Pyx_ErrFetch(&__pyx_type, &__pyx_value, &__pyx_tb);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_iline.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_line.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_x.rcbuffer->pybuffer);
  __Pyx_ErrRestore(__pyx_type, __pyx_value, __pyx_tb);}
  __Pyx_AddTraceback("orb.cutils.meansigcut2d", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  goto __pyx_L2;
  __pyx_L0:;
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_iline.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_line.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_x.rcbuffer->pybuffer);
  __pyx_L2:;
  __Pyx_XDECREF((PyObject *)__pyx_v_line);
  __Pyx_XDECREF((PyObject *)__pyx_v_iline);
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":516
 * 
 * 
 * def sigmaclip(np.ndarray[np.float64_t, ndim=1] x, double sigma,             # <<<<<<<<<<<<<<
 *               int min_values):
 *     """Return a distribution after a sigma clipping rejection
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_23sigmaclip(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_3orb_6cutils_22sigmaclip[] = "sigmaclip(ndarray x, double sigma, int min_values)\nReturn a distribution after a sigma clipping rejection\n    of the too deviant values.\n\n    :param x: The distribution to sigmaclip\n\n    :param sigma: Number of sigma above which values are considered as\n      deviant\n      \n    :param min_values: Minimum number of values to return\n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_23sigmaclip = {"sigmaclip", (PyCFunction)__pyx_pw_3orb_6cutils_23sigmaclip, METH_VARARGS|METH_KEYWORDS, __pyx_doc_3orb_6cutils_22sigmaclip};
static PyObject *__pyx_pw_3orb_6cutils_23sigmaclip(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  PyArrayObject *__pyx_v_x = 0;
  double __pyx_v_sigma;
  int __pyx_v_min_values;
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("sigmaclip (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_x,&__pyx_n_s_sigma,&__pyx_n_s_min_values,0};
    PyObject* values[3] = {0,0,0};
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
      switch (pos_args) {
        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = PyDict_Size(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_x)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        case  1:
        if (likely((values[1] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_sigma)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("sigmaclip", 1, 3, 3, 1); __PYX_ERR(0, 516, __pyx_L3_error)
        }
        case  2:
        if (likely((values[2] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_min_values)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("sigmaclip", 1, 3, 3, 2); __PYX_ERR(0, 516, __pyx_L3_error)
        }
      }
      if (unlikely(kw_args > 0)) {
        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "sigmaclip") < 0)) __PYX_ERR(0, 516, __pyx_L3_error)
      }
    } else if (PyTuple_GET_SIZE(__pyx_args) != 3) {
      goto __pyx_L5_argtuple_error;
    } else {
      values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
      values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
      values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
    }
    __pyx_v_x = ((PyArrayObject *)values[0]);
    __pyx_v_sigma = __pyx_PyFloat_AsDouble(values[1]); if (unlikely((__pyx_v_sigma == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 516, __pyx_L3_error)
    __pyx_v_min_values = __Pyx_PyInt_As_int(values[2]); if (unlikely((__pyx_v_min_values == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 517, __pyx_L3_error)
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  __Pyx_RaiseArgtupleInvalid("sigmaclip", 1, 3, 3, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 516, __pyx_L3_error)
  __pyx_L3_error:;
  __Pyx_AddTraceback("orb.cutils.sigmaclip", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __Pyx_RefNannyFinishContext();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_x), __pyx_ptype_5numpy_ndarray, 1, "x", 0))) __PYX_ERR(0, 516, __pyx_L1_error)
  __pyx_r = __pyx_pf_3orb_6cutils_22sigmaclip(__pyx_self, __pyx_v_x, __pyx_v_sigma, __pyx_v_min_values);

  /* function exit code */
  goto __pyx_L0;
  __pyx_L1_error:;
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_22sigmaclip(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_x, double __pyx_v_sigma, int __pyx_v_min_values) {
  int __pyx_v_still_rejection;
  int __pyx_v_sz;
  int __pyx_v_new_sz;
  double __pyx_v_med;
  double __pyx_v_std;
  int __pyx_v_min_mask;
  int __pyx_v_max_mask;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_x;
  __Pyx_Buffer __pyx_pybuffer_x;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  PyObject *__pyx_t_1 = NULL;
  PyObject *__pyx_t_2 = NULL;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  int __pyx_t_5;
  PyObject *__pyx_t_6 = NULL;
  PyObject *__pyx_t_7 = NULL;
  PyArrayObject *__pyx_t_8 = NULL;
  int __pyx_t_9;
  PyObject *__pyx_t_10 = NULL;
  PyObject *__pyx_t_11 = NULL;
  PyObject *__pyx_t_12 = NULL;
  double __pyx_t_13;
  Py_ssize_t __pyx_t_14;
  Py_ssize_t __pyx_t_15;
  int __pyx_t_16;
  __Pyx_RefNannySetupContext("sigmaclip", 0);
  __Pyx_INCREF((PyObject *)__pyx_v_x);
  __pyx_pybuffer_x.pybuffer.buf = NULL;
  __pyx_pybuffer_x.refcount = 0;
  __pyx_pybuffernd_x.data = NULL;
  __pyx_pybuffernd_x.rcbuffer = &__pyx_pybuffer_x;
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_x.rcbuffer->pybuffer, (PyObject*)__pyx_v_x, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) __PYX_ERR(0, 516, __pyx_L1_error)
  }
  __pyx_pybuffernd_x.diminfo[0].strides = __pyx_pybuffernd_x.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_x.diminfo[0].shape = __pyx_pybuffernd_x.rcbuffer->pybuffer.shape[0];

  /* "orb/cutils.pyx":528
 *     :param min_values: Minimum number of values to return
 *     """
 *     cdef int still_rejection = 1             # <<<<<<<<<<<<<<
 *     cdef double central_x
 *     cdef int sz, new_sz
 */
  __pyx_v_still_rejection = 1;

  /* "orb/cutils.pyx":532
 *     cdef int sz, new_sz
 *     cdef double med, std
 *     cdef int min_mask = 0             # <<<<<<<<<<<<<<
 *     cdef int max_mask = x.shape[0] - 1
 * 
 */
  __pyx_v_min_mask = 0;

  /* "orb/cutils.pyx":533
 *     cdef double med, std
 *     cdef int min_mask = 0
 *     cdef int max_mask = x.shape[0] - 1             # <<<<<<<<<<<<<<
 * 
 *     if bn.anynan(x):
 */
  __pyx_v_max_mask = ((__pyx_v_x->dimensions[0]) - 1);

  /* "orb/cutils.pyx":535
 *     cdef int max_mask = x.shape[0] - 1
 * 
 *     if bn.anynan(x):             # <<<<<<<<<<<<<<
 *         x = x[np.nonzero(~np.isnan(x))]
 * 
 */
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 535, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_anynan); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 535, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_3))) {
    __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_3);
    if (likely(__pyx_t_2)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
      __Pyx_INCREF(__pyx_t_2);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_3, function);
    }
  }
  if (!__pyx_t_2) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_3, ((PyObject *)__pyx_v_x)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 535, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_4 = PyTuple_New(1+1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 535, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_2); __pyx_t_2 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_x));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_x));
    PyTuple_SET_ITEM(__pyx_t_4, 0+1, ((PyObject *)__pyx_v_x));
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_4, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 535, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  }
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_5 = __Pyx_PyObject_IsTrue(__pyx_t_1); if (unlikely(__pyx_t_5 < 0)) __PYX_ERR(0, 535, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  if (__pyx_t_5) {

    /* "orb/cutils.pyx":536
 * 
 *     if bn.anynan(x):
 *         x = x[np.nonzero(~np.isnan(x))]             # <<<<<<<<<<<<<<
 * 
 *     # sort array once and for all
 */
    __pyx_t_3 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 536, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_nonzero); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 536, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 536, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_isnan); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 536, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __pyx_t_2 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_6))) {
      __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_6);
      if (likely(__pyx_t_2)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_6);
        __Pyx_INCREF(__pyx_t_2);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_6, function);
      }
    }
    if (!__pyx_t_2) {
      __pyx_t_3 = __Pyx_PyObject_CallOneArg(__pyx_t_6, ((PyObject *)__pyx_v_x)); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 536, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
    } else {
      __pyx_t_7 = PyTuple_New(1+1); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 536, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_7);
      __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_7, 0, __pyx_t_2); __pyx_t_2 = NULL;
      __Pyx_INCREF(((PyObject *)__pyx_v_x));
      __Pyx_GIVEREF(((PyObject *)__pyx_v_x));
      PyTuple_SET_ITEM(__pyx_t_7, 0+1, ((PyObject *)__pyx_v_x));
      __pyx_t_3 = __Pyx_PyObject_Call(__pyx_t_6, __pyx_t_7, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 536, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
    }
    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
    __pyx_t_6 = PyNumber_Invert(__pyx_t_3); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 536, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __pyx_t_3 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_4))) {
      __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_4);
      if (likely(__pyx_t_3)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
        __Pyx_INCREF(__pyx_t_3);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_4, function);
      }
    }
    if (!__pyx_t_3) {
      __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_6); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 536, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
      __Pyx_GOTREF(__pyx_t_1);
    } else {
      __pyx_t_7 = PyTuple_New(1+1); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 536, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_7);
      __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_7, 0, __pyx_t_3); __pyx_t_3 = NULL;
      __Pyx_GIVEREF(__pyx_t_6);
      PyTuple_SET_ITEM(__pyx_t_7, 0+1, __pyx_t_6);
      __pyx_t_6 = 0;
      __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_7, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 536, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);
      __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
    }
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_t_4 = PyObject_GetItem(((PyObject *)__pyx_v_x), __pyx_t_1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 536, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    if (!(likely(((__pyx_t_4) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_4, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 536, __pyx_L1_error)
    __pyx_t_8 = ((PyArrayObject *)__pyx_t_4);
    {
      __Pyx_BufFmt_StackElem __pyx_stack[1];
      __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_x.rcbuffer->pybuffer);
      __pyx_t_9 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_x.rcbuffer->pybuffer, (PyObject*)__pyx_t_8, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack);
      if (unlikely(__pyx_t_9 < 0)) {
        PyErr_Fetch(&__pyx_t_10, &__pyx_t_11, &__pyx_t_12);
        if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_x.rcbuffer->pybuffer, (PyObject*)__pyx_v_x, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
          Py_XDECREF(__pyx_t_10); Py_XDECREF(__pyx_t_11); Py_XDECREF(__pyx_t_12);
          __Pyx_RaiseBufferFallbackError();
        } else {
          PyErr_Restore(__pyx_t_10, __pyx_t_11, __pyx_t_12);
        }
      }
      __pyx_pybuffernd_x.diminfo[0].strides = __pyx_pybuffernd_x.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_x.diminfo[0].shape = __pyx_pybuffernd_x.rcbuffer->pybuffer.shape[0];
      if (unlikely(__pyx_t_9 < 0)) __PYX_ERR(0, 536, __pyx_L1_error)
    }
    __pyx_t_8 = 0;
    __Pyx_DECREF_SET(__pyx_v_x, ((PyArrayObject *)__pyx_t_4));
    __pyx_t_4 = 0;

    /* "orb/cutils.pyx":535
 *     cdef int max_mask = x.shape[0] - 1
 * 
 *     if bn.anynan(x):             # <<<<<<<<<<<<<<
 *         x = x[np.nonzero(~np.isnan(x))]
 * 
 */
  }

  /* "orb/cutils.pyx":539
 * 
 *     # sort array once and for all
 *     x = np.sort(x)             # <<<<<<<<<<<<<<
 * 
 *     # compute first median without min and max
 */
  __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 539, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_7 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_sort); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 539, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_7);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_1 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_7))) {
    __pyx_t_1 = PyMethod_GET_SELF(__pyx_t_7);
    if (likely(__pyx_t_1)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_7);
      __Pyx_INCREF(__pyx_t_1);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_7, function);
    }
  }
  if (!__pyx_t_1) {
    __pyx_t_4 = __Pyx_PyObject_CallOneArg(__pyx_t_7, ((PyObject *)__pyx_v_x)); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 539, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
  } else {
    __pyx_t_6 = PyTuple_New(1+1); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 539, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
    __Pyx_GIVEREF(__pyx_t_1); PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_1); __pyx_t_1 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_x));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_x));
    PyTuple_SET_ITEM(__pyx_t_6, 0+1, ((PyObject *)__pyx_v_x));
    __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_7, __pyx_t_6, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 539, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
  }
  __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
  if (!(likely(((__pyx_t_4) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_4, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 539, __pyx_L1_error)
  __pyx_t_8 = ((PyArrayObject *)__pyx_t_4);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_x.rcbuffer->pybuffer);
    __pyx_t_9 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_x.rcbuffer->pybuffer, (PyObject*)__pyx_t_8, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack);
    if (unlikely(__pyx_t_9 < 0)) {
      PyErr_Fetch(&__pyx_t_12, &__pyx_t_11, &__pyx_t_10);
      if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_x.rcbuffer->pybuffer, (PyObject*)__pyx_v_x, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_12); Py_XDECREF(__pyx_t_11); Py_XDECREF(__pyx_t_10);
        __Pyx_RaiseBufferFallbackError();
      } else {
        PyErr_Restore(__pyx_t_12, __pyx_t_11, __pyx_t_10);
      }
    }
    __pyx_pybuffernd_x.diminfo[0].strides = __pyx_pybuffernd_x.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_x.diminfo[0].shape = __pyx_pybuffernd_x.rcbuffer->pybuffer.shape[0];
    if (unlikely(__pyx_t_9 < 0)) __PYX_ERR(0, 539, __pyx_L1_error)
  }
  __pyx_t_8 = 0;
  __Pyx_DECREF_SET(__pyx_v_x, ((PyArrayObject *)__pyx_t_4));
  __pyx_t_4 = 0;

  /* "orb/cutils.pyx":542
 * 
 *     # compute first median without min and max
 *     med = bn.median(x[1:-1])             # <<<<<<<<<<<<<<
 *     std = bn.nanstd(x[1:-1])
 * 
 */
  __pyx_t_7 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 542, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_7);
  __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_t_7, __pyx_n_s_median); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 542, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
  __pyx_t_7 = __Pyx_PyObject_GetSlice(((PyObject *)__pyx_v_x), 1, -1L, NULL, NULL, &__pyx_slice__27, 1, 1, 1); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 542, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_7);
  __pyx_t_1 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_6))) {
    __pyx_t_1 = PyMethod_GET_SELF(__pyx_t_6);
    if (likely(__pyx_t_1)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_6);
      __Pyx_INCREF(__pyx_t_1);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_6, function);
    }
  }
  if (!__pyx_t_1) {
    __pyx_t_4 = __Pyx_PyObject_CallOneArg(__pyx_t_6, __pyx_t_7); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 542, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
    __Pyx_GOTREF(__pyx_t_4);
  } else {
    __pyx_t_3 = PyTuple_New(1+1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 542, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_GIVEREF(__pyx_t_1); PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_1); __pyx_t_1 = NULL;
    __Pyx_GIVEREF(__pyx_t_7);
    PyTuple_SET_ITEM(__pyx_t_3, 0+1, __pyx_t_7);
    __pyx_t_7 = 0;
    __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_6, __pyx_t_3, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 542, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  }
  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
  __pyx_t_13 = __pyx_PyFloat_AsDouble(__pyx_t_4); if (unlikely((__pyx_t_13 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 542, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_v_med = __pyx_t_13;

  /* "orb/cutils.pyx":543
 *     # compute first median without min and max
 *     med = bn.median(x[1:-1])
 *     std = bn.nanstd(x[1:-1])             # <<<<<<<<<<<<<<
 * 
 *     while still_rejection:
 */
  __pyx_t_6 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 543, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_6, __pyx_n_s_nanstd); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 543, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
  __pyx_t_6 = __Pyx_PyObject_GetSlice(((PyObject *)__pyx_v_x), 1, -1L, NULL, NULL, &__pyx_slice__28, 1, 1, 1); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 543, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __pyx_t_7 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_3))) {
    __pyx_t_7 = PyMethod_GET_SELF(__pyx_t_3);
    if (likely(__pyx_t_7)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
      __Pyx_INCREF(__pyx_t_7);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_3, function);
    }
  }
  if (!__pyx_t_7) {
    __pyx_t_4 = __Pyx_PyObject_CallOneArg(__pyx_t_3, __pyx_t_6); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 543, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
    __Pyx_GOTREF(__pyx_t_4);
  } else {
    __pyx_t_1 = PyTuple_New(1+1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 543, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_GIVEREF(__pyx_t_7); PyTuple_SET_ITEM(__pyx_t_1, 0, __pyx_t_7); __pyx_t_7 = NULL;
    __Pyx_GIVEREF(__pyx_t_6);
    PyTuple_SET_ITEM(__pyx_t_1, 0+1, __pyx_t_6);
    __pyx_t_6 = 0;
    __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_1, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 543, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  }
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_13 = __pyx_PyFloat_AsDouble(__pyx_t_4); if (unlikely((__pyx_t_13 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 543, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_v_std = __pyx_t_13;

  /* "orb/cutils.pyx":545
 *     std = bn.nanstd(x[1:-1])
 * 
 *     while still_rejection:             # <<<<<<<<<<<<<<
 *         # put min and max at first and last index
 *         sz = max_mask - min_mask + 1
 */
  while (1) {
    __pyx_t_5 = (__pyx_v_still_rejection != 0);
    if (!__pyx_t_5) break;

    /* "orb/cutils.pyx":547
 *     while still_rejection:
 *         # put min and max at first and last index
 *         sz = max_mask - min_mask + 1             # <<<<<<<<<<<<<<
 * 
 *         while x[min_mask] <= med - sigma * std:
 */
    __pyx_v_sz = ((__pyx_v_max_mask - __pyx_v_min_mask) + 1);

    /* "orb/cutils.pyx":549
 *         sz = max_mask - min_mask + 1
 * 
 *         while x[min_mask] <= med - sigma * std:             # <<<<<<<<<<<<<<
 *             min_mask += 1
 *         while x[max_mask] >= med + sigma * std:
 */
    while (1) {
      __pyx_t_14 = __pyx_v_min_mask;
      __pyx_t_9 = -1;
      if (__pyx_t_14 < 0) {
        __pyx_t_14 += __pyx_pybuffernd_x.diminfo[0].shape;
        if (unlikely(__pyx_t_14 < 0)) __pyx_t_9 = 0;
      } else if (unlikely(__pyx_t_14 >= __pyx_pybuffernd_x.diminfo[0].shape)) __pyx_t_9 = 0;
      if (unlikely(__pyx_t_9 != -1)) {
        __Pyx_RaiseBufferIndexError(__pyx_t_9);
        __PYX_ERR(0, 549, __pyx_L1_error)
      }
      __pyx_t_5 = (((*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_x.rcbuffer->pybuffer.buf, __pyx_t_14, __pyx_pybuffernd_x.diminfo[0].strides)) <= (__pyx_v_med - (__pyx_v_sigma * __pyx_v_std))) != 0);
      if (!__pyx_t_5) break;

      /* "orb/cutils.pyx":550
 * 
 *         while x[min_mask] <= med - sigma * std:
 *             min_mask += 1             # <<<<<<<<<<<<<<
 *         while x[max_mask] >= med + sigma * std:
 *             max_mask -= 1
 */
      __pyx_v_min_mask = (__pyx_v_min_mask + 1);
    }

    /* "orb/cutils.pyx":551
 *         while x[min_mask] <= med - sigma * std:
 *             min_mask += 1
 *         while x[max_mask] >= med + sigma * std:             # <<<<<<<<<<<<<<
 *             max_mask -= 1
 * 
 */
    while (1) {
      __pyx_t_15 = __pyx_v_max_mask;
      __pyx_t_9 = -1;
      if (__pyx_t_15 < 0) {
        __pyx_t_15 += __pyx_pybuffernd_x.diminfo[0].shape;
        if (unlikely(__pyx_t_15 < 0)) __pyx_t_9 = 0;
      } else if (unlikely(__pyx_t_15 >= __pyx_pybuffernd_x.diminfo[0].shape)) __pyx_t_9 = 0;
      if (unlikely(__pyx_t_9 != -1)) {
        __Pyx_RaiseBufferIndexError(__pyx_t_9);
        __PYX_ERR(0, 551, __pyx_L1_error)
      }
      __pyx_t_5 = (((*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_x.rcbuffer->pybuffer.buf, __pyx_t_15, __pyx_pybuffernd_x.diminfo[0].strides)) >= (__pyx_v_med + (__pyx_v_sigma * __pyx_v_std))) != 0);
      if (!__pyx_t_5) break;

      /* "orb/cutils.pyx":552
 *             min_mask += 1
 *         while x[max_mask] >= med + sigma * std:
 *             max_mask -= 1             # <<<<<<<<<<<<<<
 * 
 *         new_sz = max_mask - min_mask + 1
 */
      __pyx_v_max_mask = (__pyx_v_max_mask - 1);
    }

    /* "orb/cutils.pyx":554
 *             max_mask -= 1
 * 
 *         new_sz = max_mask - min_mask + 1             # <<<<<<<<<<<<<<
 * 
 *         if new_sz == sz or new_sz <= min_values:
 */
    __pyx_v_new_sz = ((__pyx_v_max_mask - __pyx_v_min_mask) + 1);

    /* "orb/cutils.pyx":556
 *         new_sz = max_mask - min_mask + 1
 * 
 *         if new_sz == sz or new_sz <= min_values:             # <<<<<<<<<<<<<<
 *             still_rejection = 0
 *         else:
 */
    __pyx_t_16 = ((__pyx_v_new_sz == __pyx_v_sz) != 0);
    if (!__pyx_t_16) {
    } else {
      __pyx_t_5 = __pyx_t_16;
      goto __pyx_L11_bool_binop_done;
    }
    __pyx_t_16 = ((__pyx_v_new_sz <= __pyx_v_min_values) != 0);
    __pyx_t_5 = __pyx_t_16;
    __pyx_L11_bool_binop_done:;
    if (__pyx_t_5) {

      /* "orb/cutils.pyx":557
 * 
 *         if new_sz == sz or new_sz <= min_values:
 *             still_rejection = 0             # <<<<<<<<<<<<<<
 *         else:
 *             med = bn.median(x[min_mask:max_mask+1])
 */
      __pyx_v_still_rejection = 0;

      /* "orb/cutils.pyx":556
 *         new_sz = max_mask - min_mask + 1
 * 
 *         if new_sz == sz or new_sz <= min_values:             # <<<<<<<<<<<<<<
 *             still_rejection = 0
 *         else:
 */
      goto __pyx_L10;
    }

    /* "orb/cutils.pyx":559
 *             still_rejection = 0
 *         else:
 *             med = bn.median(x[min_mask:max_mask+1])             # <<<<<<<<<<<<<<
 *             std = bn.nanstd(x[min_mask:max_mask+1])
 * 
 */
    /*else*/ {
      __pyx_t_3 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 559, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_median); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 559, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      __pyx_t_3 = __Pyx_PyObject_GetSlice(((PyObject *)__pyx_v_x), __pyx_v_min_mask, (__pyx_v_max_mask + 1), NULL, NULL, NULL, 1, 1, 1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 559, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __pyx_t_6 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_1))) {
        __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_1);
        if (likely(__pyx_t_6)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_1);
          __Pyx_INCREF(__pyx_t_6);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_1, function);
        }
      }
      if (!__pyx_t_6) {
        __pyx_t_4 = __Pyx_PyObject_CallOneArg(__pyx_t_1, __pyx_t_3); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 559, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
        __Pyx_GOTREF(__pyx_t_4);
      } else {
        __pyx_t_7 = PyTuple_New(1+1); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 559, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_7);
        __Pyx_GIVEREF(__pyx_t_6); PyTuple_SET_ITEM(__pyx_t_7, 0, __pyx_t_6); __pyx_t_6 = NULL;
        __Pyx_GIVEREF(__pyx_t_3);
        PyTuple_SET_ITEM(__pyx_t_7, 0+1, __pyx_t_3);
        __pyx_t_3 = 0;
        __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_1, __pyx_t_7, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 559, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_4);
        __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
      }
      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
      __pyx_t_13 = __pyx_PyFloat_AsDouble(__pyx_t_4); if (unlikely((__pyx_t_13 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 559, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __pyx_v_med = __pyx_t_13;

      /* "orb/cutils.pyx":560
 *         else:
 *             med = bn.median(x[min_mask:max_mask+1])
 *             std = bn.nanstd(x[min_mask:max_mask+1])             # <<<<<<<<<<<<<<
 * 
 *     return x[min_mask:max_mask+1]
 */
      __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 560, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);
      __pyx_t_7 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_nanstd); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 560, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_7);
      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
      __pyx_t_1 = __Pyx_PyObject_GetSlice(((PyObject *)__pyx_v_x), __pyx_v_min_mask, (__pyx_v_max_mask + 1), NULL, NULL, NULL, 1, 1, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 560, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);
      __pyx_t_3 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_7))) {
        __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_7);
        if (likely(__pyx_t_3)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_7);
          __Pyx_INCREF(__pyx_t_3);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_7, function);
        }
      }
      if (!__pyx_t_3) {
        __pyx_t_4 = __Pyx_PyObject_CallOneArg(__pyx_t_7, __pyx_t_1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 560, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
        __Pyx_GOTREF(__pyx_t_4);
      } else {
        __pyx_t_6 = PyTuple_New(1+1); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 560, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_6);
        __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_3); __pyx_t_3 = NULL;
        __Pyx_GIVEREF(__pyx_t_1);
        PyTuple_SET_ITEM(__pyx_t_6, 0+1, __pyx_t_1);
        __pyx_t_1 = 0;
        __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_7, __pyx_t_6, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 560, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_4);
        __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
      }
      __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
      __pyx_t_13 = __pyx_PyFloat_AsDouble(__pyx_t_4); if (unlikely((__pyx_t_13 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 560, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __pyx_v_std = __pyx_t_13;
    }
    __pyx_L10:;
  }

  /* "orb/cutils.pyx":562
 *             std = bn.nanstd(x[min_mask:max_mask+1])
 * 
 *     return x[min_mask:max_mask+1]             # <<<<<<<<<<<<<<
 * 
 * def master_combine(np.ndarray[np.float64_t, ndim=3] frames, double sigma,
 */
  __Pyx_XDECREF(__pyx_r);
  __pyx_t_4 = __Pyx_PyObject_GetSlice(((PyObject *)__pyx_v_x), __pyx_v_min_mask, (__pyx_v_max_mask + 1), NULL, NULL, NULL, 1, 1, 1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 562, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_r = __pyx_t_4;
  __pyx_t_4 = 0;
  goto __pyx_L0;

  /* "orb/cutils.pyx":516
 * 
 * 
 * def sigmaclip(np.ndarray[np.float64_t, ndim=1] x, double sigma,             # <<<<<<<<<<<<<<
 *               int min_values):
 *     """Return a distribution after a sigma clipping rejection
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_1);
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_XDECREF(__pyx_t_6);
  __Pyx_XDECREF(__pyx_t_7);
  { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
    __Pyx_PyThreadState_declare
    __Pyx_PyThreadState_assign
    __Pyx_ErrFetch(&__pyx_type, &__pyx_value, &__pyx_tb);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_x.rcbuffer->pybuffer);
  __Pyx_ErrRestore(__pyx_type, __pyx_value, __pyx_tb);}
  __Pyx_AddTraceback("orb.cutils.sigmaclip", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  goto __pyx_L2;
  __pyx_L0:;
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_x.rcbuffer->pybuffer);
  __pyx_L2:;
  __Pyx_XDECREF((PyObject *)__pyx_v_x);
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":564
 *     return x[min_mask:max_mask+1]
 * 
 * def master_combine(np.ndarray[np.float64_t, ndim=3] frames, double sigma,             # <<<<<<<<<<<<<<
 *                    int nkeep, int combine_mode, int reject_mode,
 *                    return_std_frame=False):
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_25master_combine(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_3orb_6cutils_24master_combine[] = "master_combine(ndarray frames, double sigma, int nkeep, int combine_mode, int reject_mode, return_std_frame=False)\n\n    Create a master frame from a set a frames.\n\n    This method has been inspired by the **IRAF** function\n    combine.\n\n    :param frames: Frames to be combined.\n\n    :param sigma: Sigma factor for pixel rejection.\n\n    :param nkeep: Minimum number of values to keep before\n      combining operation\n    \n    :param combine_mode: 0, mean ; 1, median.\n    \n    :param reject_mode: 0, avsigclip ; 1, sigclip ; 2, minmax.\n\n    :param return_std: If True, the std frame is also returned\n      (default False).\n\n    .. note:: Rejection operations:\n\n      * **sigclip**: A Sigma Clipping algorithm is applied for\n        each pixel. Min and max values are rejected to estimate\n        the mean and the standard deviation at each pixel. Then\n        all values over (median + sigma * std) or below (median -\n        sigma * std) are rejected. Those steps are repeated (this\n        time not excluding the extreme values) while no other\n        value is rejected or the minimum number of values to keep\n        is reached. Work best with at least 10 frames.\n\n      * **avsigclip**: Average Sigma Clipping algorithm is the\n        same as Sigma Clipping algorithm but the standard\n        deviation at each pixel is estimated using an averaged\n        value of the std over the lines. This work best than sigma\n        clipping for a small number of frames. This algorithm is a\n        little more time consuming than the others. Works best with\n        at least 5 frames.\n\n      * **minmax**: Minimum and maximum values at each pixel are\n        rejected.\n\n    .. warning:: No rejection operation can be performed with less\n      than 3 frames.\n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_25master_combine = {"master_combine", (PyCFunction)__pyx_pw_3orb_6cutils_25master_combine, METH_VARARGS|METH_KEYWORDS, __pyx_doc_3orb_6cutils_24master_combine};
static PyObject *__pyx_pw_3orb_6cutils_25master_combine(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  PyArrayObject *__pyx_v_frames = 0;
  double __pyx_v_sigma;
  int __pyx_v_nkeep;
  int __pyx_v_combine_mode;
  int __pyx_v_reject_mode;
  PyObject *__pyx_v_return_std_frame = 0;
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("master_combine (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_frames,&__pyx_n_s_sigma,&__pyx_n_s_nkeep,&__pyx_n_s_combine_mode,&__pyx_n_s_reject_mode,&__pyx_n_s_return_std_frame,0};
    PyObject* values[6] = {0,0,0,0,0,0};

    /* "orb/cutils.pyx":566
 * def master_combine(np.ndarray[np.float64_t, ndim=3] frames, double sigma,
 *                    int nkeep, int combine_mode, int reject_mode,
 *                    return_std_frame=False):             # <<<<<<<<<<<<<<
 *     """
 *     Create a master frame from a set a frames.
 */
    values[5] = ((PyObject *)Py_False);
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
      switch (pos_args) {
        case  6: values[5] = PyTuple_GET_ITEM(__pyx_args, 5);
        case  5: values[4] = PyTuple_GET_ITEM(__pyx_args, 4);
        case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = PyDict_Size(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_frames)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        case  1:
        if (likely((values[1] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_sigma)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("master_combine", 0, 5, 6, 1); __PYX_ERR(0, 564, __pyx_L3_error)
        }
        case  2:
        if (likely((values[2] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_nkeep)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("master_combine", 0, 5, 6, 2); __PYX_ERR(0, 564, __pyx_L3_error)
        }
        case  3:
        if (likely((values[3] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_combine_mode)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("master_combine", 0, 5, 6, 3); __PYX_ERR(0, 564, __pyx_L3_error)
        }
        case  4:
        if (likely((values[4] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_reject_mode)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("master_combine", 0, 5, 6, 4); __PYX_ERR(0, 564, __pyx_L3_error)
        }
        case  5:
        if (kw_args > 0) {
          PyObject* value = PyDict_GetItem(__pyx_kwds, __pyx_n_s_return_std_frame);
          if (value) { values[5] = value; kw_args--; }
        }
      }
      if (unlikely(kw_args > 0)) {
        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "master_combine") < 0)) __PYX_ERR(0, 564, __pyx_L3_error)
      }
    } else {
      switch (PyTuple_GET_SIZE(__pyx_args)) {
        case  6: values[5] = PyTuple_GET_ITEM(__pyx_args, 5);
        case  5: values[4] = PyTuple_GET_ITEM(__pyx_args, 4);
        values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
        values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        break;
        default: goto __pyx_L5_argtuple_error;
      }
    }
    __pyx_v_frames = ((PyArrayObject *)values[0]);
    __pyx_v_sigma = __pyx_PyFloat_AsDouble(values[1]); if (unlikely((__pyx_v_sigma == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 564, __pyx_L3_error)
    __pyx_v_nkeep = __Pyx_PyInt_As_int(values[2]); if (unlikely((__pyx_v_nkeep == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 565, __pyx_L3_error)
    __pyx_v_combine_mode = __Pyx_PyInt_As_int(values[3]); if (unlikely((__pyx_v_combine_mode == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 565, __pyx_L3_error)
    __pyx_v_reject_mode = __Pyx_PyInt_As_int(values[4]); if (unlikely((__pyx_v_reject_mode == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 565, __pyx_L3_error)
    __pyx_v_return_std_frame = values[5];
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  __Pyx_RaiseArgtupleInvalid("master_combine", 0, 5, 6, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 564, __pyx_L3_error)
  __pyx_L3_error:;
  __Pyx_AddTraceback("orb.cutils.master_combine", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __Pyx_RefNannyFinishContext();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_frames), __pyx_ptype_5numpy_ndarray, 1, "frames", 0))) __PYX_ERR(0, 564, __pyx_L1_error)
  __pyx_r = __pyx_pf_3orb_6cutils_24master_combine(__pyx_self, __pyx_v_frames, __pyx_v_sigma, __pyx_v_nkeep, __pyx_v_combine_mode, __pyx_v_reject_mode, __pyx_v_return_std_frame);

  /* "orb/cutils.pyx":564
 *     return x[min_mask:max_mask+1]
 * 
 * def master_combine(np.ndarray[np.float64_t, ndim=3] frames, double sigma,             # <<<<<<<<<<<<<<
 *                    int nkeep, int combine_mode, int reject_mode,
 *                    return_std_frame=False):
 */

  /* function exit code */
  goto __pyx_L0;
  __pyx_L1_error:;
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_24master_combine(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_frames, double __pyx_v_sigma, int __pyx_v_nkeep, int __pyx_v_combine_mode, int __pyx_v_reject_mode, PyObject *__pyx_v_return_std_frame) {
  int __pyx_v_stop_rejection;
  int __pyx_v_dimx;
  int __pyx_v_dimy;
  int __pyx_v_dimz;
  PyArrayObject *__pyx_v_framesdiff = 0;
  PyArrayObject *__pyx_v_argmax2d = 0;
  PyArrayObject *__pyx_v_max2d = 0;
  PyArrayObject *__pyx_v_sqrtmean2d = 0;
  PyArrayObject *__pyx_v_rejects2d = 0;
  PyArrayObject *__pyx_v_new_rejects2d = 0;
  PyArrayObject *__pyx_v_mean2d = 0;
  PyArrayObject *__pyx_v_std2d = 0;
  PyObject *__pyx_v_nans = NULL;
  PyObject *__pyx_v_mask2d = NULL;
  PyObject *__pyx_v_rejpix = NULL;
  PyObject *__pyx_v_result = NULL;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_argmax2d;
  __Pyx_Buffer __pyx_pybuffer_argmax2d;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_frames;
  __Pyx_Buffer __pyx_pybuffer_frames;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_framesdiff;
  __Pyx_Buffer __pyx_pybuffer_framesdiff;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_max2d;
  __Pyx_Buffer __pyx_pybuffer_max2d;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_mean2d;
  __Pyx_Buffer __pyx_pybuffer_mean2d;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_new_rejects2d;
  __Pyx_Buffer __pyx_pybuffer_new_rejects2d;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_rejects2d;
  __Pyx_Buffer __pyx_pybuffer_rejects2d;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_sqrtmean2d;
  __Pyx_Buffer __pyx_pybuffer_sqrtmean2d;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_std2d;
  __Pyx_Buffer __pyx_pybuffer_std2d;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  int __pyx_t_1;
  PyObject *__pyx_t_2 = NULL;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  PyObject *__pyx_t_5 = NULL;
  PyObject *__pyx_t_6 = NULL;
  PyArrayObject *__pyx_t_7 = NULL;
  PyArrayObject *__pyx_t_8 = NULL;
  PyArrayObject *__pyx_t_9 = NULL;
  PyArrayObject *__pyx_t_10 = NULL;
  PyArrayObject *__pyx_t_11 = NULL;
  PyArrayObject *__pyx_t_12 = NULL;
  PyArrayObject *__pyx_t_13 = NULL;
  PyArrayObject *__pyx_t_14 = NULL;
  PyArrayObject *__pyx_t_15 = NULL;
  int __pyx_t_16;
  PyObject *__pyx_t_17 = NULL;
  PyObject *__pyx_t_18 = NULL;
  PyObject *__pyx_t_19 = NULL;
  PyObject *__pyx_t_20 = NULL;
  PyObject *__pyx_t_21 = NULL;
  Py_ssize_t __pyx_t_22;
  PyObject *__pyx_t_23 = NULL;
  int __pyx_t_24;
  __Pyx_RefNannySetupContext("master_combine", 0);
  __Pyx_INCREF((PyObject *)__pyx_v_frames);
  __pyx_pybuffer_framesdiff.pybuffer.buf = NULL;
  __pyx_pybuffer_framesdiff.refcount = 0;
  __pyx_pybuffernd_framesdiff.data = NULL;
  __pyx_pybuffernd_framesdiff.rcbuffer = &__pyx_pybuffer_framesdiff;
  __pyx_pybuffer_argmax2d.pybuffer.buf = NULL;
  __pyx_pybuffer_argmax2d.refcount = 0;
  __pyx_pybuffernd_argmax2d.data = NULL;
  __pyx_pybuffernd_argmax2d.rcbuffer = &__pyx_pybuffer_argmax2d;
  __pyx_pybuffer_max2d.pybuffer.buf = NULL;
  __pyx_pybuffer_max2d.refcount = 0;
  __pyx_pybuffernd_max2d.data = NULL;
  __pyx_pybuffernd_max2d.rcbuffer = &__pyx_pybuffer_max2d;
  __pyx_pybuffer_sqrtmean2d.pybuffer.buf = NULL;
  __pyx_pybuffer_sqrtmean2d.refcount = 0;
  __pyx_pybuffernd_sqrtmean2d.data = NULL;
  __pyx_pybuffernd_sqrtmean2d.rcbuffer = &__pyx_pybuffer_sqrtmean2d;
  __pyx_pybuffer_rejects2d.pybuffer.buf = NULL;
  __pyx_pybuffer_rejects2d.refcount = 0;
  __pyx_pybuffernd_rejects2d.data = NULL;
  __pyx_pybuffernd_rejects2d.rcbuffer = &__pyx_pybuffer_rejects2d;
  __pyx_pybuffer_new_rejects2d.pybuffer.buf = NULL;
  __pyx_pybuffer_new_rejects2d.refcount = 0;
  __pyx_pybuffernd_new_rejects2d.data = NULL;
  __pyx_pybuffernd_new_rejects2d.rcbuffer = &__pyx_pybuffer_new_rejects2d;
  __pyx_pybuffer_mean2d.pybuffer.buf = NULL;
  __pyx_pybuffer_mean2d.refcount = 0;
  __pyx_pybuffernd_mean2d.data = NULL;
  __pyx_pybuffernd_mean2d.rcbuffer = &__pyx_pybuffer_mean2d;
  __pyx_pybuffer_std2d.pybuffer.buf = NULL;
  __pyx_pybuffer_std2d.refcount = 0;
  __pyx_pybuffernd_std2d.data = NULL;
  __pyx_pybuffernd_std2d.rcbuffer = &__pyx_pybuffer_std2d;
  __pyx_pybuffer_frames.pybuffer.buf = NULL;
  __pyx_pybuffer_frames.refcount = 0;
  __pyx_pybuffernd_frames.data = NULL;
  __pyx_pybuffernd_frames.rcbuffer = &__pyx_pybuffer_frames;
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_frames.rcbuffer->pybuffer, (PyObject*)__pyx_v_frames, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 3, 0, __pyx_stack) == -1)) __PYX_ERR(0, 564, __pyx_L1_error)
  }
  __pyx_pybuffernd_frames.diminfo[0].strides = __pyx_pybuffernd_frames.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_frames.diminfo[0].shape = __pyx_pybuffernd_frames.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_frames.diminfo[1].strides = __pyx_pybuffernd_frames.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_frames.diminfo[1].shape = __pyx_pybuffernd_frames.rcbuffer->pybuffer.shape[1]; __pyx_pybuffernd_frames.diminfo[2].strides = __pyx_pybuffernd_frames.rcbuffer->pybuffer.strides[2]; __pyx_pybuffernd_frames.diminfo[2].shape = __pyx_pybuffernd_frames.rcbuffer->pybuffer.shape[2];

  /* "orb/cutils.pyx":613
 *     """
 * 
 *     cdef int stop_rejection = 0             # <<<<<<<<<<<<<<
 *     cdef int dimx = frames.shape[0]
 *     cdef int dimy = frames.shape[1]
 */
  __pyx_v_stop_rejection = 0;

  /* "orb/cutils.pyx":614
 * 
 *     cdef int stop_rejection = 0
 *     cdef int dimx = frames.shape[0]             # <<<<<<<<<<<<<<
 *     cdef int dimy = frames.shape[1]
 *     cdef int dimz = frames.shape[2]
 */
  __pyx_v_dimx = (__pyx_v_frames->dimensions[0]);

  /* "orb/cutils.pyx":615
 *     cdef int stop_rejection = 0
 *     cdef int dimx = frames.shape[0]
 *     cdef int dimy = frames.shape[1]             # <<<<<<<<<<<<<<
 *     cdef int dimz = frames.shape[2]
 *     if dimz < 3: raise Exception('There must be more than 2 frames to combine')
 */
  __pyx_v_dimy = (__pyx_v_frames->dimensions[1]);

  /* "orb/cutils.pyx":616
 *     cdef int dimx = frames.shape[0]
 *     cdef int dimy = frames.shape[1]
 *     cdef int dimz = frames.shape[2]             # <<<<<<<<<<<<<<
 *     if dimz < 3: raise Exception('There must be more than 2 frames to combine')
 * 
 */
  __pyx_v_dimz = (__pyx_v_frames->dimensions[2]);

  /* "orb/cutils.pyx":617
 *     cdef int dimy = frames.shape[1]
 *     cdef int dimz = frames.shape[2]
 *     if dimz < 3: raise Exception('There must be more than 2 frames to combine')             # <<<<<<<<<<<<<<
 * 
 *     cdef np.ndarray[np.float64_t, ndim=3] framesdiff = np.zeros(
 */
  __pyx_t_1 = ((__pyx_v_dimz < 3) != 0);
  if (__pyx_t_1) {
    __pyx_t_2 = __Pyx_PyObject_Call(__pyx_builtin_Exception, __pyx_tuple__29, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 617, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_Raise(__pyx_t_2, 0, 0, 0);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __PYX_ERR(0, 617, __pyx_L1_error)
  }

  /* "orb/cutils.pyx":619
 *     if dimz < 3: raise Exception('There must be more than 2 frames to combine')
 * 
 *     cdef np.ndarray[np.float64_t, ndim=3] framesdiff = np.zeros(             # <<<<<<<<<<<<<<
 *         (dimx, dimy, dimz), dtype=np.float64)
 * 
 */
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 619, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_zeros); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 619, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;

  /* "orb/cutils.pyx":620
 * 
 *     cdef np.ndarray[np.float64_t, ndim=3] framesdiff = np.zeros(
 *         (dimx, dimy, dimz), dtype=np.float64)             # <<<<<<<<<<<<<<
 * 
 *     cdef np.ndarray[np.int64_t, ndim=2] argmax2d = np.zeros(
 */
  __pyx_t_2 = __Pyx_PyInt_From_int(__pyx_v_dimx); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 620, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_4 = __Pyx_PyInt_From_int(__pyx_v_dimy); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 620, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_5 = __Pyx_PyInt_From_int(__pyx_v_dimz); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 620, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_6 = PyTuple_New(3); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 620, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __Pyx_GIVEREF(__pyx_t_2);
  PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_2);
  __Pyx_GIVEREF(__pyx_t_4);
  PyTuple_SET_ITEM(__pyx_t_6, 1, __pyx_t_4);
  __Pyx_GIVEREF(__pyx_t_5);
  PyTuple_SET_ITEM(__pyx_t_6, 2, __pyx_t_5);
  __pyx_t_2 = 0;
  __pyx_t_4 = 0;
  __pyx_t_5 = 0;

  /* "orb/cutils.pyx":619
 *     if dimz < 3: raise Exception('There must be more than 2 frames to combine')
 * 
 *     cdef np.ndarray[np.float64_t, ndim=3] framesdiff = np.zeros(             # <<<<<<<<<<<<<<
 *         (dimx, dimy, dimz), dtype=np.float64)
 * 
 */
  __pyx_t_5 = PyTuple_New(1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 619, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_GIVEREF(__pyx_t_6);
  PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_6);
  __pyx_t_6 = 0;

  /* "orb/cutils.pyx":620
 * 
 *     cdef np.ndarray[np.float64_t, ndim=3] framesdiff = np.zeros(
 *         (dimx, dimy, dimz), dtype=np.float64)             # <<<<<<<<<<<<<<
 * 
 *     cdef np.ndarray[np.int64_t, ndim=2] argmax2d = np.zeros(
 */
  __pyx_t_6 = PyDict_New(); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 620, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 620, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_float64); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 620, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  if (PyDict_SetItem(__pyx_t_6, __pyx_n_s_dtype, __pyx_t_2) < 0) __PYX_ERR(0, 620, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;

  /* "orb/cutils.pyx":619
 *     if dimz < 3: raise Exception('There must be more than 2 frames to combine')
 * 
 *     cdef np.ndarray[np.float64_t, ndim=3] framesdiff = np.zeros(             # <<<<<<<<<<<<<<
 *         (dimx, dimy, dimz), dtype=np.float64)
 * 
 */
  __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_5, __pyx_t_6); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 619, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
  if (!(likely(((__pyx_t_2) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_2, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 619, __pyx_L1_error)
  __pyx_t_7 = ((PyArrayObject *)__pyx_t_2);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_framesdiff.rcbuffer->pybuffer, (PyObject*)__pyx_t_7, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 3, 0, __pyx_stack) == -1)) {
      __pyx_v_framesdiff = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_framesdiff.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 619, __pyx_L1_error)
    } else {__pyx_pybuffernd_framesdiff.diminfo[0].strides = __pyx_pybuffernd_framesdiff.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_framesdiff.diminfo[0].shape = __pyx_pybuffernd_framesdiff.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_framesdiff.diminfo[1].strides = __pyx_pybuffernd_framesdiff.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_framesdiff.diminfo[1].shape = __pyx_pybuffernd_framesdiff.rcbuffer->pybuffer.shape[1]; __pyx_pybuffernd_framesdiff.diminfo[2].strides = __pyx_pybuffernd_framesdiff.rcbuffer->pybuffer.strides[2]; __pyx_pybuffernd_framesdiff.diminfo[2].shape = __pyx_pybuffernd_framesdiff.rcbuffer->pybuffer.shape[2];
    }
  }
  __pyx_t_7 = 0;
  __pyx_v_framesdiff = ((PyArrayObject *)__pyx_t_2);
  __pyx_t_2 = 0;

  /* "orb/cutils.pyx":622
 *         (dimx, dimy, dimz), dtype=np.float64)
 * 
 *     cdef np.ndarray[np.int64_t, ndim=2] argmax2d = np.zeros(             # <<<<<<<<<<<<<<
 *         (dimx, dimy), dtype=np.int64)
 *     cdef np.ndarray[np.float64_t, ndim=2] max2d = np.zeros(
 */
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 622, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_zeros); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 622, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;

  /* "orb/cutils.pyx":623
 * 
 *     cdef np.ndarray[np.int64_t, ndim=2] argmax2d = np.zeros(
 *         (dimx, dimy), dtype=np.int64)             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.float64_t, ndim=2] max2d = np.zeros(
 *         (dimx, dimy), dtype=np.float64)
 */
  __pyx_t_2 = __Pyx_PyInt_From_int(__pyx_v_dimx); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 623, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_5 = __Pyx_PyInt_From_int(__pyx_v_dimy); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 623, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_3 = PyTuple_New(2); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 623, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_GIVEREF(__pyx_t_2);
  PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_2);
  __Pyx_GIVEREF(__pyx_t_5);
  PyTuple_SET_ITEM(__pyx_t_3, 1, __pyx_t_5);
  __pyx_t_2 = 0;
  __pyx_t_5 = 0;

  /* "orb/cutils.pyx":622
 *         (dimx, dimy, dimz), dtype=np.float64)
 * 
 *     cdef np.ndarray[np.int64_t, ndim=2] argmax2d = np.zeros(             # <<<<<<<<<<<<<<
 *         (dimx, dimy), dtype=np.int64)
 *     cdef np.ndarray[np.float64_t, ndim=2] max2d = np.zeros(
 */
  __pyx_t_5 = PyTuple_New(1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 622, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_GIVEREF(__pyx_t_3);
  PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_3);
  __pyx_t_3 = 0;

  /* "orb/cutils.pyx":623
 * 
 *     cdef np.ndarray[np.int64_t, ndim=2] argmax2d = np.zeros(
 *         (dimx, dimy), dtype=np.int64)             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.float64_t, ndim=2] max2d = np.zeros(
 *         (dimx, dimy), dtype=np.float64)
 */
  __pyx_t_3 = PyDict_New(); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 623, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 623, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_int64); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 623, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  if (PyDict_SetItem(__pyx_t_3, __pyx_n_s_dtype, __pyx_t_4) < 0) __PYX_ERR(0, 623, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;

  /* "orb/cutils.pyx":622
 *         (dimx, dimy, dimz), dtype=np.float64)
 * 
 *     cdef np.ndarray[np.int64_t, ndim=2] argmax2d = np.zeros(             # <<<<<<<<<<<<<<
 *         (dimx, dimy), dtype=np.int64)
 *     cdef np.ndarray[np.float64_t, ndim=2] max2d = np.zeros(
 */
  __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_6, __pyx_t_5, __pyx_t_3); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 622, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  if (!(likely(((__pyx_t_4) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_4, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 622, __pyx_L1_error)
  __pyx_t_8 = ((PyArrayObject *)__pyx_t_4);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_argmax2d.rcbuffer->pybuffer, (PyObject*)__pyx_t_8, &__Pyx_TypeInfo_nn___pyx_t_5numpy_int64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
      __pyx_v_argmax2d = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_argmax2d.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 622, __pyx_L1_error)
    } else {__pyx_pybuffernd_argmax2d.diminfo[0].strides = __pyx_pybuffernd_argmax2d.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_argmax2d.diminfo[0].shape = __pyx_pybuffernd_argmax2d.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_argmax2d.diminfo[1].strides = __pyx_pybuffernd_argmax2d.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_argmax2d.diminfo[1].shape = __pyx_pybuffernd_argmax2d.rcbuffer->pybuffer.shape[1];
    }
  }
  __pyx_t_8 = 0;
  __pyx_v_argmax2d = ((PyArrayObject *)__pyx_t_4);
  __pyx_t_4 = 0;

  /* "orb/cutils.pyx":624
 *     cdef np.ndarray[np.int64_t, ndim=2] argmax2d = np.zeros(
 *         (dimx, dimy), dtype=np.int64)
 *     cdef np.ndarray[np.float64_t, ndim=2] max2d = np.zeros(             # <<<<<<<<<<<<<<
 *         (dimx, dimy), dtype=np.float64)
 *     cdef np.ndarray[np.float64_t, ndim=2] sqrtmean2d = np.zeros(
 */
  __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 624, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_zeros); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 624, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;

  /* "orb/cutils.pyx":625
 *         (dimx, dimy), dtype=np.int64)
 *     cdef np.ndarray[np.float64_t, ndim=2] max2d = np.zeros(
 *         (dimx, dimy), dtype=np.float64)             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.float64_t, ndim=2] sqrtmean2d = np.zeros(
 *         (dimx, dimy), dtype=np.float64)
 */
  __pyx_t_4 = __Pyx_PyInt_From_int(__pyx_v_dimx); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 625, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_5 = __Pyx_PyInt_From_int(__pyx_v_dimy); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 625, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_6 = PyTuple_New(2); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 625, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __Pyx_GIVEREF(__pyx_t_4);
  PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_4);
  __Pyx_GIVEREF(__pyx_t_5);
  PyTuple_SET_ITEM(__pyx_t_6, 1, __pyx_t_5);
  __pyx_t_4 = 0;
  __pyx_t_5 = 0;

  /* "orb/cutils.pyx":624
 *     cdef np.ndarray[np.int64_t, ndim=2] argmax2d = np.zeros(
 *         (dimx, dimy), dtype=np.int64)
 *     cdef np.ndarray[np.float64_t, ndim=2] max2d = np.zeros(             # <<<<<<<<<<<<<<
 *         (dimx, dimy), dtype=np.float64)
 *     cdef np.ndarray[np.float64_t, ndim=2] sqrtmean2d = np.zeros(
 */
  __pyx_t_5 = PyTuple_New(1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 624, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_GIVEREF(__pyx_t_6);
  PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_6);
  __pyx_t_6 = 0;

  /* "orb/cutils.pyx":625
 *         (dimx, dimy), dtype=np.int64)
 *     cdef np.ndarray[np.float64_t, ndim=2] max2d = np.zeros(
 *         (dimx, dimy), dtype=np.float64)             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.float64_t, ndim=2] sqrtmean2d = np.zeros(
 *         (dimx, dimy), dtype=np.float64)
 */
  __pyx_t_6 = PyDict_New(); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 625, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 625, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_float64); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 625, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  if (PyDict_SetItem(__pyx_t_6, __pyx_n_s_dtype, __pyx_t_2) < 0) __PYX_ERR(0, 625, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;

  /* "orb/cutils.pyx":624
 *     cdef np.ndarray[np.int64_t, ndim=2] argmax2d = np.zeros(
 *         (dimx, dimy), dtype=np.int64)
 *     cdef np.ndarray[np.float64_t, ndim=2] max2d = np.zeros(             # <<<<<<<<<<<<<<
 *         (dimx, dimy), dtype=np.float64)
 *     cdef np.ndarray[np.float64_t, ndim=2] sqrtmean2d = np.zeros(
 */
  __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_5, __pyx_t_6); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 624, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
  if (!(likely(((__pyx_t_2) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_2, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 624, __pyx_L1_error)
  __pyx_t_9 = ((PyArrayObject *)__pyx_t_2);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_max2d.rcbuffer->pybuffer, (PyObject*)__pyx_t_9, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
      __pyx_v_max2d = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_max2d.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 624, __pyx_L1_error)
    } else {__pyx_pybuffernd_max2d.diminfo[0].strides = __pyx_pybuffernd_max2d.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_max2d.diminfo[0].shape = __pyx_pybuffernd_max2d.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_max2d.diminfo[1].strides = __pyx_pybuffernd_max2d.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_max2d.diminfo[1].shape = __pyx_pybuffernd_max2d.rcbuffer->pybuffer.shape[1];
    }
  }
  __pyx_t_9 = 0;
  __pyx_v_max2d = ((PyArrayObject *)__pyx_t_2);
  __pyx_t_2 = 0;

  /* "orb/cutils.pyx":626
 *     cdef np.ndarray[np.float64_t, ndim=2] max2d = np.zeros(
 *         (dimx, dimy), dtype=np.float64)
 *     cdef np.ndarray[np.float64_t, ndim=2] sqrtmean2d = np.zeros(             # <<<<<<<<<<<<<<
 *         (dimx, dimy), dtype=np.float64)
 *     cdef np.ndarray[np.uint8_t, ndim=2] rejects2d = np.zeros(
 */
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 626, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_zeros); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 626, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;

  /* "orb/cutils.pyx":627
 *         (dimx, dimy), dtype=np.float64)
 *     cdef np.ndarray[np.float64_t, ndim=2] sqrtmean2d = np.zeros(
 *         (dimx, dimy), dtype=np.float64)             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.uint8_t, ndim=2] rejects2d = np.zeros(
 *         (dimx, dimy), dtype=np.uint8)
 */
  __pyx_t_2 = __Pyx_PyInt_From_int(__pyx_v_dimx); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 627, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_5 = __Pyx_PyInt_From_int(__pyx_v_dimy); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 627, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_3 = PyTuple_New(2); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 627, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_GIVEREF(__pyx_t_2);
  PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_2);
  __Pyx_GIVEREF(__pyx_t_5);
  PyTuple_SET_ITEM(__pyx_t_3, 1, __pyx_t_5);
  __pyx_t_2 = 0;
  __pyx_t_5 = 0;

  /* "orb/cutils.pyx":626
 *     cdef np.ndarray[np.float64_t, ndim=2] max2d = np.zeros(
 *         (dimx, dimy), dtype=np.float64)
 *     cdef np.ndarray[np.float64_t, ndim=2] sqrtmean2d = np.zeros(             # <<<<<<<<<<<<<<
 *         (dimx, dimy), dtype=np.float64)
 *     cdef np.ndarray[np.uint8_t, ndim=2] rejects2d = np.zeros(
 */
  __pyx_t_5 = PyTuple_New(1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 626, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_GIVEREF(__pyx_t_3);
  PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_3);
  __pyx_t_3 = 0;

  /* "orb/cutils.pyx":627
 *         (dimx, dimy), dtype=np.float64)
 *     cdef np.ndarray[np.float64_t, ndim=2] sqrtmean2d = np.zeros(
 *         (dimx, dimy), dtype=np.float64)             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.uint8_t, ndim=2] rejects2d = np.zeros(
 *         (dimx, dimy), dtype=np.uint8)
 */
  __pyx_t_3 = PyDict_New(); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 627, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 627, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_float64); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 627, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  if (PyDict_SetItem(__pyx_t_3, __pyx_n_s_dtype, __pyx_t_4) < 0) __PYX_ERR(0, 627, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;

  /* "orb/cutils.pyx":626
 *     cdef np.ndarray[np.float64_t, ndim=2] max2d = np.zeros(
 *         (dimx, dimy), dtype=np.float64)
 *     cdef np.ndarray[np.float64_t, ndim=2] sqrtmean2d = np.zeros(             # <<<<<<<<<<<<<<
 *         (dimx, dimy), dtype=np.float64)
 *     cdef np.ndarray[np.uint8_t, ndim=2] rejects2d = np.zeros(
 */
  __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_6, __pyx_t_5, __pyx_t_3); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 626, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  if (!(likely(((__pyx_t_4) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_4, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 626, __pyx_L1_error)
  __pyx_t_10 = ((PyArrayObject *)__pyx_t_4);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_sqrtmean2d.rcbuffer->pybuffer, (PyObject*)__pyx_t_10, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
      __pyx_v_sqrtmean2d = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_sqrtmean2d.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 626, __pyx_L1_error)
    } else {__pyx_pybuffernd_sqrtmean2d.diminfo[0].strides = __pyx_pybuffernd_sqrtmean2d.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_sqrtmean2d.diminfo[0].shape = __pyx_pybuffernd_sqrtmean2d.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_sqrtmean2d.diminfo[1].strides = __pyx_pybuffernd_sqrtmean2d.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_sqrtmean2d.diminfo[1].shape = __pyx_pybuffernd_sqrtmean2d.rcbuffer->pybuffer.shape[1];
    }
  }
  __pyx_t_10 = 0;
  __pyx_v_sqrtmean2d = ((PyArrayObject *)__pyx_t_4);
  __pyx_t_4 = 0;

  /* "orb/cutils.pyx":628
 *     cdef np.ndarray[np.float64_t, ndim=2] sqrtmean2d = np.zeros(
 *         (dimx, dimy), dtype=np.float64)
 *     cdef np.ndarray[np.uint8_t, ndim=2] rejects2d = np.zeros(             # <<<<<<<<<<<<<<
 *         (dimx, dimy), dtype=np.uint8)
 *     cdef np.ndarray[np.uint8_t, ndim=2] new_rejects2d = np.zeros(
 */
  __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 628, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_zeros); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 628, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;

  /* "orb/cutils.pyx":629
 *         (dimx, dimy), dtype=np.float64)
 *     cdef np.ndarray[np.uint8_t, ndim=2] rejects2d = np.zeros(
 *         (dimx, dimy), dtype=np.uint8)             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.uint8_t, ndim=2] new_rejects2d = np.zeros(
 *         (dimx, dimy), dtype=np.uint8)
 */
  __pyx_t_4 = __Pyx_PyInt_From_int(__pyx_v_dimx); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 629, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_5 = __Pyx_PyInt_From_int(__pyx_v_dimy); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 629, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_6 = PyTuple_New(2); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 629, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __Pyx_GIVEREF(__pyx_t_4);
  PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_4);
  __Pyx_GIVEREF(__pyx_t_5);
  PyTuple_SET_ITEM(__pyx_t_6, 1, __pyx_t_5);
  __pyx_t_4 = 0;
  __pyx_t_5 = 0;

  /* "orb/cutils.pyx":628
 *     cdef np.ndarray[np.float64_t, ndim=2] sqrtmean2d = np.zeros(
 *         (dimx, dimy), dtype=np.float64)
 *     cdef np.ndarray[np.uint8_t, ndim=2] rejects2d = np.zeros(             # <<<<<<<<<<<<<<
 *         (dimx, dimy), dtype=np.uint8)
 *     cdef np.ndarray[np.uint8_t, ndim=2] new_rejects2d = np.zeros(
 */
  __pyx_t_5 = PyTuple_New(1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 628, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_GIVEREF(__pyx_t_6);
  PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_6);
  __pyx_t_6 = 0;

  /* "orb/cutils.pyx":629
 *         (dimx, dimy), dtype=np.float64)
 *     cdef np.ndarray[np.uint8_t, ndim=2] rejects2d = np.zeros(
 *         (dimx, dimy), dtype=np.uint8)             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.uint8_t, ndim=2] new_rejects2d = np.zeros(
 *         (dimx, dimy), dtype=np.uint8)
 */
  __pyx_t_6 = PyDict_New(); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 629, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 629, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_uint8); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 629, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  if (PyDict_SetItem(__pyx_t_6, __pyx_n_s_dtype, __pyx_t_2) < 0) __PYX_ERR(0, 629, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;

  /* "orb/cutils.pyx":628
 *     cdef np.ndarray[np.float64_t, ndim=2] sqrtmean2d = np.zeros(
 *         (dimx, dimy), dtype=np.float64)
 *     cdef np.ndarray[np.uint8_t, ndim=2] rejects2d = np.zeros(             # <<<<<<<<<<<<<<
 *         (dimx, dimy), dtype=np.uint8)
 *     cdef np.ndarray[np.uint8_t, ndim=2] new_rejects2d = np.zeros(
 */
  __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_5, __pyx_t_6); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 628, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
  if (!(likely(((__pyx_t_2) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_2, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 628, __pyx_L1_error)
  __pyx_t_11 = ((PyArrayObject *)__pyx_t_2);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_rejects2d.rcbuffer->pybuffer, (PyObject*)__pyx_t_11, &__Pyx_TypeInfo_nn___pyx_t_5numpy_uint8_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
      __pyx_v_rejects2d = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_rejects2d.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 628, __pyx_L1_error)
    } else {__pyx_pybuffernd_rejects2d.diminfo[0].strides = __pyx_pybuffernd_rejects2d.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_rejects2d.diminfo[0].shape = __pyx_pybuffernd_rejects2d.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_rejects2d.diminfo[1].strides = __pyx_pybuffernd_rejects2d.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_rejects2d.diminfo[1].shape = __pyx_pybuffernd_rejects2d.rcbuffer->pybuffer.shape[1];
    }
  }
  __pyx_t_11 = 0;
  __pyx_v_rejects2d = ((PyArrayObject *)__pyx_t_2);
  __pyx_t_2 = 0;

  /* "orb/cutils.pyx":630
 *     cdef np.ndarray[np.uint8_t, ndim=2] rejects2d = np.zeros(
 *         (dimx, dimy), dtype=np.uint8)
 *     cdef np.ndarray[np.uint8_t, ndim=2] new_rejects2d = np.zeros(             # <<<<<<<<<<<<<<
 *         (dimx, dimy), dtype=np.uint8)
 * 
 */
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 630, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_zeros); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 630, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;

  /* "orb/cutils.pyx":631
 *         (dimx, dimy), dtype=np.uint8)
 *     cdef np.ndarray[np.uint8_t, ndim=2] new_rejects2d = np.zeros(
 *         (dimx, dimy), dtype=np.uint8)             # <<<<<<<<<<<<<<
 * 
 * 
 */
  __pyx_t_2 = __Pyx_PyInt_From_int(__pyx_v_dimx); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 631, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_5 = __Pyx_PyInt_From_int(__pyx_v_dimy); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 631, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_3 = PyTuple_New(2); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 631, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_GIVEREF(__pyx_t_2);
  PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_2);
  __Pyx_GIVEREF(__pyx_t_5);
  PyTuple_SET_ITEM(__pyx_t_3, 1, __pyx_t_5);
  __pyx_t_2 = 0;
  __pyx_t_5 = 0;

  /* "orb/cutils.pyx":630
 *     cdef np.ndarray[np.uint8_t, ndim=2] rejects2d = np.zeros(
 *         (dimx, dimy), dtype=np.uint8)
 *     cdef np.ndarray[np.uint8_t, ndim=2] new_rejects2d = np.zeros(             # <<<<<<<<<<<<<<
 *         (dimx, dimy), dtype=np.uint8)
 * 
 */
  __pyx_t_5 = PyTuple_New(1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 630, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_GIVEREF(__pyx_t_3);
  PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_3);
  __pyx_t_3 = 0;

  /* "orb/cutils.pyx":631
 *         (dimx, dimy), dtype=np.uint8)
 *     cdef np.ndarray[np.uint8_t, ndim=2] new_rejects2d = np.zeros(
 *         (dimx, dimy), dtype=np.uint8)             # <<<<<<<<<<<<<<
 * 
 * 
 */
  __pyx_t_3 = PyDict_New(); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 631, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 631, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_uint8); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 631, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  if (PyDict_SetItem(__pyx_t_3, __pyx_n_s_dtype, __pyx_t_4) < 0) __PYX_ERR(0, 631, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;

  /* "orb/cutils.pyx":630
 *     cdef np.ndarray[np.uint8_t, ndim=2] rejects2d = np.zeros(
 *         (dimx, dimy), dtype=np.uint8)
 *     cdef np.ndarray[np.uint8_t, ndim=2] new_rejects2d = np.zeros(             # <<<<<<<<<<<<<<
 *         (dimx, dimy), dtype=np.uint8)
 * 
 */
  __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_6, __pyx_t_5, __pyx_t_3); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 630, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  if (!(likely(((__pyx_t_4) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_4, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 630, __pyx_L1_error)
  __pyx_t_12 = ((PyArrayObject *)__pyx_t_4);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_new_rejects2d.rcbuffer->pybuffer, (PyObject*)__pyx_t_12, &__Pyx_TypeInfo_nn___pyx_t_5numpy_uint8_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
      __pyx_v_new_rejects2d = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_new_rejects2d.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 630, __pyx_L1_error)
    } else {__pyx_pybuffernd_new_rejects2d.diminfo[0].strides = __pyx_pybuffernd_new_rejects2d.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_new_rejects2d.diminfo[0].shape = __pyx_pybuffernd_new_rejects2d.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_new_rejects2d.diminfo[1].strides = __pyx_pybuffernd_new_rejects2d.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_new_rejects2d.diminfo[1].shape = __pyx_pybuffernd_new_rejects2d.rcbuffer->pybuffer.shape[1];
    }
  }
  __pyx_t_12 = 0;
  __pyx_v_new_rejects2d = ((PyArrayObject *)__pyx_t_4);
  __pyx_t_4 = 0;

  /* "orb/cutils.pyx":634
 * 
 * 
 *     cdef np.ndarray[np.float64_t, ndim=2] mean2d = np.zeros((dimx, dimy))             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.float64_t, ndim=2] std2d = np.zeros((dimx, dimy))
 * 
 */
  __pyx_t_3 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 634, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_zeros); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 634, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_3 = __Pyx_PyInt_From_int(__pyx_v_dimx); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 634, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_6 = __Pyx_PyInt_From_int(__pyx_v_dimy); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 634, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __pyx_t_2 = PyTuple_New(2); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 634, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_GIVEREF(__pyx_t_3);
  PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_3);
  __Pyx_GIVEREF(__pyx_t_6);
  PyTuple_SET_ITEM(__pyx_t_2, 1, __pyx_t_6);
  __pyx_t_3 = 0;
  __pyx_t_6 = 0;
  __pyx_t_6 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_5))) {
    __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_5);
    if (likely(__pyx_t_6)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_5);
      __Pyx_INCREF(__pyx_t_6);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_5, function);
    }
  }
  if (!__pyx_t_6) {
    __pyx_t_4 = __Pyx_PyObject_CallOneArg(__pyx_t_5, __pyx_t_2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 634, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __Pyx_GOTREF(__pyx_t_4);
  } else {
    __pyx_t_3 = PyTuple_New(1+1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 634, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_GIVEREF(__pyx_t_6); PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_6); __pyx_t_6 = NULL;
    __Pyx_GIVEREF(__pyx_t_2);
    PyTuple_SET_ITEM(__pyx_t_3, 0+1, __pyx_t_2);
    __pyx_t_2 = 0;
    __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_3, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 634, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  }
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  if (!(likely(((__pyx_t_4) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_4, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 634, __pyx_L1_error)
  __pyx_t_13 = ((PyArrayObject *)__pyx_t_4);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_mean2d.rcbuffer->pybuffer, (PyObject*)__pyx_t_13, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
      __pyx_v_mean2d = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_mean2d.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 634, __pyx_L1_error)
    } else {__pyx_pybuffernd_mean2d.diminfo[0].strides = __pyx_pybuffernd_mean2d.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_mean2d.diminfo[0].shape = __pyx_pybuffernd_mean2d.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_mean2d.diminfo[1].strides = __pyx_pybuffernd_mean2d.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_mean2d.diminfo[1].shape = __pyx_pybuffernd_mean2d.rcbuffer->pybuffer.shape[1];
    }
  }
  __pyx_t_13 = 0;
  __pyx_v_mean2d = ((PyArrayObject *)__pyx_t_4);
  __pyx_t_4 = 0;

  /* "orb/cutils.pyx":635
 * 
 *     cdef np.ndarray[np.float64_t, ndim=2] mean2d = np.zeros((dimx, dimy))
 *     cdef np.ndarray[np.float64_t, ndim=2] std2d = np.zeros((dimx, dimy))             # <<<<<<<<<<<<<<
 * 
 *     frames = np.sort(frames, axis=2)
 */
  __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 635, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_zeros); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 635, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_5 = __Pyx_PyInt_From_int(__pyx_v_dimx); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 635, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_2 = __Pyx_PyInt_From_int(__pyx_v_dimy); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 635, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_6 = PyTuple_New(2); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 635, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __Pyx_GIVEREF(__pyx_t_5);
  PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_5);
  __Pyx_GIVEREF(__pyx_t_2);
  PyTuple_SET_ITEM(__pyx_t_6, 1, __pyx_t_2);
  __pyx_t_5 = 0;
  __pyx_t_2 = 0;
  __pyx_t_2 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_3))) {
    __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_3);
    if (likely(__pyx_t_2)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
      __Pyx_INCREF(__pyx_t_2);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_3, function);
    }
  }
  if (!__pyx_t_2) {
    __pyx_t_4 = __Pyx_PyObject_CallOneArg(__pyx_t_3, __pyx_t_6); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 635, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
    __Pyx_GOTREF(__pyx_t_4);
  } else {
    __pyx_t_5 = PyTuple_New(1+1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 635, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_2); __pyx_t_2 = NULL;
    __Pyx_GIVEREF(__pyx_t_6);
    PyTuple_SET_ITEM(__pyx_t_5, 0+1, __pyx_t_6);
    __pyx_t_6 = 0;
    __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_5, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 635, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  }
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  if (!(likely(((__pyx_t_4) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_4, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 635, __pyx_L1_error)
  __pyx_t_14 = ((PyArrayObject *)__pyx_t_4);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_std2d.rcbuffer->pybuffer, (PyObject*)__pyx_t_14, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
      __pyx_v_std2d = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_std2d.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 635, __pyx_L1_error)
    } else {__pyx_pybuffernd_std2d.diminfo[0].strides = __pyx_pybuffernd_std2d.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_std2d.diminfo[0].shape = __pyx_pybuffernd_std2d.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_std2d.diminfo[1].strides = __pyx_pybuffernd_std2d.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_std2d.diminfo[1].shape = __pyx_pybuffernd_std2d.rcbuffer->pybuffer.shape[1];
    }
  }
  __pyx_t_14 = 0;
  __pyx_v_std2d = ((PyArrayObject *)__pyx_t_4);
  __pyx_t_4 = 0;

  /* "orb/cutils.pyx":637
 *     cdef np.ndarray[np.float64_t, ndim=2] std2d = np.zeros((dimx, dimy))
 * 
 *     frames = np.sort(frames, axis=2)             # <<<<<<<<<<<<<<
 *     mean2d = bn.nanmean(frames[:,:,1:-1], axis=2)
 *     std2d = bn.nanstd(frames[:,:,1:-1], axis=2)
 */
  __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 637, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_sort); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 637, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_4 = PyTuple_New(1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 637, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_INCREF(((PyObject *)__pyx_v_frames));
  __Pyx_GIVEREF(((PyObject *)__pyx_v_frames));
  PyTuple_SET_ITEM(__pyx_t_4, 0, ((PyObject *)__pyx_v_frames));
  __pyx_t_5 = PyDict_New(); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 637, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  if (PyDict_SetItem(__pyx_t_5, __pyx_n_s_axis, __pyx_int_2) < 0) __PYX_ERR(0, 637, __pyx_L1_error)
  __pyx_t_6 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_4, __pyx_t_5); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 637, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  if (!(likely(((__pyx_t_6) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_6, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 637, __pyx_L1_error)
  __pyx_t_15 = ((PyArrayObject *)__pyx_t_6);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_frames.rcbuffer->pybuffer);
    __pyx_t_16 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_frames.rcbuffer->pybuffer, (PyObject*)__pyx_t_15, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 3, 0, __pyx_stack);
    if (unlikely(__pyx_t_16 < 0)) {
      PyErr_Fetch(&__pyx_t_17, &__pyx_t_18, &__pyx_t_19);
      if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_frames.rcbuffer->pybuffer, (PyObject*)__pyx_v_frames, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 3, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_17); Py_XDECREF(__pyx_t_18); Py_XDECREF(__pyx_t_19);
        __Pyx_RaiseBufferFallbackError();
      } else {
        PyErr_Restore(__pyx_t_17, __pyx_t_18, __pyx_t_19);
      }
    }
    __pyx_pybuffernd_frames.diminfo[0].strides = __pyx_pybuffernd_frames.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_frames.diminfo[0].shape = __pyx_pybuffernd_frames.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_frames.diminfo[1].strides = __pyx_pybuffernd_frames.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_frames.diminfo[1].shape = __pyx_pybuffernd_frames.rcbuffer->pybuffer.shape[1]; __pyx_pybuffernd_frames.diminfo[2].strides = __pyx_pybuffernd_frames.rcbuffer->pybuffer.strides[2]; __pyx_pybuffernd_frames.diminfo[2].shape = __pyx_pybuffernd_frames.rcbuffer->pybuffer.shape[2];
    if (unlikely(__pyx_t_16 < 0)) __PYX_ERR(0, 637, __pyx_L1_error)
  }
  __pyx_t_15 = 0;
  __Pyx_DECREF_SET(__pyx_v_frames, ((PyArrayObject *)__pyx_t_6));
  __pyx_t_6 = 0;

  /* "orb/cutils.pyx":638
 * 
 *     frames = np.sort(frames, axis=2)
 *     mean2d = bn.nanmean(frames[:,:,1:-1], axis=2)             # <<<<<<<<<<<<<<
 *     std2d = bn.nanstd(frames[:,:,1:-1], axis=2)
 * 
 */
  __pyx_t_6 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 638, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_6, __pyx_n_s_nanmean); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 638, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
  __pyx_t_6 = PyObject_GetItem(((PyObject *)__pyx_v_frames), __pyx_tuple__33); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 638, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __pyx_t_4 = PyTuple_New(1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 638, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_GIVEREF(__pyx_t_6);
  PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_6);
  __pyx_t_6 = 0;
  __pyx_t_6 = PyDict_New(); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 638, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  if (PyDict_SetItem(__pyx_t_6, __pyx_n_s_axis, __pyx_int_2) < 0) __PYX_ERR(0, 638, __pyx_L1_error)
  __pyx_t_3 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_4, __pyx_t_6); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 638, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
  if (!(likely(((__pyx_t_3) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_3, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 638, __pyx_L1_error)
  __pyx_t_13 = ((PyArrayObject *)__pyx_t_3);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_mean2d.rcbuffer->pybuffer);
    __pyx_t_16 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_mean2d.rcbuffer->pybuffer, (PyObject*)__pyx_t_13, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
    if (unlikely(__pyx_t_16 < 0)) {
      PyErr_Fetch(&__pyx_t_19, &__pyx_t_18, &__pyx_t_17);
      if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_mean2d.rcbuffer->pybuffer, (PyObject*)__pyx_v_mean2d, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_19); Py_XDECREF(__pyx_t_18); Py_XDECREF(__pyx_t_17);
        __Pyx_RaiseBufferFallbackError();
      } else {
        PyErr_Restore(__pyx_t_19, __pyx_t_18, __pyx_t_17);
      }
    }
    __pyx_pybuffernd_mean2d.diminfo[0].strides = __pyx_pybuffernd_mean2d.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_mean2d.diminfo[0].shape = __pyx_pybuffernd_mean2d.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_mean2d.diminfo[1].strides = __pyx_pybuffernd_mean2d.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_mean2d.diminfo[1].shape = __pyx_pybuffernd_mean2d.rcbuffer->pybuffer.shape[1];
    if (unlikely(__pyx_t_16 < 0)) __PYX_ERR(0, 638, __pyx_L1_error)
  }
  __pyx_t_13 = 0;
  __Pyx_DECREF_SET(__pyx_v_mean2d, ((PyArrayObject *)__pyx_t_3));
  __pyx_t_3 = 0;

  /* "orb/cutils.pyx":639
 *     frames = np.sort(frames, axis=2)
 *     mean2d = bn.nanmean(frames[:,:,1:-1], axis=2)
 *     std2d = bn.nanstd(frames[:,:,1:-1], axis=2)             # <<<<<<<<<<<<<<
 * 
 *     ## Rejection
 */
  __pyx_t_3 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 639, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_nanstd); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 639, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_3 = PyObject_GetItem(((PyObject *)__pyx_v_frames), __pyx_tuple__37); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 639, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_4 = PyTuple_New(1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 639, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_GIVEREF(__pyx_t_3);
  PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_3);
  __pyx_t_3 = 0;
  __pyx_t_3 = PyDict_New(); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 639, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  if (PyDict_SetItem(__pyx_t_3, __pyx_n_s_axis, __pyx_int_2) < 0) __PYX_ERR(0, 639, __pyx_L1_error)
  __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_6, __pyx_t_4, __pyx_t_3); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 639, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  if (!(likely(((__pyx_t_5) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_5, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 639, __pyx_L1_error)
  __pyx_t_14 = ((PyArrayObject *)__pyx_t_5);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_std2d.rcbuffer->pybuffer);
    __pyx_t_16 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_std2d.rcbuffer->pybuffer, (PyObject*)__pyx_t_14, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
    if (unlikely(__pyx_t_16 < 0)) {
      PyErr_Fetch(&__pyx_t_17, &__pyx_t_18, &__pyx_t_19);
      if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_std2d.rcbuffer->pybuffer, (PyObject*)__pyx_v_std2d, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_17); Py_XDECREF(__pyx_t_18); Py_XDECREF(__pyx_t_19);
        __Pyx_RaiseBufferFallbackError();
      } else {
        PyErr_Restore(__pyx_t_17, __pyx_t_18, __pyx_t_19);
      }
    }
    __pyx_pybuffernd_std2d.diminfo[0].strides = __pyx_pybuffernd_std2d.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_std2d.diminfo[0].shape = __pyx_pybuffernd_std2d.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_std2d.diminfo[1].strides = __pyx_pybuffernd_std2d.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_std2d.diminfo[1].shape = __pyx_pybuffernd_std2d.rcbuffer->pybuffer.shape[1];
    if (unlikely(__pyx_t_16 < 0)) __PYX_ERR(0, 639, __pyx_L1_error)
  }
  __pyx_t_14 = 0;
  __Pyx_DECREF_SET(__pyx_v_std2d, ((PyArrayObject *)__pyx_t_5));
  __pyx_t_5 = 0;

  /* "orb/cutils.pyx":643
 *     ## Rejection
 *     # sigclip or avsigclip
 *     if reject_mode == 0 or reject_mode == 1 :             # <<<<<<<<<<<<<<
 *         while not stop_rejection:
 *             if reject_mode == 0:
 */
  switch (__pyx_v_reject_mode) {
    case 0:
    case 1:

    /* "orb/cutils.pyx":644
 *     # sigclip or avsigclip
 *     if reject_mode == 0 or reject_mode == 1 :
 *         while not stop_rejection:             # <<<<<<<<<<<<<<
 *             if reject_mode == 0:
 *                 sqrtmean2d = np.sqrt(np.abs(mean2d))
 */
    while (1) {
      __pyx_t_1 = ((!(__pyx_v_stop_rejection != 0)) != 0);
      if (!__pyx_t_1) break;

      /* "orb/cutils.pyx":645
 *     if reject_mode == 0 or reject_mode == 1 :
 *         while not stop_rejection:
 *             if reject_mode == 0:             # <<<<<<<<<<<<<<
 *                 sqrtmean2d = np.sqrt(np.abs(mean2d))
 *                 sqrtmean2d[np.nonzero(mean2d == 0)] = np.nan
 */
      __pyx_t_1 = ((__pyx_v_reject_mode == 0) != 0);
      if (__pyx_t_1) {

        /* "orb/cutils.pyx":646
 *         while not stop_rejection:
 *             if reject_mode == 0:
 *                 sqrtmean2d = np.sqrt(np.abs(mean2d))             # <<<<<<<<<<<<<<
 *                 sqrtmean2d[np.nonzero(mean2d == 0)] = np.nan
 *                 std2d = (sqrtmean2d.T
 */
        __pyx_t_3 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 646, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_3);
        __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_sqrt); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 646, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_4);
        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
        __pyx_t_6 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 646, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_6);
        __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_6, __pyx_n_s_abs); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 646, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_2);
        __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
        __pyx_t_6 = NULL;
        if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_2))) {
          __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_2);
          if (likely(__pyx_t_6)) {
            PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
            __Pyx_INCREF(__pyx_t_6);
            __Pyx_INCREF(function);
            __Pyx_DECREF_SET(__pyx_t_2, function);
          }
        }
        if (!__pyx_t_6) {
          __pyx_t_3 = __Pyx_PyObject_CallOneArg(__pyx_t_2, ((PyObject *)__pyx_v_mean2d)); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 646, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_3);
        } else {
          __pyx_t_20 = PyTuple_New(1+1); if (unlikely(!__pyx_t_20)) __PYX_ERR(0, 646, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_20);
          __Pyx_GIVEREF(__pyx_t_6); PyTuple_SET_ITEM(__pyx_t_20, 0, __pyx_t_6); __pyx_t_6 = NULL;
          __Pyx_INCREF(((PyObject *)__pyx_v_mean2d));
          __Pyx_GIVEREF(((PyObject *)__pyx_v_mean2d));
          PyTuple_SET_ITEM(__pyx_t_20, 0+1, ((PyObject *)__pyx_v_mean2d));
          __pyx_t_3 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_20, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 646, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_3);
          __Pyx_DECREF(__pyx_t_20); __pyx_t_20 = 0;
        }
        __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
        __pyx_t_2 = NULL;
        if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_4))) {
          __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_4);
          if (likely(__pyx_t_2)) {
            PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
            __Pyx_INCREF(__pyx_t_2);
            __Pyx_INCREF(function);
            __Pyx_DECREF_SET(__pyx_t_4, function);
          }
        }
        if (!__pyx_t_2) {
          __pyx_t_5 = __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_3); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 646, __pyx_L1_error)
          __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
          __Pyx_GOTREF(__pyx_t_5);
        } else {
          __pyx_t_20 = PyTuple_New(1+1); if (unlikely(!__pyx_t_20)) __PYX_ERR(0, 646, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_20);
          __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_20, 0, __pyx_t_2); __pyx_t_2 = NULL;
          __Pyx_GIVEREF(__pyx_t_3);
          PyTuple_SET_ITEM(__pyx_t_20, 0+1, __pyx_t_3);
          __pyx_t_3 = 0;
          __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_20, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 646, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_5);
          __Pyx_DECREF(__pyx_t_20); __pyx_t_20 = 0;
        }
        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
        if (!(likely(((__pyx_t_5) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_5, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 646, __pyx_L1_error)
        __pyx_t_10 = ((PyArrayObject *)__pyx_t_5);
        {
          __Pyx_BufFmt_StackElem __pyx_stack[1];
          __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_sqrtmean2d.rcbuffer->pybuffer);
          __pyx_t_16 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_sqrtmean2d.rcbuffer->pybuffer, (PyObject*)__pyx_t_10, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
          if (unlikely(__pyx_t_16 < 0)) {
            PyErr_Fetch(&__pyx_t_19, &__pyx_t_18, &__pyx_t_17);
            if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_sqrtmean2d.rcbuffer->pybuffer, (PyObject*)__pyx_v_sqrtmean2d, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
              Py_XDECREF(__pyx_t_19); Py_XDECREF(__pyx_t_18); Py_XDECREF(__pyx_t_17);
              __Pyx_RaiseBufferFallbackError();
            } else {
              PyErr_Restore(__pyx_t_19, __pyx_t_18, __pyx_t_17);
            }
          }
          __pyx_pybuffernd_sqrtmean2d.diminfo[0].strides = __pyx_pybuffernd_sqrtmean2d.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_sqrtmean2d.diminfo[0].shape = __pyx_pybuffernd_sqrtmean2d.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_sqrtmean2d.diminfo[1].strides = __pyx_pybuffernd_sqrtmean2d.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_sqrtmean2d.diminfo[1].shape = __pyx_pybuffernd_sqrtmean2d.rcbuffer->pybuffer.shape[1];
          if (unlikely(__pyx_t_16 < 0)) __PYX_ERR(0, 646, __pyx_L1_error)
        }
        __pyx_t_10 = 0;
        __Pyx_DECREF_SET(__pyx_v_sqrtmean2d, ((PyArrayObject *)__pyx_t_5));
        __pyx_t_5 = 0;

        /* "orb/cutils.pyx":647
 *             if reject_mode == 0:
 *                 sqrtmean2d = np.sqrt(np.abs(mean2d))
 *                 sqrtmean2d[np.nonzero(mean2d == 0)] = np.nan             # <<<<<<<<<<<<<<
 *                 std2d = (sqrtmean2d.T
 *                          * bn.nanmean(std2d / sqrtmean2d, axis=1)).T
 */
        __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 647, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_5);
        __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_nan); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 647, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_4);
        __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
        __pyx_t_20 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_20)) __PYX_ERR(0, 647, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_20);
        __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_20, __pyx_n_s_nonzero); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 647, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_3);
        __Pyx_DECREF(__pyx_t_20); __pyx_t_20 = 0;
        __pyx_t_20 = PyObject_RichCompare(((PyObject *)__pyx_v_mean2d), __pyx_int_0, Py_EQ); __Pyx_XGOTREF(__pyx_t_20); if (unlikely(!__pyx_t_20)) __PYX_ERR(0, 647, __pyx_L1_error)
        __pyx_t_2 = NULL;
        if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_3))) {
          __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_3);
          if (likely(__pyx_t_2)) {
            PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
            __Pyx_INCREF(__pyx_t_2);
            __Pyx_INCREF(function);
            __Pyx_DECREF_SET(__pyx_t_3, function);
          }
        }
        if (!__pyx_t_2) {
          __pyx_t_5 = __Pyx_PyObject_CallOneArg(__pyx_t_3, __pyx_t_20); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 647, __pyx_L1_error)
          __Pyx_DECREF(__pyx_t_20); __pyx_t_20 = 0;
          __Pyx_GOTREF(__pyx_t_5);
        } else {
          __pyx_t_6 = PyTuple_New(1+1); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 647, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_6);
          __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_2); __pyx_t_2 = NULL;
          __Pyx_GIVEREF(__pyx_t_20);
          PyTuple_SET_ITEM(__pyx_t_6, 0+1, __pyx_t_20);
          __pyx_t_20 = 0;
          __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_6, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 647, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_5);
          __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
        }
        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
        if (unlikely(PyObject_SetItem(((PyObject *)__pyx_v_sqrtmean2d), __pyx_t_5, __pyx_t_4) < 0)) __PYX_ERR(0, 647, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;

        /* "orb/cutils.pyx":648
 *                 sqrtmean2d = np.sqrt(np.abs(mean2d))
 *                 sqrtmean2d[np.nonzero(mean2d == 0)] = np.nan
 *                 std2d = (sqrtmean2d.T             # <<<<<<<<<<<<<<
 *                          * bn.nanmean(std2d / sqrtmean2d, axis=1)).T
 * 
 */
        __pyx_t_4 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_sqrtmean2d), __pyx_n_s_T); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 648, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_4);

        /* "orb/cutils.pyx":649
 *                 sqrtmean2d[np.nonzero(mean2d == 0)] = np.nan
 *                 std2d = (sqrtmean2d.T
 *                          * bn.nanmean(std2d / sqrtmean2d, axis=1)).T             # <<<<<<<<<<<<<<
 * 
 *             framesdiff = np.abs((frames.T - mean2d.T).T)
 */
        __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 649, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_5);
        __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_nanmean); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 649, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_3);
        __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
        __pyx_t_5 = __Pyx_PyNumber_Divide(((PyObject *)__pyx_v_std2d), ((PyObject *)__pyx_v_sqrtmean2d)); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 649, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_5);
        __pyx_t_6 = PyTuple_New(1); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 649, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_6);
        __Pyx_GIVEREF(__pyx_t_5);
        PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_5);
        __pyx_t_5 = 0;
        __pyx_t_5 = PyDict_New(); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 649, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_5);
        if (PyDict_SetItem(__pyx_t_5, __pyx_n_s_axis, __pyx_int_1) < 0) __PYX_ERR(0, 649, __pyx_L1_error)
        __pyx_t_20 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_6, __pyx_t_5); if (unlikely(!__pyx_t_20)) __PYX_ERR(0, 649, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_20);
        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
        __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
        __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
        __pyx_t_5 = PyNumber_Multiply(__pyx_t_4, __pyx_t_20); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 649, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_5);
        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
        __Pyx_DECREF(__pyx_t_20); __pyx_t_20 = 0;
        __pyx_t_20 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_T); if (unlikely(!__pyx_t_20)) __PYX_ERR(0, 649, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_20);
        __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
        if (!(likely(((__pyx_t_20) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_20, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 649, __pyx_L1_error)
        __pyx_t_14 = ((PyArrayObject *)__pyx_t_20);
        {
          __Pyx_BufFmt_StackElem __pyx_stack[1];
          __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_std2d.rcbuffer->pybuffer);
          __pyx_t_16 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_std2d.rcbuffer->pybuffer, (PyObject*)__pyx_t_14, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
          if (unlikely(__pyx_t_16 < 0)) {
            PyErr_Fetch(&__pyx_t_17, &__pyx_t_18, &__pyx_t_19);
            if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_std2d.rcbuffer->pybuffer, (PyObject*)__pyx_v_std2d, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
              Py_XDECREF(__pyx_t_17); Py_XDECREF(__pyx_t_18); Py_XDECREF(__pyx_t_19);
              __Pyx_RaiseBufferFallbackError();
            } else {
              PyErr_Restore(__pyx_t_17, __pyx_t_18, __pyx_t_19);
            }
          }
          __pyx_pybuffernd_std2d.diminfo[0].strides = __pyx_pybuffernd_std2d.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_std2d.diminfo[0].shape = __pyx_pybuffernd_std2d.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_std2d.diminfo[1].strides = __pyx_pybuffernd_std2d.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_std2d.diminfo[1].shape = __pyx_pybuffernd_std2d.rcbuffer->pybuffer.shape[1];
          if (unlikely(__pyx_t_16 < 0)) __PYX_ERR(0, 648, __pyx_L1_error)
        }
        __pyx_t_14 = 0;
        __Pyx_DECREF_SET(__pyx_v_std2d, ((PyArrayObject *)__pyx_t_20));
        __pyx_t_20 = 0;

        /* "orb/cutils.pyx":645
 *     if reject_mode == 0 or reject_mode == 1 :
 *         while not stop_rejection:
 *             if reject_mode == 0:             # <<<<<<<<<<<<<<
 *                 sqrtmean2d = np.sqrt(np.abs(mean2d))
 *                 sqrtmean2d[np.nonzero(mean2d == 0)] = np.nan
 */
      }

      /* "orb/cutils.pyx":651
 *                          * bn.nanmean(std2d / sqrtmean2d, axis=1)).T
 * 
 *             framesdiff = np.abs((frames.T - mean2d.T).T)             # <<<<<<<<<<<<<<
 *             max2d = bn.nanmax(framesdiff, axis=2)
 * 
 */
      __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 651, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_abs); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 651, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
      __pyx_t_5 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_frames), __pyx_n_s_T); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 651, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __pyx_t_6 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_mean2d), __pyx_n_s_T); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 651, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_6);
      __pyx_t_3 = PyNumber_Subtract(__pyx_t_5, __pyx_t_6); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 651, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
      __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
      __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_T); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 651, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_6);
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      __pyx_t_3 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_4))) {
        __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_4);
        if (likely(__pyx_t_3)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
          __Pyx_INCREF(__pyx_t_3);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_4, function);
        }
      }
      if (!__pyx_t_3) {
        __pyx_t_20 = __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_6); if (unlikely(!__pyx_t_20)) __PYX_ERR(0, 651, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
        __Pyx_GOTREF(__pyx_t_20);
      } else {
        __pyx_t_5 = PyTuple_New(1+1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 651, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_5);
        __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_3); __pyx_t_3 = NULL;
        __Pyx_GIVEREF(__pyx_t_6);
        PyTuple_SET_ITEM(__pyx_t_5, 0+1, __pyx_t_6);
        __pyx_t_6 = 0;
        __pyx_t_20 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_5, NULL); if (unlikely(!__pyx_t_20)) __PYX_ERR(0, 651, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_20);
        __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
      }
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      if (!(likely(((__pyx_t_20) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_20, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 651, __pyx_L1_error)
      __pyx_t_7 = ((PyArrayObject *)__pyx_t_20);
      {
        __Pyx_BufFmt_StackElem __pyx_stack[1];
        __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_framesdiff.rcbuffer->pybuffer);
        __pyx_t_16 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_framesdiff.rcbuffer->pybuffer, (PyObject*)__pyx_t_7, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 3, 0, __pyx_stack);
        if (unlikely(__pyx_t_16 < 0)) {
          PyErr_Fetch(&__pyx_t_19, &__pyx_t_18, &__pyx_t_17);
          if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_framesdiff.rcbuffer->pybuffer, (PyObject*)__pyx_v_framesdiff, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 3, 0, __pyx_stack) == -1)) {
            Py_XDECREF(__pyx_t_19); Py_XDECREF(__pyx_t_18); Py_XDECREF(__pyx_t_17);
            __Pyx_RaiseBufferFallbackError();
          } else {
            PyErr_Restore(__pyx_t_19, __pyx_t_18, __pyx_t_17);
          }
        }
        __pyx_pybuffernd_framesdiff.diminfo[0].strides = __pyx_pybuffernd_framesdiff.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_framesdiff.diminfo[0].shape = __pyx_pybuffernd_framesdiff.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_framesdiff.diminfo[1].strides = __pyx_pybuffernd_framesdiff.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_framesdiff.diminfo[1].shape = __pyx_pybuffernd_framesdiff.rcbuffer->pybuffer.shape[1]; __pyx_pybuffernd_framesdiff.diminfo[2].strides = __pyx_pybuffernd_framesdiff.rcbuffer->pybuffer.strides[2]; __pyx_pybuffernd_framesdiff.diminfo[2].shape = __pyx_pybuffernd_framesdiff.rcbuffer->pybuffer.shape[2];
        if (unlikely(__pyx_t_16 < 0)) __PYX_ERR(0, 651, __pyx_L1_error)
      }
      __pyx_t_7 = 0;
      __Pyx_DECREF_SET(__pyx_v_framesdiff, ((PyArrayObject *)__pyx_t_20));
      __pyx_t_20 = 0;

      /* "orb/cutils.pyx":652
 * 
 *             framesdiff = np.abs((frames.T - mean2d.T).T)
 *             max2d = bn.nanmax(framesdiff, axis=2)             # <<<<<<<<<<<<<<
 * 
 *             # remove all-NaN slices
 */
      __pyx_t_20 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_20)) __PYX_ERR(0, 652, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_20);
      __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_20, __pyx_n_s_nanmax); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 652, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __Pyx_DECREF(__pyx_t_20); __pyx_t_20 = 0;
      __pyx_t_20 = PyTuple_New(1); if (unlikely(!__pyx_t_20)) __PYX_ERR(0, 652, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_20);
      __Pyx_INCREF(((PyObject *)__pyx_v_framesdiff));
      __Pyx_GIVEREF(((PyObject *)__pyx_v_framesdiff));
      PyTuple_SET_ITEM(__pyx_t_20, 0, ((PyObject *)__pyx_v_framesdiff));
      __pyx_t_5 = PyDict_New(); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 652, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      if (PyDict_SetItem(__pyx_t_5, __pyx_n_s_axis, __pyx_int_2) < 0) __PYX_ERR(0, 652, __pyx_L1_error)
      __pyx_t_6 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_20, __pyx_t_5); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 652, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_6);
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __Pyx_DECREF(__pyx_t_20); __pyx_t_20 = 0;
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
      if (!(likely(((__pyx_t_6) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_6, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 652, __pyx_L1_error)
      __pyx_t_9 = ((PyArrayObject *)__pyx_t_6);
      {
        __Pyx_BufFmt_StackElem __pyx_stack[1];
        __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_max2d.rcbuffer->pybuffer);
        __pyx_t_16 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_max2d.rcbuffer->pybuffer, (PyObject*)__pyx_t_9, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
        if (unlikely(__pyx_t_16 < 0)) {
          PyErr_Fetch(&__pyx_t_17, &__pyx_t_18, &__pyx_t_19);
          if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_max2d.rcbuffer->pybuffer, (PyObject*)__pyx_v_max2d, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
            Py_XDECREF(__pyx_t_17); Py_XDECREF(__pyx_t_18); Py_XDECREF(__pyx_t_19);
            __Pyx_RaiseBufferFallbackError();
          } else {
            PyErr_Restore(__pyx_t_17, __pyx_t_18, __pyx_t_19);
          }
        }
        __pyx_pybuffernd_max2d.diminfo[0].strides = __pyx_pybuffernd_max2d.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_max2d.diminfo[0].shape = __pyx_pybuffernd_max2d.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_max2d.diminfo[1].strides = __pyx_pybuffernd_max2d.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_max2d.diminfo[1].shape = __pyx_pybuffernd_max2d.rcbuffer->pybuffer.shape[1];
        if (unlikely(__pyx_t_16 < 0)) __PYX_ERR(0, 652, __pyx_L1_error)
      }
      __pyx_t_9 = 0;
      __Pyx_DECREF_SET(__pyx_v_max2d, ((PyArrayObject *)__pyx_t_6));
      __pyx_t_6 = 0;

      /* "orb/cutils.pyx":655
 * 
 *             # remove all-NaN slices
 *             nans = np.nonzero(np.isnan(max2d))             # <<<<<<<<<<<<<<
 *             # NaNs in framesdiff are set to 0 to avoid a ValueError
 *             framesdiff[nans] = 0.
 */
      __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 655, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __pyx_t_20 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_nonzero); if (unlikely(!__pyx_t_20)) __PYX_ERR(0, 655, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_20);
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
      __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 655, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_isnan); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 655, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __pyx_t_4 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_3))) {
        __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_3);
        if (likely(__pyx_t_4)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
          __Pyx_INCREF(__pyx_t_4);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_3, function);
        }
      }
      if (!__pyx_t_4) {
        __pyx_t_5 = __Pyx_PyObject_CallOneArg(__pyx_t_3, ((PyObject *)__pyx_v_max2d)); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 655, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_5);
      } else {
        __pyx_t_2 = PyTuple_New(1+1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 655, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_2);
        __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_4); __pyx_t_4 = NULL;
        __Pyx_INCREF(((PyObject *)__pyx_v_max2d));
        __Pyx_GIVEREF(((PyObject *)__pyx_v_max2d));
        PyTuple_SET_ITEM(__pyx_t_2, 0+1, ((PyObject *)__pyx_v_max2d));
        __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_2, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 655, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_5);
        __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
      }
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      __pyx_t_3 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_20))) {
        __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_20);
        if (likely(__pyx_t_3)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_20);
          __Pyx_INCREF(__pyx_t_3);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_20, function);
        }
      }
      if (!__pyx_t_3) {
        __pyx_t_6 = __Pyx_PyObject_CallOneArg(__pyx_t_20, __pyx_t_5); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 655, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
        __Pyx_GOTREF(__pyx_t_6);
      } else {
        __pyx_t_2 = PyTuple_New(1+1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 655, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_2);
        __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_3); __pyx_t_3 = NULL;
        __Pyx_GIVEREF(__pyx_t_5);
        PyTuple_SET_ITEM(__pyx_t_2, 0+1, __pyx_t_5);
        __pyx_t_5 = 0;
        __pyx_t_6 = __Pyx_PyObject_Call(__pyx_t_20, __pyx_t_2, NULL); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 655, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_6);
        __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
      }
      __Pyx_DECREF(__pyx_t_20); __pyx_t_20 = 0;
      __Pyx_XDECREF_SET(__pyx_v_nans, __pyx_t_6);
      __pyx_t_6 = 0;

      /* "orb/cutils.pyx":657
 *             nans = np.nonzero(np.isnan(max2d))
 *             # NaNs in framesdiff are set to 0 to avoid a ValueError
 *             framesdiff[nans] = 0.             # <<<<<<<<<<<<<<
 *             # All Nan slices are set to a value which will always reject them
 *             max2d[nans] = std2d[nans] * sigma * 2
 */
      if (unlikely(PyObject_SetItem(((PyObject *)__pyx_v_framesdiff), __pyx_v_nans, __pyx_float_0_) < 0)) __PYX_ERR(0, 657, __pyx_L1_error)

      /* "orb/cutils.pyx":659
 *             framesdiff[nans] = 0.
 *             # All Nan slices are set to a value which will always reject them
 *             max2d[nans] = std2d[nans] * sigma * 2             # <<<<<<<<<<<<<<
 * 
 *             argmax2d = bn.nanargmax(framesdiff, axis=2)
 */
      __pyx_t_6 = PyObject_GetItem(((PyObject *)__pyx_v_std2d), __pyx_v_nans); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 659, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_6);
      __pyx_t_20 = PyFloat_FromDouble(__pyx_v_sigma); if (unlikely(!__pyx_t_20)) __PYX_ERR(0, 659, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_20);
      __pyx_t_2 = PyNumber_Multiply(__pyx_t_6, __pyx_t_20); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 659, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
      __Pyx_DECREF(__pyx_t_20); __pyx_t_20 = 0;
      __pyx_t_20 = PyNumber_Multiply(__pyx_t_2, __pyx_int_2); if (unlikely(!__pyx_t_20)) __PYX_ERR(0, 659, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_20);
      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
      if (unlikely(PyObject_SetItem(((PyObject *)__pyx_v_max2d), __pyx_v_nans, __pyx_t_20) < 0)) __PYX_ERR(0, 659, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_20); __pyx_t_20 = 0;

      /* "orb/cutils.pyx":661
 *             max2d[nans] = std2d[nans] * sigma * 2
 * 
 *             argmax2d = bn.nanargmax(framesdiff, axis=2)             # <<<<<<<<<<<<<<
 *             mask2d = np.nonzero(np.logical_and(max2d > std2d * sigma,
 *                                                rejects2d < dimz - nkeep))
 */
      __pyx_t_20 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_20)) __PYX_ERR(0, 661, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_20);
      __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_20, __pyx_n_s_nanargmax); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 661, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __Pyx_DECREF(__pyx_t_20); __pyx_t_20 = 0;
      __pyx_t_20 = PyTuple_New(1); if (unlikely(!__pyx_t_20)) __PYX_ERR(0, 661, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_20);
      __Pyx_INCREF(((PyObject *)__pyx_v_framesdiff));
      __Pyx_GIVEREF(((PyObject *)__pyx_v_framesdiff));
      PyTuple_SET_ITEM(__pyx_t_20, 0, ((PyObject *)__pyx_v_framesdiff));
      __pyx_t_6 = PyDict_New(); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 661, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_6);
      if (PyDict_SetItem(__pyx_t_6, __pyx_n_s_axis, __pyx_int_2) < 0) __PYX_ERR(0, 661, __pyx_L1_error)
      __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_20, __pyx_t_6); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 661, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
      __Pyx_DECREF(__pyx_t_20); __pyx_t_20 = 0;
      __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
      if (!(likely(((__pyx_t_5) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_5, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 661, __pyx_L1_error)
      __pyx_t_8 = ((PyArrayObject *)__pyx_t_5);
      {
        __Pyx_BufFmt_StackElem __pyx_stack[1];
        __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_argmax2d.rcbuffer->pybuffer);
        __pyx_t_16 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_argmax2d.rcbuffer->pybuffer, (PyObject*)__pyx_t_8, &__Pyx_TypeInfo_nn___pyx_t_5numpy_int64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
        if (unlikely(__pyx_t_16 < 0)) {
          PyErr_Fetch(&__pyx_t_19, &__pyx_t_18, &__pyx_t_17);
          if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_argmax2d.rcbuffer->pybuffer, (PyObject*)__pyx_v_argmax2d, &__Pyx_TypeInfo_nn___pyx_t_5numpy_int64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
            Py_XDECREF(__pyx_t_19); Py_XDECREF(__pyx_t_18); Py_XDECREF(__pyx_t_17);
            __Pyx_RaiseBufferFallbackError();
          } else {
            PyErr_Restore(__pyx_t_19, __pyx_t_18, __pyx_t_17);
          }
        }
        __pyx_pybuffernd_argmax2d.diminfo[0].strides = __pyx_pybuffernd_argmax2d.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_argmax2d.diminfo[0].shape = __pyx_pybuffernd_argmax2d.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_argmax2d.diminfo[1].strides = __pyx_pybuffernd_argmax2d.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_argmax2d.diminfo[1].shape = __pyx_pybuffernd_argmax2d.rcbuffer->pybuffer.shape[1];
        if (unlikely(__pyx_t_16 < 0)) __PYX_ERR(0, 661, __pyx_L1_error)
      }
      __pyx_t_8 = 0;
      __Pyx_DECREF_SET(__pyx_v_argmax2d, ((PyArrayObject *)__pyx_t_5));
      __pyx_t_5 = 0;

      /* "orb/cutils.pyx":662
 * 
 *             argmax2d = bn.nanargmax(framesdiff, axis=2)
 *             mask2d = np.nonzero(np.logical_and(max2d > std2d * sigma,             # <<<<<<<<<<<<<<
 *                                                rejects2d < dimz - nkeep))
 *             rejpix = (mask2d[0], mask2d[1], argmax2d[mask2d])
 */
      __pyx_t_6 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 662, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_6);
      __pyx_t_20 = __Pyx_PyObject_GetAttrStr(__pyx_t_6, __pyx_n_s_nonzero); if (unlikely(!__pyx_t_20)) __PYX_ERR(0, 662, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_20);
      __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
      __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 662, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_logical_and); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 662, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
      __pyx_t_2 = PyFloat_FromDouble(__pyx_v_sigma); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 662, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __pyx_t_4 = PyNumber_Multiply(((PyObject *)__pyx_v_std2d), __pyx_t_2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 662, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
      __pyx_t_2 = PyObject_RichCompare(((PyObject *)__pyx_v_max2d), __pyx_t_4, Py_GT); __Pyx_XGOTREF(__pyx_t_2); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 662, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;

      /* "orb/cutils.pyx":663
 *             argmax2d = bn.nanargmax(framesdiff, axis=2)
 *             mask2d = np.nonzero(np.logical_and(max2d > std2d * sigma,
 *                                                rejects2d < dimz - nkeep))             # <<<<<<<<<<<<<<
 *             rejpix = (mask2d[0], mask2d[1], argmax2d[mask2d])
 *             frames[rejpix] = np.nan
 */
      __pyx_t_4 = __Pyx_PyInt_From_int((__pyx_v_dimz - __pyx_v_nkeep)); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 663, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __pyx_t_21 = PyObject_RichCompare(((PyObject *)__pyx_v_rejects2d), __pyx_t_4, Py_LT); __Pyx_XGOTREF(__pyx_t_21); if (unlikely(!__pyx_t_21)) __PYX_ERR(0, 663, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __pyx_t_4 = NULL;
      __pyx_t_22 = 0;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_3))) {
        __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_3);
        if (likely(__pyx_t_4)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
          __Pyx_INCREF(__pyx_t_4);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_3, function);
          __pyx_t_22 = 1;
        }
      }
      __pyx_t_23 = PyTuple_New(2+__pyx_t_22); if (unlikely(!__pyx_t_23)) __PYX_ERR(0, 662, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_23);
      if (__pyx_t_4) {
        __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_23, 0, __pyx_t_4); __pyx_t_4 = NULL;
      }
      __Pyx_GIVEREF(__pyx_t_2);
      PyTuple_SET_ITEM(__pyx_t_23, 0+__pyx_t_22, __pyx_t_2);
      __Pyx_GIVEREF(__pyx_t_21);
      PyTuple_SET_ITEM(__pyx_t_23, 1+__pyx_t_22, __pyx_t_21);
      __pyx_t_2 = 0;
      __pyx_t_21 = 0;
      __pyx_t_6 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_23, NULL); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 662, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_6);
      __Pyx_DECREF(__pyx_t_23); __pyx_t_23 = 0;
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      __pyx_t_3 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_20))) {
        __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_20);
        if (likely(__pyx_t_3)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_20);
          __Pyx_INCREF(__pyx_t_3);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_20, function);
        }
      }
      if (!__pyx_t_3) {
        __pyx_t_5 = __Pyx_PyObject_CallOneArg(__pyx_t_20, __pyx_t_6); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 662, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
        __Pyx_GOTREF(__pyx_t_5);
      } else {
        __pyx_t_23 = PyTuple_New(1+1); if (unlikely(!__pyx_t_23)) __PYX_ERR(0, 662, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_23);
        __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_23, 0, __pyx_t_3); __pyx_t_3 = NULL;
        __Pyx_GIVEREF(__pyx_t_6);
        PyTuple_SET_ITEM(__pyx_t_23, 0+1, __pyx_t_6);
        __pyx_t_6 = 0;
        __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_20, __pyx_t_23, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 662, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_5);
        __Pyx_DECREF(__pyx_t_23); __pyx_t_23 = 0;
      }
      __Pyx_DECREF(__pyx_t_20); __pyx_t_20 = 0;
      __Pyx_XDECREF_SET(__pyx_v_mask2d, __pyx_t_5);
      __pyx_t_5 = 0;

      /* "orb/cutils.pyx":664
 *             mask2d = np.nonzero(np.logical_and(max2d > std2d * sigma,
 *                                                rejects2d < dimz - nkeep))
 *             rejpix = (mask2d[0], mask2d[1], argmax2d[mask2d])             # <<<<<<<<<<<<<<
 *             frames[rejpix] = np.nan
 * 
 */
      __pyx_t_5 = __Pyx_GetItemInt(__pyx_v_mask2d, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 664, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __pyx_t_20 = __Pyx_GetItemInt(__pyx_v_mask2d, 1, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_20)) __PYX_ERR(0, 664, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_20);
      __pyx_t_23 = PyObject_GetItem(((PyObject *)__pyx_v_argmax2d), __pyx_v_mask2d); if (unlikely(!__pyx_t_23)) __PYX_ERR(0, 664, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_23);
      __pyx_t_6 = PyTuple_New(3); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 664, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_6);
      __Pyx_GIVEREF(__pyx_t_5);
      PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_5);
      __Pyx_GIVEREF(__pyx_t_20);
      PyTuple_SET_ITEM(__pyx_t_6, 1, __pyx_t_20);
      __Pyx_GIVEREF(__pyx_t_23);
      PyTuple_SET_ITEM(__pyx_t_6, 2, __pyx_t_23);
      __pyx_t_5 = 0;
      __pyx_t_20 = 0;
      __pyx_t_23 = 0;
      __Pyx_XDECREF_SET(__pyx_v_rejpix, ((PyObject*)__pyx_t_6));
      __pyx_t_6 = 0;

      /* "orb/cutils.pyx":665
 *                                                rejects2d < dimz - nkeep))
 *             rejpix = (mask2d[0], mask2d[1], argmax2d[mask2d])
 *             frames[rejpix] = np.nan             # <<<<<<<<<<<<<<
 * 
 *             new_rejects2d[mask2d] += 1
 */
      __pyx_t_6 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 665, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_6);
      __pyx_t_23 = __Pyx_PyObject_GetAttrStr(__pyx_t_6, __pyx_n_s_nan); if (unlikely(!__pyx_t_23)) __PYX_ERR(0, 665, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_23);
      __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
      if (unlikely(PyObject_SetItem(((PyObject *)__pyx_v_frames), __pyx_v_rejpix, __pyx_t_23) < 0)) __PYX_ERR(0, 665, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_23); __pyx_t_23 = 0;

      /* "orb/cutils.pyx":667
 *             frames[rejpix] = np.nan
 * 
 *             new_rejects2d[mask2d] += 1             # <<<<<<<<<<<<<<
 * 
 *             if np.all(new_rejects2d == rejects2d):
 */
      __Pyx_INCREF(__pyx_v_mask2d);
      __pyx_t_23 = __pyx_v_mask2d;
      __pyx_t_6 = PyObject_GetItem(((PyObject *)__pyx_v_new_rejects2d), __pyx_t_23); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 667, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_6);
      __pyx_t_20 = __Pyx_PyInt_AddObjC(__pyx_t_6, __pyx_int_1, 1, 1); if (unlikely(!__pyx_t_20)) __PYX_ERR(0, 667, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_20);
      __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
      if (unlikely(PyObject_SetItem(((PyObject *)__pyx_v_new_rejects2d), __pyx_t_23, __pyx_t_20) < 0)) __PYX_ERR(0, 667, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_20); __pyx_t_20 = 0;
      __Pyx_DECREF(__pyx_t_23); __pyx_t_23 = 0;

      /* "orb/cutils.pyx":669
 *             new_rejects2d[mask2d] += 1
 * 
 *             if np.all(new_rejects2d == rejects2d):             # <<<<<<<<<<<<<<
 *                 stop_rejection = 1
 * 
 */
      __pyx_t_20 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_20)) __PYX_ERR(0, 669, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_20);
      __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_t_20, __pyx_n_s_all); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 669, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_6);
      __Pyx_DECREF(__pyx_t_20); __pyx_t_20 = 0;
      __pyx_t_20 = PyObject_RichCompare(((PyObject *)__pyx_v_new_rejects2d), ((PyObject *)__pyx_v_rejects2d), Py_EQ); __Pyx_XGOTREF(__pyx_t_20); if (unlikely(!__pyx_t_20)) __PYX_ERR(0, 669, __pyx_L1_error)
      __pyx_t_5 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_6))) {
        __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_6);
        if (likely(__pyx_t_5)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_6);
          __Pyx_INCREF(__pyx_t_5);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_6, function);
        }
      }
      if (!__pyx_t_5) {
        __pyx_t_23 = __Pyx_PyObject_CallOneArg(__pyx_t_6, __pyx_t_20); if (unlikely(!__pyx_t_23)) __PYX_ERR(0, 669, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_20); __pyx_t_20 = 0;
        __Pyx_GOTREF(__pyx_t_23);
      } else {
        __pyx_t_3 = PyTuple_New(1+1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 669, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_3);
        __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_5); __pyx_t_5 = NULL;
        __Pyx_GIVEREF(__pyx_t_20);
        PyTuple_SET_ITEM(__pyx_t_3, 0+1, __pyx_t_20);
        __pyx_t_20 = 0;
        __pyx_t_23 = __Pyx_PyObject_Call(__pyx_t_6, __pyx_t_3, NULL); if (unlikely(!__pyx_t_23)) __PYX_ERR(0, 669, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_23);
        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      }
      __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
      __pyx_t_1 = __Pyx_PyObject_IsTrue(__pyx_t_23); if (unlikely(__pyx_t_1 < 0)) __PYX_ERR(0, 669, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_23); __pyx_t_23 = 0;
      if (__pyx_t_1) {

        /* "orb/cutils.pyx":670
 * 
 *             if np.all(new_rejects2d == rejects2d):
 *                 stop_rejection = 1             # <<<<<<<<<<<<<<
 * 
 *             rejects2d = np.copy(new_rejects2d)
 */
        __pyx_v_stop_rejection = 1;

        /* "orb/cutils.pyx":669
 *             new_rejects2d[mask2d] += 1
 * 
 *             if np.all(new_rejects2d == rejects2d):             # <<<<<<<<<<<<<<
 *                 stop_rejection = 1
 * 
 */
      }

      /* "orb/cutils.pyx":672
 *                 stop_rejection = 1
 * 
 *             rejects2d = np.copy(new_rejects2d)             # <<<<<<<<<<<<<<
 *             mean2d = bn.nanmean(frames, axis=2)
 *             std2d = bn.nanstd(frames, axis=2)
 */
      __pyx_t_6 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 672, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_6);
      __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_6, __pyx_n_s_copy); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 672, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
      __pyx_t_6 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_3))) {
        __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_3);
        if (likely(__pyx_t_6)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
          __Pyx_INCREF(__pyx_t_6);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_3, function);
        }
      }
      if (!__pyx_t_6) {
        __pyx_t_23 = __Pyx_PyObject_CallOneArg(__pyx_t_3, ((PyObject *)__pyx_v_new_rejects2d)); if (unlikely(!__pyx_t_23)) __PYX_ERR(0, 672, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_23);
      } else {
        __pyx_t_20 = PyTuple_New(1+1); if (unlikely(!__pyx_t_20)) __PYX_ERR(0, 672, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_20);
        __Pyx_GIVEREF(__pyx_t_6); PyTuple_SET_ITEM(__pyx_t_20, 0, __pyx_t_6); __pyx_t_6 = NULL;
        __Pyx_INCREF(((PyObject *)__pyx_v_new_rejects2d));
        __Pyx_GIVEREF(((PyObject *)__pyx_v_new_rejects2d));
        PyTuple_SET_ITEM(__pyx_t_20, 0+1, ((PyObject *)__pyx_v_new_rejects2d));
        __pyx_t_23 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_20, NULL); if (unlikely(!__pyx_t_23)) __PYX_ERR(0, 672, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_23);
        __Pyx_DECREF(__pyx_t_20); __pyx_t_20 = 0;
      }
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      if (!(likely(((__pyx_t_23) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_23, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 672, __pyx_L1_error)
      __pyx_t_11 = ((PyArrayObject *)__pyx_t_23);
      {
        __Pyx_BufFmt_StackElem __pyx_stack[1];
        __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_rejects2d.rcbuffer->pybuffer);
        __pyx_t_16 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_rejects2d.rcbuffer->pybuffer, (PyObject*)__pyx_t_11, &__Pyx_TypeInfo_nn___pyx_t_5numpy_uint8_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
        if (unlikely(__pyx_t_16 < 0)) {
          PyErr_Fetch(&__pyx_t_17, &__pyx_t_18, &__pyx_t_19);
          if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_rejects2d.rcbuffer->pybuffer, (PyObject*)__pyx_v_rejects2d, &__Pyx_TypeInfo_nn___pyx_t_5numpy_uint8_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
            Py_XDECREF(__pyx_t_17); Py_XDECREF(__pyx_t_18); Py_XDECREF(__pyx_t_19);
            __Pyx_RaiseBufferFallbackError();
          } else {
            PyErr_Restore(__pyx_t_17, __pyx_t_18, __pyx_t_19);
          }
        }
        __pyx_pybuffernd_rejects2d.diminfo[0].strides = __pyx_pybuffernd_rejects2d.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_rejects2d.diminfo[0].shape = __pyx_pybuffernd_rejects2d.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_rejects2d.diminfo[1].strides = __pyx_pybuffernd_rejects2d.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_rejects2d.diminfo[1].shape = __pyx_pybuffernd_rejects2d.rcbuffer->pybuffer.shape[1];
        if (unlikely(__pyx_t_16 < 0)) __PYX_ERR(0, 672, __pyx_L1_error)
      }
      __pyx_t_11 = 0;
      __Pyx_DECREF_SET(__pyx_v_rejects2d, ((PyArrayObject *)__pyx_t_23));
      __pyx_t_23 = 0;

      /* "orb/cutils.pyx":673
 * 
 *             rejects2d = np.copy(new_rejects2d)
 *             mean2d = bn.nanmean(frames, axis=2)             # <<<<<<<<<<<<<<
 *             std2d = bn.nanstd(frames, axis=2)
 * 
 */
      __pyx_t_23 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_23)) __PYX_ERR(0, 673, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_23);
      __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_23, __pyx_n_s_nanmean); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 673, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __Pyx_DECREF(__pyx_t_23); __pyx_t_23 = 0;
      __pyx_t_23 = PyTuple_New(1); if (unlikely(!__pyx_t_23)) __PYX_ERR(0, 673, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_23);
      __Pyx_INCREF(((PyObject *)__pyx_v_frames));
      __Pyx_GIVEREF(((PyObject *)__pyx_v_frames));
      PyTuple_SET_ITEM(__pyx_t_23, 0, ((PyObject *)__pyx_v_frames));
      __pyx_t_20 = PyDict_New(); if (unlikely(!__pyx_t_20)) __PYX_ERR(0, 673, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_20);
      if (PyDict_SetItem(__pyx_t_20, __pyx_n_s_axis, __pyx_int_2) < 0) __PYX_ERR(0, 673, __pyx_L1_error)
      __pyx_t_6 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_23, __pyx_t_20); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 673, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_6);
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      __Pyx_DECREF(__pyx_t_23); __pyx_t_23 = 0;
      __Pyx_DECREF(__pyx_t_20); __pyx_t_20 = 0;
      if (!(likely(((__pyx_t_6) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_6, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 673, __pyx_L1_error)
      __pyx_t_13 = ((PyArrayObject *)__pyx_t_6);
      {
        __Pyx_BufFmt_StackElem __pyx_stack[1];
        __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_mean2d.rcbuffer->pybuffer);
        __pyx_t_16 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_mean2d.rcbuffer->pybuffer, (PyObject*)__pyx_t_13, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
        if (unlikely(__pyx_t_16 < 0)) {
          PyErr_Fetch(&__pyx_t_19, &__pyx_t_18, &__pyx_t_17);
          if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_mean2d.rcbuffer->pybuffer, (PyObject*)__pyx_v_mean2d, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
            Py_XDECREF(__pyx_t_19); Py_XDECREF(__pyx_t_18); Py_XDECREF(__pyx_t_17);
            __Pyx_RaiseBufferFallbackError();
          } else {
            PyErr_Restore(__pyx_t_19, __pyx_t_18, __pyx_t_17);
          }
        }
        __pyx_pybuffernd_mean2d.diminfo[0].strides = __pyx_pybuffernd_mean2d.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_mean2d.diminfo[0].shape = __pyx_pybuffernd_mean2d.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_mean2d.diminfo[1].strides = __pyx_pybuffernd_mean2d.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_mean2d.diminfo[1].shape = __pyx_pybuffernd_mean2d.rcbuffer->pybuffer.shape[1];
        if (unlikely(__pyx_t_16 < 0)) __PYX_ERR(0, 673, __pyx_L1_error)
      }
      __pyx_t_13 = 0;
      __Pyx_DECREF_SET(__pyx_v_mean2d, ((PyArrayObject *)__pyx_t_6));
      __pyx_t_6 = 0;

      /* "orb/cutils.pyx":674
 *             rejects2d = np.copy(new_rejects2d)
 *             mean2d = bn.nanmean(frames, axis=2)
 *             std2d = bn.nanstd(frames, axis=2)             # <<<<<<<<<<<<<<
 * 
 *     # minmax
 */
      __pyx_t_6 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 674, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_6);
      __pyx_t_20 = __Pyx_PyObject_GetAttrStr(__pyx_t_6, __pyx_n_s_nanstd); if (unlikely(!__pyx_t_20)) __PYX_ERR(0, 674, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_20);
      __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
      __pyx_t_6 = PyTuple_New(1); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 674, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_6);
      __Pyx_INCREF(((PyObject *)__pyx_v_frames));
      __Pyx_GIVEREF(((PyObject *)__pyx_v_frames));
      PyTuple_SET_ITEM(__pyx_t_6, 0, ((PyObject *)__pyx_v_frames));
      __pyx_t_23 = PyDict_New(); if (unlikely(!__pyx_t_23)) __PYX_ERR(0, 674, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_23);
      if (PyDict_SetItem(__pyx_t_23, __pyx_n_s_axis, __pyx_int_2) < 0) __PYX_ERR(0, 674, __pyx_L1_error)
      __pyx_t_3 = __Pyx_PyObject_Call(__pyx_t_20, __pyx_t_6, __pyx_t_23); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 674, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __Pyx_DECREF(__pyx_t_20); __pyx_t_20 = 0;
      __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
      __Pyx_DECREF(__pyx_t_23); __pyx_t_23 = 0;
      if (!(likely(((__pyx_t_3) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_3, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 674, __pyx_L1_error)
      __pyx_t_14 = ((PyArrayObject *)__pyx_t_3);
      {
        __Pyx_BufFmt_StackElem __pyx_stack[1];
        __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_std2d.rcbuffer->pybuffer);
        __pyx_t_16 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_std2d.rcbuffer->pybuffer, (PyObject*)__pyx_t_14, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
        if (unlikely(__pyx_t_16 < 0)) {
          PyErr_Fetch(&__pyx_t_17, &__pyx_t_18, &__pyx_t_19);
          if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_std2d.rcbuffer->pybuffer, (PyObject*)__pyx_v_std2d, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
            Py_XDECREF(__pyx_t_17); Py_XDECREF(__pyx_t_18); Py_XDECREF(__pyx_t_19);
            __Pyx_RaiseBufferFallbackError();
          } else {
            PyErr_Restore(__pyx_t_17, __pyx_t_18, __pyx_t_19);
          }
        }
        __pyx_pybuffernd_std2d.diminfo[0].strides = __pyx_pybuffernd_std2d.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_std2d.diminfo[0].shape = __pyx_pybuffernd_std2d.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_std2d.diminfo[1].strides = __pyx_pybuffernd_std2d.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_std2d.diminfo[1].shape = __pyx_pybuffernd_std2d.rcbuffer->pybuffer.shape[1];
        if (unlikely(__pyx_t_16 < 0)) __PYX_ERR(0, 674, __pyx_L1_error)
      }
      __pyx_t_14 = 0;
      __Pyx_DECREF_SET(__pyx_v_std2d, ((PyArrayObject *)__pyx_t_3));
      __pyx_t_3 = 0;
    }

    /* "orb/cutils.pyx":643
 *     ## Rejection
 *     # sigclip or avsigclip
 *     if reject_mode == 0 or reject_mode == 1 :             # <<<<<<<<<<<<<<
 *         while not stop_rejection:
 *             if reject_mode == 0:
 */
    break;

    /* "orb/cutils.pyx":677
 * 
 *     # minmax
 *     elif reject_mode == 2:             # <<<<<<<<<<<<<<
 *         frames = frames[:,:,1:-1]
 *         rejects2d.fill(2)
 */
    case 2:

    /* "orb/cutils.pyx":678
 *     # minmax
 *     elif reject_mode == 2:
 *         frames = frames[:,:,1:-1]             # <<<<<<<<<<<<<<
 *         rejects2d.fill(2)
 *     else: raise Exception('Bad rejection mode. Must be 0, 1 or 2.')
 */
    __pyx_t_3 = PyObject_GetItem(((PyObject *)__pyx_v_frames), __pyx_tuple__41); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 678, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    if (!(likely(((__pyx_t_3) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_3, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 678, __pyx_L1_error)
    __pyx_t_15 = ((PyArrayObject *)__pyx_t_3);
    {
      __Pyx_BufFmt_StackElem __pyx_stack[1];
      __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_frames.rcbuffer->pybuffer);
      __pyx_t_16 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_frames.rcbuffer->pybuffer, (PyObject*)__pyx_t_15, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 3, 0, __pyx_stack);
      if (unlikely(__pyx_t_16 < 0)) {
        PyErr_Fetch(&__pyx_t_19, &__pyx_t_18, &__pyx_t_17);
        if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_frames.rcbuffer->pybuffer, (PyObject*)__pyx_v_frames, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 3, 0, __pyx_stack) == -1)) {
          Py_XDECREF(__pyx_t_19); Py_XDECREF(__pyx_t_18); Py_XDECREF(__pyx_t_17);
          __Pyx_RaiseBufferFallbackError();
        } else {
          PyErr_Restore(__pyx_t_19, __pyx_t_18, __pyx_t_17);
        }
      }
      __pyx_pybuffernd_frames.diminfo[0].strides = __pyx_pybuffernd_frames.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_frames.diminfo[0].shape = __pyx_pybuffernd_frames.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_frames.diminfo[1].strides = __pyx_pybuffernd_frames.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_frames.diminfo[1].shape = __pyx_pybuffernd_frames.rcbuffer->pybuffer.shape[1]; __pyx_pybuffernd_frames.diminfo[2].strides = __pyx_pybuffernd_frames.rcbuffer->pybuffer.strides[2]; __pyx_pybuffernd_frames.diminfo[2].shape = __pyx_pybuffernd_frames.rcbuffer->pybuffer.shape[2];
      if (unlikely(__pyx_t_16 < 0)) __PYX_ERR(0, 678, __pyx_L1_error)
    }
    __pyx_t_15 = 0;
    __Pyx_DECREF_SET(__pyx_v_frames, ((PyArrayObject *)__pyx_t_3));
    __pyx_t_3 = 0;

    /* "orb/cutils.pyx":679
 *     elif reject_mode == 2:
 *         frames = frames[:,:,1:-1]
 *         rejects2d.fill(2)             # <<<<<<<<<<<<<<
 *     else: raise Exception('Bad rejection mode. Must be 0, 1 or 2.')
 * 
 */
    __pyx_t_3 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_rejects2d), __pyx_n_s_fill); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 679, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __pyx_t_23 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_tuple__42, NULL); if (unlikely(!__pyx_t_23)) __PYX_ERR(0, 679, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_23);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __Pyx_DECREF(__pyx_t_23); __pyx_t_23 = 0;

    /* "orb/cutils.pyx":677
 * 
 *     # minmax
 *     elif reject_mode == 2:             # <<<<<<<<<<<<<<
 *         frames = frames[:,:,1:-1]
 *         rejects2d.fill(2)
 */
    break;
    default:

    /* "orb/cutils.pyx":680
 *         frames = frames[:,:,1:-1]
 *         rejects2d.fill(2)
 *     else: raise Exception('Bad rejection mode. Must be 0, 1 or 2.')             # <<<<<<<<<<<<<<
 * 
 *     ## Combination
 */
    __pyx_t_23 = __Pyx_PyObject_Call(__pyx_builtin_Exception, __pyx_tuple__43, NULL); if (unlikely(!__pyx_t_23)) __PYX_ERR(0, 680, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_23);
    __Pyx_Raise(__pyx_t_23, 0, 0, 0);
    __Pyx_DECREF(__pyx_t_23); __pyx_t_23 = 0;
    __PYX_ERR(0, 680, __pyx_L1_error)
    break;
  }

  /* "orb/cutils.pyx":683
 * 
 *     ## Combination
 *     if combine_mode == 0:             # <<<<<<<<<<<<<<
 *         result = bn.nanmean(frames, axis=2)
 *     elif combine_mode == 1:
 */
  switch (__pyx_v_combine_mode) {
    case 0:

    /* "orb/cutils.pyx":684
 *     ## Combination
 *     if combine_mode == 0:
 *         result = bn.nanmean(frames, axis=2)             # <<<<<<<<<<<<<<
 *     elif combine_mode == 1:
 *         result = bn.nanmedian(frames, axis=2)
 */
    __pyx_t_23 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_23)) __PYX_ERR(0, 684, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_23);
    __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_23, __pyx_n_s_nanmean); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 684, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_DECREF(__pyx_t_23); __pyx_t_23 = 0;
    __pyx_t_23 = PyTuple_New(1); if (unlikely(!__pyx_t_23)) __PYX_ERR(0, 684, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_23);
    __Pyx_INCREF(((PyObject *)__pyx_v_frames));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_frames));
    PyTuple_SET_ITEM(__pyx_t_23, 0, ((PyObject *)__pyx_v_frames));
    __pyx_t_6 = PyDict_New(); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 684, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
    if (PyDict_SetItem(__pyx_t_6, __pyx_n_s_axis, __pyx_int_2) < 0) __PYX_ERR(0, 684, __pyx_L1_error)
    __pyx_t_20 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_23, __pyx_t_6); if (unlikely(!__pyx_t_20)) __PYX_ERR(0, 684, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_20);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __Pyx_DECREF(__pyx_t_23); __pyx_t_23 = 0;
    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
    __pyx_v_result = __pyx_t_20;
    __pyx_t_20 = 0;

    /* "orb/cutils.pyx":683
 * 
 *     ## Combination
 *     if combine_mode == 0:             # <<<<<<<<<<<<<<
 *         result = bn.nanmean(frames, axis=2)
 *     elif combine_mode == 1:
 */
    break;

    /* "orb/cutils.pyx":685
 *     if combine_mode == 0:
 *         result = bn.nanmean(frames, axis=2)
 *     elif combine_mode == 1:             # <<<<<<<<<<<<<<
 *         result = bn.nanmedian(frames, axis=2)
 *     else: raise Exception('Bad combining mode. Must be 0 or 1')
 */
    case 1:

    /* "orb/cutils.pyx":686
 *         result = bn.nanmean(frames, axis=2)
 *     elif combine_mode == 1:
 *         result = bn.nanmedian(frames, axis=2)             # <<<<<<<<<<<<<<
 *     else: raise Exception('Bad combining mode. Must be 0 or 1')
 *     if not return_std_frame:
 */
    __pyx_t_20 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_20)) __PYX_ERR(0, 686, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_20);
    __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_t_20, __pyx_n_s_nanmedian); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 686, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
    __Pyx_DECREF(__pyx_t_20); __pyx_t_20 = 0;
    __pyx_t_20 = PyTuple_New(1); if (unlikely(!__pyx_t_20)) __PYX_ERR(0, 686, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_20);
    __Pyx_INCREF(((PyObject *)__pyx_v_frames));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_frames));
    PyTuple_SET_ITEM(__pyx_t_20, 0, ((PyObject *)__pyx_v_frames));
    __pyx_t_23 = PyDict_New(); if (unlikely(!__pyx_t_23)) __PYX_ERR(0, 686, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_23);
    if (PyDict_SetItem(__pyx_t_23, __pyx_n_s_axis, __pyx_int_2) < 0) __PYX_ERR(0, 686, __pyx_L1_error)
    __pyx_t_3 = __Pyx_PyObject_Call(__pyx_t_6, __pyx_t_20, __pyx_t_23); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 686, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
    __Pyx_DECREF(__pyx_t_20); __pyx_t_20 = 0;
    __Pyx_DECREF(__pyx_t_23); __pyx_t_23 = 0;
    __pyx_v_result = __pyx_t_3;
    __pyx_t_3 = 0;

    /* "orb/cutils.pyx":685
 *     if combine_mode == 0:
 *         result = bn.nanmean(frames, axis=2)
 *     elif combine_mode == 1:             # <<<<<<<<<<<<<<
 *         result = bn.nanmedian(frames, axis=2)
 *     else: raise Exception('Bad combining mode. Must be 0 or 1')
 */
    break;
    default:

    /* "orb/cutils.pyx":687
 *     elif combine_mode == 1:
 *         result = bn.nanmedian(frames, axis=2)
 *     else: raise Exception('Bad combining mode. Must be 0 or 1')             # <<<<<<<<<<<<<<
 *     if not return_std_frame:
 *         return result, rejects2d
 */
    __pyx_t_3 = __Pyx_PyObject_Call(__pyx_builtin_Exception, __pyx_tuple__44, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 687, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_Raise(__pyx_t_3, 0, 0, 0);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __PYX_ERR(0, 687, __pyx_L1_error)
    break;
  }

  /* "orb/cutils.pyx":688
 *         result = bn.nanmedian(frames, axis=2)
 *     else: raise Exception('Bad combining mode. Must be 0 or 1')
 *     if not return_std_frame:             # <<<<<<<<<<<<<<
 *         return result, rejects2d
 *     else:
 */
  __pyx_t_1 = __Pyx_PyObject_IsTrue(__pyx_v_return_std_frame); if (unlikely(__pyx_t_1 < 0)) __PYX_ERR(0, 688, __pyx_L1_error)
  __pyx_t_24 = ((!__pyx_t_1) != 0);
  if (__pyx_t_24) {

    /* "orb/cutils.pyx":689
 *     else: raise Exception('Bad combining mode. Must be 0 or 1')
 *     if not return_std_frame:
 *         return result, rejects2d             # <<<<<<<<<<<<<<
 *     else:
 *         return result, rejects2d, bn.nanstd(frames, axis=2)
 */
    __Pyx_XDECREF(__pyx_r);
    __pyx_t_3 = PyTuple_New(2); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 689, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_INCREF(__pyx_v_result);
    __Pyx_GIVEREF(__pyx_v_result);
    PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_v_result);
    __Pyx_INCREF(((PyObject *)__pyx_v_rejects2d));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_rejects2d));
    PyTuple_SET_ITEM(__pyx_t_3, 1, ((PyObject *)__pyx_v_rejects2d));
    __pyx_r = __pyx_t_3;
    __pyx_t_3 = 0;
    goto __pyx_L0;

    /* "orb/cutils.pyx":688
 *         result = bn.nanmedian(frames, axis=2)
 *     else: raise Exception('Bad combining mode. Must be 0 or 1')
 *     if not return_std_frame:             # <<<<<<<<<<<<<<
 *         return result, rejects2d
 *     else:
 */
  }

  /* "orb/cutils.pyx":691
 *         return result, rejects2d
 *     else:
 *         return result, rejects2d, bn.nanstd(frames, axis=2)             # <<<<<<<<<<<<<<
 * 
 * 
 */
  /*else*/ {
    __Pyx_XDECREF(__pyx_r);
    __pyx_t_3 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 691, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __pyx_t_23 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_nanstd); if (unlikely(!__pyx_t_23)) __PYX_ERR(0, 691, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_23);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 691, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_INCREF(((PyObject *)__pyx_v_frames));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_frames));
    PyTuple_SET_ITEM(__pyx_t_3, 0, ((PyObject *)__pyx_v_frames));
    __pyx_t_20 = PyDict_New(); if (unlikely(!__pyx_t_20)) __PYX_ERR(0, 691, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_20);
    if (PyDict_SetItem(__pyx_t_20, __pyx_n_s_axis, __pyx_int_2) < 0) __PYX_ERR(0, 691, __pyx_L1_error)
    __pyx_t_6 = __Pyx_PyObject_Call(__pyx_t_23, __pyx_t_3, __pyx_t_20); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 691, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
    __Pyx_DECREF(__pyx_t_23); __pyx_t_23 = 0;
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __Pyx_DECREF(__pyx_t_20); __pyx_t_20 = 0;
    __pyx_t_20 = PyTuple_New(3); if (unlikely(!__pyx_t_20)) __PYX_ERR(0, 691, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_20);
    __Pyx_INCREF(__pyx_v_result);
    __Pyx_GIVEREF(__pyx_v_result);
    PyTuple_SET_ITEM(__pyx_t_20, 0, __pyx_v_result);
    __Pyx_INCREF(((PyObject *)__pyx_v_rejects2d));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_rejects2d));
    PyTuple_SET_ITEM(__pyx_t_20, 1, ((PyObject *)__pyx_v_rejects2d));
    __Pyx_GIVEREF(__pyx_t_6);
    PyTuple_SET_ITEM(__pyx_t_20, 2, __pyx_t_6);
    __pyx_t_6 = 0;
    __pyx_r = __pyx_t_20;
    __pyx_t_20 = 0;
    goto __pyx_L0;
  }

  /* "orb/cutils.pyx":564
 *     return x[min_mask:max_mask+1]
 * 
 * def master_combine(np.ndarray[np.float64_t, ndim=3] frames, double sigma,             # <<<<<<<<<<<<<<
 *                    int nkeep, int combine_mode, int reject_mode,
 *                    return_std_frame=False):
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_XDECREF(__pyx_t_5);
  __Pyx_XDECREF(__pyx_t_6);
  __Pyx_XDECREF(__pyx_t_20);
  __Pyx_XDECREF(__pyx_t_21);
  __Pyx_XDECREF(__pyx_t_23);
  { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
    __Pyx_PyThreadState_declare
    __Pyx_PyThreadState_assign
    __Pyx_ErrFetch(&__pyx_type, &__pyx_value, &__pyx_tb);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_argmax2d.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_frames.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_framesdiff.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_max2d.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_mean2d.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_new_rejects2d.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_rejects2d.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_sqrtmean2d.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_std2d.rcbuffer->pybuffer);
  __Pyx_ErrRestore(__pyx_type, __pyx_value, __pyx_tb);}
  __Pyx_AddTraceback("orb.cutils.master_combine", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  goto __pyx_L2;
  __pyx_L0:;
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_argmax2d.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_frames.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_framesdiff.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_max2d.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_mean2d.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_new_rejects2d.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_rejects2d.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_sqrtmean2d.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_std2d.rcbuffer->pybuffer);
  __pyx_L2:;
  __Pyx_XDECREF((PyObject *)__pyx_v_framesdiff);
  __Pyx_XDECREF((PyObject *)__pyx_v_argmax2d);
  __Pyx_XDECREF((PyObject *)__pyx_v_max2d);
  __Pyx_XDECREF((PyObject *)__pyx_v_sqrtmean2d);
  __Pyx_XDECREF((PyObject *)__pyx_v_rejects2d);
  __Pyx_XDECREF((PyObject *)__pyx_v_new_rejects2d);
  __Pyx_XDECREF((PyObject *)__pyx_v_mean2d);
  __Pyx_XDECREF((PyObject *)__pyx_v_std2d);
  __Pyx_XDECREF(__pyx_v_nans);
  __Pyx_XDECREF(__pyx_v_mask2d);
  __Pyx_XDECREF(__pyx_v_rejpix);
  __Pyx_XDECREF(__pyx_v_result);
  __Pyx_XDECREF((PyObject *)__pyx_v_frames);
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":694
 * 
 * 
 * def _robust_format(np.ndarray x):             # <<<<<<<<<<<<<<
 *     """Format data and check if it can be computed by bottleneck module.
 * 
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_27_robust_format(PyObject *__pyx_self, PyObject *__pyx_v_x); /*proto*/
static char __pyx_doc_3orb_6cutils_26_robust_format[] = "_robust_format(ndarray x)\nFormat data and check if it can be computed by bottleneck module.\n\n    :param x: a numpy ndarray\n\n    :return: (formatted_data, flag, complexflag). If the flag is True,\n      data can be computed by the bottleneck module. Else it must be\n      computed with Numpy. The complexflag tells if the data is\n      complex.\n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_27_robust_format = {"_robust_format", (PyCFunction)__pyx_pw_3orb_6cutils_27_robust_format, METH_O, __pyx_doc_3orb_6cutils_26_robust_format};
static PyObject *__pyx_pw_3orb_6cutils_27_robust_format(PyObject *__pyx_self, PyObject *__pyx_v_x) {
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("_robust_format (wrapper)", 0);
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_x), __pyx_ptype_5numpy_ndarray, 1, "x", 0))) __PYX_ERR(0, 694, __pyx_L1_error)
  __pyx_r = __pyx_pf_3orb_6cutils_26_robust_format(__pyx_self, ((PyArrayObject *)__pyx_v_x));

  /* function exit code */
  goto __pyx_L0;
  __pyx_L1_error:;
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_26_robust_format(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_x) {
  PyBoolObject *__pyx_v_flag = 0;
  PyBoolObject *__pyx_v_complexflag = 0;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  int __pyx_t_1;
  PyObject *__pyx_t_2 = NULL;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  int __pyx_t_5;
  PyObject *__pyx_t_6 = NULL;
  PyObject *__pyx_t_7 = NULL;
  PyObject *__pyx_t_8 = NULL;
  PyObject *__pyx_t_9 = NULL;
  __Pyx_RefNannySetupContext("_robust_format", 0);
  __Pyx_INCREF((PyObject *)__pyx_v_x);

  /* "orb/cutils.pyx":704
 *       complex.
 *     """
 *     cdef bool flag = True             # <<<<<<<<<<<<<<
 *     cdef bool complexflag = False
 * 
 */
  __Pyx_INCREF(Py_True);
  __pyx_v_flag = ((PyBoolObject *)Py_True);

  /* "orb/cutils.pyx":705
 *     """
 *     cdef bool flag = True
 *     cdef bool complexflag = False             # <<<<<<<<<<<<<<
 * 
 *     if x.ndim < 1:
 */
  __Pyx_INCREF(Py_False);
  __pyx_v_complexflag = ((PyBoolObject *)Py_False);

  /* "orb/cutils.pyx":707
 *     cdef bool complexflag = False
 * 
 *     if x.ndim < 1:             # <<<<<<<<<<<<<<
 *         flag = False
 * 
 */
  __pyx_t_1 = ((__pyx_v_x->nd < 1) != 0);
  if (__pyx_t_1) {

    /* "orb/cutils.pyx":708
 * 
 *     if x.ndim < 1:
 *         flag = False             # <<<<<<<<<<<<<<
 * 
 *     if x.dtype == np.dtype(complex):
 */
    __Pyx_INCREF(Py_False);
    __Pyx_DECREF_SET(__pyx_v_flag, ((PyBoolObject *)Py_False));

    /* "orb/cutils.pyx":707
 *     cdef bool complexflag = False
 * 
 *     if x.ndim < 1:             # <<<<<<<<<<<<<<
 *         flag = False
 * 
 */
  }

  /* "orb/cutils.pyx":710
 *         flag = False
 * 
 *     if x.dtype == np.dtype(complex):             # <<<<<<<<<<<<<<
 *         complexflag = True
 * 
 */
  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_x), __pyx_n_s_dtype); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 710, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 710, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_INCREF(((PyObject *)(&PyComplex_Type)));
  __Pyx_GIVEREF(((PyObject *)(&PyComplex_Type)));
  PyTuple_SET_ITEM(__pyx_t_3, 0, ((PyObject *)(&PyComplex_Type)));
  __pyx_t_4 = __Pyx_PyObject_Call(((PyObject *)__pyx_ptype_5numpy_dtype), __pyx_t_3, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 710, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_3 = PyObject_RichCompare(__pyx_t_2, __pyx_t_4, Py_EQ); __Pyx_XGOTREF(__pyx_t_3); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 710, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_1 = __Pyx_PyObject_IsTrue(__pyx_t_3); if (unlikely(__pyx_t_1 < 0)) __PYX_ERR(0, 710, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  if (__pyx_t_1) {

    /* "orb/cutils.pyx":711
 * 
 *     if x.dtype == np.dtype(complex):
 *         complexflag = True             # <<<<<<<<<<<<<<
 * 
 *     if x.dtype.byteorder != '|' or '=':
 */
    __Pyx_INCREF(Py_True);
    __Pyx_DECREF_SET(__pyx_v_complexflag, ((PyBoolObject *)Py_True));

    /* "orb/cutils.pyx":710
 *         flag = False
 * 
 *     if x.dtype == np.dtype(complex):             # <<<<<<<<<<<<<<
 *         complexflag = True
 * 
 */
  }

  /* "orb/cutils.pyx":713
 *         complexflag = True
 * 
 *     if x.dtype.byteorder != '|' or '=':             # <<<<<<<<<<<<<<
 *         x = x.astype(x.dtype.newbyteorder('N'))
 * 
 */
  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_x), __pyx_n_s_dtype); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 713, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_byteorder); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 713, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_5 = (__Pyx_PyString_Equals(__pyx_t_4, __pyx_kp_s__45, Py_NE)); if (unlikely(__pyx_t_5 < 0)) __PYX_ERR(0, 713, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  if (!__pyx_t_5) {
  } else {
    __pyx_t_1 = __pyx_t_5;
    goto __pyx_L6_bool_binop_done;
  }
  __pyx_t_1 = 1;
  __pyx_L6_bool_binop_done:;
  if (__pyx_t_1) {

    /* "orb/cutils.pyx":714
 * 
 *     if x.dtype.byteorder != '|' or '=':
 *         x = x.astype(x.dtype.newbyteorder('N'))             # <<<<<<<<<<<<<<
 * 
 *     if x.dtype == np.dtype(float) or x.dtype == np.dtype(complex):
 */
    __pyx_t_3 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_x), __pyx_n_s_astype); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 714, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __pyx_t_2 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_x), __pyx_n_s_dtype); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 714, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_newbyteorder); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 714, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_6, __pyx_tuple__46, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 714, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
    __pyx_t_6 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && likely(PyMethod_Check(__pyx_t_3))) {
      __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_3);
      if (likely(__pyx_t_6)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
        __Pyx_INCREF(__pyx_t_6);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_3, function);
      }
    }
    if (!__pyx_t_6) {
      __pyx_t_4 = __Pyx_PyObject_CallOneArg(__pyx_t_3, __pyx_t_2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 714, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
      __Pyx_GOTREF(__pyx_t_4);
    } else {
      __pyx_t_7 = PyTuple_New(1+1); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 714, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_7);
      __Pyx_GIVEREF(__pyx_t_6); PyTuple_SET_ITEM(__pyx_t_7, 0, __pyx_t_6); __pyx_t_6 = NULL;
      __Pyx_GIVEREF(__pyx_t_2);
      PyTuple_SET_ITEM(__pyx_t_7, 0+1, __pyx_t_2);
      __pyx_t_2 = 0;
      __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_7, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 714, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
    }
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    if (!(likely(((__pyx_t_4) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_4, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 714, __pyx_L1_error)
    __Pyx_DECREF_SET(__pyx_v_x, ((PyArrayObject *)__pyx_t_4));
    __pyx_t_4 = 0;

    /* "orb/cutils.pyx":713
 *         complexflag = True
 * 
 *     if x.dtype.byteorder != '|' or '=':             # <<<<<<<<<<<<<<
 *         x = x.astype(x.dtype.newbyteorder('N'))
 * 
 */
  }

  /* "orb/cutils.pyx":716
 *         x = x.astype(x.dtype.newbyteorder('N'))
 * 
 *     if x.dtype == np.dtype(float) or x.dtype == np.dtype(complex):             # <<<<<<<<<<<<<<
 *         if np.any(np.isinf(x)):
 *             x[np.nonzero(np.isinf(x))] = np.nan
 */
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_x), __pyx_n_s_dtype); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 716, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 716, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_INCREF(((PyObject *)(&PyFloat_Type)));
  __Pyx_GIVEREF(((PyObject *)(&PyFloat_Type)));
  PyTuple_SET_ITEM(__pyx_t_3, 0, ((PyObject *)(&PyFloat_Type)));
  __pyx_t_7 = __Pyx_PyObject_Call(((PyObject *)__pyx_ptype_5numpy_dtype), __pyx_t_3, NULL); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 716, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_7);
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_3 = PyObject_RichCompare(__pyx_t_4, __pyx_t_7, Py_EQ); __Pyx_XGOTREF(__pyx_t_3); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 716, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
  __pyx_t_5 = __Pyx_PyObject_IsTrue(__pyx_t_3); if (unlikely(__pyx_t_5 < 0)) __PYX_ERR(0, 716, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  if (!__pyx_t_5) {
  } else {
    __pyx_t_1 = __pyx_t_5;
    goto __pyx_L9_bool_binop_done;
  }
  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_x), __pyx_n_s_dtype); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 716, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_7 = PyTuple_New(1); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 716, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_7);
  __Pyx_INCREF(((PyObject *)(&PyComplex_Type)));
  __Pyx_GIVEREF(((PyObject *)(&PyComplex_Type)));
  PyTuple_SET_ITEM(__pyx_t_7, 0, ((PyObject *)(&PyComplex_Type)));
  __pyx_t_4 = __Pyx_PyObject_Call(((PyObject *)__pyx_ptype_5numpy_dtype), __pyx_t_7, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 716, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
  __pyx_t_7 = PyObject_RichCompare(__pyx_t_3, __pyx_t_4, Py_EQ); __Pyx_XGOTREF(__pyx_t_7); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 716, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_5 = __Pyx_PyObject_IsTrue(__pyx_t_7); if (unlikely(__pyx_t_5 < 0)) __PYX_ERR(0, 716, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
  __pyx_t_1 = __pyx_t_5;
  __pyx_L9_bool_binop_done:;
  if (__pyx_t_1) {

    /* "orb/cutils.pyx":717
 * 
 *     if x.dtype == np.dtype(float) or x.dtype == np.dtype(complex):
 *         if np.any(np.isinf(x)):             # <<<<<<<<<<<<<<
 *             x[np.nonzero(np.isinf(x))] = np.nan
 * 
 */
    __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 717, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_any); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 717, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 717, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_isinf); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 717, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __pyx_t_2 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_6))) {
      __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_6);
      if (likely(__pyx_t_2)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_6);
        __Pyx_INCREF(__pyx_t_2);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_6, function);
      }
    }
    if (!__pyx_t_2) {
      __pyx_t_4 = __Pyx_PyObject_CallOneArg(__pyx_t_6, ((PyObject *)__pyx_v_x)); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 717, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
    } else {
      __pyx_t_8 = PyTuple_New(1+1); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 717, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_8);
      __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_8, 0, __pyx_t_2); __pyx_t_2 = NULL;
      __Pyx_INCREF(((PyObject *)__pyx_v_x));
      __Pyx_GIVEREF(((PyObject *)__pyx_v_x));
      PyTuple_SET_ITEM(__pyx_t_8, 0+1, ((PyObject *)__pyx_v_x));
      __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_6, __pyx_t_8, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 717, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
    }
    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
    __pyx_t_6 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_3))) {
      __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_3);
      if (likely(__pyx_t_6)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
        __Pyx_INCREF(__pyx_t_6);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_3, function);
      }
    }
    if (!__pyx_t_6) {
      __pyx_t_7 = __Pyx_PyObject_CallOneArg(__pyx_t_3, __pyx_t_4); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 717, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __Pyx_GOTREF(__pyx_t_7);
    } else {
      __pyx_t_8 = PyTuple_New(1+1); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 717, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_8);
      __Pyx_GIVEREF(__pyx_t_6); PyTuple_SET_ITEM(__pyx_t_8, 0, __pyx_t_6); __pyx_t_6 = NULL;
      __Pyx_GIVEREF(__pyx_t_4);
      PyTuple_SET_ITEM(__pyx_t_8, 0+1, __pyx_t_4);
      __pyx_t_4 = 0;
      __pyx_t_7 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_8, NULL); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 717, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_7);
      __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
    }
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __pyx_t_1 = __Pyx_PyObject_IsTrue(__pyx_t_7); if (unlikely(__pyx_t_1 < 0)) __PYX_ERR(0, 717, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
    if (__pyx_t_1) {

      /* "orb/cutils.pyx":718
 *     if x.dtype == np.dtype(float) or x.dtype == np.dtype(complex):
 *         if np.any(np.isinf(x)):
 *             x[np.nonzero(np.isinf(x))] = np.nan             # <<<<<<<<<<<<<<
 * 
 *     return x, flag, complexflag
 */
      __pyx_t_7 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 718, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_7);
      __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_7, __pyx_n_s_nan); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 718, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
      __pyx_t_8 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 718, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_8);
      __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_8, __pyx_n_s_nonzero); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 718, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
      __pyx_t_6 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 718, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_6);
      __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_6, __pyx_n_s_isinf); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 718, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
      __pyx_t_6 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_2))) {
        __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_2);
        if (likely(__pyx_t_6)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
          __Pyx_INCREF(__pyx_t_6);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_2, function);
        }
      }
      if (!__pyx_t_6) {
        __pyx_t_8 = __Pyx_PyObject_CallOneArg(__pyx_t_2, ((PyObject *)__pyx_v_x)); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 718, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_8);
      } else {
        __pyx_t_9 = PyTuple_New(1+1); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 718, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_9);
        __Pyx_GIVEREF(__pyx_t_6); PyTuple_SET_ITEM(__pyx_t_9, 0, __pyx_t_6); __pyx_t_6 = NULL;
        __Pyx_INCREF(((PyObject *)__pyx_v_x));
        __Pyx_GIVEREF(((PyObject *)__pyx_v_x));
        PyTuple_SET_ITEM(__pyx_t_9, 0+1, ((PyObject *)__pyx_v_x));
        __pyx_t_8 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_9, NULL); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 718, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_8);
        __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
      }
      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
      __pyx_t_2 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_4))) {
        __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_4);
        if (likely(__pyx_t_2)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
          __Pyx_INCREF(__pyx_t_2);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_4, function);
        }
      }
      if (!__pyx_t_2) {
        __pyx_t_7 = __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_8); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 718, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
        __Pyx_GOTREF(__pyx_t_7);
      } else {
        __pyx_t_9 = PyTuple_New(1+1); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 718, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_9);
        __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_9, 0, __pyx_t_2); __pyx_t_2 = NULL;
        __Pyx_GIVEREF(__pyx_t_8);
        PyTuple_SET_ITEM(__pyx_t_9, 0+1, __pyx_t_8);
        __pyx_t_8 = 0;
        __pyx_t_7 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_9, NULL); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 718, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_7);
        __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
      }
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      if (unlikely(PyObject_SetItem(((PyObject *)__pyx_v_x), __pyx_t_7, __pyx_t_3) < 0)) __PYX_ERR(0, 718, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;

      /* "orb/cutils.pyx":717
 * 
 *     if x.dtype == np.dtype(float) or x.dtype == np.dtype(complex):
 *         if np.any(np.isinf(x)):             # <<<<<<<<<<<<<<
 *             x[np.nonzero(np.isinf(x))] = np.nan
 * 
 */
    }

    /* "orb/cutils.pyx":716
 *         x = x.astype(x.dtype.newbyteorder('N'))
 * 
 *     if x.dtype == np.dtype(float) or x.dtype == np.dtype(complex):             # <<<<<<<<<<<<<<
 *         if np.any(np.isinf(x)):
 *             x[np.nonzero(np.isinf(x))] = np.nan
 */
  }

  /* "orb/cutils.pyx":720
 *             x[np.nonzero(np.isinf(x))] = np.nan
 * 
 *     return x, flag, complexflag             # <<<<<<<<<<<<<<
 * 
 * def robust_mean(np.ndarray x):
 */
  __Pyx_XDECREF(__pyx_r);
  __pyx_t_3 = PyTuple_New(3); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 720, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_INCREF(((PyObject *)__pyx_v_x));
  __Pyx_GIVEREF(((PyObject *)__pyx_v_x));
  PyTuple_SET_ITEM(__pyx_t_3, 0, ((PyObject *)__pyx_v_x));
  __Pyx_INCREF(((PyObject *)__pyx_v_flag));
  __Pyx_GIVEREF(((PyObject *)__pyx_v_flag));
  PyTuple_SET_ITEM(__pyx_t_3, 1, ((PyObject *)__pyx_v_flag));
  __Pyx_INCREF(((PyObject *)__pyx_v_complexflag));
  __Pyx_GIVEREF(((PyObject *)__pyx_v_complexflag));
  PyTuple_SET_ITEM(__pyx_t_3, 2, ((PyObject *)__pyx_v_complexflag));
  __pyx_r = __pyx_t_3;
  __pyx_t_3 = 0;
  goto __pyx_L0;

  /* "orb/cutils.pyx":694
 * 
 * 
 * def _robust_format(np.ndarray x):             # <<<<<<<<<<<<<<
 *     """Format data and check if it can be computed by bottleneck module.
 * 
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_XDECREF(__pyx_t_6);
  __Pyx_XDECREF(__pyx_t_7);
  __Pyx_XDECREF(__pyx_t_8);
  __Pyx_XDECREF(__pyx_t_9);
  __Pyx_AddTraceback("orb.cutils._robust_format", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_XDECREF((PyObject *)__pyx_v_flag);
  __Pyx_XDECREF((PyObject *)__pyx_v_complexflag);
  __Pyx_XDECREF((PyObject *)__pyx_v_x);
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":722
 *     return x, flag, complexflag
 * 
 * def robust_mean(np.ndarray x):             # <<<<<<<<<<<<<<
 *     """Compute robust mean of a numpy ndarray (NaNs are skipped)
 * 
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_29robust_mean(PyObject *__pyx_self, PyObject *__pyx_v_x); /*proto*/
static char __pyx_doc_3orb_6cutils_28robust_mean[] = "robust_mean(ndarray x)\nCompute robust mean of a numpy ndarray (NaNs are skipped)\n\n    :param x: a numpy ndarray \n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_29robust_mean = {"robust_mean", (PyCFunction)__pyx_pw_3orb_6cutils_29robust_mean, METH_O, __pyx_doc_3orb_6cutils_28robust_mean};
static PyObject *__pyx_pw_3orb_6cutils_29robust_mean(PyObject *__pyx_self, PyObject *__pyx_v_x) {
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("robust_mean (wrapper)", 0);
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_x), __pyx_ptype_5numpy_ndarray, 1, "x", 0))) __PYX_ERR(0, 722, __pyx_L1_error)
  __pyx_r = __pyx_pf_3orb_6cutils_28robust_mean(__pyx_self, ((PyArrayObject *)__pyx_v_x));

  /* function exit code */
  goto __pyx_L0;
  __pyx_L1_error:;
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_28robust_mean(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_x) {
  PyBoolObject *__pyx_v_flag = 0;
  PyBoolObject *__pyx_v_complexflag = 0;
  __pyx_t_double_complex __pyx_v_complexresult;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  PyObject *__pyx_t_1 = NULL;
  PyObject *__pyx_t_2 = NULL;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  PyObject *__pyx_t_5 = NULL;
  PyObject *(*__pyx_t_6)(PyObject *);
  int __pyx_t_7;
  double __pyx_t_8;
  double __pyx_t_9;
  __Pyx_RefNannySetupContext("robust_mean", 0);
  __Pyx_INCREF((PyObject *)__pyx_v_x);

  /* "orb/cutils.pyx":731
 *     cdef complex complexresult
 * 
 *     (x, flag, complexflag) = _robust_format(x)             # <<<<<<<<<<<<<<
 * 
 *     if flag:
 */
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_robust_format); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 731, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_3 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_2))) {
    __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_2);
    if (likely(__pyx_t_3)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
      __Pyx_INCREF(__pyx_t_3);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_2, function);
    }
  }
  if (!__pyx_t_3) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_2, ((PyObject *)__pyx_v_x)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 731, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_4 = PyTuple_New(1+1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 731, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_3); __pyx_t_3 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_x));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_x));
    PyTuple_SET_ITEM(__pyx_t_4, 0+1, ((PyObject *)__pyx_v_x));
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_4, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 731, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  }
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  if ((likely(PyTuple_CheckExact(__pyx_t_1))) || (PyList_CheckExact(__pyx_t_1))) {
    PyObject* sequence = __pyx_t_1;
    #if CYTHON_COMPILING_IN_CPYTHON
    Py_ssize_t size = Py_SIZE(sequence);
    #else
    Py_ssize_t size = PySequence_Size(sequence);
    #endif
    if (unlikely(size != 3)) {
      if (size > 3) __Pyx_RaiseTooManyValuesError(3);
      else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
      __PYX_ERR(0, 731, __pyx_L1_error)
    }
    #if CYTHON_COMPILING_IN_CPYTHON
    if (likely(PyTuple_CheckExact(sequence))) {
      __pyx_t_2 = PyTuple_GET_ITEM(sequence, 0); 
      __pyx_t_4 = PyTuple_GET_ITEM(sequence, 1); 
      __pyx_t_3 = PyTuple_GET_ITEM(sequence, 2); 
    } else {
      __pyx_t_2 = PyList_GET_ITEM(sequence, 0); 
      __pyx_t_4 = PyList_GET_ITEM(sequence, 1); 
      __pyx_t_3 = PyList_GET_ITEM(sequence, 2); 
    }
    __Pyx_INCREF(__pyx_t_2);
    __Pyx_INCREF(__pyx_t_4);
    __Pyx_INCREF(__pyx_t_3);
    #else
    __pyx_t_2 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 731, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __pyx_t_4 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 731, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __pyx_t_3 = PySequence_ITEM(sequence, 2); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 731, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    #endif
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  } else {
    Py_ssize_t index = -1;
    __pyx_t_5 = PyObject_GetIter(__pyx_t_1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 731, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    __pyx_t_6 = Py_TYPE(__pyx_t_5)->tp_iternext;
    index = 0; __pyx_t_2 = __pyx_t_6(__pyx_t_5); if (unlikely(!__pyx_t_2)) goto __pyx_L3_unpacking_failed;
    __Pyx_GOTREF(__pyx_t_2);
    index = 1; __pyx_t_4 = __pyx_t_6(__pyx_t_5); if (unlikely(!__pyx_t_4)) goto __pyx_L3_unpacking_failed;
    __Pyx_GOTREF(__pyx_t_4);
    index = 2; __pyx_t_3 = __pyx_t_6(__pyx_t_5); if (unlikely(!__pyx_t_3)) goto __pyx_L3_unpacking_failed;
    __Pyx_GOTREF(__pyx_t_3);
    if (__Pyx_IternextUnpackEndCheck(__pyx_t_6(__pyx_t_5), 3) < 0) __PYX_ERR(0, 731, __pyx_L1_error)
    __pyx_t_6 = NULL;
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    goto __pyx_L4_unpacking_done;
    __pyx_L3_unpacking_failed:;
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    __pyx_t_6 = NULL;
    if (__Pyx_IterFinish() == 0) __Pyx_RaiseNeedMoreValuesError(index);
    __PYX_ERR(0, 731, __pyx_L1_error)
    __pyx_L4_unpacking_done:;
  }
  if (!(likely(((__pyx_t_2) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_2, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 731, __pyx_L1_error)
  if (!(likely(((__pyx_t_4) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_4, __pyx_ptype_7cpython_4bool_bool))))) __PYX_ERR(0, 731, __pyx_L1_error)
  if (!(likely(((__pyx_t_3) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_3, __pyx_ptype_7cpython_4bool_bool))))) __PYX_ERR(0, 731, __pyx_L1_error)
  __Pyx_DECREF_SET(__pyx_v_x, ((PyArrayObject *)__pyx_t_2));
  __pyx_t_2 = 0;
  __pyx_v_flag = ((PyBoolObject *)__pyx_t_4);
  __pyx_t_4 = 0;
  __pyx_v_complexflag = ((PyBoolObject *)__pyx_t_3);
  __pyx_t_3 = 0;

  /* "orb/cutils.pyx":733
 *     (x, flag, complexflag) = _robust_format(x)
 * 
 *     if flag:             # <<<<<<<<<<<<<<
 *         if complexflag:
 *             complexresult.real = bn.nanmean(x.real)
 */
  __pyx_t_7 = __Pyx_PyObject_IsTrue(((PyObject *)__pyx_v_flag)); if (unlikely(__pyx_t_7 < 0)) __PYX_ERR(0, 733, __pyx_L1_error)
  if (__pyx_t_7) {

    /* "orb/cutils.pyx":734
 * 
 *     if flag:
 *         if complexflag:             # <<<<<<<<<<<<<<
 *             complexresult.real = bn.nanmean(x.real)
 *             complexresult.imag = bn.nanmean(x.imag)
 */
    __pyx_t_7 = __Pyx_PyObject_IsTrue(((PyObject *)__pyx_v_complexflag)); if (unlikely(__pyx_t_7 < 0)) __PYX_ERR(0, 734, __pyx_L1_error)
    if (__pyx_t_7) {

      /* "orb/cutils.pyx":735
 *     if flag:
 *         if complexflag:
 *             complexresult.real = bn.nanmean(x.real)             # <<<<<<<<<<<<<<
 *             complexresult.imag = bn.nanmean(x.imag)
 *             return complexresult
 */
      __pyx_t_3 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 735, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_nanmean); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 735, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      __pyx_t_3 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_x), __pyx_n_s_real); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 735, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __pyx_t_2 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_4))) {
        __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_4);
        if (likely(__pyx_t_2)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
          __Pyx_INCREF(__pyx_t_2);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_4, function);
        }
      }
      if (!__pyx_t_2) {
        __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_3); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 735, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
        __Pyx_GOTREF(__pyx_t_1);
      } else {
        __pyx_t_5 = PyTuple_New(1+1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 735, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_5);
        __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_2); __pyx_t_2 = NULL;
        __Pyx_GIVEREF(__pyx_t_3);
        PyTuple_SET_ITEM(__pyx_t_5, 0+1, __pyx_t_3);
        __pyx_t_3 = 0;
        __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_5, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 735, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_1);
        __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
      }
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __pyx_t_8 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_8 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 735, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
      __Pyx_SET_CREAL(__pyx_v_complexresult, __pyx_t_8);

      /* "orb/cutils.pyx":736
 *         if complexflag:
 *             complexresult.real = bn.nanmean(x.real)
 *             complexresult.imag = bn.nanmean(x.imag)             # <<<<<<<<<<<<<<
 *             return complexresult
 *         else:
 */
      __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 736, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_nanmean); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 736, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __pyx_t_4 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_x), __pyx_n_s_imag); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 736, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __pyx_t_3 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_5))) {
        __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_5);
        if (likely(__pyx_t_3)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_5);
          __Pyx_INCREF(__pyx_t_3);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_5, function);
        }
      }
      if (!__pyx_t_3) {
        __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_5, __pyx_t_4); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 736, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
        __Pyx_GOTREF(__pyx_t_1);
      } else {
        __pyx_t_2 = PyTuple_New(1+1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 736, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_2);
        __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_3); __pyx_t_3 = NULL;
        __Pyx_GIVEREF(__pyx_t_4);
        PyTuple_SET_ITEM(__pyx_t_2, 0+1, __pyx_t_4);
        __pyx_t_4 = 0;
        __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_2, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 736, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_1);
        __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
      }
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
      __pyx_t_9 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_9 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 736, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
      __Pyx_SET_CIMAG(__pyx_v_complexresult, __pyx_t_9);

      /* "orb/cutils.pyx":737
 *             complexresult.real = bn.nanmean(x.real)
 *             complexresult.imag = bn.nanmean(x.imag)
 *             return complexresult             # <<<<<<<<<<<<<<
 *         else:
 *             return bn.nanmean(x)
 */
      __Pyx_XDECREF(__pyx_r);
      __pyx_t_1 = __pyx_PyComplex_FromComplex(__pyx_v_complexresult); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 737, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);
      __pyx_r = __pyx_t_1;
      __pyx_t_1 = 0;
      goto __pyx_L0;

      /* "orb/cutils.pyx":734
 * 
 *     if flag:
 *         if complexflag:             # <<<<<<<<<<<<<<
 *             complexresult.real = bn.nanmean(x.real)
 *             complexresult.imag = bn.nanmean(x.imag)
 */
    }

    /* "orb/cutils.pyx":739
 *             return complexresult
 *         else:
 *             return bn.nanmean(x)             # <<<<<<<<<<<<<<
 *     else:
 *         return np.nanmean(x)
 */
    /*else*/ {
      __Pyx_XDECREF(__pyx_r);
      __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 739, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_nanmean); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 739, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
      __pyx_t_5 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_2))) {
        __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_2);
        if (likely(__pyx_t_5)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
          __Pyx_INCREF(__pyx_t_5);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_2, function);
        }
      }
      if (!__pyx_t_5) {
        __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_2, ((PyObject *)__pyx_v_x)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 739, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_1);
      } else {
        __pyx_t_4 = PyTuple_New(1+1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 739, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_4);
        __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_5); __pyx_t_5 = NULL;
        __Pyx_INCREF(((PyObject *)__pyx_v_x));
        __Pyx_GIVEREF(((PyObject *)__pyx_v_x));
        PyTuple_SET_ITEM(__pyx_t_4, 0+1, ((PyObject *)__pyx_v_x));
        __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_4, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 739, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_1);
        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      }
      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
      __pyx_r = __pyx_t_1;
      __pyx_t_1 = 0;
      goto __pyx_L0;
    }

    /* "orb/cutils.pyx":733
 *     (x, flag, complexflag) = _robust_format(x)
 * 
 *     if flag:             # <<<<<<<<<<<<<<
 *         if complexflag:
 *             complexresult.real = bn.nanmean(x.real)
 */
  }

  /* "orb/cutils.pyx":741
 *             return bn.nanmean(x)
 *     else:
 *         return np.nanmean(x)             # <<<<<<<<<<<<<<
 * 
 * 
 */
  /*else*/ {
    __Pyx_XDECREF(__pyx_r);
    __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 741, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_nanmean); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 741, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __pyx_t_2 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_4))) {
      __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_4);
      if (likely(__pyx_t_2)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
        __Pyx_INCREF(__pyx_t_2);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_4, function);
      }
    }
    if (!__pyx_t_2) {
      __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_4, ((PyObject *)__pyx_v_x)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 741, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);
    } else {
      __pyx_t_5 = PyTuple_New(1+1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 741, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_2); __pyx_t_2 = NULL;
      __Pyx_INCREF(((PyObject *)__pyx_v_x));
      __Pyx_GIVEREF(((PyObject *)__pyx_v_x));
      PyTuple_SET_ITEM(__pyx_t_5, 0+1, ((PyObject *)__pyx_v_x));
      __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_5, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 741, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    }
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_r = __pyx_t_1;
    __pyx_t_1 = 0;
    goto __pyx_L0;
  }

  /* "orb/cutils.pyx":722
 *     return x, flag, complexflag
 * 
 * def robust_mean(np.ndarray x):             # <<<<<<<<<<<<<<
 *     """Compute robust mean of a numpy ndarray (NaNs are skipped)
 * 
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_1);
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_XDECREF(__pyx_t_5);
  __Pyx_AddTraceback("orb.cutils.robust_mean", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_XDECREF((PyObject *)__pyx_v_flag);
  __Pyx_XDECREF((PyObject *)__pyx_v_complexflag);
  __Pyx_XDECREF((PyObject *)__pyx_v_x);
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":744
 * 
 * 
 * def robust_median(np.ndarray x):             # <<<<<<<<<<<<<<
 *     """Compute robust median of a numpy ndarray (NaNs are skipped)
 * 
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_31robust_median(PyObject *__pyx_self, PyObject *__pyx_v_x); /*proto*/
static char __pyx_doc_3orb_6cutils_30robust_median[] = "robust_median(ndarray x)\nCompute robust median of a numpy ndarray (NaNs are skipped)\n\n    :param x: a numpy ndarray \n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_31robust_median = {"robust_median", (PyCFunction)__pyx_pw_3orb_6cutils_31robust_median, METH_O, __pyx_doc_3orb_6cutils_30robust_median};
static PyObject *__pyx_pw_3orb_6cutils_31robust_median(PyObject *__pyx_self, PyObject *__pyx_v_x) {
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("robust_median (wrapper)", 0);
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_x), __pyx_ptype_5numpy_ndarray, 1, "x", 0))) __PYX_ERR(0, 744, __pyx_L1_error)
  __pyx_r = __pyx_pf_3orb_6cutils_30robust_median(__pyx_self, ((PyArrayObject *)__pyx_v_x));

  /* function exit code */
  goto __pyx_L0;
  __pyx_L1_error:;
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_30robust_median(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_x) {
  PyBoolObject *__pyx_v_flag = 0;
  PyBoolObject *__pyx_v_complexflag = 0;
  __pyx_t_double_complex __pyx_v_complexresult;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  PyObject *__pyx_t_1 = NULL;
  PyObject *__pyx_t_2 = NULL;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  PyObject *__pyx_t_5 = NULL;
  PyObject *(*__pyx_t_6)(PyObject *);
  int __pyx_t_7;
  double __pyx_t_8;
  double __pyx_t_9;
  __Pyx_RefNannySetupContext("robust_median", 0);
  __Pyx_INCREF((PyObject *)__pyx_v_x);

  /* "orb/cutils.pyx":753
 *     cdef complex complexresult
 * 
 *     (x, flag, complexflag) = _robust_format(x)             # <<<<<<<<<<<<<<
 * 
 *     if flag:
 */
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_robust_format); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 753, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_3 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_2))) {
    __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_2);
    if (likely(__pyx_t_3)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
      __Pyx_INCREF(__pyx_t_3);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_2, function);
    }
  }
  if (!__pyx_t_3) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_2, ((PyObject *)__pyx_v_x)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 753, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_4 = PyTuple_New(1+1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 753, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_3); __pyx_t_3 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_x));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_x));
    PyTuple_SET_ITEM(__pyx_t_4, 0+1, ((PyObject *)__pyx_v_x));
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_4, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 753, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  }
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  if ((likely(PyTuple_CheckExact(__pyx_t_1))) || (PyList_CheckExact(__pyx_t_1))) {
    PyObject* sequence = __pyx_t_1;
    #if CYTHON_COMPILING_IN_CPYTHON
    Py_ssize_t size = Py_SIZE(sequence);
    #else
    Py_ssize_t size = PySequence_Size(sequence);
    #endif
    if (unlikely(size != 3)) {
      if (size > 3) __Pyx_RaiseTooManyValuesError(3);
      else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
      __PYX_ERR(0, 753, __pyx_L1_error)
    }
    #if CYTHON_COMPILING_IN_CPYTHON
    if (likely(PyTuple_CheckExact(sequence))) {
      __pyx_t_2 = PyTuple_GET_ITEM(sequence, 0); 
      __pyx_t_4 = PyTuple_GET_ITEM(sequence, 1); 
      __pyx_t_3 = PyTuple_GET_ITEM(sequence, 2); 
    } else {
      __pyx_t_2 = PyList_GET_ITEM(sequence, 0); 
      __pyx_t_4 = PyList_GET_ITEM(sequence, 1); 
      __pyx_t_3 = PyList_GET_ITEM(sequence, 2); 
    }
    __Pyx_INCREF(__pyx_t_2);
    __Pyx_INCREF(__pyx_t_4);
    __Pyx_INCREF(__pyx_t_3);
    #else
    __pyx_t_2 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 753, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __pyx_t_4 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 753, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __pyx_t_3 = PySequence_ITEM(sequence, 2); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 753, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    #endif
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  } else {
    Py_ssize_t index = -1;
    __pyx_t_5 = PyObject_GetIter(__pyx_t_1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 753, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    __pyx_t_6 = Py_TYPE(__pyx_t_5)->tp_iternext;
    index = 0; __pyx_t_2 = __pyx_t_6(__pyx_t_5); if (unlikely(!__pyx_t_2)) goto __pyx_L3_unpacking_failed;
    __Pyx_GOTREF(__pyx_t_2);
    index = 1; __pyx_t_4 = __pyx_t_6(__pyx_t_5); if (unlikely(!__pyx_t_4)) goto __pyx_L3_unpacking_failed;
    __Pyx_GOTREF(__pyx_t_4);
    index = 2; __pyx_t_3 = __pyx_t_6(__pyx_t_5); if (unlikely(!__pyx_t_3)) goto __pyx_L3_unpacking_failed;
    __Pyx_GOTREF(__pyx_t_3);
    if (__Pyx_IternextUnpackEndCheck(__pyx_t_6(__pyx_t_5), 3) < 0) __PYX_ERR(0, 753, __pyx_L1_error)
    __pyx_t_6 = NULL;
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    goto __pyx_L4_unpacking_done;
    __pyx_L3_unpacking_failed:;
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    __pyx_t_6 = NULL;
    if (__Pyx_IterFinish() == 0) __Pyx_RaiseNeedMoreValuesError(index);
    __PYX_ERR(0, 753, __pyx_L1_error)
    __pyx_L4_unpacking_done:;
  }
  if (!(likely(((__pyx_t_2) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_2, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 753, __pyx_L1_error)
  if (!(likely(((__pyx_t_4) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_4, __pyx_ptype_7cpython_4bool_bool))))) __PYX_ERR(0, 753, __pyx_L1_error)
  if (!(likely(((__pyx_t_3) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_3, __pyx_ptype_7cpython_4bool_bool))))) __PYX_ERR(0, 753, __pyx_L1_error)
  __Pyx_DECREF_SET(__pyx_v_x, ((PyArrayObject *)__pyx_t_2));
  __pyx_t_2 = 0;
  __pyx_v_flag = ((PyBoolObject *)__pyx_t_4);
  __pyx_t_4 = 0;
  __pyx_v_complexflag = ((PyBoolObject *)__pyx_t_3);
  __pyx_t_3 = 0;

  /* "orb/cutils.pyx":755
 *     (x, flag, complexflag) = _robust_format(x)
 * 
 *     if flag:             # <<<<<<<<<<<<<<
 *         if complexflag:
 *             complexresult.real = bn.nanmedian(x.real)
 */
  __pyx_t_7 = __Pyx_PyObject_IsTrue(((PyObject *)__pyx_v_flag)); if (unlikely(__pyx_t_7 < 0)) __PYX_ERR(0, 755, __pyx_L1_error)
  if (__pyx_t_7) {

    /* "orb/cutils.pyx":756
 * 
 *     if flag:
 *         if complexflag:             # <<<<<<<<<<<<<<
 *             complexresult.real = bn.nanmedian(x.real)
 *             complexresult.imag = bn.nanmedian(x.imag)
 */
    __pyx_t_7 = __Pyx_PyObject_IsTrue(((PyObject *)__pyx_v_complexflag)); if (unlikely(__pyx_t_7 < 0)) __PYX_ERR(0, 756, __pyx_L1_error)
    if (__pyx_t_7) {

      /* "orb/cutils.pyx":757
 *     if flag:
 *         if complexflag:
 *             complexresult.real = bn.nanmedian(x.real)             # <<<<<<<<<<<<<<
 *             complexresult.imag = bn.nanmedian(x.imag)
 *             return complexresult
 */
      __pyx_t_3 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 757, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_nanmedian); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 757, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      __pyx_t_3 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_x), __pyx_n_s_real); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 757, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __pyx_t_2 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_4))) {
        __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_4);
        if (likely(__pyx_t_2)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
          __Pyx_INCREF(__pyx_t_2);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_4, function);
        }
      }
      if (!__pyx_t_2) {
        __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_3); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 757, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
        __Pyx_GOTREF(__pyx_t_1);
      } else {
        __pyx_t_5 = PyTuple_New(1+1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 757, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_5);
        __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_2); __pyx_t_2 = NULL;
        __Pyx_GIVEREF(__pyx_t_3);
        PyTuple_SET_ITEM(__pyx_t_5, 0+1, __pyx_t_3);
        __pyx_t_3 = 0;
        __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_5, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 757, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_1);
        __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
      }
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __pyx_t_8 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_8 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 757, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
      __Pyx_SET_CREAL(__pyx_v_complexresult, __pyx_t_8);

      /* "orb/cutils.pyx":758
 *         if complexflag:
 *             complexresult.real = bn.nanmedian(x.real)
 *             complexresult.imag = bn.nanmedian(x.imag)             # <<<<<<<<<<<<<<
 *             return complexresult
 *         else:
 */
      __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 758, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_nanmedian); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 758, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __pyx_t_4 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_x), __pyx_n_s_imag); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 758, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __pyx_t_3 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_5))) {
        __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_5);
        if (likely(__pyx_t_3)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_5);
          __Pyx_INCREF(__pyx_t_3);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_5, function);
        }
      }
      if (!__pyx_t_3) {
        __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_5, __pyx_t_4); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 758, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
        __Pyx_GOTREF(__pyx_t_1);
      } else {
        __pyx_t_2 = PyTuple_New(1+1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 758, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_2);
        __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_3); __pyx_t_3 = NULL;
        __Pyx_GIVEREF(__pyx_t_4);
        PyTuple_SET_ITEM(__pyx_t_2, 0+1, __pyx_t_4);
        __pyx_t_4 = 0;
        __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_2, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 758, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_1);
        __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
      }
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
      __pyx_t_9 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_9 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 758, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
      __Pyx_SET_CIMAG(__pyx_v_complexresult, __pyx_t_9);

      /* "orb/cutils.pyx":759
 *             complexresult.real = bn.nanmedian(x.real)
 *             complexresult.imag = bn.nanmedian(x.imag)
 *             return complexresult             # <<<<<<<<<<<<<<
 *         else:
 *             return bn.nanmedian(x)
 */
      __Pyx_XDECREF(__pyx_r);
      __pyx_t_1 = __pyx_PyComplex_FromComplex(__pyx_v_complexresult); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 759, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);
      __pyx_r = __pyx_t_1;
      __pyx_t_1 = 0;
      goto __pyx_L0;

      /* "orb/cutils.pyx":756
 * 
 *     if flag:
 *         if complexflag:             # <<<<<<<<<<<<<<
 *             complexresult.real = bn.nanmedian(x.real)
 *             complexresult.imag = bn.nanmedian(x.imag)
 */
    }

    /* "orb/cutils.pyx":761
 *             return complexresult
 *         else:
 *             return bn.nanmedian(x)             # <<<<<<<<<<<<<<
 *     else:
 *         return np.median(x)
 */
    /*else*/ {
      __Pyx_XDECREF(__pyx_r);
      __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 761, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_nanmedian); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 761, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
      __pyx_t_5 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_2))) {
        __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_2);
        if (likely(__pyx_t_5)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
          __Pyx_INCREF(__pyx_t_5);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_2, function);
        }
      }
      if (!__pyx_t_5) {
        __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_2, ((PyObject *)__pyx_v_x)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 761, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_1);
      } else {
        __pyx_t_4 = PyTuple_New(1+1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 761, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_4);
        __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_5); __pyx_t_5 = NULL;
        __Pyx_INCREF(((PyObject *)__pyx_v_x));
        __Pyx_GIVEREF(((PyObject *)__pyx_v_x));
        PyTuple_SET_ITEM(__pyx_t_4, 0+1, ((PyObject *)__pyx_v_x));
        __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_4, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 761, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_1);
        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      }
      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
      __pyx_r = __pyx_t_1;
      __pyx_t_1 = 0;
      goto __pyx_L0;
    }

    /* "orb/cutils.pyx":755
 *     (x, flag, complexflag) = _robust_format(x)
 * 
 *     if flag:             # <<<<<<<<<<<<<<
 *         if complexflag:
 *             complexresult.real = bn.nanmedian(x.real)
 */
  }

  /* "orb/cutils.pyx":763
 *             return bn.nanmedian(x)
 *     else:
 *         return np.median(x)             # <<<<<<<<<<<<<<
 * 
 * def robust_sum(np.ndarray x):
 */
  /*else*/ {
    __Pyx_XDECREF(__pyx_r);
    __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 763, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_median); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 763, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __pyx_t_2 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_4))) {
      __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_4);
      if (likely(__pyx_t_2)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
        __Pyx_INCREF(__pyx_t_2);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_4, function);
      }
    }
    if (!__pyx_t_2) {
      __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_4, ((PyObject *)__pyx_v_x)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 763, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);
    } else {
      __pyx_t_5 = PyTuple_New(1+1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 763, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_2); __pyx_t_2 = NULL;
      __Pyx_INCREF(((PyObject *)__pyx_v_x));
      __Pyx_GIVEREF(((PyObject *)__pyx_v_x));
      PyTuple_SET_ITEM(__pyx_t_5, 0+1, ((PyObject *)__pyx_v_x));
      __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_5, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 763, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    }
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_r = __pyx_t_1;
    __pyx_t_1 = 0;
    goto __pyx_L0;
  }

  /* "orb/cutils.pyx":744
 * 
 * 
 * def robust_median(np.ndarray x):             # <<<<<<<<<<<<<<
 *     """Compute robust median of a numpy ndarray (NaNs are skipped)
 * 
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_1);
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_XDECREF(__pyx_t_5);
  __Pyx_AddTraceback("orb.cutils.robust_median", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_XDECREF((PyObject *)__pyx_v_flag);
  __Pyx_XDECREF((PyObject *)__pyx_v_complexflag);
  __Pyx_XDECREF((PyObject *)__pyx_v_x);
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":765
 *         return np.median(x)
 * 
 * def robust_sum(np.ndarray x):             # <<<<<<<<<<<<<<
 *     """Compute robust sum of a numpy ndarray (NaNs are skipped)
 * 
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_33robust_sum(PyObject *__pyx_self, PyObject *__pyx_v_x); /*proto*/
static char __pyx_doc_3orb_6cutils_32robust_sum[] = "robust_sum(ndarray x)\nCompute robust sum of a numpy ndarray (NaNs are skipped)\n\n    :param x: a numpy ndarray \n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_33robust_sum = {"robust_sum", (PyCFunction)__pyx_pw_3orb_6cutils_33robust_sum, METH_O, __pyx_doc_3orb_6cutils_32robust_sum};
static PyObject *__pyx_pw_3orb_6cutils_33robust_sum(PyObject *__pyx_self, PyObject *__pyx_v_x) {
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("robust_sum (wrapper)", 0);
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_x), __pyx_ptype_5numpy_ndarray, 1, "x", 0))) __PYX_ERR(0, 765, __pyx_L1_error)
  __pyx_r = __pyx_pf_3orb_6cutils_32robust_sum(__pyx_self, ((PyArrayObject *)__pyx_v_x));

  /* function exit code */
  goto __pyx_L0;
  __pyx_L1_error:;
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_32robust_sum(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_x) {
  PyBoolObject *__pyx_v_flag = 0;
  PyBoolObject *__pyx_v_complexflag = 0;
  __pyx_t_double_complex __pyx_v_complexresult;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  PyObject *__pyx_t_1 = NULL;
  PyObject *__pyx_t_2 = NULL;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  PyObject *__pyx_t_5 = NULL;
  PyObject *(*__pyx_t_6)(PyObject *);
  int __pyx_t_7;
  double __pyx_t_8;
  double __pyx_t_9;
  __Pyx_RefNannySetupContext("robust_sum", 0);
  __Pyx_INCREF((PyObject *)__pyx_v_x);

  /* "orb/cutils.pyx":774
 *     cdef complex complexresult
 * 
 *     (x, flag, complexflag) = _robust_format(x)             # <<<<<<<<<<<<<<
 * 
 *     if flag:
 */
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_robust_format); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 774, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_3 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_2))) {
    __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_2);
    if (likely(__pyx_t_3)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
      __Pyx_INCREF(__pyx_t_3);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_2, function);
    }
  }
  if (!__pyx_t_3) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_2, ((PyObject *)__pyx_v_x)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 774, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_4 = PyTuple_New(1+1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 774, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_3); __pyx_t_3 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_x));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_x));
    PyTuple_SET_ITEM(__pyx_t_4, 0+1, ((PyObject *)__pyx_v_x));
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_4, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 774, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  }
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  if ((likely(PyTuple_CheckExact(__pyx_t_1))) || (PyList_CheckExact(__pyx_t_1))) {
    PyObject* sequence = __pyx_t_1;
    #if CYTHON_COMPILING_IN_CPYTHON
    Py_ssize_t size = Py_SIZE(sequence);
    #else
    Py_ssize_t size = PySequence_Size(sequence);
    #endif
    if (unlikely(size != 3)) {
      if (size > 3) __Pyx_RaiseTooManyValuesError(3);
      else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
      __PYX_ERR(0, 774, __pyx_L1_error)
    }
    #if CYTHON_COMPILING_IN_CPYTHON
    if (likely(PyTuple_CheckExact(sequence))) {
      __pyx_t_2 = PyTuple_GET_ITEM(sequence, 0); 
      __pyx_t_4 = PyTuple_GET_ITEM(sequence, 1); 
      __pyx_t_3 = PyTuple_GET_ITEM(sequence, 2); 
    } else {
      __pyx_t_2 = PyList_GET_ITEM(sequence, 0); 
      __pyx_t_4 = PyList_GET_ITEM(sequence, 1); 
      __pyx_t_3 = PyList_GET_ITEM(sequence, 2); 
    }
    __Pyx_INCREF(__pyx_t_2);
    __Pyx_INCREF(__pyx_t_4);
    __Pyx_INCREF(__pyx_t_3);
    #else
    __pyx_t_2 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 774, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __pyx_t_4 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 774, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __pyx_t_3 = PySequence_ITEM(sequence, 2); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 774, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    #endif
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  } else {
    Py_ssize_t index = -1;
    __pyx_t_5 = PyObject_GetIter(__pyx_t_1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 774, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    __pyx_t_6 = Py_TYPE(__pyx_t_5)->tp_iternext;
    index = 0; __pyx_t_2 = __pyx_t_6(__pyx_t_5); if (unlikely(!__pyx_t_2)) goto __pyx_L3_unpacking_failed;
    __Pyx_GOTREF(__pyx_t_2);
    index = 1; __pyx_t_4 = __pyx_t_6(__pyx_t_5); if (unlikely(!__pyx_t_4)) goto __pyx_L3_unpacking_failed;
    __Pyx_GOTREF(__pyx_t_4);
    index = 2; __pyx_t_3 = __pyx_t_6(__pyx_t_5); if (unlikely(!__pyx_t_3)) goto __pyx_L3_unpacking_failed;
    __Pyx_GOTREF(__pyx_t_3);
    if (__Pyx_IternextUnpackEndCheck(__pyx_t_6(__pyx_t_5), 3) < 0) __PYX_ERR(0, 774, __pyx_L1_error)
    __pyx_t_6 = NULL;
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    goto __pyx_L4_unpacking_done;
    __pyx_L3_unpacking_failed:;
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    __pyx_t_6 = NULL;
    if (__Pyx_IterFinish() == 0) __Pyx_RaiseNeedMoreValuesError(index);
    __PYX_ERR(0, 774, __pyx_L1_error)
    __pyx_L4_unpacking_done:;
  }
  if (!(likely(((__pyx_t_2) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_2, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 774, __pyx_L1_error)
  if (!(likely(((__pyx_t_4) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_4, __pyx_ptype_7cpython_4bool_bool))))) __PYX_ERR(0, 774, __pyx_L1_error)
  if (!(likely(((__pyx_t_3) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_3, __pyx_ptype_7cpython_4bool_bool))))) __PYX_ERR(0, 774, __pyx_L1_error)
  __Pyx_DECREF_SET(__pyx_v_x, ((PyArrayObject *)__pyx_t_2));
  __pyx_t_2 = 0;
  __pyx_v_flag = ((PyBoolObject *)__pyx_t_4);
  __pyx_t_4 = 0;
  __pyx_v_complexflag = ((PyBoolObject *)__pyx_t_3);
  __pyx_t_3 = 0;

  /* "orb/cutils.pyx":776
 *     (x, flag, complexflag) = _robust_format(x)
 * 
 *     if flag:             # <<<<<<<<<<<<<<
 *         if complexflag:
 *             complexresult.real = bn.nansum(x.real)
 */
  __pyx_t_7 = __Pyx_PyObject_IsTrue(((PyObject *)__pyx_v_flag)); if (unlikely(__pyx_t_7 < 0)) __PYX_ERR(0, 776, __pyx_L1_error)
  if (__pyx_t_7) {

    /* "orb/cutils.pyx":777
 * 
 *     if flag:
 *         if complexflag:             # <<<<<<<<<<<<<<
 *             complexresult.real = bn.nansum(x.real)
 *             complexresult.imag = bn.nansum(x.imag)
 */
    __pyx_t_7 = __Pyx_PyObject_IsTrue(((PyObject *)__pyx_v_complexflag)); if (unlikely(__pyx_t_7 < 0)) __PYX_ERR(0, 777, __pyx_L1_error)
    if (__pyx_t_7) {

      /* "orb/cutils.pyx":778
 *     if flag:
 *         if complexflag:
 *             complexresult.real = bn.nansum(x.real)             # <<<<<<<<<<<<<<
 *             complexresult.imag = bn.nansum(x.imag)
 *             return complexresult
 */
      __pyx_t_3 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 778, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_nansum); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 778, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      __pyx_t_3 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_x), __pyx_n_s_real); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 778, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __pyx_t_2 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_4))) {
        __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_4);
        if (likely(__pyx_t_2)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
          __Pyx_INCREF(__pyx_t_2);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_4, function);
        }
      }
      if (!__pyx_t_2) {
        __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_3); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 778, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
        __Pyx_GOTREF(__pyx_t_1);
      } else {
        __pyx_t_5 = PyTuple_New(1+1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 778, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_5);
        __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_2); __pyx_t_2 = NULL;
        __Pyx_GIVEREF(__pyx_t_3);
        PyTuple_SET_ITEM(__pyx_t_5, 0+1, __pyx_t_3);
        __pyx_t_3 = 0;
        __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_5, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 778, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_1);
        __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
      }
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __pyx_t_8 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_8 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 778, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
      __Pyx_SET_CREAL(__pyx_v_complexresult, __pyx_t_8);

      /* "orb/cutils.pyx":779
 *         if complexflag:
 *             complexresult.real = bn.nansum(x.real)
 *             complexresult.imag = bn.nansum(x.imag)             # <<<<<<<<<<<<<<
 *             return complexresult
 *         else:
 */
      __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 779, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_nansum); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 779, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __pyx_t_4 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_x), __pyx_n_s_imag); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 779, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __pyx_t_3 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_5))) {
        __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_5);
        if (likely(__pyx_t_3)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_5);
          __Pyx_INCREF(__pyx_t_3);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_5, function);
        }
      }
      if (!__pyx_t_3) {
        __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_5, __pyx_t_4); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 779, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
        __Pyx_GOTREF(__pyx_t_1);
      } else {
        __pyx_t_2 = PyTuple_New(1+1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 779, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_2);
        __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_3); __pyx_t_3 = NULL;
        __Pyx_GIVEREF(__pyx_t_4);
        PyTuple_SET_ITEM(__pyx_t_2, 0+1, __pyx_t_4);
        __pyx_t_4 = 0;
        __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_2, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 779, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_1);
        __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
      }
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
      __pyx_t_9 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_9 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 779, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
      __Pyx_SET_CIMAG(__pyx_v_complexresult, __pyx_t_9);

      /* "orb/cutils.pyx":780
 *             complexresult.real = bn.nansum(x.real)
 *             complexresult.imag = bn.nansum(x.imag)
 *             return complexresult             # <<<<<<<<<<<<<<
 *         else:
 *             return bn.nansum(x)
 */
      __Pyx_XDECREF(__pyx_r);
      __pyx_t_1 = __pyx_PyComplex_FromComplex(__pyx_v_complexresult); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 780, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);
      __pyx_r = __pyx_t_1;
      __pyx_t_1 = 0;
      goto __pyx_L0;

      /* "orb/cutils.pyx":777
 * 
 *     if flag:
 *         if complexflag:             # <<<<<<<<<<<<<<
 *             complexresult.real = bn.nansum(x.real)
 *             complexresult.imag = bn.nansum(x.imag)
 */
    }

    /* "orb/cutils.pyx":782
 *             return complexresult
 *         else:
 *             return bn.nansum(x)             # <<<<<<<<<<<<<<
 *     else:
 *         return np.nansum(x)
 */
    /*else*/ {
      __Pyx_XDECREF(__pyx_r);
      __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 782, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_nansum); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 782, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
      __pyx_t_5 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_2))) {
        __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_2);
        if (likely(__pyx_t_5)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
          __Pyx_INCREF(__pyx_t_5);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_2, function);
        }
      }
      if (!__pyx_t_5) {
        __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_2, ((PyObject *)__pyx_v_x)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 782, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_1);
      } else {
        __pyx_t_4 = PyTuple_New(1+1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 782, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_4);
        __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_5); __pyx_t_5 = NULL;
        __Pyx_INCREF(((PyObject *)__pyx_v_x));
        __Pyx_GIVEREF(((PyObject *)__pyx_v_x));
        PyTuple_SET_ITEM(__pyx_t_4, 0+1, ((PyObject *)__pyx_v_x));
        __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_4, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 782, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_1);
        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      }
      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
      __pyx_r = __pyx_t_1;
      __pyx_t_1 = 0;
      goto __pyx_L0;
    }

    /* "orb/cutils.pyx":776
 *     (x, flag, complexflag) = _robust_format(x)
 * 
 *     if flag:             # <<<<<<<<<<<<<<
 *         if complexflag:
 *             complexresult.real = bn.nansum(x.real)
 */
  }

  /* "orb/cutils.pyx":784
 *             return bn.nansum(x)
 *     else:
 *         return np.nansum(x)             # <<<<<<<<<<<<<<
 * 
 * def robust_std(np.ndarray x):
 */
  /*else*/ {
    __Pyx_XDECREF(__pyx_r);
    __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 784, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_nansum); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 784, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __pyx_t_2 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_4))) {
      __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_4);
      if (likely(__pyx_t_2)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
        __Pyx_INCREF(__pyx_t_2);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_4, function);
      }
    }
    if (!__pyx_t_2) {
      __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_4, ((PyObject *)__pyx_v_x)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 784, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);
    } else {
      __pyx_t_5 = PyTuple_New(1+1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 784, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_2); __pyx_t_2 = NULL;
      __Pyx_INCREF(((PyObject *)__pyx_v_x));
      __Pyx_GIVEREF(((PyObject *)__pyx_v_x));
      PyTuple_SET_ITEM(__pyx_t_5, 0+1, ((PyObject *)__pyx_v_x));
      __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_5, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 784, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    }
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_r = __pyx_t_1;
    __pyx_t_1 = 0;
    goto __pyx_L0;
  }

  /* "orb/cutils.pyx":765
 *         return np.median(x)
 * 
 * def robust_sum(np.ndarray x):             # <<<<<<<<<<<<<<
 *     """Compute robust sum of a numpy ndarray (NaNs are skipped)
 * 
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_1);
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_XDECREF(__pyx_t_5);
  __Pyx_AddTraceback("orb.cutils.robust_sum", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_XDECREF((PyObject *)__pyx_v_flag);
  __Pyx_XDECREF((PyObject *)__pyx_v_complexflag);
  __Pyx_XDECREF((PyObject *)__pyx_v_x);
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":786
 *         return np.nansum(x)
 * 
 * def robust_std(np.ndarray x):             # <<<<<<<<<<<<<<
 *     """Compute robust std of a numpy ndarray (NaNs are skipped)
 * 
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_35robust_std(PyObject *__pyx_self, PyObject *__pyx_v_x); /*proto*/
static char __pyx_doc_3orb_6cutils_34robust_std[] = "robust_std(ndarray x)\nCompute robust std of a numpy ndarray (NaNs are skipped)\n\n    :param x: a numpy ndarray \n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_35robust_std = {"robust_std", (PyCFunction)__pyx_pw_3orb_6cutils_35robust_std, METH_O, __pyx_doc_3orb_6cutils_34robust_std};
static PyObject *__pyx_pw_3orb_6cutils_35robust_std(PyObject *__pyx_self, PyObject *__pyx_v_x) {
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("robust_std (wrapper)", 0);
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_x), __pyx_ptype_5numpy_ndarray, 1, "x", 0))) __PYX_ERR(0, 786, __pyx_L1_error)
  __pyx_r = __pyx_pf_3orb_6cutils_34robust_std(__pyx_self, ((PyArrayObject *)__pyx_v_x));

  /* function exit code */
  goto __pyx_L0;
  __pyx_L1_error:;
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_34robust_std(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_x) {
  PyBoolObject *__pyx_v_flag = 0;
  PyBoolObject *__pyx_v_complexflag = 0;
  __pyx_t_double_complex __pyx_v_complexresult;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  PyObject *__pyx_t_1 = NULL;
  PyObject *__pyx_t_2 = NULL;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  PyObject *__pyx_t_5 = NULL;
  PyObject *(*__pyx_t_6)(PyObject *);
  int __pyx_t_7;
  double __pyx_t_8;
  double __pyx_t_9;
  __Pyx_RefNannySetupContext("robust_std", 0);
  __Pyx_INCREF((PyObject *)__pyx_v_x);

  /* "orb/cutils.pyx":795
 *     cdef complex complexresult
 * 
 *     (x, flag, complexflag) = _robust_format(x)             # <<<<<<<<<<<<<<
 * 
 *     if flag:
 */
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_robust_format); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 795, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_3 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_2))) {
    __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_2);
    if (likely(__pyx_t_3)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
      __Pyx_INCREF(__pyx_t_3);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_2, function);
    }
  }
  if (!__pyx_t_3) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_2, ((PyObject *)__pyx_v_x)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 795, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_4 = PyTuple_New(1+1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 795, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_3); __pyx_t_3 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_x));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_x));
    PyTuple_SET_ITEM(__pyx_t_4, 0+1, ((PyObject *)__pyx_v_x));
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_4, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 795, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  }
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  if ((likely(PyTuple_CheckExact(__pyx_t_1))) || (PyList_CheckExact(__pyx_t_1))) {
    PyObject* sequence = __pyx_t_1;
    #if CYTHON_COMPILING_IN_CPYTHON
    Py_ssize_t size = Py_SIZE(sequence);
    #else
    Py_ssize_t size = PySequence_Size(sequence);
    #endif
    if (unlikely(size != 3)) {
      if (size > 3) __Pyx_RaiseTooManyValuesError(3);
      else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
      __PYX_ERR(0, 795, __pyx_L1_error)
    }
    #if CYTHON_COMPILING_IN_CPYTHON
    if (likely(PyTuple_CheckExact(sequence))) {
      __pyx_t_2 = PyTuple_GET_ITEM(sequence, 0); 
      __pyx_t_4 = PyTuple_GET_ITEM(sequence, 1); 
      __pyx_t_3 = PyTuple_GET_ITEM(sequence, 2); 
    } else {
      __pyx_t_2 = PyList_GET_ITEM(sequence, 0); 
      __pyx_t_4 = PyList_GET_ITEM(sequence, 1); 
      __pyx_t_3 = PyList_GET_ITEM(sequence, 2); 
    }
    __Pyx_INCREF(__pyx_t_2);
    __Pyx_INCREF(__pyx_t_4);
    __Pyx_INCREF(__pyx_t_3);
    #else
    __pyx_t_2 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 795, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __pyx_t_4 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 795, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __pyx_t_3 = PySequence_ITEM(sequence, 2); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 795, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    #endif
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  } else {
    Py_ssize_t index = -1;
    __pyx_t_5 = PyObject_GetIter(__pyx_t_1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 795, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    __pyx_t_6 = Py_TYPE(__pyx_t_5)->tp_iternext;
    index = 0; __pyx_t_2 = __pyx_t_6(__pyx_t_5); if (unlikely(!__pyx_t_2)) goto __pyx_L3_unpacking_failed;
    __Pyx_GOTREF(__pyx_t_2);
    index = 1; __pyx_t_4 = __pyx_t_6(__pyx_t_5); if (unlikely(!__pyx_t_4)) goto __pyx_L3_unpacking_failed;
    __Pyx_GOTREF(__pyx_t_4);
    index = 2; __pyx_t_3 = __pyx_t_6(__pyx_t_5); if (unlikely(!__pyx_t_3)) goto __pyx_L3_unpacking_failed;
    __Pyx_GOTREF(__pyx_t_3);
    if (__Pyx_IternextUnpackEndCheck(__pyx_t_6(__pyx_t_5), 3) < 0) __PYX_ERR(0, 795, __pyx_L1_error)
    __pyx_t_6 = NULL;
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    goto __pyx_L4_unpacking_done;
    __pyx_L3_unpacking_failed:;
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    __pyx_t_6 = NULL;
    if (__Pyx_IterFinish() == 0) __Pyx_RaiseNeedMoreValuesError(index);
    __PYX_ERR(0, 795, __pyx_L1_error)
    __pyx_L4_unpacking_done:;
  }
  if (!(likely(((__pyx_t_2) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_2, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 795, __pyx_L1_error)
  if (!(likely(((__pyx_t_4) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_4, __pyx_ptype_7cpython_4bool_bool))))) __PYX_ERR(0, 795, __pyx_L1_error)
  if (!(likely(((__pyx_t_3) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_3, __pyx_ptype_7cpython_4bool_bool))))) __PYX_ERR(0, 795, __pyx_L1_error)
  __Pyx_DECREF_SET(__pyx_v_x, ((PyArrayObject *)__pyx_t_2));
  __pyx_t_2 = 0;
  __pyx_v_flag = ((PyBoolObject *)__pyx_t_4);
  __pyx_t_4 = 0;
  __pyx_v_complexflag = ((PyBoolObject *)__pyx_t_3);
  __pyx_t_3 = 0;

  /* "orb/cutils.pyx":797
 *     (x, flag, complexflag) = _robust_format(x)
 * 
 *     if flag:             # <<<<<<<<<<<<<<
 *         if complexflag:
 *             complexresult.real = bn.nanstd(x.real)
 */
  __pyx_t_7 = __Pyx_PyObject_IsTrue(((PyObject *)__pyx_v_flag)); if (unlikely(__pyx_t_7 < 0)) __PYX_ERR(0, 797, __pyx_L1_error)
  if (__pyx_t_7) {

    /* "orb/cutils.pyx":798
 * 
 *     if flag:
 *         if complexflag:             # <<<<<<<<<<<<<<
 *             complexresult.real = bn.nanstd(x.real)
 *             complexresult.imag = bn.nanstd(x.imag)
 */
    __pyx_t_7 = __Pyx_PyObject_IsTrue(((PyObject *)__pyx_v_complexflag)); if (unlikely(__pyx_t_7 < 0)) __PYX_ERR(0, 798, __pyx_L1_error)
    if (__pyx_t_7) {

      /* "orb/cutils.pyx":799
 *     if flag:
 *         if complexflag:
 *             complexresult.real = bn.nanstd(x.real)             # <<<<<<<<<<<<<<
 *             complexresult.imag = bn.nanstd(x.imag)
 *             return complexresult
 */
      __pyx_t_3 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 799, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_nanstd); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 799, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      __pyx_t_3 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_x), __pyx_n_s_real); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 799, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __pyx_t_2 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_4))) {
        __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_4);
        if (likely(__pyx_t_2)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
          __Pyx_INCREF(__pyx_t_2);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_4, function);
        }
      }
      if (!__pyx_t_2) {
        __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_3); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 799, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
        __Pyx_GOTREF(__pyx_t_1);
      } else {
        __pyx_t_5 = PyTuple_New(1+1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 799, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_5);
        __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_2); __pyx_t_2 = NULL;
        __Pyx_GIVEREF(__pyx_t_3);
        PyTuple_SET_ITEM(__pyx_t_5, 0+1, __pyx_t_3);
        __pyx_t_3 = 0;
        __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_5, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 799, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_1);
        __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
      }
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __pyx_t_8 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_8 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 799, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
      __Pyx_SET_CREAL(__pyx_v_complexresult, __pyx_t_8);

      /* "orb/cutils.pyx":800
 *         if complexflag:
 *             complexresult.real = bn.nanstd(x.real)
 *             complexresult.imag = bn.nanstd(x.imag)             # <<<<<<<<<<<<<<
 *             return complexresult
 *         else:
 */
      __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 800, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_nanstd); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 800, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __pyx_t_4 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_x), __pyx_n_s_imag); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 800, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __pyx_t_3 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_5))) {
        __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_5);
        if (likely(__pyx_t_3)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_5);
          __Pyx_INCREF(__pyx_t_3);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_5, function);
        }
      }
      if (!__pyx_t_3) {
        __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_5, __pyx_t_4); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 800, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
        __Pyx_GOTREF(__pyx_t_1);
      } else {
        __pyx_t_2 = PyTuple_New(1+1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 800, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_2);
        __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_3); __pyx_t_3 = NULL;
        __Pyx_GIVEREF(__pyx_t_4);
        PyTuple_SET_ITEM(__pyx_t_2, 0+1, __pyx_t_4);
        __pyx_t_4 = 0;
        __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_2, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 800, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_1);
        __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
      }
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
      __pyx_t_9 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_9 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 800, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
      __Pyx_SET_CIMAG(__pyx_v_complexresult, __pyx_t_9);

      /* "orb/cutils.pyx":801
 *             complexresult.real = bn.nanstd(x.real)
 *             complexresult.imag = bn.nanstd(x.imag)
 *             return complexresult             # <<<<<<<<<<<<<<
 *         else:
 *             return bn.nanstd(x)
 */
      __Pyx_XDECREF(__pyx_r);
      __pyx_t_1 = __pyx_PyComplex_FromComplex(__pyx_v_complexresult); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 801, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);
      __pyx_r = __pyx_t_1;
      __pyx_t_1 = 0;
      goto __pyx_L0;

      /* "orb/cutils.pyx":798
 * 
 *     if flag:
 *         if complexflag:             # <<<<<<<<<<<<<<
 *             complexresult.real = bn.nanstd(x.real)
 *             complexresult.imag = bn.nanstd(x.imag)
 */
    }

    /* "orb/cutils.pyx":803
 *             return complexresult
 *         else:
 *             return bn.nanstd(x)             # <<<<<<<<<<<<<<
 *     else:
 *         return np.nanstd(x)
 */
    /*else*/ {
      __Pyx_XDECREF(__pyx_r);
      __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 803, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_nanstd); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 803, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
      __pyx_t_5 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_2))) {
        __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_2);
        if (likely(__pyx_t_5)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
          __Pyx_INCREF(__pyx_t_5);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_2, function);
        }
      }
      if (!__pyx_t_5) {
        __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_2, ((PyObject *)__pyx_v_x)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 803, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_1);
      } else {
        __pyx_t_4 = PyTuple_New(1+1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 803, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_4);
        __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_5); __pyx_t_5 = NULL;
        __Pyx_INCREF(((PyObject *)__pyx_v_x));
        __Pyx_GIVEREF(((PyObject *)__pyx_v_x));
        PyTuple_SET_ITEM(__pyx_t_4, 0+1, ((PyObject *)__pyx_v_x));
        __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_4, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 803, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_1);
        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      }
      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
      __pyx_r = __pyx_t_1;
      __pyx_t_1 = 0;
      goto __pyx_L0;
    }

    /* "orb/cutils.pyx":797
 *     (x, flag, complexflag) = _robust_format(x)
 * 
 *     if flag:             # <<<<<<<<<<<<<<
 *         if complexflag:
 *             complexresult.real = bn.nanstd(x.real)
 */
  }

  /* "orb/cutils.pyx":805
 *             return bn.nanstd(x)
 *     else:
 *         return np.nanstd(x)             # <<<<<<<<<<<<<<
 * 
 * def robust_average(np.ndarray x,
 */
  /*else*/ {
    __Pyx_XDECREF(__pyx_r);
    __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 805, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_nanstd); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 805, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __pyx_t_2 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_4))) {
      __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_4);
      if (likely(__pyx_t_2)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
        __Pyx_INCREF(__pyx_t_2);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_4, function);
      }
    }
    if (!__pyx_t_2) {
      __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_4, ((PyObject *)__pyx_v_x)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 805, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);
    } else {
      __pyx_t_5 = PyTuple_New(1+1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 805, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_2); __pyx_t_2 = NULL;
      __Pyx_INCREF(((PyObject *)__pyx_v_x));
      __Pyx_GIVEREF(((PyObject *)__pyx_v_x));
      PyTuple_SET_ITEM(__pyx_t_5, 0+1, ((PyObject *)__pyx_v_x));
      __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_5, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 805, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    }
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_r = __pyx_t_1;
    __pyx_t_1 = 0;
    goto __pyx_L0;
  }

  /* "orb/cutils.pyx":786
 *         return np.nansum(x)
 * 
 * def robust_std(np.ndarray x):             # <<<<<<<<<<<<<<
 *     """Compute robust std of a numpy ndarray (NaNs are skipped)
 * 
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_1);
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_XDECREF(__pyx_t_5);
  __Pyx_AddTraceback("orb.cutils.robust_std", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_XDECREF((PyObject *)__pyx_v_flag);
  __Pyx_XDECREF((PyObject *)__pyx_v_complexflag);
  __Pyx_XDECREF((PyObject *)__pyx_v_x);
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":807
 *         return np.nanstd(x)
 * 
 * def robust_average(np.ndarray x,             # <<<<<<<<<<<<<<
 *                    np.ndarray w):
 *     """Compute robust average of a numpy ndarray (NaNs are skipped)
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_37robust_average(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_3orb_6cutils_36robust_average[] = "robust_average(ndarray x, ndarray w)\nCompute robust average of a numpy ndarray (NaNs are skipped)\n\n    :param x: a numpy ndarray\n    :param w: a numpy ndarray of weigths\n\n    .. note:: To get a weighted average the MEAN of the weights must\n      be equal to 1.\n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_37robust_average = {"robust_average", (PyCFunction)__pyx_pw_3orb_6cutils_37robust_average, METH_VARARGS|METH_KEYWORDS, __pyx_doc_3orb_6cutils_36robust_average};
static PyObject *__pyx_pw_3orb_6cutils_37robust_average(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  PyArrayObject *__pyx_v_x = 0;
  PyArrayObject *__pyx_v_w = 0;
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("robust_average (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_x,&__pyx_n_s_w,0};
    PyObject* values[2] = {0,0};
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
      switch (pos_args) {
        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = PyDict_Size(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_x)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        case  1:
        if (likely((values[1] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_w)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("robust_average", 1, 2, 2, 1); __PYX_ERR(0, 807, __pyx_L3_error)
        }
      }
      if (unlikely(kw_args > 0)) {
        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "robust_average") < 0)) __PYX_ERR(0, 807, __pyx_L3_error)
      }
    } else if (PyTuple_GET_SIZE(__pyx_args) != 2) {
      goto __pyx_L5_argtuple_error;
    } else {
      values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
      values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
    }
    __pyx_v_x = ((PyArrayObject *)values[0]);
    __pyx_v_w = ((PyArrayObject *)values[1]);
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  __Pyx_RaiseArgtupleInvalid("robust_average", 1, 2, 2, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 807, __pyx_L3_error)
  __pyx_L3_error:;
  __Pyx_AddTraceback("orb.cutils.robust_average", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __Pyx_RefNannyFinishContext();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_x), __pyx_ptype_5numpy_ndarray, 1, "x", 0))) __PYX_ERR(0, 807, __pyx_L1_error)
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_w), __pyx_ptype_5numpy_ndarray, 1, "w", 0))) __PYX_ERR(0, 808, __pyx_L1_error)
  __pyx_r = __pyx_pf_3orb_6cutils_36robust_average(__pyx_self, __pyx_v_x, __pyx_v_w);

  /* function exit code */
  goto __pyx_L0;
  __pyx_L1_error:;
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_36robust_average(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_x, PyArrayObject *__pyx_v_w) {
  PyBoolObject *__pyx_v_flagx = 0;
  PyBoolObject *__pyx_v_flagw = 0;
  PyBoolObject *__pyx_v_complexflagx = 0;
  PyBoolObject *__pyx_v_complexflagw = 0;
  __pyx_t_double_complex __pyx_v_complexresult;
  int __pyx_v_i;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  PyObject *__pyx_t_1 = NULL;
  PyObject *__pyx_t_2 = NULL;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  PyObject *__pyx_t_5 = NULL;
  PyObject *(*__pyx_t_6)(PyObject *);
  int __pyx_t_7;
  int __pyx_t_8;
  int __pyx_t_9;
  int __pyx_t_10;
  double __pyx_t_11;
  double __pyx_t_12;
  __Pyx_RefNannySetupContext("robust_average", 0);
  __Pyx_INCREF((PyObject *)__pyx_v_x);
  __Pyx_INCREF((PyObject *)__pyx_v_w);

  /* "orb/cutils.pyx":824
 *     cdef int i
 * 
 *     (x, flagx, complexflagx) = _robust_format(x)             # <<<<<<<<<<<<<<
 *     (w, flagw, complexflagw) = _robust_format(w)
 * 
 */
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_robust_format); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 824, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_3 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_2))) {
    __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_2);
    if (likely(__pyx_t_3)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
      __Pyx_INCREF(__pyx_t_3);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_2, function);
    }
  }
  if (!__pyx_t_3) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_2, ((PyObject *)__pyx_v_x)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 824, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_4 = PyTuple_New(1+1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 824, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_3); __pyx_t_3 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_x));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_x));
    PyTuple_SET_ITEM(__pyx_t_4, 0+1, ((PyObject *)__pyx_v_x));
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_4, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 824, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  }
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  if ((likely(PyTuple_CheckExact(__pyx_t_1))) || (PyList_CheckExact(__pyx_t_1))) {
    PyObject* sequence = __pyx_t_1;
    #if CYTHON_COMPILING_IN_CPYTHON
    Py_ssize_t size = Py_SIZE(sequence);
    #else
    Py_ssize_t size = PySequence_Size(sequence);
    #endif
    if (unlikely(size != 3)) {
      if (size > 3) __Pyx_RaiseTooManyValuesError(3);
      else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
      __PYX_ERR(0, 824, __pyx_L1_error)
    }
    #if CYTHON_COMPILING_IN_CPYTHON
    if (likely(PyTuple_CheckExact(sequence))) {
      __pyx_t_2 = PyTuple_GET_ITEM(sequence, 0); 
      __pyx_t_4 = PyTuple_GET_ITEM(sequence, 1); 
      __pyx_t_3 = PyTuple_GET_ITEM(sequence, 2); 
    } else {
      __pyx_t_2 = PyList_GET_ITEM(sequence, 0); 
      __pyx_t_4 = PyList_GET_ITEM(sequence, 1); 
      __pyx_t_3 = PyList_GET_ITEM(sequence, 2); 
    }
    __Pyx_INCREF(__pyx_t_2);
    __Pyx_INCREF(__pyx_t_4);
    __Pyx_INCREF(__pyx_t_3);
    #else
    __pyx_t_2 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 824, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __pyx_t_4 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 824, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __pyx_t_3 = PySequence_ITEM(sequence, 2); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 824, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    #endif
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  } else {
    Py_ssize_t index = -1;
    __pyx_t_5 = PyObject_GetIter(__pyx_t_1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 824, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    __pyx_t_6 = Py_TYPE(__pyx_t_5)->tp_iternext;
    index = 0; __pyx_t_2 = __pyx_t_6(__pyx_t_5); if (unlikely(!__pyx_t_2)) goto __pyx_L3_unpacking_failed;
    __Pyx_GOTREF(__pyx_t_2);
    index = 1; __pyx_t_4 = __pyx_t_6(__pyx_t_5); if (unlikely(!__pyx_t_4)) goto __pyx_L3_unpacking_failed;
    __Pyx_GOTREF(__pyx_t_4);
    index = 2; __pyx_t_3 = __pyx_t_6(__pyx_t_5); if (unlikely(!__pyx_t_3)) goto __pyx_L3_unpacking_failed;
    __Pyx_GOTREF(__pyx_t_3);
    if (__Pyx_IternextUnpackEndCheck(__pyx_t_6(__pyx_t_5), 3) < 0) __PYX_ERR(0, 824, __pyx_L1_error)
    __pyx_t_6 = NULL;
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    goto __pyx_L4_unpacking_done;
    __pyx_L3_unpacking_failed:;
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    __pyx_t_6 = NULL;
    if (__Pyx_IterFinish() == 0) __Pyx_RaiseNeedMoreValuesError(index);
    __PYX_ERR(0, 824, __pyx_L1_error)
    __pyx_L4_unpacking_done:;
  }
  if (!(likely(((__pyx_t_2) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_2, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 824, __pyx_L1_error)
  if (!(likely(((__pyx_t_4) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_4, __pyx_ptype_7cpython_4bool_bool))))) __PYX_ERR(0, 824, __pyx_L1_error)
  if (!(likely(((__pyx_t_3) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_3, __pyx_ptype_7cpython_4bool_bool))))) __PYX_ERR(0, 824, __pyx_L1_error)
  __Pyx_DECREF_SET(__pyx_v_x, ((PyArrayObject *)__pyx_t_2));
  __pyx_t_2 = 0;
  __pyx_v_flagx = ((PyBoolObject *)__pyx_t_4);
  __pyx_t_4 = 0;
  __pyx_v_complexflagx = ((PyBoolObject *)__pyx_t_3);
  __pyx_t_3 = 0;

  /* "orb/cutils.pyx":825
 * 
 *     (x, flagx, complexflagx) = _robust_format(x)
 *     (w, flagw, complexflagw) = _robust_format(w)             # <<<<<<<<<<<<<<
 * 
 *     if x.ndim == w.ndim:
 */
  __pyx_t_3 = __Pyx_GetModuleGlobalName(__pyx_n_s_robust_format); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 825, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_4 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_3))) {
    __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_3);
    if (likely(__pyx_t_4)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
      __Pyx_INCREF(__pyx_t_4);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_3, function);
    }
  }
  if (!__pyx_t_4) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_3, ((PyObject *)__pyx_v_w)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 825, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_2 = PyTuple_New(1+1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 825, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_4); __pyx_t_4 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_w));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_w));
    PyTuple_SET_ITEM(__pyx_t_2, 0+1, ((PyObject *)__pyx_v_w));
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_2, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 825, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  }
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  if ((likely(PyTuple_CheckExact(__pyx_t_1))) || (PyList_CheckExact(__pyx_t_1))) {
    PyObject* sequence = __pyx_t_1;
    #if CYTHON_COMPILING_IN_CPYTHON
    Py_ssize_t size = Py_SIZE(sequence);
    #else
    Py_ssize_t size = PySequence_Size(sequence);
    #endif
    if (unlikely(size != 3)) {
      if (size > 3) __Pyx_RaiseTooManyValuesError(3);
      else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
      __PYX_ERR(0, 825, __pyx_L1_error)
    }
    #if CYTHON_COMPILING_IN_CPYTHON
    if (likely(PyTuple_CheckExact(sequence))) {
      __pyx_t_3 = PyTuple_GET_ITEM(sequence, 0); 
      __pyx_t_2 = PyTuple_GET_ITEM(sequence, 1); 
      __pyx_t_4 = PyTuple_GET_ITEM(sequence, 2); 
    } else {
      __pyx_t_3 = PyList_GET_ITEM(sequence, 0); 
      __pyx_t_2 = PyList_GET_ITEM(sequence, 1); 
      __pyx_t_4 = PyList_GET_ITEM(sequence, 2); 
    }
    __Pyx_INCREF(__pyx_t_3);
    __Pyx_INCREF(__pyx_t_2);
    __Pyx_INCREF(__pyx_t_4);
    #else
    __pyx_t_3 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 825, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __pyx_t_2 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 825, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __pyx_t_4 = PySequence_ITEM(sequence, 2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 825, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    #endif
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  } else {
    Py_ssize_t index = -1;
    __pyx_t_5 = PyObject_GetIter(__pyx_t_1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 825, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    __pyx_t_6 = Py_TYPE(__pyx_t_5)->tp_iternext;
    index = 0; __pyx_t_3 = __pyx_t_6(__pyx_t_5); if (unlikely(!__pyx_t_3)) goto __pyx_L5_unpacking_failed;
    __Pyx_GOTREF(__pyx_t_3);
    index = 1; __pyx_t_2 = __pyx_t_6(__pyx_t_5); if (unlikely(!__pyx_t_2)) goto __pyx_L5_unpacking_failed;
    __Pyx_GOTREF(__pyx_t_2);
    index = 2; __pyx_t_4 = __pyx_t_6(__pyx_t_5); if (unlikely(!__pyx_t_4)) goto __pyx_L5_unpacking_failed;
    __Pyx_GOTREF(__pyx_t_4);
    if (__Pyx_IternextUnpackEndCheck(__pyx_t_6(__pyx_t_5), 3) < 0) __PYX_ERR(0, 825, __pyx_L1_error)
    __pyx_t_6 = NULL;
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    goto __pyx_L6_unpacking_done;
    __pyx_L5_unpacking_failed:;
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    __pyx_t_6 = NULL;
    if (__Pyx_IterFinish() == 0) __Pyx_RaiseNeedMoreValuesError(index);
    __PYX_ERR(0, 825, __pyx_L1_error)
    __pyx_L6_unpacking_done:;
  }
  if (!(likely(((__pyx_t_3) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_3, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 825, __pyx_L1_error)
  if (!(likely(((__pyx_t_2) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_2, __pyx_ptype_7cpython_4bool_bool))))) __PYX_ERR(0, 825, __pyx_L1_error)
  if (!(likely(((__pyx_t_4) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_4, __pyx_ptype_7cpython_4bool_bool))))) __PYX_ERR(0, 825, __pyx_L1_error)
  __Pyx_DECREF_SET(__pyx_v_w, ((PyArrayObject *)__pyx_t_3));
  __pyx_t_3 = 0;
  __pyx_v_flagw = ((PyBoolObject *)__pyx_t_2);
  __pyx_t_2 = 0;
  __pyx_v_complexflagw = ((PyBoolObject *)__pyx_t_4);
  __pyx_t_4 = 0;

  /* "orb/cutils.pyx":827
 *     (w, flagw, complexflagw) = _robust_format(w)
 * 
 *     if x.ndim == w.ndim:             # <<<<<<<<<<<<<<
 *         for i in range(x.ndim):
 *             if x.shape[i] != w.shape[i]:
 */
  __pyx_t_7 = ((__pyx_v_x->nd == __pyx_v_w->nd) != 0);
  if (__pyx_t_7) {

    /* "orb/cutils.pyx":828
 * 
 *     if x.ndim == w.ndim:
 *         for i in range(x.ndim):             # <<<<<<<<<<<<<<
 *             if x.shape[i] != w.shape[i]:
 *                 raise Exception('Array and weights must have same shape')
 */
    __pyx_t_8 = __pyx_v_x->nd;
    for (__pyx_t_9 = 0; __pyx_t_9 < __pyx_t_8; __pyx_t_9+=1) {
      __pyx_v_i = __pyx_t_9;

      /* "orb/cutils.pyx":829
 *     if x.ndim == w.ndim:
 *         for i in range(x.ndim):
 *             if x.shape[i] != w.shape[i]:             # <<<<<<<<<<<<<<
 *                 raise Exception('Array and weights must have same shape')
 *     else:
 */
      __pyx_t_7 = (((__pyx_v_x->dimensions[__pyx_v_i]) != (__pyx_v_w->dimensions[__pyx_v_i])) != 0);
      if (__pyx_t_7) {

        /* "orb/cutils.pyx":830
 *         for i in range(x.ndim):
 *             if x.shape[i] != w.shape[i]:
 *                 raise Exception('Array and weights must have same shape')             # <<<<<<<<<<<<<<
 *     else:
 *         raise Exception('Array and weights must have same number of dimensions')
 */
        __pyx_t_1 = __Pyx_PyObject_Call(__pyx_builtin_Exception, __pyx_tuple__47, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 830, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_1);
        __Pyx_Raise(__pyx_t_1, 0, 0, 0);
        __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
        __PYX_ERR(0, 830, __pyx_L1_error)

        /* "orb/cutils.pyx":829
 *     if x.ndim == w.ndim:
 *         for i in range(x.ndim):
 *             if x.shape[i] != w.shape[i]:             # <<<<<<<<<<<<<<
 *                 raise Exception('Array and weights must have same shape')
 *     else:
 */
      }
    }

    /* "orb/cutils.pyx":827
 *     (w, flagw, complexflagw) = _robust_format(w)
 * 
 *     if x.ndim == w.ndim:             # <<<<<<<<<<<<<<
 *         for i in range(x.ndim):
 *             if x.shape[i] != w.shape[i]:
 */
    goto __pyx_L7;
  }

  /* "orb/cutils.pyx":832
 *                 raise Exception('Array and weights must have same shape')
 *     else:
 *         raise Exception('Array and weights must have same number of dimensions')             # <<<<<<<<<<<<<<
 * 
 *     if flagx and flagw:
 */
  /*else*/ {
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_builtin_Exception, __pyx_tuple__48, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 832, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_Raise(__pyx_t_1, 0, 0, 0);
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    __PYX_ERR(0, 832, __pyx_L1_error)
  }
  __pyx_L7:;

  /* "orb/cutils.pyx":834
 *         raise Exception('Array and weights must have same number of dimensions')
 * 
 *     if flagx and flagw:             # <<<<<<<<<<<<<<
 *         if complexflagx or complexflagw:
 *             complexresult.real = bn.nanmean(x.real * w.real)
 */
  __pyx_t_10 = __Pyx_PyObject_IsTrue(((PyObject *)__pyx_v_flagx)); if (unlikely(__pyx_t_10 < 0)) __PYX_ERR(0, 834, __pyx_L1_error)
  if (__pyx_t_10) {
  } else {
    __pyx_t_7 = __pyx_t_10;
    goto __pyx_L12_bool_binop_done;
  }
  __pyx_t_10 = __Pyx_PyObject_IsTrue(((PyObject *)__pyx_v_flagw)); if (unlikely(__pyx_t_10 < 0)) __PYX_ERR(0, 834, __pyx_L1_error)
  __pyx_t_7 = __pyx_t_10;
  __pyx_L12_bool_binop_done:;
  if (__pyx_t_7) {

    /* "orb/cutils.pyx":835
 * 
 *     if flagx and flagw:
 *         if complexflagx or complexflagw:             # <<<<<<<<<<<<<<
 *             complexresult.real = bn.nanmean(x.real * w.real)
 *             complexresult.imag = bn.nanmean(x.imag * w.imag)
 */
    __pyx_t_10 = __Pyx_PyObject_IsTrue(((PyObject *)__pyx_v_complexflagx)); if (unlikely(__pyx_t_10 < 0)) __PYX_ERR(0, 835, __pyx_L1_error)
    if (!__pyx_t_10) {
    } else {
      __pyx_t_7 = __pyx_t_10;
      goto __pyx_L15_bool_binop_done;
    }
    __pyx_t_10 = __Pyx_PyObject_IsTrue(((PyObject *)__pyx_v_complexflagw)); if (unlikely(__pyx_t_10 < 0)) __PYX_ERR(0, 835, __pyx_L1_error)
    __pyx_t_7 = __pyx_t_10;
    __pyx_L15_bool_binop_done:;
    if (__pyx_t_7) {

      /* "orb/cutils.pyx":836
 *     if flagx and flagw:
 *         if complexflagx or complexflagw:
 *             complexresult.real = bn.nanmean(x.real * w.real)             # <<<<<<<<<<<<<<
 *             complexresult.imag = bn.nanmean(x.imag * w.imag)
 *             return complexresult
 */
      __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 836, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_nanmean); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 836, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __pyx_t_4 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_x), __pyx_n_s_real); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 836, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __pyx_t_3 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_w), __pyx_n_s_real); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 836, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __pyx_t_5 = PyNumber_Multiply(__pyx_t_4, __pyx_t_3); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 836, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      __pyx_t_3 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_2))) {
        __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_2);
        if (likely(__pyx_t_3)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
          __Pyx_INCREF(__pyx_t_3);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_2, function);
        }
      }
      if (!__pyx_t_3) {
        __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_2, __pyx_t_5); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 836, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
        __Pyx_GOTREF(__pyx_t_1);
      } else {
        __pyx_t_4 = PyTuple_New(1+1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 836, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_4);
        __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_3); __pyx_t_3 = NULL;
        __Pyx_GIVEREF(__pyx_t_5);
        PyTuple_SET_ITEM(__pyx_t_4, 0+1, __pyx_t_5);
        __pyx_t_5 = 0;
        __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_4, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 836, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_1);
        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      }
      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
      __pyx_t_11 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_11 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 836, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
      __Pyx_SET_CREAL(__pyx_v_complexresult, __pyx_t_11);

      /* "orb/cutils.pyx":837
 *         if complexflagx or complexflagw:
 *             complexresult.real = bn.nanmean(x.real * w.real)
 *             complexresult.imag = bn.nanmean(x.imag * w.imag)             # <<<<<<<<<<<<<<
 *             return complexresult
 *         else:
 */
      __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 837, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_nanmean); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 837, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
      __pyx_t_2 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_x), __pyx_n_s_imag); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 837, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __pyx_t_5 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_w), __pyx_n_s_imag); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 837, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __pyx_t_3 = PyNumber_Multiply(__pyx_t_2, __pyx_t_5); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 837, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
      __pyx_t_5 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_4))) {
        __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_4);
        if (likely(__pyx_t_5)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
          __Pyx_INCREF(__pyx_t_5);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_4, function);
        }
      }
      if (!__pyx_t_5) {
        __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_3); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 837, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
        __Pyx_GOTREF(__pyx_t_1);
      } else {
        __pyx_t_2 = PyTuple_New(1+1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 837, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_2);
        __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_5); __pyx_t_5 = NULL;
        __Pyx_GIVEREF(__pyx_t_3);
        PyTuple_SET_ITEM(__pyx_t_2, 0+1, __pyx_t_3);
        __pyx_t_3 = 0;
        __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_2, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 837, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_1);
        __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
      }
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __pyx_t_12 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_12 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 837, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
      __Pyx_SET_CIMAG(__pyx_v_complexresult, __pyx_t_12);

      /* "orb/cutils.pyx":838
 *             complexresult.real = bn.nanmean(x.real * w.real)
 *             complexresult.imag = bn.nanmean(x.imag * w.imag)
 *             return complexresult             # <<<<<<<<<<<<<<
 *         else:
 *             return bn.nanmean(x * w)
 */
      __Pyx_XDECREF(__pyx_r);
      __pyx_t_1 = __pyx_PyComplex_FromComplex(__pyx_v_complexresult); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 838, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);
      __pyx_r = __pyx_t_1;
      __pyx_t_1 = 0;
      goto __pyx_L0;

      /* "orb/cutils.pyx":835
 * 
 *     if flagx and flagw:
 *         if complexflagx or complexflagw:             # <<<<<<<<<<<<<<
 *             complexresult.real = bn.nanmean(x.real * w.real)
 *             complexresult.imag = bn.nanmean(x.imag * w.imag)
 */
    }

    /* "orb/cutils.pyx":840
 *             return complexresult
 *         else:
 *             return bn.nanmean(x * w)             # <<<<<<<<<<<<<<
 *     else:
 *         return np.nanmean(x * w)
 */
    /*else*/ {
      __Pyx_XDECREF(__pyx_r);
      __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 840, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_nanmean); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 840, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __pyx_t_4 = PyNumber_Multiply(((PyObject *)__pyx_v_x), ((PyObject *)__pyx_v_w)); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 840, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __pyx_t_3 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_2))) {
        __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_2);
        if (likely(__pyx_t_3)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
          __Pyx_INCREF(__pyx_t_3);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_2, function);
        }
      }
      if (!__pyx_t_3) {
        __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_2, __pyx_t_4); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 840, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
        __Pyx_GOTREF(__pyx_t_1);
      } else {
        __pyx_t_5 = PyTuple_New(1+1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 840, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_5);
        __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_3); __pyx_t_3 = NULL;
        __Pyx_GIVEREF(__pyx_t_4);
        PyTuple_SET_ITEM(__pyx_t_5, 0+1, __pyx_t_4);
        __pyx_t_4 = 0;
        __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_5, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 840, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_1);
        __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
      }
      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
      __pyx_r = __pyx_t_1;
      __pyx_t_1 = 0;
      goto __pyx_L0;
    }

    /* "orb/cutils.pyx":834
 *         raise Exception('Array and weights must have same number of dimensions')
 * 
 *     if flagx and flagw:             # <<<<<<<<<<<<<<
 *         if complexflagx or complexflagw:
 *             complexresult.real = bn.nanmean(x.real * w.real)
 */
  }

  /* "orb/cutils.pyx":842
 *             return bn.nanmean(x * w)
 *     else:
 *         return np.nanmean(x * w)             # <<<<<<<<<<<<<<
 * 
 * def gaussian1d(np.ndarray[np.float64_t, ndim=1] x,
 */
  /*else*/ {
    __Pyx_XDECREF(__pyx_r);
    __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 842, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_nanmean); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 842, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __pyx_t_2 = PyNumber_Multiply(((PyObject *)__pyx_v_x), ((PyObject *)__pyx_v_w)); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 842, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __pyx_t_4 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_5))) {
      __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_5);
      if (likely(__pyx_t_4)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_5);
        __Pyx_INCREF(__pyx_t_4);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_5, function);
      }
    }
    if (!__pyx_t_4) {
      __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_5, __pyx_t_2); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 842, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
      __Pyx_GOTREF(__pyx_t_1);
    } else {
      __pyx_t_3 = PyTuple_New(1+1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 842, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_4); __pyx_t_4 = NULL;
      __Pyx_GIVEREF(__pyx_t_2);
      PyTuple_SET_ITEM(__pyx_t_3, 0+1, __pyx_t_2);
      __pyx_t_2 = 0;
      __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_3, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 842, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    }
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    __pyx_r = __pyx_t_1;
    __pyx_t_1 = 0;
    goto __pyx_L0;
  }

  /* "orb/cutils.pyx":807
 *         return np.nanstd(x)
 * 
 * def robust_average(np.ndarray x,             # <<<<<<<<<<<<<<
 *                    np.ndarray w):
 *     """Compute robust average of a numpy ndarray (NaNs are skipped)
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_1);
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_XDECREF(__pyx_t_5);
  __Pyx_AddTraceback("orb.cutils.robust_average", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_XDECREF((PyObject *)__pyx_v_flagx);
  __Pyx_XDECREF((PyObject *)__pyx_v_flagw);
  __Pyx_XDECREF((PyObject *)__pyx_v_complexflagx);
  __Pyx_XDECREF((PyObject *)__pyx_v_complexflagw);
  __Pyx_XDECREF((PyObject *)__pyx_v_x);
  __Pyx_XDECREF((PyObject *)__pyx_v_w);
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":844
 *         return np.nanmean(x * w)
 * 
 * def gaussian1d(np.ndarray[np.float64_t, ndim=1] x,             # <<<<<<<<<<<<<<
 *                double h, double a, double dx, double fwhm):
 *     """Return a 1D gaussian given a set of parameters.
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_39gaussian1d(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_3orb_6cutils_38gaussian1d[] = "gaussian1d(ndarray x, double h, double a, double dx, double fwhm)\nReturn a 1D gaussian given a set of parameters.\n\n    :param x: 1D array of float64 giving the positions where the\n      gaussian is evaluated\n    \n    :param h: Height\n    :param a: Amplitude\n    :param dx: Position of the center\n    :param w: FWHM, :math:`\\text{FWHM} = \\text{Width} \\times 2 \\sqrt{2 \\ln 2}`\n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_39gaussian1d = {"gaussian1d", (PyCFunction)__pyx_pw_3orb_6cutils_39gaussian1d, METH_VARARGS|METH_KEYWORDS, __pyx_doc_3orb_6cutils_38gaussian1d};
static PyObject *__pyx_pw_3orb_6cutils_39gaussian1d(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  PyArrayObject *__pyx_v_x = 0;
  double __pyx_v_h;
  double __pyx_v_a;
  double __pyx_v_dx;
  double __pyx_v_fwhm;
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("gaussian1d (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_x,&__pyx_n_s_h,&__pyx_n_s_a,&__pyx_n_s_dx,&__pyx_n_s_fwhm,0};
    PyObject* values[5] = {0,0,0,0,0};
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
      switch (pos_args) {
        case  5: values[4] = PyTuple_GET_ITEM(__pyx_args, 4);
        case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = PyDict_Size(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_x)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        case  1:
        if (likely((values[1] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_h)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("gaussian1d", 1, 5, 5, 1); __PYX_ERR(0, 844, __pyx_L3_error)
        }
        case  2:
        if (likely((values[2] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_a)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("gaussian1d", 1, 5, 5, 2); __PYX_ERR(0, 844, __pyx_L3_error)
        }
        case  3:
        if (likely((values[3] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_dx)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("gaussian1d", 1, 5, 5, 3); __PYX_ERR(0, 844, __pyx_L3_error)
        }
        case  4:
        if (likely((values[4] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_fwhm)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("gaussian1d", 1, 5, 5, 4); __PYX_ERR(0, 844, __pyx_L3_error)
        }
      }
      if (unlikely(kw_args > 0)) {
        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "gaussian1d") < 0)) __PYX_ERR(0, 844, __pyx_L3_error)
      }
    } else if (PyTuple_GET_SIZE(__pyx_args) != 5) {
      goto __pyx_L5_argtuple_error;
    } else {
      values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
      values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
      values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
      values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
      values[4] = PyTuple_GET_ITEM(__pyx_args, 4);
    }
    __pyx_v_x = ((PyArrayObject *)values[0]);
    __pyx_v_h = __pyx_PyFloat_AsDouble(values[1]); if (unlikely((__pyx_v_h == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 845, __pyx_L3_error)
    __pyx_v_a = __pyx_PyFloat_AsDouble(values[2]); if (unlikely((__pyx_v_a == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 845, __pyx_L3_error)
    __pyx_v_dx = __pyx_PyFloat_AsDouble(values[3]); if (unlikely((__pyx_v_dx == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 845, __pyx_L3_error)
    __pyx_v_fwhm = __pyx_PyFloat_AsDouble(values[4]); if (unlikely((__pyx_v_fwhm == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 845, __pyx_L3_error)
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  __Pyx_RaiseArgtupleInvalid("gaussian1d", 1, 5, 5, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 844, __pyx_L3_error)
  __pyx_L3_error:;
  __Pyx_AddTraceback("orb.cutils.gaussian1d", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __Pyx_RefNannyFinishContext();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_x), __pyx_ptype_5numpy_ndarray, 1, "x", 0))) __PYX_ERR(0, 844, __pyx_L1_error)
  __pyx_r = __pyx_pf_3orb_6cutils_38gaussian1d(__pyx_self, __pyx_v_x, __pyx_v_h, __pyx_v_a, __pyx_v_dx, __pyx_v_fwhm);

  /* function exit code */
  goto __pyx_L0;
  __pyx_L1_error:;
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_38gaussian1d(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_x, double __pyx_v_h, double __pyx_v_a, double __pyx_v_dx, double __pyx_v_fwhm) {
  double __pyx_v_w;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_x;
  __Pyx_Buffer __pyx_pybuffer_x;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  double __pyx_t_1;
  PyObject *__pyx_t_2 = NULL;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  PyObject *__pyx_t_5 = NULL;
  PyObject *__pyx_t_6 = NULL;
  PyObject *__pyx_t_7 = NULL;
  PyObject *__pyx_t_8 = NULL;
  __Pyx_RefNannySetupContext("gaussian1d", 0);
  __pyx_pybuffer_x.pybuffer.buf = NULL;
  __pyx_pybuffer_x.refcount = 0;
  __pyx_pybuffernd_x.data = NULL;
  __pyx_pybuffernd_x.rcbuffer = &__pyx_pybuffer_x;
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_x.rcbuffer->pybuffer, (PyObject*)__pyx_v_x, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) __PYX_ERR(0, 844, __pyx_L1_error)
  }
  __pyx_pybuffernd_x.diminfo[0].strides = __pyx_pybuffernd_x.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_x.diminfo[0].shape = __pyx_pybuffernd_x.rcbuffer->pybuffer.shape[0];

  /* "orb/cutils.pyx":856
 *     :param w: FWHM, :math:`\\text{FWHM} = \\text{Width} \\times 2 \\sqrt{2 \\ln 2}`
 *     """
 *     cdef double w = fwhm / (2. * sqrt(2. * log(2.)))             # <<<<<<<<<<<<<<
 *     return  h + a * np.exp(-(x - dx)**2. / (2. * w**2.))
 * 
 */
  __pyx_t_1 = (2. * sqrt((2. * log(2.))));
  if (unlikely(__pyx_t_1 == 0)) {
    PyErr_SetString(PyExc_ZeroDivisionError, "float division");
    __PYX_ERR(0, 856, __pyx_L1_error)
  }
  __pyx_v_w = (__pyx_v_fwhm / __pyx_t_1);

  /* "orb/cutils.pyx":857
 *     """
 *     cdef double w = fwhm / (2. * sqrt(2. * log(2.)))
 *     return  h + a * np.exp(-(x - dx)**2. / (2. * w**2.))             # <<<<<<<<<<<<<<
 * 
 * def sinc1d(np.ndarray[np.float64_t, ndim=1] x,
 */
  __Pyx_XDECREF(__pyx_r);
  __pyx_t_2 = PyFloat_FromDouble(__pyx_v_h); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 857, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_3 = PyFloat_FromDouble(__pyx_v_a); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 857, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 857, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_exp); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 857, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_5 = PyFloat_FromDouble(__pyx_v_dx); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 857, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_7 = PyNumber_Subtract(((PyObject *)__pyx_v_x), __pyx_t_5); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 857, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_7);
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_5 = PyNumber_Power(__pyx_t_7, __pyx_float_2_, Py_None); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 857, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
  __pyx_t_7 = PyNumber_Negative(__pyx_t_5); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 857, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_7);
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_5 = PyFloat_FromDouble((2. * pow(__pyx_v_w, 2.))); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 857, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_8 = __Pyx_PyNumber_Divide(__pyx_t_7, __pyx_t_5); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 857, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_8);
  __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_5 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_6))) {
    __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_6);
    if (likely(__pyx_t_5)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_6);
      __Pyx_INCREF(__pyx_t_5);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_6, function);
    }
  }
  if (!__pyx_t_5) {
    __pyx_t_4 = __Pyx_PyObject_CallOneArg(__pyx_t_6, __pyx_t_8); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 857, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
    __Pyx_GOTREF(__pyx_t_4);
  } else {
    __pyx_t_7 = PyTuple_New(1+1); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 857, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_7);
    __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_7, 0, __pyx_t_5); __pyx_t_5 = NULL;
    __Pyx_GIVEREF(__pyx_t_8);
    PyTuple_SET_ITEM(__pyx_t_7, 0+1, __pyx_t_8);
    __pyx_t_8 = 0;
    __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_6, __pyx_t_7, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 857, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
  }
  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
  __pyx_t_6 = PyNumber_Multiply(__pyx_t_3, __pyx_t_4); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 857, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_4 = PyNumber_Add(__pyx_t_2, __pyx_t_6); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 857, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
  __pyx_r = __pyx_t_4;
  __pyx_t_4 = 0;
  goto __pyx_L0;

  /* "orb/cutils.pyx":844
 *         return np.nanmean(x * w)
 * 
 * def gaussian1d(np.ndarray[np.float64_t, ndim=1] x,             # <<<<<<<<<<<<<<
 *                double h, double a, double dx, double fwhm):
 *     """Return a 1D gaussian given a set of parameters.
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_XDECREF(__pyx_t_5);
  __Pyx_XDECREF(__pyx_t_6);
  __Pyx_XDECREF(__pyx_t_7);
  __Pyx_XDECREF(__pyx_t_8);
  { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
    __Pyx_PyThreadState_declare
    __Pyx_PyThreadState_assign
    __Pyx_ErrFetch(&__pyx_type, &__pyx_value, &__pyx_tb);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_x.rcbuffer->pybuffer);
  __Pyx_ErrRestore(__pyx_type, __pyx_value, __pyx_tb);}
  __Pyx_AddTraceback("orb.cutils.gaussian1d", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  goto __pyx_L2;
  __pyx_L0:;
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_x.rcbuffer->pybuffer);
  __pyx_L2:;
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":859
 *     return  h + a * np.exp(-(x - dx)**2. / (2. * w**2.))
 * 
 * def sinc1d(np.ndarray[np.float64_t, ndim=1] x,             # <<<<<<<<<<<<<<
 *            double h, double a, double dx, double fwhm):
 *     """Return a 1D sinc given a set of parameters.
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_41sinc1d(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_3orb_6cutils_40sinc1d[] = "sinc1d(ndarray x, double h, double a, double dx, double fwhm)\nReturn a 1D sinc given a set of parameters.\n\n    :param x: 1D array of float64 giving the positions where the\n      sinc is evaluated\n    \n    :param h: Height\n    :param a: Amplitude\n    :param dx: Position of the center\n    :param w: FWHM, :math:`\\text{FWHM} = \\text{Width} \\times 2 \\sqrt{2 \\ln 2}`\n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_41sinc1d = {"sinc1d", (PyCFunction)__pyx_pw_3orb_6cutils_41sinc1d, METH_VARARGS|METH_KEYWORDS, __pyx_doc_3orb_6cutils_40sinc1d};
static PyObject *__pyx_pw_3orb_6cutils_41sinc1d(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  PyArrayObject *__pyx_v_x = 0;
  double __pyx_v_h;
  double __pyx_v_a;
  double __pyx_v_dx;
  double __pyx_v_fwhm;
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("sinc1d (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_x,&__pyx_n_s_h,&__pyx_n_s_a,&__pyx_n_s_dx,&__pyx_n_s_fwhm,0};
    PyObject* values[5] = {0,0,0,0,0};
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
      switch (pos_args) {
        case  5: values[4] = PyTuple_GET_ITEM(__pyx_args, 4);
        case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = PyDict_Size(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_x)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        case  1:
        if (likely((values[1] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_h)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("sinc1d", 1, 5, 5, 1); __PYX_ERR(0, 859, __pyx_L3_error)
        }
        case  2:
        if (likely((values[2] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_a)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("sinc1d", 1, 5, 5, 2); __PYX_ERR(0, 859, __pyx_L3_error)
        }
        case  3:
        if (likely((values[3] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_dx)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("sinc1d", 1, 5, 5, 3); __PYX_ERR(0, 859, __pyx_L3_error)
        }
        case  4:
        if (likely((values[4] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_fwhm)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("sinc1d", 1, 5, 5, 4); __PYX_ERR(0, 859, __pyx_L3_error)
        }
      }
      if (unlikely(kw_args > 0)) {
        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "sinc1d") < 0)) __PYX_ERR(0, 859, __pyx_L3_error)
      }
    } else if (PyTuple_GET_SIZE(__pyx_args) != 5) {
      goto __pyx_L5_argtuple_error;
    } else {
      values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
      values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
      values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
      values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
      values[4] = PyTuple_GET_ITEM(__pyx_args, 4);
    }
    __pyx_v_x = ((PyArrayObject *)values[0]);
    __pyx_v_h = __pyx_PyFloat_AsDouble(values[1]); if (unlikely((__pyx_v_h == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 860, __pyx_L3_error)
    __pyx_v_a = __pyx_PyFloat_AsDouble(values[2]); if (unlikely((__pyx_v_a == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 860, __pyx_L3_error)
    __pyx_v_dx = __pyx_PyFloat_AsDouble(values[3]); if (unlikely((__pyx_v_dx == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 860, __pyx_L3_error)
    __pyx_v_fwhm = __pyx_PyFloat_AsDouble(values[4]); if (unlikely((__pyx_v_fwhm == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 860, __pyx_L3_error)
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  __Pyx_RaiseArgtupleInvalid("sinc1d", 1, 5, 5, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 859, __pyx_L3_error)
  __pyx_L3_error:;
  __Pyx_AddTraceback("orb.cutils.sinc1d", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __Pyx_RefNannyFinishContext();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_x), __pyx_ptype_5numpy_ndarray, 1, "x", 0))) __PYX_ERR(0, 859, __pyx_L1_error)
  __pyx_r = __pyx_pf_3orb_6cutils_40sinc1d(__pyx_self, __pyx_v_x, __pyx_v_h, __pyx_v_a, __pyx_v_dx, __pyx_v_fwhm);

  /* function exit code */
  goto __pyx_L0;
  __pyx_L1_error:;
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_40sinc1d(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_x, double __pyx_v_h, double __pyx_v_a, double __pyx_v_dx, double __pyx_v_fwhm) {
  PyArrayObject *__pyx_v_X = 0;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_X;
  __Pyx_Buffer __pyx_pybuffer_X;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_x;
  __Pyx_Buffer __pyx_pybuffer_x;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  PyObject *__pyx_t_1 = NULL;
  PyObject *__pyx_t_2 = NULL;
  PyObject *__pyx_t_3 = NULL;
  PyArrayObject *__pyx_t_4 = NULL;
  PyObject *__pyx_t_5 = NULL;
  PyObject *__pyx_t_6 = NULL;
  PyObject *__pyx_t_7 = NULL;
  __Pyx_RefNannySetupContext("sinc1d", 0);
  __pyx_pybuffer_X.pybuffer.buf = NULL;
  __pyx_pybuffer_X.refcount = 0;
  __pyx_pybuffernd_X.data = NULL;
  __pyx_pybuffernd_X.rcbuffer = &__pyx_pybuffer_X;
  __pyx_pybuffer_x.pybuffer.buf = NULL;
  __pyx_pybuffer_x.refcount = 0;
  __pyx_pybuffernd_x.data = NULL;
  __pyx_pybuffernd_x.rcbuffer = &__pyx_pybuffer_x;
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_x.rcbuffer->pybuffer, (PyObject*)__pyx_v_x, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) __PYX_ERR(0, 859, __pyx_L1_error)
  }
  __pyx_pybuffernd_x.diminfo[0].strides = __pyx_pybuffernd_x.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_x.diminfo[0].shape = __pyx_pybuffernd_x.rcbuffer->pybuffer.shape[0];

  /* "orb/cutils.pyx":871
 *     :param w: FWHM, :math:`\\text{FWHM} = \\text{Width} \\times 2 \\sqrt{2 \\ln 2}`
 *     """
 *     cdef np.ndarray[np.float64_t, ndim=1] X = ((x-dx)/(fwhm/1.20671))             # <<<<<<<<<<<<<<
 *     return h + a * np.sinc(X)
 * 
 */
  __pyx_t_1 = PyFloat_FromDouble(__pyx_v_dx); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 871, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_2 = PyNumber_Subtract(((PyObject *)__pyx_v_x), __pyx_t_1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 871, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_1 = PyFloat_FromDouble((__pyx_v_fwhm / 1.20671)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 871, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_3 = __Pyx_PyNumber_Divide(__pyx_t_2, __pyx_t_1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 871, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  if (!(likely(((__pyx_t_3) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_3, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 871, __pyx_L1_error)
  __pyx_t_4 = ((PyArrayObject *)__pyx_t_3);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_X.rcbuffer->pybuffer, (PyObject*)__pyx_t_4, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
      __pyx_v_X = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_X.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 871, __pyx_L1_error)
    } else {__pyx_pybuffernd_X.diminfo[0].strides = __pyx_pybuffernd_X.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_X.diminfo[0].shape = __pyx_pybuffernd_X.rcbuffer->pybuffer.shape[0];
    }
  }
  __pyx_t_4 = 0;
  __pyx_v_X = ((PyArrayObject *)__pyx_t_3);
  __pyx_t_3 = 0;

  /* "orb/cutils.pyx":872
 *     """
 *     cdef np.ndarray[np.float64_t, ndim=1] X = ((x-dx)/(fwhm/1.20671))
 *     return h + a * np.sinc(X)             # <<<<<<<<<<<<<<
 * 
 * 
 */
  __Pyx_XDECREF(__pyx_r);
  __pyx_t_3 = PyFloat_FromDouble(__pyx_v_h); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 872, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_1 = PyFloat_FromDouble(__pyx_v_a); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 872, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 872, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_sinc); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 872, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_5 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_6))) {
    __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_6);
    if (likely(__pyx_t_5)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_6);
      __Pyx_INCREF(__pyx_t_5);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_6, function);
    }
  }
  if (!__pyx_t_5) {
    __pyx_t_2 = __Pyx_PyObject_CallOneArg(__pyx_t_6, ((PyObject *)__pyx_v_X)); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 872, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
  } else {
    __pyx_t_7 = PyTuple_New(1+1); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 872, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_7);
    __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_7, 0, __pyx_t_5); __pyx_t_5 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_X));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_X));
    PyTuple_SET_ITEM(__pyx_t_7, 0+1, ((PyObject *)__pyx_v_X));
    __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_6, __pyx_t_7, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 872, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
  }
  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
  __pyx_t_6 = PyNumber_Multiply(__pyx_t_1, __pyx_t_2); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 872, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = PyNumber_Add(__pyx_t_3, __pyx_t_6); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 872, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
  __pyx_r = __pyx_t_2;
  __pyx_t_2 = 0;
  goto __pyx_L0;

  /* "orb/cutils.pyx":859
 *     return  h + a * np.exp(-(x - dx)**2. / (2. * w**2.))
 * 
 * def sinc1d(np.ndarray[np.float64_t, ndim=1] x,             # <<<<<<<<<<<<<<
 *            double h, double a, double dx, double fwhm):
 *     """Return a 1D sinc given a set of parameters.
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_1);
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_5);
  __Pyx_XDECREF(__pyx_t_6);
  __Pyx_XDECREF(__pyx_t_7);
  { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
    __Pyx_PyThreadState_declare
    __Pyx_PyThreadState_assign
    __Pyx_ErrFetch(&__pyx_type, &__pyx_value, &__pyx_tb);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_X.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_x.rcbuffer->pybuffer);
  __Pyx_ErrRestore(__pyx_type, __pyx_value, __pyx_tb);}
  __Pyx_AddTraceback("orb.cutils.sinc1d", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  goto __pyx_L2;
  __pyx_L0:;
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_X.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_x.rcbuffer->pybuffer);
  __pyx_L2:;
  __Pyx_XDECREF((PyObject *)__pyx_v_X);
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":911
 * ##     return (h + a * e * (dawson1 - dawson2)).real
 * 
 * def interf_mean_energy(np.ndarray interf):             # <<<<<<<<<<<<<<
 *     """Return the mean energy of an interferogram by step.
 * 
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_43interf_mean_energy(PyObject *__pyx_self, PyObject *__pyx_v_interf); /*proto*/
static char __pyx_doc_3orb_6cutils_42interf_mean_energy[] = "interf_mean_energy(ndarray interf)\nReturn the mean energy of an interferogram by step.\n\n    :param interf: an interferogram\n\n    .. warning:: The mean of the interferogram is substracted to\n      compute only the modulation energy. This is the modulation\n      energy which must be conserved in the resulting spectrum. Note\n      that the interferogram transformation function (see\n      :py:meth:`utils.transform_interferogram`) remove the mean of the\n      interferogram before computing its FFT.\n\n    .. note:: NaNs are counted as zeros.\n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_43interf_mean_energy = {"interf_mean_energy", (PyCFunction)__pyx_pw_3orb_6cutils_43interf_mean_energy, METH_O, __pyx_doc_3orb_6cutils_42interf_mean_energy};
static PyObject *__pyx_pw_3orb_6cutils_43interf_mean_energy(PyObject *__pyx_self, PyObject *__pyx_v_interf) {
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("interf_mean_energy (wrapper)", 0);
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_interf), __pyx_ptype_5numpy_ndarray, 1, "interf", 0))) __PYX_ERR(0, 911, __pyx_L1_error)
  __pyx_r = __pyx_pf_3orb_6cutils_42interf_mean_energy(__pyx_self, ((PyArrayObject *)__pyx_v_interf));

  /* function exit code */
  goto __pyx_L0;
  __pyx_L1_error:;
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_42interf_mean_energy(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_interf) {
  double __pyx_v_energy_sum;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  PyObject *__pyx_t_1 = NULL;
  PyObject *__pyx_t_2 = NULL;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  int __pyx_t_5;
  int __pyx_t_6;
  PyObject *__pyx_t_7 = NULL;
  PyObject *__pyx_t_8 = NULL;
  double __pyx_t_9;
  PyObject *__pyx_t_10 = NULL;
  PyObject *__pyx_t_11 = NULL;
  PyObject *__pyx_t_12 = NULL;
  float __pyx_t_13;
  __Pyx_RefNannySetupContext("interf_mean_energy", 0);

  /* "orb/cutils.pyx":927
 *     cdef double energy_sum
 * 
 *     if not np.iscomplexobj(interf):             # <<<<<<<<<<<<<<
 *         energy_sum = bn.nansum((interf - bn.nanmean(interf))**2.)
 *     else:
 */
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 927, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_iscomplexobj); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 927, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_3))) {
    __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_3);
    if (likely(__pyx_t_2)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
      __Pyx_INCREF(__pyx_t_2);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_3, function);
    }
  }
  if (!__pyx_t_2) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_3, ((PyObject *)__pyx_v_interf)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 927, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_4 = PyTuple_New(1+1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 927, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_2); __pyx_t_2 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_interf));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_interf));
    PyTuple_SET_ITEM(__pyx_t_4, 0+1, ((PyObject *)__pyx_v_interf));
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_4, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 927, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  }
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_5 = __Pyx_PyObject_IsTrue(__pyx_t_1); if (unlikely(__pyx_t_5 < 0)) __PYX_ERR(0, 927, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_6 = ((!__pyx_t_5) != 0);
  if (__pyx_t_6) {

    /* "orb/cutils.pyx":928
 * 
 *     if not np.iscomplexobj(interf):
 *         energy_sum = bn.nansum((interf - bn.nanmean(interf))**2.)             # <<<<<<<<<<<<<<
 *     else:
 *         energy_sum = bn.nansum(
 */
    __pyx_t_3 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 928, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_nansum); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 928, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 928, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __pyx_t_7 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_nanmean); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 928, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_7);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __pyx_t_2 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_7))) {
      __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_7);
      if (likely(__pyx_t_2)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_7);
        __Pyx_INCREF(__pyx_t_2);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_7, function);
      }
    }
    if (!__pyx_t_2) {
      __pyx_t_3 = __Pyx_PyObject_CallOneArg(__pyx_t_7, ((PyObject *)__pyx_v_interf)); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 928, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
    } else {
      __pyx_t_8 = PyTuple_New(1+1); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 928, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_8);
      __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_8, 0, __pyx_t_2); __pyx_t_2 = NULL;
      __Pyx_INCREF(((PyObject *)__pyx_v_interf));
      __Pyx_GIVEREF(((PyObject *)__pyx_v_interf));
      PyTuple_SET_ITEM(__pyx_t_8, 0+1, ((PyObject *)__pyx_v_interf));
      __pyx_t_3 = __Pyx_PyObject_Call(__pyx_t_7, __pyx_t_8, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 928, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
    }
    __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
    __pyx_t_7 = PyNumber_Subtract(((PyObject *)__pyx_v_interf), __pyx_t_3); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 928, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_7);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __pyx_t_3 = PyNumber_Power(__pyx_t_7, __pyx_float_2_, Py_None); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 928, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
    __pyx_t_7 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_4))) {
      __pyx_t_7 = PyMethod_GET_SELF(__pyx_t_4);
      if (likely(__pyx_t_7)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
        __Pyx_INCREF(__pyx_t_7);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_4, function);
      }
    }
    if (!__pyx_t_7) {
      __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_3); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 928, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      __Pyx_GOTREF(__pyx_t_1);
    } else {
      __pyx_t_8 = PyTuple_New(1+1); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 928, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_8);
      __Pyx_GIVEREF(__pyx_t_7); PyTuple_SET_ITEM(__pyx_t_8, 0, __pyx_t_7); __pyx_t_7 = NULL;
      __Pyx_GIVEREF(__pyx_t_3);
      PyTuple_SET_ITEM(__pyx_t_8, 0+1, __pyx_t_3);
      __pyx_t_3 = 0;
      __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_8, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 928, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);
      __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
    }
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_t_9 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_9 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 928, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    __pyx_v_energy_sum = __pyx_t_9;

    /* "orb/cutils.pyx":927
 *     cdef double energy_sum
 * 
 *     if not np.iscomplexobj(interf):             # <<<<<<<<<<<<<<
 *         energy_sum = bn.nansum((interf - bn.nanmean(interf))**2.)
 *     else:
 */
    goto __pyx_L3;
  }

  /* "orb/cutils.pyx":930
 *         energy_sum = bn.nansum((interf - bn.nanmean(interf))**2.)
 *     else:
 *         energy_sum = bn.nansum(             # <<<<<<<<<<<<<<
 *             (interf.real - bn.nanmean(interf.real))**2.
 *             + (interf.imag - bn.nanmean(interf.imag))**2.)
 */
  /*else*/ {
    __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 930, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __pyx_t_8 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_nansum); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 930, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_8);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;

    /* "orb/cutils.pyx":931
 *     else:
 *         energy_sum = bn.nansum(
 *             (interf.real - bn.nanmean(interf.real))**2.             # <<<<<<<<<<<<<<
 *             + (interf.imag - bn.nanmean(interf.imag))**2.)
 * 
 */
    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_interf), __pyx_n_s_real); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 931, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __pyx_t_7 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 931, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_7);
    __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_7, __pyx_n_s_nanmean); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 931, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
    __pyx_t_7 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_interf), __pyx_n_s_real); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 931, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_7);
    __pyx_t_10 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_2))) {
      __pyx_t_10 = PyMethod_GET_SELF(__pyx_t_2);
      if (likely(__pyx_t_10)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
        __Pyx_INCREF(__pyx_t_10);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_2, function);
      }
    }
    if (!__pyx_t_10) {
      __pyx_t_3 = __Pyx_PyObject_CallOneArg(__pyx_t_2, __pyx_t_7); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 931, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
      __Pyx_GOTREF(__pyx_t_3);
    } else {
      __pyx_t_11 = PyTuple_New(1+1); if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 931, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_11);
      __Pyx_GIVEREF(__pyx_t_10); PyTuple_SET_ITEM(__pyx_t_11, 0, __pyx_t_10); __pyx_t_10 = NULL;
      __Pyx_GIVEREF(__pyx_t_7);
      PyTuple_SET_ITEM(__pyx_t_11, 0+1, __pyx_t_7);
      __pyx_t_7 = 0;
      __pyx_t_3 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_11, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 931, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __Pyx_DECREF(__pyx_t_11); __pyx_t_11 = 0;
    }
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __pyx_t_2 = PyNumber_Subtract(__pyx_t_4, __pyx_t_3); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 931, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __pyx_t_3 = PyNumber_Power(__pyx_t_2, __pyx_float_2_, Py_None); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 931, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;

    /* "orb/cutils.pyx":932
 *         energy_sum = bn.nansum(
 *             (interf.real - bn.nanmean(interf.real))**2.
 *             + (interf.imag - bn.nanmean(interf.imag))**2.)             # <<<<<<<<<<<<<<
 * 
 *     return sqrt(energy_sum / <float> np.size(interf))
 */
    __pyx_t_2 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_interf), __pyx_n_s_imag); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 932, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __pyx_t_11 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 932, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_11);
    __pyx_t_7 = __Pyx_PyObject_GetAttrStr(__pyx_t_11, __pyx_n_s_nanmean); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 932, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_7);
    __Pyx_DECREF(__pyx_t_11); __pyx_t_11 = 0;
    __pyx_t_11 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_interf), __pyx_n_s_imag); if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 932, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_11);
    __pyx_t_10 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_7))) {
      __pyx_t_10 = PyMethod_GET_SELF(__pyx_t_7);
      if (likely(__pyx_t_10)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_7);
        __Pyx_INCREF(__pyx_t_10);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_7, function);
      }
    }
    if (!__pyx_t_10) {
      __pyx_t_4 = __Pyx_PyObject_CallOneArg(__pyx_t_7, __pyx_t_11); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 932, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_11); __pyx_t_11 = 0;
      __Pyx_GOTREF(__pyx_t_4);
    } else {
      __pyx_t_12 = PyTuple_New(1+1); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 932, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_12);
      __Pyx_GIVEREF(__pyx_t_10); PyTuple_SET_ITEM(__pyx_t_12, 0, __pyx_t_10); __pyx_t_10 = NULL;
      __Pyx_GIVEREF(__pyx_t_11);
      PyTuple_SET_ITEM(__pyx_t_12, 0+1, __pyx_t_11);
      __pyx_t_11 = 0;
      __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_7, __pyx_t_12, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 932, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __Pyx_DECREF(__pyx_t_12); __pyx_t_12 = 0;
    }
    __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
    __pyx_t_7 = PyNumber_Subtract(__pyx_t_2, __pyx_t_4); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 932, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_7);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_t_4 = PyNumber_Power(__pyx_t_7, __pyx_float_2_, Py_None); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 932, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
    __pyx_t_7 = PyNumber_Add(__pyx_t_3, __pyx_t_4); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 932, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_7);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_t_4 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_8))) {
      __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_8);
      if (likely(__pyx_t_4)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_8);
        __Pyx_INCREF(__pyx_t_4);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_8, function);
      }
    }
    if (!__pyx_t_4) {
      __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_8, __pyx_t_7); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 930, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
      __Pyx_GOTREF(__pyx_t_1);
    } else {
      __pyx_t_3 = PyTuple_New(1+1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 930, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_4); __pyx_t_4 = NULL;
      __Pyx_GIVEREF(__pyx_t_7);
      PyTuple_SET_ITEM(__pyx_t_3, 0+1, __pyx_t_7);
      __pyx_t_7 = 0;
      __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_8, __pyx_t_3, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 930, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    }
    __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;

    /* "orb/cutils.pyx":930
 *         energy_sum = bn.nansum((interf - bn.nanmean(interf))**2.)
 *     else:
 *         energy_sum = bn.nansum(             # <<<<<<<<<<<<<<
 *             (interf.real - bn.nanmean(interf.real))**2.
 *             + (interf.imag - bn.nanmean(interf.imag))**2.)
 */
    __pyx_t_9 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_9 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 930, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    __pyx_v_energy_sum = __pyx_t_9;
  }
  __pyx_L3:;

  /* "orb/cutils.pyx":934
 *             + (interf.imag - bn.nanmean(interf.imag))**2.)
 * 
 *     return sqrt(energy_sum / <float> np.size(interf))             # <<<<<<<<<<<<<<
 * 
 * def spectrum_mean_energy(np.ndarray spectrum):
 */
  __Pyx_XDECREF(__pyx_r);
  __pyx_t_8 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 934, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_8);
  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_8, __pyx_n_s_size); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 934, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
  __pyx_t_8 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_3))) {
    __pyx_t_8 = PyMethod_GET_SELF(__pyx_t_3);
    if (likely(__pyx_t_8)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
      __Pyx_INCREF(__pyx_t_8);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_3, function);
    }
  }
  if (!__pyx_t_8) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_3, ((PyObject *)__pyx_v_interf)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 934, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_7 = PyTuple_New(1+1); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 934, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_7);
    __Pyx_GIVEREF(__pyx_t_8); PyTuple_SET_ITEM(__pyx_t_7, 0, __pyx_t_8); __pyx_t_8 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_interf));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_interf));
    PyTuple_SET_ITEM(__pyx_t_7, 0+1, ((PyObject *)__pyx_v_interf));
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_7, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 934, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
  }
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_13 = __pyx_PyFloat_AsFloat(__pyx_t_1); if (unlikely((__pyx_t_13 == (float)-1) && PyErr_Occurred())) __PYX_ERR(0, 934, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  if (unlikely(((float)__pyx_t_13) == 0)) {
    PyErr_SetString(PyExc_ZeroDivisionError, "float division");
    __PYX_ERR(0, 934, __pyx_L1_error)
  }
  __pyx_t_1 = PyFloat_FromDouble(sqrt((__pyx_v_energy_sum / ((float)__pyx_t_13)))); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 934, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_r = __pyx_t_1;
  __pyx_t_1 = 0;
  goto __pyx_L0;

  /* "orb/cutils.pyx":911
 * ##     return (h + a * e * (dawson1 - dawson2)).real
 * 
 * def interf_mean_energy(np.ndarray interf):             # <<<<<<<<<<<<<<
 *     """Return the mean energy of an interferogram by step.
 * 
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_1);
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_XDECREF(__pyx_t_7);
  __Pyx_XDECREF(__pyx_t_8);
  __Pyx_XDECREF(__pyx_t_10);
  __Pyx_XDECREF(__pyx_t_11);
  __Pyx_XDECREF(__pyx_t_12);
  __Pyx_AddTraceback("orb.cutils.interf_mean_energy", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":936
 *     return sqrt(energy_sum / <float> np.size(interf))
 * 
 * def spectrum_mean_energy(np.ndarray spectrum):             # <<<<<<<<<<<<<<
 *     """Return the mean energy of a spectrum by channel.
 * 
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_45spectrum_mean_energy(PyObject *__pyx_self, PyObject *__pyx_v_spectrum); /*proto*/
static char __pyx_doc_3orb_6cutils_44spectrum_mean_energy[] = "spectrum_mean_energy(ndarray spectrum)\nReturn the mean energy of a spectrum by channel.\n\n    :param spectrum: a 1D spectrum\n\n    .. note:: NaNs are counted as zeros.\n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_45spectrum_mean_energy = {"spectrum_mean_energy", (PyCFunction)__pyx_pw_3orb_6cutils_45spectrum_mean_energy, METH_O, __pyx_doc_3orb_6cutils_44spectrum_mean_energy};
static PyObject *__pyx_pw_3orb_6cutils_45spectrum_mean_energy(PyObject *__pyx_self, PyObject *__pyx_v_spectrum) {
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("spectrum_mean_energy (wrapper)", 0);
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_spectrum), __pyx_ptype_5numpy_ndarray, 1, "spectrum", 0))) __PYX_ERR(0, 936, __pyx_L1_error)
  __pyx_r = __pyx_pf_3orb_6cutils_44spectrum_mean_energy(__pyx_self, ((PyArrayObject *)__pyx_v_spectrum));

  /* function exit code */
  goto __pyx_L0;
  __pyx_L1_error:;
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_44spectrum_mean_energy(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_spectrum) {
  double __pyx_v_energy_sum;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  PyObject *__pyx_t_1 = NULL;
  PyObject *__pyx_t_2 = NULL;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  int __pyx_t_5;
  int __pyx_t_6;
  PyObject *__pyx_t_7 = NULL;
  double __pyx_t_8;
  float __pyx_t_9;
  __Pyx_RefNannySetupContext("spectrum_mean_energy", 0);

  /* "orb/cutils.pyx":945
 *     cdef double energy_sum
 * 
 *     if not np.iscomplexobj(spectrum):             # <<<<<<<<<<<<<<
 *         energy_sum = bn.nansum(spectrum**2.)
 *     else:
 */
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 945, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_iscomplexobj); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 945, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_3))) {
    __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_3);
    if (likely(__pyx_t_2)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
      __Pyx_INCREF(__pyx_t_2);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_3, function);
    }
  }
  if (!__pyx_t_2) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_3, ((PyObject *)__pyx_v_spectrum)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 945, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_4 = PyTuple_New(1+1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 945, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_2); __pyx_t_2 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_spectrum));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_spectrum));
    PyTuple_SET_ITEM(__pyx_t_4, 0+1, ((PyObject *)__pyx_v_spectrum));
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_4, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 945, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  }
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_5 = __Pyx_PyObject_IsTrue(__pyx_t_1); if (unlikely(__pyx_t_5 < 0)) __PYX_ERR(0, 945, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_6 = ((!__pyx_t_5) != 0);
  if (__pyx_t_6) {

    /* "orb/cutils.pyx":946
 * 
 *     if not np.iscomplexobj(spectrum):
 *         energy_sum = bn.nansum(spectrum**2.)             # <<<<<<<<<<<<<<
 *     else:
 *         energy_sum = bn.nansum(spectrum.real**2. + spectrum.imag**2.)
 */
    __pyx_t_3 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 946, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_nansum); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 946, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __pyx_t_3 = PyNumber_Power(((PyObject *)__pyx_v_spectrum), __pyx_float_2_, Py_None); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 946, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __pyx_t_2 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_4))) {
      __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_4);
      if (likely(__pyx_t_2)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
        __Pyx_INCREF(__pyx_t_2);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_4, function);
      }
    }
    if (!__pyx_t_2) {
      __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_3); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 946, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      __Pyx_GOTREF(__pyx_t_1);
    } else {
      __pyx_t_7 = PyTuple_New(1+1); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 946, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_7);
      __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_7, 0, __pyx_t_2); __pyx_t_2 = NULL;
      __Pyx_GIVEREF(__pyx_t_3);
      PyTuple_SET_ITEM(__pyx_t_7, 0+1, __pyx_t_3);
      __pyx_t_3 = 0;
      __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_7, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 946, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);
      __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
    }
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_t_8 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_8 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 946, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    __pyx_v_energy_sum = __pyx_t_8;

    /* "orb/cutils.pyx":945
 *     cdef double energy_sum
 * 
 *     if not np.iscomplexobj(spectrum):             # <<<<<<<<<<<<<<
 *         energy_sum = bn.nansum(spectrum**2.)
 *     else:
 */
    goto __pyx_L3;
  }

  /* "orb/cutils.pyx":948
 *         energy_sum = bn.nansum(spectrum**2.)
 *     else:
 *         energy_sum = bn.nansum(spectrum.real**2. + spectrum.imag**2.)             # <<<<<<<<<<<<<<
 * 
 *     return sqrt(energy_sum) / <float> np.size(spectrum)
 */
  /*else*/ {
    __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 948, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __pyx_t_7 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_nansum); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 948, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_7);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_spectrum), __pyx_n_s_real); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 948, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __pyx_t_3 = PyNumber_Power(__pyx_t_4, __pyx_float_2_, Py_None); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 948, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_spectrum), __pyx_n_s_imag); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 948, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __pyx_t_2 = PyNumber_Power(__pyx_t_4, __pyx_float_2_, Py_None); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 948, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_t_4 = PyNumber_Add(__pyx_t_3, __pyx_t_2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 948, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __pyx_t_2 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_7))) {
      __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_7);
      if (likely(__pyx_t_2)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_7);
        __Pyx_INCREF(__pyx_t_2);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_7, function);
      }
    }
    if (!__pyx_t_2) {
      __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_7, __pyx_t_4); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 948, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __Pyx_GOTREF(__pyx_t_1);
    } else {
      __pyx_t_3 = PyTuple_New(1+1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 948, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_2); __pyx_t_2 = NULL;
      __Pyx_GIVEREF(__pyx_t_4);
      PyTuple_SET_ITEM(__pyx_t_3, 0+1, __pyx_t_4);
      __pyx_t_4 = 0;
      __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_7, __pyx_t_3, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 948, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    }
    __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
    __pyx_t_8 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_8 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 948, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    __pyx_v_energy_sum = __pyx_t_8;
  }
  __pyx_L3:;

  /* "orb/cutils.pyx":950
 *         energy_sum = bn.nansum(spectrum.real**2. + spectrum.imag**2.)
 * 
 *     return sqrt(energy_sum) / <float> np.size(spectrum)             # <<<<<<<<<<<<<<
 * 
 * def fft_filter(np.ndarray[np.float64_t, ndim=1] a,
 */
  __Pyx_XDECREF(__pyx_r);
  __pyx_t_8 = sqrt(__pyx_v_energy_sum);
  __pyx_t_7 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 950, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_7);
  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_7, __pyx_n_s_size); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 950, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
  __pyx_t_7 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_3))) {
    __pyx_t_7 = PyMethod_GET_SELF(__pyx_t_3);
    if (likely(__pyx_t_7)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
      __Pyx_INCREF(__pyx_t_7);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_3, function);
    }
  }
  if (!__pyx_t_7) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_3, ((PyObject *)__pyx_v_spectrum)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 950, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_4 = PyTuple_New(1+1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 950, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_GIVEREF(__pyx_t_7); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_7); __pyx_t_7 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_spectrum));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_spectrum));
    PyTuple_SET_ITEM(__pyx_t_4, 0+1, ((PyObject *)__pyx_v_spectrum));
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_4, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 950, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  }
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_9 = __pyx_PyFloat_AsFloat(__pyx_t_1); if (unlikely((__pyx_t_9 == (float)-1) && PyErr_Occurred())) __PYX_ERR(0, 950, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  if (unlikely(((float)__pyx_t_9) == 0)) {
    PyErr_SetString(PyExc_ZeroDivisionError, "float division");
    __PYX_ERR(0, 950, __pyx_L1_error)
  }
  __pyx_t_1 = PyFloat_FromDouble((__pyx_t_8 / ((float)__pyx_t_9))); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 950, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_r = __pyx_t_1;
  __pyx_t_1 = 0;
  goto __pyx_L0;

  /* "orb/cutils.pyx":936
 *     return sqrt(energy_sum / <float> np.size(interf))
 * 
 * def spectrum_mean_energy(np.ndarray spectrum):             # <<<<<<<<<<<<<<
 *     """Return the mean energy of a spectrum by channel.
 * 
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_1);
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_XDECREF(__pyx_t_7);
  __Pyx_AddTraceback("orb.cutils.spectrum_mean_energy", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":952
 *     return sqrt(energy_sum) / <float> np.size(spectrum)
 * 
 * def fft_filter(np.ndarray[np.float64_t, ndim=1] a,             # <<<<<<<<<<<<<<
 *                 double cutoff, double width, bool lowpass):
 *     """
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_47fft_filter(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_3orb_6cutils_46fft_filter[] = "fft_filter(ndarray a, double cutoff, double width, bool lowpass)\n\n    Simple lowpass or highpass FFT filter (high pass or low pass)\n\n    Filter shape is a gaussian.\n    \n    :param a: a 1D float64 vector\n\n    :param cutoff_coeff: Coefficient defining the position of the cutoff\n      frequency (Cutoff frequency = cutoff_coeff * vector length)\n\n    :param width_coeff: Coefficient defining the width of\n      the smoothed part of the filter (width = width_coeff * vector\n      length) \n\n    :param lowpass: If True filter will be 'low_pass' and 'high_pass'\n      if False.\n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_47fft_filter = {"fft_filter", (PyCFunction)__pyx_pw_3orb_6cutils_47fft_filter, METH_VARARGS|METH_KEYWORDS, __pyx_doc_3orb_6cutils_46fft_filter};
static PyObject *__pyx_pw_3orb_6cutils_47fft_filter(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  PyArrayObject *__pyx_v_a = 0;
  double __pyx_v_cutoff;
  double __pyx_v_width;
  PyBoolObject *__pyx_v_lowpass = 0;
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("fft_filter (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_a,&__pyx_n_s_cutoff,&__pyx_n_s_width,&__pyx_n_s_lowpass,0};
    PyObject* values[4] = {0,0,0,0};
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
      switch (pos_args) {
        case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = PyDict_Size(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_a)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        case  1:
        if (likely((values[1] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_cutoff)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("fft_filter", 1, 4, 4, 1); __PYX_ERR(0, 952, __pyx_L3_error)
        }
        case  2:
        if (likely((values[2] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_width)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("fft_filter", 1, 4, 4, 2); __PYX_ERR(0, 952, __pyx_L3_error)
        }
        case  3:
        if (likely((values[3] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_lowpass)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("fft_filter", 1, 4, 4, 3); __PYX_ERR(0, 952, __pyx_L3_error)
        }
      }
      if (unlikely(kw_args > 0)) {
        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "fft_filter") < 0)) __PYX_ERR(0, 952, __pyx_L3_error)
      }
    } else if (PyTuple_GET_SIZE(__pyx_args) != 4) {
      goto __pyx_L5_argtuple_error;
    } else {
      values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
      values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
      values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
      values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
    }
    __pyx_v_a = ((PyArrayObject *)values[0]);
    __pyx_v_cutoff = __pyx_PyFloat_AsDouble(values[1]); if (unlikely((__pyx_v_cutoff == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 953, __pyx_L3_error)
    __pyx_v_width = __pyx_PyFloat_AsDouble(values[2]); if (unlikely((__pyx_v_width == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 953, __pyx_L3_error)
    __pyx_v_lowpass = ((PyBoolObject *)values[3]);
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  __Pyx_RaiseArgtupleInvalid("fft_filter", 1, 4, 4, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 952, __pyx_L3_error)
  __pyx_L3_error:;
  __Pyx_AddTraceback("orb.cutils.fft_filter", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __Pyx_RefNannyFinishContext();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_a), __pyx_ptype_5numpy_ndarray, 1, "a", 0))) __PYX_ERR(0, 952, __pyx_L1_error)
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_lowpass), __pyx_ptype_7cpython_4bool_bool, 1, "lowpass", 0))) __PYX_ERR(0, 953, __pyx_L1_error)
  __pyx_r = __pyx_pf_3orb_6cutils_46fft_filter(__pyx_self, __pyx_v_a, __pyx_v_cutoff, __pyx_v_width, __pyx_v_lowpass);

  /* function exit code */
  goto __pyx_L0;
  __pyx_L1_error:;
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_46fft_filter(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_a, double __pyx_v_cutoff, double __pyx_v_width, PyBoolObject *__pyx_v_lowpass) {
  int __pyx_v_n;
  int __pyx_v_fn;
  PyArrayObject *__pyx_v_hwindow = 0;
  PyArrayObject *__pyx_v_window = 0;
  int __pyx_v_icut;
  double __pyx_v_wlen;
  int __pyx_v_wsize;
  PyArrayObject *__pyx_v_w = 0;
  double __pyx_v_dx;
  int __pyx_v_minx;
  int __pyx_v_maxx;
  double __pyx_v_median_a;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_a;
  __Pyx_Buffer __pyx_pybuffer_a;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_hwindow;
  __Pyx_Buffer __pyx_pybuffer_hwindow;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_w;
  __Pyx_Buffer __pyx_pybuffer_w;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_window;
  __Pyx_Buffer __pyx_pybuffer_window;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  int __pyx_t_1;
  int __pyx_t_2;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  PyObject *__pyx_t_5 = NULL;
  PyObject *__pyx_t_6 = NULL;
  PyObject *__pyx_t_7 = NULL;
  PyArrayObject *__pyx_t_8 = NULL;
  PyArrayObject *__pyx_t_9 = NULL;
  int __pyx_t_10;
  long __pyx_t_11;
  long __pyx_t_12;
  PyArrayObject *__pyx_t_13 = NULL;
  PyObject *__pyx_t_14 = NULL;
  PyObject *__pyx_t_15 = NULL;
  Py_ssize_t __pyx_t_16;
  PyObject *__pyx_t_17 = NULL;
  PyObject *__pyx_t_18 = NULL;
  PyObject *__pyx_t_19 = NULL;
  Py_ssize_t __pyx_t_20;
  Py_ssize_t __pyx_t_21;
  double __pyx_t_22;
  __Pyx_RefNannySetupContext("fft_filter", 0);
  __pyx_pybuffer_hwindow.pybuffer.buf = NULL;
  __pyx_pybuffer_hwindow.refcount = 0;
  __pyx_pybuffernd_hwindow.data = NULL;
  __pyx_pybuffernd_hwindow.rcbuffer = &__pyx_pybuffer_hwindow;
  __pyx_pybuffer_window.pybuffer.buf = NULL;
  __pyx_pybuffer_window.refcount = 0;
  __pyx_pybuffernd_window.data = NULL;
  __pyx_pybuffernd_window.rcbuffer = &__pyx_pybuffer_window;
  __pyx_pybuffer_w.pybuffer.buf = NULL;
  __pyx_pybuffer_w.refcount = 0;
  __pyx_pybuffernd_w.data = NULL;
  __pyx_pybuffernd_w.rcbuffer = &__pyx_pybuffer_w;
  __pyx_pybuffer_a.pybuffer.buf = NULL;
  __pyx_pybuffer_a.refcount = 0;
  __pyx_pybuffernd_a.data = NULL;
  __pyx_pybuffernd_a.rcbuffer = &__pyx_pybuffer_a;
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_a.rcbuffer->pybuffer, (PyObject*)__pyx_v_a, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) __PYX_ERR(0, 952, __pyx_L1_error)
  }
  __pyx_pybuffernd_a.diminfo[0].strides = __pyx_pybuffernd_a.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_a.diminfo[0].shape = __pyx_pybuffernd_a.rcbuffer->pybuffer.shape[0];

  /* "orb/cutils.pyx":971
 *       if False.
 *     """
 *     if cutoff > 1. or cutoff < 0.:             # <<<<<<<<<<<<<<
 *         raise ValueError('cutoff must be between 0. and 1.')
 *     if width > 1. or width < 0.:
 */
  __pyx_t_2 = ((__pyx_v_cutoff > 1.) != 0);
  if (!__pyx_t_2) {
  } else {
    __pyx_t_1 = __pyx_t_2;
    goto __pyx_L4_bool_binop_done;
  }
  __pyx_t_2 = ((__pyx_v_cutoff < 0.) != 0);
  __pyx_t_1 = __pyx_t_2;
  __pyx_L4_bool_binop_done:;
  if (__pyx_t_1) {

    /* "orb/cutils.pyx":972
 *     """
 *     if cutoff > 1. or cutoff < 0.:
 *         raise ValueError('cutoff must be between 0. and 1.')             # <<<<<<<<<<<<<<
 *     if width > 1. or width < 0.:
 *         raise ValueError('width must be between 0. and 1.')
 */
    __pyx_t_3 = __Pyx_PyObject_Call(__pyx_builtin_ValueError, __pyx_tuple__49, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 972, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_Raise(__pyx_t_3, 0, 0, 0);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __PYX_ERR(0, 972, __pyx_L1_error)

    /* "orb/cutils.pyx":971
 *       if False.
 *     """
 *     if cutoff > 1. or cutoff < 0.:             # <<<<<<<<<<<<<<
 *         raise ValueError('cutoff must be between 0. and 1.')
 *     if width > 1. or width < 0.:
 */
  }

  /* "orb/cutils.pyx":973
 *     if cutoff > 1. or cutoff < 0.:
 *         raise ValueError('cutoff must be between 0. and 1.')
 *     if width > 1. or width < 0.:             # <<<<<<<<<<<<<<
 *         raise ValueError('width must be between 0. and 1.')
 * 
 */
  __pyx_t_2 = ((__pyx_v_width > 1.) != 0);
  if (!__pyx_t_2) {
  } else {
    __pyx_t_1 = __pyx_t_2;
    goto __pyx_L7_bool_binop_done;
  }
  __pyx_t_2 = ((__pyx_v_width < 0.) != 0);
  __pyx_t_1 = __pyx_t_2;
  __pyx_L7_bool_binop_done:;
  if (__pyx_t_1) {

    /* "orb/cutils.pyx":974
 *         raise ValueError('cutoff must be between 0. and 1.')
 *     if width > 1. or width < 0.:
 *         raise ValueError('width must be between 0. and 1.')             # <<<<<<<<<<<<<<
 * 
 *     cdef int n = a.shape[0]
 */
    __pyx_t_3 = __Pyx_PyObject_Call(__pyx_builtin_ValueError, __pyx_tuple__50, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 974, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_Raise(__pyx_t_3, 0, 0, 0);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __PYX_ERR(0, 974, __pyx_L1_error)

    /* "orb/cutils.pyx":973
 *     if cutoff > 1. or cutoff < 0.:
 *         raise ValueError('cutoff must be between 0. and 1.')
 *     if width > 1. or width < 0.:             # <<<<<<<<<<<<<<
 *         raise ValueError('width must be between 0. and 1.')
 * 
 */
  }

  /* "orb/cutils.pyx":976
 *         raise ValueError('width must be between 0. and 1.')
 * 
 *     cdef int n = a.shape[0]             # <<<<<<<<<<<<<<
 *     cdef int fn = <int> floor(<double> n/2.)
 *     cdef np.ndarray[np.float64_t, ndim=1] hwindow = np.zeros(
 */
  __pyx_v_n = (__pyx_v_a->dimensions[0]);

  /* "orb/cutils.pyx":977
 * 
 *     cdef int n = a.shape[0]
 *     cdef int fn = <int> floor(<double> n/2.)             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.float64_t, ndim=1] hwindow = np.zeros(
 *         fn, dtype=np.float64)
 */
  __pyx_v_fn = ((int)floor((((double)__pyx_v_n) / 2.)));

  /* "orb/cutils.pyx":978
 *     cdef int n = a.shape[0]
 *     cdef int fn = <int> floor(<double> n/2.)
 *     cdef np.ndarray[np.float64_t, ndim=1] hwindow = np.zeros(             # <<<<<<<<<<<<<<
 *         fn, dtype=np.float64)
 *     cdef np.ndarray[np.float64_t, ndim=1] window = np.zeros(
 */
  __pyx_t_3 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 978, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_zeros); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 978, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;

  /* "orb/cutils.pyx":979
 *     cdef int fn = <int> floor(<double> n/2.)
 *     cdef np.ndarray[np.float64_t, ndim=1] hwindow = np.zeros(
 *         fn, dtype=np.float64)             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.float64_t, ndim=1] window = np.zeros(
 *         n, dtype=np.float64)
 */
  __pyx_t_3 = __Pyx_PyInt_From_int(__pyx_v_fn); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 979, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);

  /* "orb/cutils.pyx":978
 *     cdef int n = a.shape[0]
 *     cdef int fn = <int> floor(<double> n/2.)
 *     cdef np.ndarray[np.float64_t, ndim=1] hwindow = np.zeros(             # <<<<<<<<<<<<<<
 *         fn, dtype=np.float64)
 *     cdef np.ndarray[np.float64_t, ndim=1] window = np.zeros(
 */
  __pyx_t_5 = PyTuple_New(1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 978, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_GIVEREF(__pyx_t_3);
  PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_3);
  __pyx_t_3 = 0;

  /* "orb/cutils.pyx":979
 *     cdef int fn = <int> floor(<double> n/2.)
 *     cdef np.ndarray[np.float64_t, ndim=1] hwindow = np.zeros(
 *         fn, dtype=np.float64)             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.float64_t, ndim=1] window = np.zeros(
 *         n, dtype=np.float64)
 */
  __pyx_t_3 = PyDict_New(); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 979, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_6 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 979, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __pyx_t_7 = __Pyx_PyObject_GetAttrStr(__pyx_t_6, __pyx_n_s_float64); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 979, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_7);
  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
  if (PyDict_SetItem(__pyx_t_3, __pyx_n_s_dtype, __pyx_t_7) < 0) __PYX_ERR(0, 979, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;

  /* "orb/cutils.pyx":978
 *     cdef int n = a.shape[0]
 *     cdef int fn = <int> floor(<double> n/2.)
 *     cdef np.ndarray[np.float64_t, ndim=1] hwindow = np.zeros(             # <<<<<<<<<<<<<<
 *         fn, dtype=np.float64)
 *     cdef np.ndarray[np.float64_t, ndim=1] window = np.zeros(
 */
  __pyx_t_7 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_5, __pyx_t_3); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 978, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_7);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  if (!(likely(((__pyx_t_7) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_7, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 978, __pyx_L1_error)
  __pyx_t_8 = ((PyArrayObject *)__pyx_t_7);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_hwindow.rcbuffer->pybuffer, (PyObject*)__pyx_t_8, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
      __pyx_v_hwindow = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_hwindow.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 978, __pyx_L1_error)
    } else {__pyx_pybuffernd_hwindow.diminfo[0].strides = __pyx_pybuffernd_hwindow.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_hwindow.diminfo[0].shape = __pyx_pybuffernd_hwindow.rcbuffer->pybuffer.shape[0];
    }
  }
  __pyx_t_8 = 0;
  __pyx_v_hwindow = ((PyArrayObject *)__pyx_t_7);
  __pyx_t_7 = 0;

  /* "orb/cutils.pyx":980
 *     cdef np.ndarray[np.float64_t, ndim=1] hwindow = np.zeros(
 *         fn, dtype=np.float64)
 *     cdef np.ndarray[np.float64_t, ndim=1] window = np.zeros(             # <<<<<<<<<<<<<<
 *         n, dtype=np.float64)
 *     cdef int icut = max(0, <int> floor(<double> n * cutoff))
 */
  __pyx_t_7 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 980, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_7);
  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_7, __pyx_n_s_zeros); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 980, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;

  /* "orb/cutils.pyx":981
 *         fn, dtype=np.float64)
 *     cdef np.ndarray[np.float64_t, ndim=1] window = np.zeros(
 *         n, dtype=np.float64)             # <<<<<<<<<<<<<<
 *     cdef int icut = max(0, <int> floor(<double> n * cutoff))
 *     cdef double wlen = <double> fn * width
 */
  __pyx_t_7 = __Pyx_PyInt_From_int(__pyx_v_n); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 981, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_7);

  /* "orb/cutils.pyx":980
 *     cdef np.ndarray[np.float64_t, ndim=1] hwindow = np.zeros(
 *         fn, dtype=np.float64)
 *     cdef np.ndarray[np.float64_t, ndim=1] window = np.zeros(             # <<<<<<<<<<<<<<
 *         n, dtype=np.float64)
 *     cdef int icut = max(0, <int> floor(<double> n * cutoff))
 */
  __pyx_t_5 = PyTuple_New(1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 980, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_GIVEREF(__pyx_t_7);
  PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_7);
  __pyx_t_7 = 0;

  /* "orb/cutils.pyx":981
 *         fn, dtype=np.float64)
 *     cdef np.ndarray[np.float64_t, ndim=1] window = np.zeros(
 *         n, dtype=np.float64)             # <<<<<<<<<<<<<<
 *     cdef int icut = max(0, <int> floor(<double> n * cutoff))
 *     cdef double wlen = <double> fn * width
 */
  __pyx_t_7 = PyDict_New(); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 981, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_7);
  __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 981, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_float64); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 981, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  if (PyDict_SetItem(__pyx_t_7, __pyx_n_s_dtype, __pyx_t_6) < 0) __PYX_ERR(0, 981, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;

  /* "orb/cutils.pyx":980
 *     cdef np.ndarray[np.float64_t, ndim=1] hwindow = np.zeros(
 *         fn, dtype=np.float64)
 *     cdef np.ndarray[np.float64_t, ndim=1] window = np.zeros(             # <<<<<<<<<<<<<<
 *         n, dtype=np.float64)
 *     cdef int icut = max(0, <int> floor(<double> n * cutoff))
 */
  __pyx_t_6 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_5, __pyx_t_7); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 980, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
  if (!(likely(((__pyx_t_6) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_6, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 980, __pyx_L1_error)
  __pyx_t_9 = ((PyArrayObject *)__pyx_t_6);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_window.rcbuffer->pybuffer, (PyObject*)__pyx_t_9, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
      __pyx_v_window = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_window.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 980, __pyx_L1_error)
    } else {__pyx_pybuffernd_window.diminfo[0].strides = __pyx_pybuffernd_window.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_window.diminfo[0].shape = __pyx_pybuffernd_window.rcbuffer->pybuffer.shape[0];
    }
  }
  __pyx_t_9 = 0;
  __pyx_v_window = ((PyArrayObject *)__pyx_t_6);
  __pyx_t_6 = 0;

  /* "orb/cutils.pyx":982
 *     cdef np.ndarray[np.float64_t, ndim=1] window = np.zeros(
 *         n, dtype=np.float64)
 *     cdef int icut = max(0, <int> floor(<double> n * cutoff))             # <<<<<<<<<<<<<<
 *     cdef double wlen = <double> fn * width
 *     cdef int wsize = <int> ceil(wlen) * 2
 */
  __pyx_t_10 = ((int)floor((((double)__pyx_v_n) * __pyx_v_cutoff)));
  __pyx_t_11 = 0;
  if (((__pyx_t_10 > __pyx_t_11) != 0)) {
    __pyx_t_12 = __pyx_t_10;
  } else {
    __pyx_t_12 = __pyx_t_11;
  }
  __pyx_v_icut = __pyx_t_12;

  /* "orb/cutils.pyx":983
 *         n, dtype=np.float64)
 *     cdef int icut = max(0, <int> floor(<double> n * cutoff))
 *     cdef double wlen = <double> fn * width             # <<<<<<<<<<<<<<
 *     cdef int wsize = <int> ceil(wlen) * 2
 *     cdef np.ndarray[np.float64_t, ndim=1] w = np.zeros(
 */
  __pyx_v_wlen = (((double)__pyx_v_fn) * __pyx_v_width);

  /* "orb/cutils.pyx":984
 *     cdef int icut = max(0, <int> floor(<double> n * cutoff))
 *     cdef double wlen = <double> fn * width
 *     cdef int wsize = <int> ceil(wlen) * 2             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.float64_t, ndim=1] w = np.zeros(
 *         wsize, dtype=np.float64)
 */
  __pyx_v_wsize = (((int)ceil(__pyx_v_wlen)) * 2);

  /* "orb/cutils.pyx":985
 *     cdef double wlen = <double> fn * width
 *     cdef int wsize = <int> ceil(wlen) * 2
 *     cdef np.ndarray[np.float64_t, ndim=1] w = np.zeros(             # <<<<<<<<<<<<<<
 *         wsize, dtype=np.float64)
 *     cdef double dx
 */
  __pyx_t_6 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 985, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __pyx_t_7 = __Pyx_PyObject_GetAttrStr(__pyx_t_6, __pyx_n_s_zeros); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 985, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_7);
  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;

  /* "orb/cutils.pyx":986
 *     cdef int wsize = <int> ceil(wlen) * 2
 *     cdef np.ndarray[np.float64_t, ndim=1] w = np.zeros(
 *         wsize, dtype=np.float64)             # <<<<<<<<<<<<<<
 *     cdef double dx
 *     cdef int minx, maxx
 */
  __pyx_t_6 = __Pyx_PyInt_From_int(__pyx_v_wsize); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 986, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);

  /* "orb/cutils.pyx":985
 *     cdef double wlen = <double> fn * width
 *     cdef int wsize = <int> ceil(wlen) * 2
 *     cdef np.ndarray[np.float64_t, ndim=1] w = np.zeros(             # <<<<<<<<<<<<<<
 *         wsize, dtype=np.float64)
 *     cdef double dx
 */
  __pyx_t_5 = PyTuple_New(1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 985, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_GIVEREF(__pyx_t_6);
  PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_6);
  __pyx_t_6 = 0;

  /* "orb/cutils.pyx":986
 *     cdef int wsize = <int> ceil(wlen) * 2
 *     cdef np.ndarray[np.float64_t, ndim=1] w = np.zeros(
 *         wsize, dtype=np.float64)             # <<<<<<<<<<<<<<
 *     cdef double dx
 *     cdef int minx, maxx
 */
  __pyx_t_6 = PyDict_New(); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 986, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __pyx_t_3 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 986, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_float64); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 986, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  if (PyDict_SetItem(__pyx_t_6, __pyx_n_s_dtype, __pyx_t_4) < 0) __PYX_ERR(0, 986, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;

  /* "orb/cutils.pyx":985
 *     cdef double wlen = <double> fn * width
 *     cdef int wsize = <int> ceil(wlen) * 2
 *     cdef np.ndarray[np.float64_t, ndim=1] w = np.zeros(             # <<<<<<<<<<<<<<
 *         wsize, dtype=np.float64)
 *     cdef double dx
 */
  __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_7, __pyx_t_5, __pyx_t_6); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 985, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
  if (!(likely(((__pyx_t_4) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_4, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 985, __pyx_L1_error)
  __pyx_t_13 = ((PyArrayObject *)__pyx_t_4);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_w.rcbuffer->pybuffer, (PyObject*)__pyx_t_13, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 1, 0, __pyx_stack) == -1)) {
      __pyx_v_w = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_w.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 985, __pyx_L1_error)
    } else {__pyx_pybuffernd_w.diminfo[0].strides = __pyx_pybuffernd_w.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_w.diminfo[0].shape = __pyx_pybuffernd_w.rcbuffer->pybuffer.shape[0];
    }
  }
  __pyx_t_13 = 0;
  __pyx_v_w = ((PyArrayObject *)__pyx_t_4);
  __pyx_t_4 = 0;

  /* "orb/cutils.pyx":992
 * 
 *     # half-window design
 *     dx = <double> fn * cutoff - <double> icut             # <<<<<<<<<<<<<<
 *     w = gaussian1d(np.arange(wsize, dtype=np.float64),
 *                    0., 1., dx, wlen / 1.5)
 */
  __pyx_v_dx = ((((double)__pyx_v_fn) * __pyx_v_cutoff) - ((double)__pyx_v_icut));

  /* "orb/cutils.pyx":993
 *     # half-window design
 *     dx = <double> fn * cutoff - <double> icut
 *     w = gaussian1d(np.arange(wsize, dtype=np.float64),             # <<<<<<<<<<<<<<
 *                    0., 1., dx, wlen / 1.5)
 *     w[0] = 1.
 */
  __pyx_t_6 = __Pyx_GetModuleGlobalName(__pyx_n_s_gaussian1d); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 993, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 993, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_7 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_arange); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 993, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_7);
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_5 = __Pyx_PyInt_From_int(__pyx_v_wsize); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 993, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 993, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_GIVEREF(__pyx_t_5);
  PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_5);
  __pyx_t_5 = 0;
  __pyx_t_5 = PyDict_New(); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 993, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_14 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 993, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_14);
  __pyx_t_15 = __Pyx_PyObject_GetAttrStr(__pyx_t_14, __pyx_n_s_float64); if (unlikely(!__pyx_t_15)) __PYX_ERR(0, 993, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_15);
  __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
  if (PyDict_SetItem(__pyx_t_5, __pyx_n_s_dtype, __pyx_t_15) < 0) __PYX_ERR(0, 993, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_15); __pyx_t_15 = 0;
  __pyx_t_15 = __Pyx_PyObject_Call(__pyx_t_7, __pyx_t_3, __pyx_t_5); if (unlikely(!__pyx_t_15)) __PYX_ERR(0, 993, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_15);
  __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

  /* "orb/cutils.pyx":994
 *     dx = <double> fn * cutoff - <double> icut
 *     w = gaussian1d(np.arange(wsize, dtype=np.float64),
 *                    0., 1., dx, wlen / 1.5)             # <<<<<<<<<<<<<<
 *     w[0] = 1.
 * 
 */
  __pyx_t_5 = PyFloat_FromDouble(__pyx_v_dx); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 994, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_3 = PyFloat_FromDouble((__pyx_v_wlen / 1.5)); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 994, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_7 = NULL;
  __pyx_t_16 = 0;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_6))) {
    __pyx_t_7 = PyMethod_GET_SELF(__pyx_t_6);
    if (likely(__pyx_t_7)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_6);
      __Pyx_INCREF(__pyx_t_7);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_6, function);
      __pyx_t_16 = 1;
    }
  }
  __pyx_t_14 = PyTuple_New(5+__pyx_t_16); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 993, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_14);
  if (__pyx_t_7) {
    __Pyx_GIVEREF(__pyx_t_7); PyTuple_SET_ITEM(__pyx_t_14, 0, __pyx_t_7); __pyx_t_7 = NULL;
  }
  __Pyx_GIVEREF(__pyx_t_15);
  PyTuple_SET_ITEM(__pyx_t_14, 0+__pyx_t_16, __pyx_t_15);
  __Pyx_INCREF(__pyx_float_0_);
  __Pyx_GIVEREF(__pyx_float_0_);
  PyTuple_SET_ITEM(__pyx_t_14, 1+__pyx_t_16, __pyx_float_0_);
  __Pyx_INCREF(__pyx_float_1_);
  __Pyx_GIVEREF(__pyx_float_1_);
  PyTuple_SET_ITEM(__pyx_t_14, 2+__pyx_t_16, __pyx_float_1_);
  __Pyx_GIVEREF(__pyx_t_5);
  PyTuple_SET_ITEM(__pyx_t_14, 3+__pyx_t_16, __pyx_t_5);
  __Pyx_GIVEREF(__pyx_t_3);
  PyTuple_SET_ITEM(__pyx_t_14, 4+__pyx_t_16, __pyx_t_3);
  __pyx_t_15 = 0;
  __pyx_t_5 = 0;
  __pyx_t_3 = 0;
  __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_6, __pyx_t_14, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 993, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;

  /* "orb/cutils.pyx":993
 *     # half-window design
 *     dx = <double> fn * cutoff - <double> icut
 *     w = gaussian1d(np.arange(wsize, dtype=np.float64),             # <<<<<<<<<<<<<<
 *                    0., 1., dx, wlen / 1.5)
 *     w[0] = 1.
 */
  if (!(likely(((__pyx_t_4) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_4, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 993, __pyx_L1_error)
  __pyx_t_13 = ((PyArrayObject *)__pyx_t_4);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_w.rcbuffer->pybuffer);
    __pyx_t_10 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_w.rcbuffer->pybuffer, (PyObject*)__pyx_t_13, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 1, 0, __pyx_stack);
    if (unlikely(__pyx_t_10 < 0)) {
      PyErr_Fetch(&__pyx_t_17, &__pyx_t_18, &__pyx_t_19);
      if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_w.rcbuffer->pybuffer, (PyObject*)__pyx_v_w, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 1, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_17); Py_XDECREF(__pyx_t_18); Py_XDECREF(__pyx_t_19);
        __Pyx_RaiseBufferFallbackError();
      } else {
        PyErr_Restore(__pyx_t_17, __pyx_t_18, __pyx_t_19);
      }
    }
    __pyx_pybuffernd_w.diminfo[0].strides = __pyx_pybuffernd_w.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_w.diminfo[0].shape = __pyx_pybuffernd_w.rcbuffer->pybuffer.shape[0];
    if (unlikely(__pyx_t_10 < 0)) __PYX_ERR(0, 993, __pyx_L1_error)
  }
  __pyx_t_13 = 0;
  __Pyx_DECREF_SET(__pyx_v_w, ((PyArrayObject *)__pyx_t_4));
  __pyx_t_4 = 0;

  /* "orb/cutils.pyx":995
 *     w = gaussian1d(np.arange(wsize, dtype=np.float64),
 *                    0., 1., dx, wlen / 1.5)
 *     w[0] = 1.             # <<<<<<<<<<<<<<
 * 
 *     minx = icut - <int> floor(wlen / 2.)
 */
  __pyx_t_20 = 0;
  __pyx_t_10 = -1;
  if (__pyx_t_20 < 0) {
    __pyx_t_20 += __pyx_pybuffernd_w.diminfo[0].shape;
    if (unlikely(__pyx_t_20 < 0)) __pyx_t_10 = 0;
  } else if (unlikely(__pyx_t_20 >= __pyx_pybuffernd_w.diminfo[0].shape)) __pyx_t_10 = 0;
  if (unlikely(__pyx_t_10 != -1)) {
    __Pyx_RaiseBufferIndexError(__pyx_t_10);
    __PYX_ERR(0, 995, __pyx_L1_error)
  }
  *__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_w.rcbuffer->pybuffer.buf, __pyx_t_20, __pyx_pybuffernd_w.diminfo[0].strides) = 1.;

  /* "orb/cutils.pyx":997
 *     w[0] = 1.
 * 
 *     minx = icut - <int> floor(wlen / 2.)             # <<<<<<<<<<<<<<
 *     maxx = minx + w.shape[0]
 *     if minx < 0:
 */
  __pyx_v_minx = (__pyx_v_icut - ((int)floor((__pyx_v_wlen / 2.))));

  /* "orb/cutils.pyx":998
 * 
 *     minx = icut - <int> floor(wlen / 2.)
 *     maxx = minx + w.shape[0]             # <<<<<<<<<<<<<<
 *     if minx < 0:
 *         w = w[-minx:]
 */
  __pyx_v_maxx = (__pyx_v_minx + (__pyx_v_w->dimensions[0]));

  /* "orb/cutils.pyx":999
 *     minx = icut - <int> floor(wlen / 2.)
 *     maxx = minx + w.shape[0]
 *     if minx < 0:             # <<<<<<<<<<<<<<
 *         w = w[-minx:]
 *         minx = 0
 */
  __pyx_t_1 = ((__pyx_v_minx < 0) != 0);
  if (__pyx_t_1) {

    /* "orb/cutils.pyx":1000
 *     maxx = minx + w.shape[0]
 *     if minx < 0:
 *         w = w[-minx:]             # <<<<<<<<<<<<<<
 *         minx = 0
 *     if maxx >= fn:
 */
    __pyx_t_4 = __Pyx_PyObject_GetSlice(((PyObject *)__pyx_v_w), (-__pyx_v_minx), 0, NULL, NULL, NULL, 1, 0, 1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1000, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    if (!(likely(((__pyx_t_4) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_4, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1000, __pyx_L1_error)
    __pyx_t_13 = ((PyArrayObject *)__pyx_t_4);
    {
      __Pyx_BufFmt_StackElem __pyx_stack[1];
      __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_w.rcbuffer->pybuffer);
      __pyx_t_10 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_w.rcbuffer->pybuffer, (PyObject*)__pyx_t_13, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 1, 0, __pyx_stack);
      if (unlikely(__pyx_t_10 < 0)) {
        PyErr_Fetch(&__pyx_t_19, &__pyx_t_18, &__pyx_t_17);
        if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_w.rcbuffer->pybuffer, (PyObject*)__pyx_v_w, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 1, 0, __pyx_stack) == -1)) {
          Py_XDECREF(__pyx_t_19); Py_XDECREF(__pyx_t_18); Py_XDECREF(__pyx_t_17);
          __Pyx_RaiseBufferFallbackError();
        } else {
          PyErr_Restore(__pyx_t_19, __pyx_t_18, __pyx_t_17);
        }
      }
      __pyx_pybuffernd_w.diminfo[0].strides = __pyx_pybuffernd_w.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_w.diminfo[0].shape = __pyx_pybuffernd_w.rcbuffer->pybuffer.shape[0];
      if (unlikely(__pyx_t_10 < 0)) __PYX_ERR(0, 1000, __pyx_L1_error)
    }
    __pyx_t_13 = 0;
    __Pyx_DECREF_SET(__pyx_v_w, ((PyArrayObject *)__pyx_t_4));
    __pyx_t_4 = 0;

    /* "orb/cutils.pyx":1001
 *     if minx < 0:
 *         w = w[-minx:]
 *         minx = 0             # <<<<<<<<<<<<<<
 *     if maxx >= fn:
 *         w = w[:fn-maxx]
 */
    __pyx_v_minx = 0;

    /* "orb/cutils.pyx":999
 *     minx = icut - <int> floor(wlen / 2.)
 *     maxx = minx + w.shape[0]
 *     if minx < 0:             # <<<<<<<<<<<<<<
 *         w = w[-minx:]
 *         minx = 0
 */
  }

  /* "orb/cutils.pyx":1002
 *         w = w[-minx:]
 *         minx = 0
 *     if maxx >= fn:             # <<<<<<<<<<<<<<
 *         w = w[:fn-maxx]
 *         maxx = fn
 */
  __pyx_t_1 = ((__pyx_v_maxx >= __pyx_v_fn) != 0);
  if (__pyx_t_1) {

    /* "orb/cutils.pyx":1003
 *         minx = 0
 *     if maxx >= fn:
 *         w = w[:fn-maxx]             # <<<<<<<<<<<<<<
 *         maxx = fn
 *     hwindow[minx:maxx] = w
 */
    __pyx_t_4 = __Pyx_PyObject_GetSlice(((PyObject *)__pyx_v_w), 0, (__pyx_v_fn - __pyx_v_maxx), NULL, NULL, NULL, 0, 1, 1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1003, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    if (!(likely(((__pyx_t_4) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_4, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1003, __pyx_L1_error)
    __pyx_t_13 = ((PyArrayObject *)__pyx_t_4);
    {
      __Pyx_BufFmt_StackElem __pyx_stack[1];
      __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_w.rcbuffer->pybuffer);
      __pyx_t_10 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_w.rcbuffer->pybuffer, (PyObject*)__pyx_t_13, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 1, 0, __pyx_stack);
      if (unlikely(__pyx_t_10 < 0)) {
        PyErr_Fetch(&__pyx_t_17, &__pyx_t_18, &__pyx_t_19);
        if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_w.rcbuffer->pybuffer, (PyObject*)__pyx_v_w, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 1, 0, __pyx_stack) == -1)) {
          Py_XDECREF(__pyx_t_17); Py_XDECREF(__pyx_t_18); Py_XDECREF(__pyx_t_19);
          __Pyx_RaiseBufferFallbackError();
        } else {
          PyErr_Restore(__pyx_t_17, __pyx_t_18, __pyx_t_19);
        }
      }
      __pyx_pybuffernd_w.diminfo[0].strides = __pyx_pybuffernd_w.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_w.diminfo[0].shape = __pyx_pybuffernd_w.rcbuffer->pybuffer.shape[0];
      if (unlikely(__pyx_t_10 < 0)) __PYX_ERR(0, 1003, __pyx_L1_error)
    }
    __pyx_t_13 = 0;
    __Pyx_DECREF_SET(__pyx_v_w, ((PyArrayObject *)__pyx_t_4));
    __pyx_t_4 = 0;

    /* "orb/cutils.pyx":1004
 *     if maxx >= fn:
 *         w = w[:fn-maxx]
 *         maxx = fn             # <<<<<<<<<<<<<<
 *     hwindow[minx:maxx] = w
 *     if minx > 0:
 */
    __pyx_v_maxx = __pyx_v_fn;

    /* "orb/cutils.pyx":1002
 *         w = w[-minx:]
 *         minx = 0
 *     if maxx >= fn:             # <<<<<<<<<<<<<<
 *         w = w[:fn-maxx]
 *         maxx = fn
 */
  }

  /* "orb/cutils.pyx":1005
 *         w = w[:fn-maxx]
 *         maxx = fn
 *     hwindow[minx:maxx] = w             # <<<<<<<<<<<<<<
 *     if minx > 0:
 *         hwindow[:minx+1] = 1.
 */
  if (__Pyx_PyObject_SetSlice(((PyObject *)__pyx_v_hwindow), ((PyObject *)__pyx_v_w), __pyx_v_minx, __pyx_v_maxx, NULL, NULL, NULL, 1, 1, 1) < 0) __PYX_ERR(0, 1005, __pyx_L1_error)

  /* "orb/cutils.pyx":1006
 *         maxx = fn
 *     hwindow[minx:maxx] = w
 *     if minx > 0:             # <<<<<<<<<<<<<<
 *         hwindow[:minx+1] = 1.
 * 
 */
  __pyx_t_1 = ((__pyx_v_minx > 0) != 0);
  if (__pyx_t_1) {

    /* "orb/cutils.pyx":1007
 *     hwindow[minx:maxx] = w
 *     if minx > 0:
 *         hwindow[:minx+1] = 1.             # <<<<<<<<<<<<<<
 * 
 *     if not lowpass:
 */
    if (__Pyx_PyObject_SetSlice(((PyObject *)__pyx_v_hwindow), __pyx_float_1_, 0, (__pyx_v_minx + 1), NULL, NULL, NULL, 0, 1, 1) < 0) __PYX_ERR(0, 1007, __pyx_L1_error)

    /* "orb/cutils.pyx":1006
 *         maxx = fn
 *     hwindow[minx:maxx] = w
 *     if minx > 0:             # <<<<<<<<<<<<<<
 *         hwindow[:minx+1] = 1.
 * 
 */
  }

  /* "orb/cutils.pyx":1009
 *         hwindow[:minx+1] = 1.
 * 
 *     if not lowpass:             # <<<<<<<<<<<<<<
 *         hwindow = - hwindow + 1.
 * 
 */
  __pyx_t_1 = __Pyx_PyObject_IsTrue(((PyObject *)__pyx_v_lowpass)); if (unlikely(__pyx_t_1 < 0)) __PYX_ERR(0, 1009, __pyx_L1_error)
  __pyx_t_2 = ((!__pyx_t_1) != 0);
  if (__pyx_t_2) {

    /* "orb/cutils.pyx":1010
 * 
 *     if not lowpass:
 *         hwindow = - hwindow + 1.             # <<<<<<<<<<<<<<
 * 
 *     if not n%2:
 */
    __pyx_t_4 = PyNumber_Negative(((PyObject *)__pyx_v_hwindow)); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1010, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __pyx_t_6 = __Pyx_PyFloat_AddObjC(__pyx_t_4, __pyx_float_1_, 1., 0); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1010, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    if (!(likely(((__pyx_t_6) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_6, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1010, __pyx_L1_error)
    __pyx_t_8 = ((PyArrayObject *)__pyx_t_6);
    {
      __Pyx_BufFmt_StackElem __pyx_stack[1];
      __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_hwindow.rcbuffer->pybuffer);
      __pyx_t_10 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_hwindow.rcbuffer->pybuffer, (PyObject*)__pyx_t_8, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack);
      if (unlikely(__pyx_t_10 < 0)) {
        PyErr_Fetch(&__pyx_t_19, &__pyx_t_18, &__pyx_t_17);
        if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_hwindow.rcbuffer->pybuffer, (PyObject*)__pyx_v_hwindow, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
          Py_XDECREF(__pyx_t_19); Py_XDECREF(__pyx_t_18); Py_XDECREF(__pyx_t_17);
          __Pyx_RaiseBufferFallbackError();
        } else {
          PyErr_Restore(__pyx_t_19, __pyx_t_18, __pyx_t_17);
        }
      }
      __pyx_pybuffernd_hwindow.diminfo[0].strides = __pyx_pybuffernd_hwindow.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_hwindow.diminfo[0].shape = __pyx_pybuffernd_hwindow.rcbuffer->pybuffer.shape[0];
      if (unlikely(__pyx_t_10 < 0)) __PYX_ERR(0, 1010, __pyx_L1_error)
    }
    __pyx_t_8 = 0;
    __Pyx_DECREF_SET(__pyx_v_hwindow, ((PyArrayObject *)__pyx_t_6));
    __pyx_t_6 = 0;

    /* "orb/cutils.pyx":1009
 *         hwindow[:minx+1] = 1.
 * 
 *     if not lowpass:             # <<<<<<<<<<<<<<
 *         hwindow = - hwindow + 1.
 * 
 */
  }

  /* "orb/cutils.pyx":1012
 *         hwindow = - hwindow + 1.
 * 
 *     if not n%2:             # <<<<<<<<<<<<<<
 *         window = np.hstack((hwindow, hwindow[::-1]))
 *     else:
 */
  __pyx_t_2 = ((!(__Pyx_mod_long(__pyx_v_n, 2) != 0)) != 0);
  if (__pyx_t_2) {

    /* "orb/cutils.pyx":1013
 * 
 *     if not n%2:
 *         window = np.hstack((hwindow, hwindow[::-1]))             # <<<<<<<<<<<<<<
 *     else:
 *         window = np.hstack((hwindow, hwindow[-1], hwindow[::-1]))
 */
    __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1013, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __pyx_t_14 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_hstack); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 1013, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_14);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_t_4 = PyObject_GetItem(((PyObject *)__pyx_v_hwindow), __pyx_slice__51); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1013, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __pyx_t_3 = PyTuple_New(2); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1013, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_INCREF(((PyObject *)__pyx_v_hwindow));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_hwindow));
    PyTuple_SET_ITEM(__pyx_t_3, 0, ((PyObject *)__pyx_v_hwindow));
    __Pyx_GIVEREF(__pyx_t_4);
    PyTuple_SET_ITEM(__pyx_t_3, 1, __pyx_t_4);
    __pyx_t_4 = 0;
    __pyx_t_4 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_14))) {
      __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_14);
      if (likely(__pyx_t_4)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_14);
        __Pyx_INCREF(__pyx_t_4);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_14, function);
      }
    }
    if (!__pyx_t_4) {
      __pyx_t_6 = __Pyx_PyObject_CallOneArg(__pyx_t_14, __pyx_t_3); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1013, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      __Pyx_GOTREF(__pyx_t_6);
    } else {
      __pyx_t_5 = PyTuple_New(1+1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1013, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_4); __pyx_t_4 = NULL;
      __Pyx_GIVEREF(__pyx_t_3);
      PyTuple_SET_ITEM(__pyx_t_5, 0+1, __pyx_t_3);
      __pyx_t_3 = 0;
      __pyx_t_6 = __Pyx_PyObject_Call(__pyx_t_14, __pyx_t_5, NULL); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1013, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_6);
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    }
    __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
    if (!(likely(((__pyx_t_6) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_6, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1013, __pyx_L1_error)
    __pyx_t_9 = ((PyArrayObject *)__pyx_t_6);
    {
      __Pyx_BufFmt_StackElem __pyx_stack[1];
      __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_window.rcbuffer->pybuffer);
      __pyx_t_10 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_window.rcbuffer->pybuffer, (PyObject*)__pyx_t_9, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack);
      if (unlikely(__pyx_t_10 < 0)) {
        PyErr_Fetch(&__pyx_t_17, &__pyx_t_18, &__pyx_t_19);
        if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_window.rcbuffer->pybuffer, (PyObject*)__pyx_v_window, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
          Py_XDECREF(__pyx_t_17); Py_XDECREF(__pyx_t_18); Py_XDECREF(__pyx_t_19);
          __Pyx_RaiseBufferFallbackError();
        } else {
          PyErr_Restore(__pyx_t_17, __pyx_t_18, __pyx_t_19);
        }
      }
      __pyx_pybuffernd_window.diminfo[0].strides = __pyx_pybuffernd_window.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_window.diminfo[0].shape = __pyx_pybuffernd_window.rcbuffer->pybuffer.shape[0];
      if (unlikely(__pyx_t_10 < 0)) __PYX_ERR(0, 1013, __pyx_L1_error)
    }
    __pyx_t_9 = 0;
    __Pyx_DECREF_SET(__pyx_v_window, ((PyArrayObject *)__pyx_t_6));
    __pyx_t_6 = 0;

    /* "orb/cutils.pyx":1012
 *         hwindow = - hwindow + 1.
 * 
 *     if not n%2:             # <<<<<<<<<<<<<<
 *         window = np.hstack((hwindow, hwindow[::-1]))
 *     else:
 */
    goto __pyx_L13;
  }

  /* "orb/cutils.pyx":1015
 *         window = np.hstack((hwindow, hwindow[::-1]))
 *     else:
 *         window = np.hstack((hwindow, hwindow[-1], hwindow[::-1]))             # <<<<<<<<<<<<<<
 * 
 *     if bn.anynan(a):
 */
  /*else*/ {
    __pyx_t_14 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 1015, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_14);
    __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_14, __pyx_n_s_hstack); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1015, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
    __pyx_t_21 = -1L;
    __pyx_t_10 = -1;
    if (__pyx_t_21 < 0) {
      __pyx_t_21 += __pyx_pybuffernd_hwindow.diminfo[0].shape;
      if (unlikely(__pyx_t_21 < 0)) __pyx_t_10 = 0;
    } else if (unlikely(__pyx_t_21 >= __pyx_pybuffernd_hwindow.diminfo[0].shape)) __pyx_t_10 = 0;
    if (unlikely(__pyx_t_10 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_10);
      __PYX_ERR(0, 1015, __pyx_L1_error)
    }
    __pyx_t_14 = PyFloat_FromDouble((*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_hwindow.rcbuffer->pybuffer.buf, __pyx_t_21, __pyx_pybuffernd_hwindow.diminfo[0].strides))); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 1015, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_14);
    __pyx_t_3 = PyObject_GetItem(((PyObject *)__pyx_v_hwindow), __pyx_slice__52); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1015, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __pyx_t_4 = PyTuple_New(3); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1015, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_INCREF(((PyObject *)__pyx_v_hwindow));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_hwindow));
    PyTuple_SET_ITEM(__pyx_t_4, 0, ((PyObject *)__pyx_v_hwindow));
    __Pyx_GIVEREF(__pyx_t_14);
    PyTuple_SET_ITEM(__pyx_t_4, 1, __pyx_t_14);
    __Pyx_GIVEREF(__pyx_t_3);
    PyTuple_SET_ITEM(__pyx_t_4, 2, __pyx_t_3);
    __pyx_t_14 = 0;
    __pyx_t_3 = 0;
    __pyx_t_3 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_5))) {
      __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_5);
      if (likely(__pyx_t_3)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_5);
        __Pyx_INCREF(__pyx_t_3);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_5, function);
      }
    }
    if (!__pyx_t_3) {
      __pyx_t_6 = __Pyx_PyObject_CallOneArg(__pyx_t_5, __pyx_t_4); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1015, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __Pyx_GOTREF(__pyx_t_6);
    } else {
      __pyx_t_14 = PyTuple_New(1+1); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 1015, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_14);
      __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_14, 0, __pyx_t_3); __pyx_t_3 = NULL;
      __Pyx_GIVEREF(__pyx_t_4);
      PyTuple_SET_ITEM(__pyx_t_14, 0+1, __pyx_t_4);
      __pyx_t_4 = 0;
      __pyx_t_6 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_14, NULL); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1015, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_6);
      __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
    }
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    if (!(likely(((__pyx_t_6) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_6, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1015, __pyx_L1_error)
    __pyx_t_9 = ((PyArrayObject *)__pyx_t_6);
    {
      __Pyx_BufFmt_StackElem __pyx_stack[1];
      __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_window.rcbuffer->pybuffer);
      __pyx_t_10 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_window.rcbuffer->pybuffer, (PyObject*)__pyx_t_9, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack);
      if (unlikely(__pyx_t_10 < 0)) {
        PyErr_Fetch(&__pyx_t_19, &__pyx_t_18, &__pyx_t_17);
        if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_window.rcbuffer->pybuffer, (PyObject*)__pyx_v_window, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
          Py_XDECREF(__pyx_t_19); Py_XDECREF(__pyx_t_18); Py_XDECREF(__pyx_t_17);
          __Pyx_RaiseBufferFallbackError();
        } else {
          PyErr_Restore(__pyx_t_19, __pyx_t_18, __pyx_t_17);
        }
      }
      __pyx_pybuffernd_window.diminfo[0].strides = __pyx_pybuffernd_window.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_window.diminfo[0].shape = __pyx_pybuffernd_window.rcbuffer->pybuffer.shape[0];
      if (unlikely(__pyx_t_10 < 0)) __PYX_ERR(0, 1015, __pyx_L1_error)
    }
    __pyx_t_9 = 0;
    __Pyx_DECREF_SET(__pyx_v_window, ((PyArrayObject *)__pyx_t_6));
    __pyx_t_6 = 0;
  }
  __pyx_L13:;

  /* "orb/cutils.pyx":1017
 *         window = np.hstack((hwindow, hwindow[-1], hwindow[::-1]))
 * 
 *     if bn.anynan(a):             # <<<<<<<<<<<<<<
 *         median_a = robust_median(a)
 *         a[np.nonzero(np.isnan(a))] = median_a
 */
  __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1017, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_14 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_anynan); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 1017, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_14);
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_5 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_14))) {
    __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_14);
    if (likely(__pyx_t_5)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_14);
      __Pyx_INCREF(__pyx_t_5);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_14, function);
    }
  }
  if (!__pyx_t_5) {
    __pyx_t_6 = __Pyx_PyObject_CallOneArg(__pyx_t_14, ((PyObject *)__pyx_v_a)); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1017, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
  } else {
    __pyx_t_4 = PyTuple_New(1+1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1017, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_5); __pyx_t_5 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_a));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_a));
    PyTuple_SET_ITEM(__pyx_t_4, 0+1, ((PyObject *)__pyx_v_a));
    __pyx_t_6 = __Pyx_PyObject_Call(__pyx_t_14, __pyx_t_4, NULL); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1017, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  }
  __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
  __pyx_t_2 = __Pyx_PyObject_IsTrue(__pyx_t_6); if (unlikely(__pyx_t_2 < 0)) __PYX_ERR(0, 1017, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
  if (__pyx_t_2) {

    /* "orb/cutils.pyx":1018
 * 
 *     if bn.anynan(a):
 *         median_a = robust_median(a)             # <<<<<<<<<<<<<<
 *         a[np.nonzero(np.isnan(a))] = median_a
 * 
 */
    __pyx_t_14 = __Pyx_GetModuleGlobalName(__pyx_n_s_robust_median); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 1018, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_14);
    __pyx_t_4 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_14))) {
      __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_14);
      if (likely(__pyx_t_4)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_14);
        __Pyx_INCREF(__pyx_t_4);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_14, function);
      }
    }
    if (!__pyx_t_4) {
      __pyx_t_6 = __Pyx_PyObject_CallOneArg(__pyx_t_14, ((PyObject *)__pyx_v_a)); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1018, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_6);
    } else {
      __pyx_t_5 = PyTuple_New(1+1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1018, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_4); __pyx_t_4 = NULL;
      __Pyx_INCREF(((PyObject *)__pyx_v_a));
      __Pyx_GIVEREF(((PyObject *)__pyx_v_a));
      PyTuple_SET_ITEM(__pyx_t_5, 0+1, ((PyObject *)__pyx_v_a));
      __pyx_t_6 = __Pyx_PyObject_Call(__pyx_t_14, __pyx_t_5, NULL); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1018, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_6);
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    }
    __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
    __pyx_t_22 = __pyx_PyFloat_AsDouble(__pyx_t_6); if (unlikely((__pyx_t_22 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 1018, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
    __pyx_v_median_a = __pyx_t_22;

    /* "orb/cutils.pyx":1019
 *     if bn.anynan(a):
 *         median_a = robust_median(a)
 *         a[np.nonzero(np.isnan(a))] = median_a             # <<<<<<<<<<<<<<
 * 
 *     # FFT and IFFT
 */
    __pyx_t_6 = PyFloat_FromDouble(__pyx_v_median_a); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1019, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
    __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1019, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_nonzero); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1019, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    __pyx_t_3 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1019, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __pyx_t_15 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_isnan); if (unlikely(!__pyx_t_15)) __PYX_ERR(0, 1019, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_15);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __pyx_t_3 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_15))) {
      __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_15);
      if (likely(__pyx_t_3)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_15);
        __Pyx_INCREF(__pyx_t_3);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_15, function);
      }
    }
    if (!__pyx_t_3) {
      __pyx_t_5 = __Pyx_PyObject_CallOneArg(__pyx_t_15, ((PyObject *)__pyx_v_a)); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1019, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
    } else {
      __pyx_t_7 = PyTuple_New(1+1); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 1019, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_7);
      __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_7, 0, __pyx_t_3); __pyx_t_3 = NULL;
      __Pyx_INCREF(((PyObject *)__pyx_v_a));
      __Pyx_GIVEREF(((PyObject *)__pyx_v_a));
      PyTuple_SET_ITEM(__pyx_t_7, 0+1, ((PyObject *)__pyx_v_a));
      __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_15, __pyx_t_7, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1019, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
    }
    __Pyx_DECREF(__pyx_t_15); __pyx_t_15 = 0;
    __pyx_t_15 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_4))) {
      __pyx_t_15 = PyMethod_GET_SELF(__pyx_t_4);
      if (likely(__pyx_t_15)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
        __Pyx_INCREF(__pyx_t_15);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_4, function);
      }
    }
    if (!__pyx_t_15) {
      __pyx_t_14 = __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_5); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 1019, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
      __Pyx_GOTREF(__pyx_t_14);
    } else {
      __pyx_t_7 = PyTuple_New(1+1); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 1019, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_7);
      __Pyx_GIVEREF(__pyx_t_15); PyTuple_SET_ITEM(__pyx_t_7, 0, __pyx_t_15); __pyx_t_15 = NULL;
      __Pyx_GIVEREF(__pyx_t_5);
      PyTuple_SET_ITEM(__pyx_t_7, 0+1, __pyx_t_5);
      __pyx_t_5 = 0;
      __pyx_t_14 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_7, NULL); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 1019, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_14);
      __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
    }
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    if (unlikely(PyObject_SetItem(((PyObject *)__pyx_v_a), __pyx_t_14, __pyx_t_6) < 0)) __PYX_ERR(0, 1019, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;

    /* "orb/cutils.pyx":1017
 *         window = np.hstack((hwindow, hwindow[-1], hwindow[::-1]))
 * 
 *     if bn.anynan(a):             # <<<<<<<<<<<<<<
 *         median_a = robust_median(a)
 *         a[np.nonzero(np.isnan(a))] = median_a
 */
  }

  /* "orb/cutils.pyx":1022
 * 
 *     # FFT and IFFT
 *     return (np.fft.ifft(np.fft.fft(a) * window)).real             # <<<<<<<<<<<<<<
 * 
 * 
 */
  __Pyx_XDECREF(__pyx_r);
  __pyx_t_14 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 1022, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_14);
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_14, __pyx_n_s_fft); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1022, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
  __pyx_t_14 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_ifft); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 1022, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_14);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_7 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 1022, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_7);
  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_7, __pyx_n_s_fft); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1022, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
  __pyx_t_7 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_fft); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 1022, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_7);
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_5 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && likely(PyMethod_Check(__pyx_t_7))) {
    __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_7);
    if (likely(__pyx_t_5)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_7);
      __Pyx_INCREF(__pyx_t_5);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_7, function);
    }
  }
  if (!__pyx_t_5) {
    __pyx_t_4 = __Pyx_PyObject_CallOneArg(__pyx_t_7, ((PyObject *)__pyx_v_a)); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1022, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
  } else {
    __pyx_t_15 = PyTuple_New(1+1); if (unlikely(!__pyx_t_15)) __PYX_ERR(0, 1022, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_15);
    __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_15, 0, __pyx_t_5); __pyx_t_5 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_a));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_a));
    PyTuple_SET_ITEM(__pyx_t_15, 0+1, ((PyObject *)__pyx_v_a));
    __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_7, __pyx_t_15, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1022, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_15); __pyx_t_15 = 0;
  }
  __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
  __pyx_t_7 = PyNumber_Multiply(__pyx_t_4, ((PyObject *)__pyx_v_window)); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 1022, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_7);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_4 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && likely(PyMethod_Check(__pyx_t_14))) {
    __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_14);
    if (likely(__pyx_t_4)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_14);
      __Pyx_INCREF(__pyx_t_4);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_14, function);
    }
  }
  if (!__pyx_t_4) {
    __pyx_t_6 = __Pyx_PyObject_CallOneArg(__pyx_t_14, __pyx_t_7); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1022, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
    __Pyx_GOTREF(__pyx_t_6);
  } else {
    __pyx_t_15 = PyTuple_New(1+1); if (unlikely(!__pyx_t_15)) __PYX_ERR(0, 1022, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_15);
    __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_15, 0, __pyx_t_4); __pyx_t_4 = NULL;
    __Pyx_GIVEREF(__pyx_t_7);
    PyTuple_SET_ITEM(__pyx_t_15, 0+1, __pyx_t_7);
    __pyx_t_7 = 0;
    __pyx_t_6 = __Pyx_PyObject_Call(__pyx_t_14, __pyx_t_15, NULL); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1022, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
    __Pyx_DECREF(__pyx_t_15); __pyx_t_15 = 0;
  }
  __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
  __pyx_t_14 = __Pyx_PyObject_GetAttrStr(__pyx_t_6, __pyx_n_s_real); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 1022, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_14);
  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
  __pyx_r = __pyx_t_14;
  __pyx_t_14 = 0;
  goto __pyx_L0;

  /* "orb/cutils.pyx":952
 *     return sqrt(energy_sum) / <float> np.size(spectrum)
 * 
 * def fft_filter(np.ndarray[np.float64_t, ndim=1] a,             # <<<<<<<<<<<<<<
 *                 double cutoff, double width, bool lowpass):
 *     """
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_XDECREF(__pyx_t_5);
  __Pyx_XDECREF(__pyx_t_6);
  __Pyx_XDECREF(__pyx_t_7);
  __Pyx_XDECREF(__pyx_t_14);
  __Pyx_XDECREF(__pyx_t_15);
  { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
    __Pyx_PyThreadState_declare
    __Pyx_PyThreadState_assign
    __Pyx_ErrFetch(&__pyx_type, &__pyx_value, &__pyx_tb);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_a.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_hwindow.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_w.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_window.rcbuffer->pybuffer);
  __Pyx_ErrRestore(__pyx_type, __pyx_value, __pyx_tb);}
  __Pyx_AddTraceback("orb.cutils.fft_filter", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  goto __pyx_L2;
  __pyx_L0:;
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_a.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_hwindow.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_w.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_window.rcbuffer->pybuffer);
  __pyx_L2:;
  __Pyx_XDECREF((PyObject *)__pyx_v_hwindow);
  __Pyx_XDECREF((PyObject *)__pyx_v_window);
  __Pyx_XDECREF((PyObject *)__pyx_v_w);
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":1025
 * 
 * 
 * def low_pass_image_filter(np.ndarray[np.float64_t, ndim=2] im, int deg):             # <<<<<<<<<<<<<<
 *     """Low pass image filter by convolution with a gaussian kernel.
 * 
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_49low_pass_image_filter(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_3orb_6cutils_48low_pass_image_filter[] = "low_pass_image_filter(ndarray im, int deg)\nLow pass image filter by convolution with a gaussian kernel.\n\n    :param im: Image to filter\n    \n    :param deg: Kernel degree\n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_49low_pass_image_filter = {"low_pass_image_filter", (PyCFunction)__pyx_pw_3orb_6cutils_49low_pass_image_filter, METH_VARARGS|METH_KEYWORDS, __pyx_doc_3orb_6cutils_48low_pass_image_filter};
static PyObject *__pyx_pw_3orb_6cutils_49low_pass_image_filter(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  PyArrayObject *__pyx_v_im = 0;
  int __pyx_v_deg;
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("low_pass_image_filter (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_im,&__pyx_n_s_deg,0};
    PyObject* values[2] = {0,0};
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
      switch (pos_args) {
        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = PyDict_Size(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_im)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        case  1:
        if (likely((values[1] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_deg)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("low_pass_image_filter", 1, 2, 2, 1); __PYX_ERR(0, 1025, __pyx_L3_error)
        }
      }
      if (unlikely(kw_args > 0)) {
        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "low_pass_image_filter") < 0)) __PYX_ERR(0, 1025, __pyx_L3_error)
      }
    } else if (PyTuple_GET_SIZE(__pyx_args) != 2) {
      goto __pyx_L5_argtuple_error;
    } else {
      values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
      values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
    }
    __pyx_v_im = ((PyArrayObject *)values[0]);
    __pyx_v_deg = __Pyx_PyInt_As_int(values[1]); if (unlikely((__pyx_v_deg == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 1025, __pyx_L3_error)
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  __Pyx_RaiseArgtupleInvalid("low_pass_image_filter", 1, 2, 2, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 1025, __pyx_L3_error)
  __pyx_L3_error:;
  __Pyx_AddTraceback("orb.cutils.low_pass_image_filter", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __Pyx_RefNannyFinishContext();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_im), __pyx_ptype_5numpy_ndarray, 1, "im", 0))) __PYX_ERR(0, 1025, __pyx_L1_error)
  __pyx_r = __pyx_pf_3orb_6cutils_48low_pass_image_filter(__pyx_self, __pyx_v_im, __pyx_v_deg);

  /* function exit code */
  goto __pyx_L0;
  __pyx_L1_error:;
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_48low_pass_image_filter(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_im, int __pyx_v_deg) {
  PyArrayObject *__pyx_v_real_nans = 0;
  PyArrayObject *__pyx_v_new_nans = 0;
  PyArrayObject *__pyx_v_final_im = 0;
  PyArrayObject *__pyx_v_kernel = 0;
  PyArrayObject *__pyx_v_kernel_mod = 0;
  PyArrayObject *__pyx_v_box = 0;
  int __pyx_v_inan;
  int __pyx_v_ix;
  int __pyx_v_iy;
  PyObject *__pyx_v_nans = NULL;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_box;
  __Pyx_Buffer __pyx_pybuffer_box;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_final_im;
  __Pyx_Buffer __pyx_pybuffer_final_im;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_im;
  __Pyx_Buffer __pyx_pybuffer_im;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_kernel;
  __Pyx_Buffer __pyx_pybuffer_kernel;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_kernel_mod;
  __Pyx_Buffer __pyx_pybuffer_kernel_mod;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_new_nans;
  __Pyx_Buffer __pyx_pybuffer_new_nans;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_real_nans;
  __Pyx_Buffer __pyx_pybuffer_real_nans;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  PyObject *__pyx_t_1 = NULL;
  PyObject *__pyx_t_2 = NULL;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  PyObject *__pyx_t_5 = NULL;
  PyArrayObject *__pyx_t_6 = NULL;
  PyArrayObject *__pyx_t_7 = NULL;
  PyArrayObject *__pyx_t_8 = NULL;
  PyArrayObject *__pyx_t_9 = NULL;
  PyArrayObject *__pyx_t_10 = NULL;
  PyArrayObject *__pyx_t_11 = NULL;
  PyObject *__pyx_t_12 = NULL;
  int __pyx_t_13;
  PyObject *__pyx_t_14 = NULL;
  int __pyx_t_15;
  PyObject *__pyx_t_16 = NULL;
  PyObject *__pyx_t_17 = NULL;
  PyObject *__pyx_t_18 = NULL;
  Py_ssize_t __pyx_t_19;
  int __pyx_t_20;
  int __pyx_t_21;
  __pyx_t_5numpy_float64_t __pyx_t_22;
  Py_ssize_t __pyx_t_23;
  Py_ssize_t __pyx_t_24;
  __Pyx_RefNannySetupContext("low_pass_image_filter", 0);
  __pyx_pybuffer_real_nans.pybuffer.buf = NULL;
  __pyx_pybuffer_real_nans.refcount = 0;
  __pyx_pybuffernd_real_nans.data = NULL;
  __pyx_pybuffernd_real_nans.rcbuffer = &__pyx_pybuffer_real_nans;
  __pyx_pybuffer_new_nans.pybuffer.buf = NULL;
  __pyx_pybuffer_new_nans.refcount = 0;
  __pyx_pybuffernd_new_nans.data = NULL;
  __pyx_pybuffernd_new_nans.rcbuffer = &__pyx_pybuffer_new_nans;
  __pyx_pybuffer_final_im.pybuffer.buf = NULL;
  __pyx_pybuffer_final_im.refcount = 0;
  __pyx_pybuffernd_final_im.data = NULL;
  __pyx_pybuffernd_final_im.rcbuffer = &__pyx_pybuffer_final_im;
  __pyx_pybuffer_kernel.pybuffer.buf = NULL;
  __pyx_pybuffer_kernel.refcount = 0;
  __pyx_pybuffernd_kernel.data = NULL;
  __pyx_pybuffernd_kernel.rcbuffer = &__pyx_pybuffer_kernel;
  __pyx_pybuffer_kernel_mod.pybuffer.buf = NULL;
  __pyx_pybuffer_kernel_mod.refcount = 0;
  __pyx_pybuffernd_kernel_mod.data = NULL;
  __pyx_pybuffernd_kernel_mod.rcbuffer = &__pyx_pybuffer_kernel_mod;
  __pyx_pybuffer_box.pybuffer.buf = NULL;
  __pyx_pybuffer_box.refcount = 0;
  __pyx_pybuffernd_box.data = NULL;
  __pyx_pybuffernd_box.rcbuffer = &__pyx_pybuffer_box;
  __pyx_pybuffer_im.pybuffer.buf = NULL;
  __pyx_pybuffer_im.refcount = 0;
  __pyx_pybuffernd_im.data = NULL;
  __pyx_pybuffernd_im.rcbuffer = &__pyx_pybuffer_im;
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_im.rcbuffer->pybuffer, (PyObject*)__pyx_v_im, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) __PYX_ERR(0, 1025, __pyx_L1_error)
  }
  __pyx_pybuffernd_im.diminfo[0].strides = __pyx_pybuffernd_im.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_im.diminfo[0].shape = __pyx_pybuffernd_im.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_im.diminfo[1].strides = __pyx_pybuffernd_im.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_im.diminfo[1].shape = __pyx_pybuffernd_im.rcbuffer->pybuffer.shape[1];

  /* "orb/cutils.pyx":1033
 *     """
 *     cdef np.ndarray[np.int8_t, ndim=2] real_nans = (
 *         np.isnan(im).astype(np.int8))             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.int8_t, ndim=2] new_nans = np.zeros_like(real_nans)
 * 
 */
  __pyx_t_3 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1033, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_isnan); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1033, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_3 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_4))) {
    __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_4);
    if (likely(__pyx_t_3)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
      __Pyx_INCREF(__pyx_t_3);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_4, function);
    }
  }
  if (!__pyx_t_3) {
    __pyx_t_2 = __Pyx_PyObject_CallOneArg(__pyx_t_4, ((PyObject *)__pyx_v_im)); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1033, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
  } else {
    __pyx_t_5 = PyTuple_New(1+1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1033, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_3); __pyx_t_3 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_im));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_im));
    PyTuple_SET_ITEM(__pyx_t_5, 0+1, ((PyObject *)__pyx_v_im));
    __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_5, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1033, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  }
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_astype); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1033, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1033, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_int8); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1033, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && likely(PyMethod_Check(__pyx_t_4))) {
    __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_4);
    if (likely(__pyx_t_2)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
      __Pyx_INCREF(__pyx_t_2);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_4, function);
    }
  }
  if (!__pyx_t_2) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_5); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1033, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_3 = PyTuple_New(1+1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1033, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_2); __pyx_t_2 = NULL;
    __Pyx_GIVEREF(__pyx_t_5);
    PyTuple_SET_ITEM(__pyx_t_3, 0+1, __pyx_t_5);
    __pyx_t_5 = 0;
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_3, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1033, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  }
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1033, __pyx_L1_error)
  __pyx_t_6 = ((PyArrayObject *)__pyx_t_1);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_real_nans.rcbuffer->pybuffer, (PyObject*)__pyx_t_6, &__Pyx_TypeInfo_nn___pyx_t_5numpy_int8_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
      __pyx_v_real_nans = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_real_nans.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 1032, __pyx_L1_error)
    } else {__pyx_pybuffernd_real_nans.diminfo[0].strides = __pyx_pybuffernd_real_nans.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_real_nans.diminfo[0].shape = __pyx_pybuffernd_real_nans.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_real_nans.diminfo[1].strides = __pyx_pybuffernd_real_nans.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_real_nans.diminfo[1].shape = __pyx_pybuffernd_real_nans.rcbuffer->pybuffer.shape[1];
    }
  }
  __pyx_t_6 = 0;
  __pyx_v_real_nans = ((PyArrayObject *)__pyx_t_1);
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1034
 *     cdef np.ndarray[np.int8_t, ndim=2] real_nans = (
 *         np.isnan(im).astype(np.int8))
 *     cdef np.ndarray[np.int8_t, ndim=2] new_nans = np.zeros_like(real_nans)             # <<<<<<<<<<<<<<
 * 
 *     cdef np.ndarray[np.float64_t, ndim=2] final_im = np.zeros_like(im)
 */
  __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1034, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_zeros_like); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1034, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_4 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_3))) {
    __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_3);
    if (likely(__pyx_t_4)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
      __Pyx_INCREF(__pyx_t_4);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_3, function);
    }
  }
  if (!__pyx_t_4) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_3, ((PyObject *)__pyx_v_real_nans)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1034, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_5 = PyTuple_New(1+1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1034, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_4); __pyx_t_4 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_real_nans));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_real_nans));
    PyTuple_SET_ITEM(__pyx_t_5, 0+1, ((PyObject *)__pyx_v_real_nans));
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_5, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1034, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  }
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1034, __pyx_L1_error)
  __pyx_t_7 = ((PyArrayObject *)__pyx_t_1);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_new_nans.rcbuffer->pybuffer, (PyObject*)__pyx_t_7, &__Pyx_TypeInfo_nn___pyx_t_5numpy_int8_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
      __pyx_v_new_nans = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_new_nans.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 1034, __pyx_L1_error)
    } else {__pyx_pybuffernd_new_nans.diminfo[0].strides = __pyx_pybuffernd_new_nans.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_new_nans.diminfo[0].shape = __pyx_pybuffernd_new_nans.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_new_nans.diminfo[1].strides = __pyx_pybuffernd_new_nans.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_new_nans.diminfo[1].shape = __pyx_pybuffernd_new_nans.rcbuffer->pybuffer.shape[1];
    }
  }
  __pyx_t_7 = 0;
  __pyx_v_new_nans = ((PyArrayObject *)__pyx_t_1);
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1036
 *     cdef np.ndarray[np.int8_t, ndim=2] new_nans = np.zeros_like(real_nans)
 * 
 *     cdef np.ndarray[np.float64_t, ndim=2] final_im = np.zeros_like(im)             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.float64_t, ndim=2] kernel = gaussian_kernel(deg)
 *     cdef np.ndarray[np.float64_t, ndim=2] kernel_mod = np.zeros_like(kernel)
 */
  __pyx_t_3 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1036, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_zeros_like); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1036, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_3 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_5))) {
    __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_5);
    if (likely(__pyx_t_3)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_5);
      __Pyx_INCREF(__pyx_t_3);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_5, function);
    }
  }
  if (!__pyx_t_3) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_5, ((PyObject *)__pyx_v_im)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1036, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_4 = PyTuple_New(1+1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1036, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_3); __pyx_t_3 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_im));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_im));
    PyTuple_SET_ITEM(__pyx_t_4, 0+1, ((PyObject *)__pyx_v_im));
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_4, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1036, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  }
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1036, __pyx_L1_error)
  __pyx_t_8 = ((PyArrayObject *)__pyx_t_1);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_final_im.rcbuffer->pybuffer, (PyObject*)__pyx_t_8, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 2, 0, __pyx_stack) == -1)) {
      __pyx_v_final_im = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_final_im.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 1036, __pyx_L1_error)
    } else {__pyx_pybuffernd_final_im.diminfo[0].strides = __pyx_pybuffernd_final_im.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_final_im.diminfo[0].shape = __pyx_pybuffernd_final_im.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_final_im.diminfo[1].strides = __pyx_pybuffernd_final_im.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_final_im.diminfo[1].shape = __pyx_pybuffernd_final_im.rcbuffer->pybuffer.shape[1];
    }
  }
  __pyx_t_8 = 0;
  __pyx_v_final_im = ((PyArrayObject *)__pyx_t_1);
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1037
 * 
 *     cdef np.ndarray[np.float64_t, ndim=2] final_im = np.zeros_like(im)
 *     cdef np.ndarray[np.float64_t, ndim=2] kernel = gaussian_kernel(deg)             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.float64_t, ndim=2] kernel_mod = np.zeros_like(kernel)
 *     cdef np.ndarray[np.float64_t, ndim=2] box = np.zeros_like(kernel)
 */
  __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_gaussian_kernel); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1037, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_4 = __Pyx_PyInt_From_int(__pyx_v_deg); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1037, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_3 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_5))) {
    __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_5);
    if (likely(__pyx_t_3)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_5);
      __Pyx_INCREF(__pyx_t_3);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_5, function);
    }
  }
  if (!__pyx_t_3) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_5, __pyx_t_4); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1037, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_2 = PyTuple_New(1+1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1037, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_3); __pyx_t_3 = NULL;
    __Pyx_GIVEREF(__pyx_t_4);
    PyTuple_SET_ITEM(__pyx_t_2, 0+1, __pyx_t_4);
    __pyx_t_4 = 0;
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_2, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1037, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  }
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1037, __pyx_L1_error)
  __pyx_t_9 = ((PyArrayObject *)__pyx_t_1);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_kernel.rcbuffer->pybuffer, (PyObject*)__pyx_t_9, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
      __pyx_v_kernel = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_kernel.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 1037, __pyx_L1_error)
    } else {__pyx_pybuffernd_kernel.diminfo[0].strides = __pyx_pybuffernd_kernel.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_kernel.diminfo[0].shape = __pyx_pybuffernd_kernel.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_kernel.diminfo[1].strides = __pyx_pybuffernd_kernel.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_kernel.diminfo[1].shape = __pyx_pybuffernd_kernel.rcbuffer->pybuffer.shape[1];
    }
  }
  __pyx_t_9 = 0;
  __pyx_v_kernel = ((PyArrayObject *)__pyx_t_1);
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1038
 *     cdef np.ndarray[np.float64_t, ndim=2] final_im = np.zeros_like(im)
 *     cdef np.ndarray[np.float64_t, ndim=2] kernel = gaussian_kernel(deg)
 *     cdef np.ndarray[np.float64_t, ndim=2] kernel_mod = np.zeros_like(kernel)             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.float64_t, ndim=2] box = np.zeros_like(kernel)
 * 
 */
  __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1038, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_zeros_like); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1038, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_5 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_2))) {
    __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_2);
    if (likely(__pyx_t_5)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
      __Pyx_INCREF(__pyx_t_5);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_2, function);
    }
  }
  if (!__pyx_t_5) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_2, ((PyObject *)__pyx_v_kernel)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1038, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_4 = PyTuple_New(1+1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1038, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_5); __pyx_t_5 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_kernel));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_kernel));
    PyTuple_SET_ITEM(__pyx_t_4, 0+1, ((PyObject *)__pyx_v_kernel));
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_4, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1038, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  }
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1038, __pyx_L1_error)
  __pyx_t_10 = ((PyArrayObject *)__pyx_t_1);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_kernel_mod.rcbuffer->pybuffer, (PyObject*)__pyx_t_10, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
      __pyx_v_kernel_mod = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_kernel_mod.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 1038, __pyx_L1_error)
    } else {__pyx_pybuffernd_kernel_mod.diminfo[0].strides = __pyx_pybuffernd_kernel_mod.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_kernel_mod.diminfo[0].shape = __pyx_pybuffernd_kernel_mod.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_kernel_mod.diminfo[1].strides = __pyx_pybuffernd_kernel_mod.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_kernel_mod.diminfo[1].shape = __pyx_pybuffernd_kernel_mod.rcbuffer->pybuffer.shape[1];
    }
  }
  __pyx_t_10 = 0;
  __pyx_v_kernel_mod = ((PyArrayObject *)__pyx_t_1);
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1039
 *     cdef np.ndarray[np.float64_t, ndim=2] kernel = gaussian_kernel(deg)
 *     cdef np.ndarray[np.float64_t, ndim=2] kernel_mod = np.zeros_like(kernel)
 *     cdef np.ndarray[np.float64_t, ndim=2] box = np.zeros_like(kernel)             # <<<<<<<<<<<<<<
 * 
 *     cdef int inan
 */
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1039, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_zeros_like); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1039, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_4))) {
    __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_4);
    if (likely(__pyx_t_2)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
      __Pyx_INCREF(__pyx_t_2);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_4, function);
    }
  }
  if (!__pyx_t_2) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_4, ((PyObject *)__pyx_v_kernel)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1039, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_5 = PyTuple_New(1+1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1039, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_2); __pyx_t_2 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_kernel));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_kernel));
    PyTuple_SET_ITEM(__pyx_t_5, 0+1, ((PyObject *)__pyx_v_kernel));
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_5, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1039, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  }
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1039, __pyx_L1_error)
  __pyx_t_11 = ((PyArrayObject *)__pyx_t_1);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_box.rcbuffer->pybuffer, (PyObject*)__pyx_t_11, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
      __pyx_v_box = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_box.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 1039, __pyx_L1_error)
    } else {__pyx_pybuffernd_box.diminfo[0].strides = __pyx_pybuffernd_box.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_box.diminfo[0].shape = __pyx_pybuffernd_box.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_box.diminfo[1].strides = __pyx_pybuffernd_box.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_box.diminfo[1].shape = __pyx_pybuffernd_box.rcbuffer->pybuffer.shape[1];
    }
  }
  __pyx_t_11 = 0;
  __pyx_v_box = ((PyArrayObject *)__pyx_t_1);
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1045
 *     cdef int iy
 * 
 *     if np.any(np.isinf(im)):             # <<<<<<<<<<<<<<
 *         im[np.nonzero(np.isinf(im))] = np.nan
 * 
 */
  __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1045, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_any); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1045, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1045, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_isinf); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1045, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_3))) {
    __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_3);
    if (likely(__pyx_t_2)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
      __Pyx_INCREF(__pyx_t_2);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_3, function);
    }
  }
  if (!__pyx_t_2) {
    __pyx_t_4 = __Pyx_PyObject_CallOneArg(__pyx_t_3, ((PyObject *)__pyx_v_im)); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1045, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
  } else {
    __pyx_t_12 = PyTuple_New(1+1); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 1045, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_12);
    __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_12, 0, __pyx_t_2); __pyx_t_2 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_im));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_im));
    PyTuple_SET_ITEM(__pyx_t_12, 0+1, ((PyObject *)__pyx_v_im));
    __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_12, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1045, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_12); __pyx_t_12 = 0;
  }
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_3 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_5))) {
    __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_5);
    if (likely(__pyx_t_3)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_5);
      __Pyx_INCREF(__pyx_t_3);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_5, function);
    }
  }
  if (!__pyx_t_3) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_5, __pyx_t_4); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1045, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_12 = PyTuple_New(1+1); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 1045, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_12);
    __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_12, 0, __pyx_t_3); __pyx_t_3 = NULL;
    __Pyx_GIVEREF(__pyx_t_4);
    PyTuple_SET_ITEM(__pyx_t_12, 0+1, __pyx_t_4);
    __pyx_t_4 = 0;
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_12, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1045, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_12); __pyx_t_12 = 0;
  }
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_13 = __Pyx_PyObject_IsTrue(__pyx_t_1); if (unlikely(__pyx_t_13 < 0)) __PYX_ERR(0, 1045, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  if (__pyx_t_13) {

    /* "orb/cutils.pyx":1046
 * 
 *     if np.any(np.isinf(im)):
 *         im[np.nonzero(np.isinf(im))] = np.nan             # <<<<<<<<<<<<<<
 * 
 *     final_im = scipy.ndimage.filters.convolve(im, kernel,
 */
    __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1046, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_nan); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1046, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    __pyx_t_12 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 1046, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_12);
    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_12, __pyx_n_s_nonzero); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1046, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_12); __pyx_t_12 = 0;
    __pyx_t_3 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1046, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_isinf); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1046, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __pyx_t_3 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_2))) {
      __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_2);
      if (likely(__pyx_t_3)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
        __Pyx_INCREF(__pyx_t_3);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_2, function);
      }
    }
    if (!__pyx_t_3) {
      __pyx_t_12 = __Pyx_PyObject_CallOneArg(__pyx_t_2, ((PyObject *)__pyx_v_im)); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 1046, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_12);
    } else {
      __pyx_t_14 = PyTuple_New(1+1); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 1046, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_14);
      __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_14, 0, __pyx_t_3); __pyx_t_3 = NULL;
      __Pyx_INCREF(((PyObject *)__pyx_v_im));
      __Pyx_GIVEREF(((PyObject *)__pyx_v_im));
      PyTuple_SET_ITEM(__pyx_t_14, 0+1, ((PyObject *)__pyx_v_im));
      __pyx_t_12 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_14, NULL); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 1046, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_12);
      __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
    }
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __pyx_t_2 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_4))) {
      __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_4);
      if (likely(__pyx_t_2)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
        __Pyx_INCREF(__pyx_t_2);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_4, function);
      }
    }
    if (!__pyx_t_2) {
      __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_12); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1046, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_12); __pyx_t_12 = 0;
      __Pyx_GOTREF(__pyx_t_1);
    } else {
      __pyx_t_14 = PyTuple_New(1+1); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 1046, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_14);
      __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_14, 0, __pyx_t_2); __pyx_t_2 = NULL;
      __Pyx_GIVEREF(__pyx_t_12);
      PyTuple_SET_ITEM(__pyx_t_14, 0+1, __pyx_t_12);
      __pyx_t_12 = 0;
      __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_14, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1046, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);
      __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
    }
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    if (unlikely(PyObject_SetItem(((PyObject *)__pyx_v_im), __pyx_t_1, __pyx_t_5) < 0)) __PYX_ERR(0, 1046, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

    /* "orb/cutils.pyx":1045
 *     cdef int iy
 * 
 *     if np.any(np.isinf(im)):             # <<<<<<<<<<<<<<
 *         im[np.nonzero(np.isinf(im))] = np.nan
 * 
 */
  }

  /* "orb/cutils.pyx":1048
 *         im[np.nonzero(np.isinf(im))] = np.nan
 * 
 *     final_im = scipy.ndimage.filters.convolve(im, kernel,             # <<<<<<<<<<<<<<
 *                                               mode='nearest')
 * 
 */
  __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_scipy); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1048, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_ndimage); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1048, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_filters); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1048, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_convolve); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1048, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_5 = PyTuple_New(2); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1048, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_INCREF(((PyObject *)__pyx_v_im));
  __Pyx_GIVEREF(((PyObject *)__pyx_v_im));
  PyTuple_SET_ITEM(__pyx_t_5, 0, ((PyObject *)__pyx_v_im));
  __Pyx_INCREF(((PyObject *)__pyx_v_kernel));
  __Pyx_GIVEREF(((PyObject *)__pyx_v_kernel));
  PyTuple_SET_ITEM(__pyx_t_5, 1, ((PyObject *)__pyx_v_kernel));

  /* "orb/cutils.pyx":1049
 * 
 *     final_im = scipy.ndimage.filters.convolve(im, kernel,
 *                                               mode='nearest')             # <<<<<<<<<<<<<<
 * 
 *     new_nans = (np.isnan(final_im).astype(np.int8)
 */
  __pyx_t_4 = PyDict_New(); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1049, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  if (PyDict_SetItem(__pyx_t_4, __pyx_n_s_mode, __pyx_n_s_nearest) < 0) __PYX_ERR(0, 1049, __pyx_L1_error)

  /* "orb/cutils.pyx":1048
 *         im[np.nonzero(np.isinf(im))] = np.nan
 * 
 *     final_im = scipy.ndimage.filters.convolve(im, kernel,             # <<<<<<<<<<<<<<
 *                                               mode='nearest')
 * 
 */
  __pyx_t_14 = __Pyx_PyObject_Call(__pyx_t_1, __pyx_t_5, __pyx_t_4); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 1048, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_14);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  if (!(likely(((__pyx_t_14) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_14, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1048, __pyx_L1_error)
  __pyx_t_8 = ((PyArrayObject *)__pyx_t_14);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_final_im.rcbuffer->pybuffer);
    __pyx_t_15 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_final_im.rcbuffer->pybuffer, (PyObject*)__pyx_t_8, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 2, 0, __pyx_stack);
    if (unlikely(__pyx_t_15 < 0)) {
      PyErr_Fetch(&__pyx_t_16, &__pyx_t_17, &__pyx_t_18);
      if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_final_im.rcbuffer->pybuffer, (PyObject*)__pyx_v_final_im, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 2, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_16); Py_XDECREF(__pyx_t_17); Py_XDECREF(__pyx_t_18);
        __Pyx_RaiseBufferFallbackError();
      } else {
        PyErr_Restore(__pyx_t_16, __pyx_t_17, __pyx_t_18);
      }
    }
    __pyx_pybuffernd_final_im.diminfo[0].strides = __pyx_pybuffernd_final_im.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_final_im.diminfo[0].shape = __pyx_pybuffernd_final_im.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_final_im.diminfo[1].strides = __pyx_pybuffernd_final_im.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_final_im.diminfo[1].shape = __pyx_pybuffernd_final_im.rcbuffer->pybuffer.shape[1];
    if (unlikely(__pyx_t_15 < 0)) __PYX_ERR(0, 1048, __pyx_L1_error)
  }
  __pyx_t_8 = 0;
  __Pyx_DECREF_SET(__pyx_v_final_im, ((PyArrayObject *)__pyx_t_14));
  __pyx_t_14 = 0;

  /* "orb/cutils.pyx":1051
 *                                               mode='nearest')
 * 
 *     new_nans = (np.isnan(final_im).astype(np.int8)             # <<<<<<<<<<<<<<
 *                 +  np.isinf(final_im).astype(np.int8) - real_nans)
 * 
 */
  __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1051, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_isnan); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1051, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_5 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_1))) {
    __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_1);
    if (likely(__pyx_t_5)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_1);
      __Pyx_INCREF(__pyx_t_5);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_1, function);
    }
  }
  if (!__pyx_t_5) {
    __pyx_t_4 = __Pyx_PyObject_CallOneArg(__pyx_t_1, ((PyObject *)__pyx_v_final_im)); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1051, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
  } else {
    __pyx_t_12 = PyTuple_New(1+1); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 1051, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_12);
    __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_12, 0, __pyx_t_5); __pyx_t_5 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_final_im));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_final_im));
    PyTuple_SET_ITEM(__pyx_t_12, 0+1, ((PyObject *)__pyx_v_final_im));
    __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_1, __pyx_t_12, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1051, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_12); __pyx_t_12 = 0;
  }
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_astype); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1051, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1051, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_12 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_int8); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 1051, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_12);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_4 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && likely(PyMethod_Check(__pyx_t_1))) {
    __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_1);
    if (likely(__pyx_t_4)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_1);
      __Pyx_INCREF(__pyx_t_4);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_1, function);
    }
  }
  if (!__pyx_t_4) {
    __pyx_t_14 = __Pyx_PyObject_CallOneArg(__pyx_t_1, __pyx_t_12); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 1051, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_12); __pyx_t_12 = 0;
    __Pyx_GOTREF(__pyx_t_14);
  } else {
    __pyx_t_5 = PyTuple_New(1+1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1051, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_4); __pyx_t_4 = NULL;
    __Pyx_GIVEREF(__pyx_t_12);
    PyTuple_SET_ITEM(__pyx_t_5, 0+1, __pyx_t_12);
    __pyx_t_12 = 0;
    __pyx_t_14 = __Pyx_PyObject_Call(__pyx_t_1, __pyx_t_5, NULL); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 1051, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_14);
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  }
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1052
 * 
 *     new_nans = (np.isnan(final_im).astype(np.int8)
 *                 +  np.isinf(final_im).astype(np.int8) - real_nans)             # <<<<<<<<<<<<<<
 * 
 *     nans = np.nonzero(new_nans > 0)
 */
  __pyx_t_12 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 1052, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_12);
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_12, __pyx_n_s_isinf); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1052, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_12); __pyx_t_12 = 0;
  __pyx_t_12 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_4))) {
    __pyx_t_12 = PyMethod_GET_SELF(__pyx_t_4);
    if (likely(__pyx_t_12)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
      __Pyx_INCREF(__pyx_t_12);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_4, function);
    }
  }
  if (!__pyx_t_12) {
    __pyx_t_5 = __Pyx_PyObject_CallOneArg(__pyx_t_4, ((PyObject *)__pyx_v_final_im)); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1052, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
  } else {
    __pyx_t_2 = PyTuple_New(1+1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1052, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_GIVEREF(__pyx_t_12); PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_12); __pyx_t_12 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_final_im));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_final_im));
    PyTuple_SET_ITEM(__pyx_t_2, 0+1, ((PyObject *)__pyx_v_final_im));
    __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_2, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1052, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  }
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_astype); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1052, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1052, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_int8); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1052, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_5 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && likely(PyMethod_Check(__pyx_t_4))) {
    __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_4);
    if (likely(__pyx_t_5)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
      __Pyx_INCREF(__pyx_t_5);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_4, function);
    }
  }
  if (!__pyx_t_5) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_2); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1052, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_12 = PyTuple_New(1+1); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 1052, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_12);
    __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_12, 0, __pyx_t_5); __pyx_t_5 = NULL;
    __Pyx_GIVEREF(__pyx_t_2);
    PyTuple_SET_ITEM(__pyx_t_12, 0+1, __pyx_t_2);
    __pyx_t_2 = 0;
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_12, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1052, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_12); __pyx_t_12 = 0;
  }
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_4 = PyNumber_Add(__pyx_t_14, __pyx_t_1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1052, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_1 = PyNumber_Subtract(__pyx_t_4, ((PyObject *)__pyx_v_real_nans)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1052, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1052, __pyx_L1_error)
  __pyx_t_7 = ((PyArrayObject *)__pyx_t_1);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_new_nans.rcbuffer->pybuffer);
    __pyx_t_15 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_new_nans.rcbuffer->pybuffer, (PyObject*)__pyx_t_7, &__Pyx_TypeInfo_nn___pyx_t_5numpy_int8_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
    if (unlikely(__pyx_t_15 < 0)) {
      PyErr_Fetch(&__pyx_t_18, &__pyx_t_17, &__pyx_t_16);
      if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_new_nans.rcbuffer->pybuffer, (PyObject*)__pyx_v_new_nans, &__Pyx_TypeInfo_nn___pyx_t_5numpy_int8_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_18); Py_XDECREF(__pyx_t_17); Py_XDECREF(__pyx_t_16);
        __Pyx_RaiseBufferFallbackError();
      } else {
        PyErr_Restore(__pyx_t_18, __pyx_t_17, __pyx_t_16);
      }
    }
    __pyx_pybuffernd_new_nans.diminfo[0].strides = __pyx_pybuffernd_new_nans.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_new_nans.diminfo[0].shape = __pyx_pybuffernd_new_nans.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_new_nans.diminfo[1].strides = __pyx_pybuffernd_new_nans.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_new_nans.diminfo[1].shape = __pyx_pybuffernd_new_nans.rcbuffer->pybuffer.shape[1];
    if (unlikely(__pyx_t_15 < 0)) __PYX_ERR(0, 1051, __pyx_L1_error)
  }
  __pyx_t_7 = 0;
  __Pyx_DECREF_SET(__pyx_v_new_nans, ((PyArrayObject *)__pyx_t_1));
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1054
 *                 +  np.isinf(final_im).astype(np.int8) - real_nans)
 * 
 *     nans = np.nonzero(new_nans > 0)             # <<<<<<<<<<<<<<
 * 
 *     for inan in range(len(nans[0])):
 */
  __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1054, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_14 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_nonzero); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 1054, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_14);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_4 = PyObject_RichCompare(((PyObject *)__pyx_v_new_nans), __pyx_int_0, Py_GT); __Pyx_XGOTREF(__pyx_t_4); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1054, __pyx_L1_error)
  __pyx_t_12 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_14))) {
    __pyx_t_12 = PyMethod_GET_SELF(__pyx_t_14);
    if (likely(__pyx_t_12)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_14);
      __Pyx_INCREF(__pyx_t_12);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_14, function);
    }
  }
  if (!__pyx_t_12) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_14, __pyx_t_4); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1054, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_2 = PyTuple_New(1+1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1054, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_GIVEREF(__pyx_t_12); PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_12); __pyx_t_12 = NULL;
    __Pyx_GIVEREF(__pyx_t_4);
    PyTuple_SET_ITEM(__pyx_t_2, 0+1, __pyx_t_4);
    __pyx_t_4 = 0;
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_14, __pyx_t_2, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1054, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  }
  __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
  __pyx_v_nans = __pyx_t_1;
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1056
 *     nans = np.nonzero(new_nans > 0)
 * 
 *     for inan in range(len(nans[0])):             # <<<<<<<<<<<<<<
 *         ix = nans[0][inan]
 *         iy = nans[1][inan]
 */
  __pyx_t_1 = __Pyx_GetItemInt(__pyx_v_nans, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1056, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_19 = PyObject_Length(__pyx_t_1); if (unlikely(__pyx_t_19 == -1)) __PYX_ERR(0, 1056, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  for (__pyx_t_15 = 0; __pyx_t_15 < __pyx_t_19; __pyx_t_15+=1) {
    __pyx_v_inan = __pyx_t_15;

    /* "orb/cutils.pyx":1057
 * 
 *     for inan in range(len(nans[0])):
 *         ix = nans[0][inan]             # <<<<<<<<<<<<<<
 *         iy = nans[1][inan]
 *         if (ix >= deg and iy >= deg and ix < im.shape[0] - deg
 */
    __pyx_t_1 = __Pyx_GetItemInt(__pyx_v_nans, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1057, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __pyx_t_14 = __Pyx_GetItemInt(__pyx_t_1, __pyx_v_inan, int, 1, __Pyx_PyInt_From_int, 0, 1, 1); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 1057, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_14);
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    __pyx_t_20 = __Pyx_PyInt_As_int(__pyx_t_14); if (unlikely((__pyx_t_20 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 1057, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
    __pyx_v_ix = __pyx_t_20;

    /* "orb/cutils.pyx":1058
 *     for inan in range(len(nans[0])):
 *         ix = nans[0][inan]
 *         iy = nans[1][inan]             # <<<<<<<<<<<<<<
 *         if (ix >= deg and iy >= deg and ix < im.shape[0] - deg
 *             and  iy < im.shape[1] - deg):
 */
    __pyx_t_14 = __Pyx_GetItemInt(__pyx_v_nans, 1, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 1058, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_14);
    __pyx_t_1 = __Pyx_GetItemInt(__pyx_t_14, __pyx_v_inan, int, 1, __Pyx_PyInt_From_int, 0, 1, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1058, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
    __pyx_t_20 = __Pyx_PyInt_As_int(__pyx_t_1); if (unlikely((__pyx_t_20 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 1058, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    __pyx_v_iy = __pyx_t_20;

    /* "orb/cutils.pyx":1059
 *         ix = nans[0][inan]
 *         iy = nans[1][inan]
 *         if (ix >= deg and iy >= deg and ix < im.shape[0] - deg             # <<<<<<<<<<<<<<
 *             and  iy < im.shape[1] - deg):
 *             box = np.copy(im[ix-deg:ix+deg+1, iy-deg:iy+deg+1])
 */
    __pyx_t_21 = ((__pyx_v_ix >= __pyx_v_deg) != 0);
    if (__pyx_t_21) {
    } else {
      __pyx_t_13 = __pyx_t_21;
      goto __pyx_L7_bool_binop_done;
    }
    __pyx_t_21 = ((__pyx_v_iy >= __pyx_v_deg) != 0);
    if (__pyx_t_21) {
    } else {
      __pyx_t_13 = __pyx_t_21;
      goto __pyx_L7_bool_binop_done;
    }

    /* "orb/cutils.pyx":1060
 *         iy = nans[1][inan]
 *         if (ix >= deg and iy >= deg and ix < im.shape[0] - deg
 *             and  iy < im.shape[1] - deg):             # <<<<<<<<<<<<<<
 *             box = np.copy(im[ix-deg:ix+deg+1, iy-deg:iy+deg+1])
 *             if not np.isnan(bn.nansum(box)):
 */
    __pyx_t_21 = ((__pyx_v_ix < ((__pyx_v_im->dimensions[0]) - __pyx_v_deg)) != 0);
    if (__pyx_t_21) {
    } else {
      __pyx_t_13 = __pyx_t_21;
      goto __pyx_L7_bool_binop_done;
    }
    __pyx_t_21 = ((__pyx_v_iy < ((__pyx_v_im->dimensions[1]) - __pyx_v_deg)) != 0);
    __pyx_t_13 = __pyx_t_21;
    __pyx_L7_bool_binop_done:;

    /* "orb/cutils.pyx":1059
 *         ix = nans[0][inan]
 *         iy = nans[1][inan]
 *         if (ix >= deg and iy >= deg and ix < im.shape[0] - deg             # <<<<<<<<<<<<<<
 *             and  iy < im.shape[1] - deg):
 *             box = np.copy(im[ix-deg:ix+deg+1, iy-deg:iy+deg+1])
 */
    if (__pyx_t_13) {

      /* "orb/cutils.pyx":1061
 *         if (ix >= deg and iy >= deg and ix < im.shape[0] - deg
 *             and  iy < im.shape[1] - deg):
 *             box = np.copy(im[ix-deg:ix+deg+1, iy-deg:iy+deg+1])             # <<<<<<<<<<<<<<
 *             if not np.isnan(bn.nansum(box)):
 *                 kernel_mod = kernel * (~np.isnan(box))
 */
      __pyx_t_14 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 1061, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_14);
      __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_14, __pyx_n_s_copy); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1061, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
      __pyx_t_14 = __Pyx_PyInt_From_int((__pyx_v_ix - __pyx_v_deg)); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 1061, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_14);
      __pyx_t_4 = __Pyx_PyInt_From_long(((__pyx_v_ix + __pyx_v_deg) + 1)); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1061, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __pyx_t_12 = PySlice_New(__pyx_t_14, __pyx_t_4, Py_None); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 1061, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_12);
      __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __pyx_t_4 = __Pyx_PyInt_From_int((__pyx_v_iy - __pyx_v_deg)); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1061, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __pyx_t_14 = __Pyx_PyInt_From_long(((__pyx_v_iy + __pyx_v_deg) + 1)); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 1061, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_14);
      __pyx_t_5 = PySlice_New(__pyx_t_4, __pyx_t_14, Py_None); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1061, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
      __pyx_t_14 = PyTuple_New(2); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 1061, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_14);
      __Pyx_GIVEREF(__pyx_t_12);
      PyTuple_SET_ITEM(__pyx_t_14, 0, __pyx_t_12);
      __Pyx_GIVEREF(__pyx_t_5);
      PyTuple_SET_ITEM(__pyx_t_14, 1, __pyx_t_5);
      __pyx_t_12 = 0;
      __pyx_t_5 = 0;
      __pyx_t_5 = PyObject_GetItem(((PyObject *)__pyx_v_im), __pyx_t_14); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1061, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
      __pyx_t_14 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_2))) {
        __pyx_t_14 = PyMethod_GET_SELF(__pyx_t_2);
        if (likely(__pyx_t_14)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
          __Pyx_INCREF(__pyx_t_14);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_2, function);
        }
      }
      if (!__pyx_t_14) {
        __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_2, __pyx_t_5); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1061, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
        __Pyx_GOTREF(__pyx_t_1);
      } else {
        __pyx_t_12 = PyTuple_New(1+1); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 1061, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_12);
        __Pyx_GIVEREF(__pyx_t_14); PyTuple_SET_ITEM(__pyx_t_12, 0, __pyx_t_14); __pyx_t_14 = NULL;
        __Pyx_GIVEREF(__pyx_t_5);
        PyTuple_SET_ITEM(__pyx_t_12, 0+1, __pyx_t_5);
        __pyx_t_5 = 0;
        __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_12, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1061, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_1);
        __Pyx_DECREF(__pyx_t_12); __pyx_t_12 = 0;
      }
      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
      if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1061, __pyx_L1_error)
      __pyx_t_11 = ((PyArrayObject *)__pyx_t_1);
      {
        __Pyx_BufFmt_StackElem __pyx_stack[1];
        __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_box.rcbuffer->pybuffer);
        __pyx_t_20 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_box.rcbuffer->pybuffer, (PyObject*)__pyx_t_11, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
        if (unlikely(__pyx_t_20 < 0)) {
          PyErr_Fetch(&__pyx_t_16, &__pyx_t_17, &__pyx_t_18);
          if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_box.rcbuffer->pybuffer, (PyObject*)__pyx_v_box, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
            Py_XDECREF(__pyx_t_16); Py_XDECREF(__pyx_t_17); Py_XDECREF(__pyx_t_18);
            __Pyx_RaiseBufferFallbackError();
          } else {
            PyErr_Restore(__pyx_t_16, __pyx_t_17, __pyx_t_18);
          }
        }
        __pyx_pybuffernd_box.diminfo[0].strides = __pyx_pybuffernd_box.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_box.diminfo[0].shape = __pyx_pybuffernd_box.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_box.diminfo[1].strides = __pyx_pybuffernd_box.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_box.diminfo[1].shape = __pyx_pybuffernd_box.rcbuffer->pybuffer.shape[1];
        if (unlikely(__pyx_t_20 < 0)) __PYX_ERR(0, 1061, __pyx_L1_error)
      }
      __pyx_t_11 = 0;
      __Pyx_DECREF_SET(__pyx_v_box, ((PyArrayObject *)__pyx_t_1));
      __pyx_t_1 = 0;

      /* "orb/cutils.pyx":1062
 *             and  iy < im.shape[1] - deg):
 *             box = np.copy(im[ix-deg:ix+deg+1, iy-deg:iy+deg+1])
 *             if not np.isnan(bn.nansum(box)):             # <<<<<<<<<<<<<<
 *                 kernel_mod = kernel * (~np.isnan(box))
 *                 kernel_mod = (kernel_mod / bn.nansum(kernel_mod)
 */
      __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1062, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __pyx_t_12 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_isnan); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 1062, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_12);
      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
      __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1062, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __pyx_t_14 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_nansum); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 1062, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_14);
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
      __pyx_t_5 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_14))) {
        __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_14);
        if (likely(__pyx_t_5)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_14);
          __Pyx_INCREF(__pyx_t_5);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_14, function);
        }
      }
      if (!__pyx_t_5) {
        __pyx_t_2 = __Pyx_PyObject_CallOneArg(__pyx_t_14, ((PyObject *)__pyx_v_box)); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1062, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_2);
      } else {
        __pyx_t_4 = PyTuple_New(1+1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1062, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_4);
        __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_5); __pyx_t_5 = NULL;
        __Pyx_INCREF(((PyObject *)__pyx_v_box));
        __Pyx_GIVEREF(((PyObject *)__pyx_v_box));
        PyTuple_SET_ITEM(__pyx_t_4, 0+1, ((PyObject *)__pyx_v_box));
        __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_14, __pyx_t_4, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1062, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_2);
        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      }
      __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
      __pyx_t_14 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_12))) {
        __pyx_t_14 = PyMethod_GET_SELF(__pyx_t_12);
        if (likely(__pyx_t_14)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_12);
          __Pyx_INCREF(__pyx_t_14);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_12, function);
        }
      }
      if (!__pyx_t_14) {
        __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_12, __pyx_t_2); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1062, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
        __Pyx_GOTREF(__pyx_t_1);
      } else {
        __pyx_t_4 = PyTuple_New(1+1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1062, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_4);
        __Pyx_GIVEREF(__pyx_t_14); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_14); __pyx_t_14 = NULL;
        __Pyx_GIVEREF(__pyx_t_2);
        PyTuple_SET_ITEM(__pyx_t_4, 0+1, __pyx_t_2);
        __pyx_t_2 = 0;
        __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_12, __pyx_t_4, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1062, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_1);
        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      }
      __Pyx_DECREF(__pyx_t_12); __pyx_t_12 = 0;
      __pyx_t_13 = __Pyx_PyObject_IsTrue(__pyx_t_1); if (unlikely(__pyx_t_13 < 0)) __PYX_ERR(0, 1062, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
      __pyx_t_21 = ((!__pyx_t_13) != 0);
      if (__pyx_t_21) {

        /* "orb/cutils.pyx":1063
 *             box = np.copy(im[ix-deg:ix+deg+1, iy-deg:iy+deg+1])
 *             if not np.isnan(bn.nansum(box)):
 *                 kernel_mod = kernel * (~np.isnan(box))             # <<<<<<<<<<<<<<
 *                 kernel_mod = (kernel_mod / bn.nansum(kernel_mod)
 *                               * bn.nansum(kernel))
 */
        __pyx_t_12 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 1063, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_12);
        __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_12, __pyx_n_s_isnan); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1063, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_4);
        __Pyx_DECREF(__pyx_t_12); __pyx_t_12 = 0;
        __pyx_t_12 = NULL;
        if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_4))) {
          __pyx_t_12 = PyMethod_GET_SELF(__pyx_t_4);
          if (likely(__pyx_t_12)) {
            PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
            __Pyx_INCREF(__pyx_t_12);
            __Pyx_INCREF(function);
            __Pyx_DECREF_SET(__pyx_t_4, function);
          }
        }
        if (!__pyx_t_12) {
          __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_4, ((PyObject *)__pyx_v_box)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1063, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_1);
        } else {
          __pyx_t_2 = PyTuple_New(1+1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1063, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_2);
          __Pyx_GIVEREF(__pyx_t_12); PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_12); __pyx_t_12 = NULL;
          __Pyx_INCREF(((PyObject *)__pyx_v_box));
          __Pyx_GIVEREF(((PyObject *)__pyx_v_box));
          PyTuple_SET_ITEM(__pyx_t_2, 0+1, ((PyObject *)__pyx_v_box));
          __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_2, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1063, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_1);
          __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
        }
        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
        __pyx_t_4 = PyNumber_Invert(__pyx_t_1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1063, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_4);
        __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
        __pyx_t_1 = PyNumber_Multiply(((PyObject *)__pyx_v_kernel), __pyx_t_4); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1063, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_1);
        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
        if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1063, __pyx_L1_error)
        __pyx_t_10 = ((PyArrayObject *)__pyx_t_1);
        {
          __Pyx_BufFmt_StackElem __pyx_stack[1];
          __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_kernel_mod.rcbuffer->pybuffer);
          __pyx_t_20 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_kernel_mod.rcbuffer->pybuffer, (PyObject*)__pyx_t_10, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
          if (unlikely(__pyx_t_20 < 0)) {
            PyErr_Fetch(&__pyx_t_18, &__pyx_t_17, &__pyx_t_16);
            if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_kernel_mod.rcbuffer->pybuffer, (PyObject*)__pyx_v_kernel_mod, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
              Py_XDECREF(__pyx_t_18); Py_XDECREF(__pyx_t_17); Py_XDECREF(__pyx_t_16);
              __Pyx_RaiseBufferFallbackError();
            } else {
              PyErr_Restore(__pyx_t_18, __pyx_t_17, __pyx_t_16);
            }
          }
          __pyx_pybuffernd_kernel_mod.diminfo[0].strides = __pyx_pybuffernd_kernel_mod.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_kernel_mod.diminfo[0].shape = __pyx_pybuffernd_kernel_mod.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_kernel_mod.diminfo[1].strides = __pyx_pybuffernd_kernel_mod.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_kernel_mod.diminfo[1].shape = __pyx_pybuffernd_kernel_mod.rcbuffer->pybuffer.shape[1];
          if (unlikely(__pyx_t_20 < 0)) __PYX_ERR(0, 1063, __pyx_L1_error)
        }
        __pyx_t_10 = 0;
        __Pyx_DECREF_SET(__pyx_v_kernel_mod, ((PyArrayObject *)__pyx_t_1));
        __pyx_t_1 = 0;

        /* "orb/cutils.pyx":1064
 *             if not np.isnan(bn.nansum(box)):
 *                 kernel_mod = kernel * (~np.isnan(box))
 *                 kernel_mod = (kernel_mod / bn.nansum(kernel_mod)             # <<<<<<<<<<<<<<
 *                               * bn.nansum(kernel))
 *                 box[np.nonzero(np.isnan(box))] = 0.
 */
        __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1064, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_4);
        __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_nansum); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1064, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_2);
        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
        __pyx_t_4 = NULL;
        if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_2))) {
          __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_2);
          if (likely(__pyx_t_4)) {
            PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
            __Pyx_INCREF(__pyx_t_4);
            __Pyx_INCREF(function);
            __Pyx_DECREF_SET(__pyx_t_2, function);
          }
        }
        if (!__pyx_t_4) {
          __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_2, ((PyObject *)__pyx_v_kernel_mod)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1064, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_1);
        } else {
          __pyx_t_12 = PyTuple_New(1+1); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 1064, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_12);
          __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_12, 0, __pyx_t_4); __pyx_t_4 = NULL;
          __Pyx_INCREF(((PyObject *)__pyx_v_kernel_mod));
          __Pyx_GIVEREF(((PyObject *)__pyx_v_kernel_mod));
          PyTuple_SET_ITEM(__pyx_t_12, 0+1, ((PyObject *)__pyx_v_kernel_mod));
          __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_12, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1064, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_1);
          __Pyx_DECREF(__pyx_t_12); __pyx_t_12 = 0;
        }
        __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
        __pyx_t_2 = __Pyx_PyNumber_Divide(((PyObject *)__pyx_v_kernel_mod), __pyx_t_1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1064, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_2);
        __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

        /* "orb/cutils.pyx":1065
 *                 kernel_mod = kernel * (~np.isnan(box))
 *                 kernel_mod = (kernel_mod / bn.nansum(kernel_mod)
 *                               * bn.nansum(kernel))             # <<<<<<<<<<<<<<
 *                 box[np.nonzero(np.isnan(box))] = 0.
 *                 final_im[ix,iy] = bn.nansum(box * kernel_mod)
 */
        __pyx_t_12 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 1065, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_12);
        __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_12, __pyx_n_s_nansum); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1065, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_4);
        __Pyx_DECREF(__pyx_t_12); __pyx_t_12 = 0;
        __pyx_t_12 = NULL;
        if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_4))) {
          __pyx_t_12 = PyMethod_GET_SELF(__pyx_t_4);
          if (likely(__pyx_t_12)) {
            PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
            __Pyx_INCREF(__pyx_t_12);
            __Pyx_INCREF(function);
            __Pyx_DECREF_SET(__pyx_t_4, function);
          }
        }
        if (!__pyx_t_12) {
          __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_4, ((PyObject *)__pyx_v_kernel)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1065, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_1);
        } else {
          __pyx_t_14 = PyTuple_New(1+1); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 1065, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_14);
          __Pyx_GIVEREF(__pyx_t_12); PyTuple_SET_ITEM(__pyx_t_14, 0, __pyx_t_12); __pyx_t_12 = NULL;
          __Pyx_INCREF(((PyObject *)__pyx_v_kernel));
          __Pyx_GIVEREF(((PyObject *)__pyx_v_kernel));
          PyTuple_SET_ITEM(__pyx_t_14, 0+1, ((PyObject *)__pyx_v_kernel));
          __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_14, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1065, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_1);
          __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
        }
        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
        __pyx_t_4 = PyNumber_Multiply(__pyx_t_2, __pyx_t_1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1065, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_4);
        __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
        __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
        if (!(likely(((__pyx_t_4) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_4, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1065, __pyx_L1_error)
        __pyx_t_10 = ((PyArrayObject *)__pyx_t_4);
        {
          __Pyx_BufFmt_StackElem __pyx_stack[1];
          __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_kernel_mod.rcbuffer->pybuffer);
          __pyx_t_20 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_kernel_mod.rcbuffer->pybuffer, (PyObject*)__pyx_t_10, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
          if (unlikely(__pyx_t_20 < 0)) {
            PyErr_Fetch(&__pyx_t_16, &__pyx_t_17, &__pyx_t_18);
            if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_kernel_mod.rcbuffer->pybuffer, (PyObject*)__pyx_v_kernel_mod, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
              Py_XDECREF(__pyx_t_16); Py_XDECREF(__pyx_t_17); Py_XDECREF(__pyx_t_18);
              __Pyx_RaiseBufferFallbackError();
            } else {
              PyErr_Restore(__pyx_t_16, __pyx_t_17, __pyx_t_18);
            }
          }
          __pyx_pybuffernd_kernel_mod.diminfo[0].strides = __pyx_pybuffernd_kernel_mod.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_kernel_mod.diminfo[0].shape = __pyx_pybuffernd_kernel_mod.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_kernel_mod.diminfo[1].strides = __pyx_pybuffernd_kernel_mod.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_kernel_mod.diminfo[1].shape = __pyx_pybuffernd_kernel_mod.rcbuffer->pybuffer.shape[1];
          if (unlikely(__pyx_t_20 < 0)) __PYX_ERR(0, 1064, __pyx_L1_error)
        }
        __pyx_t_10 = 0;
        __Pyx_DECREF_SET(__pyx_v_kernel_mod, ((PyArrayObject *)__pyx_t_4));
        __pyx_t_4 = 0;

        /* "orb/cutils.pyx":1066
 *                 kernel_mod = (kernel_mod / bn.nansum(kernel_mod)
 *                               * bn.nansum(kernel))
 *                 box[np.nonzero(np.isnan(box))] = 0.             # <<<<<<<<<<<<<<
 *                 final_im[ix,iy] = bn.nansum(box * kernel_mod)
 * 
 */
        __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1066, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_1);
        __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_nonzero); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1066, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_2);
        __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
        __pyx_t_14 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 1066, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_14);
        __pyx_t_12 = __Pyx_PyObject_GetAttrStr(__pyx_t_14, __pyx_n_s_isnan); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 1066, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_12);
        __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
        __pyx_t_14 = NULL;
        if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_12))) {
          __pyx_t_14 = PyMethod_GET_SELF(__pyx_t_12);
          if (likely(__pyx_t_14)) {
            PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_12);
            __Pyx_INCREF(__pyx_t_14);
            __Pyx_INCREF(function);
            __Pyx_DECREF_SET(__pyx_t_12, function);
          }
        }
        if (!__pyx_t_14) {
          __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_12, ((PyObject *)__pyx_v_box)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1066, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_1);
        } else {
          __pyx_t_5 = PyTuple_New(1+1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1066, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_5);
          __Pyx_GIVEREF(__pyx_t_14); PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_14); __pyx_t_14 = NULL;
          __Pyx_INCREF(((PyObject *)__pyx_v_box));
          __Pyx_GIVEREF(((PyObject *)__pyx_v_box));
          PyTuple_SET_ITEM(__pyx_t_5, 0+1, ((PyObject *)__pyx_v_box));
          __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_12, __pyx_t_5, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1066, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_1);
          __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
        }
        __Pyx_DECREF(__pyx_t_12); __pyx_t_12 = 0;
        __pyx_t_12 = NULL;
        if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_2))) {
          __pyx_t_12 = PyMethod_GET_SELF(__pyx_t_2);
          if (likely(__pyx_t_12)) {
            PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
            __Pyx_INCREF(__pyx_t_12);
            __Pyx_INCREF(function);
            __Pyx_DECREF_SET(__pyx_t_2, function);
          }
        }
        if (!__pyx_t_12) {
          __pyx_t_4 = __Pyx_PyObject_CallOneArg(__pyx_t_2, __pyx_t_1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1066, __pyx_L1_error)
          __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
          __Pyx_GOTREF(__pyx_t_4);
        } else {
          __pyx_t_5 = PyTuple_New(1+1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1066, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_5);
          __Pyx_GIVEREF(__pyx_t_12); PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_12); __pyx_t_12 = NULL;
          __Pyx_GIVEREF(__pyx_t_1);
          PyTuple_SET_ITEM(__pyx_t_5, 0+1, __pyx_t_1);
          __pyx_t_1 = 0;
          __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_5, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1066, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_4);
          __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
        }
        __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
        if (unlikely(PyObject_SetItem(((PyObject *)__pyx_v_box), __pyx_t_4, __pyx_float_0_) < 0)) __PYX_ERR(0, 1066, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;

        /* "orb/cutils.pyx":1067
 *                               * bn.nansum(kernel))
 *                 box[np.nonzero(np.isnan(box))] = 0.
 *                 final_im[ix,iy] = bn.nansum(box * kernel_mod)             # <<<<<<<<<<<<<<
 * 
 *     return np.copy(final_im)
 */
        __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1067, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_2);
        __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_nansum); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1067, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_5);
        __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
        __pyx_t_2 = PyNumber_Multiply(((PyObject *)__pyx_v_box), ((PyObject *)__pyx_v_kernel_mod)); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1067, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_2);
        __pyx_t_1 = NULL;
        if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_5))) {
          __pyx_t_1 = PyMethod_GET_SELF(__pyx_t_5);
          if (likely(__pyx_t_1)) {
            PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_5);
            __Pyx_INCREF(__pyx_t_1);
            __Pyx_INCREF(function);
            __Pyx_DECREF_SET(__pyx_t_5, function);
          }
        }
        if (!__pyx_t_1) {
          __pyx_t_4 = __Pyx_PyObject_CallOneArg(__pyx_t_5, __pyx_t_2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1067, __pyx_L1_error)
          __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
          __Pyx_GOTREF(__pyx_t_4);
        } else {
          __pyx_t_12 = PyTuple_New(1+1); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 1067, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_12);
          __Pyx_GIVEREF(__pyx_t_1); PyTuple_SET_ITEM(__pyx_t_12, 0, __pyx_t_1); __pyx_t_1 = NULL;
          __Pyx_GIVEREF(__pyx_t_2);
          PyTuple_SET_ITEM(__pyx_t_12, 0+1, __pyx_t_2);
          __pyx_t_2 = 0;
          __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_12, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1067, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_4);
          __Pyx_DECREF(__pyx_t_12); __pyx_t_12 = 0;
        }
        __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
        __pyx_t_22 = __pyx_PyFloat_AsDouble(__pyx_t_4); if (unlikely((__pyx_t_22 == (npy_float64)-1) && PyErr_Occurred())) __PYX_ERR(0, 1067, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
        __pyx_t_23 = __pyx_v_ix;
        __pyx_t_24 = __pyx_v_iy;
        __pyx_t_20 = -1;
        if (__pyx_t_23 < 0) {
          __pyx_t_23 += __pyx_pybuffernd_final_im.diminfo[0].shape;
          if (unlikely(__pyx_t_23 < 0)) __pyx_t_20 = 0;
        } else if (unlikely(__pyx_t_23 >= __pyx_pybuffernd_final_im.diminfo[0].shape)) __pyx_t_20 = 0;
        if (__pyx_t_24 < 0) {
          __pyx_t_24 += __pyx_pybuffernd_final_im.diminfo[1].shape;
          if (unlikely(__pyx_t_24 < 0)) __pyx_t_20 = 1;
        } else if (unlikely(__pyx_t_24 >= __pyx_pybuffernd_final_im.diminfo[1].shape)) __pyx_t_20 = 1;
        if (unlikely(__pyx_t_20 != -1)) {
          __Pyx_RaiseBufferIndexError(__pyx_t_20);
          __PYX_ERR(0, 1067, __pyx_L1_error)
        }
        *__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_final_im.rcbuffer->pybuffer.buf, __pyx_t_23, __pyx_pybuffernd_final_im.diminfo[0].strides, __pyx_t_24, __pyx_pybuffernd_final_im.diminfo[1].strides) = __pyx_t_22;

        /* "orb/cutils.pyx":1062
 *             and  iy < im.shape[1] - deg):
 *             box = np.copy(im[ix-deg:ix+deg+1, iy-deg:iy+deg+1])
 *             if not np.isnan(bn.nansum(box)):             # <<<<<<<<<<<<<<
 *                 kernel_mod = kernel * (~np.isnan(box))
 *                 kernel_mod = (kernel_mod / bn.nansum(kernel_mod)
 */
      }

      /* "orb/cutils.pyx":1059
 *         ix = nans[0][inan]
 *         iy = nans[1][inan]
 *         if (ix >= deg and iy >= deg and ix < im.shape[0] - deg             # <<<<<<<<<<<<<<
 *             and  iy < im.shape[1] - deg):
 *             box = np.copy(im[ix-deg:ix+deg+1, iy-deg:iy+deg+1])
 */
    }
  }

  /* "orb/cutils.pyx":1069
 *                 final_im[ix,iy] = bn.nansum(box * kernel_mod)
 * 
 *     return np.copy(final_im)             # <<<<<<<<<<<<<<
 * 
 * def fast_gaussian_kernel(int deg):
 */
  __Pyx_XDECREF(__pyx_r);
  __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1069, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_12 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_copy); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 1069, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_12);
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_5 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_12))) {
    __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_12);
    if (likely(__pyx_t_5)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_12);
      __Pyx_INCREF(__pyx_t_5);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_12, function);
    }
  }
  if (!__pyx_t_5) {
    __pyx_t_4 = __Pyx_PyObject_CallOneArg(__pyx_t_12, ((PyObject *)__pyx_v_final_im)); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1069, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
  } else {
    __pyx_t_2 = PyTuple_New(1+1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1069, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_5); __pyx_t_5 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_final_im));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_final_im));
    PyTuple_SET_ITEM(__pyx_t_2, 0+1, ((PyObject *)__pyx_v_final_im));
    __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_12, __pyx_t_2, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1069, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  }
  __Pyx_DECREF(__pyx_t_12); __pyx_t_12 = 0;
  __pyx_r = __pyx_t_4;
  __pyx_t_4 = 0;
  goto __pyx_L0;

  /* "orb/cutils.pyx":1025
 * 
 * 
 * def low_pass_image_filter(np.ndarray[np.float64_t, ndim=2] im, int deg):             # <<<<<<<<<<<<<<
 *     """Low pass image filter by convolution with a gaussian kernel.
 * 
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_1);
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_XDECREF(__pyx_t_5);
  __Pyx_XDECREF(__pyx_t_12);
  __Pyx_XDECREF(__pyx_t_14);
  { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
    __Pyx_PyThreadState_declare
    __Pyx_PyThreadState_assign
    __Pyx_ErrFetch(&__pyx_type, &__pyx_value, &__pyx_tb);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_box.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_final_im.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_im.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_kernel.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_kernel_mod.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_new_nans.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_real_nans.rcbuffer->pybuffer);
  __Pyx_ErrRestore(__pyx_type, __pyx_value, __pyx_tb);}
  __Pyx_AddTraceback("orb.cutils.low_pass_image_filter", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  goto __pyx_L2;
  __pyx_L0:;
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_box.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_final_im.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_im.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_kernel.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_kernel_mod.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_new_nans.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_real_nans.rcbuffer->pybuffer);
  __pyx_L2:;
  __Pyx_XDECREF((PyObject *)__pyx_v_real_nans);
  __Pyx_XDECREF((PyObject *)__pyx_v_new_nans);
  __Pyx_XDECREF((PyObject *)__pyx_v_final_im);
  __Pyx_XDECREF((PyObject *)__pyx_v_kernel);
  __Pyx_XDECREF((PyObject *)__pyx_v_kernel_mod);
  __Pyx_XDECREF((PyObject *)__pyx_v_box);
  __Pyx_XDECREF(__pyx_v_nans);
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":1071
 *     return np.copy(final_im)
 * 
 * def fast_gaussian_kernel(int deg):             # <<<<<<<<<<<<<<
 *     """Return a fast gaussian kernel.
 * 
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_51fast_gaussian_kernel(PyObject *__pyx_self, PyObject *__pyx_arg_deg); /*proto*/
static char __pyx_doc_3orb_6cutils_50fast_gaussian_kernel[] = "fast_gaussian_kernel(int deg)\nReturn a fast gaussian kernel.\n\n    The value of each pixel is just the value of the gaussian at the\n    center of the pixel.\n\n    The degree gives the size of the kernel's side : size = 2 * deg + 1\n\n    :param deg: The degree of the kernel. Must be an integer >= 0.\n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_51fast_gaussian_kernel = {"fast_gaussian_kernel", (PyCFunction)__pyx_pw_3orb_6cutils_51fast_gaussian_kernel, METH_O, __pyx_doc_3orb_6cutils_50fast_gaussian_kernel};
static PyObject *__pyx_pw_3orb_6cutils_51fast_gaussian_kernel(PyObject *__pyx_self, PyObject *__pyx_arg_deg) {
  int __pyx_v_deg;
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("fast_gaussian_kernel (wrapper)", 0);
  assert(__pyx_arg_deg); {
    __pyx_v_deg = __Pyx_PyInt_As_int(__pyx_arg_deg); if (unlikely((__pyx_v_deg == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 1071, __pyx_L3_error)
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L3_error:;
  __Pyx_AddTraceback("orb.cutils.fast_gaussian_kernel", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __Pyx_RefNannyFinishContext();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  __pyx_r = __pyx_pf_3orb_6cutils_50fast_gaussian_kernel(__pyx_self, ((int)__pyx_v_deg));

  /* function exit code */
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_50fast_gaussian_kernel(CYTHON_UNUSED PyObject *__pyx_self, int __pyx_v_deg) {
  double __pyx_v_ddeg;
  int __pyx_v_sz;
  double __pyx_v_fwhm;
  PyArrayObject *__pyx_v_kernel = 0;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_kernel;
  __Pyx_Buffer __pyx_pybuffer_kernel;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  PyObject *__pyx_t_1 = NULL;
  PyObject *__pyx_t_2 = NULL;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  PyObject *__pyx_t_5 = NULL;
  PyArrayObject *__pyx_t_6 = NULL;
  int __pyx_t_7;
  PyObject *__pyx_t_8 = NULL;
  PyObject *__pyx_t_9 = NULL;
  PyObject *__pyx_t_10 = NULL;
  Py_ssize_t __pyx_t_11;
  PyObject *__pyx_t_12 = NULL;
  int __pyx_t_13;
  PyObject *__pyx_t_14 = NULL;
  PyObject *__pyx_t_15 = NULL;
  PyObject *__pyx_t_16 = NULL;
  __Pyx_RefNannySetupContext("fast_gaussian_kernel", 0);
  __pyx_pybuffer_kernel.pybuffer.buf = NULL;
  __pyx_pybuffer_kernel.refcount = 0;
  __pyx_pybuffernd_kernel.data = NULL;
  __pyx_pybuffernd_kernel.rcbuffer = &__pyx_pybuffer_kernel;

  /* "orb/cutils.pyx":1081
 *     :param deg: The degree of the kernel. Must be an integer >= 0.
 *     """
 *     cdef double ddeg = <double> deg             # <<<<<<<<<<<<<<
 *     cdef int sz = 2 * deg + 1
 *     cdef double fwhm = ddeg/2. * (2. * sqrt(2. * log(2.)))
 */
  __pyx_v_ddeg = ((double)__pyx_v_deg);

  /* "orb/cutils.pyx":1082
 *     """
 *     cdef double ddeg = <double> deg
 *     cdef int sz = 2 * deg + 1             # <<<<<<<<<<<<<<
 *     cdef double fwhm = ddeg/2. * (2. * sqrt(2. * log(2.)))
 *     cdef np.ndarray[np.float64_t, ndim=2] kernel = np.zeros(
 */
  __pyx_v_sz = ((2 * __pyx_v_deg) + 1);

  /* "orb/cutils.pyx":1083
 *     cdef double ddeg = <double> deg
 *     cdef int sz = 2 * deg + 1
 *     cdef double fwhm = ddeg/2. * (2. * sqrt(2. * log(2.)))             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.float64_t, ndim=2] kernel = np.zeros(
 *         (sz, sz), dtype=np.float64)
 */
  __pyx_v_fwhm = ((__pyx_v_ddeg / 2.) * (2. * sqrt((2. * log(2.)))));

  /* "orb/cutils.pyx":1084
 *     cdef int sz = 2 * deg + 1
 *     cdef double fwhm = ddeg/2. * (2. * sqrt(2. * log(2.)))
 *     cdef np.ndarray[np.float64_t, ndim=2] kernel = np.zeros(             # <<<<<<<<<<<<<<
 *         (sz, sz), dtype=np.float64)
 * 
 */
  __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1084, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_zeros); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1084, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1085
 *     cdef double fwhm = ddeg/2. * (2. * sqrt(2. * log(2.)))
 *     cdef np.ndarray[np.float64_t, ndim=2] kernel = np.zeros(
 *         (sz, sz), dtype=np.float64)             # <<<<<<<<<<<<<<
 * 
 *     if deg < 0: raise ValueError('deg must be >= 0')
 */
  __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_sz); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1085, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_3 = __Pyx_PyInt_From_int(__pyx_v_sz); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1085, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_4 = PyTuple_New(2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1085, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_GIVEREF(__pyx_t_1);
  PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_1);
  __Pyx_GIVEREF(__pyx_t_3);
  PyTuple_SET_ITEM(__pyx_t_4, 1, __pyx_t_3);
  __pyx_t_1 = 0;
  __pyx_t_3 = 0;

  /* "orb/cutils.pyx":1084
 *     cdef int sz = 2 * deg + 1
 *     cdef double fwhm = ddeg/2. * (2. * sqrt(2. * log(2.)))
 *     cdef np.ndarray[np.float64_t, ndim=2] kernel = np.zeros(             # <<<<<<<<<<<<<<
 *         (sz, sz), dtype=np.float64)
 * 
 */
  __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1084, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_GIVEREF(__pyx_t_4);
  PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_4);
  __pyx_t_4 = 0;

  /* "orb/cutils.pyx":1085
 *     cdef double fwhm = ddeg/2. * (2. * sqrt(2. * log(2.)))
 *     cdef np.ndarray[np.float64_t, ndim=2] kernel = np.zeros(
 *         (sz, sz), dtype=np.float64)             # <<<<<<<<<<<<<<
 * 
 *     if deg < 0: raise ValueError('deg must be >= 0')
 */
  __pyx_t_4 = PyDict_New(); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1085, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1085, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_float64); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1085, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  if (PyDict_SetItem(__pyx_t_4, __pyx_n_s_dtype, __pyx_t_5) < 0) __PYX_ERR(0, 1085, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

  /* "orb/cutils.pyx":1084
 *     cdef int sz = 2 * deg + 1
 *     cdef double fwhm = ddeg/2. * (2. * sqrt(2. * log(2.)))
 *     cdef np.ndarray[np.float64_t, ndim=2] kernel = np.zeros(             # <<<<<<<<<<<<<<
 *         (sz, sz), dtype=np.float64)
 * 
 */
  __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_3, __pyx_t_4); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1084, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  if (!(likely(((__pyx_t_5) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_5, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1084, __pyx_L1_error)
  __pyx_t_6 = ((PyArrayObject *)__pyx_t_5);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_kernel.rcbuffer->pybuffer, (PyObject*)__pyx_t_6, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
      __pyx_v_kernel = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_kernel.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 1084, __pyx_L1_error)
    } else {__pyx_pybuffernd_kernel.diminfo[0].strides = __pyx_pybuffernd_kernel.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_kernel.diminfo[0].shape = __pyx_pybuffernd_kernel.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_kernel.diminfo[1].strides = __pyx_pybuffernd_kernel.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_kernel.diminfo[1].shape = __pyx_pybuffernd_kernel.rcbuffer->pybuffer.shape[1];
    }
  }
  __pyx_t_6 = 0;
  __pyx_v_kernel = ((PyArrayObject *)__pyx_t_5);
  __pyx_t_5 = 0;

  /* "orb/cutils.pyx":1087
 *         (sz, sz), dtype=np.float64)
 * 
 *     if deg < 0: raise ValueError('deg must be >= 0')             # <<<<<<<<<<<<<<
 *     if deg > 0:
 *         kernel = gaussian_array2d(0., 1., ddeg, ddeg, fwhm, sz, sz)
 */
  __pyx_t_7 = ((__pyx_v_deg < 0) != 0);
  if (__pyx_t_7) {
    __pyx_t_5 = __Pyx_PyObject_Call(__pyx_builtin_ValueError, __pyx_tuple__53, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1087, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_Raise(__pyx_t_5, 0, 0, 0);
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    __PYX_ERR(0, 1087, __pyx_L1_error)
  }

  /* "orb/cutils.pyx":1088
 * 
 *     if deg < 0: raise ValueError('deg must be >= 0')
 *     if deg > 0:             # <<<<<<<<<<<<<<
 *         kernel = gaussian_array2d(0., 1., ddeg, ddeg, fwhm, sz, sz)
 *         kernel / bn.nansum(kernel)
 */
  __pyx_t_7 = ((__pyx_v_deg > 0) != 0);
  if (__pyx_t_7) {

    /* "orb/cutils.pyx":1089
 *     if deg < 0: raise ValueError('deg must be >= 0')
 *     if deg > 0:
 *         kernel = gaussian_array2d(0., 1., ddeg, ddeg, fwhm, sz, sz)             # <<<<<<<<<<<<<<
 *         kernel / bn.nansum(kernel)
 *         return kernel
 */
    __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_gaussian_array2d); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1089, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __pyx_t_3 = PyFloat_FromDouble(__pyx_v_ddeg); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1089, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __pyx_t_2 = PyFloat_FromDouble(__pyx_v_ddeg); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1089, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __pyx_t_1 = PyFloat_FromDouble(__pyx_v_fwhm); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1089, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __pyx_t_8 = __Pyx_PyInt_From_int(__pyx_v_sz); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 1089, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_8);
    __pyx_t_9 = __Pyx_PyInt_From_int(__pyx_v_sz); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 1089, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_9);
    __pyx_t_10 = NULL;
    __pyx_t_11 = 0;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_4))) {
      __pyx_t_10 = PyMethod_GET_SELF(__pyx_t_4);
      if (likely(__pyx_t_10)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
        __Pyx_INCREF(__pyx_t_10);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_4, function);
        __pyx_t_11 = 1;
      }
    }
    __pyx_t_12 = PyTuple_New(7+__pyx_t_11); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 1089, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_12);
    if (__pyx_t_10) {
      __Pyx_GIVEREF(__pyx_t_10); PyTuple_SET_ITEM(__pyx_t_12, 0, __pyx_t_10); __pyx_t_10 = NULL;
    }
    __Pyx_INCREF(__pyx_float_0_);
    __Pyx_GIVEREF(__pyx_float_0_);
    PyTuple_SET_ITEM(__pyx_t_12, 0+__pyx_t_11, __pyx_float_0_);
    __Pyx_INCREF(__pyx_float_1_);
    __Pyx_GIVEREF(__pyx_float_1_);
    PyTuple_SET_ITEM(__pyx_t_12, 1+__pyx_t_11, __pyx_float_1_);
    __Pyx_GIVEREF(__pyx_t_3);
    PyTuple_SET_ITEM(__pyx_t_12, 2+__pyx_t_11, __pyx_t_3);
    __Pyx_GIVEREF(__pyx_t_2);
    PyTuple_SET_ITEM(__pyx_t_12, 3+__pyx_t_11, __pyx_t_2);
    __Pyx_GIVEREF(__pyx_t_1);
    PyTuple_SET_ITEM(__pyx_t_12, 4+__pyx_t_11, __pyx_t_1);
    __Pyx_GIVEREF(__pyx_t_8);
    PyTuple_SET_ITEM(__pyx_t_12, 5+__pyx_t_11, __pyx_t_8);
    __Pyx_GIVEREF(__pyx_t_9);
    PyTuple_SET_ITEM(__pyx_t_12, 6+__pyx_t_11, __pyx_t_9);
    __pyx_t_3 = 0;
    __pyx_t_2 = 0;
    __pyx_t_1 = 0;
    __pyx_t_8 = 0;
    __pyx_t_9 = 0;
    __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_12, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1089, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_DECREF(__pyx_t_12); __pyx_t_12 = 0;
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    if (!(likely(((__pyx_t_5) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_5, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1089, __pyx_L1_error)
    __pyx_t_6 = ((PyArrayObject *)__pyx_t_5);
    {
      __Pyx_BufFmt_StackElem __pyx_stack[1];
      __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_kernel.rcbuffer->pybuffer);
      __pyx_t_13 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_kernel.rcbuffer->pybuffer, (PyObject*)__pyx_t_6, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
      if (unlikely(__pyx_t_13 < 0)) {
        PyErr_Fetch(&__pyx_t_14, &__pyx_t_15, &__pyx_t_16);
        if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_kernel.rcbuffer->pybuffer, (PyObject*)__pyx_v_kernel, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
          Py_XDECREF(__pyx_t_14); Py_XDECREF(__pyx_t_15); Py_XDECREF(__pyx_t_16);
          __Pyx_RaiseBufferFallbackError();
        } else {
          PyErr_Restore(__pyx_t_14, __pyx_t_15, __pyx_t_16);
        }
      }
      __pyx_pybuffernd_kernel.diminfo[0].strides = __pyx_pybuffernd_kernel.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_kernel.diminfo[0].shape = __pyx_pybuffernd_kernel.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_kernel.diminfo[1].strides = __pyx_pybuffernd_kernel.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_kernel.diminfo[1].shape = __pyx_pybuffernd_kernel.rcbuffer->pybuffer.shape[1];
      if (unlikely(__pyx_t_13 < 0)) __PYX_ERR(0, 1089, __pyx_L1_error)
    }
    __pyx_t_6 = 0;
    __Pyx_DECREF_SET(__pyx_v_kernel, ((PyArrayObject *)__pyx_t_5));
    __pyx_t_5 = 0;

    /* "orb/cutils.pyx":1090
 *     if deg > 0:
 *         kernel = gaussian_array2d(0., 1., ddeg, ddeg, fwhm, sz, sz)
 *         kernel / bn.nansum(kernel)             # <<<<<<<<<<<<<<
 *         return kernel
 *     else:
 */
    __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1090, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __pyx_t_12 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_nansum); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 1090, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_12);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_t_4 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_12))) {
      __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_12);
      if (likely(__pyx_t_4)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_12);
        __Pyx_INCREF(__pyx_t_4);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_12, function);
      }
    }
    if (!__pyx_t_4) {
      __pyx_t_5 = __Pyx_PyObject_CallOneArg(__pyx_t_12, ((PyObject *)__pyx_v_kernel)); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1090, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
    } else {
      __pyx_t_9 = PyTuple_New(1+1); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 1090, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_9);
      __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_9, 0, __pyx_t_4); __pyx_t_4 = NULL;
      __Pyx_INCREF(((PyObject *)__pyx_v_kernel));
      __Pyx_GIVEREF(((PyObject *)__pyx_v_kernel));
      PyTuple_SET_ITEM(__pyx_t_9, 0+1, ((PyObject *)__pyx_v_kernel));
      __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_12, __pyx_t_9, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1090, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
    }
    __Pyx_DECREF(__pyx_t_12); __pyx_t_12 = 0;
    __pyx_t_12 = __Pyx_PyNumber_Divide(((PyObject *)__pyx_v_kernel), __pyx_t_5); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 1090, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_12);
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    __Pyx_DECREF(__pyx_t_12); __pyx_t_12 = 0;

    /* "orb/cutils.pyx":1091
 *         kernel = gaussian_array2d(0., 1., ddeg, ddeg, fwhm, sz, sz)
 *         kernel / bn.nansum(kernel)
 *         return kernel             # <<<<<<<<<<<<<<
 *     else:
 *         kernel.fill(1.)
 */
    __Pyx_XDECREF(__pyx_r);
    __Pyx_INCREF(((PyObject *)__pyx_v_kernel));
    __pyx_r = ((PyObject *)__pyx_v_kernel);
    goto __pyx_L0;

    /* "orb/cutils.pyx":1088
 * 
 *     if deg < 0: raise ValueError('deg must be >= 0')
 *     if deg > 0:             # <<<<<<<<<<<<<<
 *         kernel = gaussian_array2d(0., 1., ddeg, ddeg, fwhm, sz, sz)
 *         kernel / bn.nansum(kernel)
 */
  }

  /* "orb/cutils.pyx":1093
 *         return kernel
 *     else:
 *         kernel.fill(1.)             # <<<<<<<<<<<<<<
 *         return kernel
 * 
 */
  /*else*/ {
    __pyx_t_12 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_kernel), __pyx_n_s_fill); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 1093, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_12);
    __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_12, __pyx_tuple__54, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1093, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_DECREF(__pyx_t_12); __pyx_t_12 = 0;
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

    /* "orb/cutils.pyx":1094
 *     else:
 *         kernel.fill(1.)
 *         return kernel             # <<<<<<<<<<<<<<
 * 
 * 
 */
    __Pyx_XDECREF(__pyx_r);
    __Pyx_INCREF(((PyObject *)__pyx_v_kernel));
    __pyx_r = ((PyObject *)__pyx_v_kernel);
    goto __pyx_L0;
  }

  /* "orb/cutils.pyx":1071
 *     return np.copy(final_im)
 * 
 * def fast_gaussian_kernel(int deg):             # <<<<<<<<<<<<<<
 *     """Return a fast gaussian kernel.
 * 
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_1);
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_XDECREF(__pyx_t_5);
  __Pyx_XDECREF(__pyx_t_8);
  __Pyx_XDECREF(__pyx_t_9);
  __Pyx_XDECREF(__pyx_t_10);
  __Pyx_XDECREF(__pyx_t_12);
  { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
    __Pyx_PyThreadState_declare
    __Pyx_PyThreadState_assign
    __Pyx_ErrFetch(&__pyx_type, &__pyx_value, &__pyx_tb);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_kernel.rcbuffer->pybuffer);
  __Pyx_ErrRestore(__pyx_type, __pyx_value, __pyx_tb);}
  __Pyx_AddTraceback("orb.cutils.fast_gaussian_kernel", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  goto __pyx_L2;
  __pyx_L0:;
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_kernel.rcbuffer->pybuffer);
  __pyx_L2:;
  __Pyx_XDECREF((PyObject *)__pyx_v_kernel);
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":1099
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def gaussian_kernel(double deg):             # <<<<<<<<<<<<<<
 *     """Return a gaussian kernel.
 * 
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_53gaussian_kernel(PyObject *__pyx_self, PyObject *__pyx_arg_deg); /*proto*/
static char __pyx_doc_3orb_6cutils_52gaussian_kernel[] = "gaussian_kernel(double deg)\nReturn a gaussian kernel.\n\n    The value of each pixel is the integral of the gaussian over the\n    whole pixel because the shape of the gaussian is not linear at\n    all. The estimation is done by subdividing each pixel in 9\n    sub-pixels.\n\n    The degree gives the size of the kernel's side : size = 2 * deg + 1\n\n    :param deg: The degree of the kernel. Must be an integer >= 0.\n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_53gaussian_kernel = {"gaussian_kernel", (PyCFunction)__pyx_pw_3orb_6cutils_53gaussian_kernel, METH_O, __pyx_doc_3orb_6cutils_52gaussian_kernel};
static PyObject *__pyx_pw_3orb_6cutils_53gaussian_kernel(PyObject *__pyx_self, PyObject *__pyx_arg_deg) {
  double __pyx_v_deg;
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("gaussian_kernel (wrapper)", 0);
  assert(__pyx_arg_deg); {
    __pyx_v_deg = __pyx_PyFloat_AsDouble(__pyx_arg_deg); if (unlikely((__pyx_v_deg == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 1099, __pyx_L3_error)
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L3_error:;
  __Pyx_AddTraceback("orb.cutils.gaussian_kernel", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __Pyx_RefNannyFinishContext();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  __pyx_r = __pyx_pf_3orb_6cutils_52gaussian_kernel(__pyx_self, ((double)__pyx_v_deg));

  /* function exit code */
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_52gaussian_kernel(CYTHON_UNUSED PyObject *__pyx_self, double __pyx_v_deg) {
  int __pyx_v_ideg;
  int __pyx_v_sz;
  int __pyx_v_PRECISION_COEFF;
  int __pyx_v_large_sz;
  PyArrayObject *__pyx_v_large_kernel = 0;
  double __pyx_v_fwhm;
  PyArrayObject *__pyx_v_kernel = 0;
  int __pyx_v_ii;
  int __pyx_v_ij;
  int __pyx_v_i;
  int __pyx_v_j;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_kernel;
  __Pyx_Buffer __pyx_pybuffer_kernel;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_large_kernel;
  __Pyx_Buffer __pyx_pybuffer_large_kernel;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  PyObject *__pyx_t_1 = NULL;
  PyObject *__pyx_t_2 = NULL;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  PyObject *__pyx_t_5 = NULL;
  PyArrayObject *__pyx_t_6 = NULL;
  PyArrayObject *__pyx_t_7 = NULL;
  int __pyx_t_8;
  PyObject *__pyx_t_9 = NULL;
  PyObject *__pyx_t_10 = NULL;
  PyObject *__pyx_t_11 = NULL;
  Py_ssize_t __pyx_t_12;
  PyObject *__pyx_t_13 = NULL;
  int __pyx_t_14;
  PyObject *__pyx_t_15 = NULL;
  PyObject *__pyx_t_16 = NULL;
  PyObject *__pyx_t_17 = NULL;
  int __pyx_t_18;
  int __pyx_t_19;
  int __pyx_t_20;
  Py_ssize_t __pyx_t_21;
  Py_ssize_t __pyx_t_22;
  Py_ssize_t __pyx_t_23;
  Py_ssize_t __pyx_t_24;
  __Pyx_RefNannySetupContext("gaussian_kernel", 0);
  __pyx_pybuffer_large_kernel.pybuffer.buf = NULL;
  __pyx_pybuffer_large_kernel.refcount = 0;
  __pyx_pybuffernd_large_kernel.data = NULL;
  __pyx_pybuffernd_large_kernel.rcbuffer = &__pyx_pybuffer_large_kernel;
  __pyx_pybuffer_kernel.pybuffer.buf = NULL;
  __pyx_pybuffer_kernel.refcount = 0;
  __pyx_pybuffernd_kernel.data = NULL;
  __pyx_pybuffernd_kernel.rcbuffer = &__pyx_pybuffer_kernel;

  /* "orb/cutils.pyx":1111
 *     :param deg: The degree of the kernel. Must be an integer >= 0.
 *     """
 *     cdef int ideg = <int> floor(deg)             # <<<<<<<<<<<<<<
 *     cdef int sz = 2 * ideg + 1
 *     cdef int PRECISION_COEFF = 9 # must be odd and >= 3
 */
  __pyx_v_ideg = ((int)floor(__pyx_v_deg));

  /* "orb/cutils.pyx":1112
 *     """
 *     cdef int ideg = <int> floor(deg)
 *     cdef int sz = 2 * ideg + 1             # <<<<<<<<<<<<<<
 *     cdef int PRECISION_COEFF = 9 # must be odd and >= 3
 *     cdef int large_sz = PRECISION_COEFF * sz
 */
  __pyx_v_sz = ((2 * __pyx_v_ideg) + 1);

  /* "orb/cutils.pyx":1113
 *     cdef int ideg = <int> floor(deg)
 *     cdef int sz = 2 * ideg + 1
 *     cdef int PRECISION_COEFF = 9 # must be odd and >= 3             # <<<<<<<<<<<<<<
 *     cdef int large_sz = PRECISION_COEFF * sz
 *     cdef np.ndarray[np.float64_t, ndim=2] large_kernel = np.zeros(
 */
  __pyx_v_PRECISION_COEFF = 9;

  /* "orb/cutils.pyx":1114
 *     cdef int sz = 2 * ideg + 1
 *     cdef int PRECISION_COEFF = 9 # must be odd and >= 3
 *     cdef int large_sz = PRECISION_COEFF * sz             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.float64_t, ndim=2] large_kernel = np.zeros(
 *         (large_sz, large_sz), dtype=np.float64)
 */
  __pyx_v_large_sz = (__pyx_v_PRECISION_COEFF * __pyx_v_sz);

  /* "orb/cutils.pyx":1115
 *     cdef int PRECISION_COEFF = 9 # must be odd and >= 3
 *     cdef int large_sz = PRECISION_COEFF * sz
 *     cdef np.ndarray[np.float64_t, ndim=2] large_kernel = np.zeros(             # <<<<<<<<<<<<<<
 *         (large_sz, large_sz), dtype=np.float64)
 * 
 */
  __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1115, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_zeros); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1115, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1116
 *     cdef int large_sz = PRECISION_COEFF * sz
 *     cdef np.ndarray[np.float64_t, ndim=2] large_kernel = np.zeros(
 *         (large_sz, large_sz), dtype=np.float64)             # <<<<<<<<<<<<<<
 * 
 *     cdef double fwhm = deg/2. * (2. * sqrt(2. * log(2.)))
 */
  __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_large_sz); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1116, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_3 = __Pyx_PyInt_From_int(__pyx_v_large_sz); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1116, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_4 = PyTuple_New(2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1116, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_GIVEREF(__pyx_t_1);
  PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_1);
  __Pyx_GIVEREF(__pyx_t_3);
  PyTuple_SET_ITEM(__pyx_t_4, 1, __pyx_t_3);
  __pyx_t_1 = 0;
  __pyx_t_3 = 0;

  /* "orb/cutils.pyx":1115
 *     cdef int PRECISION_COEFF = 9 # must be odd and >= 3
 *     cdef int large_sz = PRECISION_COEFF * sz
 *     cdef np.ndarray[np.float64_t, ndim=2] large_kernel = np.zeros(             # <<<<<<<<<<<<<<
 *         (large_sz, large_sz), dtype=np.float64)
 * 
 */
  __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1115, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_GIVEREF(__pyx_t_4);
  PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_4);
  __pyx_t_4 = 0;

  /* "orb/cutils.pyx":1116
 *     cdef int large_sz = PRECISION_COEFF * sz
 *     cdef np.ndarray[np.float64_t, ndim=2] large_kernel = np.zeros(
 *         (large_sz, large_sz), dtype=np.float64)             # <<<<<<<<<<<<<<
 * 
 *     cdef double fwhm = deg/2. * (2. * sqrt(2. * log(2.)))
 */
  __pyx_t_4 = PyDict_New(); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1116, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1116, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_float64); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1116, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  if (PyDict_SetItem(__pyx_t_4, __pyx_n_s_dtype, __pyx_t_5) < 0) __PYX_ERR(0, 1116, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

  /* "orb/cutils.pyx":1115
 *     cdef int PRECISION_COEFF = 9 # must be odd and >= 3
 *     cdef int large_sz = PRECISION_COEFF * sz
 *     cdef np.ndarray[np.float64_t, ndim=2] large_kernel = np.zeros(             # <<<<<<<<<<<<<<
 *         (large_sz, large_sz), dtype=np.float64)
 * 
 */
  __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_3, __pyx_t_4); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1115, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  if (!(likely(((__pyx_t_5) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_5, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1115, __pyx_L1_error)
  __pyx_t_6 = ((PyArrayObject *)__pyx_t_5);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_large_kernel.rcbuffer->pybuffer, (PyObject*)__pyx_t_6, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
      __pyx_v_large_kernel = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_large_kernel.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 1115, __pyx_L1_error)
    } else {__pyx_pybuffernd_large_kernel.diminfo[0].strides = __pyx_pybuffernd_large_kernel.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_large_kernel.diminfo[0].shape = __pyx_pybuffernd_large_kernel.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_large_kernel.diminfo[1].strides = __pyx_pybuffernd_large_kernel.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_large_kernel.diminfo[1].shape = __pyx_pybuffernd_large_kernel.rcbuffer->pybuffer.shape[1];
    }
  }
  __pyx_t_6 = 0;
  __pyx_v_large_kernel = ((PyArrayObject *)__pyx_t_5);
  __pyx_t_5 = 0;

  /* "orb/cutils.pyx":1118
 *         (large_sz, large_sz), dtype=np.float64)
 * 
 *     cdef double fwhm = deg/2. * (2. * sqrt(2. * log(2.)))             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.float64_t, ndim=2] kernel = np.zeros(
 *         (sz, sz), dtype=float)
 */
  __pyx_v_fwhm = ((__pyx_v_deg / 2.) * (2. * sqrt((2. * log(2.)))));

  /* "orb/cutils.pyx":1119
 * 
 *     cdef double fwhm = deg/2. * (2. * sqrt(2. * log(2.)))
 *     cdef np.ndarray[np.float64_t, ndim=2] kernel = np.zeros(             # <<<<<<<<<<<<<<
 *         (sz, sz), dtype=float)
 *     cdef int ii, ij, i, j
 */
  __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1119, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_zeros); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1119, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

  /* "orb/cutils.pyx":1120
 *     cdef double fwhm = deg/2. * (2. * sqrt(2. * log(2.)))
 *     cdef np.ndarray[np.float64_t, ndim=2] kernel = np.zeros(
 *         (sz, sz), dtype=float)             # <<<<<<<<<<<<<<
 *     cdef int ii, ij, i, j
 * 
 */
  __pyx_t_5 = __Pyx_PyInt_From_int(__pyx_v_sz); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1120, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_3 = __Pyx_PyInt_From_int(__pyx_v_sz); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1120, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_2 = PyTuple_New(2); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1120, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_GIVEREF(__pyx_t_5);
  PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_5);
  __Pyx_GIVEREF(__pyx_t_3);
  PyTuple_SET_ITEM(__pyx_t_2, 1, __pyx_t_3);
  __pyx_t_5 = 0;
  __pyx_t_3 = 0;

  /* "orb/cutils.pyx":1119
 * 
 *     cdef double fwhm = deg/2. * (2. * sqrt(2. * log(2.)))
 *     cdef np.ndarray[np.float64_t, ndim=2] kernel = np.zeros(             # <<<<<<<<<<<<<<
 *         (sz, sz), dtype=float)
 *     cdef int ii, ij, i, j
 */
  __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1119, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_GIVEREF(__pyx_t_2);
  PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_2);
  __pyx_t_2 = 0;

  /* "orb/cutils.pyx":1120
 *     cdef double fwhm = deg/2. * (2. * sqrt(2. * log(2.)))
 *     cdef np.ndarray[np.float64_t, ndim=2] kernel = np.zeros(
 *         (sz, sz), dtype=float)             # <<<<<<<<<<<<<<
 *     cdef int ii, ij, i, j
 * 
 */
  __pyx_t_2 = PyDict_New(); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1120, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  if (PyDict_SetItem(__pyx_t_2, __pyx_n_s_dtype, ((PyObject *)(&PyFloat_Type))) < 0) __PYX_ERR(0, 1120, __pyx_L1_error)

  /* "orb/cutils.pyx":1119
 * 
 *     cdef double fwhm = deg/2. * (2. * sqrt(2. * log(2.)))
 *     cdef np.ndarray[np.float64_t, ndim=2] kernel = np.zeros(             # <<<<<<<<<<<<<<
 *         (sz, sz), dtype=float)
 *     cdef int ii, ij, i, j
 */
  __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_3, __pyx_t_2); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1119, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  if (!(likely(((__pyx_t_5) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_5, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1119, __pyx_L1_error)
  __pyx_t_7 = ((PyArrayObject *)__pyx_t_5);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_kernel.rcbuffer->pybuffer, (PyObject*)__pyx_t_7, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 2, 0, __pyx_stack) == -1)) {
      __pyx_v_kernel = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_kernel.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 1119, __pyx_L1_error)
    } else {__pyx_pybuffernd_kernel.diminfo[0].strides = __pyx_pybuffernd_kernel.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_kernel.diminfo[0].shape = __pyx_pybuffernd_kernel.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_kernel.diminfo[1].strides = __pyx_pybuffernd_kernel.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_kernel.diminfo[1].shape = __pyx_pybuffernd_kernel.rcbuffer->pybuffer.shape[1];
    }
  }
  __pyx_t_7 = 0;
  __pyx_v_kernel = ((PyArrayObject *)__pyx_t_5);
  __pyx_t_5 = 0;

  /* "orb/cutils.pyx":1124
 * 
 * 
 *     if deg < 0: raise Exception('deg must be >= 0')             # <<<<<<<<<<<<<<
 * 
 *     large_kernel = gaussian_array2d(0., 1.,
 */
  __pyx_t_8 = ((__pyx_v_deg < 0.0) != 0);
  if (__pyx_t_8) {
    __pyx_t_5 = __Pyx_PyObject_Call(__pyx_builtin_Exception, __pyx_tuple__55, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1124, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_Raise(__pyx_t_5, 0, 0, 0);
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    __PYX_ERR(0, 1124, __pyx_L1_error)
  }

  /* "orb/cutils.pyx":1126
 *     if deg < 0: raise Exception('deg must be >= 0')
 * 
 *     large_kernel = gaussian_array2d(0., 1.,             # <<<<<<<<<<<<<<
 *                                     <double> large_sz / 2. - 0.5,
 *                                     <double> large_sz / 2. - 0.5,
 */
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_gaussian_array2d); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1126, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);

  /* "orb/cutils.pyx":1127
 * 
 *     large_kernel = gaussian_array2d(0., 1.,
 *                                     <double> large_sz / 2. - 0.5,             # <<<<<<<<<<<<<<
 *                                     <double> large_sz / 2. - 0.5,
 *                                     fwhm * <double> PRECISION_COEFF,
 */
  __pyx_t_3 = PyFloat_FromDouble(((((double)__pyx_v_large_sz) / 2.) - 0.5)); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1127, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);

  /* "orb/cutils.pyx":1128
 *     large_kernel = gaussian_array2d(0., 1.,
 *                                     <double> large_sz / 2. - 0.5,
 *                                     <double> large_sz / 2. - 0.5,             # <<<<<<<<<<<<<<
 *                                     fwhm * <double> PRECISION_COEFF,
 *                                     large_sz, large_sz)
 */
  __pyx_t_4 = PyFloat_FromDouble(((((double)__pyx_v_large_sz) / 2.) - 0.5)); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1128, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);

  /* "orb/cutils.pyx":1129
 *                                     <double> large_sz / 2. - 0.5,
 *                                     <double> large_sz / 2. - 0.5,
 *                                     fwhm * <double> PRECISION_COEFF,             # <<<<<<<<<<<<<<
 *                                     large_sz, large_sz)
 * 
 */
  __pyx_t_1 = PyFloat_FromDouble((__pyx_v_fwhm * ((double)__pyx_v_PRECISION_COEFF))); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1129, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);

  /* "orb/cutils.pyx":1130
 *                                     <double> large_sz / 2. - 0.5,
 *                                     fwhm * <double> PRECISION_COEFF,
 *                                     large_sz, large_sz)             # <<<<<<<<<<<<<<
 * 
 *     with nogil:
 */
  __pyx_t_9 = __Pyx_PyInt_From_int(__pyx_v_large_sz); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 1130, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_9);
  __pyx_t_10 = __Pyx_PyInt_From_int(__pyx_v_large_sz); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 1130, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_10);
  __pyx_t_11 = NULL;
  __pyx_t_12 = 0;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_2))) {
    __pyx_t_11 = PyMethod_GET_SELF(__pyx_t_2);
    if (likely(__pyx_t_11)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
      __Pyx_INCREF(__pyx_t_11);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_2, function);
      __pyx_t_12 = 1;
    }
  }
  __pyx_t_13 = PyTuple_New(7+__pyx_t_12); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 1126, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_13);
  if (__pyx_t_11) {
    __Pyx_GIVEREF(__pyx_t_11); PyTuple_SET_ITEM(__pyx_t_13, 0, __pyx_t_11); __pyx_t_11 = NULL;
  }
  __Pyx_INCREF(__pyx_float_0_);
  __Pyx_GIVEREF(__pyx_float_0_);
  PyTuple_SET_ITEM(__pyx_t_13, 0+__pyx_t_12, __pyx_float_0_);
  __Pyx_INCREF(__pyx_float_1_);
  __Pyx_GIVEREF(__pyx_float_1_);
  PyTuple_SET_ITEM(__pyx_t_13, 1+__pyx_t_12, __pyx_float_1_);
  __Pyx_GIVEREF(__pyx_t_3);
  PyTuple_SET_ITEM(__pyx_t_13, 2+__pyx_t_12, __pyx_t_3);
  __Pyx_GIVEREF(__pyx_t_4);
  PyTuple_SET_ITEM(__pyx_t_13, 3+__pyx_t_12, __pyx_t_4);
  __Pyx_GIVEREF(__pyx_t_1);
  PyTuple_SET_ITEM(__pyx_t_13, 4+__pyx_t_12, __pyx_t_1);
  __Pyx_GIVEREF(__pyx_t_9);
  PyTuple_SET_ITEM(__pyx_t_13, 5+__pyx_t_12, __pyx_t_9);
  __Pyx_GIVEREF(__pyx_t_10);
  PyTuple_SET_ITEM(__pyx_t_13, 6+__pyx_t_12, __pyx_t_10);
  __pyx_t_3 = 0;
  __pyx_t_4 = 0;
  __pyx_t_1 = 0;
  __pyx_t_9 = 0;
  __pyx_t_10 = 0;
  __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_13, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1126, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;

  /* "orb/cutils.pyx":1126
 *     if deg < 0: raise Exception('deg must be >= 0')
 * 
 *     large_kernel = gaussian_array2d(0., 1.,             # <<<<<<<<<<<<<<
 *                                     <double> large_sz / 2. - 0.5,
 *                                     <double> large_sz / 2. - 0.5,
 */
  if (!(likely(((__pyx_t_5) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_5, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1126, __pyx_L1_error)
  __pyx_t_6 = ((PyArrayObject *)__pyx_t_5);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_large_kernel.rcbuffer->pybuffer);
    __pyx_t_14 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_large_kernel.rcbuffer->pybuffer, (PyObject*)__pyx_t_6, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
    if (unlikely(__pyx_t_14 < 0)) {
      PyErr_Fetch(&__pyx_t_15, &__pyx_t_16, &__pyx_t_17);
      if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_large_kernel.rcbuffer->pybuffer, (PyObject*)__pyx_v_large_kernel, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_15); Py_XDECREF(__pyx_t_16); Py_XDECREF(__pyx_t_17);
        __Pyx_RaiseBufferFallbackError();
      } else {
        PyErr_Restore(__pyx_t_15, __pyx_t_16, __pyx_t_17);
      }
    }
    __pyx_pybuffernd_large_kernel.diminfo[0].strides = __pyx_pybuffernd_large_kernel.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_large_kernel.diminfo[0].shape = __pyx_pybuffernd_large_kernel.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_large_kernel.diminfo[1].strides = __pyx_pybuffernd_large_kernel.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_large_kernel.diminfo[1].shape = __pyx_pybuffernd_large_kernel.rcbuffer->pybuffer.shape[1];
    if (unlikely(__pyx_t_14 < 0)) __PYX_ERR(0, 1126, __pyx_L1_error)
  }
  __pyx_t_6 = 0;
  __Pyx_DECREF_SET(__pyx_v_large_kernel, ((PyArrayObject *)__pyx_t_5));
  __pyx_t_5 = 0;

  /* "orb/cutils.pyx":1132
 *                                     large_sz, large_sz)
 * 
 *     with nogil:             # <<<<<<<<<<<<<<
 *         for ii in range(large_sz):
 *             for ij in range(large_sz):
 */
  {
      #ifdef WITH_THREAD
      PyThreadState *_save;
      Py_UNBLOCK_THREADS
      #endif
      /*try:*/ {

        /* "orb/cutils.pyx":1133
 * 
 *     with nogil:
 *         for ii in range(large_sz):             # <<<<<<<<<<<<<<
 *             for ij in range(large_sz):
 *                 i = <int> (<double> ii / <double> PRECISION_COEFF)
 */
        __pyx_t_14 = __pyx_v_large_sz;
        for (__pyx_t_18 = 0; __pyx_t_18 < __pyx_t_14; __pyx_t_18+=1) {
          __pyx_v_ii = __pyx_t_18;

          /* "orb/cutils.pyx":1134
 *     with nogil:
 *         for ii in range(large_sz):
 *             for ij in range(large_sz):             # <<<<<<<<<<<<<<
 *                 i = <int> (<double> ii / <double> PRECISION_COEFF)
 *                 j = <int> (<double> ij / <double> PRECISION_COEFF)
 */
          __pyx_t_19 = __pyx_v_large_sz;
          for (__pyx_t_20 = 0; __pyx_t_20 < __pyx_t_19; __pyx_t_20+=1) {
            __pyx_v_ij = __pyx_t_20;

            /* "orb/cutils.pyx":1135
 *         for ii in range(large_sz):
 *             for ij in range(large_sz):
 *                 i = <int> (<double> ii / <double> PRECISION_COEFF)             # <<<<<<<<<<<<<<
 *                 j = <int> (<double> ij / <double> PRECISION_COEFF)
 *                 kernel[i,j] += large_kernel[ii,ij]
 */
            if (unlikely(((double)__pyx_v_PRECISION_COEFF) == 0)) {
              #ifdef WITH_THREAD
              PyGILState_STATE __pyx_gilstate_save = PyGILState_Ensure();
              #endif
              PyErr_SetString(PyExc_ZeroDivisionError, "float division");
              #ifdef WITH_THREAD
              PyGILState_Release(__pyx_gilstate_save);
              #endif
              __PYX_ERR(0, 1135, __pyx_L5_error)
            }
            __pyx_v_i = ((int)(((double)__pyx_v_ii) / ((double)__pyx_v_PRECISION_COEFF)));

            /* "orb/cutils.pyx":1136
 *             for ij in range(large_sz):
 *                 i = <int> (<double> ii / <double> PRECISION_COEFF)
 *                 j = <int> (<double> ij / <double> PRECISION_COEFF)             # <<<<<<<<<<<<<<
 *                 kernel[i,j] += large_kernel[ii,ij]
 * 
 */
            if (unlikely(((double)__pyx_v_PRECISION_COEFF) == 0)) {
              #ifdef WITH_THREAD
              PyGILState_STATE __pyx_gilstate_save = PyGILState_Ensure();
              #endif
              PyErr_SetString(PyExc_ZeroDivisionError, "float division");
              #ifdef WITH_THREAD
              PyGILState_Release(__pyx_gilstate_save);
              #endif
              __PYX_ERR(0, 1136, __pyx_L5_error)
            }
            __pyx_v_j = ((int)(((double)__pyx_v_ij) / ((double)__pyx_v_PRECISION_COEFF)));

            /* "orb/cutils.pyx":1137
 *                 i = <int> (<double> ii / <double> PRECISION_COEFF)
 *                 j = <int> (<double> ij / <double> PRECISION_COEFF)
 *                 kernel[i,j] += large_kernel[ii,ij]             # <<<<<<<<<<<<<<
 * 
 *     return kernel / bn.nansum(kernel)
 */
            __pyx_t_21 = __pyx_v_ii;
            __pyx_t_22 = __pyx_v_ij;
            __pyx_t_23 = __pyx_v_i;
            __pyx_t_24 = __pyx_v_j;
            *__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_kernel.rcbuffer->pybuffer.buf, __pyx_t_23, __pyx_pybuffernd_kernel.diminfo[0].strides, __pyx_t_24, __pyx_pybuffernd_kernel.diminfo[1].strides) += (*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_large_kernel.rcbuffer->pybuffer.buf, __pyx_t_21, __pyx_pybuffernd_large_kernel.diminfo[0].strides, __pyx_t_22, __pyx_pybuffernd_large_kernel.diminfo[1].strides));
          }
        }
      }

      /* "orb/cutils.pyx":1132
 *                                     large_sz, large_sz)
 * 
 *     with nogil:             # <<<<<<<<<<<<<<
 *         for ii in range(large_sz):
 *             for ij in range(large_sz):
 */
      /*finally:*/ {
        /*normal exit:*/{
          #ifdef WITH_THREAD
          Py_BLOCK_THREADS
          #endif
          goto __pyx_L6;
        }
        __pyx_L5_error: {
          #ifdef WITH_THREAD
          Py_BLOCK_THREADS
          #endif
          goto __pyx_L1_error;
        }
        __pyx_L6:;
      }
  }

  /* "orb/cutils.pyx":1139
 *                 kernel[i,j] += large_kernel[ii,ij]
 * 
 *     return kernel / bn.nansum(kernel)             # <<<<<<<<<<<<<<
 * 
 * 
 */
  __Pyx_XDECREF(__pyx_r);
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1139, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_13 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_nansum); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 1139, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_13);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_13))) {
    __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_13);
    if (likely(__pyx_t_2)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_13);
      __Pyx_INCREF(__pyx_t_2);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_13, function);
    }
  }
  if (!__pyx_t_2) {
    __pyx_t_5 = __Pyx_PyObject_CallOneArg(__pyx_t_13, ((PyObject *)__pyx_v_kernel)); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1139, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
  } else {
    __pyx_t_10 = PyTuple_New(1+1); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 1139, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_10);
    __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_10, 0, __pyx_t_2); __pyx_t_2 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_kernel));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_kernel));
    PyTuple_SET_ITEM(__pyx_t_10, 0+1, ((PyObject *)__pyx_v_kernel));
    __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_13, __pyx_t_10, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1139, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
  }
  __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
  __pyx_t_13 = __Pyx_PyNumber_Divide(((PyObject *)__pyx_v_kernel), __pyx_t_5); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 1139, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_13);
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_r = __pyx_t_13;
  __pyx_t_13 = 0;
  goto __pyx_L0;

  /* "orb/cutils.pyx":1099
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def gaussian_kernel(double deg):             # <<<<<<<<<<<<<<
 *     """Return a gaussian kernel.
 * 
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_1);
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_XDECREF(__pyx_t_5);
  __Pyx_XDECREF(__pyx_t_9);
  __Pyx_XDECREF(__pyx_t_10);
  __Pyx_XDECREF(__pyx_t_11);
  __Pyx_XDECREF(__pyx_t_13);
  { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
    __Pyx_PyThreadState_declare
    __Pyx_PyThreadState_assign
    __Pyx_ErrFetch(&__pyx_type, &__pyx_value, &__pyx_tb);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_kernel.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_large_kernel.rcbuffer->pybuffer);
  __Pyx_ErrRestore(__pyx_type, __pyx_value, __pyx_tb);}
  __Pyx_AddTraceback("orb.cutils.gaussian_kernel", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  goto __pyx_L2;
  __pyx_L0:;
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_kernel.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_large_kernel.rcbuffer->pybuffer);
  __pyx_L2:;
  __Pyx_XDECREF((PyObject *)__pyx_v_large_kernel);
  __Pyx_XDECREF((PyObject *)__pyx_v_kernel);
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":1142
 * 
 * 
 * def get_box_coords(int ix, int iy, int box_size,             # <<<<<<<<<<<<<<
 *                    int x_lim_min, int x_lim_max,
 *                    int y_lim_min, int y_lim_max):
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_55get_box_coords(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_3orb_6cutils_54get_box_coords[] = "get_box_coords(int ix, int iy, int box_size, int x_lim_min, int x_lim_max, int y_lim_min, int y_lim_max)\nReturn the coordinates of a box given the center of the box,\n    its size and the limits of the range along x and y axes.\n\n    :param ix: center of the box along x axis\n    :param iy: center of the box along y axis\n    \n    :param box_size: Size of the box. The final size of the box will\n      generally be the same if box_size is odd. Note that the final\n      size of the box cannot be guaranteed.\n\n    :param x_lim_min: Minimum limit of the range along x.\n    :param x_lim_max: Maximum limit of the range along x.\n    :param y_lim_min: Minimum limit of the range along y.\n    :param y_lim_max: Maximum limit of the range along y.\n\n    :return: x_min, x_max, y_min, y_max\n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_55get_box_coords = {"get_box_coords", (PyCFunction)__pyx_pw_3orb_6cutils_55get_box_coords, METH_VARARGS|METH_KEYWORDS, __pyx_doc_3orb_6cutils_54get_box_coords};
static PyObject *__pyx_pw_3orb_6cutils_55get_box_coords(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  int __pyx_v_ix;
  int __pyx_v_iy;
  int __pyx_v_box_size;
  int __pyx_v_x_lim_min;
  int __pyx_v_x_lim_max;
  int __pyx_v_y_lim_min;
  int __pyx_v_y_lim_max;
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("get_box_coords (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_ix,&__pyx_n_s_iy,&__pyx_n_s_box_size,&__pyx_n_s_x_lim_min,&__pyx_n_s_x_lim_max,&__pyx_n_s_y_lim_min,&__pyx_n_s_y_lim_max,0};
    PyObject* values[7] = {0,0,0,0,0,0,0};
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
      switch (pos_args) {
        case  7: values[6] = PyTuple_GET_ITEM(__pyx_args, 6);
        case  6: values[5] = PyTuple_GET_ITEM(__pyx_args, 5);
        case  5: values[4] = PyTuple_GET_ITEM(__pyx_args, 4);
        case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = PyDict_Size(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_ix)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        case  1:
        if (likely((values[1] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_iy)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("get_box_coords", 1, 7, 7, 1); __PYX_ERR(0, 1142, __pyx_L3_error)
        }
        case  2:
        if (likely((values[2] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_box_size)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("get_box_coords", 1, 7, 7, 2); __PYX_ERR(0, 1142, __pyx_L3_error)
        }
        case  3:
        if (likely((values[3] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_x_lim_min)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("get_box_coords", 1, 7, 7, 3); __PYX_ERR(0, 1142, __pyx_L3_error)
        }
        case  4:
        if (likely((values[4] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_x_lim_max)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("get_box_coords", 1, 7, 7, 4); __PYX_ERR(0, 1142, __pyx_L3_error)
        }
        case  5:
        if (likely((values[5] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_y_lim_min)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("get_box_coords", 1, 7, 7, 5); __PYX_ERR(0, 1142, __pyx_L3_error)
        }
        case  6:
        if (likely((values[6] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_y_lim_max)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("get_box_coords", 1, 7, 7, 6); __PYX_ERR(0, 1142, __pyx_L3_error)
        }
      }
      if (unlikely(kw_args > 0)) {
        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "get_box_coords") < 0)) __PYX_ERR(0, 1142, __pyx_L3_error)
      }
    } else if (PyTuple_GET_SIZE(__pyx_args) != 7) {
      goto __pyx_L5_argtuple_error;
    } else {
      values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
      values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
      values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
      values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
      values[4] = PyTuple_GET_ITEM(__pyx_args, 4);
      values[5] = PyTuple_GET_ITEM(__pyx_args, 5);
      values[6] = PyTuple_GET_ITEM(__pyx_args, 6);
    }
    __pyx_v_ix = __Pyx_PyInt_As_int(values[0]); if (unlikely((__pyx_v_ix == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 1142, __pyx_L3_error)
    __pyx_v_iy = __Pyx_PyInt_As_int(values[1]); if (unlikely((__pyx_v_iy == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 1142, __pyx_L3_error)
    __pyx_v_box_size = __Pyx_PyInt_As_int(values[2]); if (unlikely((__pyx_v_box_size == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 1142, __pyx_L3_error)
    __pyx_v_x_lim_min = __Pyx_PyInt_As_int(values[3]); if (unlikely((__pyx_v_x_lim_min == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 1143, __pyx_L3_error)
    __pyx_v_x_lim_max = __Pyx_PyInt_As_int(values[4]); if (unlikely((__pyx_v_x_lim_max == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 1143, __pyx_L3_error)
    __pyx_v_y_lim_min = __Pyx_PyInt_As_int(values[5]); if (unlikely((__pyx_v_y_lim_min == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 1144, __pyx_L3_error)
    __pyx_v_y_lim_max = __Pyx_PyInt_As_int(values[6]); if (unlikely((__pyx_v_y_lim_max == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 1144, __pyx_L3_error)
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  __Pyx_RaiseArgtupleInvalid("get_box_coords", 1, 7, 7, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 1142, __pyx_L3_error)
  __pyx_L3_error:;
  __Pyx_AddTraceback("orb.cutils.get_box_coords", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __Pyx_RefNannyFinishContext();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  __pyx_r = __pyx_pf_3orb_6cutils_54get_box_coords(__pyx_self, __pyx_v_ix, __pyx_v_iy, __pyx_v_box_size, __pyx_v_x_lim_min, __pyx_v_x_lim_max, __pyx_v_y_lim_min, __pyx_v_y_lim_max);

  /* function exit code */
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_54get_box_coords(CYTHON_UNUSED PyObject *__pyx_self, int __pyx_v_ix, int __pyx_v_iy, int __pyx_v_box_size, int __pyx_v_x_lim_min, int __pyx_v_x_lim_max, int __pyx_v_y_lim_min, int __pyx_v_y_lim_max) {
  int __pyx_v_x_min;
  int __pyx_v_x_max;
  int __pyx_v_y_min;
  int __pyx_v_y_max;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  int __pyx_t_1;
  PyObject *__pyx_t_2 = NULL;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  PyObject *__pyx_t_5 = NULL;
  PyObject *__pyx_t_6 = NULL;
  __Pyx_RefNannySetupContext("get_box_coords", 0);

  /* "orb/cutils.pyx":1164
 *     cdef int x_min, x_max, y_min, y_max
 * 
 *     x_min = <int> (ix - <int> (box_size/2.))             # <<<<<<<<<<<<<<
 *     x_max = <int> (ix + <int> (box_size/2.)) + 1
 *     y_min = <int> (iy - <int> (box_size/2.))
 */
  __pyx_v_x_min = ((int)(__pyx_v_ix - ((int)(__pyx_v_box_size / 2.))));

  /* "orb/cutils.pyx":1165
 * 
 *     x_min = <int> (ix - <int> (box_size/2.))
 *     x_max = <int> (ix + <int> (box_size/2.)) + 1             # <<<<<<<<<<<<<<
 *     y_min = <int> (iy - <int> (box_size/2.))
 *     y_max = <int> (iy + <int> (box_size/2.)) + 1
 */
  __pyx_v_x_max = (((int)(__pyx_v_ix + ((int)(__pyx_v_box_size / 2.)))) + 1);

  /* "orb/cutils.pyx":1166
 *     x_min = <int> (ix - <int> (box_size/2.))
 *     x_max = <int> (ix + <int> (box_size/2.)) + 1
 *     y_min = <int> (iy - <int> (box_size/2.))             # <<<<<<<<<<<<<<
 *     y_max = <int> (iy + <int> (box_size/2.)) + 1
 *     if x_min < x_lim_min: x_min = x_lim_min
 */
  __pyx_v_y_min = ((int)(__pyx_v_iy - ((int)(__pyx_v_box_size / 2.))));

  /* "orb/cutils.pyx":1167
 *     x_max = <int> (ix + <int> (box_size/2.)) + 1
 *     y_min = <int> (iy - <int> (box_size/2.))
 *     y_max = <int> (iy + <int> (box_size/2.)) + 1             # <<<<<<<<<<<<<<
 *     if x_min < x_lim_min: x_min = x_lim_min
 *     if y_min < y_lim_min: y_min = y_lim_min
 */
  __pyx_v_y_max = (((int)(__pyx_v_iy + ((int)(__pyx_v_box_size / 2.)))) + 1);

  /* "orb/cutils.pyx":1168
 *     y_min = <int> (iy - <int> (box_size/2.))
 *     y_max = <int> (iy + <int> (box_size/2.)) + 1
 *     if x_min < x_lim_min: x_min = x_lim_min             # <<<<<<<<<<<<<<
 *     if y_min < y_lim_min: y_min = y_lim_min
 *     if x_max >= x_lim_max: x_max = x_lim_max
 */
  __pyx_t_1 = ((__pyx_v_x_min < __pyx_v_x_lim_min) != 0);
  if (__pyx_t_1) {
    __pyx_v_x_min = __pyx_v_x_lim_min;
  }

  /* "orb/cutils.pyx":1169
 *     y_max = <int> (iy + <int> (box_size/2.)) + 1
 *     if x_min < x_lim_min: x_min = x_lim_min
 *     if y_min < y_lim_min: y_min = y_lim_min             # <<<<<<<<<<<<<<
 *     if x_max >= x_lim_max: x_max = x_lim_max
 *     if y_max >= y_lim_max: y_max = y_lim_max
 */
  __pyx_t_1 = ((__pyx_v_y_min < __pyx_v_y_lim_min) != 0);
  if (__pyx_t_1) {
    __pyx_v_y_min = __pyx_v_y_lim_min;
  }

  /* "orb/cutils.pyx":1170
 *     if x_min < x_lim_min: x_min = x_lim_min
 *     if y_min < y_lim_min: y_min = y_lim_min
 *     if x_max >= x_lim_max: x_max = x_lim_max             # <<<<<<<<<<<<<<
 *     if y_max >= y_lim_max: y_max = y_lim_max
 *     if x_max - x_min < 1:
 */
  __pyx_t_1 = ((__pyx_v_x_max >= __pyx_v_x_lim_max) != 0);
  if (__pyx_t_1) {
    __pyx_v_x_max = __pyx_v_x_lim_max;
  }

  /* "orb/cutils.pyx":1171
 *     if y_min < y_lim_min: y_min = y_lim_min
 *     if x_max >= x_lim_max: x_max = x_lim_max
 *     if y_max >= y_lim_max: y_max = y_lim_max             # <<<<<<<<<<<<<<
 *     if x_max - x_min < 1:
 *         x_max = x_min + 1
 */
  __pyx_t_1 = ((__pyx_v_y_max >= __pyx_v_y_lim_max) != 0);
  if (__pyx_t_1) {
    __pyx_v_y_max = __pyx_v_y_lim_max;
  }

  /* "orb/cutils.pyx":1172
 *     if x_max >= x_lim_max: x_max = x_lim_max
 *     if y_max >= y_lim_max: y_max = y_lim_max
 *     if x_max - x_min < 1:             # <<<<<<<<<<<<<<
 *         x_max = x_min + 1
 *     if y_max - y_min < 1:
 */
  __pyx_t_1 = (((__pyx_v_x_max - __pyx_v_x_min) < 1) != 0);
  if (__pyx_t_1) {

    /* "orb/cutils.pyx":1173
 *     if y_max >= y_lim_max: y_max = y_lim_max
 *     if x_max - x_min < 1:
 *         x_max = x_min + 1             # <<<<<<<<<<<<<<
 *     if y_max - y_min < 1:
 *         y_max = y_min + 1
 */
    __pyx_v_x_max = (__pyx_v_x_min + 1);

    /* "orb/cutils.pyx":1172
 *     if x_max >= x_lim_max: x_max = x_lim_max
 *     if y_max >= y_lim_max: y_max = y_lim_max
 *     if x_max - x_min < 1:             # <<<<<<<<<<<<<<
 *         x_max = x_min + 1
 *     if y_max - y_min < 1:
 */
  }

  /* "orb/cutils.pyx":1174
 *     if x_max - x_min < 1:
 *         x_max = x_min + 1
 *     if y_max - y_min < 1:             # <<<<<<<<<<<<<<
 *         y_max = y_min + 1
 * 
 */
  __pyx_t_1 = (((__pyx_v_y_max - __pyx_v_y_min) < 1) != 0);
  if (__pyx_t_1) {

    /* "orb/cutils.pyx":1175
 *         x_max = x_min + 1
 *     if y_max - y_min < 1:
 *         y_max = y_min + 1             # <<<<<<<<<<<<<<
 * 
 *     return x_min, x_max, y_min, y_max
 */
    __pyx_v_y_max = (__pyx_v_y_min + 1);

    /* "orb/cutils.pyx":1174
 *     if x_max - x_min < 1:
 *         x_max = x_min + 1
 *     if y_max - y_min < 1:             # <<<<<<<<<<<<<<
 *         y_max = y_min + 1
 * 
 */
  }

  /* "orb/cutils.pyx":1177
 *         y_max = y_min + 1
 * 
 *     return x_min, x_max, y_min, y_max             # <<<<<<<<<<<<<<
 * 
 * 
 */
  __Pyx_XDECREF(__pyx_r);
  __pyx_t_2 = __Pyx_PyInt_From_int(__pyx_v_x_min); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1177, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_3 = __Pyx_PyInt_From_int(__pyx_v_x_max); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1177, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_4 = __Pyx_PyInt_From_int(__pyx_v_y_min); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1177, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_5 = __Pyx_PyInt_From_int(__pyx_v_y_max); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1177, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_6 = PyTuple_New(4); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1177, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __Pyx_GIVEREF(__pyx_t_2);
  PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_2);
  __Pyx_GIVEREF(__pyx_t_3);
  PyTuple_SET_ITEM(__pyx_t_6, 1, __pyx_t_3);
  __Pyx_GIVEREF(__pyx_t_4);
  PyTuple_SET_ITEM(__pyx_t_6, 2, __pyx_t_4);
  __Pyx_GIVEREF(__pyx_t_5);
  PyTuple_SET_ITEM(__pyx_t_6, 3, __pyx_t_5);
  __pyx_t_2 = 0;
  __pyx_t_3 = 0;
  __pyx_t_4 = 0;
  __pyx_t_5 = 0;
  __pyx_r = __pyx_t_6;
  __pyx_t_6 = 0;
  goto __pyx_L0;

  /* "orb/cutils.pyx":1142
 * 
 * 
 * def get_box_coords(int ix, int iy, int box_size,             # <<<<<<<<<<<<<<
 *                    int x_lim_min, int x_lim_max,
 *                    int y_lim_min, int y_lim_max):
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_XDECREF(__pyx_t_5);
  __Pyx_XDECREF(__pyx_t_6);
  __Pyx_AddTraceback("orb.cutils.get_box_coords", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":1180
 * 
 * 
 * def point_inside_polygon(double x, double y, list poly):             # <<<<<<<<<<<<<<
 *     """ Determine if a point is inside a given polygon or not
 *     Polygon is a list of (x,y) pairs.
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_57point_inside_polygon(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_3orb_6cutils_56point_inside_polygon[] = "point_inside_polygon(double x, double y, list poly)\n Determine if a point is inside a given polygon or not\n    Polygon is a list of (x,y) pairs.\n\n    This function has been taken from\n    http://www.ariel.com.au/a/python-point-int-poly.html and cythonized.\n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_57point_inside_polygon = {"point_inside_polygon", (PyCFunction)__pyx_pw_3orb_6cutils_57point_inside_polygon, METH_VARARGS|METH_KEYWORDS, __pyx_doc_3orb_6cutils_56point_inside_polygon};
static PyObject *__pyx_pw_3orb_6cutils_57point_inside_polygon(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  double __pyx_v_x;
  double __pyx_v_y;
  PyObject *__pyx_v_poly = 0;
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("point_inside_polygon (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_x,&__pyx_n_s_y,&__pyx_n_s_poly,0};
    PyObject* values[3] = {0,0,0};
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
      switch (pos_args) {
        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = PyDict_Size(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_x)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        case  1:
        if (likely((values[1] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_y)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("point_inside_polygon", 1, 3, 3, 1); __PYX_ERR(0, 1180, __pyx_L3_error)
        }
        case  2:
        if (likely((values[2] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_poly)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("point_inside_polygon", 1, 3, 3, 2); __PYX_ERR(0, 1180, __pyx_L3_error)
        }
      }
      if (unlikely(kw_args > 0)) {
        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "point_inside_polygon") < 0)) __PYX_ERR(0, 1180, __pyx_L3_error)
      }
    } else if (PyTuple_GET_SIZE(__pyx_args) != 3) {
      goto __pyx_L5_argtuple_error;
    } else {
      values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
      values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
      values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
    }
    __pyx_v_x = __pyx_PyFloat_AsDouble(values[0]); if (unlikely((__pyx_v_x == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 1180, __pyx_L3_error)
    __pyx_v_y = __pyx_PyFloat_AsDouble(values[1]); if (unlikely((__pyx_v_y == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 1180, __pyx_L3_error)
    __pyx_v_poly = ((PyObject*)values[2]);
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  __Pyx_RaiseArgtupleInvalid("point_inside_polygon", 1, 3, 3, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 1180, __pyx_L3_error)
  __pyx_L3_error:;
  __Pyx_AddTraceback("orb.cutils.point_inside_polygon", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __Pyx_RefNannyFinishContext();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_poly), (&PyList_Type), 1, "poly", 1))) __PYX_ERR(0, 1180, __pyx_L1_error)
  __pyx_r = __pyx_pf_3orb_6cutils_56point_inside_polygon(__pyx_self, __pyx_v_x, __pyx_v_y, __pyx_v_poly);

  /* function exit code */
  goto __pyx_L0;
  __pyx_L1_error:;
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_56point_inside_polygon(CYTHON_UNUSED PyObject *__pyx_self, double __pyx_v_x, double __pyx_v_y, PyObject *__pyx_v_poly) {
  int __pyx_v_n;
  PyBoolObject *__pyx_v_inside = 0;
  int __pyx_v_i;
  double __pyx_v_p1x;
  double __pyx_v_p1y;
  double __pyx_v_p2x;
  double __pyx_v_p2y;
  double __pyx_v_xinters;
  CYTHON_UNUSED PyObject *__pyx_v_plx = NULL;
  CYTHON_UNUSED PyObject *__pyx_v_ply = NULL;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  Py_ssize_t __pyx_t_1;
  PyObject *__pyx_t_2 = NULL;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  PyObject *__pyx_t_5 = NULL;
  PyObject *(*__pyx_t_6)(PyObject *);
  long __pyx_t_7;
  int __pyx_t_8;
  int __pyx_t_9;
  double __pyx_t_10;
  double __pyx_t_11;
  double __pyx_t_12;
  int __pyx_t_13;
  int __pyx_t_14;
  __Pyx_RefNannySetupContext("point_inside_polygon", 0);

  /* "orb/cutils.pyx":1187
 *     http://www.ariel.com.au/a/python-point-int-poly.html and cythonized.
 *     """
 *     cdef int n = len(poly)             # <<<<<<<<<<<<<<
 *     cdef bool inside = False
 *     cdef int i
 */
  if (unlikely(__pyx_v_poly == Py_None)) {
    PyErr_SetString(PyExc_TypeError, "object of type 'NoneType' has no len()");
    __PYX_ERR(0, 1187, __pyx_L1_error)
  }
  __pyx_t_1 = PyList_GET_SIZE(__pyx_v_poly); if (unlikely(__pyx_t_1 == -1)) __PYX_ERR(0, 1187, __pyx_L1_error)
  __pyx_v_n = __pyx_t_1;

  /* "orb/cutils.pyx":1188
 *     """
 *     cdef int n = len(poly)
 *     cdef bool inside = False             # <<<<<<<<<<<<<<
 *     cdef int i
 *     cdef double p1x, p1y, p2x, p2y
 */
  __Pyx_INCREF(Py_False);
  __pyx_v_inside = ((PyBoolObject *)Py_False);

  /* "orb/cutils.pyx":1193
 *     cdef double xinters
 * 
 *     plx, ply = poly[0]             # <<<<<<<<<<<<<<
 * 
 *     for i in range(n+1):
 */
  if (unlikely(__pyx_v_poly == Py_None)) {
    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
    __PYX_ERR(0, 1193, __pyx_L1_error)
  }
  __pyx_t_2 = __Pyx_GetItemInt_List(__pyx_v_poly, 0, long, 1, __Pyx_PyInt_From_long, 1, 0, 1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1193, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  if ((likely(PyTuple_CheckExact(__pyx_t_2))) || (PyList_CheckExact(__pyx_t_2))) {
    PyObject* sequence = __pyx_t_2;
    #if CYTHON_COMPILING_IN_CPYTHON
    Py_ssize_t size = Py_SIZE(sequence);
    #else
    Py_ssize_t size = PySequence_Size(sequence);
    #endif
    if (unlikely(size != 2)) {
      if (size > 2) __Pyx_RaiseTooManyValuesError(2);
      else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
      __PYX_ERR(0, 1193, __pyx_L1_error)
    }
    #if CYTHON_COMPILING_IN_CPYTHON
    if (likely(PyTuple_CheckExact(sequence))) {
      __pyx_t_3 = PyTuple_GET_ITEM(sequence, 0); 
      __pyx_t_4 = PyTuple_GET_ITEM(sequence, 1); 
    } else {
      __pyx_t_3 = PyList_GET_ITEM(sequence, 0); 
      __pyx_t_4 = PyList_GET_ITEM(sequence, 1); 
    }
    __Pyx_INCREF(__pyx_t_3);
    __Pyx_INCREF(__pyx_t_4);
    #else
    __pyx_t_3 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1193, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __pyx_t_4 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1193, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    #endif
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  } else {
    Py_ssize_t index = -1;
    __pyx_t_5 = PyObject_GetIter(__pyx_t_2); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1193, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __pyx_t_6 = Py_TYPE(__pyx_t_5)->tp_iternext;
    index = 0; __pyx_t_3 = __pyx_t_6(__pyx_t_5); if (unlikely(!__pyx_t_3)) goto __pyx_L3_unpacking_failed;
    __Pyx_GOTREF(__pyx_t_3);
    index = 1; __pyx_t_4 = __pyx_t_6(__pyx_t_5); if (unlikely(!__pyx_t_4)) goto __pyx_L3_unpacking_failed;
    __Pyx_GOTREF(__pyx_t_4);
    if (__Pyx_IternextUnpackEndCheck(__pyx_t_6(__pyx_t_5), 2) < 0) __PYX_ERR(0, 1193, __pyx_L1_error)
    __pyx_t_6 = NULL;
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    goto __pyx_L4_unpacking_done;
    __pyx_L3_unpacking_failed:;
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    __pyx_t_6 = NULL;
    if (__Pyx_IterFinish() == 0) __Pyx_RaiseNeedMoreValuesError(index);
    __PYX_ERR(0, 1193, __pyx_L1_error)
    __pyx_L4_unpacking_done:;
  }
  __pyx_v_plx = __pyx_t_3;
  __pyx_t_3 = 0;
  __pyx_v_ply = __pyx_t_4;
  __pyx_t_4 = 0;

  /* "orb/cutils.pyx":1195
 *     plx, ply = poly[0]
 * 
 *     for i in range(n+1):             # <<<<<<<<<<<<<<
 *         p2x,p2y = poly[i % n]
 *         if y > min(p1y,p2y):
 */
  __pyx_t_7 = (__pyx_v_n + 1);
  for (__pyx_t_8 = 0; __pyx_t_8 < __pyx_t_7; __pyx_t_8+=1) {
    __pyx_v_i = __pyx_t_8;

    /* "orb/cutils.pyx":1196
 * 
 *     for i in range(n+1):
 *         p2x,p2y = poly[i % n]             # <<<<<<<<<<<<<<
 *         if y > min(p1y,p2y):
 *             if y <= max(p1y,p2y):
 */
    if (unlikely(__pyx_v_poly == Py_None)) {
      PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
      __PYX_ERR(0, 1196, __pyx_L1_error)
    }
    if (unlikely(__pyx_v_n == 0)) {
      PyErr_SetString(PyExc_ZeroDivisionError, "integer division or modulo by zero");
      __PYX_ERR(0, 1196, __pyx_L1_error)
    }
    __pyx_t_9 = __Pyx_mod_int(__pyx_v_i, __pyx_v_n);
    __pyx_t_2 = __Pyx_GetItemInt_List(__pyx_v_poly, __pyx_t_9, int, 1, __Pyx_PyInt_From_int, 1, 1, 1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1196, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    if ((likely(PyTuple_CheckExact(__pyx_t_2))) || (PyList_CheckExact(__pyx_t_2))) {
      PyObject* sequence = __pyx_t_2;
      #if CYTHON_COMPILING_IN_CPYTHON
      Py_ssize_t size = Py_SIZE(sequence);
      #else
      Py_ssize_t size = PySequence_Size(sequence);
      #endif
      if (unlikely(size != 2)) {
        if (size > 2) __Pyx_RaiseTooManyValuesError(2);
        else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
        __PYX_ERR(0, 1196, __pyx_L1_error)
      }
      #if CYTHON_COMPILING_IN_CPYTHON
      if (likely(PyTuple_CheckExact(sequence))) {
        __pyx_t_4 = PyTuple_GET_ITEM(sequence, 0); 
        __pyx_t_3 = PyTuple_GET_ITEM(sequence, 1); 
      } else {
        __pyx_t_4 = PyList_GET_ITEM(sequence, 0); 
        __pyx_t_3 = PyList_GET_ITEM(sequence, 1); 
      }
      __Pyx_INCREF(__pyx_t_4);
      __Pyx_INCREF(__pyx_t_3);
      #else
      __pyx_t_4 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1196, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __pyx_t_3 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1196, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      #endif
      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    } else {
      Py_ssize_t index = -1;
      __pyx_t_5 = PyObject_GetIter(__pyx_t_2); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1196, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
      __pyx_t_6 = Py_TYPE(__pyx_t_5)->tp_iternext;
      index = 0; __pyx_t_4 = __pyx_t_6(__pyx_t_5); if (unlikely(!__pyx_t_4)) goto __pyx_L7_unpacking_failed;
      __Pyx_GOTREF(__pyx_t_4);
      index = 1; __pyx_t_3 = __pyx_t_6(__pyx_t_5); if (unlikely(!__pyx_t_3)) goto __pyx_L7_unpacking_failed;
      __Pyx_GOTREF(__pyx_t_3);
      if (__Pyx_IternextUnpackEndCheck(__pyx_t_6(__pyx_t_5), 2) < 0) __PYX_ERR(0, 1196, __pyx_L1_error)
      __pyx_t_6 = NULL;
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
      goto __pyx_L8_unpacking_done;
      __pyx_L7_unpacking_failed:;
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
      __pyx_t_6 = NULL;
      if (__Pyx_IterFinish() == 0) __Pyx_RaiseNeedMoreValuesError(index);
      __PYX_ERR(0, 1196, __pyx_L1_error)
      __pyx_L8_unpacking_done:;
    }
    __pyx_t_10 = __pyx_PyFloat_AsDouble(__pyx_t_4); if (unlikely((__pyx_t_10 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 1196, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_t_11 = __pyx_PyFloat_AsDouble(__pyx_t_3); if (unlikely((__pyx_t_11 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 1196, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __pyx_v_p2x = __pyx_t_10;
    __pyx_v_p2y = __pyx_t_11;

    /* "orb/cutils.pyx":1197
 *     for i in range(n+1):
 *         p2x,p2y = poly[i % n]
 *         if y > min(p1y,p2y):             # <<<<<<<<<<<<<<
 *             if y <= max(p1y,p2y):
 *                 if x <= max(p1x,p2x):
 */
    __pyx_t_11 = __pyx_v_p2y;
    __pyx_t_10 = __pyx_v_p1y;
    if (((__pyx_t_11 < __pyx_t_10) != 0)) {
      __pyx_t_12 = __pyx_t_11;
    } else {
      __pyx_t_12 = __pyx_t_10;
    }
    __pyx_t_13 = ((__pyx_v_y > __pyx_t_12) != 0);
    if (__pyx_t_13) {

      /* "orb/cutils.pyx":1198
 *         p2x,p2y = poly[i % n]
 *         if y > min(p1y,p2y):
 *             if y <= max(p1y,p2y):             # <<<<<<<<<<<<<<
 *                 if x <= max(p1x,p2x):
 *                     if p1y != p2y:
 */
      __pyx_t_12 = __pyx_v_p2y;
      __pyx_t_11 = __pyx_v_p1y;
      if (((__pyx_t_12 > __pyx_t_11) != 0)) {
        __pyx_t_10 = __pyx_t_12;
      } else {
        __pyx_t_10 = __pyx_t_11;
      }
      __pyx_t_13 = ((__pyx_v_y <= __pyx_t_10) != 0);
      if (__pyx_t_13) {

        /* "orb/cutils.pyx":1199
 *         if y > min(p1y,p2y):
 *             if y <= max(p1y,p2y):
 *                 if x <= max(p1x,p2x):             # <<<<<<<<<<<<<<
 *                     if p1y != p2y:
 *                         xinters = (y-p1y)*(p2x-p1x)/(p2y-p1y)+p1x
 */
        __pyx_t_10 = __pyx_v_p2x;
        __pyx_t_12 = __pyx_v_p1x;
        if (((__pyx_t_10 > __pyx_t_12) != 0)) {
          __pyx_t_11 = __pyx_t_10;
        } else {
          __pyx_t_11 = __pyx_t_12;
        }
        __pyx_t_13 = ((__pyx_v_x <= __pyx_t_11) != 0);
        if (__pyx_t_13) {

          /* "orb/cutils.pyx":1200
 *             if y <= max(p1y,p2y):
 *                 if x <= max(p1x,p2x):
 *                     if p1y != p2y:             # <<<<<<<<<<<<<<
 *                         xinters = (y-p1y)*(p2x-p1x)/(p2y-p1y)+p1x
 *                     if p1x == p2x or x <= xinters:
 */
          __pyx_t_13 = ((__pyx_v_p1y != __pyx_v_p2y) != 0);
          if (__pyx_t_13) {

            /* "orb/cutils.pyx":1201
 *                 if x <= max(p1x,p2x):
 *                     if p1y != p2y:
 *                         xinters = (y-p1y)*(p2x-p1x)/(p2y-p1y)+p1x             # <<<<<<<<<<<<<<
 *                     if p1x == p2x or x <= xinters:
 *                         inside = not inside
 */
            __pyx_t_11 = ((__pyx_v_y - __pyx_v_p1y) * (__pyx_v_p2x - __pyx_v_p1x));
            __pyx_t_10 = (__pyx_v_p2y - __pyx_v_p1y);
            if (unlikely(__pyx_t_10 == 0)) {
              PyErr_SetString(PyExc_ZeroDivisionError, "float division");
              __PYX_ERR(0, 1201, __pyx_L1_error)
            }
            __pyx_v_xinters = ((__pyx_t_11 / __pyx_t_10) + __pyx_v_p1x);

            /* "orb/cutils.pyx":1200
 *             if y <= max(p1y,p2y):
 *                 if x <= max(p1x,p2x):
 *                     if p1y != p2y:             # <<<<<<<<<<<<<<
 *                         xinters = (y-p1y)*(p2x-p1x)/(p2y-p1y)+p1x
 *                     if p1x == p2x or x <= xinters:
 */
          }

          /* "orb/cutils.pyx":1202
 *                     if p1y != p2y:
 *                         xinters = (y-p1y)*(p2x-p1x)/(p2y-p1y)+p1x
 *                     if p1x == p2x or x <= xinters:             # <<<<<<<<<<<<<<
 *                         inside = not inside
 *         p1x,p1y = p2x,p2y
 */
          __pyx_t_14 = ((__pyx_v_p1x == __pyx_v_p2x) != 0);
          if (!__pyx_t_14) {
          } else {
            __pyx_t_13 = __pyx_t_14;
            goto __pyx_L14_bool_binop_done;
          }
          __pyx_t_14 = ((__pyx_v_x <= __pyx_v_xinters) != 0);
          __pyx_t_13 = __pyx_t_14;
          __pyx_L14_bool_binop_done:;
          if (__pyx_t_13) {

            /* "orb/cutils.pyx":1203
 *                         xinters = (y-p1y)*(p2x-p1x)/(p2y-p1y)+p1x
 *                     if p1x == p2x or x <= xinters:
 *                         inside = not inside             # <<<<<<<<<<<<<<
 *         p1x,p1y = p2x,p2y
 * 
 */
            __pyx_t_13 = __Pyx_PyObject_IsTrue(((PyObject *)__pyx_v_inside)); if (unlikely(__pyx_t_13 < 0)) __PYX_ERR(0, 1203, __pyx_L1_error)
            __pyx_t_2 = __Pyx_PyBool_FromLong((!__pyx_t_13)); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1203, __pyx_L1_error)
            __Pyx_GOTREF(__pyx_t_2);
            if (!(likely(__Pyx_TypeTest(__pyx_t_2, __pyx_ptype_7cpython_4bool_bool)))) __PYX_ERR(0, 1203, __pyx_L1_error)
            __Pyx_DECREF_SET(__pyx_v_inside, ((PyBoolObject *)__pyx_t_2));
            __pyx_t_2 = 0;

            /* "orb/cutils.pyx":1202
 *                     if p1y != p2y:
 *                         xinters = (y-p1y)*(p2x-p1x)/(p2y-p1y)+p1x
 *                     if p1x == p2x or x <= xinters:             # <<<<<<<<<<<<<<
 *                         inside = not inside
 *         p1x,p1y = p2x,p2y
 */
          }

          /* "orb/cutils.pyx":1199
 *         if y > min(p1y,p2y):
 *             if y <= max(p1y,p2y):
 *                 if x <= max(p1x,p2x):             # <<<<<<<<<<<<<<
 *                     if p1y != p2y:
 *                         xinters = (y-p1y)*(p2x-p1x)/(p2y-p1y)+p1x
 */
        }

        /* "orb/cutils.pyx":1198
 *         p2x,p2y = poly[i % n]
 *         if y > min(p1y,p2y):
 *             if y <= max(p1y,p2y):             # <<<<<<<<<<<<<<
 *                 if x <= max(p1x,p2x):
 *                     if p1y != p2y:
 */
      }

      /* "orb/cutils.pyx":1197
 *     for i in range(n+1):
 *         p2x,p2y = poly[i % n]
 *         if y > min(p1y,p2y):             # <<<<<<<<<<<<<<
 *             if y <= max(p1y,p2y):
 *                 if x <= max(p1x,p2x):
 */
    }

    /* "orb/cutils.pyx":1204
 *                     if p1x == p2x or x <= xinters:
 *                         inside = not inside
 *         p1x,p1y = p2x,p2y             # <<<<<<<<<<<<<<
 * 
 *     return inside
 */
    __pyx_t_10 = __pyx_v_p2x;
    __pyx_t_11 = __pyx_v_p2y;
    __pyx_v_p1x = __pyx_t_10;
    __pyx_v_p1y = __pyx_t_11;
  }

  /* "orb/cutils.pyx":1206
 *         p1x,p1y = p2x,p2y
 * 
 *     return inside             # <<<<<<<<<<<<<<
 * 
 * def multi_fit_stars(np.ndarray[np.float64_t, ndim=2] frame,
 */
  __Pyx_XDECREF(__pyx_r);
  __Pyx_INCREF(((PyObject *)__pyx_v_inside));
  __pyx_r = ((PyObject *)__pyx_v_inside);
  goto __pyx_L0;

  /* "orb/cutils.pyx":1180
 * 
 * 
 * def point_inside_polygon(double x, double y, list poly):             # <<<<<<<<<<<<<<
 *     """ Determine if a point is inside a given polygon or not
 *     Polygon is a list of (x,y) pairs.
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_XDECREF(__pyx_t_5);
  __Pyx_AddTraceback("orb.cutils.point_inside_polygon", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_XDECREF((PyObject *)__pyx_v_inside);
  __Pyx_XDECREF(__pyx_v_plx);
  __Pyx_XDECREF(__pyx_v_ply);
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":1208
 *     return inside
 * 
 * def multi_fit_stars(np.ndarray[np.float64_t, ndim=2] frame,             # <<<<<<<<<<<<<<
 *                     np.ndarray[np.float64_t, ndim=2] pos,
 *                     int box_size,
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_59multi_fit_stars(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_3orb_6cutils_58multi_fit_stars[] = "multi_fit_stars(ndarray frame, ndarray pos, int box_size, double height_guess=np.nan, ndarray fwhm_guess=<\077\077?>, bool cov_height=False, bool cov_pos=True, bool cov_fwhm=True, bool fix_height=False, bool fix_pos=False, bool fix_fwhm=False, double fit_tol=0.001, double ron=np.nan, double dcl=np.nan, bool enable_zoom=False, bool enable_rotation=False, bool estimate_local_noise=True, double saturation=0, sip=None)\nFit multiple stars at the same time.\n\n    Useful if the relative positions of the stars are well known. In\n    this case the pattern of position can be shifted, zoomed and\n    rotated in order to be adjusted to the stars in the frame.\n\n    Other covarying parameters can be the height and the FWHM.\n\n    :param frame: Frame\n    \n    :param pos: array of stars positions of shape [[x1, y1], [x2, y2] ...]\n    \n    :param box_size: Size of the box around a single star\n    \n    :param height_guess: (Optional) Initial guess on the height\n      parameter (default NaN).\n      \n    :param fwhm_guess: (Optional) Initial guess on the FWHM parameter\n      must a numpy.ndarray.\n\n    :param cov_height: (Optional) If True, height is considered to be\n      the same for all the stars. It is then a covarying parameter\n      (default False).\n\n    :param cov_pos: (Optional) If True, shift along x and y is\n      considered as the same for all the stars. dx and dy are thus 2\n      covarying parameters (default True).\n\n    :param cov_fwhm: (Optional) If True, FWHM is considered to be the\n      same for all the stars. It is then a covarying parameter\n      (default True).\n\n    :param fix_height: (Optional) If True, height is fixed to its\n      guess (default False).\n\n    :param fix_pos: (Optional) If True, x and y are fixed to the position\n      guess given by pos (default False).\n\n    :param fix_fwhm: (Optional) If True, FWHM is fixed to its guess\n      (default False).\n\n    :param fit_tol: (Optional) Tolerance on the fit (default 1e-3).""\n      \n    :param ron: (Optional) Readout noise. If given and if\n      estimate_local_noise is set to False the readout noise is fixed\n      to the given value. If not given the ron is guessed from the\n      background around the stars (default NaN).\n\n    :param dcl: (Optional) Dark current level. If given and if\n      estimate_local_noise is set to False the dark current level is\n      fixed to the given value. If not given the dark current level is\n      fixed to 0. (default NaN)\n\n    :param enable_zoom: (Optional) If True the position pattern can be\n      zoomed (default False).\n\n    :param enable_rotation: (Optional) If True the position pattern\n      can be rotated (default False).\n\n    :param estimate_local_noise: (Optional) If True, the level of\n      noise is computed from the background pixels around the\n      stars. ron and dcl parameters are thus not used (default True).\n\n    :param saturation: (Optional) If not 0, all pixels above the\n      saturation level are removed from the fit (default 0).\n\n    :param sip: (Optional) A pywcs.WCS instance containing SIP\n      distorsion correction (default None).\n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_59multi_fit_stars = {"multi_fit_stars", (PyCFunction)__pyx_pw_3orb_6cutils_59multi_fit_stars, METH_VARARGS|METH_KEYWORDS, __pyx_doc_3orb_6cutils_58multi_fit_stars};
static PyObject *__pyx_pw_3orb_6cutils_59multi_fit_stars(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  PyArrayObject *__pyx_v_frame = 0;
  PyArrayObject *__pyx_v_pos = 0;
  int __pyx_v_box_size;
  double __pyx_v_height_guess;
  PyArrayObject *__pyx_v_fwhm_guess = 0;
  PyBoolObject *__pyx_v_cov_height = 0;
  PyBoolObject *__pyx_v_cov_pos = 0;
  PyBoolObject *__pyx_v_cov_fwhm = 0;
  PyBoolObject *__pyx_v_fix_height = 0;
  PyBoolObject *__pyx_v_fix_pos = 0;
  PyBoolObject *__pyx_v_fix_fwhm = 0;
  double __pyx_v_fit_tol;
  double __pyx_v_ron;
  double __pyx_v_dcl;
  PyBoolObject *__pyx_v_enable_zoom = 0;
  PyBoolObject *__pyx_v_enable_rotation = 0;
  PyBoolObject *__pyx_v_estimate_local_noise = 0;
  double __pyx_v_saturation;
  PyObject *__pyx_v_sip = 0;
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("multi_fit_stars (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_frame,&__pyx_n_s_pos,&__pyx_n_s_box_size,&__pyx_n_s_height_guess,&__pyx_n_s_fwhm_guess,&__pyx_n_s_cov_height,&__pyx_n_s_cov_pos,&__pyx_n_s_cov_fwhm,&__pyx_n_s_fix_height,&__pyx_n_s_fix_pos,&__pyx_n_s_fix_fwhm,&__pyx_n_s_fit_tol,&__pyx_n_s_ron,&__pyx_n_s_dcl,&__pyx_n_s_enable_zoom,&__pyx_n_s_enable_rotation,&__pyx_n_s_estimate_local_noise,&__pyx_n_s_saturation,&__pyx_n_s_sip,0};
    PyObject* values[19] = {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};
    values[4] = (PyObject *)__pyx_k__56;

    /* "orb/cutils.pyx":1214
 *                     np.ndarray[np.float64_t, ndim=1] fwhm_guess=np.array(
 *                         [np.nan], dtype=float),
 *                     bool cov_height=False,             # <<<<<<<<<<<<<<
 *                     bool cov_pos=True,
 *                     bool cov_fwhm=True,
 */
    values[5] = (PyObject *)((PyBoolObject *)Py_False);

    /* "orb/cutils.pyx":1215
 *                         [np.nan], dtype=float),
 *                     bool cov_height=False,
 *                     bool cov_pos=True,             # <<<<<<<<<<<<<<
 *                     bool cov_fwhm=True,
 *                     bool fix_height=False,
 */
    values[6] = (PyObject *)((PyBoolObject *)Py_True);

    /* "orb/cutils.pyx":1216
 *                     bool cov_height=False,
 *                     bool cov_pos=True,
 *                     bool cov_fwhm=True,             # <<<<<<<<<<<<<<
 *                     bool fix_height=False,
 *                     bool fix_pos=False,
 */
    values[7] = (PyObject *)((PyBoolObject *)Py_True);

    /* "orb/cutils.pyx":1217
 *                     bool cov_pos=True,
 *                     bool cov_fwhm=True,
 *                     bool fix_height=False,             # <<<<<<<<<<<<<<
 *                     bool fix_pos=False,
 *                     bool fix_fwhm=False,
 */
    values[8] = (PyObject *)((PyBoolObject *)Py_False);

    /* "orb/cutils.pyx":1218
 *                     bool cov_fwhm=True,
 *                     bool fix_height=False,
 *                     bool fix_pos=False,             # <<<<<<<<<<<<<<
 *                     bool fix_fwhm=False,
 *                     double fit_tol=1e-3,
 */
    values[9] = (PyObject *)((PyBoolObject *)Py_False);

    /* "orb/cutils.pyx":1219
 *                     bool fix_height=False,
 *                     bool fix_pos=False,
 *                     bool fix_fwhm=False,             # <<<<<<<<<<<<<<
 *                     double fit_tol=1e-3,
 *                     double ron=np.nan,
 */
    values[10] = (PyObject *)((PyBoolObject *)Py_False);

    /* "orb/cutils.pyx":1223
 *                     double ron=np.nan,
 *                     double dcl=np.nan,
 *                     bool enable_zoom=False,             # <<<<<<<<<<<<<<
 *                     bool enable_rotation=False,
 *                     bool estimate_local_noise=True,
 */
    values[14] = (PyObject *)((PyBoolObject *)Py_False);

    /* "orb/cutils.pyx":1224
 *                     double dcl=np.nan,
 *                     bool enable_zoom=False,
 *                     bool enable_rotation=False,             # <<<<<<<<<<<<<<
 *                     bool estimate_local_noise=True,
 *                     double saturation=0,
 */
    values[15] = (PyObject *)((PyBoolObject *)Py_False);

    /* "orb/cutils.pyx":1225
 *                     bool enable_zoom=False,
 *                     bool enable_rotation=False,
 *                     bool estimate_local_noise=True,             # <<<<<<<<<<<<<<
 *                     double saturation=0,
 *                     sip=None):
 */
    values[16] = (PyObject *)((PyBoolObject *)Py_True);

    /* "orb/cutils.pyx":1227
 *                     bool estimate_local_noise=True,
 *                     double saturation=0,
 *                     sip=None):             # <<<<<<<<<<<<<<
 *     """Fit multiple stars at the same time.
 * 
 */
    values[18] = ((PyObject *)Py_None);
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
      switch (pos_args) {
        case 19: values[18] = PyTuple_GET_ITEM(__pyx_args, 18);
        case 18: values[17] = PyTuple_GET_ITEM(__pyx_args, 17);
        case 17: values[16] = PyTuple_GET_ITEM(__pyx_args, 16);
        case 16: values[15] = PyTuple_GET_ITEM(__pyx_args, 15);
        case 15: values[14] = PyTuple_GET_ITEM(__pyx_args, 14);
        case 14: values[13] = PyTuple_GET_ITEM(__pyx_args, 13);
        case 13: values[12] = PyTuple_GET_ITEM(__pyx_args, 12);
        case 12: values[11] = PyTuple_GET_ITEM(__pyx_args, 11);
        case 11: values[10] = PyTuple_GET_ITEM(__pyx_args, 10);
        case 10: values[9] = PyTuple_GET_ITEM(__pyx_args, 9);
        case  9: values[8] = PyTuple_GET_ITEM(__pyx_args, 8);
        case  8: values[7] = PyTuple_GET_ITEM(__pyx_args, 7);
        case  7: values[6] = PyTuple_GET_ITEM(__pyx_args, 6);
        case  6: values[5] = PyTuple_GET_ITEM(__pyx_args, 5);
        case  5: values[4] = PyTuple_GET_ITEM(__pyx_args, 4);
        case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = PyDict_Size(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_frame)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        case  1:
        if (likely((values[1] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_pos)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("multi_fit_stars", 0, 3, 19, 1); __PYX_ERR(0, 1208, __pyx_L3_error)
        }
        case  2:
        if (likely((values[2] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_box_size)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("multi_fit_stars", 0, 3, 19, 2); __PYX_ERR(0, 1208, __pyx_L3_error)
        }
        case  3:
        if (kw_args > 0) {
          PyObject* value = PyDict_GetItem(__pyx_kwds, __pyx_n_s_height_guess);
          if (value) { values[3] = value; kw_args--; }
        }
        case  4:
        if (kw_args > 0) {
          PyObject* value = PyDict_GetItem(__pyx_kwds, __pyx_n_s_fwhm_guess);
          if (value) { values[4] = value; kw_args--; }
        }
        case  5:
        if (kw_args > 0) {
          PyObject* value = PyDict_GetItem(__pyx_kwds, __pyx_n_s_cov_height);
          if (value) { values[5] = value; kw_args--; }
        }
        case  6:
        if (kw_args > 0) {
          PyObject* value = PyDict_GetItem(__pyx_kwds, __pyx_n_s_cov_pos);
          if (value) { values[6] = value; kw_args--; }
        }
        case  7:
        if (kw_args > 0) {
          PyObject* value = PyDict_GetItem(__pyx_kwds, __pyx_n_s_cov_fwhm);
          if (value) { values[7] = value; kw_args--; }
        }
        case  8:
        if (kw_args > 0) {
          PyObject* value = PyDict_GetItem(__pyx_kwds, __pyx_n_s_fix_height);
          if (value) { values[8] = value; kw_args--; }
        }
        case  9:
        if (kw_args > 0) {
          PyObject* value = PyDict_GetItem(__pyx_kwds, __pyx_n_s_fix_pos);
          if (value) { values[9] = value; kw_args--; }
        }
        case 10:
        if (kw_args > 0) {
          PyObject* value = PyDict_GetItem(__pyx_kwds, __pyx_n_s_fix_fwhm);
          if (value) { values[10] = value; kw_args--; }
        }
        case 11:
        if (kw_args > 0) {
          PyObject* value = PyDict_GetItem(__pyx_kwds, __pyx_n_s_fit_tol);
          if (value) { values[11] = value; kw_args--; }
        }
        case 12:
        if (kw_args > 0) {
          PyObject* value = PyDict_GetItem(__pyx_kwds, __pyx_n_s_ron);
          if (value) { values[12] = value; kw_args--; }
        }
        case 13:
        if (kw_args > 0) {
          PyObject* value = PyDict_GetItem(__pyx_kwds, __pyx_n_s_dcl);
          if (value) { values[13] = value; kw_args--; }
        }
        case 14:
        if (kw_args > 0) {
          PyObject* value = PyDict_GetItem(__pyx_kwds, __pyx_n_s_enable_zoom);
          if (value) { values[14] = value; kw_args--; }
        }
        case 15:
        if (kw_args > 0) {
          PyObject* value = PyDict_GetItem(__pyx_kwds, __pyx_n_s_enable_rotation);
          if (value) { values[15] = value; kw_args--; }
        }
        case 16:
        if (kw_args > 0) {
          PyObject* value = PyDict_GetItem(__pyx_kwds, __pyx_n_s_estimate_local_noise);
          if (value) { values[16] = value; kw_args--; }
        }
        case 17:
        if (kw_args > 0) {
          PyObject* value = PyDict_GetItem(__pyx_kwds, __pyx_n_s_saturation);
          if (value) { values[17] = value; kw_args--; }
        }
        case 18:
        if (kw_args > 0) {
          PyObject* value = PyDict_GetItem(__pyx_kwds, __pyx_n_s_sip);
          if (value) { values[18] = value; kw_args--; }
        }
      }
      if (unlikely(kw_args > 0)) {
        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "multi_fit_stars") < 0)) __PYX_ERR(0, 1208, __pyx_L3_error)
      }
    } else {
      switch (PyTuple_GET_SIZE(__pyx_args)) {
        case 19: values[18] = PyTuple_GET_ITEM(__pyx_args, 18);
        case 18: values[17] = PyTuple_GET_ITEM(__pyx_args, 17);
        case 17: values[16] = PyTuple_GET_ITEM(__pyx_args, 16);
        case 16: values[15] = PyTuple_GET_ITEM(__pyx_args, 15);
        case 15: values[14] = PyTuple_GET_ITEM(__pyx_args, 14);
        case 14: values[13] = PyTuple_GET_ITEM(__pyx_args, 13);
        case 13: values[12] = PyTuple_GET_ITEM(__pyx_args, 12);
        case 12: values[11] = PyTuple_GET_ITEM(__pyx_args, 11);
        case 11: values[10] = PyTuple_GET_ITEM(__pyx_args, 10);
        case 10: values[9] = PyTuple_GET_ITEM(__pyx_args, 9);
        case  9: values[8] = PyTuple_GET_ITEM(__pyx_args, 8);
        case  8: values[7] = PyTuple_GET_ITEM(__pyx_args, 7);
        case  7: values[6] = PyTuple_GET_ITEM(__pyx_args, 6);
        case  6: values[5] = PyTuple_GET_ITEM(__pyx_args, 5);
        case  5: values[4] = PyTuple_GET_ITEM(__pyx_args, 4);
        case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        break;
        default: goto __pyx_L5_argtuple_error;
      }
    }
    __pyx_v_frame = ((PyArrayObject *)values[0]);
    __pyx_v_pos = ((PyArrayObject *)values[1]);
    __pyx_v_box_size = __Pyx_PyInt_As_int(values[2]); if (unlikely((__pyx_v_box_size == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 1210, __pyx_L3_error)
    if (values[3]) {
      __pyx_v_height_guess = __pyx_PyFloat_AsDouble(values[3]); if (unlikely((__pyx_v_height_guess == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 1211, __pyx_L3_error)
    } else {
      __pyx_v_height_guess = __pyx_k__57;
    }
    __pyx_v_fwhm_guess = ((PyArrayObject *)values[4]);
    __pyx_v_cov_height = ((PyBoolObject *)values[5]);
    __pyx_v_cov_pos = ((PyBoolObject *)values[6]);
    __pyx_v_cov_fwhm = ((PyBoolObject *)values[7]);
    __pyx_v_fix_height = ((PyBoolObject *)values[8]);
    __pyx_v_fix_pos = ((PyBoolObject *)values[9]);
    __pyx_v_fix_fwhm = ((PyBoolObject *)values[10]);
    if (values[11]) {
      __pyx_v_fit_tol = __pyx_PyFloat_AsDouble(values[11]); if (unlikely((__pyx_v_fit_tol == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 1220, __pyx_L3_error)
    } else {
      __pyx_v_fit_tol = ((double)1e-3);
    }
    if (values[12]) {
      __pyx_v_ron = __pyx_PyFloat_AsDouble(values[12]); if (unlikely((__pyx_v_ron == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 1221, __pyx_L3_error)
    } else {
      __pyx_v_ron = __pyx_k__58;
    }
    if (values[13]) {
      __pyx_v_dcl = __pyx_PyFloat_AsDouble(values[13]); if (unlikely((__pyx_v_dcl == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 1222, __pyx_L3_error)
    } else {
      __pyx_v_dcl = __pyx_k__59;
    }
    __pyx_v_enable_zoom = ((PyBoolObject *)values[14]);
    __pyx_v_enable_rotation = ((PyBoolObject *)values[15]);
    __pyx_v_estimate_local_noise = ((PyBoolObject *)values[16]);
    if (values[17]) {
      __pyx_v_saturation = __pyx_PyFloat_AsDouble(values[17]); if (unlikely((__pyx_v_saturation == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 1226, __pyx_L3_error)
    } else {
      __pyx_v_saturation = ((double)0.0);
    }
    __pyx_v_sip = values[18];
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  __Pyx_RaiseArgtupleInvalid("multi_fit_stars", 0, 3, 19, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 1208, __pyx_L3_error)
  __pyx_L3_error:;
  __Pyx_AddTraceback("orb.cutils.multi_fit_stars", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __Pyx_RefNannyFinishContext();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_frame), __pyx_ptype_5numpy_ndarray, 1, "frame", 0))) __PYX_ERR(0, 1208, __pyx_L1_error)
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_pos), __pyx_ptype_5numpy_ndarray, 1, "pos", 0))) __PYX_ERR(0, 1209, __pyx_L1_error)
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_fwhm_guess), __pyx_ptype_5numpy_ndarray, 1, "fwhm_guess", 0))) __PYX_ERR(0, 1212, __pyx_L1_error)
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_cov_height), __pyx_ptype_7cpython_4bool_bool, 1, "cov_height", 0))) __PYX_ERR(0, 1214, __pyx_L1_error)
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_cov_pos), __pyx_ptype_7cpython_4bool_bool, 1, "cov_pos", 0))) __PYX_ERR(0, 1215, __pyx_L1_error)
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_cov_fwhm), __pyx_ptype_7cpython_4bool_bool, 1, "cov_fwhm", 0))) __PYX_ERR(0, 1216, __pyx_L1_error)
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_fix_height), __pyx_ptype_7cpython_4bool_bool, 1, "fix_height", 0))) __PYX_ERR(0, 1217, __pyx_L1_error)
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_fix_pos), __pyx_ptype_7cpython_4bool_bool, 1, "fix_pos", 0))) __PYX_ERR(0, 1218, __pyx_L1_error)
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_fix_fwhm), __pyx_ptype_7cpython_4bool_bool, 1, "fix_fwhm", 0))) __PYX_ERR(0, 1219, __pyx_L1_error)
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_enable_zoom), __pyx_ptype_7cpython_4bool_bool, 1, "enable_zoom", 0))) __PYX_ERR(0, 1223, __pyx_L1_error)
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_enable_rotation), __pyx_ptype_7cpython_4bool_bool, 1, "enable_rotation", 0))) __PYX_ERR(0, 1224, __pyx_L1_error)
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_estimate_local_noise), __pyx_ptype_7cpython_4bool_bool, 1, "estimate_local_noise", 0))) __PYX_ERR(0, 1225, __pyx_L1_error)
  __pyx_r = __pyx_pf_3orb_6cutils_58multi_fit_stars(__pyx_self, __pyx_v_frame, __pyx_v_pos, __pyx_v_box_size, __pyx_v_height_guess, __pyx_v_fwhm_guess, __pyx_v_cov_height, __pyx_v_cov_pos, __pyx_v_cov_fwhm, __pyx_v_fix_height, __pyx_v_fix_pos, __pyx_v_fix_fwhm, __pyx_v_fit_tol, __pyx_v_ron, __pyx_v_dcl, __pyx_v_enable_zoom, __pyx_v_enable_rotation, __pyx_v_estimate_local_noise, __pyx_v_saturation, __pyx_v_sip);

  /* "orb/cutils.pyx":1208
 *     return inside
 * 
 * def multi_fit_stars(np.ndarray[np.float64_t, ndim=2] frame,             # <<<<<<<<<<<<<<
 *                     np.ndarray[np.float64_t, ndim=2] pos,
 *                     int box_size,
 */

  /* function exit code */
  goto __pyx_L0;
  __pyx_L1_error:;
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":1297
 *       distorsion correction (default None).
 *     """
 *     def params_arrays2vect(np.ndarray[np.float64_t, ndim=2] stars_p,             # <<<<<<<<<<<<<<
 *                            np.ndarray[np.float64_t, ndim=1] stars_p_mask,
 *                            np.ndarray[np.float64_t, ndim=1] cov_p,
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_15multi_fit_stars_1params_arrays2vect(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static PyMethodDef __pyx_mdef_3orb_6cutils_15multi_fit_stars_1params_arrays2vect = {"params_arrays2vect", (PyCFunction)__pyx_pw_3orb_6cutils_15multi_fit_stars_1params_arrays2vect, METH_VARARGS|METH_KEYWORDS, 0};
static PyObject *__pyx_pw_3orb_6cutils_15multi_fit_stars_1params_arrays2vect(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  PyArrayObject *__pyx_v_stars_p = 0;
  PyArrayObject *__pyx_v_stars_p_mask = 0;
  PyArrayObject *__pyx_v_cov_p = 0;
  PyArrayObject *__pyx_v_cov_p_mask = 0;
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("params_arrays2vect (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_stars_p,&__pyx_n_s_stars_p_mask,&__pyx_n_s_cov_p,&__pyx_n_s_cov_p_mask,0};
    PyObject* values[4] = {0,0,0,0};
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
      switch (pos_args) {
        case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = PyDict_Size(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_stars_p)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        case  1:
        if (likely((values[1] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_stars_p_mask)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("params_arrays2vect", 1, 4, 4, 1); __PYX_ERR(0, 1297, __pyx_L3_error)
        }
        case  2:
        if (likely((values[2] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_cov_p)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("params_arrays2vect", 1, 4, 4, 2); __PYX_ERR(0, 1297, __pyx_L3_error)
        }
        case  3:
        if (likely((values[3] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_cov_p_mask)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("params_arrays2vect", 1, 4, 4, 3); __PYX_ERR(0, 1297, __pyx_L3_error)
        }
      }
      if (unlikely(kw_args > 0)) {
        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "params_arrays2vect") < 0)) __PYX_ERR(0, 1297, __pyx_L3_error)
      }
    } else if (PyTuple_GET_SIZE(__pyx_args) != 4) {
      goto __pyx_L5_argtuple_error;
    } else {
      values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
      values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
      values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
      values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
    }
    __pyx_v_stars_p = ((PyArrayObject *)values[0]);
    __pyx_v_stars_p_mask = ((PyArrayObject *)values[1]);
    __pyx_v_cov_p = ((PyArrayObject *)values[2]);
    __pyx_v_cov_p_mask = ((PyArrayObject *)values[3]);
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  __Pyx_RaiseArgtupleInvalid("params_arrays2vect", 1, 4, 4, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 1297, __pyx_L3_error)
  __pyx_L3_error:;
  __Pyx_AddTraceback("orb.cutils.multi_fit_stars.params_arrays2vect", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __Pyx_RefNannyFinishContext();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_stars_p), __pyx_ptype_5numpy_ndarray, 1, "stars_p", 0))) __PYX_ERR(0, 1297, __pyx_L1_error)
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_stars_p_mask), __pyx_ptype_5numpy_ndarray, 1, "stars_p_mask", 0))) __PYX_ERR(0, 1298, __pyx_L1_error)
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_cov_p), __pyx_ptype_5numpy_ndarray, 1, "cov_p", 0))) __PYX_ERR(0, 1299, __pyx_L1_error)
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_cov_p_mask), __pyx_ptype_5numpy_ndarray, 1, "cov_p_mask", 0))) __PYX_ERR(0, 1300, __pyx_L1_error)
  __pyx_r = __pyx_pf_3orb_6cutils_15multi_fit_stars_params_arrays2vect(__pyx_self, __pyx_v_stars_p, __pyx_v_stars_p_mask, __pyx_v_cov_p, __pyx_v_cov_p_mask);

  /* function exit code */
  goto __pyx_L0;
  __pyx_L1_error:;
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_15multi_fit_stars_params_arrays2vect(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_stars_p, PyArrayObject *__pyx_v_stars_p_mask, PyArrayObject *__pyx_v_cov_p, PyArrayObject *__pyx_v_cov_p_mask) {
  int __pyx_v_stars_free_p_nb;
  int __pyx_v_cov_free_p_nb;
  PyArrayObject *__pyx_v_free_p = 0;
  PyArrayObject *__pyx_v_fixed_p = 0;
  int __pyx_v_ip;
  int __pyx_v_i;
  int __pyx_v_j;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_cov_p;
  __Pyx_Buffer __pyx_pybuffer_cov_p;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_cov_p_mask;
  __Pyx_Buffer __pyx_pybuffer_cov_p_mask;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_fixed_p;
  __Pyx_Buffer __pyx_pybuffer_fixed_p;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_free_p;
  __Pyx_Buffer __pyx_pybuffer_free_p;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_stars_p;
  __Pyx_Buffer __pyx_pybuffer_stars_p;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_stars_p_mask;
  __Pyx_Buffer __pyx_pybuffer_stars_p_mask;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  PyObject *__pyx_t_1 = NULL;
  PyObject *__pyx_t_2 = NULL;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  int __pyx_t_5;
  PyArrayObject *__pyx_t_6 = NULL;
  PyObject *__pyx_t_7 = NULL;
  PyObject *__pyx_t_8 = NULL;
  PyArrayObject *__pyx_t_9 = NULL;
  npy_intp __pyx_t_10;
  Py_ssize_t __pyx_t_11;
  int __pyx_t_12;
  int __pyx_t_13;
  __Pyx_RefNannySetupContext("params_arrays2vect", 0);
  __pyx_pybuffer_free_p.pybuffer.buf = NULL;
  __pyx_pybuffer_free_p.refcount = 0;
  __pyx_pybuffernd_free_p.data = NULL;
  __pyx_pybuffernd_free_p.rcbuffer = &__pyx_pybuffer_free_p;
  __pyx_pybuffer_fixed_p.pybuffer.buf = NULL;
  __pyx_pybuffer_fixed_p.refcount = 0;
  __pyx_pybuffernd_fixed_p.data = NULL;
  __pyx_pybuffernd_fixed_p.rcbuffer = &__pyx_pybuffer_fixed_p;
  __pyx_pybuffer_stars_p.pybuffer.buf = NULL;
  __pyx_pybuffer_stars_p.refcount = 0;
  __pyx_pybuffernd_stars_p.data = NULL;
  __pyx_pybuffernd_stars_p.rcbuffer = &__pyx_pybuffer_stars_p;
  __pyx_pybuffer_stars_p_mask.pybuffer.buf = NULL;
  __pyx_pybuffer_stars_p_mask.refcount = 0;
  __pyx_pybuffernd_stars_p_mask.data = NULL;
  __pyx_pybuffernd_stars_p_mask.rcbuffer = &__pyx_pybuffer_stars_p_mask;
  __pyx_pybuffer_cov_p.pybuffer.buf = NULL;
  __pyx_pybuffer_cov_p.refcount = 0;
  __pyx_pybuffernd_cov_p.data = NULL;
  __pyx_pybuffernd_cov_p.rcbuffer = &__pyx_pybuffer_cov_p;
  __pyx_pybuffer_cov_p_mask.pybuffer.buf = NULL;
  __pyx_pybuffer_cov_p_mask.refcount = 0;
  __pyx_pybuffernd_cov_p_mask.data = NULL;
  __pyx_pybuffernd_cov_p_mask.rcbuffer = &__pyx_pybuffer_cov_p_mask;
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_stars_p.rcbuffer->pybuffer, (PyObject*)__pyx_v_stars_p, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) __PYX_ERR(0, 1297, __pyx_L1_error)
  }
  __pyx_pybuffernd_stars_p.diminfo[0].strides = __pyx_pybuffernd_stars_p.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_stars_p.diminfo[0].shape = __pyx_pybuffernd_stars_p.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_stars_p.diminfo[1].strides = __pyx_pybuffernd_stars_p.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_stars_p.diminfo[1].shape = __pyx_pybuffernd_stars_p.rcbuffer->pybuffer.shape[1];
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_stars_p_mask.rcbuffer->pybuffer, (PyObject*)__pyx_v_stars_p_mask, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) __PYX_ERR(0, 1297, __pyx_L1_error)
  }
  __pyx_pybuffernd_stars_p_mask.diminfo[0].strides = __pyx_pybuffernd_stars_p_mask.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_stars_p_mask.diminfo[0].shape = __pyx_pybuffernd_stars_p_mask.rcbuffer->pybuffer.shape[0];
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_cov_p.rcbuffer->pybuffer, (PyObject*)__pyx_v_cov_p, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) __PYX_ERR(0, 1297, __pyx_L1_error)
  }
  __pyx_pybuffernd_cov_p.diminfo[0].strides = __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_cov_p.diminfo[0].shape = __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.shape[0];
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_cov_p_mask.rcbuffer->pybuffer, (PyObject*)__pyx_v_cov_p_mask, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) __PYX_ERR(0, 1297, __pyx_L1_error)
  }
  __pyx_pybuffernd_cov_p_mask.diminfo[0].strides = __pyx_pybuffernd_cov_p_mask.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_cov_p_mask.diminfo[0].shape = __pyx_pybuffernd_cov_p_mask.rcbuffer->pybuffer.shape[0];

  /* "orb/cutils.pyx":1302
 *                            np.ndarray[np.float64_t, ndim=1] cov_p_mask):
 * 
 *         cdef int stars_free_p_nb = np.sum(stars_p_mask)             # <<<<<<<<<<<<<<
 *         cdef int cov_free_p_nb = np.sum(cov_p_mask)
 *         cdef np.ndarray[np.float64_t, ndim=1] free_p = np.zeros(
 */
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1302, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_sum); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1302, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_3))) {
    __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_3);
    if (likely(__pyx_t_2)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
      __Pyx_INCREF(__pyx_t_2);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_3, function);
    }
  }
  if (!__pyx_t_2) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_3, ((PyObject *)__pyx_v_stars_p_mask)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1302, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_4 = PyTuple_New(1+1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1302, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_2); __pyx_t_2 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_stars_p_mask));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_stars_p_mask));
    PyTuple_SET_ITEM(__pyx_t_4, 0+1, ((PyObject *)__pyx_v_stars_p_mask));
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_4, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1302, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  }
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_5 = __Pyx_PyInt_As_int(__pyx_t_1); if (unlikely((__pyx_t_5 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 1302, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_v_stars_free_p_nb = __pyx_t_5;

  /* "orb/cutils.pyx":1303
 * 
 *         cdef int stars_free_p_nb = np.sum(stars_p_mask)
 *         cdef int cov_free_p_nb = np.sum(cov_p_mask)             # <<<<<<<<<<<<<<
 *         cdef np.ndarray[np.float64_t, ndim=1] free_p = np.zeros(
 *             stars_p.shape[0] * stars_free_p_nb
 */
  __pyx_t_3 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1303, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_sum); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1303, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_3 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_4))) {
    __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_4);
    if (likely(__pyx_t_3)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
      __Pyx_INCREF(__pyx_t_3);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_4, function);
    }
  }
  if (!__pyx_t_3) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_4, ((PyObject *)__pyx_v_cov_p_mask)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1303, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_2 = PyTuple_New(1+1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1303, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_3); __pyx_t_3 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_cov_p_mask));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_cov_p_mask));
    PyTuple_SET_ITEM(__pyx_t_2, 0+1, ((PyObject *)__pyx_v_cov_p_mask));
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_2, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1303, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  }
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_5 = __Pyx_PyInt_As_int(__pyx_t_1); if (unlikely((__pyx_t_5 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 1303, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_v_cov_free_p_nb = __pyx_t_5;

  /* "orb/cutils.pyx":1304
 *         cdef int stars_free_p_nb = np.sum(stars_p_mask)
 *         cdef int cov_free_p_nb = np.sum(cov_p_mask)
 *         cdef np.ndarray[np.float64_t, ndim=1] free_p = np.zeros(             # <<<<<<<<<<<<<<
 *             stars_p.shape[0] * stars_free_p_nb
 *             + cov_free_p_nb, dtype=float)
 */
  __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1304, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_zeros); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1304, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1306
 *         cdef np.ndarray[np.float64_t, ndim=1] free_p = np.zeros(
 *             stars_p.shape[0] * stars_free_p_nb
 *             + cov_free_p_nb, dtype=float)             # <<<<<<<<<<<<<<
 *         cdef np.ndarray[np.float64_t, ndim=1] fixed_p = np.zeros(
 *             np.size(stars_p) + np.size(cov_p) - np.size(free_p),
 */
  __pyx_t_1 = __Pyx_PyInt_From_Py_intptr_t((((__pyx_v_stars_p->dimensions[0]) * __pyx_v_stars_free_p_nb) + __pyx_v_cov_free_p_nb)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1306, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);

  /* "orb/cutils.pyx":1304
 *         cdef int stars_free_p_nb = np.sum(stars_p_mask)
 *         cdef int cov_free_p_nb = np.sum(cov_p_mask)
 *         cdef np.ndarray[np.float64_t, ndim=1] free_p = np.zeros(             # <<<<<<<<<<<<<<
 *             stars_p.shape[0] * stars_free_p_nb
 *             + cov_free_p_nb, dtype=float)
 */
  __pyx_t_2 = PyTuple_New(1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1304, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_GIVEREF(__pyx_t_1);
  PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_1);
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1306
 *         cdef np.ndarray[np.float64_t, ndim=1] free_p = np.zeros(
 *             stars_p.shape[0] * stars_free_p_nb
 *             + cov_free_p_nb, dtype=float)             # <<<<<<<<<<<<<<
 *         cdef np.ndarray[np.float64_t, ndim=1] fixed_p = np.zeros(
 *             np.size(stars_p) + np.size(cov_p) - np.size(free_p),
 */
  __pyx_t_1 = PyDict_New(); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1306, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if (PyDict_SetItem(__pyx_t_1, __pyx_n_s_dtype, ((PyObject *)(&PyFloat_Type))) < 0) __PYX_ERR(0, 1306, __pyx_L1_error)

  /* "orb/cutils.pyx":1304
 *         cdef int stars_free_p_nb = np.sum(stars_p_mask)
 *         cdef int cov_free_p_nb = np.sum(cov_p_mask)
 *         cdef np.ndarray[np.float64_t, ndim=1] free_p = np.zeros(             # <<<<<<<<<<<<<<
 *             stars_p.shape[0] * stars_free_p_nb
 *             + cov_free_p_nb, dtype=float)
 */
  __pyx_t_3 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_2, __pyx_t_1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1304, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  if (!(likely(((__pyx_t_3) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_3, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1304, __pyx_L1_error)
  __pyx_t_6 = ((PyArrayObject *)__pyx_t_3);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_free_p.rcbuffer->pybuffer, (PyObject*)__pyx_t_6, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
      __pyx_v_free_p = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_free_p.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 1304, __pyx_L1_error)
    } else {__pyx_pybuffernd_free_p.diminfo[0].strides = __pyx_pybuffernd_free_p.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_free_p.diminfo[0].shape = __pyx_pybuffernd_free_p.rcbuffer->pybuffer.shape[0];
    }
  }
  __pyx_t_6 = 0;
  __pyx_v_free_p = ((PyArrayObject *)__pyx_t_3);
  __pyx_t_3 = 0;

  /* "orb/cutils.pyx":1307
 *             stars_p.shape[0] * stars_free_p_nb
 *             + cov_free_p_nb, dtype=float)
 *         cdef np.ndarray[np.float64_t, ndim=1] fixed_p = np.zeros(             # <<<<<<<<<<<<<<
 *             np.size(stars_p) + np.size(cov_p) - np.size(free_p),
 *             dtype=float)
 */
  __pyx_t_3 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1307, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_zeros); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1307, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;

  /* "orb/cutils.pyx":1308
 *             + cov_free_p_nb, dtype=float)
 *         cdef np.ndarray[np.float64_t, ndim=1] fixed_p = np.zeros(
 *             np.size(stars_p) + np.size(cov_p) - np.size(free_p),             # <<<<<<<<<<<<<<
 *             dtype=float)
 *         cdef int ip, i, j
 */
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1308, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_size); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1308, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_4))) {
    __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_4);
    if (likely(__pyx_t_2)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
      __Pyx_INCREF(__pyx_t_2);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_4, function);
    }
  }
  if (!__pyx_t_2) {
    __pyx_t_3 = __Pyx_PyObject_CallOneArg(__pyx_t_4, ((PyObject *)__pyx_v_stars_p)); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1308, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
  } else {
    __pyx_t_7 = PyTuple_New(1+1); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 1308, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_7);
    __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_7, 0, __pyx_t_2); __pyx_t_2 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_stars_p));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_stars_p));
    PyTuple_SET_ITEM(__pyx_t_7, 0+1, ((PyObject *)__pyx_v_stars_p));
    __pyx_t_3 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_7, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1308, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
  }
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_7 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 1308, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_7);
  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_7, __pyx_n_s_size); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1308, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
  __pyx_t_7 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_2))) {
    __pyx_t_7 = PyMethod_GET_SELF(__pyx_t_2);
    if (likely(__pyx_t_7)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
      __Pyx_INCREF(__pyx_t_7);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_2, function);
    }
  }
  if (!__pyx_t_7) {
    __pyx_t_4 = __Pyx_PyObject_CallOneArg(__pyx_t_2, ((PyObject *)__pyx_v_cov_p)); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1308, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
  } else {
    __pyx_t_8 = PyTuple_New(1+1); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 1308, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_8);
    __Pyx_GIVEREF(__pyx_t_7); PyTuple_SET_ITEM(__pyx_t_8, 0, __pyx_t_7); __pyx_t_7 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_cov_p));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_cov_p));
    PyTuple_SET_ITEM(__pyx_t_8, 0+1, ((PyObject *)__pyx_v_cov_p));
    __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_8, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1308, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
  }
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = PyNumber_Add(__pyx_t_3, __pyx_t_4); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1308, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_3 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1308, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_8 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_size); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 1308, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_8);
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_3 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_8))) {
    __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_8);
    if (likely(__pyx_t_3)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_8);
      __Pyx_INCREF(__pyx_t_3);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_8, function);
    }
  }
  if (!__pyx_t_3) {
    __pyx_t_4 = __Pyx_PyObject_CallOneArg(__pyx_t_8, ((PyObject *)__pyx_v_free_p)); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1308, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
  } else {
    __pyx_t_7 = PyTuple_New(1+1); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 1308, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_7);
    __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_7, 0, __pyx_t_3); __pyx_t_3 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_free_p));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_free_p));
    PyTuple_SET_ITEM(__pyx_t_7, 0+1, ((PyObject *)__pyx_v_free_p));
    __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_8, __pyx_t_7, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1308, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
  }
  __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
  __pyx_t_8 = PyNumber_Subtract(__pyx_t_2, __pyx_t_4); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 1308, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_8);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;

  /* "orb/cutils.pyx":1307
 *             stars_p.shape[0] * stars_free_p_nb
 *             + cov_free_p_nb, dtype=float)
 *         cdef np.ndarray[np.float64_t, ndim=1] fixed_p = np.zeros(             # <<<<<<<<<<<<<<
 *             np.size(stars_p) + np.size(cov_p) - np.size(free_p),
 *             dtype=float)
 */
  __pyx_t_4 = PyTuple_New(1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1307, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_GIVEREF(__pyx_t_8);
  PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_8);
  __pyx_t_8 = 0;

  /* "orb/cutils.pyx":1309
 *         cdef np.ndarray[np.float64_t, ndim=1] fixed_p = np.zeros(
 *             np.size(stars_p) + np.size(cov_p) - np.size(free_p),
 *             dtype=float)             # <<<<<<<<<<<<<<
 *         cdef int ip, i, j
 * 
 */
  __pyx_t_8 = PyDict_New(); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 1309, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_8);
  if (PyDict_SetItem(__pyx_t_8, __pyx_n_s_dtype, ((PyObject *)(&PyFloat_Type))) < 0) __PYX_ERR(0, 1309, __pyx_L1_error)

  /* "orb/cutils.pyx":1307
 *             stars_p.shape[0] * stars_free_p_nb
 *             + cov_free_p_nb, dtype=float)
 *         cdef np.ndarray[np.float64_t, ndim=1] fixed_p = np.zeros(             # <<<<<<<<<<<<<<
 *             np.size(stars_p) + np.size(cov_p) - np.size(free_p),
 *             dtype=float)
 */
  __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_1, __pyx_t_4, __pyx_t_8); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1307, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
  if (!(likely(((__pyx_t_2) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_2, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1307, __pyx_L1_error)
  __pyx_t_9 = ((PyArrayObject *)__pyx_t_2);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_fixed_p.rcbuffer->pybuffer, (PyObject*)__pyx_t_9, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
      __pyx_v_fixed_p = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_fixed_p.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 1307, __pyx_L1_error)
    } else {__pyx_pybuffernd_fixed_p.diminfo[0].strides = __pyx_pybuffernd_fixed_p.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_fixed_p.diminfo[0].shape = __pyx_pybuffernd_fixed_p.rcbuffer->pybuffer.shape[0];
    }
  }
  __pyx_t_9 = 0;
  __pyx_v_fixed_p = ((PyArrayObject *)__pyx_t_2);
  __pyx_t_2 = 0;

  /* "orb/cutils.pyx":1312
 *         cdef int ip, i, j
 * 
 *         i = 0             # <<<<<<<<<<<<<<
 *         j = 0
 * 
 */
  __pyx_v_i = 0;

  /* "orb/cutils.pyx":1313
 * 
 *         i = 0
 *         j = 0             # <<<<<<<<<<<<<<
 * 
 *         for ip in range(stars_p.shape[1]):
 */
  __pyx_v_j = 0;

  /* "orb/cutils.pyx":1315
 *         j = 0
 * 
 *         for ip in range(stars_p.shape[1]):             # <<<<<<<<<<<<<<
 *             if stars_p_mask[ip] == 1:
 *                 free_p[i*stars_p.shape[0]:
 */
  __pyx_t_10 = (__pyx_v_stars_p->dimensions[1]);
  for (__pyx_t_5 = 0; __pyx_t_5 < __pyx_t_10; __pyx_t_5+=1) {
    __pyx_v_ip = __pyx_t_5;

    /* "orb/cutils.pyx":1316
 * 
 *         for ip in range(stars_p.shape[1]):
 *             if stars_p_mask[ip] == 1:             # <<<<<<<<<<<<<<
 *                 free_p[i*stars_p.shape[0]:
 *                        (i+1)*stars_p.shape[0]] = stars_p[:,ip]
 */
    __pyx_t_11 = __pyx_v_ip;
    __pyx_t_12 = -1;
    if (__pyx_t_11 < 0) {
      __pyx_t_11 += __pyx_pybuffernd_stars_p_mask.diminfo[0].shape;
      if (unlikely(__pyx_t_11 < 0)) __pyx_t_12 = 0;
    } else if (unlikely(__pyx_t_11 >= __pyx_pybuffernd_stars_p_mask.diminfo[0].shape)) __pyx_t_12 = 0;
    if (unlikely(__pyx_t_12 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_12);
      __PYX_ERR(0, 1316, __pyx_L1_error)
    }
    __pyx_t_13 = (((*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_stars_p_mask.rcbuffer->pybuffer.buf, __pyx_t_11, __pyx_pybuffernd_stars_p_mask.diminfo[0].strides)) == 1.0) != 0);
    if (__pyx_t_13) {

      /* "orb/cutils.pyx":1318
 *             if stars_p_mask[ip] == 1:
 *                 free_p[i*stars_p.shape[0]:
 *                        (i+1)*stars_p.shape[0]] = stars_p[:,ip]             # <<<<<<<<<<<<<<
 *                 i += 1
 *             else:
 */
      __pyx_t_2 = __Pyx_PyInt_From_int(__pyx_v_ip); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1318, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __pyx_t_8 = PyTuple_New(2); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 1318, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_8);
      __Pyx_INCREF(__pyx_slice__60);
      __Pyx_GIVEREF(__pyx_slice__60);
      PyTuple_SET_ITEM(__pyx_t_8, 0, __pyx_slice__60);
      __Pyx_GIVEREF(__pyx_t_2);
      PyTuple_SET_ITEM(__pyx_t_8, 1, __pyx_t_2);
      __pyx_t_2 = 0;
      __pyx_t_2 = PyObject_GetItem(((PyObject *)__pyx_v_stars_p), __pyx_t_8); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1318, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;

      /* "orb/cutils.pyx":1317
 *         for ip in range(stars_p.shape[1]):
 *             if stars_p_mask[ip] == 1:
 *                 free_p[i*stars_p.shape[0]:             # <<<<<<<<<<<<<<
 *                        (i+1)*stars_p.shape[0]] = stars_p[:,ip]
 *                 i += 1
 */
      if (__Pyx_PyObject_SetSlice(((PyObject *)__pyx_v_free_p), __pyx_t_2, (__pyx_v_i * (__pyx_v_stars_p->dimensions[0])), ((__pyx_v_i + 1) * (__pyx_v_stars_p->dimensions[0])), NULL, NULL, NULL, 1, 1, 1) < 0) __PYX_ERR(0, 1317, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;

      /* "orb/cutils.pyx":1319
 *                 free_p[i*stars_p.shape[0]:
 *                        (i+1)*stars_p.shape[0]] = stars_p[:,ip]
 *                 i += 1             # <<<<<<<<<<<<<<
 *             else:
 *                 fixed_p[j*stars_p.shape[0]:
 */
      __pyx_v_i = (__pyx_v_i + 1);

      /* "orb/cutils.pyx":1316
 * 
 *         for ip in range(stars_p.shape[1]):
 *             if stars_p_mask[ip] == 1:             # <<<<<<<<<<<<<<
 *                 free_p[i*stars_p.shape[0]:
 *                        (i+1)*stars_p.shape[0]] = stars_p[:,ip]
 */
      goto __pyx_L5;
    }

    /* "orb/cutils.pyx":1321
 *                 i += 1
 *             else:
 *                 fixed_p[j*stars_p.shape[0]:             # <<<<<<<<<<<<<<
 *                        (j+1)*stars_p.shape[0]] = stars_p[:,ip]
 *                 j += 1
 */
    /*else*/ {

      /* "orb/cutils.pyx":1322
 *             else:
 *                 fixed_p[j*stars_p.shape[0]:
 *                        (j+1)*stars_p.shape[0]] = stars_p[:,ip]             # <<<<<<<<<<<<<<
 *                 j += 1
 * 
 */
      __pyx_t_2 = __Pyx_PyInt_From_int(__pyx_v_ip); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1322, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __pyx_t_8 = PyTuple_New(2); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 1322, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_8);
      __Pyx_INCREF(__pyx_slice__61);
      __Pyx_GIVEREF(__pyx_slice__61);
      PyTuple_SET_ITEM(__pyx_t_8, 0, __pyx_slice__61);
      __Pyx_GIVEREF(__pyx_t_2);
      PyTuple_SET_ITEM(__pyx_t_8, 1, __pyx_t_2);
      __pyx_t_2 = 0;
      __pyx_t_2 = PyObject_GetItem(((PyObject *)__pyx_v_stars_p), __pyx_t_8); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1322, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;

      /* "orb/cutils.pyx":1321
 *                 i += 1
 *             else:
 *                 fixed_p[j*stars_p.shape[0]:             # <<<<<<<<<<<<<<
 *                        (j+1)*stars_p.shape[0]] = stars_p[:,ip]
 *                 j += 1
 */
      if (__Pyx_PyObject_SetSlice(((PyObject *)__pyx_v_fixed_p), __pyx_t_2, (__pyx_v_j * (__pyx_v_stars_p->dimensions[0])), ((__pyx_v_j + 1) * (__pyx_v_stars_p->dimensions[0])), NULL, NULL, NULL, 1, 1, 1) < 0) __PYX_ERR(0, 1321, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;

      /* "orb/cutils.pyx":1323
 *                 fixed_p[j*stars_p.shape[0]:
 *                        (j+1)*stars_p.shape[0]] = stars_p[:,ip]
 *                 j += 1             # <<<<<<<<<<<<<<
 * 
 *         if bn.nansum(cov_p_mask > 0):
 */
      __pyx_v_j = (__pyx_v_j + 1);
    }
    __pyx_L5:;
  }

  /* "orb/cutils.pyx":1325
 *                 j += 1
 * 
 *         if bn.nansum(cov_p_mask > 0):             # <<<<<<<<<<<<<<
 *             free_p[-cov_free_p_nb:] = cov_p[np.nonzero(cov_p_mask)]
 *         if bn.nansum(cov_p_mask > 0) != np.size(cov_p_mask):
 */
  __pyx_t_8 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 1325, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_8);
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_8, __pyx_n_s_nansum); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1325, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
  __pyx_t_8 = PyObject_RichCompare(((PyObject *)__pyx_v_cov_p_mask), __pyx_int_0, Py_GT); __Pyx_XGOTREF(__pyx_t_8); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 1325, __pyx_L1_error)
  __pyx_t_1 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_4))) {
    __pyx_t_1 = PyMethod_GET_SELF(__pyx_t_4);
    if (likely(__pyx_t_1)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
      __Pyx_INCREF(__pyx_t_1);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_4, function);
    }
  }
  if (!__pyx_t_1) {
    __pyx_t_2 = __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_8); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1325, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
    __Pyx_GOTREF(__pyx_t_2);
  } else {
    __pyx_t_7 = PyTuple_New(1+1); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 1325, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_7);
    __Pyx_GIVEREF(__pyx_t_1); PyTuple_SET_ITEM(__pyx_t_7, 0, __pyx_t_1); __pyx_t_1 = NULL;
    __Pyx_GIVEREF(__pyx_t_8);
    PyTuple_SET_ITEM(__pyx_t_7, 0+1, __pyx_t_8);
    __pyx_t_8 = 0;
    __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_7, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1325, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
  }
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_13 = __Pyx_PyObject_IsTrue(__pyx_t_2); if (unlikely(__pyx_t_13 < 0)) __PYX_ERR(0, 1325, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  if (__pyx_t_13) {

    /* "orb/cutils.pyx":1326
 * 
 *         if bn.nansum(cov_p_mask > 0):
 *             free_p[-cov_free_p_nb:] = cov_p[np.nonzero(cov_p_mask)]             # <<<<<<<<<<<<<<
 *         if bn.nansum(cov_p_mask > 0) != np.size(cov_p_mask):
 *             fixed_p[-(np.size(cov_p)-cov_free_p_nb):] = cov_p[
 */
    __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1326, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __pyx_t_7 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_nonzero); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 1326, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_7);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_t_4 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_7))) {
      __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_7);
      if (likely(__pyx_t_4)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_7);
        __Pyx_INCREF(__pyx_t_4);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_7, function);
      }
    }
    if (!__pyx_t_4) {
      __pyx_t_2 = __Pyx_PyObject_CallOneArg(__pyx_t_7, ((PyObject *)__pyx_v_cov_p_mask)); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1326, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
    } else {
      __pyx_t_8 = PyTuple_New(1+1); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 1326, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_8);
      __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_8, 0, __pyx_t_4); __pyx_t_4 = NULL;
      __Pyx_INCREF(((PyObject *)__pyx_v_cov_p_mask));
      __Pyx_GIVEREF(((PyObject *)__pyx_v_cov_p_mask));
      PyTuple_SET_ITEM(__pyx_t_8, 0+1, ((PyObject *)__pyx_v_cov_p_mask));
      __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_7, __pyx_t_8, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1326, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
    }
    __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
    __pyx_t_7 = PyObject_GetItem(((PyObject *)__pyx_v_cov_p), __pyx_t_2); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 1326, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_7);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    if (__Pyx_PyObject_SetSlice(((PyObject *)__pyx_v_free_p), __pyx_t_7, (-__pyx_v_cov_free_p_nb), 0, NULL, NULL, NULL, 1, 0, 1) < 0) __PYX_ERR(0, 1326, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;

    /* "orb/cutils.pyx":1325
 *                 j += 1
 * 
 *         if bn.nansum(cov_p_mask > 0):             # <<<<<<<<<<<<<<
 *             free_p[-cov_free_p_nb:] = cov_p[np.nonzero(cov_p_mask)]
 *         if bn.nansum(cov_p_mask > 0) != np.size(cov_p_mask):
 */
  }

  /* "orb/cutils.pyx":1327
 *         if bn.nansum(cov_p_mask > 0):
 *             free_p[-cov_free_p_nb:] = cov_p[np.nonzero(cov_p_mask)]
 *         if bn.nansum(cov_p_mask > 0) != np.size(cov_p_mask):             # <<<<<<<<<<<<<<
 *             fixed_p[-(np.size(cov_p)-cov_free_p_nb):] = cov_p[
 *                 np.nonzero(cov_p_mask == 0)]
 */
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1327, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_8 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_nansum); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 1327, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_8);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = PyObject_RichCompare(((PyObject *)__pyx_v_cov_p_mask), __pyx_int_0, Py_GT); __Pyx_XGOTREF(__pyx_t_2); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1327, __pyx_L1_error)
  __pyx_t_4 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_8))) {
    __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_8);
    if (likely(__pyx_t_4)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_8);
      __Pyx_INCREF(__pyx_t_4);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_8, function);
    }
  }
  if (!__pyx_t_4) {
    __pyx_t_7 = __Pyx_PyObject_CallOneArg(__pyx_t_8, __pyx_t_2); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 1327, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __Pyx_GOTREF(__pyx_t_7);
  } else {
    __pyx_t_1 = PyTuple_New(1+1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1327, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_1, 0, __pyx_t_4); __pyx_t_4 = NULL;
    __Pyx_GIVEREF(__pyx_t_2);
    PyTuple_SET_ITEM(__pyx_t_1, 0+1, __pyx_t_2);
    __pyx_t_2 = 0;
    __pyx_t_7 = __Pyx_PyObject_Call(__pyx_t_8, __pyx_t_1, NULL); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 1327, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_7);
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  }
  __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
  __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1327, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_size); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1327, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_1 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_2))) {
    __pyx_t_1 = PyMethod_GET_SELF(__pyx_t_2);
    if (likely(__pyx_t_1)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
      __Pyx_INCREF(__pyx_t_1);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_2, function);
    }
  }
  if (!__pyx_t_1) {
    __pyx_t_8 = __Pyx_PyObject_CallOneArg(__pyx_t_2, ((PyObject *)__pyx_v_cov_p_mask)); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 1327, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_8);
  } else {
    __pyx_t_4 = PyTuple_New(1+1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1327, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_GIVEREF(__pyx_t_1); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_1); __pyx_t_1 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_cov_p_mask));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_cov_p_mask));
    PyTuple_SET_ITEM(__pyx_t_4, 0+1, ((PyObject *)__pyx_v_cov_p_mask));
    __pyx_t_8 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_4, NULL); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 1327, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_8);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  }
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = PyObject_RichCompare(__pyx_t_7, __pyx_t_8, Py_NE); __Pyx_XGOTREF(__pyx_t_2); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1327, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
  __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
  __pyx_t_13 = __Pyx_PyObject_IsTrue(__pyx_t_2); if (unlikely(__pyx_t_13 < 0)) __PYX_ERR(0, 1327, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  if (__pyx_t_13) {

    /* "orb/cutils.pyx":1329
 *         if bn.nansum(cov_p_mask > 0) != np.size(cov_p_mask):
 *             fixed_p[-(np.size(cov_p)-cov_free_p_nb):] = cov_p[
 *                 np.nonzero(cov_p_mask == 0)]             # <<<<<<<<<<<<<<
 * 
 * 
 */
    __pyx_t_8 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 1329, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_8);
    __pyx_t_7 = __Pyx_PyObject_GetAttrStr(__pyx_t_8, __pyx_n_s_nonzero); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 1329, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_7);
    __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
    __pyx_t_8 = PyObject_RichCompare(((PyObject *)__pyx_v_cov_p_mask), __pyx_int_0, Py_EQ); __Pyx_XGOTREF(__pyx_t_8); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 1329, __pyx_L1_error)
    __pyx_t_4 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_7))) {
      __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_7);
      if (likely(__pyx_t_4)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_7);
        __Pyx_INCREF(__pyx_t_4);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_7, function);
      }
    }
    if (!__pyx_t_4) {
      __pyx_t_2 = __Pyx_PyObject_CallOneArg(__pyx_t_7, __pyx_t_8); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1329, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
      __Pyx_GOTREF(__pyx_t_2);
    } else {
      __pyx_t_1 = PyTuple_New(1+1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1329, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);
      __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_1, 0, __pyx_t_4); __pyx_t_4 = NULL;
      __Pyx_GIVEREF(__pyx_t_8);
      PyTuple_SET_ITEM(__pyx_t_1, 0+1, __pyx_t_8);
      __pyx_t_8 = 0;
      __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_7, __pyx_t_1, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1329, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    }
    __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;

    /* "orb/cutils.pyx":1328
 *             free_p[-cov_free_p_nb:] = cov_p[np.nonzero(cov_p_mask)]
 *         if bn.nansum(cov_p_mask > 0) != np.size(cov_p_mask):
 *             fixed_p[-(np.size(cov_p)-cov_free_p_nb):] = cov_p[             # <<<<<<<<<<<<<<
 *                 np.nonzero(cov_p_mask == 0)]
 * 
 */
    __pyx_t_7 = PyObject_GetItem(((PyObject *)__pyx_v_cov_p), __pyx_t_2); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 1328, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_7);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1328, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __pyx_t_8 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_size); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 1328, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_8);
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    __pyx_t_1 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_8))) {
      __pyx_t_1 = PyMethod_GET_SELF(__pyx_t_8);
      if (likely(__pyx_t_1)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_8);
        __Pyx_INCREF(__pyx_t_1);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_8, function);
      }
    }
    if (!__pyx_t_1) {
      __pyx_t_2 = __Pyx_PyObject_CallOneArg(__pyx_t_8, ((PyObject *)__pyx_v_cov_p)); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1328, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
    } else {
      __pyx_t_4 = PyTuple_New(1+1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1328, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __Pyx_GIVEREF(__pyx_t_1); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_1); __pyx_t_1 = NULL;
      __Pyx_INCREF(((PyObject *)__pyx_v_cov_p));
      __Pyx_GIVEREF(((PyObject *)__pyx_v_cov_p));
      PyTuple_SET_ITEM(__pyx_t_4, 0+1, ((PyObject *)__pyx_v_cov_p));
      __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_8, __pyx_t_4, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1328, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    }
    __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
    __pyx_t_8 = __Pyx_PyInt_From_int(__pyx_v_cov_free_p_nb); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 1328, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_8);
    __pyx_t_4 = PyNumber_Subtract(__pyx_t_2, __pyx_t_8); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1328, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
    __pyx_t_8 = PyNumber_Negative(__pyx_t_4); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 1328, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_8);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    if (__Pyx_PyObject_SetSlice(((PyObject *)__pyx_v_fixed_p), __pyx_t_7, 0, 0, &__pyx_t_8, NULL, NULL, 0, 0, 1) < 0) __PYX_ERR(0, 1328, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
    __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;

    /* "orb/cutils.pyx":1327
 *         if bn.nansum(cov_p_mask > 0):
 *             free_p[-cov_free_p_nb:] = cov_p[np.nonzero(cov_p_mask)]
 *         if bn.nansum(cov_p_mask > 0) != np.size(cov_p_mask):             # <<<<<<<<<<<<<<
 *             fixed_p[-(np.size(cov_p)-cov_free_p_nb):] = cov_p[
 *                 np.nonzero(cov_p_mask == 0)]
 */
  }

  /* "orb/cutils.pyx":1332
 * 
 * 
 *         return free_p, fixed_p             # <<<<<<<<<<<<<<
 * 
 *     def params_vect2arrays(np.ndarray[np.float64_t, ndim=1] free_p,
 */
  __Pyx_XDECREF(__pyx_r);
  __pyx_t_7 = PyTuple_New(2); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 1332, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_7);
  __Pyx_INCREF(((PyObject *)__pyx_v_free_p));
  __Pyx_GIVEREF(((PyObject *)__pyx_v_free_p));
  PyTuple_SET_ITEM(__pyx_t_7, 0, ((PyObject *)__pyx_v_free_p));
  __Pyx_INCREF(((PyObject *)__pyx_v_fixed_p));
  __Pyx_GIVEREF(((PyObject *)__pyx_v_fixed_p));
  PyTuple_SET_ITEM(__pyx_t_7, 1, ((PyObject *)__pyx_v_fixed_p));
  __pyx_r = __pyx_t_7;
  __pyx_t_7 = 0;
  goto __pyx_L0;

  /* "orb/cutils.pyx":1297
 *       distorsion correction (default None).
 *     """
 *     def params_arrays2vect(np.ndarray[np.float64_t, ndim=2] stars_p,             # <<<<<<<<<<<<<<
 *                            np.ndarray[np.float64_t, ndim=1] stars_p_mask,
 *                            np.ndarray[np.float64_t, ndim=1] cov_p,
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_1);
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_XDECREF(__pyx_t_7);
  __Pyx_XDECREF(__pyx_t_8);
  { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
    __Pyx_PyThreadState_declare
    __Pyx_PyThreadState_assign
    __Pyx_ErrFetch(&__pyx_type, &__pyx_value, &__pyx_tb);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_cov_p.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_cov_p_mask.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_fixed_p.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_free_p.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_stars_p.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_stars_p_mask.rcbuffer->pybuffer);
  __Pyx_ErrRestore(__pyx_type, __pyx_value, __pyx_tb);}
  __Pyx_AddTraceback("orb.cutils.multi_fit_stars.params_arrays2vect", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  goto __pyx_L2;
  __pyx_L0:;
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_cov_p.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_cov_p_mask.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_fixed_p.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_free_p.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_stars_p.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_stars_p_mask.rcbuffer->pybuffer);
  __pyx_L2:;
  __Pyx_XDECREF((PyObject *)__pyx_v_free_p);
  __Pyx_XDECREF((PyObject *)__pyx_v_fixed_p);
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":1334
 *         return free_p, fixed_p
 * 
 *     def params_vect2arrays(np.ndarray[np.float64_t, ndim=1] free_p,             # <<<<<<<<<<<<<<
 *                            np.ndarray[np.float64_t, ndim=1] fixed_p,
 *                            np.ndarray[np.float64_t, ndim=1] stars_p_mask,
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_15multi_fit_stars_3params_vect2arrays(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static PyMethodDef __pyx_mdef_3orb_6cutils_15multi_fit_stars_3params_vect2arrays = {"params_vect2arrays", (PyCFunction)__pyx_pw_3orb_6cutils_15multi_fit_stars_3params_vect2arrays, METH_VARARGS|METH_KEYWORDS, 0};
static PyObject *__pyx_pw_3orb_6cutils_15multi_fit_stars_3params_vect2arrays(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  PyArrayObject *__pyx_v_free_p = 0;
  PyArrayObject *__pyx_v_fixed_p = 0;
  PyArrayObject *__pyx_v_stars_p_mask = 0;
  PyArrayObject *__pyx_v_cov_p_mask = 0;
  int __pyx_v_star_nb;
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("params_vect2arrays (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_free_p,&__pyx_n_s_fixed_p,&__pyx_n_s_stars_p_mask,&__pyx_n_s_cov_p_mask,&__pyx_n_s_star_nb,0};
    PyObject* values[5] = {0,0,0,0,0};
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
      switch (pos_args) {
        case  5: values[4] = PyTuple_GET_ITEM(__pyx_args, 4);
        case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = PyDict_Size(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_free_p)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        case  1:
        if (likely((values[1] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_fixed_p)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("params_vect2arrays", 1, 5, 5, 1); __PYX_ERR(0, 1334, __pyx_L3_error)
        }
        case  2:
        if (likely((values[2] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_stars_p_mask)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("params_vect2arrays", 1, 5, 5, 2); __PYX_ERR(0, 1334, __pyx_L3_error)
        }
        case  3:
        if (likely((values[3] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_cov_p_mask)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("params_vect2arrays", 1, 5, 5, 3); __PYX_ERR(0, 1334, __pyx_L3_error)
        }
        case  4:
        if (likely((values[4] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_star_nb)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("params_vect2arrays", 1, 5, 5, 4); __PYX_ERR(0, 1334, __pyx_L3_error)
        }
      }
      if (unlikely(kw_args > 0)) {
        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "params_vect2arrays") < 0)) __PYX_ERR(0, 1334, __pyx_L3_error)
      }
    } else if (PyTuple_GET_SIZE(__pyx_args) != 5) {
      goto __pyx_L5_argtuple_error;
    } else {
      values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
      values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
      values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
      values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
      values[4] = PyTuple_GET_ITEM(__pyx_args, 4);
    }
    __pyx_v_free_p = ((PyArrayObject *)values[0]);
    __pyx_v_fixed_p = ((PyArrayObject *)values[1]);
    __pyx_v_stars_p_mask = ((PyArrayObject *)values[2]);
    __pyx_v_cov_p_mask = ((PyArrayObject *)values[3]);
    __pyx_v_star_nb = __Pyx_PyInt_As_int(values[4]); if (unlikely((__pyx_v_star_nb == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 1338, __pyx_L3_error)
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  __Pyx_RaiseArgtupleInvalid("params_vect2arrays", 1, 5, 5, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 1334, __pyx_L3_error)
  __pyx_L3_error:;
  __Pyx_AddTraceback("orb.cutils.multi_fit_stars.params_vect2arrays", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __Pyx_RefNannyFinishContext();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_free_p), __pyx_ptype_5numpy_ndarray, 1, "free_p", 0))) __PYX_ERR(0, 1334, __pyx_L1_error)
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_fixed_p), __pyx_ptype_5numpy_ndarray, 1, "fixed_p", 0))) __PYX_ERR(0, 1335, __pyx_L1_error)
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_stars_p_mask), __pyx_ptype_5numpy_ndarray, 1, "stars_p_mask", 0))) __PYX_ERR(0, 1336, __pyx_L1_error)
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_cov_p_mask), __pyx_ptype_5numpy_ndarray, 1, "cov_p_mask", 0))) __PYX_ERR(0, 1337, __pyx_L1_error)
  __pyx_r = __pyx_pf_3orb_6cutils_15multi_fit_stars_2params_vect2arrays(__pyx_self, __pyx_v_free_p, __pyx_v_fixed_p, __pyx_v_stars_p_mask, __pyx_v_cov_p_mask, __pyx_v_star_nb);

  /* function exit code */
  goto __pyx_L0;
  __pyx_L1_error:;
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_15multi_fit_stars_2params_vect2arrays(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_free_p, PyArrayObject *__pyx_v_fixed_p, PyArrayObject *__pyx_v_stars_p_mask, PyArrayObject *__pyx_v_cov_p_mask, int __pyx_v_star_nb) {
  CYTHON_UNUSED int __pyx_v_stars_free_p_nb;
  int __pyx_v_cov_free_p_nb;
  PyArrayObject *__pyx_v_stars_p = 0;
  PyArrayObject *__pyx_v_cov_p = 0;
  int __pyx_v_ip;
  int __pyx_v_i;
  int __pyx_v_j;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_cov_p;
  __Pyx_Buffer __pyx_pybuffer_cov_p;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_cov_p_mask;
  __Pyx_Buffer __pyx_pybuffer_cov_p_mask;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_fixed_p;
  __Pyx_Buffer __pyx_pybuffer_fixed_p;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_free_p;
  __Pyx_Buffer __pyx_pybuffer_free_p;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_stars_p;
  __Pyx_Buffer __pyx_pybuffer_stars_p;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_stars_p_mask;
  __Pyx_Buffer __pyx_pybuffer_stars_p_mask;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  PyObject *__pyx_t_1 = NULL;
  PyObject *__pyx_t_2 = NULL;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  int __pyx_t_5;
  PyObject *__pyx_t_6 = NULL;
  PyObject *__pyx_t_7 = NULL;
  PyArrayObject *__pyx_t_8 = NULL;
  PyArrayObject *__pyx_t_9 = NULL;
  long __pyx_t_10;
  Py_ssize_t __pyx_t_11;
  int __pyx_t_12;
  int __pyx_t_13;
  __Pyx_RefNannySetupContext("params_vect2arrays", 0);
  __pyx_pybuffer_stars_p.pybuffer.buf = NULL;
  __pyx_pybuffer_stars_p.refcount = 0;
  __pyx_pybuffernd_stars_p.data = NULL;
  __pyx_pybuffernd_stars_p.rcbuffer = &__pyx_pybuffer_stars_p;
  __pyx_pybuffer_cov_p.pybuffer.buf = NULL;
  __pyx_pybuffer_cov_p.refcount = 0;
  __pyx_pybuffernd_cov_p.data = NULL;
  __pyx_pybuffernd_cov_p.rcbuffer = &__pyx_pybuffer_cov_p;
  __pyx_pybuffer_free_p.pybuffer.buf = NULL;
  __pyx_pybuffer_free_p.refcount = 0;
  __pyx_pybuffernd_free_p.data = NULL;
  __pyx_pybuffernd_free_p.rcbuffer = &__pyx_pybuffer_free_p;
  __pyx_pybuffer_fixed_p.pybuffer.buf = NULL;
  __pyx_pybuffer_fixed_p.refcount = 0;
  __pyx_pybuffernd_fixed_p.data = NULL;
  __pyx_pybuffernd_fixed_p.rcbuffer = &__pyx_pybuffer_fixed_p;
  __pyx_pybuffer_stars_p_mask.pybuffer.buf = NULL;
  __pyx_pybuffer_stars_p_mask.refcount = 0;
  __pyx_pybuffernd_stars_p_mask.data = NULL;
  __pyx_pybuffernd_stars_p_mask.rcbuffer = &__pyx_pybuffer_stars_p_mask;
  __pyx_pybuffer_cov_p_mask.pybuffer.buf = NULL;
  __pyx_pybuffer_cov_p_mask.refcount = 0;
  __pyx_pybuffernd_cov_p_mask.data = NULL;
  __pyx_pybuffernd_cov_p_mask.rcbuffer = &__pyx_pybuffer_cov_p_mask;
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_free_p.rcbuffer->pybuffer, (PyObject*)__pyx_v_free_p, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) __PYX_ERR(0, 1334, __pyx_L1_error)
  }
  __pyx_pybuffernd_free_p.diminfo[0].strides = __pyx_pybuffernd_free_p.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_free_p.diminfo[0].shape = __pyx_pybuffernd_free_p.rcbuffer->pybuffer.shape[0];
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_fixed_p.rcbuffer->pybuffer, (PyObject*)__pyx_v_fixed_p, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) __PYX_ERR(0, 1334, __pyx_L1_error)
  }
  __pyx_pybuffernd_fixed_p.diminfo[0].strides = __pyx_pybuffernd_fixed_p.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_fixed_p.diminfo[0].shape = __pyx_pybuffernd_fixed_p.rcbuffer->pybuffer.shape[0];
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_stars_p_mask.rcbuffer->pybuffer, (PyObject*)__pyx_v_stars_p_mask, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) __PYX_ERR(0, 1334, __pyx_L1_error)
  }
  __pyx_pybuffernd_stars_p_mask.diminfo[0].strides = __pyx_pybuffernd_stars_p_mask.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_stars_p_mask.diminfo[0].shape = __pyx_pybuffernd_stars_p_mask.rcbuffer->pybuffer.shape[0];
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_cov_p_mask.rcbuffer->pybuffer, (PyObject*)__pyx_v_cov_p_mask, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) __PYX_ERR(0, 1334, __pyx_L1_error)
  }
  __pyx_pybuffernd_cov_p_mask.diminfo[0].strides = __pyx_pybuffernd_cov_p_mask.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_cov_p_mask.diminfo[0].shape = __pyx_pybuffernd_cov_p_mask.rcbuffer->pybuffer.shape[0];

  /* "orb/cutils.pyx":1340
 *                            int star_nb):
 * 
 *         cdef int stars_free_p_nb = bn.nansum(stars_p_mask)             # <<<<<<<<<<<<<<
 *         cdef int cov_free_p_nb = bn.nansum(cov_p_mask)
 *         cdef np.ndarray[np.float64_t, ndim=2] stars_p = np.zeros(
 */
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1340, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_nansum); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1340, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_3))) {
    __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_3);
    if (likely(__pyx_t_2)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
      __Pyx_INCREF(__pyx_t_2);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_3, function);
    }
  }
  if (!__pyx_t_2) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_3, ((PyObject *)__pyx_v_stars_p_mask)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1340, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_4 = PyTuple_New(1+1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1340, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_2); __pyx_t_2 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_stars_p_mask));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_stars_p_mask));
    PyTuple_SET_ITEM(__pyx_t_4, 0+1, ((PyObject *)__pyx_v_stars_p_mask));
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_4, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1340, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  }
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_5 = __Pyx_PyInt_As_int(__pyx_t_1); if (unlikely((__pyx_t_5 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 1340, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_v_stars_free_p_nb = __pyx_t_5;

  /* "orb/cutils.pyx":1341
 * 
 *         cdef int stars_free_p_nb = bn.nansum(stars_p_mask)
 *         cdef int cov_free_p_nb = bn.nansum(cov_p_mask)             # <<<<<<<<<<<<<<
 *         cdef np.ndarray[np.float64_t, ndim=2] stars_p = np.zeros(
 *             (star_nb, np.size(stars_p_mask)), dtype=float)
 */
  __pyx_t_3 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1341, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_nansum); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1341, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_3 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_4))) {
    __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_4);
    if (likely(__pyx_t_3)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
      __Pyx_INCREF(__pyx_t_3);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_4, function);
    }
  }
  if (!__pyx_t_3) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_4, ((PyObject *)__pyx_v_cov_p_mask)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1341, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_2 = PyTuple_New(1+1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1341, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_3); __pyx_t_3 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_cov_p_mask));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_cov_p_mask));
    PyTuple_SET_ITEM(__pyx_t_2, 0+1, ((PyObject *)__pyx_v_cov_p_mask));
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_2, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1341, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  }
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_5 = __Pyx_PyInt_As_int(__pyx_t_1); if (unlikely((__pyx_t_5 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 1341, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_v_cov_free_p_nb = __pyx_t_5;

  /* "orb/cutils.pyx":1342
 *         cdef int stars_free_p_nb = bn.nansum(stars_p_mask)
 *         cdef int cov_free_p_nb = bn.nansum(cov_p_mask)
 *         cdef np.ndarray[np.float64_t, ndim=2] stars_p = np.zeros(             # <<<<<<<<<<<<<<
 *             (star_nb, np.size(stars_p_mask)), dtype=float)
 *         cdef np.ndarray[np.float64_t, ndim=1] cov_p = np.zeros(
 */
  __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1342, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_zeros); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1342, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1343
 *         cdef int cov_free_p_nb = bn.nansum(cov_p_mask)
 *         cdef np.ndarray[np.float64_t, ndim=2] stars_p = np.zeros(
 *             (star_nb, np.size(stars_p_mask)), dtype=float)             # <<<<<<<<<<<<<<
 *         cdef np.ndarray[np.float64_t, ndim=1] cov_p = np.zeros(
 *             np.size(cov_p_mask), dtype=float)
 */
  __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_star_nb); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1343, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_3 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1343, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_size); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1343, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_3 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_6))) {
    __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_6);
    if (likely(__pyx_t_3)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_6);
      __Pyx_INCREF(__pyx_t_3);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_6, function);
    }
  }
  if (!__pyx_t_3) {
    __pyx_t_2 = __Pyx_PyObject_CallOneArg(__pyx_t_6, ((PyObject *)__pyx_v_stars_p_mask)); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1343, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
  } else {
    __pyx_t_7 = PyTuple_New(1+1); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 1343, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_7);
    __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_7, 0, __pyx_t_3); __pyx_t_3 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_stars_p_mask));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_stars_p_mask));
    PyTuple_SET_ITEM(__pyx_t_7, 0+1, ((PyObject *)__pyx_v_stars_p_mask));
    __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_6, __pyx_t_7, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1343, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
  }
  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
  __pyx_t_6 = PyTuple_New(2); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1343, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __Pyx_GIVEREF(__pyx_t_1);
  PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_1);
  __Pyx_GIVEREF(__pyx_t_2);
  PyTuple_SET_ITEM(__pyx_t_6, 1, __pyx_t_2);
  __pyx_t_1 = 0;
  __pyx_t_2 = 0;

  /* "orb/cutils.pyx":1342
 *         cdef int stars_free_p_nb = bn.nansum(stars_p_mask)
 *         cdef int cov_free_p_nb = bn.nansum(cov_p_mask)
 *         cdef np.ndarray[np.float64_t, ndim=2] stars_p = np.zeros(             # <<<<<<<<<<<<<<
 *             (star_nb, np.size(stars_p_mask)), dtype=float)
 *         cdef np.ndarray[np.float64_t, ndim=1] cov_p = np.zeros(
 */
  __pyx_t_2 = PyTuple_New(1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1342, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_GIVEREF(__pyx_t_6);
  PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_6);
  __pyx_t_6 = 0;

  /* "orb/cutils.pyx":1343
 *         cdef int cov_free_p_nb = bn.nansum(cov_p_mask)
 *         cdef np.ndarray[np.float64_t, ndim=2] stars_p = np.zeros(
 *             (star_nb, np.size(stars_p_mask)), dtype=float)             # <<<<<<<<<<<<<<
 *         cdef np.ndarray[np.float64_t, ndim=1] cov_p = np.zeros(
 *             np.size(cov_p_mask), dtype=float)
 */
  __pyx_t_6 = PyDict_New(); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1343, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  if (PyDict_SetItem(__pyx_t_6, __pyx_n_s_dtype, ((PyObject *)(&PyFloat_Type))) < 0) __PYX_ERR(0, 1343, __pyx_L1_error)

  /* "orb/cutils.pyx":1342
 *         cdef int stars_free_p_nb = bn.nansum(stars_p_mask)
 *         cdef int cov_free_p_nb = bn.nansum(cov_p_mask)
 *         cdef np.ndarray[np.float64_t, ndim=2] stars_p = np.zeros(             # <<<<<<<<<<<<<<
 *             (star_nb, np.size(stars_p_mask)), dtype=float)
 *         cdef np.ndarray[np.float64_t, ndim=1] cov_p = np.zeros(
 */
  __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_2, __pyx_t_6); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1342, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1342, __pyx_L1_error)
  __pyx_t_8 = ((PyArrayObject *)__pyx_t_1);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_stars_p.rcbuffer->pybuffer, (PyObject*)__pyx_t_8, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
      __pyx_v_stars_p = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_stars_p.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 1342, __pyx_L1_error)
    } else {__pyx_pybuffernd_stars_p.diminfo[0].strides = __pyx_pybuffernd_stars_p.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_stars_p.diminfo[0].shape = __pyx_pybuffernd_stars_p.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_stars_p.diminfo[1].strides = __pyx_pybuffernd_stars_p.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_stars_p.diminfo[1].shape = __pyx_pybuffernd_stars_p.rcbuffer->pybuffer.shape[1];
    }
  }
  __pyx_t_8 = 0;
  __pyx_v_stars_p = ((PyArrayObject *)__pyx_t_1);
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1344
 *         cdef np.ndarray[np.float64_t, ndim=2] stars_p = np.zeros(
 *             (star_nb, np.size(stars_p_mask)), dtype=float)
 *         cdef np.ndarray[np.float64_t, ndim=1] cov_p = np.zeros(             # <<<<<<<<<<<<<<
 *             np.size(cov_p_mask), dtype=float)
 *         cdef int ip, i, j
 */
  __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1344, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_zeros); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1344, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1345
 *             (star_nb, np.size(stars_p_mask)), dtype=float)
 *         cdef np.ndarray[np.float64_t, ndim=1] cov_p = np.zeros(
 *             np.size(cov_p_mask), dtype=float)             # <<<<<<<<<<<<<<
 *         cdef int ip, i, j
 * 
 */
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1345, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_size); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1345, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_4))) {
    __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_4);
    if (likely(__pyx_t_2)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
      __Pyx_INCREF(__pyx_t_2);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_4, function);
    }
  }
  if (!__pyx_t_2) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_4, ((PyObject *)__pyx_v_cov_p_mask)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1345, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_7 = PyTuple_New(1+1); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 1345, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_7);
    __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_7, 0, __pyx_t_2); __pyx_t_2 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_cov_p_mask));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_cov_p_mask));
    PyTuple_SET_ITEM(__pyx_t_7, 0+1, ((PyObject *)__pyx_v_cov_p_mask));
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_7, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1345, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
  }
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;

  /* "orb/cutils.pyx":1344
 *         cdef np.ndarray[np.float64_t, ndim=2] stars_p = np.zeros(
 *             (star_nb, np.size(stars_p_mask)), dtype=float)
 *         cdef np.ndarray[np.float64_t, ndim=1] cov_p = np.zeros(             # <<<<<<<<<<<<<<
 *             np.size(cov_p_mask), dtype=float)
 *         cdef int ip, i, j
 */
  __pyx_t_4 = PyTuple_New(1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1344, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_GIVEREF(__pyx_t_1);
  PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_1);
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1345
 *             (star_nb, np.size(stars_p_mask)), dtype=float)
 *         cdef np.ndarray[np.float64_t, ndim=1] cov_p = np.zeros(
 *             np.size(cov_p_mask), dtype=float)             # <<<<<<<<<<<<<<
 *         cdef int ip, i, j
 * 
 */
  __pyx_t_1 = PyDict_New(); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1345, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if (PyDict_SetItem(__pyx_t_1, __pyx_n_s_dtype, ((PyObject *)(&PyFloat_Type))) < 0) __PYX_ERR(0, 1345, __pyx_L1_error)

  /* "orb/cutils.pyx":1344
 *         cdef np.ndarray[np.float64_t, ndim=2] stars_p = np.zeros(
 *             (star_nb, np.size(stars_p_mask)), dtype=float)
 *         cdef np.ndarray[np.float64_t, ndim=1] cov_p = np.zeros(             # <<<<<<<<<<<<<<
 *             np.size(cov_p_mask), dtype=float)
 *         cdef int ip, i, j
 */
  __pyx_t_7 = __Pyx_PyObject_Call(__pyx_t_6, __pyx_t_4, __pyx_t_1); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 1344, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_7);
  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  if (!(likely(((__pyx_t_7) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_7, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1344, __pyx_L1_error)
  __pyx_t_9 = ((PyArrayObject *)__pyx_t_7);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_cov_p.rcbuffer->pybuffer, (PyObject*)__pyx_t_9, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
      __pyx_v_cov_p = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 1344, __pyx_L1_error)
    } else {__pyx_pybuffernd_cov_p.diminfo[0].strides = __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_cov_p.diminfo[0].shape = __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.shape[0];
    }
  }
  __pyx_t_9 = 0;
  __pyx_v_cov_p = ((PyArrayObject *)__pyx_t_7);
  __pyx_t_7 = 0;

  /* "orb/cutils.pyx":1348
 *         cdef int ip, i, j
 * 
 *         i = 0             # <<<<<<<<<<<<<<
 *         j = 0
 *         for ip in range(np.size(stars_p_mask)):
 */
  __pyx_v_i = 0;

  /* "orb/cutils.pyx":1349
 * 
 *         i = 0
 *         j = 0             # <<<<<<<<<<<<<<
 *         for ip in range(np.size(stars_p_mask)):
 *             if stars_p_mask[ip] == 1:
 */
  __pyx_v_j = 0;

  /* "orb/cutils.pyx":1350
 *         i = 0
 *         j = 0
 *         for ip in range(np.size(stars_p_mask)):             # <<<<<<<<<<<<<<
 *             if stars_p_mask[ip] == 1:
 *                 stars_p[:,ip] = free_p[i*stars_p.shape[0]:
 */
  __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1350, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_size); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1350, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_1 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_4))) {
    __pyx_t_1 = PyMethod_GET_SELF(__pyx_t_4);
    if (likely(__pyx_t_1)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
      __Pyx_INCREF(__pyx_t_1);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_4, function);
    }
  }
  if (!__pyx_t_1) {
    __pyx_t_7 = __Pyx_PyObject_CallOneArg(__pyx_t_4, ((PyObject *)__pyx_v_stars_p_mask)); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 1350, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_7);
  } else {
    __pyx_t_6 = PyTuple_New(1+1); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1350, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
    __Pyx_GIVEREF(__pyx_t_1); PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_1); __pyx_t_1 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_stars_p_mask));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_stars_p_mask));
    PyTuple_SET_ITEM(__pyx_t_6, 0+1, ((PyObject *)__pyx_v_stars_p_mask));
    __pyx_t_7 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_6, NULL); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 1350, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_7);
    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
  }
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_10 = __Pyx_PyInt_As_long(__pyx_t_7); if (unlikely((__pyx_t_10 == (long)-1) && PyErr_Occurred())) __PYX_ERR(0, 1350, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
  for (__pyx_t_5 = 0; __pyx_t_5 < __pyx_t_10; __pyx_t_5+=1) {
    __pyx_v_ip = __pyx_t_5;

    /* "orb/cutils.pyx":1351
 *         j = 0
 *         for ip in range(np.size(stars_p_mask)):
 *             if stars_p_mask[ip] == 1:             # <<<<<<<<<<<<<<
 *                 stars_p[:,ip] = free_p[i*stars_p.shape[0]:
 *                                        (i+1)*stars_p.shape[0]]
 */
    __pyx_t_11 = __pyx_v_ip;
    __pyx_t_12 = -1;
    if (__pyx_t_11 < 0) {
      __pyx_t_11 += __pyx_pybuffernd_stars_p_mask.diminfo[0].shape;
      if (unlikely(__pyx_t_11 < 0)) __pyx_t_12 = 0;
    } else if (unlikely(__pyx_t_11 >= __pyx_pybuffernd_stars_p_mask.diminfo[0].shape)) __pyx_t_12 = 0;
    if (unlikely(__pyx_t_12 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_12);
      __PYX_ERR(0, 1351, __pyx_L1_error)
    }
    __pyx_t_13 = (((*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_stars_p_mask.rcbuffer->pybuffer.buf, __pyx_t_11, __pyx_pybuffernd_stars_p_mask.diminfo[0].strides)) == 1.0) != 0);
    if (__pyx_t_13) {

      /* "orb/cutils.pyx":1352
 *         for ip in range(np.size(stars_p_mask)):
 *             if stars_p_mask[ip] == 1:
 *                 stars_p[:,ip] = free_p[i*stars_p.shape[0]:             # <<<<<<<<<<<<<<
 *                                        (i+1)*stars_p.shape[0]]
 *                 i += 1
 */
      __pyx_t_7 = __Pyx_PyObject_GetSlice(((PyObject *)__pyx_v_free_p), (__pyx_v_i * (__pyx_v_stars_p->dimensions[0])), ((__pyx_v_i + 1) * (__pyx_v_stars_p->dimensions[0])), NULL, NULL, NULL, 1, 1, 1); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 1352, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_7);
      __pyx_t_4 = __Pyx_PyInt_From_int(__pyx_v_ip); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1352, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __pyx_t_6 = PyTuple_New(2); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1352, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_6);
      __Pyx_INCREF(__pyx_slice__62);
      __Pyx_GIVEREF(__pyx_slice__62);
      PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_slice__62);
      __Pyx_GIVEREF(__pyx_t_4);
      PyTuple_SET_ITEM(__pyx_t_6, 1, __pyx_t_4);
      __pyx_t_4 = 0;
      if (unlikely(PyObject_SetItem(((PyObject *)__pyx_v_stars_p), __pyx_t_6, __pyx_t_7) < 0)) __PYX_ERR(0, 1352, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
      __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;

      /* "orb/cutils.pyx":1354
 *                 stars_p[:,ip] = free_p[i*stars_p.shape[0]:
 *                                        (i+1)*stars_p.shape[0]]
 *                 i += 1             # <<<<<<<<<<<<<<
 *             else:
 *                 stars_p[:,ip] =  fixed_p[j*stars_p.shape[0]:
 */
      __pyx_v_i = (__pyx_v_i + 1);

      /* "orb/cutils.pyx":1351
 *         j = 0
 *         for ip in range(np.size(stars_p_mask)):
 *             if stars_p_mask[ip] == 1:             # <<<<<<<<<<<<<<
 *                 stars_p[:,ip] = free_p[i*stars_p.shape[0]:
 *                                        (i+1)*stars_p.shape[0]]
 */
      goto __pyx_L5;
    }

    /* "orb/cutils.pyx":1356
 *                 i += 1
 *             else:
 *                 stars_p[:,ip] =  fixed_p[j*stars_p.shape[0]:             # <<<<<<<<<<<<<<
 *                                          (j+1)*stars_p.shape[0]]
 *                 j += 1
 */
    /*else*/ {

      /* "orb/cutils.pyx":1357
 *             else:
 *                 stars_p[:,ip] =  fixed_p[j*stars_p.shape[0]:
 *                                          (j+1)*stars_p.shape[0]]             # <<<<<<<<<<<<<<
 *                 j += 1
 * 
 */
      __pyx_t_7 = __Pyx_PyObject_GetSlice(((PyObject *)__pyx_v_fixed_p), (__pyx_v_j * (__pyx_v_stars_p->dimensions[0])), ((__pyx_v_j + 1) * (__pyx_v_stars_p->dimensions[0])), NULL, NULL, NULL, 1, 1, 1); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 1356, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_7);

      /* "orb/cutils.pyx":1356
 *                 i += 1
 *             else:
 *                 stars_p[:,ip] =  fixed_p[j*stars_p.shape[0]:             # <<<<<<<<<<<<<<
 *                                          (j+1)*stars_p.shape[0]]
 *                 j += 1
 */
      __pyx_t_6 = __Pyx_PyInt_From_int(__pyx_v_ip); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1356, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_6);
      __pyx_t_4 = PyTuple_New(2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1356, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __Pyx_INCREF(__pyx_slice__63);
      __Pyx_GIVEREF(__pyx_slice__63);
      PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_slice__63);
      __Pyx_GIVEREF(__pyx_t_6);
      PyTuple_SET_ITEM(__pyx_t_4, 1, __pyx_t_6);
      __pyx_t_6 = 0;
      if (unlikely(PyObject_SetItem(((PyObject *)__pyx_v_stars_p), __pyx_t_4, __pyx_t_7) < 0)) __PYX_ERR(0, 1356, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;

      /* "orb/cutils.pyx":1358
 *                 stars_p[:,ip] =  fixed_p[j*stars_p.shape[0]:
 *                                          (j+1)*stars_p.shape[0]]
 *                 j += 1             # <<<<<<<<<<<<<<
 * 
 *         if bn.nansum(cov_p_mask > 0):
 */
      __pyx_v_j = (__pyx_v_j + 1);
    }
    __pyx_L5:;
  }

  /* "orb/cutils.pyx":1360
 *                 j += 1
 * 
 *         if bn.nansum(cov_p_mask > 0):             # <<<<<<<<<<<<<<
 *             cov_p[np.nonzero(cov_p_mask)] = free_p[-cov_free_p_nb:]
 *             cov_p[np.nonzero(cov_p_mask == 0)] = fixed_p[
 */
  __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1360, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_nansum); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1360, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_4 = PyObject_RichCompare(((PyObject *)__pyx_v_cov_p_mask), __pyx_int_0, Py_GT); __Pyx_XGOTREF(__pyx_t_4); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1360, __pyx_L1_error)
  __pyx_t_1 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_6))) {
    __pyx_t_1 = PyMethod_GET_SELF(__pyx_t_6);
    if (likely(__pyx_t_1)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_6);
      __Pyx_INCREF(__pyx_t_1);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_6, function);
    }
  }
  if (!__pyx_t_1) {
    __pyx_t_7 = __Pyx_PyObject_CallOneArg(__pyx_t_6, __pyx_t_4); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 1360, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __Pyx_GOTREF(__pyx_t_7);
  } else {
    __pyx_t_2 = PyTuple_New(1+1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1360, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_GIVEREF(__pyx_t_1); PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_1); __pyx_t_1 = NULL;
    __Pyx_GIVEREF(__pyx_t_4);
    PyTuple_SET_ITEM(__pyx_t_2, 0+1, __pyx_t_4);
    __pyx_t_4 = 0;
    __pyx_t_7 = __Pyx_PyObject_Call(__pyx_t_6, __pyx_t_2, NULL); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 1360, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_7);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  }
  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
  __pyx_t_13 = __Pyx_PyObject_IsTrue(__pyx_t_7); if (unlikely(__pyx_t_13 < 0)) __PYX_ERR(0, 1360, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
  if (__pyx_t_13) {

    /* "orb/cutils.pyx":1361
 * 
 *         if bn.nansum(cov_p_mask > 0):
 *             cov_p[np.nonzero(cov_p_mask)] = free_p[-cov_free_p_nb:]             # <<<<<<<<<<<<<<
 *             cov_p[np.nonzero(cov_p_mask == 0)] = fixed_p[
 *                 -(np.size(cov_p)-cov_free_p_nb):]
 */
    __pyx_t_7 = __Pyx_PyObject_GetSlice(((PyObject *)__pyx_v_free_p), (-__pyx_v_cov_free_p_nb), 0, NULL, NULL, NULL, 1, 0, 1); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 1361, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_7);
    __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1361, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_nonzero); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1361, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __pyx_t_2 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_4))) {
      __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_4);
      if (likely(__pyx_t_2)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
        __Pyx_INCREF(__pyx_t_2);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_4, function);
      }
    }
    if (!__pyx_t_2) {
      __pyx_t_6 = __Pyx_PyObject_CallOneArg(__pyx_t_4, ((PyObject *)__pyx_v_cov_p_mask)); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1361, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_6);
    } else {
      __pyx_t_1 = PyTuple_New(1+1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1361, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);
      __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_1, 0, __pyx_t_2); __pyx_t_2 = NULL;
      __Pyx_INCREF(((PyObject *)__pyx_v_cov_p_mask));
      __Pyx_GIVEREF(((PyObject *)__pyx_v_cov_p_mask));
      PyTuple_SET_ITEM(__pyx_t_1, 0+1, ((PyObject *)__pyx_v_cov_p_mask));
      __pyx_t_6 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_1, NULL); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1361, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_6);
      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    }
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    if (unlikely(PyObject_SetItem(((PyObject *)__pyx_v_cov_p), __pyx_t_6, __pyx_t_7) < 0)) __PYX_ERR(0, 1361, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
    __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;

    /* "orb/cutils.pyx":1363
 *             cov_p[np.nonzero(cov_p_mask)] = free_p[-cov_free_p_nb:]
 *             cov_p[np.nonzero(cov_p_mask == 0)] = fixed_p[
 *                 -(np.size(cov_p)-cov_free_p_nb):]             # <<<<<<<<<<<<<<
 * 
 *         return stars_p, cov_p
 */
    __pyx_t_6 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1363, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_6, __pyx_n_s_size); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1363, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
    __pyx_t_6 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_4))) {
      __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_4);
      if (likely(__pyx_t_6)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
        __Pyx_INCREF(__pyx_t_6);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_4, function);
      }
    }
    if (!__pyx_t_6) {
      __pyx_t_7 = __Pyx_PyObject_CallOneArg(__pyx_t_4, ((PyObject *)__pyx_v_cov_p)); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 1363, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_7);
    } else {
      __pyx_t_1 = PyTuple_New(1+1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1363, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);
      __Pyx_GIVEREF(__pyx_t_6); PyTuple_SET_ITEM(__pyx_t_1, 0, __pyx_t_6); __pyx_t_6 = NULL;
      __Pyx_INCREF(((PyObject *)__pyx_v_cov_p));
      __Pyx_GIVEREF(((PyObject *)__pyx_v_cov_p));
      PyTuple_SET_ITEM(__pyx_t_1, 0+1, ((PyObject *)__pyx_v_cov_p));
      __pyx_t_7 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_1, NULL); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 1363, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_7);
      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    }
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_t_4 = __Pyx_PyInt_From_int(__pyx_v_cov_free_p_nb); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1363, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __pyx_t_1 = PyNumber_Subtract(__pyx_t_7, __pyx_t_4); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1363, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_t_4 = PyNumber_Negative(__pyx_t_1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1363, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

    /* "orb/cutils.pyx":1362
 *         if bn.nansum(cov_p_mask > 0):
 *             cov_p[np.nonzero(cov_p_mask)] = free_p[-cov_free_p_nb:]
 *             cov_p[np.nonzero(cov_p_mask == 0)] = fixed_p[             # <<<<<<<<<<<<<<
 *                 -(np.size(cov_p)-cov_free_p_nb):]
 * 
 */
    __pyx_t_1 = __Pyx_PyObject_GetSlice(((PyObject *)__pyx_v_fixed_p), 0, 0, &__pyx_t_4, NULL, NULL, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1362, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_t_7 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 1362, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_7);
    __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_t_7, __pyx_n_s_nonzero); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1362, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
    __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
    __pyx_t_7 = PyObject_RichCompare(((PyObject *)__pyx_v_cov_p_mask), __pyx_int_0, Py_EQ); __Pyx_XGOTREF(__pyx_t_7); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 1362, __pyx_L1_error)
    __pyx_t_2 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_6))) {
      __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_6);
      if (likely(__pyx_t_2)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_6);
        __Pyx_INCREF(__pyx_t_2);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_6, function);
      }
    }
    if (!__pyx_t_2) {
      __pyx_t_4 = __Pyx_PyObject_CallOneArg(__pyx_t_6, __pyx_t_7); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1362, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
      __Pyx_GOTREF(__pyx_t_4);
    } else {
      __pyx_t_3 = PyTuple_New(1+1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1362, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_2); __pyx_t_2 = NULL;
      __Pyx_GIVEREF(__pyx_t_7);
      PyTuple_SET_ITEM(__pyx_t_3, 0+1, __pyx_t_7);
      __pyx_t_7 = 0;
      __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_6, __pyx_t_3, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1362, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    }
    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
    if (unlikely(PyObject_SetItem(((PyObject *)__pyx_v_cov_p), __pyx_t_4, __pyx_t_1) < 0)) __PYX_ERR(0, 1362, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

    /* "orb/cutils.pyx":1360
 *                 j += 1
 * 
 *         if bn.nansum(cov_p_mask > 0):             # <<<<<<<<<<<<<<
 *             cov_p[np.nonzero(cov_p_mask)] = free_p[-cov_free_p_nb:]
 *             cov_p[np.nonzero(cov_p_mask == 0)] = fixed_p[
 */
  }

  /* "orb/cutils.pyx":1365
 *                 -(np.size(cov_p)-cov_free_p_nb):]
 * 
 *         return stars_p, cov_p             # <<<<<<<<<<<<<<
 * 
 *     def sigma(np.ndarray[np.float64_t, ndim=2] data,
 */
  __Pyx_XDECREF(__pyx_r);
  __pyx_t_1 = PyTuple_New(2); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1365, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_INCREF(((PyObject *)__pyx_v_stars_p));
  __Pyx_GIVEREF(((PyObject *)__pyx_v_stars_p));
  PyTuple_SET_ITEM(__pyx_t_1, 0, ((PyObject *)__pyx_v_stars_p));
  __Pyx_INCREF(((PyObject *)__pyx_v_cov_p));
  __Pyx_GIVEREF(((PyObject *)__pyx_v_cov_p));
  PyTuple_SET_ITEM(__pyx_t_1, 1, ((PyObject *)__pyx_v_cov_p));
  __pyx_r = __pyx_t_1;
  __pyx_t_1 = 0;
  goto __pyx_L0;

  /* "orb/cutils.pyx":1334
 *         return free_p, fixed_p
 * 
 *     def params_vect2arrays(np.ndarray[np.float64_t, ndim=1] free_p,             # <<<<<<<<<<<<<<
 *                            np.ndarray[np.float64_t, ndim=1] fixed_p,
 *                            np.ndarray[np.float64_t, ndim=1] stars_p_mask,
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_1);
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_XDECREF(__pyx_t_6);
  __Pyx_XDECREF(__pyx_t_7);
  { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
    __Pyx_PyThreadState_declare
    __Pyx_PyThreadState_assign
    __Pyx_ErrFetch(&__pyx_type, &__pyx_value, &__pyx_tb);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_cov_p.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_cov_p_mask.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_fixed_p.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_free_p.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_stars_p.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_stars_p_mask.rcbuffer->pybuffer);
  __Pyx_ErrRestore(__pyx_type, __pyx_value, __pyx_tb);}
  __Pyx_AddTraceback("orb.cutils.multi_fit_stars.params_vect2arrays", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  goto __pyx_L2;
  __pyx_L0:;
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_cov_p.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_cov_p_mask.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_fixed_p.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_free_p.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_stars_p.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_stars_p_mask.rcbuffer->pybuffer);
  __pyx_L2:;
  __Pyx_XDECREF((PyObject *)__pyx_v_stars_p);
  __Pyx_XDECREF((PyObject *)__pyx_v_cov_p);
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":1367
 *         return stars_p, cov_p
 * 
 *     def sigma(np.ndarray[np.float64_t, ndim=2] data,             # <<<<<<<<<<<<<<
 *               double noise, double dcl):
 *         """guess sigma as sqrt(photon noise + readout noise^2 + dark
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_15multi_fit_stars_5sigma(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_3orb_6cutils_15multi_fit_stars_4sigma[] = "guess sigma as sqrt(photon noise + readout noise^2 + dark\n        current level)";
static PyMethodDef __pyx_mdef_3orb_6cutils_15multi_fit_stars_5sigma = {"sigma", (PyCFunction)__pyx_pw_3orb_6cutils_15multi_fit_stars_5sigma, METH_VARARGS|METH_KEYWORDS, __pyx_doc_3orb_6cutils_15multi_fit_stars_4sigma};
static PyObject *__pyx_pw_3orb_6cutils_15multi_fit_stars_5sigma(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  PyArrayObject *__pyx_v_data = 0;
  double __pyx_v_noise;
  double __pyx_v_dcl;
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("sigma (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_data,&__pyx_n_s_noise,&__pyx_n_s_dcl,0};
    PyObject* values[3] = {0,0,0};
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
      switch (pos_args) {
        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = PyDict_Size(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_data)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        case  1:
        if (likely((values[1] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_noise)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("sigma", 1, 3, 3, 1); __PYX_ERR(0, 1367, __pyx_L3_error)
        }
        case  2:
        if (likely((values[2] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_dcl)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("sigma", 1, 3, 3, 2); __PYX_ERR(0, 1367, __pyx_L3_error)
        }
      }
      if (unlikely(kw_args > 0)) {
        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "sigma") < 0)) __PYX_ERR(0, 1367, __pyx_L3_error)
      }
    } else if (PyTuple_GET_SIZE(__pyx_args) != 3) {
      goto __pyx_L5_argtuple_error;
    } else {
      values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
      values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
      values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
    }
    __pyx_v_data = ((PyArrayObject *)values[0]);
    __pyx_v_noise = __pyx_PyFloat_AsDouble(values[1]); if (unlikely((__pyx_v_noise == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 1368, __pyx_L3_error)
    __pyx_v_dcl = __pyx_PyFloat_AsDouble(values[2]); if (unlikely((__pyx_v_dcl == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 1368, __pyx_L3_error)
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  __Pyx_RaiseArgtupleInvalid("sigma", 1, 3, 3, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 1367, __pyx_L3_error)
  __pyx_L3_error:;
  __Pyx_AddTraceback("orb.cutils.multi_fit_stars.sigma", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __Pyx_RefNannyFinishContext();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_data), __pyx_ptype_5numpy_ndarray, 1, "data", 0))) __PYX_ERR(0, 1367, __pyx_L1_error)
  __pyx_r = __pyx_pf_3orb_6cutils_15multi_fit_stars_4sigma(__pyx_self, __pyx_v_data, __pyx_v_noise, __pyx_v_dcl);

  /* function exit code */
  goto __pyx_L0;
  __pyx_L1_error:;
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_15multi_fit_stars_4sigma(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_data, double __pyx_v_noise, double __pyx_v_dcl) {
  __Pyx_LocalBuf_ND __pyx_pybuffernd_data;
  __Pyx_Buffer __pyx_pybuffer_data;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  PyObject *__pyx_t_1 = NULL;
  PyObject *__pyx_t_2 = NULL;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  PyObject *__pyx_t_5 = NULL;
  PyObject *__pyx_t_6 = NULL;
  __Pyx_RefNannySetupContext("sigma", 0);
  __pyx_pybuffer_data.pybuffer.buf = NULL;
  __pyx_pybuffer_data.refcount = 0;
  __pyx_pybuffernd_data.data = NULL;
  __pyx_pybuffernd_data.rcbuffer = &__pyx_pybuffer_data;
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_data.rcbuffer->pybuffer, (PyObject*)__pyx_v_data, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) __PYX_ERR(0, 1367, __pyx_L1_error)
  }
  __pyx_pybuffernd_data.diminfo[0].strides = __pyx_pybuffernd_data.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_data.diminfo[0].shape = __pyx_pybuffernd_data.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_data.diminfo[1].strides = __pyx_pybuffernd_data.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_data.diminfo[1].shape = __pyx_pybuffernd_data.rcbuffer->pybuffer.shape[1];

  /* "orb/cutils.pyx":1371
 *         """guess sigma as sqrt(photon noise + readout noise^2 + dark
 *         current level)"""
 *         return np.sqrt(np.abs(data) + (noise)**2. + dcl)             # <<<<<<<<<<<<<<
 * 
 *     def model_diff(int dimx, int dimy, np.ndarray[np.float64_t, ndim=2] params,
 */
  __Pyx_XDECREF(__pyx_r);
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1371, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_sqrt); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1371, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1371, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_abs); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1371, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_4 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_5))) {
    __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_5);
    if (likely(__pyx_t_4)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_5);
      __Pyx_INCREF(__pyx_t_4);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_5, function);
    }
  }
  if (!__pyx_t_4) {
    __pyx_t_2 = __Pyx_PyObject_CallOneArg(__pyx_t_5, ((PyObject *)__pyx_v_data)); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1371, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
  } else {
    __pyx_t_6 = PyTuple_New(1+1); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1371, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
    __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_4); __pyx_t_4 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_data));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_data));
    PyTuple_SET_ITEM(__pyx_t_6, 0+1, ((PyObject *)__pyx_v_data));
    __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_6, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1371, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
  }
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_5 = PyFloat_FromDouble(pow(__pyx_v_noise, 2.)); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1371, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_6 = PyNumber_Add(__pyx_t_2, __pyx_t_5); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1371, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_5 = PyFloat_FromDouble(__pyx_v_dcl); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1371, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_2 = PyNumber_Add(__pyx_t_6, __pyx_t_5); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1371, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_5 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_3))) {
    __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_3);
    if (likely(__pyx_t_5)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
      __Pyx_INCREF(__pyx_t_5);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_3, function);
    }
  }
  if (!__pyx_t_5) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_3, __pyx_t_2); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1371, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_6 = PyTuple_New(1+1); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1371, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
    __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_5); __pyx_t_5 = NULL;
    __Pyx_GIVEREF(__pyx_t_2);
    PyTuple_SET_ITEM(__pyx_t_6, 0+1, __pyx_t_2);
    __pyx_t_2 = 0;
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_6, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1371, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
  }
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_r = __pyx_t_1;
  __pyx_t_1 = 0;
  goto __pyx_L0;

  /* "orb/cutils.pyx":1367
 *         return stars_p, cov_p
 * 
 *     def sigma(np.ndarray[np.float64_t, ndim=2] data,             # <<<<<<<<<<<<<<
 *               double noise, double dcl):
 *         """guess sigma as sqrt(photon noise + readout noise^2 + dark
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_1);
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_XDECREF(__pyx_t_5);
  __Pyx_XDECREF(__pyx_t_6);
  { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
    __Pyx_PyThreadState_declare
    __Pyx_PyThreadState_assign
    __Pyx_ErrFetch(&__pyx_type, &__pyx_value, &__pyx_tb);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_data.rcbuffer->pybuffer);
  __Pyx_ErrRestore(__pyx_type, __pyx_value, __pyx_tb);}
  __Pyx_AddTraceback("orb.cutils.multi_fit_stars.sigma", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  goto __pyx_L2;
  __pyx_L0:;
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_data.rcbuffer->pybuffer);
  __pyx_L2:;
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":1373
 *         return np.sqrt(np.abs(data) + (noise)**2. + dcl)
 * 
 *     def model_diff(int dimx, int dimy, np.ndarray[np.float64_t, ndim=2] params,             # <<<<<<<<<<<<<<
 *                    int box_size, np.ndarray[np.float64_t, ndim=2] frame,
 *                    np.ndarray[np.float64_t, ndim=1] noise, double dcl,
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_15multi_fit_stars_7model_diff(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_3orb_6cutils_15multi_fit_stars_6model_diff[] = "params is an array (star_nb, 5) with the 5 parameters of\n        each star in this order : height, amplitude, posx, posy, fwhm\n        ";
static PyMethodDef __pyx_mdef_3orb_6cutils_15multi_fit_stars_7model_diff = {"model_diff", (PyCFunction)__pyx_pw_3orb_6cutils_15multi_fit_stars_7model_diff, METH_VARARGS|METH_KEYWORDS, __pyx_doc_3orb_6cutils_15multi_fit_stars_6model_diff};
static PyObject *__pyx_pw_3orb_6cutils_15multi_fit_stars_7model_diff(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  int __pyx_v_dimx;
  int __pyx_v_dimy;
  PyArrayObject *__pyx_v_params = 0;
  int __pyx_v_box_size;
  PyArrayObject *__pyx_v_frame = 0;
  CYTHON_UNUSED PyArrayObject *__pyx_v_noise = 0;
  CYTHON_UNUSED double __pyx_v_dcl;
  double __pyx_v_saturation;
  PyObject *__pyx_v_transpose = 0;
  PyObject *__pyx_v_normalize = 0;
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("model_diff (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_dimx,&__pyx_n_s_dimy,&__pyx_n_s_params,&__pyx_n_s_box_size,&__pyx_n_s_frame,&__pyx_n_s_noise,&__pyx_n_s_dcl,&__pyx_n_s_saturation,&__pyx_n_s_transpose,&__pyx_n_s_normalize,0};
    PyObject* values[10] = {0,0,0,0,0,0,0,0,0,0};

    /* "orb/cutils.pyx":1376
 *                    int box_size, np.ndarray[np.float64_t, ndim=2] frame,
 *                    np.ndarray[np.float64_t, ndim=1] noise, double dcl,
 *                    double saturation, transpose=False, normalize=False):             # <<<<<<<<<<<<<<
 *         """params is an array (star_nb, 5) with the 5 parameters of
 *         each star in this order : height, amplitude, posx, posy, fwhm
 */
    values[8] = ((PyObject *)((PyObject *)Py_False));
    values[9] = ((PyObject *)((PyObject *)Py_False));
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
      switch (pos_args) {
        case 10: values[9] = PyTuple_GET_ITEM(__pyx_args, 9);
        case  9: values[8] = PyTuple_GET_ITEM(__pyx_args, 8);
        case  8: values[7] = PyTuple_GET_ITEM(__pyx_args, 7);
        case  7: values[6] = PyTuple_GET_ITEM(__pyx_args, 6);
        case  6: values[5] = PyTuple_GET_ITEM(__pyx_args, 5);
        case  5: values[4] = PyTuple_GET_ITEM(__pyx_args, 4);
        case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = PyDict_Size(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_dimx)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        case  1:
        if (likely((values[1] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_dimy)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("model_diff", 0, 8, 10, 1); __PYX_ERR(0, 1373, __pyx_L3_error)
        }
        case  2:
        if (likely((values[2] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_params)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("model_diff", 0, 8, 10, 2); __PYX_ERR(0, 1373, __pyx_L3_error)
        }
        case  3:
        if (likely((values[3] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_box_size)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("model_diff", 0, 8, 10, 3); __PYX_ERR(0, 1373, __pyx_L3_error)
        }
        case  4:
        if (likely((values[4] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_frame)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("model_diff", 0, 8, 10, 4); __PYX_ERR(0, 1373, __pyx_L3_error)
        }
        case  5:
        if (likely((values[5] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_noise)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("model_diff", 0, 8, 10, 5); __PYX_ERR(0, 1373, __pyx_L3_error)
        }
        case  6:
        if (likely((values[6] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_dcl)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("model_diff", 0, 8, 10, 6); __PYX_ERR(0, 1373, __pyx_L3_error)
        }
        case  7:
        if (likely((values[7] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_saturation)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("model_diff", 0, 8, 10, 7); __PYX_ERR(0, 1373, __pyx_L3_error)
        }
        case  8:
        if (kw_args > 0) {
          PyObject* value = PyDict_GetItem(__pyx_kwds, __pyx_n_s_transpose);
          if (value) { values[8] = value; kw_args--; }
        }
        case  9:
        if (kw_args > 0) {
          PyObject* value = PyDict_GetItem(__pyx_kwds, __pyx_n_s_normalize);
          if (value) { values[9] = value; kw_args--; }
        }
      }
      if (unlikely(kw_args > 0)) {
        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "model_diff") < 0)) __PYX_ERR(0, 1373, __pyx_L3_error)
      }
    } else {
      switch (PyTuple_GET_SIZE(__pyx_args)) {
        case 10: values[9] = PyTuple_GET_ITEM(__pyx_args, 9);
        case  9: values[8] = PyTuple_GET_ITEM(__pyx_args, 8);
        case  8: values[7] = PyTuple_GET_ITEM(__pyx_args, 7);
        values[6] = PyTuple_GET_ITEM(__pyx_args, 6);
        values[5] = PyTuple_GET_ITEM(__pyx_args, 5);
        values[4] = PyTuple_GET_ITEM(__pyx_args, 4);
        values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
        values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        break;
        default: goto __pyx_L5_argtuple_error;
      }
    }
    __pyx_v_dimx = __Pyx_PyInt_As_int(values[0]); if (unlikely((__pyx_v_dimx == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 1373, __pyx_L3_error)
    __pyx_v_dimy = __Pyx_PyInt_As_int(values[1]); if (unlikely((__pyx_v_dimy == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 1373, __pyx_L3_error)
    __pyx_v_params = ((PyArrayObject *)values[2]);
    __pyx_v_box_size = __Pyx_PyInt_As_int(values[3]); if (unlikely((__pyx_v_box_size == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 1374, __pyx_L3_error)
    __pyx_v_frame = ((PyArrayObject *)values[4]);
    __pyx_v_noise = ((PyArrayObject *)values[5]);
    __pyx_v_dcl = __pyx_PyFloat_AsDouble(values[6]); if (unlikely((__pyx_v_dcl == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 1375, __pyx_L3_error)
    __pyx_v_saturation = __pyx_PyFloat_AsDouble(values[7]); if (unlikely((__pyx_v_saturation == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 1376, __pyx_L3_error)
    __pyx_v_transpose = values[8];
    __pyx_v_normalize = values[9];
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  __Pyx_RaiseArgtupleInvalid("model_diff", 0, 8, 10, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 1373, __pyx_L3_error)
  __pyx_L3_error:;
  __Pyx_AddTraceback("orb.cutils.multi_fit_stars.model_diff", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __Pyx_RefNannyFinishContext();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_params), __pyx_ptype_5numpy_ndarray, 1, "params", 0))) __PYX_ERR(0, 1373, __pyx_L1_error)
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_frame), __pyx_ptype_5numpy_ndarray, 1, "frame", 0))) __PYX_ERR(0, 1374, __pyx_L1_error)
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_noise), __pyx_ptype_5numpy_ndarray, 1, "noise", 0))) __PYX_ERR(0, 1375, __pyx_L1_error)
  __pyx_r = __pyx_pf_3orb_6cutils_15multi_fit_stars_6model_diff(__pyx_self, __pyx_v_dimx, __pyx_v_dimy, __pyx_v_params, __pyx_v_box_size, __pyx_v_frame, __pyx_v_noise, __pyx_v_dcl, __pyx_v_saturation, __pyx_v_transpose, __pyx_v_normalize);

  /* "orb/cutils.pyx":1373
 *         return np.sqrt(np.abs(data) + (noise)**2. + dcl)
 * 
 *     def model_diff(int dimx, int dimy, np.ndarray[np.float64_t, ndim=2] params,             # <<<<<<<<<<<<<<
 *                    int box_size, np.ndarray[np.float64_t, ndim=2] frame,
 *                    np.ndarray[np.float64_t, ndim=1] noise, double dcl,
 */

  /* function exit code */
  goto __pyx_L0;
  __pyx_L1_error:;
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_15multi_fit_stars_6model_diff(CYTHON_UNUSED PyObject *__pyx_self, int __pyx_v_dimx, int __pyx_v_dimy, PyArrayObject *__pyx_v_params, int __pyx_v_box_size, PyArrayObject *__pyx_v_frame, CYTHON_UNUSED PyArrayObject *__pyx_v_noise, CYTHON_UNUSED double __pyx_v_dcl, double __pyx_v_saturation, PyObject *__pyx_v_transpose, PyObject *__pyx_v_normalize) {
  int __pyx_v_int_posx;
  int __pyx_v_int_posy;
  int __pyx_v_istar;
  PyArrayObject *__pyx_v_star = 0;
  PyArrayObject *__pyx_v_data = 0;
  PyArrayObject *__pyx_v_res = 0;
  double __pyx_v_dx;
  double __pyx_v_dy;
  int __pyx_v_x_min;
  int __pyx_v_x_max;
  int __pyx_v_y_min;
  int __pyx_v_y_max;
  int __pyx_v_hsz;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_data;
  __Pyx_Buffer __pyx_pybuffer_data;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_frame;
  __Pyx_Buffer __pyx_pybuffer_frame;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_noise;
  __Pyx_Buffer __pyx_pybuffer_noise;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_params;
  __Pyx_Buffer __pyx_pybuffer_params;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_res;
  __Pyx_Buffer __pyx_pybuffer_res;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_star;
  __Pyx_Buffer __pyx_pybuffer_star;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  PyObject *__pyx_t_1 = NULL;
  PyObject *__pyx_t_2 = NULL;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  PyArrayObject *__pyx_t_5 = NULL;
  PyArrayObject *__pyx_t_6 = NULL;
  int __pyx_t_7;
  int __pyx_t_8;
  PyArrayObject *__pyx_t_9 = NULL;
  int __pyx_t_10;
  PyObject *__pyx_t_11 = NULL;
  PyObject *__pyx_t_12 = NULL;
  PyObject *__pyx_t_13 = NULL;
  PyObject *__pyx_t_14 = NULL;
  npy_intp __pyx_t_15;
  Py_ssize_t __pyx_t_16;
  Py_ssize_t __pyx_t_17;
  int __pyx_t_18;
  Py_ssize_t __pyx_t_19;
  Py_ssize_t __pyx_t_20;
  Py_ssize_t __pyx_t_21;
  Py_ssize_t __pyx_t_22;
  Py_ssize_t __pyx_t_23;
  Py_ssize_t __pyx_t_24;
  Py_ssize_t __pyx_t_25;
  Py_ssize_t __pyx_t_26;
  Py_ssize_t __pyx_t_27;
  Py_ssize_t __pyx_t_28;
  PyObject *__pyx_t_29 = NULL;
  PyObject *__pyx_t_30 = NULL;
  PyObject *__pyx_t_31 = NULL;
  PyObject *__pyx_t_32 = NULL;
  Py_ssize_t __pyx_t_33;
  PyObject *__pyx_t_34 = NULL;
  Py_ssize_t __pyx_t_35;
  Py_ssize_t __pyx_t_36;
  PyObject *(*__pyx_t_37)(PyObject *);
  int __pyx_t_38;
  int __pyx_t_39;
  int __pyx_t_40;
  __Pyx_RefNannySetupContext("model_diff", 0);
  __pyx_pybuffer_star.pybuffer.buf = NULL;
  __pyx_pybuffer_star.refcount = 0;
  __pyx_pybuffernd_star.data = NULL;
  __pyx_pybuffernd_star.rcbuffer = &__pyx_pybuffer_star;
  __pyx_pybuffer_data.pybuffer.buf = NULL;
  __pyx_pybuffer_data.refcount = 0;
  __pyx_pybuffernd_data.data = NULL;
  __pyx_pybuffernd_data.rcbuffer = &__pyx_pybuffer_data;
  __pyx_pybuffer_res.pybuffer.buf = NULL;
  __pyx_pybuffer_res.refcount = 0;
  __pyx_pybuffernd_res.data = NULL;
  __pyx_pybuffernd_res.rcbuffer = &__pyx_pybuffer_res;
  __pyx_pybuffer_params.pybuffer.buf = NULL;
  __pyx_pybuffer_params.refcount = 0;
  __pyx_pybuffernd_params.data = NULL;
  __pyx_pybuffernd_params.rcbuffer = &__pyx_pybuffer_params;
  __pyx_pybuffer_frame.pybuffer.buf = NULL;
  __pyx_pybuffer_frame.refcount = 0;
  __pyx_pybuffernd_frame.data = NULL;
  __pyx_pybuffernd_frame.rcbuffer = &__pyx_pybuffer_frame;
  __pyx_pybuffer_noise.pybuffer.buf = NULL;
  __pyx_pybuffer_noise.refcount = 0;
  __pyx_pybuffernd_noise.data = NULL;
  __pyx_pybuffernd_noise.rcbuffer = &__pyx_pybuffer_noise;
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_params.rcbuffer->pybuffer, (PyObject*)__pyx_v_params, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) __PYX_ERR(0, 1373, __pyx_L1_error)
  }
  __pyx_pybuffernd_params.diminfo[0].strides = __pyx_pybuffernd_params.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_params.diminfo[0].shape = __pyx_pybuffernd_params.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_params.diminfo[1].strides = __pyx_pybuffernd_params.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_params.diminfo[1].shape = __pyx_pybuffernd_params.rcbuffer->pybuffer.shape[1];
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_frame.rcbuffer->pybuffer, (PyObject*)__pyx_v_frame, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) __PYX_ERR(0, 1373, __pyx_L1_error)
  }
  __pyx_pybuffernd_frame.diminfo[0].strides = __pyx_pybuffernd_frame.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_frame.diminfo[0].shape = __pyx_pybuffernd_frame.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_frame.diminfo[1].strides = __pyx_pybuffernd_frame.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_frame.diminfo[1].shape = __pyx_pybuffernd_frame.rcbuffer->pybuffer.shape[1];
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_noise.rcbuffer->pybuffer, (PyObject*)__pyx_v_noise, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) __PYX_ERR(0, 1373, __pyx_L1_error)
  }
  __pyx_pybuffernd_noise.diminfo[0].strides = __pyx_pybuffernd_noise.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_noise.diminfo[0].shape = __pyx_pybuffernd_noise.rcbuffer->pybuffer.shape[0];

  /* "orb/cutils.pyx":1381
 *         """
 *         cdef int int_posx, int_posy, istar
 *         cdef np.ndarray[np.float64_t, ndim=2] star = np.zeros(             # <<<<<<<<<<<<<<
 *             (box_size, box_size), dtype=float)
 *         cdef np.ndarray[np.float64_t, ndim=2] data = np.zeros_like(
 */
  __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1381, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_zeros); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1381, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1382
 *         cdef int int_posx, int_posy, istar
 *         cdef np.ndarray[np.float64_t, ndim=2] star = np.zeros(
 *             (box_size, box_size), dtype=float)             # <<<<<<<<<<<<<<
 *         cdef np.ndarray[np.float64_t, ndim=2] data = np.zeros_like(
 *             star, dtype=float)
 */
  __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_box_size); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1382, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_3 = __Pyx_PyInt_From_int(__pyx_v_box_size); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1382, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_4 = PyTuple_New(2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1382, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_GIVEREF(__pyx_t_1);
  PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_1);
  __Pyx_GIVEREF(__pyx_t_3);
  PyTuple_SET_ITEM(__pyx_t_4, 1, __pyx_t_3);
  __pyx_t_1 = 0;
  __pyx_t_3 = 0;

  /* "orb/cutils.pyx":1381
 *         """
 *         cdef int int_posx, int_posy, istar
 *         cdef np.ndarray[np.float64_t, ndim=2] star = np.zeros(             # <<<<<<<<<<<<<<
 *             (box_size, box_size), dtype=float)
 *         cdef np.ndarray[np.float64_t, ndim=2] data = np.zeros_like(
 */
  __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1381, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_GIVEREF(__pyx_t_4);
  PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_4);
  __pyx_t_4 = 0;

  /* "orb/cutils.pyx":1382
 *         cdef int int_posx, int_posy, istar
 *         cdef np.ndarray[np.float64_t, ndim=2] star = np.zeros(
 *             (box_size, box_size), dtype=float)             # <<<<<<<<<<<<<<
 *         cdef np.ndarray[np.float64_t, ndim=2] data = np.zeros_like(
 *             star, dtype=float)
 */
  __pyx_t_4 = PyDict_New(); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1382, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  if (PyDict_SetItem(__pyx_t_4, __pyx_n_s_dtype, ((PyObject *)(&PyFloat_Type))) < 0) __PYX_ERR(0, 1382, __pyx_L1_error)

  /* "orb/cutils.pyx":1381
 *         """
 *         cdef int int_posx, int_posy, istar
 *         cdef np.ndarray[np.float64_t, ndim=2] star = np.zeros(             # <<<<<<<<<<<<<<
 *             (box_size, box_size), dtype=float)
 *         cdef np.ndarray[np.float64_t, ndim=2] data = np.zeros_like(
 */
  __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_3, __pyx_t_4); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1381, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1381, __pyx_L1_error)
  __pyx_t_5 = ((PyArrayObject *)__pyx_t_1);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_star.rcbuffer->pybuffer, (PyObject*)__pyx_t_5, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
      __pyx_v_star = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_star.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 1381, __pyx_L1_error)
    } else {__pyx_pybuffernd_star.diminfo[0].strides = __pyx_pybuffernd_star.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_star.diminfo[0].shape = __pyx_pybuffernd_star.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_star.diminfo[1].strides = __pyx_pybuffernd_star.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_star.diminfo[1].shape = __pyx_pybuffernd_star.rcbuffer->pybuffer.shape[1];
    }
  }
  __pyx_t_5 = 0;
  __pyx_v_star = ((PyArrayObject *)__pyx_t_1);
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1383
 *         cdef np.ndarray[np.float64_t, ndim=2] star = np.zeros(
 *             (box_size, box_size), dtype=float)
 *         cdef np.ndarray[np.float64_t, ndim=2] data = np.zeros_like(             # <<<<<<<<<<<<<<
 *             star, dtype=float)
 *         cdef np.ndarray[np.float64_t, ndim=2] res
 */
  __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1383, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_zeros_like); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1383, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1384
 *             (box_size, box_size), dtype=float)
 *         cdef np.ndarray[np.float64_t, ndim=2] data = np.zeros_like(
 *             star, dtype=float)             # <<<<<<<<<<<<<<
 *         cdef np.ndarray[np.float64_t, ndim=2] res
 *         cdef double dx, dy
 */
  __pyx_t_1 = PyTuple_New(1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1383, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_INCREF(((PyObject *)__pyx_v_star));
  __Pyx_GIVEREF(((PyObject *)__pyx_v_star));
  PyTuple_SET_ITEM(__pyx_t_1, 0, ((PyObject *)__pyx_v_star));
  __pyx_t_3 = PyDict_New(); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1384, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  if (PyDict_SetItem(__pyx_t_3, __pyx_n_s_dtype, ((PyObject *)(&PyFloat_Type))) < 0) __PYX_ERR(0, 1384, __pyx_L1_error)

  /* "orb/cutils.pyx":1383
 *         cdef np.ndarray[np.float64_t, ndim=2] star = np.zeros(
 *             (box_size, box_size), dtype=float)
 *         cdef np.ndarray[np.float64_t, ndim=2] data = np.zeros_like(             # <<<<<<<<<<<<<<
 *             star, dtype=float)
 *         cdef np.ndarray[np.float64_t, ndim=2] res
 */
  __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_1, __pyx_t_3); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1383, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  if (!(likely(((__pyx_t_2) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_2, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1383, __pyx_L1_error)
  __pyx_t_6 = ((PyArrayObject *)__pyx_t_2);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_data.rcbuffer->pybuffer, (PyObject*)__pyx_t_6, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
      __pyx_v_data = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_data.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 1383, __pyx_L1_error)
    } else {__pyx_pybuffernd_data.diminfo[0].strides = __pyx_pybuffernd_data.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_data.diminfo[0].shape = __pyx_pybuffernd_data.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_data.diminfo[1].strides = __pyx_pybuffernd_data.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_data.diminfo[1].shape = __pyx_pybuffernd_data.rcbuffer->pybuffer.shape[1];
    }
  }
  __pyx_t_6 = 0;
  __pyx_v_data = ((PyArrayObject *)__pyx_t_2);
  __pyx_t_2 = 0;

  /* "orb/cutils.pyx":1390
 *         cdef int hsz
 * 
 *         if not transpose:             # <<<<<<<<<<<<<<
 *             res = np.zeros(
 *                 (box_size * params.shape[0], box_size), dtype=float)
 */
  __pyx_t_7 = __Pyx_PyObject_IsTrue(__pyx_v_transpose); if (unlikely(__pyx_t_7 < 0)) __PYX_ERR(0, 1390, __pyx_L1_error)
  __pyx_t_8 = ((!__pyx_t_7) != 0);
  if (__pyx_t_8) {

    /* "orb/cutils.pyx":1391
 * 
 *         if not transpose:
 *             res = np.zeros(             # <<<<<<<<<<<<<<
 *                 (box_size * params.shape[0], box_size), dtype=float)
 *         else:
 */
    __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1391, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_zeros); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1391, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;

    /* "orb/cutils.pyx":1392
 *         if not transpose:
 *             res = np.zeros(
 *                 (box_size * params.shape[0], box_size), dtype=float)             # <<<<<<<<<<<<<<
 *         else:
 *             res = np.zeros(
 */
    __pyx_t_2 = __Pyx_PyInt_From_Py_intptr_t((__pyx_v_box_size * (__pyx_v_params->dimensions[0]))); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1392, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_box_size); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1392, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __pyx_t_4 = PyTuple_New(2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1392, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_GIVEREF(__pyx_t_2);
    PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_2);
    __Pyx_GIVEREF(__pyx_t_1);
    PyTuple_SET_ITEM(__pyx_t_4, 1, __pyx_t_1);
    __pyx_t_2 = 0;
    __pyx_t_1 = 0;

    /* "orb/cutils.pyx":1391
 * 
 *         if not transpose:
 *             res = np.zeros(             # <<<<<<<<<<<<<<
 *                 (box_size * params.shape[0], box_size), dtype=float)
 *         else:
 */
    __pyx_t_1 = PyTuple_New(1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1391, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_GIVEREF(__pyx_t_4);
    PyTuple_SET_ITEM(__pyx_t_1, 0, __pyx_t_4);
    __pyx_t_4 = 0;

    /* "orb/cutils.pyx":1392
 *         if not transpose:
 *             res = np.zeros(
 *                 (box_size * params.shape[0], box_size), dtype=float)             # <<<<<<<<<<<<<<
 *         else:
 *             res = np.zeros(
 */
    __pyx_t_4 = PyDict_New(); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1392, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    if (PyDict_SetItem(__pyx_t_4, __pyx_n_s_dtype, ((PyObject *)(&PyFloat_Type))) < 0) __PYX_ERR(0, 1392, __pyx_L1_error)

    /* "orb/cutils.pyx":1391
 * 
 *         if not transpose:
 *             res = np.zeros(             # <<<<<<<<<<<<<<
 *                 (box_size * params.shape[0], box_size), dtype=float)
 *         else:
 */
    __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_1, __pyx_t_4); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1391, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    if (!(likely(((__pyx_t_2) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_2, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1391, __pyx_L1_error)
    __pyx_t_9 = ((PyArrayObject *)__pyx_t_2);
    {
      __Pyx_BufFmt_StackElem __pyx_stack[1];
      __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_res.rcbuffer->pybuffer);
      __pyx_t_10 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_res.rcbuffer->pybuffer, (PyObject*)__pyx_t_9, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
      if (unlikely(__pyx_t_10 < 0)) {
        PyErr_Fetch(&__pyx_t_11, &__pyx_t_12, &__pyx_t_13);
        if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_res.rcbuffer->pybuffer, (PyObject*)__pyx_v_res, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
          Py_XDECREF(__pyx_t_11); Py_XDECREF(__pyx_t_12); Py_XDECREF(__pyx_t_13);
          __Pyx_RaiseBufferFallbackError();
        } else {
          PyErr_Restore(__pyx_t_11, __pyx_t_12, __pyx_t_13);
        }
      }
      __pyx_pybuffernd_res.diminfo[0].strides = __pyx_pybuffernd_res.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_res.diminfo[0].shape = __pyx_pybuffernd_res.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_res.diminfo[1].strides = __pyx_pybuffernd_res.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_res.diminfo[1].shape = __pyx_pybuffernd_res.rcbuffer->pybuffer.shape[1];
      if (unlikely(__pyx_t_10 < 0)) __PYX_ERR(0, 1391, __pyx_L1_error)
    }
    __pyx_t_9 = 0;
    __pyx_v_res = ((PyArrayObject *)__pyx_t_2);
    __pyx_t_2 = 0;

    /* "orb/cutils.pyx":1390
 *         cdef int hsz
 * 
 *         if not transpose:             # <<<<<<<<<<<<<<
 *             res = np.zeros(
 *                 (box_size * params.shape[0], box_size), dtype=float)
 */
    goto __pyx_L3;
  }

  /* "orb/cutils.pyx":1394
 *                 (box_size * params.shape[0], box_size), dtype=float)
 *         else:
 *             res = np.zeros(             # <<<<<<<<<<<<<<
 *                 (box_size, box_size * params.shape[0]), dtype=float)
 * 
 */
  /*else*/ {
    __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1394, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_zeros); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1394, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;

    /* "orb/cutils.pyx":1395
 *         else:
 *             res = np.zeros(
 *                 (box_size, box_size * params.shape[0]), dtype=float)             # <<<<<<<<<<<<<<
 * 
 *         res.fill(np.nan)
 */
    __pyx_t_2 = __Pyx_PyInt_From_int(__pyx_v_box_size); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1395, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __pyx_t_1 = __Pyx_PyInt_From_Py_intptr_t((__pyx_v_box_size * (__pyx_v_params->dimensions[0]))); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1395, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __pyx_t_3 = PyTuple_New(2); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1395, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_GIVEREF(__pyx_t_2);
    PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_2);
    __Pyx_GIVEREF(__pyx_t_1);
    PyTuple_SET_ITEM(__pyx_t_3, 1, __pyx_t_1);
    __pyx_t_2 = 0;
    __pyx_t_1 = 0;

    /* "orb/cutils.pyx":1394
 *                 (box_size * params.shape[0], box_size), dtype=float)
 *         else:
 *             res = np.zeros(             # <<<<<<<<<<<<<<
 *                 (box_size, box_size * params.shape[0]), dtype=float)
 * 
 */
    __pyx_t_1 = PyTuple_New(1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1394, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_GIVEREF(__pyx_t_3);
    PyTuple_SET_ITEM(__pyx_t_1, 0, __pyx_t_3);
    __pyx_t_3 = 0;

    /* "orb/cutils.pyx":1395
 *         else:
 *             res = np.zeros(
 *                 (box_size, box_size * params.shape[0]), dtype=float)             # <<<<<<<<<<<<<<
 * 
 *         res.fill(np.nan)
 */
    __pyx_t_3 = PyDict_New(); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1395, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    if (PyDict_SetItem(__pyx_t_3, __pyx_n_s_dtype, ((PyObject *)(&PyFloat_Type))) < 0) __PYX_ERR(0, 1395, __pyx_L1_error)

    /* "orb/cutils.pyx":1394
 *                 (box_size * params.shape[0], box_size), dtype=float)
 *         else:
 *             res = np.zeros(             # <<<<<<<<<<<<<<
 *                 (box_size, box_size * params.shape[0]), dtype=float)
 * 
 */
    __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_1, __pyx_t_3); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1394, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    if (!(likely(((__pyx_t_2) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_2, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1394, __pyx_L1_error)
    __pyx_t_9 = ((PyArrayObject *)__pyx_t_2);
    {
      __Pyx_BufFmt_StackElem __pyx_stack[1];
      __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_res.rcbuffer->pybuffer);
      __pyx_t_10 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_res.rcbuffer->pybuffer, (PyObject*)__pyx_t_9, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
      if (unlikely(__pyx_t_10 < 0)) {
        PyErr_Fetch(&__pyx_t_13, &__pyx_t_12, &__pyx_t_11);
        if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_res.rcbuffer->pybuffer, (PyObject*)__pyx_v_res, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
          Py_XDECREF(__pyx_t_13); Py_XDECREF(__pyx_t_12); Py_XDECREF(__pyx_t_11);
          __Pyx_RaiseBufferFallbackError();
        } else {
          PyErr_Restore(__pyx_t_13, __pyx_t_12, __pyx_t_11);
        }
      }
      __pyx_pybuffernd_res.diminfo[0].strides = __pyx_pybuffernd_res.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_res.diminfo[0].shape = __pyx_pybuffernd_res.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_res.diminfo[1].strides = __pyx_pybuffernd_res.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_res.diminfo[1].shape = __pyx_pybuffernd_res.rcbuffer->pybuffer.shape[1];
      if (unlikely(__pyx_t_10 < 0)) __PYX_ERR(0, 1394, __pyx_L1_error)
    }
    __pyx_t_9 = 0;
    __pyx_v_res = ((PyArrayObject *)__pyx_t_2);
    __pyx_t_2 = 0;
  }
  __pyx_L3:;

  /* "orb/cutils.pyx":1397
 *                 (box_size, box_size * params.shape[0]), dtype=float)
 * 
 *         res.fill(np.nan)             # <<<<<<<<<<<<<<
 * 
 *         for istar in range(params.shape[0]):
 */
  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_res), __pyx_n_s_fill); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1397, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1397, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_nan); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1397, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_1 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && likely(PyMethod_Check(__pyx_t_3))) {
    __pyx_t_1 = PyMethod_GET_SELF(__pyx_t_3);
    if (likely(__pyx_t_1)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
      __Pyx_INCREF(__pyx_t_1);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_3, function);
    }
  }
  if (!__pyx_t_1) {
    __pyx_t_2 = __Pyx_PyObject_CallOneArg(__pyx_t_3, __pyx_t_4); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1397, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __Pyx_GOTREF(__pyx_t_2);
  } else {
    __pyx_t_14 = PyTuple_New(1+1); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 1397, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_14);
    __Pyx_GIVEREF(__pyx_t_1); PyTuple_SET_ITEM(__pyx_t_14, 0, __pyx_t_1); __pyx_t_1 = NULL;
    __Pyx_GIVEREF(__pyx_t_4);
    PyTuple_SET_ITEM(__pyx_t_14, 0+1, __pyx_t_4);
    __pyx_t_4 = 0;
    __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_14, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1397, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
  }
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;

  /* "orb/cutils.pyx":1399
 *         res.fill(np.nan)
 * 
 *         for istar in range(params.shape[0]):             # <<<<<<<<<<<<<<
 *             int_posx = <int> params[istar,2]
 *             int_posy = <int> params[istar,3]
 */
  __pyx_t_15 = (__pyx_v_params->dimensions[0]);
  for (__pyx_t_10 = 0; __pyx_t_10 < __pyx_t_15; __pyx_t_10+=1) {
    __pyx_v_istar = __pyx_t_10;

    /* "orb/cutils.pyx":1400
 * 
 *         for istar in range(params.shape[0]):
 *             int_posx = <int> params[istar,2]             # <<<<<<<<<<<<<<
 *             int_posy = <int> params[istar,3]
 *             dx = (params[istar,2] - <double> int_posx
 */
    __pyx_t_16 = __pyx_v_istar;
    __pyx_t_17 = 2;
    __pyx_t_18 = -1;
    if (__pyx_t_16 < 0) {
      __pyx_t_16 += __pyx_pybuffernd_params.diminfo[0].shape;
      if (unlikely(__pyx_t_16 < 0)) __pyx_t_18 = 0;
    } else if (unlikely(__pyx_t_16 >= __pyx_pybuffernd_params.diminfo[0].shape)) __pyx_t_18 = 0;
    if (__pyx_t_17 < 0) {
      __pyx_t_17 += __pyx_pybuffernd_params.diminfo[1].shape;
      if (unlikely(__pyx_t_17 < 0)) __pyx_t_18 = 1;
    } else if (unlikely(__pyx_t_17 >= __pyx_pybuffernd_params.diminfo[1].shape)) __pyx_t_18 = 1;
    if (unlikely(__pyx_t_18 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_18);
      __PYX_ERR(0, 1400, __pyx_L1_error)
    }
    __pyx_v_int_posx = ((int)(*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_params.rcbuffer->pybuffer.buf, __pyx_t_16, __pyx_pybuffernd_params.diminfo[0].strides, __pyx_t_17, __pyx_pybuffernd_params.diminfo[1].strides)));

    /* "orb/cutils.pyx":1401
 *         for istar in range(params.shape[0]):
 *             int_posx = <int> params[istar,2]
 *             int_posy = <int> params[istar,3]             # <<<<<<<<<<<<<<
 *             dx = (params[istar,2] - <double> int_posx
 *                   + (<double> box_size / 2.) - 0.5)
 */
    __pyx_t_19 = __pyx_v_istar;
    __pyx_t_20 = 3;
    __pyx_t_18 = -1;
    if (__pyx_t_19 < 0) {
      __pyx_t_19 += __pyx_pybuffernd_params.diminfo[0].shape;
      if (unlikely(__pyx_t_19 < 0)) __pyx_t_18 = 0;
    } else if (unlikely(__pyx_t_19 >= __pyx_pybuffernd_params.diminfo[0].shape)) __pyx_t_18 = 0;
    if (__pyx_t_20 < 0) {
      __pyx_t_20 += __pyx_pybuffernd_params.diminfo[1].shape;
      if (unlikely(__pyx_t_20 < 0)) __pyx_t_18 = 1;
    } else if (unlikely(__pyx_t_20 >= __pyx_pybuffernd_params.diminfo[1].shape)) __pyx_t_18 = 1;
    if (unlikely(__pyx_t_18 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_18);
      __PYX_ERR(0, 1401, __pyx_L1_error)
    }
    __pyx_v_int_posy = ((int)(*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_params.rcbuffer->pybuffer.buf, __pyx_t_19, __pyx_pybuffernd_params.diminfo[0].strides, __pyx_t_20, __pyx_pybuffernd_params.diminfo[1].strides)));

    /* "orb/cutils.pyx":1402
 *             int_posx = <int> params[istar,2]
 *             int_posy = <int> params[istar,3]
 *             dx = (params[istar,2] - <double> int_posx             # <<<<<<<<<<<<<<
 *                   + (<double> box_size / 2.) - 0.5)
 *             dy = (params[istar,3] - <double> int_posy
 */
    __pyx_t_21 = __pyx_v_istar;
    __pyx_t_22 = 2;
    __pyx_t_18 = -1;
    if (__pyx_t_21 < 0) {
      __pyx_t_21 += __pyx_pybuffernd_params.diminfo[0].shape;
      if (unlikely(__pyx_t_21 < 0)) __pyx_t_18 = 0;
    } else if (unlikely(__pyx_t_21 >= __pyx_pybuffernd_params.diminfo[0].shape)) __pyx_t_18 = 0;
    if (__pyx_t_22 < 0) {
      __pyx_t_22 += __pyx_pybuffernd_params.diminfo[1].shape;
      if (unlikely(__pyx_t_22 < 0)) __pyx_t_18 = 1;
    } else if (unlikely(__pyx_t_22 >= __pyx_pybuffernd_params.diminfo[1].shape)) __pyx_t_18 = 1;
    if (unlikely(__pyx_t_18 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_18);
      __PYX_ERR(0, 1402, __pyx_L1_error)
    }

    /* "orb/cutils.pyx":1403
 *             int_posy = <int> params[istar,3]
 *             dx = (params[istar,2] - <double> int_posx
 *                   + (<double> box_size / 2.) - 0.5)             # <<<<<<<<<<<<<<
 *             dy = (params[istar,3] - <double> int_posy
 *                   + (<double> box_size / 2.) - 0.5)
 */
    __pyx_v_dx = ((((*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_params.rcbuffer->pybuffer.buf, __pyx_t_21, __pyx_pybuffernd_params.diminfo[0].strides, __pyx_t_22, __pyx_pybuffernd_params.diminfo[1].strides)) - ((double)__pyx_v_int_posx)) + (((double)__pyx_v_box_size) / 2.)) - 0.5);

    /* "orb/cutils.pyx":1404
 *             dx = (params[istar,2] - <double> int_posx
 *                   + (<double> box_size / 2.) - 0.5)
 *             dy = (params[istar,3] - <double> int_posy             # <<<<<<<<<<<<<<
 *                   + (<double> box_size / 2.) - 0.5)
 * 
 */
    __pyx_t_23 = __pyx_v_istar;
    __pyx_t_24 = 3;
    __pyx_t_18 = -1;
    if (__pyx_t_23 < 0) {
      __pyx_t_23 += __pyx_pybuffernd_params.diminfo[0].shape;
      if (unlikely(__pyx_t_23 < 0)) __pyx_t_18 = 0;
    } else if (unlikely(__pyx_t_23 >= __pyx_pybuffernd_params.diminfo[0].shape)) __pyx_t_18 = 0;
    if (__pyx_t_24 < 0) {
      __pyx_t_24 += __pyx_pybuffernd_params.diminfo[1].shape;
      if (unlikely(__pyx_t_24 < 0)) __pyx_t_18 = 1;
    } else if (unlikely(__pyx_t_24 >= __pyx_pybuffernd_params.diminfo[1].shape)) __pyx_t_18 = 1;
    if (unlikely(__pyx_t_18 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_18);
      __PYX_ERR(0, 1404, __pyx_L1_error)
    }

    /* "orb/cutils.pyx":1405
 *                   + (<double> box_size / 2.) - 0.5)
 *             dy = (params[istar,3] - <double> int_posy
 *                   + (<double> box_size / 2.) - 0.5)             # <<<<<<<<<<<<<<
 * 
 *             # star
 */
    __pyx_v_dy = ((((*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_params.rcbuffer->pybuffer.buf, __pyx_t_23, __pyx_pybuffernd_params.diminfo[0].strides, __pyx_t_24, __pyx_pybuffernd_params.diminfo[1].strides)) - ((double)__pyx_v_int_posy)) + (((double)__pyx_v_box_size) / 2.)) - 0.5);

    /* "orb/cutils.pyx":1408
 * 
 *             # star
 *             star = gaussian_array2d(0.,             # <<<<<<<<<<<<<<
 *                                     params[istar,1],
 *                                     dx, dy,
 */
    __pyx_t_3 = __Pyx_GetModuleGlobalName(__pyx_n_s_gaussian_array2d); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1408, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);

    /* "orb/cutils.pyx":1409
 *             # star
 *             star = gaussian_array2d(0.,
 *                                     params[istar,1],             # <<<<<<<<<<<<<<
 *                                     dx, dy,
 *                                     params[istar,4],
 */
    __pyx_t_25 = __pyx_v_istar;
    __pyx_t_26 = 1;
    __pyx_t_18 = -1;
    if (__pyx_t_25 < 0) {
      __pyx_t_25 += __pyx_pybuffernd_params.diminfo[0].shape;
      if (unlikely(__pyx_t_25 < 0)) __pyx_t_18 = 0;
    } else if (unlikely(__pyx_t_25 >= __pyx_pybuffernd_params.diminfo[0].shape)) __pyx_t_18 = 0;
    if (__pyx_t_26 < 0) {
      __pyx_t_26 += __pyx_pybuffernd_params.diminfo[1].shape;
      if (unlikely(__pyx_t_26 < 0)) __pyx_t_18 = 1;
    } else if (unlikely(__pyx_t_26 >= __pyx_pybuffernd_params.diminfo[1].shape)) __pyx_t_18 = 1;
    if (unlikely(__pyx_t_18 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_18);
      __PYX_ERR(0, 1409, __pyx_L1_error)
    }
    __pyx_t_14 = PyFloat_FromDouble((*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_params.rcbuffer->pybuffer.buf, __pyx_t_25, __pyx_pybuffernd_params.diminfo[0].strides, __pyx_t_26, __pyx_pybuffernd_params.diminfo[1].strides))); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 1409, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_14);

    /* "orb/cutils.pyx":1410
 *             star = gaussian_array2d(0.,
 *                                     params[istar,1],
 *                                     dx, dy,             # <<<<<<<<<<<<<<
 *                                     params[istar,4],
 *                                     box_size, box_size)
 */
    __pyx_t_4 = PyFloat_FromDouble(__pyx_v_dx); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1410, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __pyx_t_1 = PyFloat_FromDouble(__pyx_v_dy); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1410, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);

    /* "orb/cutils.pyx":1411
 *                                     params[istar,1],
 *                                     dx, dy,
 *                                     params[istar,4],             # <<<<<<<<<<<<<<
 *                                     box_size, box_size)
 *             # background
 */
    __pyx_t_27 = __pyx_v_istar;
    __pyx_t_28 = 4;
    __pyx_t_18 = -1;
    if (__pyx_t_27 < 0) {
      __pyx_t_27 += __pyx_pybuffernd_params.diminfo[0].shape;
      if (unlikely(__pyx_t_27 < 0)) __pyx_t_18 = 0;
    } else if (unlikely(__pyx_t_27 >= __pyx_pybuffernd_params.diminfo[0].shape)) __pyx_t_18 = 0;
    if (__pyx_t_28 < 0) {
      __pyx_t_28 += __pyx_pybuffernd_params.diminfo[1].shape;
      if (unlikely(__pyx_t_28 < 0)) __pyx_t_18 = 1;
    } else if (unlikely(__pyx_t_28 >= __pyx_pybuffernd_params.diminfo[1].shape)) __pyx_t_18 = 1;
    if (unlikely(__pyx_t_18 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_18);
      __PYX_ERR(0, 1411, __pyx_L1_error)
    }
    __pyx_t_29 = PyFloat_FromDouble((*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_params.rcbuffer->pybuffer.buf, __pyx_t_27, __pyx_pybuffernd_params.diminfo[0].strides, __pyx_t_28, __pyx_pybuffernd_params.diminfo[1].strides))); if (unlikely(!__pyx_t_29)) __PYX_ERR(0, 1411, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_29);

    /* "orb/cutils.pyx":1412
 *                                     dx, dy,
 *                                     params[istar,4],
 *                                     box_size, box_size)             # <<<<<<<<<<<<<<
 *             # background
 *             #xx, xy = np.mgrid[0 - dx: star.shape[0] - dx,
 */
    __pyx_t_30 = __Pyx_PyInt_From_int(__pyx_v_box_size); if (unlikely(!__pyx_t_30)) __PYX_ERR(0, 1412, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_30);
    __pyx_t_31 = __Pyx_PyInt_From_int(__pyx_v_box_size); if (unlikely(!__pyx_t_31)) __PYX_ERR(0, 1412, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_31);
    __pyx_t_32 = NULL;
    __pyx_t_33 = 0;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_3))) {
      __pyx_t_32 = PyMethod_GET_SELF(__pyx_t_3);
      if (likely(__pyx_t_32)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
        __Pyx_INCREF(__pyx_t_32);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_3, function);
        __pyx_t_33 = 1;
      }
    }
    __pyx_t_34 = PyTuple_New(7+__pyx_t_33); if (unlikely(!__pyx_t_34)) __PYX_ERR(0, 1408, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_34);
    if (__pyx_t_32) {
      __Pyx_GIVEREF(__pyx_t_32); PyTuple_SET_ITEM(__pyx_t_34, 0, __pyx_t_32); __pyx_t_32 = NULL;
    }
    __Pyx_INCREF(__pyx_float_0_);
    __Pyx_GIVEREF(__pyx_float_0_);
    PyTuple_SET_ITEM(__pyx_t_34, 0+__pyx_t_33, __pyx_float_0_);
    __Pyx_GIVEREF(__pyx_t_14);
    PyTuple_SET_ITEM(__pyx_t_34, 1+__pyx_t_33, __pyx_t_14);
    __Pyx_GIVEREF(__pyx_t_4);
    PyTuple_SET_ITEM(__pyx_t_34, 2+__pyx_t_33, __pyx_t_4);
    __Pyx_GIVEREF(__pyx_t_1);
    PyTuple_SET_ITEM(__pyx_t_34, 3+__pyx_t_33, __pyx_t_1);
    __Pyx_GIVEREF(__pyx_t_29);
    PyTuple_SET_ITEM(__pyx_t_34, 4+__pyx_t_33, __pyx_t_29);
    __Pyx_GIVEREF(__pyx_t_30);
    PyTuple_SET_ITEM(__pyx_t_34, 5+__pyx_t_33, __pyx_t_30);
    __Pyx_GIVEREF(__pyx_t_31);
    PyTuple_SET_ITEM(__pyx_t_34, 6+__pyx_t_33, __pyx_t_31);
    __pyx_t_14 = 0;
    __pyx_t_4 = 0;
    __pyx_t_1 = 0;
    __pyx_t_29 = 0;
    __pyx_t_30 = 0;
    __pyx_t_31 = 0;
    __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_34, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1408, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_DECREF(__pyx_t_34); __pyx_t_34 = 0;
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;

    /* "orb/cutils.pyx":1408
 * 
 *             # star
 *             star = gaussian_array2d(0.,             # <<<<<<<<<<<<<<
 *                                     params[istar,1],
 *                                     dx, dy,
 */
    if (!(likely(((__pyx_t_2) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_2, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1408, __pyx_L1_error)
    __pyx_t_5 = ((PyArrayObject *)__pyx_t_2);
    {
      __Pyx_BufFmt_StackElem __pyx_stack[1];
      __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_star.rcbuffer->pybuffer);
      __pyx_t_18 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_star.rcbuffer->pybuffer, (PyObject*)__pyx_t_5, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
      if (unlikely(__pyx_t_18 < 0)) {
        PyErr_Fetch(&__pyx_t_11, &__pyx_t_12, &__pyx_t_13);
        if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_star.rcbuffer->pybuffer, (PyObject*)__pyx_v_star, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
          Py_XDECREF(__pyx_t_11); Py_XDECREF(__pyx_t_12); Py_XDECREF(__pyx_t_13);
          __Pyx_RaiseBufferFallbackError();
        } else {
          PyErr_Restore(__pyx_t_11, __pyx_t_12, __pyx_t_13);
        }
      }
      __pyx_pybuffernd_star.diminfo[0].strides = __pyx_pybuffernd_star.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_star.diminfo[0].shape = __pyx_pybuffernd_star.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_star.diminfo[1].strides = __pyx_pybuffernd_star.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_star.diminfo[1].shape = __pyx_pybuffernd_star.rcbuffer->pybuffer.shape[1];
      if (unlikely(__pyx_t_18 < 0)) __PYX_ERR(0, 1408, __pyx_L1_error)
    }
    __pyx_t_5 = 0;
    __Pyx_DECREF_SET(__pyx_v_star, ((PyArrayObject *)__pyx_t_2));
    __pyx_t_2 = 0;

    /* "orb/cutils.pyx":1417
 *             #                  0 - dy: star.shape[1] - dy]
 *             #star += params[istar,0] + params[istar,5] * xy
 *             star += params[istar,0]             # <<<<<<<<<<<<<<
 * 
 *             x_min, x_max, y_min, y_max = get_box_coords(
 */
    __pyx_t_35 = __pyx_v_istar;
    __pyx_t_36 = 0;
    __pyx_t_18 = -1;
    if (__pyx_t_35 < 0) {
      __pyx_t_35 += __pyx_pybuffernd_params.diminfo[0].shape;
      if (unlikely(__pyx_t_35 < 0)) __pyx_t_18 = 0;
    } else if (unlikely(__pyx_t_35 >= __pyx_pybuffernd_params.diminfo[0].shape)) __pyx_t_18 = 0;
    if (__pyx_t_36 < 0) {
      __pyx_t_36 += __pyx_pybuffernd_params.diminfo[1].shape;
      if (unlikely(__pyx_t_36 < 0)) __pyx_t_18 = 1;
    } else if (unlikely(__pyx_t_36 >= __pyx_pybuffernd_params.diminfo[1].shape)) __pyx_t_18 = 1;
    if (unlikely(__pyx_t_18 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_18);
      __PYX_ERR(0, 1417, __pyx_L1_error)
    }
    __pyx_t_2 = PyFloat_FromDouble((*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_params.rcbuffer->pybuffer.buf, __pyx_t_35, __pyx_pybuffernd_params.diminfo[0].strides, __pyx_t_36, __pyx_pybuffernd_params.diminfo[1].strides))); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1417, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __pyx_t_3 = PyNumber_InPlaceAdd(((PyObject *)__pyx_v_star), __pyx_t_2); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1417, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    if (!(likely(((__pyx_t_3) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_3, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1417, __pyx_L1_error)
    __pyx_t_5 = ((PyArrayObject *)__pyx_t_3);
    {
      __Pyx_BufFmt_StackElem __pyx_stack[1];
      __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_star.rcbuffer->pybuffer);
      __pyx_t_18 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_star.rcbuffer->pybuffer, (PyObject*)__pyx_t_5, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
      if (unlikely(__pyx_t_18 < 0)) {
        PyErr_Fetch(&__pyx_t_13, &__pyx_t_12, &__pyx_t_11);
        if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_star.rcbuffer->pybuffer, (PyObject*)__pyx_v_star, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
          Py_XDECREF(__pyx_t_13); Py_XDECREF(__pyx_t_12); Py_XDECREF(__pyx_t_11);
          __Pyx_RaiseBufferFallbackError();
        } else {
          PyErr_Restore(__pyx_t_13, __pyx_t_12, __pyx_t_11);
        }
      }
      __pyx_pybuffernd_star.diminfo[0].strides = __pyx_pybuffernd_star.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_star.diminfo[0].shape = __pyx_pybuffernd_star.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_star.diminfo[1].strides = __pyx_pybuffernd_star.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_star.diminfo[1].shape = __pyx_pybuffernd_star.rcbuffer->pybuffer.shape[1];
      if (unlikely(__pyx_t_18 < 0)) __PYX_ERR(0, 1417, __pyx_L1_error)
    }
    __pyx_t_5 = 0;
    __Pyx_DECREF_SET(__pyx_v_star, ((PyArrayObject *)__pyx_t_3));
    __pyx_t_3 = 0;

    /* "orb/cutils.pyx":1419
 *             star += params[istar,0]
 * 
 *             x_min, x_max, y_min, y_max = get_box_coords(             # <<<<<<<<<<<<<<
 *                 int_posx, int_posy, box_size,
 *                 0, dimx, 0, dimy)
 */
    __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_get_box_coords); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1419, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);

    /* "orb/cutils.pyx":1420
 * 
 *             x_min, x_max, y_min, y_max = get_box_coords(
 *                 int_posx, int_posy, box_size,             # <<<<<<<<<<<<<<
 *                 0, dimx, 0, dimy)
 *             hsz = <int> (<double> box_size / 2.)
 */
    __pyx_t_34 = __Pyx_PyInt_From_int(__pyx_v_int_posx); if (unlikely(!__pyx_t_34)) __PYX_ERR(0, 1420, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_34);
    __pyx_t_31 = __Pyx_PyInt_From_int(__pyx_v_int_posy); if (unlikely(!__pyx_t_31)) __PYX_ERR(0, 1420, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_31);
    __pyx_t_30 = __Pyx_PyInt_From_int(__pyx_v_box_size); if (unlikely(!__pyx_t_30)) __PYX_ERR(0, 1420, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_30);

    /* "orb/cutils.pyx":1421
 *             x_min, x_max, y_min, y_max = get_box_coords(
 *                 int_posx, int_posy, box_size,
 *                 0, dimx, 0, dimy)             # <<<<<<<<<<<<<<
 *             hsz = <int> (<double> box_size / 2.)
 *             if int_posx - x_min != hsz:
 */
    __pyx_t_29 = __Pyx_PyInt_From_int(__pyx_v_dimx); if (unlikely(!__pyx_t_29)) __PYX_ERR(0, 1421, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_29);
    __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_dimy); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1421, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __pyx_t_4 = NULL;
    __pyx_t_33 = 0;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_2))) {
      __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_2);
      if (likely(__pyx_t_4)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
        __Pyx_INCREF(__pyx_t_4);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_2, function);
        __pyx_t_33 = 1;
      }
    }
    __pyx_t_14 = PyTuple_New(7+__pyx_t_33); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 1419, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_14);
    if (__pyx_t_4) {
      __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_14, 0, __pyx_t_4); __pyx_t_4 = NULL;
    }
    __Pyx_GIVEREF(__pyx_t_34);
    PyTuple_SET_ITEM(__pyx_t_14, 0+__pyx_t_33, __pyx_t_34);
    __Pyx_GIVEREF(__pyx_t_31);
    PyTuple_SET_ITEM(__pyx_t_14, 1+__pyx_t_33, __pyx_t_31);
    __Pyx_GIVEREF(__pyx_t_30);
    PyTuple_SET_ITEM(__pyx_t_14, 2+__pyx_t_33, __pyx_t_30);
    __Pyx_INCREF(__pyx_int_0);
    __Pyx_GIVEREF(__pyx_int_0);
    PyTuple_SET_ITEM(__pyx_t_14, 3+__pyx_t_33, __pyx_int_0);
    __Pyx_GIVEREF(__pyx_t_29);
    PyTuple_SET_ITEM(__pyx_t_14, 4+__pyx_t_33, __pyx_t_29);
    __Pyx_INCREF(__pyx_int_0);
    __Pyx_GIVEREF(__pyx_int_0);
    PyTuple_SET_ITEM(__pyx_t_14, 5+__pyx_t_33, __pyx_int_0);
    __Pyx_GIVEREF(__pyx_t_1);
    PyTuple_SET_ITEM(__pyx_t_14, 6+__pyx_t_33, __pyx_t_1);
    __pyx_t_34 = 0;
    __pyx_t_31 = 0;
    __pyx_t_30 = 0;
    __pyx_t_29 = 0;
    __pyx_t_1 = 0;
    __pyx_t_3 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_14, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1419, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    if ((likely(PyTuple_CheckExact(__pyx_t_3))) || (PyList_CheckExact(__pyx_t_3))) {
      PyObject* sequence = __pyx_t_3;
      #if CYTHON_COMPILING_IN_CPYTHON
      Py_ssize_t size = Py_SIZE(sequence);
      #else
      Py_ssize_t size = PySequence_Size(sequence);
      #endif
      if (unlikely(size != 4)) {
        if (size > 4) __Pyx_RaiseTooManyValuesError(4);
        else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
        __PYX_ERR(0, 1419, __pyx_L1_error)
      }
      #if CYTHON_COMPILING_IN_CPYTHON
      if (likely(PyTuple_CheckExact(sequence))) {
        __pyx_t_2 = PyTuple_GET_ITEM(sequence, 0); 
        __pyx_t_14 = PyTuple_GET_ITEM(sequence, 1); 
        __pyx_t_1 = PyTuple_GET_ITEM(sequence, 2); 
        __pyx_t_29 = PyTuple_GET_ITEM(sequence, 3); 
      } else {
        __pyx_t_2 = PyList_GET_ITEM(sequence, 0); 
        __pyx_t_14 = PyList_GET_ITEM(sequence, 1); 
        __pyx_t_1 = PyList_GET_ITEM(sequence, 2); 
        __pyx_t_29 = PyList_GET_ITEM(sequence, 3); 
      }
      __Pyx_INCREF(__pyx_t_2);
      __Pyx_INCREF(__pyx_t_14);
      __Pyx_INCREF(__pyx_t_1);
      __Pyx_INCREF(__pyx_t_29);
      #else
      {
        Py_ssize_t i;
        PyObject** temps[4] = {&__pyx_t_2,&__pyx_t_14,&__pyx_t_1,&__pyx_t_29};
        for (i=0; i < 4; i++) {
          PyObject* item = PySequence_ITEM(sequence, i); if (unlikely(!item)) __PYX_ERR(0, 1419, __pyx_L1_error)
          __Pyx_GOTREF(item);
          *(temps[i]) = item;
        }
      }
      #endif
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    } else {
      Py_ssize_t index = -1;
      PyObject** temps[4] = {&__pyx_t_2,&__pyx_t_14,&__pyx_t_1,&__pyx_t_29};
      __pyx_t_30 = PyObject_GetIter(__pyx_t_3); if (unlikely(!__pyx_t_30)) __PYX_ERR(0, 1419, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_30);
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      __pyx_t_37 = Py_TYPE(__pyx_t_30)->tp_iternext;
      for (index=0; index < 4; index++) {
        PyObject* item = __pyx_t_37(__pyx_t_30); if (unlikely(!item)) goto __pyx_L6_unpacking_failed;
        __Pyx_GOTREF(item);
        *(temps[index]) = item;
      }
      if (__Pyx_IternextUnpackEndCheck(__pyx_t_37(__pyx_t_30), 4) < 0) __PYX_ERR(0, 1419, __pyx_L1_error)
      __pyx_t_37 = NULL;
      __Pyx_DECREF(__pyx_t_30); __pyx_t_30 = 0;
      goto __pyx_L7_unpacking_done;
      __pyx_L6_unpacking_failed:;
      __Pyx_DECREF(__pyx_t_30); __pyx_t_30 = 0;
      __pyx_t_37 = NULL;
      if (__Pyx_IterFinish() == 0) __Pyx_RaiseNeedMoreValuesError(index);
      __PYX_ERR(0, 1419, __pyx_L1_error)
      __pyx_L7_unpacking_done:;
    }

    /* "orb/cutils.pyx":1419
 *             star += params[istar,0]
 * 
 *             x_min, x_max, y_min, y_max = get_box_coords(             # <<<<<<<<<<<<<<
 *                 int_posx, int_posy, box_size,
 *                 0, dimx, 0, dimy)
 */
    __pyx_t_18 = __Pyx_PyInt_As_int(__pyx_t_2); if (unlikely((__pyx_t_18 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 1419, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __pyx_t_38 = __Pyx_PyInt_As_int(__pyx_t_14); if (unlikely((__pyx_t_38 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 1419, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
    __pyx_t_39 = __Pyx_PyInt_As_int(__pyx_t_1); if (unlikely((__pyx_t_39 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 1419, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    __pyx_t_40 = __Pyx_PyInt_As_int(__pyx_t_29); if (unlikely((__pyx_t_40 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 1419, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_29); __pyx_t_29 = 0;
    __pyx_v_x_min = __pyx_t_18;
    __pyx_v_x_max = __pyx_t_38;
    __pyx_v_y_min = __pyx_t_39;
    __pyx_v_y_max = __pyx_t_40;

    /* "orb/cutils.pyx":1422
 *                 int_posx, int_posy, box_size,
 *                 0, dimx, 0, dimy)
 *             hsz = <int> (<double> box_size / 2.)             # <<<<<<<<<<<<<<
 *             if int_posx - x_min != hsz:
 *                 star = star[hsz - (int_posx - x_min):,:]
 */
    __pyx_v_hsz = ((int)(((double)__pyx_v_box_size) / 2.));

    /* "orb/cutils.pyx":1423
 *                 0, dimx, 0, dimy)
 *             hsz = <int> (<double> box_size / 2.)
 *             if int_posx - x_min != hsz:             # <<<<<<<<<<<<<<
 *                 star = star[hsz - (int_posx - x_min):,:]
 *             if x_max - int_posx != hsz + 1:
 */
    __pyx_t_8 = (((__pyx_v_int_posx - __pyx_v_x_min) != __pyx_v_hsz) != 0);
    if (__pyx_t_8) {

      /* "orb/cutils.pyx":1424
 *             hsz = <int> (<double> box_size / 2.)
 *             if int_posx - x_min != hsz:
 *                 star = star[hsz - (int_posx - x_min):,:]             # <<<<<<<<<<<<<<
 *             if x_max - int_posx != hsz + 1:
 *                 star = star[:-(hsz + 1 - (x_max - int_posx)), :]
 */
      __pyx_t_3 = __Pyx_PyInt_From_int((__pyx_v_hsz - (__pyx_v_int_posx - __pyx_v_x_min))); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1424, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __pyx_t_29 = PySlice_New(__pyx_t_3, Py_None, Py_None); if (unlikely(!__pyx_t_29)) __PYX_ERR(0, 1424, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_29);
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      __pyx_t_3 = PyTuple_New(2); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1424, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __Pyx_GIVEREF(__pyx_t_29);
      PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_29);
      __Pyx_INCREF(__pyx_slice__64);
      __Pyx_GIVEREF(__pyx_slice__64);
      PyTuple_SET_ITEM(__pyx_t_3, 1, __pyx_slice__64);
      __pyx_t_29 = 0;
      __pyx_t_29 = PyObject_GetItem(((PyObject *)__pyx_v_star), __pyx_t_3); if (unlikely(!__pyx_t_29)) __PYX_ERR(0, 1424, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_29);
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      if (!(likely(((__pyx_t_29) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_29, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1424, __pyx_L1_error)
      __pyx_t_5 = ((PyArrayObject *)__pyx_t_29);
      {
        __Pyx_BufFmt_StackElem __pyx_stack[1];
        __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_star.rcbuffer->pybuffer);
        __pyx_t_40 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_star.rcbuffer->pybuffer, (PyObject*)__pyx_t_5, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
        if (unlikely(__pyx_t_40 < 0)) {
          PyErr_Fetch(&__pyx_t_11, &__pyx_t_12, &__pyx_t_13);
          if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_star.rcbuffer->pybuffer, (PyObject*)__pyx_v_star, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
            Py_XDECREF(__pyx_t_11); Py_XDECREF(__pyx_t_12); Py_XDECREF(__pyx_t_13);
            __Pyx_RaiseBufferFallbackError();
          } else {
            PyErr_Restore(__pyx_t_11, __pyx_t_12, __pyx_t_13);
          }
        }
        __pyx_pybuffernd_star.diminfo[0].strides = __pyx_pybuffernd_star.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_star.diminfo[0].shape = __pyx_pybuffernd_star.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_star.diminfo[1].strides = __pyx_pybuffernd_star.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_star.diminfo[1].shape = __pyx_pybuffernd_star.rcbuffer->pybuffer.shape[1];
        if (unlikely(__pyx_t_40 < 0)) __PYX_ERR(0, 1424, __pyx_L1_error)
      }
      __pyx_t_5 = 0;
      __Pyx_DECREF_SET(__pyx_v_star, ((PyArrayObject *)__pyx_t_29));
      __pyx_t_29 = 0;

      /* "orb/cutils.pyx":1423
 *                 0, dimx, 0, dimy)
 *             hsz = <int> (<double> box_size / 2.)
 *             if int_posx - x_min != hsz:             # <<<<<<<<<<<<<<
 *                 star = star[hsz - (int_posx - x_min):,:]
 *             if x_max - int_posx != hsz + 1:
 */
    }

    /* "orb/cutils.pyx":1425
 *             if int_posx - x_min != hsz:
 *                 star = star[hsz - (int_posx - x_min):,:]
 *             if x_max - int_posx != hsz + 1:             # <<<<<<<<<<<<<<
 *                 star = star[:-(hsz + 1 - (x_max - int_posx)), :]
 *             if int_posy - y_min != hsz:
 */
    __pyx_t_8 = (((__pyx_v_x_max - __pyx_v_int_posx) != (__pyx_v_hsz + 1)) != 0);
    if (__pyx_t_8) {

      /* "orb/cutils.pyx":1426
 *                 star = star[hsz - (int_posx - x_min):,:]
 *             if x_max - int_posx != hsz + 1:
 *                 star = star[:-(hsz + 1 - (x_max - int_posx)), :]             # <<<<<<<<<<<<<<
 *             if int_posy - y_min != hsz:
 *                 star = star[:, hsz - (int_posy - y_min):]
 */
      __pyx_t_29 = __Pyx_PyInt_From_long((-((__pyx_v_hsz + 1) - (__pyx_v_x_max - __pyx_v_int_posx)))); if (unlikely(!__pyx_t_29)) __PYX_ERR(0, 1426, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_29);
      __pyx_t_3 = PySlice_New(Py_None, __pyx_t_29, Py_None); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1426, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __Pyx_DECREF(__pyx_t_29); __pyx_t_29 = 0;
      __pyx_t_29 = PyTuple_New(2); if (unlikely(!__pyx_t_29)) __PYX_ERR(0, 1426, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_29);
      __Pyx_GIVEREF(__pyx_t_3);
      PyTuple_SET_ITEM(__pyx_t_29, 0, __pyx_t_3);
      __Pyx_INCREF(__pyx_slice__65);
      __Pyx_GIVEREF(__pyx_slice__65);
      PyTuple_SET_ITEM(__pyx_t_29, 1, __pyx_slice__65);
      __pyx_t_3 = 0;
      __pyx_t_3 = PyObject_GetItem(((PyObject *)__pyx_v_star), __pyx_t_29); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1426, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __Pyx_DECREF(__pyx_t_29); __pyx_t_29 = 0;
      if (!(likely(((__pyx_t_3) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_3, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1426, __pyx_L1_error)
      __pyx_t_5 = ((PyArrayObject *)__pyx_t_3);
      {
        __Pyx_BufFmt_StackElem __pyx_stack[1];
        __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_star.rcbuffer->pybuffer);
        __pyx_t_40 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_star.rcbuffer->pybuffer, (PyObject*)__pyx_t_5, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
        if (unlikely(__pyx_t_40 < 0)) {
          PyErr_Fetch(&__pyx_t_13, &__pyx_t_12, &__pyx_t_11);
          if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_star.rcbuffer->pybuffer, (PyObject*)__pyx_v_star, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
            Py_XDECREF(__pyx_t_13); Py_XDECREF(__pyx_t_12); Py_XDECREF(__pyx_t_11);
            __Pyx_RaiseBufferFallbackError();
          } else {
            PyErr_Restore(__pyx_t_13, __pyx_t_12, __pyx_t_11);
          }
        }
        __pyx_pybuffernd_star.diminfo[0].strides = __pyx_pybuffernd_star.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_star.diminfo[0].shape = __pyx_pybuffernd_star.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_star.diminfo[1].strides = __pyx_pybuffernd_star.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_star.diminfo[1].shape = __pyx_pybuffernd_star.rcbuffer->pybuffer.shape[1];
        if (unlikely(__pyx_t_40 < 0)) __PYX_ERR(0, 1426, __pyx_L1_error)
      }
      __pyx_t_5 = 0;
      __Pyx_DECREF_SET(__pyx_v_star, ((PyArrayObject *)__pyx_t_3));
      __pyx_t_3 = 0;

      /* "orb/cutils.pyx":1425
 *             if int_posx - x_min != hsz:
 *                 star = star[hsz - (int_posx - x_min):,:]
 *             if x_max - int_posx != hsz + 1:             # <<<<<<<<<<<<<<
 *                 star = star[:-(hsz + 1 - (x_max - int_posx)), :]
 *             if int_posy - y_min != hsz:
 */
    }

    /* "orb/cutils.pyx":1427
 *             if x_max - int_posx != hsz + 1:
 *                 star = star[:-(hsz + 1 - (x_max - int_posx)), :]
 *             if int_posy - y_min != hsz:             # <<<<<<<<<<<<<<
 *                 star = star[:, hsz - (int_posy - y_min):]
 *             if y_max - int_posy != hsz + 1:
 */
    __pyx_t_8 = (((__pyx_v_int_posy - __pyx_v_y_min) != __pyx_v_hsz) != 0);
    if (__pyx_t_8) {

      /* "orb/cutils.pyx":1428
 *                 star = star[:-(hsz + 1 - (x_max - int_posx)), :]
 *             if int_posy - y_min != hsz:
 *                 star = star[:, hsz - (int_posy - y_min):]             # <<<<<<<<<<<<<<
 *             if y_max - int_posy != hsz + 1:
 *                 star = star[:, :-(hsz + 1 - (y_max - int_posy))]
 */
      __pyx_t_3 = __Pyx_PyInt_From_int((__pyx_v_hsz - (__pyx_v_int_posy - __pyx_v_y_min))); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1428, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __pyx_t_29 = PySlice_New(__pyx_t_3, Py_None, Py_None); if (unlikely(!__pyx_t_29)) __PYX_ERR(0, 1428, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_29);
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      __pyx_t_3 = PyTuple_New(2); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1428, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __Pyx_INCREF(__pyx_slice__66);
      __Pyx_GIVEREF(__pyx_slice__66);
      PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_slice__66);
      __Pyx_GIVEREF(__pyx_t_29);
      PyTuple_SET_ITEM(__pyx_t_3, 1, __pyx_t_29);
      __pyx_t_29 = 0;
      __pyx_t_29 = PyObject_GetItem(((PyObject *)__pyx_v_star), __pyx_t_3); if (unlikely(!__pyx_t_29)) __PYX_ERR(0, 1428, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_29);
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      if (!(likely(((__pyx_t_29) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_29, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1428, __pyx_L1_error)
      __pyx_t_5 = ((PyArrayObject *)__pyx_t_29);
      {
        __Pyx_BufFmt_StackElem __pyx_stack[1];
        __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_star.rcbuffer->pybuffer);
        __pyx_t_40 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_star.rcbuffer->pybuffer, (PyObject*)__pyx_t_5, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
        if (unlikely(__pyx_t_40 < 0)) {
          PyErr_Fetch(&__pyx_t_11, &__pyx_t_12, &__pyx_t_13);
          if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_star.rcbuffer->pybuffer, (PyObject*)__pyx_v_star, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
            Py_XDECREF(__pyx_t_11); Py_XDECREF(__pyx_t_12); Py_XDECREF(__pyx_t_13);
            __Pyx_RaiseBufferFallbackError();
          } else {
            PyErr_Restore(__pyx_t_11, __pyx_t_12, __pyx_t_13);
          }
        }
        __pyx_pybuffernd_star.diminfo[0].strides = __pyx_pybuffernd_star.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_star.diminfo[0].shape = __pyx_pybuffernd_star.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_star.diminfo[1].strides = __pyx_pybuffernd_star.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_star.diminfo[1].shape = __pyx_pybuffernd_star.rcbuffer->pybuffer.shape[1];
        if (unlikely(__pyx_t_40 < 0)) __PYX_ERR(0, 1428, __pyx_L1_error)
      }
      __pyx_t_5 = 0;
      __Pyx_DECREF_SET(__pyx_v_star, ((PyArrayObject *)__pyx_t_29));
      __pyx_t_29 = 0;

      /* "orb/cutils.pyx":1427
 *             if x_max - int_posx != hsz + 1:
 *                 star = star[:-(hsz + 1 - (x_max - int_posx)), :]
 *             if int_posy - y_min != hsz:             # <<<<<<<<<<<<<<
 *                 star = star[:, hsz - (int_posy - y_min):]
 *             if y_max - int_posy != hsz + 1:
 */
    }

    /* "orb/cutils.pyx":1429
 *             if int_posy - y_min != hsz:
 *                 star = star[:, hsz - (int_posy - y_min):]
 *             if y_max - int_posy != hsz + 1:             # <<<<<<<<<<<<<<
 *                 star = star[:, :-(hsz + 1 - (y_max - int_posy))]
 * 
 */
    __pyx_t_8 = (((__pyx_v_y_max - __pyx_v_int_posy) != (__pyx_v_hsz + 1)) != 0);
    if (__pyx_t_8) {

      /* "orb/cutils.pyx":1430
 *                 star = star[:, hsz - (int_posy - y_min):]
 *             if y_max - int_posy != hsz + 1:
 *                 star = star[:, :-(hsz + 1 - (y_max - int_posy))]             # <<<<<<<<<<<<<<
 * 
 *             if star.shape[0] > 1 and star.shape[1] > 1:
 */
      __pyx_t_29 = __Pyx_PyInt_From_long((-((__pyx_v_hsz + 1) - (__pyx_v_y_max - __pyx_v_int_posy)))); if (unlikely(!__pyx_t_29)) __PYX_ERR(0, 1430, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_29);
      __pyx_t_3 = PySlice_New(Py_None, __pyx_t_29, Py_None); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1430, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __Pyx_DECREF(__pyx_t_29); __pyx_t_29 = 0;
      __pyx_t_29 = PyTuple_New(2); if (unlikely(!__pyx_t_29)) __PYX_ERR(0, 1430, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_29);
      __Pyx_INCREF(__pyx_slice__67);
      __Pyx_GIVEREF(__pyx_slice__67);
      PyTuple_SET_ITEM(__pyx_t_29, 0, __pyx_slice__67);
      __Pyx_GIVEREF(__pyx_t_3);
      PyTuple_SET_ITEM(__pyx_t_29, 1, __pyx_t_3);
      __pyx_t_3 = 0;
      __pyx_t_3 = PyObject_GetItem(((PyObject *)__pyx_v_star), __pyx_t_29); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1430, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __Pyx_DECREF(__pyx_t_29); __pyx_t_29 = 0;
      if (!(likely(((__pyx_t_3) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_3, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1430, __pyx_L1_error)
      __pyx_t_5 = ((PyArrayObject *)__pyx_t_3);
      {
        __Pyx_BufFmt_StackElem __pyx_stack[1];
        __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_star.rcbuffer->pybuffer);
        __pyx_t_40 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_star.rcbuffer->pybuffer, (PyObject*)__pyx_t_5, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
        if (unlikely(__pyx_t_40 < 0)) {
          PyErr_Fetch(&__pyx_t_13, &__pyx_t_12, &__pyx_t_11);
          if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_star.rcbuffer->pybuffer, (PyObject*)__pyx_v_star, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
            Py_XDECREF(__pyx_t_13); Py_XDECREF(__pyx_t_12); Py_XDECREF(__pyx_t_11);
            __Pyx_RaiseBufferFallbackError();
          } else {
            PyErr_Restore(__pyx_t_13, __pyx_t_12, __pyx_t_11);
          }
        }
        __pyx_pybuffernd_star.diminfo[0].strides = __pyx_pybuffernd_star.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_star.diminfo[0].shape = __pyx_pybuffernd_star.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_star.diminfo[1].strides = __pyx_pybuffernd_star.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_star.diminfo[1].shape = __pyx_pybuffernd_star.rcbuffer->pybuffer.shape[1];
        if (unlikely(__pyx_t_40 < 0)) __PYX_ERR(0, 1430, __pyx_L1_error)
      }
      __pyx_t_5 = 0;
      __Pyx_DECREF_SET(__pyx_v_star, ((PyArrayObject *)__pyx_t_3));
      __pyx_t_3 = 0;

      /* "orb/cutils.pyx":1429
 *             if int_posy - y_min != hsz:
 *                 star = star[:, hsz - (int_posy - y_min):]
 *             if y_max - int_posy != hsz + 1:             # <<<<<<<<<<<<<<
 *                 star = star[:, :-(hsz + 1 - (y_max - int_posy))]
 * 
 */
    }

    /* "orb/cutils.pyx":1432
 *                 star = star[:, :-(hsz + 1 - (y_max - int_posy))]
 * 
 *             if star.shape[0] > 1 and star.shape[1] > 1:             # <<<<<<<<<<<<<<
 *                 data = frame[<int> x_min:<int> x_max, <int> y_min:<int> y_max]
 *                 star = (star - data) #/ sigma(data, noise[istar], dcl)
 */
    __pyx_t_7 = (((__pyx_v_star->dimensions[0]) > 1) != 0);
    if (__pyx_t_7) {
    } else {
      __pyx_t_8 = __pyx_t_7;
      goto __pyx_L13_bool_binop_done;
    }
    __pyx_t_7 = (((__pyx_v_star->dimensions[1]) > 1) != 0);
    __pyx_t_8 = __pyx_t_7;
    __pyx_L13_bool_binop_done:;
    if (__pyx_t_8) {

      /* "orb/cutils.pyx":1433
 * 
 *             if star.shape[0] > 1 and star.shape[1] > 1:
 *                 data = frame[<int> x_min:<int> x_max, <int> y_min:<int> y_max]             # <<<<<<<<<<<<<<
 *                 star = (star - data) #/ sigma(data, noise[istar], dcl)
 *                 if saturation > 0.:
 */
      __pyx_t_3 = __Pyx_PyInt_From_int(((int)__pyx_v_x_min)); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1433, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __pyx_t_29 = __Pyx_PyInt_From_int(((int)__pyx_v_x_max)); if (unlikely(!__pyx_t_29)) __PYX_ERR(0, 1433, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_29);
      __pyx_t_1 = PySlice_New(__pyx_t_3, __pyx_t_29, Py_None); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1433, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      __Pyx_DECREF(__pyx_t_29); __pyx_t_29 = 0;
      __pyx_t_29 = __Pyx_PyInt_From_int(((int)__pyx_v_y_min)); if (unlikely(!__pyx_t_29)) __PYX_ERR(0, 1433, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_29);
      __pyx_t_3 = __Pyx_PyInt_From_int(((int)__pyx_v_y_max)); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1433, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __pyx_t_14 = PySlice_New(__pyx_t_29, __pyx_t_3, Py_None); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 1433, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_14);
      __Pyx_DECREF(__pyx_t_29); __pyx_t_29 = 0;
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      __pyx_t_3 = PyTuple_New(2); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1433, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __Pyx_GIVEREF(__pyx_t_1);
      PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_1);
      __Pyx_GIVEREF(__pyx_t_14);
      PyTuple_SET_ITEM(__pyx_t_3, 1, __pyx_t_14);
      __pyx_t_1 = 0;
      __pyx_t_14 = 0;
      __pyx_t_14 = PyObject_GetItem(((PyObject *)__pyx_v_frame), __pyx_t_3); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 1433, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_14);
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      if (!(likely(((__pyx_t_14) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_14, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1433, __pyx_L1_error)
      __pyx_t_6 = ((PyArrayObject *)__pyx_t_14);
      {
        __Pyx_BufFmt_StackElem __pyx_stack[1];
        __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_data.rcbuffer->pybuffer);
        __pyx_t_40 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_data.rcbuffer->pybuffer, (PyObject*)__pyx_t_6, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
        if (unlikely(__pyx_t_40 < 0)) {
          PyErr_Fetch(&__pyx_t_11, &__pyx_t_12, &__pyx_t_13);
          if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_data.rcbuffer->pybuffer, (PyObject*)__pyx_v_data, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
            Py_XDECREF(__pyx_t_11); Py_XDECREF(__pyx_t_12); Py_XDECREF(__pyx_t_13);
            __Pyx_RaiseBufferFallbackError();
          } else {
            PyErr_Restore(__pyx_t_11, __pyx_t_12, __pyx_t_13);
          }
        }
        __pyx_pybuffernd_data.diminfo[0].strides = __pyx_pybuffernd_data.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_data.diminfo[0].shape = __pyx_pybuffernd_data.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_data.diminfo[1].strides = __pyx_pybuffernd_data.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_data.diminfo[1].shape = __pyx_pybuffernd_data.rcbuffer->pybuffer.shape[1];
        if (unlikely(__pyx_t_40 < 0)) __PYX_ERR(0, 1433, __pyx_L1_error)
      }
      __pyx_t_6 = 0;
      __Pyx_DECREF_SET(__pyx_v_data, ((PyArrayObject *)__pyx_t_14));
      __pyx_t_14 = 0;

      /* "orb/cutils.pyx":1434
 *             if star.shape[0] > 1 and star.shape[1] > 1:
 *                 data = frame[<int> x_min:<int> x_max, <int> y_min:<int> y_max]
 *                 star = (star - data) #/ sigma(data, noise[istar], dcl)             # <<<<<<<<<<<<<<
 *                 if saturation > 0.:
 *                     star[np.nonzero(data >= saturation)] = np.nan
 */
      __pyx_t_14 = PyNumber_Subtract(((PyObject *)__pyx_v_star), ((PyObject *)__pyx_v_data)); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 1434, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_14);
      if (!(likely(((__pyx_t_14) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_14, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1434, __pyx_L1_error)
      __pyx_t_5 = ((PyArrayObject *)__pyx_t_14);
      {
        __Pyx_BufFmt_StackElem __pyx_stack[1];
        __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_star.rcbuffer->pybuffer);
        __pyx_t_40 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_star.rcbuffer->pybuffer, (PyObject*)__pyx_t_5, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
        if (unlikely(__pyx_t_40 < 0)) {
          PyErr_Fetch(&__pyx_t_13, &__pyx_t_12, &__pyx_t_11);
          if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_star.rcbuffer->pybuffer, (PyObject*)__pyx_v_star, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
            Py_XDECREF(__pyx_t_13); Py_XDECREF(__pyx_t_12); Py_XDECREF(__pyx_t_11);
            __Pyx_RaiseBufferFallbackError();
          } else {
            PyErr_Restore(__pyx_t_13, __pyx_t_12, __pyx_t_11);
          }
        }
        __pyx_pybuffernd_star.diminfo[0].strides = __pyx_pybuffernd_star.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_star.diminfo[0].shape = __pyx_pybuffernd_star.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_star.diminfo[1].strides = __pyx_pybuffernd_star.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_star.diminfo[1].shape = __pyx_pybuffernd_star.rcbuffer->pybuffer.shape[1];
        if (unlikely(__pyx_t_40 < 0)) __PYX_ERR(0, 1434, __pyx_L1_error)
      }
      __pyx_t_5 = 0;
      __Pyx_DECREF_SET(__pyx_v_star, ((PyArrayObject *)__pyx_t_14));
      __pyx_t_14 = 0;

      /* "orb/cutils.pyx":1435
 *                 data = frame[<int> x_min:<int> x_max, <int> y_min:<int> y_max]
 *                 star = (star - data) #/ sigma(data, noise[istar], dcl)
 *                 if saturation > 0.:             # <<<<<<<<<<<<<<
 *                     star[np.nonzero(data >= saturation)] = np.nan
 * 
 */
      __pyx_t_8 = ((__pyx_v_saturation > 0.) != 0);
      if (__pyx_t_8) {

        /* "orb/cutils.pyx":1436
 *                 star = (star - data) #/ sigma(data, noise[istar], dcl)
 *                 if saturation > 0.:
 *                     star[np.nonzero(data >= saturation)] = np.nan             # <<<<<<<<<<<<<<
 * 
 *                 if normalize:
 */
        __pyx_t_14 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 1436, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_14);
        __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_14, __pyx_n_s_nan); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1436, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_3);
        __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
        __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1436, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_1);
        __pyx_t_29 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_nonzero); if (unlikely(!__pyx_t_29)) __PYX_ERR(0, 1436, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_29);
        __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
        __pyx_t_1 = PyFloat_FromDouble(__pyx_v_saturation); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1436, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_1);
        __pyx_t_2 = PyObject_RichCompare(((PyObject *)__pyx_v_data), __pyx_t_1, Py_GE); __Pyx_XGOTREF(__pyx_t_2); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1436, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
        __pyx_t_1 = NULL;
        if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_29))) {
          __pyx_t_1 = PyMethod_GET_SELF(__pyx_t_29);
          if (likely(__pyx_t_1)) {
            PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_29);
            __Pyx_INCREF(__pyx_t_1);
            __Pyx_INCREF(function);
            __Pyx_DECREF_SET(__pyx_t_29, function);
          }
        }
        if (!__pyx_t_1) {
          __pyx_t_14 = __Pyx_PyObject_CallOneArg(__pyx_t_29, __pyx_t_2); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 1436, __pyx_L1_error)
          __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
          __Pyx_GOTREF(__pyx_t_14);
        } else {
          __pyx_t_30 = PyTuple_New(1+1); if (unlikely(!__pyx_t_30)) __PYX_ERR(0, 1436, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_30);
          __Pyx_GIVEREF(__pyx_t_1); PyTuple_SET_ITEM(__pyx_t_30, 0, __pyx_t_1); __pyx_t_1 = NULL;
          __Pyx_GIVEREF(__pyx_t_2);
          PyTuple_SET_ITEM(__pyx_t_30, 0+1, __pyx_t_2);
          __pyx_t_2 = 0;
          __pyx_t_14 = __Pyx_PyObject_Call(__pyx_t_29, __pyx_t_30, NULL); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 1436, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_14);
          __Pyx_DECREF(__pyx_t_30); __pyx_t_30 = 0;
        }
        __Pyx_DECREF(__pyx_t_29); __pyx_t_29 = 0;
        if (unlikely(PyObject_SetItem(((PyObject *)__pyx_v_star), __pyx_t_14, __pyx_t_3) < 0)) __PYX_ERR(0, 1436, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;

        /* "orb/cutils.pyx":1435
 *                 data = frame[<int> x_min:<int> x_max, <int> y_min:<int> y_max]
 *                 star = (star - data) #/ sigma(data, noise[istar], dcl)
 *                 if saturation > 0.:             # <<<<<<<<<<<<<<
 *                     star[np.nonzero(data >= saturation)] = np.nan
 * 
 */
      }

      /* "orb/cutils.pyx":1438
 *                     star[np.nonzero(data >= saturation)] = np.nan
 * 
 *                 if normalize:             # <<<<<<<<<<<<<<
 *                     star /= np.nanmax(star)
 * 
 */
      __pyx_t_8 = __Pyx_PyObject_IsTrue(__pyx_v_normalize); if (unlikely(__pyx_t_8 < 0)) __PYX_ERR(0, 1438, __pyx_L1_error)
      if (__pyx_t_8) {

        /* "orb/cutils.pyx":1439
 * 
 *                 if normalize:
 *                     star /= np.nanmax(star)             # <<<<<<<<<<<<<<
 * 
 *                 if not transpose:
 */
        __pyx_t_14 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 1439, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_14);
        __pyx_t_29 = __Pyx_PyObject_GetAttrStr(__pyx_t_14, __pyx_n_s_nanmax); if (unlikely(!__pyx_t_29)) __PYX_ERR(0, 1439, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_29);
        __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
        __pyx_t_14 = NULL;
        if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_29))) {
          __pyx_t_14 = PyMethod_GET_SELF(__pyx_t_29);
          if (likely(__pyx_t_14)) {
            PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_29);
            __Pyx_INCREF(__pyx_t_14);
            __Pyx_INCREF(function);
            __Pyx_DECREF_SET(__pyx_t_29, function);
          }
        }
        if (!__pyx_t_14) {
          __pyx_t_3 = __Pyx_PyObject_CallOneArg(__pyx_t_29, ((PyObject *)__pyx_v_star)); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1439, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_3);
        } else {
          __pyx_t_30 = PyTuple_New(1+1); if (unlikely(!__pyx_t_30)) __PYX_ERR(0, 1439, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_30);
          __Pyx_GIVEREF(__pyx_t_14); PyTuple_SET_ITEM(__pyx_t_30, 0, __pyx_t_14); __pyx_t_14 = NULL;
          __Pyx_INCREF(((PyObject *)__pyx_v_star));
          __Pyx_GIVEREF(((PyObject *)__pyx_v_star));
          PyTuple_SET_ITEM(__pyx_t_30, 0+1, ((PyObject *)__pyx_v_star));
          __pyx_t_3 = __Pyx_PyObject_Call(__pyx_t_29, __pyx_t_30, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1439, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_3);
          __Pyx_DECREF(__pyx_t_30); __pyx_t_30 = 0;
        }
        __Pyx_DECREF(__pyx_t_29); __pyx_t_29 = 0;
        __pyx_t_29 = __Pyx_PyNumber_InPlaceDivide(((PyObject *)__pyx_v_star), __pyx_t_3); if (unlikely(!__pyx_t_29)) __PYX_ERR(0, 1439, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_29);
        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
        if (!(likely(((__pyx_t_29) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_29, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1439, __pyx_L1_error)
        __pyx_t_5 = ((PyArrayObject *)__pyx_t_29);
        {
          __Pyx_BufFmt_StackElem __pyx_stack[1];
          __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_star.rcbuffer->pybuffer);
          __pyx_t_40 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_star.rcbuffer->pybuffer, (PyObject*)__pyx_t_5, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
          if (unlikely(__pyx_t_40 < 0)) {
            PyErr_Fetch(&__pyx_t_11, &__pyx_t_12, &__pyx_t_13);
            if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_star.rcbuffer->pybuffer, (PyObject*)__pyx_v_star, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
              Py_XDECREF(__pyx_t_11); Py_XDECREF(__pyx_t_12); Py_XDECREF(__pyx_t_13);
              __Pyx_RaiseBufferFallbackError();
            } else {
              PyErr_Restore(__pyx_t_11, __pyx_t_12, __pyx_t_13);
            }
          }
          __pyx_pybuffernd_star.diminfo[0].strides = __pyx_pybuffernd_star.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_star.diminfo[0].shape = __pyx_pybuffernd_star.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_star.diminfo[1].strides = __pyx_pybuffernd_star.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_star.diminfo[1].shape = __pyx_pybuffernd_star.rcbuffer->pybuffer.shape[1];
          if (unlikely(__pyx_t_40 < 0)) __PYX_ERR(0, 1439, __pyx_L1_error)
        }
        __pyx_t_5 = 0;
        __Pyx_DECREF_SET(__pyx_v_star, ((PyArrayObject *)__pyx_t_29));
        __pyx_t_29 = 0;

        /* "orb/cutils.pyx":1438
 *                     star[np.nonzero(data >= saturation)] = np.nan
 * 
 *                 if normalize:             # <<<<<<<<<<<<<<
 *                     star /= np.nanmax(star)
 * 
 */
      }

      /* "orb/cutils.pyx":1441
 *                     star /= np.nanmax(star)
 * 
 *                 if not transpose:             # <<<<<<<<<<<<<<
 *                     res[istar * box_size:
 *                         istar * box_size + star.shape[0],
 */
      __pyx_t_8 = __Pyx_PyObject_IsTrue(__pyx_v_transpose); if (unlikely(__pyx_t_8 < 0)) __PYX_ERR(0, 1441, __pyx_L1_error)
      __pyx_t_7 = ((!__pyx_t_8) != 0);
      if (__pyx_t_7) {

        /* "orb/cutils.pyx":1442
 * 
 *                 if not transpose:
 *                     res[istar * box_size:             # <<<<<<<<<<<<<<
 *                         istar * box_size + star.shape[0],
 *                         0: star.shape[1]] = star
 */
        __pyx_t_29 = __Pyx_PyInt_From_int((__pyx_v_istar * __pyx_v_box_size)); if (unlikely(!__pyx_t_29)) __PYX_ERR(0, 1442, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_29);

        /* "orb/cutils.pyx":1443
 *                 if not transpose:
 *                     res[istar * box_size:
 *                         istar * box_size + star.shape[0],             # <<<<<<<<<<<<<<
 *                         0: star.shape[1]] = star
 *                 else:
 */
        __pyx_t_3 = __Pyx_PyInt_From_Py_intptr_t(((__pyx_v_istar * __pyx_v_box_size) + (__pyx_v_star->dimensions[0]))); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1443, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_3);

        /* "orb/cutils.pyx":1442
 * 
 *                 if not transpose:
 *                     res[istar * box_size:             # <<<<<<<<<<<<<<
 *                         istar * box_size + star.shape[0],
 *                         0: star.shape[1]] = star
 */
        __pyx_t_30 = PySlice_New(__pyx_t_29, __pyx_t_3, Py_None); if (unlikely(!__pyx_t_30)) __PYX_ERR(0, 1442, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_30);
        __Pyx_DECREF(__pyx_t_29); __pyx_t_29 = 0;
        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;

        /* "orb/cutils.pyx":1444
 *                     res[istar * box_size:
 *                         istar * box_size + star.shape[0],
 *                         0: star.shape[1]] = star             # <<<<<<<<<<<<<<
 *                 else:
 *                     res[0: star.shape[0],
 */
        __pyx_t_3 = __Pyx_PyInt_From_Py_intptr_t((__pyx_v_star->dimensions[1])); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1444, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_3);

        /* "orb/cutils.pyx":1442
 * 
 *                 if not transpose:
 *                     res[istar * box_size:             # <<<<<<<<<<<<<<
 *                         istar * box_size + star.shape[0],
 *                         0: star.shape[1]] = star
 */
        __pyx_t_29 = PySlice_New(__pyx_int_0, __pyx_t_3, Py_None); if (unlikely(!__pyx_t_29)) __PYX_ERR(0, 1442, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_29);
        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
        __pyx_t_3 = PyTuple_New(2); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1442, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_3);
        __Pyx_GIVEREF(__pyx_t_30);
        PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_30);
        __Pyx_GIVEREF(__pyx_t_29);
        PyTuple_SET_ITEM(__pyx_t_3, 1, __pyx_t_29);
        __pyx_t_30 = 0;
        __pyx_t_29 = 0;
        if (unlikely(PyObject_SetItem(((PyObject *)__pyx_v_res), __pyx_t_3, ((PyObject *)__pyx_v_star)) < 0)) __PYX_ERR(0, 1442, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;

        /* "orb/cutils.pyx":1441
 *                     star /= np.nanmax(star)
 * 
 *                 if not transpose:             # <<<<<<<<<<<<<<
 *                     res[istar * box_size:
 *                         istar * box_size + star.shape[0],
 */
        goto __pyx_L17;
      }

      /* "orb/cutils.pyx":1448
 *                     res[0: star.shape[0],
 *                         istar * box_size:
 *                         istar * box_size + star.shape[1]] = star             # <<<<<<<<<<<<<<
 * 
 *         return res
 */
      /*else*/ {

        /* "orb/cutils.pyx":1446
 *                         0: star.shape[1]] = star
 *                 else:
 *                     res[0: star.shape[0],             # <<<<<<<<<<<<<<
 *                         istar * box_size:
 *                         istar * box_size + star.shape[1]] = star
 */
        __pyx_t_3 = __Pyx_PyInt_From_Py_intptr_t((__pyx_v_star->dimensions[0])); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1446, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_3);
        __pyx_t_29 = PySlice_New(__pyx_int_0, __pyx_t_3, Py_None); if (unlikely(!__pyx_t_29)) __PYX_ERR(0, 1446, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_29);
        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;

        /* "orb/cutils.pyx":1447
 *                 else:
 *                     res[0: star.shape[0],
 *                         istar * box_size:             # <<<<<<<<<<<<<<
 *                         istar * box_size + star.shape[1]] = star
 * 
 */
        __pyx_t_3 = __Pyx_PyInt_From_int((__pyx_v_istar * __pyx_v_box_size)); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1447, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_3);

        /* "orb/cutils.pyx":1448
 *                     res[0: star.shape[0],
 *                         istar * box_size:
 *                         istar * box_size + star.shape[1]] = star             # <<<<<<<<<<<<<<
 * 
 *         return res
 */
        __pyx_t_30 = __Pyx_PyInt_From_Py_intptr_t(((__pyx_v_istar * __pyx_v_box_size) + (__pyx_v_star->dimensions[1]))); if (unlikely(!__pyx_t_30)) __PYX_ERR(0, 1448, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_30);

        /* "orb/cutils.pyx":1446
 *                         0: star.shape[1]] = star
 *                 else:
 *                     res[0: star.shape[0],             # <<<<<<<<<<<<<<
 *                         istar * box_size:
 *                         istar * box_size + star.shape[1]] = star
 */
        __pyx_t_14 = PySlice_New(__pyx_t_3, __pyx_t_30, Py_None); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 1446, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_14);
        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
        __Pyx_DECREF(__pyx_t_30); __pyx_t_30 = 0;
        __pyx_t_30 = PyTuple_New(2); if (unlikely(!__pyx_t_30)) __PYX_ERR(0, 1446, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_30);
        __Pyx_GIVEREF(__pyx_t_29);
        PyTuple_SET_ITEM(__pyx_t_30, 0, __pyx_t_29);
        __Pyx_GIVEREF(__pyx_t_14);
        PyTuple_SET_ITEM(__pyx_t_30, 1, __pyx_t_14);
        __pyx_t_29 = 0;
        __pyx_t_14 = 0;
        if (unlikely(PyObject_SetItem(((PyObject *)__pyx_v_res), __pyx_t_30, ((PyObject *)__pyx_v_star)) < 0)) __PYX_ERR(0, 1446, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_30); __pyx_t_30 = 0;
      }
      __pyx_L17:;

      /* "orb/cutils.pyx":1432
 *                 star = star[:, :-(hsz + 1 - (y_max - int_posy))]
 * 
 *             if star.shape[0] > 1 and star.shape[1] > 1:             # <<<<<<<<<<<<<<
 *                 data = frame[<int> x_min:<int> x_max, <int> y_min:<int> y_max]
 *                 star = (star - data) #/ sigma(data, noise[istar], dcl)
 */
    }
  }

  /* "orb/cutils.pyx":1450
 *                         istar * box_size + star.shape[1]] = star
 * 
 *         return res             # <<<<<<<<<<<<<<
 * 
 *     def diff(np.ndarray[np.float64_t, ndim=1] free_p,
 */
  __Pyx_XDECREF(__pyx_r);
  __Pyx_INCREF(((PyObject *)__pyx_v_res));
  __pyx_r = ((PyObject *)__pyx_v_res);
  goto __pyx_L0;

  /* "orb/cutils.pyx":1373
 *         return np.sqrt(np.abs(data) + (noise)**2. + dcl)
 * 
 *     def model_diff(int dimx, int dimy, np.ndarray[np.float64_t, ndim=2] params,             # <<<<<<<<<<<<<<
 *                    int box_size, np.ndarray[np.float64_t, ndim=2] frame,
 *                    np.ndarray[np.float64_t, ndim=1] noise, double dcl,
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_1);
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_XDECREF(__pyx_t_14);
  __Pyx_XDECREF(__pyx_t_29);
  __Pyx_XDECREF(__pyx_t_30);
  __Pyx_XDECREF(__pyx_t_31);
  __Pyx_XDECREF(__pyx_t_32);
  __Pyx_XDECREF(__pyx_t_34);
  { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
    __Pyx_PyThreadState_declare
    __Pyx_PyThreadState_assign
    __Pyx_ErrFetch(&__pyx_type, &__pyx_value, &__pyx_tb);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_data.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_frame.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_noise.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_params.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_res.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_star.rcbuffer->pybuffer);
  __Pyx_ErrRestore(__pyx_type, __pyx_value, __pyx_tb);}
  __Pyx_AddTraceback("orb.cutils.multi_fit_stars.model_diff", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  goto __pyx_L2;
  __pyx_L0:;
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_data.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_frame.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_noise.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_params.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_res.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_star.rcbuffer->pybuffer);
  __pyx_L2:;
  __Pyx_XDECREF((PyObject *)__pyx_v_star);
  __Pyx_XDECREF((PyObject *)__pyx_v_data);
  __Pyx_XDECREF((PyObject *)__pyx_v_res);
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":1452
 *         return res
 * 
 *     def diff(np.ndarray[np.float64_t, ndim=1] free_p,             # <<<<<<<<<<<<<<
 *              np.ndarray[np.float64_t, ndim=1] fixed_p,
 *              np.ndarray[np.float64_t, ndim=1] stars_p_mask,
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_15multi_fit_stars_9diff(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static PyMethodDef __pyx_mdef_3orb_6cutils_15multi_fit_stars_9diff = {"diff", (PyCFunction)__pyx_pw_3orb_6cutils_15multi_fit_stars_9diff, METH_VARARGS|METH_KEYWORDS, 0};
static PyObject *__pyx_pw_3orb_6cutils_15multi_fit_stars_9diff(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  PyArrayObject *__pyx_v_free_p = 0;
  PyArrayObject *__pyx_v_fixed_p = 0;
  PyArrayObject *__pyx_v_stars_p_mask = 0;
  PyArrayObject *__pyx_v_cov_p_mask = 0;
  PyArrayObject *__pyx_v_frame = 0;
  int __pyx_v_box_size;
  int __pyx_v_star_nb;
  PyArrayObject *__pyx_v_noise = 0;
  double __pyx_v_dcl;
  double __pyx_v_saturation;
  PyObject *__pyx_v_sip = 0;
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("diff (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_free_p,&__pyx_n_s_fixed_p,&__pyx_n_s_stars_p_mask,&__pyx_n_s_cov_p_mask,&__pyx_n_s_frame,&__pyx_n_s_box_size,&__pyx_n_s_star_nb,&__pyx_n_s_noise,&__pyx_n_s_dcl,&__pyx_n_s_saturation,&__pyx_n_s_sip,0};
    PyObject* values[11] = {0,0,0,0,0,0,0,0,0,0,0};
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
      switch (pos_args) {
        case 11: values[10] = PyTuple_GET_ITEM(__pyx_args, 10);
        case 10: values[9] = PyTuple_GET_ITEM(__pyx_args, 9);
        case  9: values[8] = PyTuple_GET_ITEM(__pyx_args, 8);
        case  8: values[7] = PyTuple_GET_ITEM(__pyx_args, 7);
        case  7: values[6] = PyTuple_GET_ITEM(__pyx_args, 6);
        case  6: values[5] = PyTuple_GET_ITEM(__pyx_args, 5);
        case  5: values[4] = PyTuple_GET_ITEM(__pyx_args, 4);
        case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = PyDict_Size(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_free_p)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        case  1:
        if (likely((values[1] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_fixed_p)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("diff", 1, 11, 11, 1); __PYX_ERR(0, 1452, __pyx_L3_error)
        }
        case  2:
        if (likely((values[2] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_stars_p_mask)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("diff", 1, 11, 11, 2); __PYX_ERR(0, 1452, __pyx_L3_error)
        }
        case  3:
        if (likely((values[3] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_cov_p_mask)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("diff", 1, 11, 11, 3); __PYX_ERR(0, 1452, __pyx_L3_error)
        }
        case  4:
        if (likely((values[4] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_frame)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("diff", 1, 11, 11, 4); __PYX_ERR(0, 1452, __pyx_L3_error)
        }
        case  5:
        if (likely((values[5] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_box_size)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("diff", 1, 11, 11, 5); __PYX_ERR(0, 1452, __pyx_L3_error)
        }
        case  6:
        if (likely((values[6] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_star_nb)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("diff", 1, 11, 11, 6); __PYX_ERR(0, 1452, __pyx_L3_error)
        }
        case  7:
        if (likely((values[7] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_noise)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("diff", 1, 11, 11, 7); __PYX_ERR(0, 1452, __pyx_L3_error)
        }
        case  8:
        if (likely((values[8] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_dcl)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("diff", 1, 11, 11, 8); __PYX_ERR(0, 1452, __pyx_L3_error)
        }
        case  9:
        if (likely((values[9] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_saturation)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("diff", 1, 11, 11, 9); __PYX_ERR(0, 1452, __pyx_L3_error)
        }
        case 10:
        if (likely((values[10] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_sip)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("diff", 1, 11, 11, 10); __PYX_ERR(0, 1452, __pyx_L3_error)
        }
      }
      if (unlikely(kw_args > 0)) {
        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "diff") < 0)) __PYX_ERR(0, 1452, __pyx_L3_error)
      }
    } else if (PyTuple_GET_SIZE(__pyx_args) != 11) {
      goto __pyx_L5_argtuple_error;
    } else {
      values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
      values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
      values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
      values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
      values[4] = PyTuple_GET_ITEM(__pyx_args, 4);
      values[5] = PyTuple_GET_ITEM(__pyx_args, 5);
      values[6] = PyTuple_GET_ITEM(__pyx_args, 6);
      values[7] = PyTuple_GET_ITEM(__pyx_args, 7);
      values[8] = PyTuple_GET_ITEM(__pyx_args, 8);
      values[9] = PyTuple_GET_ITEM(__pyx_args, 9);
      values[10] = PyTuple_GET_ITEM(__pyx_args, 10);
    }
    __pyx_v_free_p = ((PyArrayObject *)values[0]);
    __pyx_v_fixed_p = ((PyArrayObject *)values[1]);
    __pyx_v_stars_p_mask = ((PyArrayObject *)values[2]);
    __pyx_v_cov_p_mask = ((PyArrayObject *)values[3]);
    __pyx_v_frame = ((PyArrayObject *)values[4]);
    __pyx_v_box_size = __Pyx_PyInt_As_int(values[5]); if (unlikely((__pyx_v_box_size == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 1457, __pyx_L3_error)
    __pyx_v_star_nb = __Pyx_PyInt_As_int(values[6]); if (unlikely((__pyx_v_star_nb == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 1457, __pyx_L3_error)
    __pyx_v_noise = ((PyArrayObject *)values[7]);
    __pyx_v_dcl = __pyx_PyFloat_AsDouble(values[8]); if (unlikely((__pyx_v_dcl == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 1458, __pyx_L3_error)
    __pyx_v_saturation = __pyx_PyFloat_AsDouble(values[9]); if (unlikely((__pyx_v_saturation == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 1459, __pyx_L3_error)
    __pyx_v_sip = values[10];
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  __Pyx_RaiseArgtupleInvalid("diff", 1, 11, 11, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 1452, __pyx_L3_error)
  __pyx_L3_error:;
  __Pyx_AddTraceback("orb.cutils.multi_fit_stars.diff", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __Pyx_RefNannyFinishContext();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_free_p), __pyx_ptype_5numpy_ndarray, 1, "free_p", 0))) __PYX_ERR(0, 1452, __pyx_L1_error)
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_fixed_p), __pyx_ptype_5numpy_ndarray, 1, "fixed_p", 0))) __PYX_ERR(0, 1453, __pyx_L1_error)
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_stars_p_mask), __pyx_ptype_5numpy_ndarray, 1, "stars_p_mask", 0))) __PYX_ERR(0, 1454, __pyx_L1_error)
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_cov_p_mask), __pyx_ptype_5numpy_ndarray, 1, "cov_p_mask", 0))) __PYX_ERR(0, 1455, __pyx_L1_error)
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_frame), __pyx_ptype_5numpy_ndarray, 1, "frame", 0))) __PYX_ERR(0, 1456, __pyx_L1_error)
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_noise), __pyx_ptype_5numpy_ndarray, 1, "noise", 0))) __PYX_ERR(0, 1458, __pyx_L1_error)
  __pyx_r = __pyx_pf_3orb_6cutils_15multi_fit_stars_8diff(__pyx_self, __pyx_v_free_p, __pyx_v_fixed_p, __pyx_v_stars_p_mask, __pyx_v_cov_p_mask, __pyx_v_frame, __pyx_v_box_size, __pyx_v_star_nb, __pyx_v_noise, __pyx_v_dcl, __pyx_v_saturation, __pyx_v_sip);

  /* function exit code */
  goto __pyx_L0;
  __pyx_L1_error:;
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_15multi_fit_stars_8diff(PyObject *__pyx_self, PyArrayObject *__pyx_v_free_p, PyArrayObject *__pyx_v_fixed_p, PyArrayObject *__pyx_v_stars_p_mask, PyArrayObject *__pyx_v_cov_p_mask, PyArrayObject *__pyx_v_frame, int __pyx_v_box_size, int __pyx_v_star_nb, PyArrayObject *__pyx_v_noise, double __pyx_v_dcl, double __pyx_v_saturation, PyObject *__pyx_v_sip) {
  struct __pyx_obj_3orb_6cutils___pyx_scope_struct__multi_fit_stars *__pyx_cur_scope;
  struct __pyx_obj_3orb_6cutils___pyx_scope_struct__multi_fit_stars *__pyx_outer_scope;
  PyArrayObject *__pyx_v_params = 0;
  PyArrayObject *__pyx_v_stars_p = 0;
  PyArrayObject *__pyx_v_cov_p = 0;
  PyArrayObject *__pyx_v_res = 0;
  double __pyx_v_rcx;
  double __pyx_v_rcy;
  int __pyx_v_istar;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_cov_p;
  __Pyx_Buffer __pyx_pybuffer_cov_p;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_cov_p_mask;
  __Pyx_Buffer __pyx_pybuffer_cov_p_mask;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_fixed_p;
  __Pyx_Buffer __pyx_pybuffer_fixed_p;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_frame;
  __Pyx_Buffer __pyx_pybuffer_frame;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_free_p;
  __Pyx_Buffer __pyx_pybuffer_free_p;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_noise;
  __Pyx_Buffer __pyx_pybuffer_noise;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_params;
  __Pyx_Buffer __pyx_pybuffer_params;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_res;
  __Pyx_Buffer __pyx_pybuffer_res;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_stars_p;
  __Pyx_Buffer __pyx_pybuffer_stars_p;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_stars_p_mask;
  __Pyx_Buffer __pyx_pybuffer_stars_p_mask;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  PyObject *__pyx_t_1 = NULL;
  PyObject *__pyx_t_2 = NULL;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  PyObject *__pyx_t_5 = NULL;
  PyObject *__pyx_t_6 = NULL;
  PyArrayObject *__pyx_t_7 = NULL;
  PyArrayObject *__pyx_t_8 = NULL;
  PyArrayObject *__pyx_t_9 = NULL;
  PyArrayObject *__pyx_t_10 = NULL;
  PyObject *(*__pyx_t_11)(PyObject *);
  int __pyx_t_12;
  PyObject *__pyx_t_13 = NULL;
  PyObject *__pyx_t_14 = NULL;
  PyObject *__pyx_t_15 = NULL;
  PyObject *__pyx_t_16 = NULL;
  Py_ssize_t __pyx_t_17;
  Py_ssize_t __pyx_t_18;
  npy_intp __pyx_t_19;
  Py_ssize_t __pyx_t_20;
  Py_ssize_t __pyx_t_21;
  int __pyx_t_22;
  Py_ssize_t __pyx_t_23;
  Py_ssize_t __pyx_t_24;
  Py_ssize_t __pyx_t_25;
  Py_ssize_t __pyx_t_26;
  Py_ssize_t __pyx_t_27;
  PyObject *__pyx_t_28 = NULL;
  PyObject *__pyx_t_29 = NULL;
  PyObject *__pyx_t_30 = NULL;
  Py_ssize_t __pyx_t_31;
  PyObject *__pyx_t_32 = NULL;
  Py_ssize_t __pyx_t_33;
  PyObject *__pyx_t_34 = NULL;
  PyObject *__pyx_t_35 = NULL;
  Py_ssize_t __pyx_t_36;
  PyObject *__pyx_t_37 = NULL;
  __pyx_t_5numpy_float64_t __pyx_t_38;
  __pyx_t_5numpy_float64_t __pyx_t_39;
  Py_ssize_t __pyx_t_40;
  Py_ssize_t __pyx_t_41;
  Py_ssize_t __pyx_t_42;
  Py_ssize_t __pyx_t_43;
  int __pyx_t_44;
  int __pyx_t_45;
  __Pyx_RefNannySetupContext("diff", 0);
  __pyx_outer_scope = (struct __pyx_obj_3orb_6cutils___pyx_scope_struct__multi_fit_stars *) __Pyx_CyFunction_GetClosure(__pyx_self);
  __pyx_cur_scope = __pyx_outer_scope;
  __pyx_pybuffer_params.pybuffer.buf = NULL;
  __pyx_pybuffer_params.refcount = 0;
  __pyx_pybuffernd_params.data = NULL;
  __pyx_pybuffernd_params.rcbuffer = &__pyx_pybuffer_params;
  __pyx_pybuffer_stars_p.pybuffer.buf = NULL;
  __pyx_pybuffer_stars_p.refcount = 0;
  __pyx_pybuffernd_stars_p.data = NULL;
  __pyx_pybuffernd_stars_p.rcbuffer = &__pyx_pybuffer_stars_p;
  __pyx_pybuffer_cov_p.pybuffer.buf = NULL;
  __pyx_pybuffer_cov_p.refcount = 0;
  __pyx_pybuffernd_cov_p.data = NULL;
  __pyx_pybuffernd_cov_p.rcbuffer = &__pyx_pybuffer_cov_p;
  __pyx_pybuffer_res.pybuffer.buf = NULL;
  __pyx_pybuffer_res.refcount = 0;
  __pyx_pybuffernd_res.data = NULL;
  __pyx_pybuffernd_res.rcbuffer = &__pyx_pybuffer_res;
  __pyx_pybuffer_free_p.pybuffer.buf = NULL;
  __pyx_pybuffer_free_p.refcount = 0;
  __pyx_pybuffernd_free_p.data = NULL;
  __pyx_pybuffernd_free_p.rcbuffer = &__pyx_pybuffer_free_p;
  __pyx_pybuffer_fixed_p.pybuffer.buf = NULL;
  __pyx_pybuffer_fixed_p.refcount = 0;
  __pyx_pybuffernd_fixed_p.data = NULL;
  __pyx_pybuffernd_fixed_p.rcbuffer = &__pyx_pybuffer_fixed_p;
  __pyx_pybuffer_stars_p_mask.pybuffer.buf = NULL;
  __pyx_pybuffer_stars_p_mask.refcount = 0;
  __pyx_pybuffernd_stars_p_mask.data = NULL;
  __pyx_pybuffernd_stars_p_mask.rcbuffer = &__pyx_pybuffer_stars_p_mask;
  __pyx_pybuffer_cov_p_mask.pybuffer.buf = NULL;
  __pyx_pybuffer_cov_p_mask.refcount = 0;
  __pyx_pybuffernd_cov_p_mask.data = NULL;
  __pyx_pybuffernd_cov_p_mask.rcbuffer = &__pyx_pybuffer_cov_p_mask;
  __pyx_pybuffer_frame.pybuffer.buf = NULL;
  __pyx_pybuffer_frame.refcount = 0;
  __pyx_pybuffernd_frame.data = NULL;
  __pyx_pybuffernd_frame.rcbuffer = &__pyx_pybuffer_frame;
  __pyx_pybuffer_noise.pybuffer.buf = NULL;
  __pyx_pybuffer_noise.refcount = 0;
  __pyx_pybuffernd_noise.data = NULL;
  __pyx_pybuffernd_noise.rcbuffer = &__pyx_pybuffer_noise;
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_free_p.rcbuffer->pybuffer, (PyObject*)__pyx_v_free_p, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) __PYX_ERR(0, 1452, __pyx_L1_error)
  }
  __pyx_pybuffernd_free_p.diminfo[0].strides = __pyx_pybuffernd_free_p.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_free_p.diminfo[0].shape = __pyx_pybuffernd_free_p.rcbuffer->pybuffer.shape[0];
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_fixed_p.rcbuffer->pybuffer, (PyObject*)__pyx_v_fixed_p, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) __PYX_ERR(0, 1452, __pyx_L1_error)
  }
  __pyx_pybuffernd_fixed_p.diminfo[0].strides = __pyx_pybuffernd_fixed_p.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_fixed_p.diminfo[0].shape = __pyx_pybuffernd_fixed_p.rcbuffer->pybuffer.shape[0];
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_stars_p_mask.rcbuffer->pybuffer, (PyObject*)__pyx_v_stars_p_mask, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) __PYX_ERR(0, 1452, __pyx_L1_error)
  }
  __pyx_pybuffernd_stars_p_mask.diminfo[0].strides = __pyx_pybuffernd_stars_p_mask.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_stars_p_mask.diminfo[0].shape = __pyx_pybuffernd_stars_p_mask.rcbuffer->pybuffer.shape[0];
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_cov_p_mask.rcbuffer->pybuffer, (PyObject*)__pyx_v_cov_p_mask, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) __PYX_ERR(0, 1452, __pyx_L1_error)
  }
  __pyx_pybuffernd_cov_p_mask.diminfo[0].strides = __pyx_pybuffernd_cov_p_mask.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_cov_p_mask.diminfo[0].shape = __pyx_pybuffernd_cov_p_mask.rcbuffer->pybuffer.shape[0];
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_frame.rcbuffer->pybuffer, (PyObject*)__pyx_v_frame, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) __PYX_ERR(0, 1452, __pyx_L1_error)
  }
  __pyx_pybuffernd_frame.diminfo[0].strides = __pyx_pybuffernd_frame.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_frame.diminfo[0].shape = __pyx_pybuffernd_frame.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_frame.diminfo[1].strides = __pyx_pybuffernd_frame.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_frame.diminfo[1].shape = __pyx_pybuffernd_frame.rcbuffer->pybuffer.shape[1];
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_noise.rcbuffer->pybuffer, (PyObject*)__pyx_v_noise, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) __PYX_ERR(0, 1452, __pyx_L1_error)
  }
  __pyx_pybuffernd_noise.diminfo[0].strides = __pyx_pybuffernd_noise.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_noise.diminfo[0].shape = __pyx_pybuffernd_noise.rcbuffer->pybuffer.shape[0];

  /* "orb/cutils.pyx":1461
 *              double saturation, sip):
 * 
 *         cdef np.ndarray[np.float64_t, ndim=2] params = np.zeros(             # <<<<<<<<<<<<<<
 *             (star_nb, np.size(stars_p_mask)), dtype=float)
 *         cdef np.ndarray[np.float64_t, ndim=2] stars_p = np.zeros_like(params)
 */
  __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1461, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_zeros); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1461, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1462
 * 
 *         cdef np.ndarray[np.float64_t, ndim=2] params = np.zeros(
 *             (star_nb, np.size(stars_p_mask)), dtype=float)             # <<<<<<<<<<<<<<
 *         cdef np.ndarray[np.float64_t, ndim=2] stars_p = np.zeros_like(params)
 *         cdef np.ndarray[np.float64_t, ndim=1] cov_p = np.zeros_like(cov_p_mask)
 */
  __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_star_nb); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1462, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1462, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_size); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1462, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_4 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_5))) {
    __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_5);
    if (likely(__pyx_t_4)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_5);
      __Pyx_INCREF(__pyx_t_4);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_5, function);
    }
  }
  if (!__pyx_t_4) {
    __pyx_t_3 = __Pyx_PyObject_CallOneArg(__pyx_t_5, ((PyObject *)__pyx_v_stars_p_mask)); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1462, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
  } else {
    __pyx_t_6 = PyTuple_New(1+1); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1462, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
    __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_4); __pyx_t_4 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_stars_p_mask));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_stars_p_mask));
    PyTuple_SET_ITEM(__pyx_t_6, 0+1, ((PyObject *)__pyx_v_stars_p_mask));
    __pyx_t_3 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_6, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1462, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
  }
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_5 = PyTuple_New(2); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1462, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_GIVEREF(__pyx_t_1);
  PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_1);
  __Pyx_GIVEREF(__pyx_t_3);
  PyTuple_SET_ITEM(__pyx_t_5, 1, __pyx_t_3);
  __pyx_t_1 = 0;
  __pyx_t_3 = 0;

  /* "orb/cutils.pyx":1461
 *              double saturation, sip):
 * 
 *         cdef np.ndarray[np.float64_t, ndim=2] params = np.zeros(             # <<<<<<<<<<<<<<
 *             (star_nb, np.size(stars_p_mask)), dtype=float)
 *         cdef np.ndarray[np.float64_t, ndim=2] stars_p = np.zeros_like(params)
 */
  __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1461, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_GIVEREF(__pyx_t_5);
  PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_5);
  __pyx_t_5 = 0;

  /* "orb/cutils.pyx":1462
 * 
 *         cdef np.ndarray[np.float64_t, ndim=2] params = np.zeros(
 *             (star_nb, np.size(stars_p_mask)), dtype=float)             # <<<<<<<<<<<<<<
 *         cdef np.ndarray[np.float64_t, ndim=2] stars_p = np.zeros_like(params)
 *         cdef np.ndarray[np.float64_t, ndim=1] cov_p = np.zeros_like(cov_p_mask)
 */
  __pyx_t_5 = PyDict_New(); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1462, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  if (PyDict_SetItem(__pyx_t_5, __pyx_n_s_dtype, ((PyObject *)(&PyFloat_Type))) < 0) __PYX_ERR(0, 1462, __pyx_L1_error)

  /* "orb/cutils.pyx":1461
 *              double saturation, sip):
 * 
 *         cdef np.ndarray[np.float64_t, ndim=2] params = np.zeros(             # <<<<<<<<<<<<<<
 *             (star_nb, np.size(stars_p_mask)), dtype=float)
 *         cdef np.ndarray[np.float64_t, ndim=2] stars_p = np.zeros_like(params)
 */
  __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_3, __pyx_t_5); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1461, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1461, __pyx_L1_error)
  __pyx_t_7 = ((PyArrayObject *)__pyx_t_1);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_params.rcbuffer->pybuffer, (PyObject*)__pyx_t_7, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 2, 0, __pyx_stack) == -1)) {
      __pyx_v_params = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_params.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 1461, __pyx_L1_error)
    } else {__pyx_pybuffernd_params.diminfo[0].strides = __pyx_pybuffernd_params.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_params.diminfo[0].shape = __pyx_pybuffernd_params.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_params.diminfo[1].strides = __pyx_pybuffernd_params.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_params.diminfo[1].shape = __pyx_pybuffernd_params.rcbuffer->pybuffer.shape[1];
    }
  }
  __pyx_t_7 = 0;
  __pyx_v_params = ((PyArrayObject *)__pyx_t_1);
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1463
 *         cdef np.ndarray[np.float64_t, ndim=2] params = np.zeros(
 *             (star_nb, np.size(stars_p_mask)), dtype=float)
 *         cdef np.ndarray[np.float64_t, ndim=2] stars_p = np.zeros_like(params)             # <<<<<<<<<<<<<<
 *         cdef np.ndarray[np.float64_t, ndim=1] cov_p = np.zeros_like(cov_p_mask)
 *         cdef np.ndarray[np.float64_t, ndim=2] res = np.zeros(
 */
  __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1463, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_zeros_like); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1463, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_5 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_3))) {
    __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_3);
    if (likely(__pyx_t_5)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
      __Pyx_INCREF(__pyx_t_5);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_3, function);
    }
  }
  if (!__pyx_t_5) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_3, ((PyObject *)__pyx_v_params)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1463, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_2 = PyTuple_New(1+1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1463, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_5); __pyx_t_5 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_params));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_params));
    PyTuple_SET_ITEM(__pyx_t_2, 0+1, ((PyObject *)__pyx_v_params));
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_2, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1463, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  }
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1463, __pyx_L1_error)
  __pyx_t_8 = ((PyArrayObject *)__pyx_t_1);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_stars_p.rcbuffer->pybuffer, (PyObject*)__pyx_t_8, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
      __pyx_v_stars_p = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_stars_p.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 1463, __pyx_L1_error)
    } else {__pyx_pybuffernd_stars_p.diminfo[0].strides = __pyx_pybuffernd_stars_p.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_stars_p.diminfo[0].shape = __pyx_pybuffernd_stars_p.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_stars_p.diminfo[1].strides = __pyx_pybuffernd_stars_p.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_stars_p.diminfo[1].shape = __pyx_pybuffernd_stars_p.rcbuffer->pybuffer.shape[1];
    }
  }
  __pyx_t_8 = 0;
  __pyx_v_stars_p = ((PyArrayObject *)__pyx_t_1);
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1464
 *             (star_nb, np.size(stars_p_mask)), dtype=float)
 *         cdef np.ndarray[np.float64_t, ndim=2] stars_p = np.zeros_like(params)
 *         cdef np.ndarray[np.float64_t, ndim=1] cov_p = np.zeros_like(cov_p_mask)             # <<<<<<<<<<<<<<
 *         cdef np.ndarray[np.float64_t, ndim=2] res = np.zeros(
 *             (box_size * star_nb, box_size), dtype=float)
 */
  __pyx_t_3 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1464, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_zeros_like); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1464, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_3 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_2))) {
    __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_2);
    if (likely(__pyx_t_3)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
      __Pyx_INCREF(__pyx_t_3);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_2, function);
    }
  }
  if (!__pyx_t_3) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_2, ((PyObject *)__pyx_v_cov_p_mask)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1464, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_5 = PyTuple_New(1+1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1464, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_3); __pyx_t_3 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_cov_p_mask));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_cov_p_mask));
    PyTuple_SET_ITEM(__pyx_t_5, 0+1, ((PyObject *)__pyx_v_cov_p_mask));
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_5, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1464, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  }
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1464, __pyx_L1_error)
  __pyx_t_9 = ((PyArrayObject *)__pyx_t_1);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_cov_p.rcbuffer->pybuffer, (PyObject*)__pyx_t_9, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
      __pyx_v_cov_p = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 1464, __pyx_L1_error)
    } else {__pyx_pybuffernd_cov_p.diminfo[0].strides = __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_cov_p.diminfo[0].shape = __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.shape[0];
    }
  }
  __pyx_t_9 = 0;
  __pyx_v_cov_p = ((PyArrayObject *)__pyx_t_1);
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1465
 *         cdef np.ndarray[np.float64_t, ndim=2] stars_p = np.zeros_like(params)
 *         cdef np.ndarray[np.float64_t, ndim=1] cov_p = np.zeros_like(cov_p_mask)
 *         cdef np.ndarray[np.float64_t, ndim=2] res = np.zeros(             # <<<<<<<<<<<<<<
 *             (box_size * star_nb, box_size), dtype=float)
 *         cdef double rcx, rcy
 */
  __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1465, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_zeros); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1465, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1466
 *         cdef np.ndarray[np.float64_t, ndim=1] cov_p = np.zeros_like(cov_p_mask)
 *         cdef np.ndarray[np.float64_t, ndim=2] res = np.zeros(
 *             (box_size * star_nb, box_size), dtype=float)             # <<<<<<<<<<<<<<
 *         cdef double rcx, rcy
 *         cdef int istar
 */
  __pyx_t_1 = __Pyx_PyInt_From_int((__pyx_v_box_size * __pyx_v_star_nb)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1466, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_5 = __Pyx_PyInt_From_int(__pyx_v_box_size); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1466, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_3 = PyTuple_New(2); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1466, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_GIVEREF(__pyx_t_1);
  PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_1);
  __Pyx_GIVEREF(__pyx_t_5);
  PyTuple_SET_ITEM(__pyx_t_3, 1, __pyx_t_5);
  __pyx_t_1 = 0;
  __pyx_t_5 = 0;

  /* "orb/cutils.pyx":1465
 *         cdef np.ndarray[np.float64_t, ndim=2] stars_p = np.zeros_like(params)
 *         cdef np.ndarray[np.float64_t, ndim=1] cov_p = np.zeros_like(cov_p_mask)
 *         cdef np.ndarray[np.float64_t, ndim=2] res = np.zeros(             # <<<<<<<<<<<<<<
 *             (box_size * star_nb, box_size), dtype=float)
 *         cdef double rcx, rcy
 */
  __pyx_t_5 = PyTuple_New(1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1465, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_GIVEREF(__pyx_t_3);
  PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_3);
  __pyx_t_3 = 0;

  /* "orb/cutils.pyx":1466
 *         cdef np.ndarray[np.float64_t, ndim=1] cov_p = np.zeros_like(cov_p_mask)
 *         cdef np.ndarray[np.float64_t, ndim=2] res = np.zeros(
 *             (box_size * star_nb, box_size), dtype=float)             # <<<<<<<<<<<<<<
 *         cdef double rcx, rcy
 *         cdef int istar
 */
  __pyx_t_3 = PyDict_New(); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1466, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  if (PyDict_SetItem(__pyx_t_3, __pyx_n_s_dtype, ((PyObject *)(&PyFloat_Type))) < 0) __PYX_ERR(0, 1466, __pyx_L1_error)

  /* "orb/cutils.pyx":1465
 *         cdef np.ndarray[np.float64_t, ndim=2] stars_p = np.zeros_like(params)
 *         cdef np.ndarray[np.float64_t, ndim=1] cov_p = np.zeros_like(cov_p_mask)
 *         cdef np.ndarray[np.float64_t, ndim=2] res = np.zeros(             # <<<<<<<<<<<<<<
 *             (box_size * star_nb, box_size), dtype=float)
 *         cdef double rcx, rcy
 */
  __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_5, __pyx_t_3); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1465, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1465, __pyx_L1_error)
  __pyx_t_10 = ((PyArrayObject *)__pyx_t_1);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_res.rcbuffer->pybuffer, (PyObject*)__pyx_t_10, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
      __pyx_v_res = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_res.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 1465, __pyx_L1_error)
    } else {__pyx_pybuffernd_res.diminfo[0].strides = __pyx_pybuffernd_res.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_res.diminfo[0].shape = __pyx_pybuffernd_res.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_res.diminfo[1].strides = __pyx_pybuffernd_res.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_res.diminfo[1].shape = __pyx_pybuffernd_res.rcbuffer->pybuffer.shape[1];
    }
  }
  __pyx_t_10 = 0;
  __pyx_v_res = ((PyArrayObject *)__pyx_t_1);
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1470
 *         cdef int istar
 * 
 *         rcx = <double> frame.shape[0] / 2.             # <<<<<<<<<<<<<<
 *         rcy = <double> frame.shape[1] / 2.
 * 
 */
  __pyx_v_rcx = (((double)(__pyx_v_frame->dimensions[0])) / 2.);

  /* "orb/cutils.pyx":1471
 * 
 *         rcx = <double> frame.shape[0] / 2.
 *         rcy = <double> frame.shape[1] / 2.             # <<<<<<<<<<<<<<
 * 
 *         stars_p, cov_p = params_vect2arrays(
 */
  __pyx_v_rcy = (((double)(__pyx_v_frame->dimensions[1])) / 2.);

  /* "orb/cutils.pyx":1473
 *         rcy = <double> frame.shape[1] / 2.
 * 
 *         stars_p, cov_p = params_vect2arrays(             # <<<<<<<<<<<<<<
 *             free_p, fixed_p, stars_p_mask, cov_p_mask, star_nb)
 * 
 */
  if (unlikely(!__pyx_cur_scope->__pyx_v_params_vect2arrays)) { __Pyx_RaiseClosureNameError("params_vect2arrays"); __PYX_ERR(0, 1473, __pyx_L1_error) }
  __pyx_t_1 = __pyx_pf_3orb_6cutils_15multi_fit_stars_2params_vect2arrays(__pyx_cur_scope->__pyx_v_params_vect2arrays, ((PyArrayObject *)__pyx_v_free_p), ((PyArrayObject *)__pyx_v_fixed_p), ((PyArrayObject *)__pyx_v_stars_p_mask), ((PyArrayObject *)__pyx_v_cov_p_mask), __pyx_v_star_nb); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1473, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if ((likely(PyTuple_CheckExact(__pyx_t_1))) || (PyList_CheckExact(__pyx_t_1))) {
    PyObject* sequence = __pyx_t_1;
    #if CYTHON_COMPILING_IN_CPYTHON
    Py_ssize_t size = Py_SIZE(sequence);
    #else
    Py_ssize_t size = PySequence_Size(sequence);
    #endif
    if (unlikely(size != 2)) {
      if (size > 2) __Pyx_RaiseTooManyValuesError(2);
      else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
      __PYX_ERR(0, 1473, __pyx_L1_error)
    }
    #if CYTHON_COMPILING_IN_CPYTHON
    if (likely(PyTuple_CheckExact(sequence))) {
      __pyx_t_3 = PyTuple_GET_ITEM(sequence, 0); 
      __pyx_t_5 = PyTuple_GET_ITEM(sequence, 1); 
    } else {
      __pyx_t_3 = PyList_GET_ITEM(sequence, 0); 
      __pyx_t_5 = PyList_GET_ITEM(sequence, 1); 
    }
    __Pyx_INCREF(__pyx_t_3);
    __Pyx_INCREF(__pyx_t_5);
    #else
    __pyx_t_3 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1473, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __pyx_t_5 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1473, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    #endif
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  } else {
    Py_ssize_t index = -1;
    __pyx_t_2 = PyObject_GetIter(__pyx_t_1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1473, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    __pyx_t_11 = Py_TYPE(__pyx_t_2)->tp_iternext;
    index = 0; __pyx_t_3 = __pyx_t_11(__pyx_t_2); if (unlikely(!__pyx_t_3)) goto __pyx_L3_unpacking_failed;
    __Pyx_GOTREF(__pyx_t_3);
    index = 1; __pyx_t_5 = __pyx_t_11(__pyx_t_2); if (unlikely(!__pyx_t_5)) goto __pyx_L3_unpacking_failed;
    __Pyx_GOTREF(__pyx_t_5);
    if (__Pyx_IternextUnpackEndCheck(__pyx_t_11(__pyx_t_2), 2) < 0) __PYX_ERR(0, 1473, __pyx_L1_error)
    __pyx_t_11 = NULL;
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    goto __pyx_L4_unpacking_done;
    __pyx_L3_unpacking_failed:;
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __pyx_t_11 = NULL;
    if (__Pyx_IterFinish() == 0) __Pyx_RaiseNeedMoreValuesError(index);
    __PYX_ERR(0, 1473, __pyx_L1_error)
    __pyx_L4_unpacking_done:;
  }
  if (!(likely(((__pyx_t_3) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_3, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1473, __pyx_L1_error)
  if (!(likely(((__pyx_t_5) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_5, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1473, __pyx_L1_error)
  __pyx_t_8 = ((PyArrayObject *)__pyx_t_3);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_stars_p.rcbuffer->pybuffer);
    __pyx_t_12 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_stars_p.rcbuffer->pybuffer, (PyObject*)__pyx_t_8, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
    if (unlikely(__pyx_t_12 < 0)) {
      PyErr_Fetch(&__pyx_t_13, &__pyx_t_14, &__pyx_t_15);
      if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_stars_p.rcbuffer->pybuffer, (PyObject*)__pyx_v_stars_p, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_13); Py_XDECREF(__pyx_t_14); Py_XDECREF(__pyx_t_15);
        __Pyx_RaiseBufferFallbackError();
      } else {
        PyErr_Restore(__pyx_t_13, __pyx_t_14, __pyx_t_15);
      }
    }
    __pyx_pybuffernd_stars_p.diminfo[0].strides = __pyx_pybuffernd_stars_p.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_stars_p.diminfo[0].shape = __pyx_pybuffernd_stars_p.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_stars_p.diminfo[1].strides = __pyx_pybuffernd_stars_p.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_stars_p.diminfo[1].shape = __pyx_pybuffernd_stars_p.rcbuffer->pybuffer.shape[1];
    if (unlikely(__pyx_t_12 < 0)) __PYX_ERR(0, 1473, __pyx_L1_error)
  }
  __pyx_t_8 = 0;
  __Pyx_DECREF_SET(__pyx_v_stars_p, ((PyArrayObject *)__pyx_t_3));
  __pyx_t_3 = 0;
  __pyx_t_9 = ((PyArrayObject *)__pyx_t_5);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_cov_p.rcbuffer->pybuffer);
    __pyx_t_12 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_cov_p.rcbuffer->pybuffer, (PyObject*)__pyx_t_9, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack);
    if (unlikely(__pyx_t_12 < 0)) {
      PyErr_Fetch(&__pyx_t_15, &__pyx_t_14, &__pyx_t_13);
      if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_cov_p.rcbuffer->pybuffer, (PyObject*)__pyx_v_cov_p, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_15); Py_XDECREF(__pyx_t_14); Py_XDECREF(__pyx_t_13);
        __Pyx_RaiseBufferFallbackError();
      } else {
        PyErr_Restore(__pyx_t_15, __pyx_t_14, __pyx_t_13);
      }
    }
    __pyx_pybuffernd_cov_p.diminfo[0].strides = __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_cov_p.diminfo[0].shape = __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.shape[0];
    if (unlikely(__pyx_t_12 < 0)) __PYX_ERR(0, 1473, __pyx_L1_error)
  }
  __pyx_t_9 = 0;
  __Pyx_DECREF_SET(__pyx_v_cov_p, ((PyArrayObject *)__pyx_t_5));
  __pyx_t_5 = 0;

  /* "orb/cutils.pyx":1476
 *             free_p, fixed_p, stars_p_mask, cov_p_mask, star_nb)
 * 
 *         params = np.copy(stars_p)             # <<<<<<<<<<<<<<
 *         params[:,0] += cov_p[0] # COV HEIGHT
 * 
 */
  __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1476, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_copy); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1476, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_5 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_3))) {
    __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_3);
    if (likely(__pyx_t_5)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
      __Pyx_INCREF(__pyx_t_5);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_3, function);
    }
  }
  if (!__pyx_t_5) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_3, ((PyObject *)__pyx_v_stars_p)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1476, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_2 = PyTuple_New(1+1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1476, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_5); __pyx_t_5 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_stars_p));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_stars_p));
    PyTuple_SET_ITEM(__pyx_t_2, 0+1, ((PyObject *)__pyx_v_stars_p));
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_2, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1476, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  }
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1476, __pyx_L1_error)
  __pyx_t_7 = ((PyArrayObject *)__pyx_t_1);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_params.rcbuffer->pybuffer);
    __pyx_t_12 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_params.rcbuffer->pybuffer, (PyObject*)__pyx_t_7, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 2, 0, __pyx_stack);
    if (unlikely(__pyx_t_12 < 0)) {
      PyErr_Fetch(&__pyx_t_13, &__pyx_t_14, &__pyx_t_15);
      if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_params.rcbuffer->pybuffer, (PyObject*)__pyx_v_params, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 2, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_13); Py_XDECREF(__pyx_t_14); Py_XDECREF(__pyx_t_15);
        __Pyx_RaiseBufferFallbackError();
      } else {
        PyErr_Restore(__pyx_t_13, __pyx_t_14, __pyx_t_15);
      }
    }
    __pyx_pybuffernd_params.diminfo[0].strides = __pyx_pybuffernd_params.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_params.diminfo[0].shape = __pyx_pybuffernd_params.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_params.diminfo[1].strides = __pyx_pybuffernd_params.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_params.diminfo[1].shape = __pyx_pybuffernd_params.rcbuffer->pybuffer.shape[1];
    if (unlikely(__pyx_t_12 < 0)) __PYX_ERR(0, 1476, __pyx_L1_error)
  }
  __pyx_t_7 = 0;
  __Pyx_DECREF_SET(__pyx_v_params, ((PyArrayObject *)__pyx_t_1));
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1477
 * 
 *         params = np.copy(stars_p)
 *         params[:,0] += cov_p[0] # COV HEIGHT             # <<<<<<<<<<<<<<
 * 
 *         # COV FWHM: here FWHM covariance is best interpreted as the
 */
  __Pyx_INCREF(__pyx_tuple__69);
  __pyx_t_16 = __pyx_tuple__69;
  __pyx_t_1 = PyObject_GetItem(((PyObject *)__pyx_v_params), __pyx_t_16); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1477, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_17 = 0;
  __pyx_t_12 = -1;
  if (__pyx_t_17 < 0) {
    __pyx_t_17 += __pyx_pybuffernd_cov_p.diminfo[0].shape;
    if (unlikely(__pyx_t_17 < 0)) __pyx_t_12 = 0;
  } else if (unlikely(__pyx_t_17 >= __pyx_pybuffernd_cov_p.diminfo[0].shape)) __pyx_t_12 = 0;
  if (unlikely(__pyx_t_12 != -1)) {
    __Pyx_RaiseBufferIndexError(__pyx_t_12);
    __PYX_ERR(0, 1477, __pyx_L1_error)
  }
  __pyx_t_3 = PyFloat_FromDouble((*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.buf, __pyx_t_17, __pyx_pybuffernd_cov_p.diminfo[0].strides))); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1477, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_2 = PyNumber_InPlaceAdd(__pyx_t_1, __pyx_t_3); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1477, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  if (unlikely(PyObject_SetItem(((PyObject *)__pyx_v_params), __pyx_t_16, __pyx_t_2) < 0)) __PYX_ERR(0, 1477, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __Pyx_DECREF(__pyx_t_16); __pyx_t_16 = 0;

  /* "orb/cutils.pyx":1484
 *         # the quadratic sum of the psf's.
 *         #params[:,4] += cov_p[3] # COV FWHM
 *         params[:,4] = np.sqrt(params[:,4]**2. + cov_p[3]**2.)             # <<<<<<<<<<<<<<
 * 
 *         # dx, dy & zoom & rotation
 */
  __pyx_t_3 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1484, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_sqrt); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1484, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_3 = PyObject_GetItem(((PyObject *)__pyx_v_params), __pyx_tuple__71); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1484, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_5 = PyNumber_Power(__pyx_t_3, __pyx_float_2_, Py_None); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1484, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_18 = 3;
  __pyx_t_12 = -1;
  if (__pyx_t_18 < 0) {
    __pyx_t_18 += __pyx_pybuffernd_cov_p.diminfo[0].shape;
    if (unlikely(__pyx_t_18 < 0)) __pyx_t_12 = 0;
  } else if (unlikely(__pyx_t_18 >= __pyx_pybuffernd_cov_p.diminfo[0].shape)) __pyx_t_12 = 0;
  if (unlikely(__pyx_t_12 != -1)) {
    __Pyx_RaiseBufferIndexError(__pyx_t_12);
    __PYX_ERR(0, 1484, __pyx_L1_error)
  }
  __pyx_t_3 = PyFloat_FromDouble(pow((*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.buf, __pyx_t_18, __pyx_pybuffernd_cov_p.diminfo[0].strides)), ((__pyx_t_5numpy_float64_t)2.))); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1484, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_6 = PyNumber_Add(__pyx_t_5, __pyx_t_3); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1484, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_3 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_1))) {
    __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_1);
    if (likely(__pyx_t_3)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_1);
      __Pyx_INCREF(__pyx_t_3);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_1, function);
    }
  }
  if (!__pyx_t_3) {
    __pyx_t_2 = __Pyx_PyObject_CallOneArg(__pyx_t_1, __pyx_t_6); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1484, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
    __Pyx_GOTREF(__pyx_t_2);
  } else {
    __pyx_t_5 = PyTuple_New(1+1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1484, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_3); __pyx_t_3 = NULL;
    __Pyx_GIVEREF(__pyx_t_6);
    PyTuple_SET_ITEM(__pyx_t_5, 0+1, __pyx_t_6);
    __pyx_t_6 = 0;
    __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_1, __pyx_t_5, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1484, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  }
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  if (unlikely(PyObject_SetItem(((PyObject *)__pyx_v_params), __pyx_tuple__73, __pyx_t_2) < 0)) __PYX_ERR(0, 1484, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;

  /* "orb/cutils.pyx":1487
 * 
 *         # dx, dy & zoom & rotation
 *         for istar in range(stars_p.shape[0]):             # <<<<<<<<<<<<<<
 *             params[istar,2],  params[istar,3] = transform_A_to_B(
 *                 params[istar,2], params[istar,3], -cov_p[1], -cov_p[2],
 */
  __pyx_t_19 = (__pyx_v_stars_p->dimensions[0]);
  for (__pyx_t_12 = 0; __pyx_t_12 < __pyx_t_19; __pyx_t_12+=1) {
    __pyx_v_istar = __pyx_t_12;

    /* "orb/cutils.pyx":1488
 *         # dx, dy & zoom & rotation
 *         for istar in range(stars_p.shape[0]):
 *             params[istar,2],  params[istar,3] = transform_A_to_B(             # <<<<<<<<<<<<<<
 *                 params[istar,2], params[istar,3], -cov_p[1], -cov_p[2],
 *                 cov_p[6], 0., 0., rcx, rcy, cov_p[4], cov_p[5])
 */
    __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_transform_A_to_B); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1488, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);

    /* "orb/cutils.pyx":1489
 *         for istar in range(stars_p.shape[0]):
 *             params[istar,2],  params[istar,3] = transform_A_to_B(
 *                 params[istar,2], params[istar,3], -cov_p[1], -cov_p[2],             # <<<<<<<<<<<<<<
 *                 cov_p[6], 0., 0., rcx, rcy, cov_p[4], cov_p[5])
 * 
 */
    __pyx_t_20 = __pyx_v_istar;
    __pyx_t_21 = 2;
    __pyx_t_22 = -1;
    if (__pyx_t_20 < 0) {
      __pyx_t_20 += __pyx_pybuffernd_params.diminfo[0].shape;
      if (unlikely(__pyx_t_20 < 0)) __pyx_t_22 = 0;
    } else if (unlikely(__pyx_t_20 >= __pyx_pybuffernd_params.diminfo[0].shape)) __pyx_t_22 = 0;
    if (__pyx_t_21 < 0) {
      __pyx_t_21 += __pyx_pybuffernd_params.diminfo[1].shape;
      if (unlikely(__pyx_t_21 < 0)) __pyx_t_22 = 1;
    } else if (unlikely(__pyx_t_21 >= __pyx_pybuffernd_params.diminfo[1].shape)) __pyx_t_22 = 1;
    if (unlikely(__pyx_t_22 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_22);
      __PYX_ERR(0, 1489, __pyx_L1_error)
    }
    __pyx_t_5 = PyFloat_FromDouble((*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_params.rcbuffer->pybuffer.buf, __pyx_t_20, __pyx_pybuffernd_params.diminfo[0].strides, __pyx_t_21, __pyx_pybuffernd_params.diminfo[1].strides))); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1489, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __pyx_t_23 = __pyx_v_istar;
    __pyx_t_24 = 3;
    __pyx_t_22 = -1;
    if (__pyx_t_23 < 0) {
      __pyx_t_23 += __pyx_pybuffernd_params.diminfo[0].shape;
      if (unlikely(__pyx_t_23 < 0)) __pyx_t_22 = 0;
    } else if (unlikely(__pyx_t_23 >= __pyx_pybuffernd_params.diminfo[0].shape)) __pyx_t_22 = 0;
    if (__pyx_t_24 < 0) {
      __pyx_t_24 += __pyx_pybuffernd_params.diminfo[1].shape;
      if (unlikely(__pyx_t_24 < 0)) __pyx_t_22 = 1;
    } else if (unlikely(__pyx_t_24 >= __pyx_pybuffernd_params.diminfo[1].shape)) __pyx_t_22 = 1;
    if (unlikely(__pyx_t_22 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_22);
      __PYX_ERR(0, 1489, __pyx_L1_error)
    }
    __pyx_t_6 = PyFloat_FromDouble((*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_params.rcbuffer->pybuffer.buf, __pyx_t_23, __pyx_pybuffernd_params.diminfo[0].strides, __pyx_t_24, __pyx_pybuffernd_params.diminfo[1].strides))); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1489, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
    __pyx_t_25 = 1;
    __pyx_t_22 = -1;
    if (__pyx_t_25 < 0) {
      __pyx_t_25 += __pyx_pybuffernd_cov_p.diminfo[0].shape;
      if (unlikely(__pyx_t_25 < 0)) __pyx_t_22 = 0;
    } else if (unlikely(__pyx_t_25 >= __pyx_pybuffernd_cov_p.diminfo[0].shape)) __pyx_t_22 = 0;
    if (unlikely(__pyx_t_22 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_22);
      __PYX_ERR(0, 1489, __pyx_L1_error)
    }
    __pyx_t_3 = PyFloat_FromDouble((-(*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.buf, __pyx_t_25, __pyx_pybuffernd_cov_p.diminfo[0].strides)))); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1489, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __pyx_t_26 = 2;
    __pyx_t_22 = -1;
    if (__pyx_t_26 < 0) {
      __pyx_t_26 += __pyx_pybuffernd_cov_p.diminfo[0].shape;
      if (unlikely(__pyx_t_26 < 0)) __pyx_t_22 = 0;
    } else if (unlikely(__pyx_t_26 >= __pyx_pybuffernd_cov_p.diminfo[0].shape)) __pyx_t_22 = 0;
    if (unlikely(__pyx_t_22 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_22);
      __PYX_ERR(0, 1489, __pyx_L1_error)
    }
    __pyx_t_4 = PyFloat_FromDouble((-(*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.buf, __pyx_t_26, __pyx_pybuffernd_cov_p.diminfo[0].strides)))); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1489, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);

    /* "orb/cutils.pyx":1490
 *             params[istar,2],  params[istar,3] = transform_A_to_B(
 *                 params[istar,2], params[istar,3], -cov_p[1], -cov_p[2],
 *                 cov_p[6], 0., 0., rcx, rcy, cov_p[4], cov_p[5])             # <<<<<<<<<<<<<<
 * 
 *         if sip is not None:
 */
    __pyx_t_27 = 6;
    __pyx_t_22 = -1;
    if (__pyx_t_27 < 0) {
      __pyx_t_27 += __pyx_pybuffernd_cov_p.diminfo[0].shape;
      if (unlikely(__pyx_t_27 < 0)) __pyx_t_22 = 0;
    } else if (unlikely(__pyx_t_27 >= __pyx_pybuffernd_cov_p.diminfo[0].shape)) __pyx_t_22 = 0;
    if (unlikely(__pyx_t_22 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_22);
      __PYX_ERR(0, 1490, __pyx_L1_error)
    }
    __pyx_t_28 = PyFloat_FromDouble((*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.buf, __pyx_t_27, __pyx_pybuffernd_cov_p.diminfo[0].strides))); if (unlikely(!__pyx_t_28)) __PYX_ERR(0, 1490, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_28);
    __pyx_t_29 = PyFloat_FromDouble(__pyx_v_rcx); if (unlikely(!__pyx_t_29)) __PYX_ERR(0, 1490, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_29);
    __pyx_t_30 = PyFloat_FromDouble(__pyx_v_rcy); if (unlikely(!__pyx_t_30)) __PYX_ERR(0, 1490, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_30);
    __pyx_t_31 = 4;
    __pyx_t_22 = -1;
    if (__pyx_t_31 < 0) {
      __pyx_t_31 += __pyx_pybuffernd_cov_p.diminfo[0].shape;
      if (unlikely(__pyx_t_31 < 0)) __pyx_t_22 = 0;
    } else if (unlikely(__pyx_t_31 >= __pyx_pybuffernd_cov_p.diminfo[0].shape)) __pyx_t_22 = 0;
    if (unlikely(__pyx_t_22 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_22);
      __PYX_ERR(0, 1490, __pyx_L1_error)
    }
    __pyx_t_32 = PyFloat_FromDouble((*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.buf, __pyx_t_31, __pyx_pybuffernd_cov_p.diminfo[0].strides))); if (unlikely(!__pyx_t_32)) __PYX_ERR(0, 1490, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_32);
    __pyx_t_33 = 5;
    __pyx_t_22 = -1;
    if (__pyx_t_33 < 0) {
      __pyx_t_33 += __pyx_pybuffernd_cov_p.diminfo[0].shape;
      if (unlikely(__pyx_t_33 < 0)) __pyx_t_22 = 0;
    } else if (unlikely(__pyx_t_33 >= __pyx_pybuffernd_cov_p.diminfo[0].shape)) __pyx_t_22 = 0;
    if (unlikely(__pyx_t_22 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_22);
      __PYX_ERR(0, 1490, __pyx_L1_error)
    }
    __pyx_t_34 = PyFloat_FromDouble((*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.buf, __pyx_t_33, __pyx_pybuffernd_cov_p.diminfo[0].strides))); if (unlikely(!__pyx_t_34)) __PYX_ERR(0, 1490, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_34);
    __pyx_t_35 = NULL;
    __pyx_t_36 = 0;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_1))) {
      __pyx_t_35 = PyMethod_GET_SELF(__pyx_t_1);
      if (likely(__pyx_t_35)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_1);
        __Pyx_INCREF(__pyx_t_35);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_1, function);
        __pyx_t_36 = 1;
      }
    }
    __pyx_t_37 = PyTuple_New(11+__pyx_t_36); if (unlikely(!__pyx_t_37)) __PYX_ERR(0, 1488, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_37);
    if (__pyx_t_35) {
      __Pyx_GIVEREF(__pyx_t_35); PyTuple_SET_ITEM(__pyx_t_37, 0, __pyx_t_35); __pyx_t_35 = NULL;
    }
    __Pyx_GIVEREF(__pyx_t_5);
    PyTuple_SET_ITEM(__pyx_t_37, 0+__pyx_t_36, __pyx_t_5);
    __Pyx_GIVEREF(__pyx_t_6);
    PyTuple_SET_ITEM(__pyx_t_37, 1+__pyx_t_36, __pyx_t_6);
    __Pyx_GIVEREF(__pyx_t_3);
    PyTuple_SET_ITEM(__pyx_t_37, 2+__pyx_t_36, __pyx_t_3);
    __Pyx_GIVEREF(__pyx_t_4);
    PyTuple_SET_ITEM(__pyx_t_37, 3+__pyx_t_36, __pyx_t_4);
    __Pyx_GIVEREF(__pyx_t_28);
    PyTuple_SET_ITEM(__pyx_t_37, 4+__pyx_t_36, __pyx_t_28);
    __Pyx_INCREF(__pyx_float_0_);
    __Pyx_GIVEREF(__pyx_float_0_);
    PyTuple_SET_ITEM(__pyx_t_37, 5+__pyx_t_36, __pyx_float_0_);
    __Pyx_INCREF(__pyx_float_0_);
    __Pyx_GIVEREF(__pyx_float_0_);
    PyTuple_SET_ITEM(__pyx_t_37, 6+__pyx_t_36, __pyx_float_0_);
    __Pyx_GIVEREF(__pyx_t_29);
    PyTuple_SET_ITEM(__pyx_t_37, 7+__pyx_t_36, __pyx_t_29);
    __Pyx_GIVEREF(__pyx_t_30);
    PyTuple_SET_ITEM(__pyx_t_37, 8+__pyx_t_36, __pyx_t_30);
    __Pyx_GIVEREF(__pyx_t_32);
    PyTuple_SET_ITEM(__pyx_t_37, 9+__pyx_t_36, __pyx_t_32);
    __Pyx_GIVEREF(__pyx_t_34);
    PyTuple_SET_ITEM(__pyx_t_37, 10+__pyx_t_36, __pyx_t_34);
    __pyx_t_5 = 0;
    __pyx_t_6 = 0;
    __pyx_t_3 = 0;
    __pyx_t_4 = 0;
    __pyx_t_28 = 0;
    __pyx_t_29 = 0;
    __pyx_t_30 = 0;
    __pyx_t_32 = 0;
    __pyx_t_34 = 0;
    __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_1, __pyx_t_37, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1488, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_DECREF(__pyx_t_37); __pyx_t_37 = 0;
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    if ((likely(PyTuple_CheckExact(__pyx_t_2))) || (PyList_CheckExact(__pyx_t_2))) {
      PyObject* sequence = __pyx_t_2;
      #if CYTHON_COMPILING_IN_CPYTHON
      Py_ssize_t size = Py_SIZE(sequence);
      #else
      Py_ssize_t size = PySequence_Size(sequence);
      #endif
      if (unlikely(size != 2)) {
        if (size > 2) __Pyx_RaiseTooManyValuesError(2);
        else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
        __PYX_ERR(0, 1488, __pyx_L1_error)
      }
      #if CYTHON_COMPILING_IN_CPYTHON
      if (likely(PyTuple_CheckExact(sequence))) {
        __pyx_t_1 = PyTuple_GET_ITEM(sequence, 0); 
        __pyx_t_37 = PyTuple_GET_ITEM(sequence, 1); 
      } else {
        __pyx_t_1 = PyList_GET_ITEM(sequence, 0); 
        __pyx_t_37 = PyList_GET_ITEM(sequence, 1); 
      }
      __Pyx_INCREF(__pyx_t_1);
      __Pyx_INCREF(__pyx_t_37);
      #else
      __pyx_t_1 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1488, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);
      __pyx_t_37 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_37)) __PYX_ERR(0, 1488, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_37);
      #endif
      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    } else {
      Py_ssize_t index = -1;
      __pyx_t_34 = PyObject_GetIter(__pyx_t_2); if (unlikely(!__pyx_t_34)) __PYX_ERR(0, 1488, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_34);
      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
      __pyx_t_11 = Py_TYPE(__pyx_t_34)->tp_iternext;
      index = 0; __pyx_t_1 = __pyx_t_11(__pyx_t_34); if (unlikely(!__pyx_t_1)) goto __pyx_L7_unpacking_failed;
      __Pyx_GOTREF(__pyx_t_1);
      index = 1; __pyx_t_37 = __pyx_t_11(__pyx_t_34); if (unlikely(!__pyx_t_37)) goto __pyx_L7_unpacking_failed;
      __Pyx_GOTREF(__pyx_t_37);
      if (__Pyx_IternextUnpackEndCheck(__pyx_t_11(__pyx_t_34), 2) < 0) __PYX_ERR(0, 1488, __pyx_L1_error)
      __pyx_t_11 = NULL;
      __Pyx_DECREF(__pyx_t_34); __pyx_t_34 = 0;
      goto __pyx_L8_unpacking_done;
      __pyx_L7_unpacking_failed:;
      __Pyx_DECREF(__pyx_t_34); __pyx_t_34 = 0;
      __pyx_t_11 = NULL;
      if (__Pyx_IterFinish() == 0) __Pyx_RaiseNeedMoreValuesError(index);
      __PYX_ERR(0, 1488, __pyx_L1_error)
      __pyx_L8_unpacking_done:;
    }

    /* "orb/cutils.pyx":1488
 *         # dx, dy & zoom & rotation
 *         for istar in range(stars_p.shape[0]):
 *             params[istar,2],  params[istar,3] = transform_A_to_B(             # <<<<<<<<<<<<<<
 *                 params[istar,2], params[istar,3], -cov_p[1], -cov_p[2],
 *                 cov_p[6], 0., 0., rcx, rcy, cov_p[4], cov_p[5])
 */
    __pyx_t_38 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_38 == (npy_float64)-1) && PyErr_Occurred())) __PYX_ERR(0, 1488, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    __pyx_t_39 = __pyx_PyFloat_AsDouble(__pyx_t_37); if (unlikely((__pyx_t_39 == (npy_float64)-1) && PyErr_Occurred())) __PYX_ERR(0, 1488, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_37); __pyx_t_37 = 0;
    __pyx_t_40 = __pyx_v_istar;
    __pyx_t_41 = 2;
    __pyx_t_22 = -1;
    if (__pyx_t_40 < 0) {
      __pyx_t_40 += __pyx_pybuffernd_params.diminfo[0].shape;
      if (unlikely(__pyx_t_40 < 0)) __pyx_t_22 = 0;
    } else if (unlikely(__pyx_t_40 >= __pyx_pybuffernd_params.diminfo[0].shape)) __pyx_t_22 = 0;
    if (__pyx_t_41 < 0) {
      __pyx_t_41 += __pyx_pybuffernd_params.diminfo[1].shape;
      if (unlikely(__pyx_t_41 < 0)) __pyx_t_22 = 1;
    } else if (unlikely(__pyx_t_41 >= __pyx_pybuffernd_params.diminfo[1].shape)) __pyx_t_22 = 1;
    if (unlikely(__pyx_t_22 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_22);
      __PYX_ERR(0, 1488, __pyx_L1_error)
    }
    *__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_params.rcbuffer->pybuffer.buf, __pyx_t_40, __pyx_pybuffernd_params.diminfo[0].strides, __pyx_t_41, __pyx_pybuffernd_params.diminfo[1].strides) = __pyx_t_38;
    __pyx_t_42 = __pyx_v_istar;
    __pyx_t_43 = 3;
    __pyx_t_22 = -1;
    if (__pyx_t_42 < 0) {
      __pyx_t_42 += __pyx_pybuffernd_params.diminfo[0].shape;
      if (unlikely(__pyx_t_42 < 0)) __pyx_t_22 = 0;
    } else if (unlikely(__pyx_t_42 >= __pyx_pybuffernd_params.diminfo[0].shape)) __pyx_t_22 = 0;
    if (__pyx_t_43 < 0) {
      __pyx_t_43 += __pyx_pybuffernd_params.diminfo[1].shape;
      if (unlikely(__pyx_t_43 < 0)) __pyx_t_22 = 1;
    } else if (unlikely(__pyx_t_43 >= __pyx_pybuffernd_params.diminfo[1].shape)) __pyx_t_22 = 1;
    if (unlikely(__pyx_t_22 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_22);
      __PYX_ERR(0, 1488, __pyx_L1_error)
    }
    *__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_params.rcbuffer->pybuffer.buf, __pyx_t_42, __pyx_pybuffernd_params.diminfo[0].strides, __pyx_t_43, __pyx_pybuffernd_params.diminfo[1].strides) = __pyx_t_39;
  }

  /* "orb/cutils.pyx":1492
 *                 cov_p[6], 0., 0., rcx, rcy, cov_p[4], cov_p[5])
 * 
 *         if sip is not None:             # <<<<<<<<<<<<<<
 *             params[:,2:4] = sip_im2pix(params[:,2:4], sip)
 * 
 */
  __pyx_t_44 = (__pyx_v_sip != Py_None);
  __pyx_t_45 = (__pyx_t_44 != 0);
  if (__pyx_t_45) {

    /* "orb/cutils.pyx":1493
 * 
 *         if sip is not None:
 *             params[:,2:4] = sip_im2pix(params[:,2:4], sip)             # <<<<<<<<<<<<<<
 * 
 *         res = model_diff(frame.shape[0], frame.shape[1],
 */
    __pyx_t_37 = __Pyx_GetModuleGlobalName(__pyx_n_s_sip_im2pix); if (unlikely(!__pyx_t_37)) __PYX_ERR(0, 1493, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_37);
    __pyx_t_1 = PyObject_GetItem(((PyObject *)__pyx_v_params), __pyx_tuple__76); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1493, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __pyx_t_34 = NULL;
    __pyx_t_36 = 0;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_37))) {
      __pyx_t_34 = PyMethod_GET_SELF(__pyx_t_37);
      if (likely(__pyx_t_34)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_37);
        __Pyx_INCREF(__pyx_t_34);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_37, function);
        __pyx_t_36 = 1;
      }
    }
    __pyx_t_32 = PyTuple_New(2+__pyx_t_36); if (unlikely(!__pyx_t_32)) __PYX_ERR(0, 1493, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_32);
    if (__pyx_t_34) {
      __Pyx_GIVEREF(__pyx_t_34); PyTuple_SET_ITEM(__pyx_t_32, 0, __pyx_t_34); __pyx_t_34 = NULL;
    }
    __Pyx_GIVEREF(__pyx_t_1);
    PyTuple_SET_ITEM(__pyx_t_32, 0+__pyx_t_36, __pyx_t_1);
    __Pyx_INCREF(__pyx_v_sip);
    __Pyx_GIVEREF(__pyx_v_sip);
    PyTuple_SET_ITEM(__pyx_t_32, 1+__pyx_t_36, __pyx_v_sip);
    __pyx_t_1 = 0;
    __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_37, __pyx_t_32, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1493, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_DECREF(__pyx_t_32); __pyx_t_32 = 0;
    __Pyx_DECREF(__pyx_t_37); __pyx_t_37 = 0;
    if (unlikely(PyObject_SetItem(((PyObject *)__pyx_v_params), __pyx_tuple__79, __pyx_t_2) < 0)) __PYX_ERR(0, 1493, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;

    /* "orb/cutils.pyx":1492
 *                 cov_p[6], 0., 0., rcx, rcy, cov_p[4], cov_p[5])
 * 
 *         if sip is not None:             # <<<<<<<<<<<<<<
 *             params[:,2:4] = sip_im2pix(params[:,2:4], sip)
 * 
 */
  }

  /* "orb/cutils.pyx":1495
 *             params[:,2:4] = sip_im2pix(params[:,2:4], sip)
 * 
 *         res = model_diff(frame.shape[0], frame.shape[1],             # <<<<<<<<<<<<<<
 *                          params, box_size, frame, noise, dcl,
 *                          saturation)
 */
  if (unlikely(!__pyx_cur_scope->__pyx_v_model_diff)) { __Pyx_RaiseClosureNameError("model_diff"); __PYX_ERR(0, 1495, __pyx_L1_error) }
  __pyx_t_2 = __Pyx_PyInt_From_Py_intptr_t((__pyx_v_frame->dimensions[0])); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1495, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_37 = __Pyx_PyInt_From_Py_intptr_t((__pyx_v_frame->dimensions[1])); if (unlikely(!__pyx_t_37)) __PYX_ERR(0, 1495, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_37);

  /* "orb/cutils.pyx":1496
 * 
 *         res = model_diff(frame.shape[0], frame.shape[1],
 *                          params, box_size, frame, noise, dcl,             # <<<<<<<<<<<<<<
 *                          saturation)
 * 
 */
  __pyx_t_32 = __Pyx_PyInt_From_int(__pyx_v_box_size); if (unlikely(!__pyx_t_32)) __PYX_ERR(0, 1496, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_32);
  __pyx_t_1 = PyFloat_FromDouble(__pyx_v_dcl); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1496, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);

  /* "orb/cutils.pyx":1497
 *         res = model_diff(frame.shape[0], frame.shape[1],
 *                          params, box_size, frame, noise, dcl,
 *                          saturation)             # <<<<<<<<<<<<<<
 * 
 *         return res[np.nonzero(~np.isnan(res))]
 */
  __pyx_t_34 = PyFloat_FromDouble(__pyx_v_saturation); if (unlikely(!__pyx_t_34)) __PYX_ERR(0, 1497, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_34);

  /* "orb/cutils.pyx":1495
 *             params[:,2:4] = sip_im2pix(params[:,2:4], sip)
 * 
 *         res = model_diff(frame.shape[0], frame.shape[1],             # <<<<<<<<<<<<<<
 *                          params, box_size, frame, noise, dcl,
 *                          saturation)
 */
  __pyx_t_30 = PyTuple_New(8); if (unlikely(!__pyx_t_30)) __PYX_ERR(0, 1495, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_30);
  __Pyx_GIVEREF(__pyx_t_2);
  PyTuple_SET_ITEM(__pyx_t_30, 0, __pyx_t_2);
  __Pyx_GIVEREF(__pyx_t_37);
  PyTuple_SET_ITEM(__pyx_t_30, 1, __pyx_t_37);
  __Pyx_INCREF(((PyObject *)__pyx_v_params));
  __Pyx_GIVEREF(((PyObject *)__pyx_v_params));
  PyTuple_SET_ITEM(__pyx_t_30, 2, ((PyObject *)__pyx_v_params));
  __Pyx_GIVEREF(__pyx_t_32);
  PyTuple_SET_ITEM(__pyx_t_30, 3, __pyx_t_32);
  __Pyx_INCREF(((PyObject *)__pyx_v_frame));
  __Pyx_GIVEREF(((PyObject *)__pyx_v_frame));
  PyTuple_SET_ITEM(__pyx_t_30, 4, ((PyObject *)__pyx_v_frame));
  __Pyx_INCREF(((PyObject *)__pyx_v_noise));
  __Pyx_GIVEREF(((PyObject *)__pyx_v_noise));
  PyTuple_SET_ITEM(__pyx_t_30, 5, ((PyObject *)__pyx_v_noise));
  __Pyx_GIVEREF(__pyx_t_1);
  PyTuple_SET_ITEM(__pyx_t_30, 6, __pyx_t_1);
  __Pyx_GIVEREF(__pyx_t_34);
  PyTuple_SET_ITEM(__pyx_t_30, 7, __pyx_t_34);
  __pyx_t_2 = 0;
  __pyx_t_37 = 0;
  __pyx_t_32 = 0;
  __pyx_t_1 = 0;
  __pyx_t_34 = 0;
  __pyx_t_34 = __Pyx_PyObject_Call(__pyx_cur_scope->__pyx_v_model_diff, __pyx_t_30, NULL); if (unlikely(!__pyx_t_34)) __PYX_ERR(0, 1495, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_34);
  __Pyx_DECREF(__pyx_t_30); __pyx_t_30 = 0;
  if (!(likely(((__pyx_t_34) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_34, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1495, __pyx_L1_error)
  __pyx_t_10 = ((PyArrayObject *)__pyx_t_34);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_res.rcbuffer->pybuffer);
    __pyx_t_12 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_res.rcbuffer->pybuffer, (PyObject*)__pyx_t_10, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
    if (unlikely(__pyx_t_12 < 0)) {
      PyErr_Fetch(&__pyx_t_15, &__pyx_t_14, &__pyx_t_13);
      if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_res.rcbuffer->pybuffer, (PyObject*)__pyx_v_res, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_15); Py_XDECREF(__pyx_t_14); Py_XDECREF(__pyx_t_13);
        __Pyx_RaiseBufferFallbackError();
      } else {
        PyErr_Restore(__pyx_t_15, __pyx_t_14, __pyx_t_13);
      }
    }
    __pyx_pybuffernd_res.diminfo[0].strides = __pyx_pybuffernd_res.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_res.diminfo[0].shape = __pyx_pybuffernd_res.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_res.diminfo[1].strides = __pyx_pybuffernd_res.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_res.diminfo[1].shape = __pyx_pybuffernd_res.rcbuffer->pybuffer.shape[1];
    if (unlikely(__pyx_t_12 < 0)) __PYX_ERR(0, 1495, __pyx_L1_error)
  }
  __pyx_t_10 = 0;
  __Pyx_DECREF_SET(__pyx_v_res, ((PyArrayObject *)__pyx_t_34));
  __pyx_t_34 = 0;

  /* "orb/cutils.pyx":1499
 *                          saturation)
 * 
 *         return res[np.nonzero(~np.isnan(res))]             # <<<<<<<<<<<<<<
 * 
 *     ## filter pos list
 */
  __Pyx_XDECREF(__pyx_r);
  __pyx_t_30 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_30)) __PYX_ERR(0, 1499, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_30);
  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_30, __pyx_n_s_nonzero); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1499, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_DECREF(__pyx_t_30); __pyx_t_30 = 0;
  __pyx_t_32 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_32)) __PYX_ERR(0, 1499, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_32);
  __pyx_t_37 = __Pyx_PyObject_GetAttrStr(__pyx_t_32, __pyx_n_s_isnan); if (unlikely(!__pyx_t_37)) __PYX_ERR(0, 1499, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_37);
  __Pyx_DECREF(__pyx_t_32); __pyx_t_32 = 0;
  __pyx_t_32 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_37))) {
    __pyx_t_32 = PyMethod_GET_SELF(__pyx_t_37);
    if (likely(__pyx_t_32)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_37);
      __Pyx_INCREF(__pyx_t_32);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_37, function);
    }
  }
  if (!__pyx_t_32) {
    __pyx_t_30 = __Pyx_PyObject_CallOneArg(__pyx_t_37, ((PyObject *)__pyx_v_res)); if (unlikely(!__pyx_t_30)) __PYX_ERR(0, 1499, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_30);
  } else {
    __pyx_t_2 = PyTuple_New(1+1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1499, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_GIVEREF(__pyx_t_32); PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_32); __pyx_t_32 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_res));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_res));
    PyTuple_SET_ITEM(__pyx_t_2, 0+1, ((PyObject *)__pyx_v_res));
    __pyx_t_30 = __Pyx_PyObject_Call(__pyx_t_37, __pyx_t_2, NULL); if (unlikely(!__pyx_t_30)) __PYX_ERR(0, 1499, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_30);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  }
  __Pyx_DECREF(__pyx_t_37); __pyx_t_37 = 0;
  __pyx_t_37 = PyNumber_Invert(__pyx_t_30); if (unlikely(!__pyx_t_37)) __PYX_ERR(0, 1499, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_37);
  __Pyx_DECREF(__pyx_t_30); __pyx_t_30 = 0;
  __pyx_t_30 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_1))) {
    __pyx_t_30 = PyMethod_GET_SELF(__pyx_t_1);
    if (likely(__pyx_t_30)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_1);
      __Pyx_INCREF(__pyx_t_30);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_1, function);
    }
  }
  if (!__pyx_t_30) {
    __pyx_t_34 = __Pyx_PyObject_CallOneArg(__pyx_t_1, __pyx_t_37); if (unlikely(!__pyx_t_34)) __PYX_ERR(0, 1499, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_37); __pyx_t_37 = 0;
    __Pyx_GOTREF(__pyx_t_34);
  } else {
    __pyx_t_2 = PyTuple_New(1+1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1499, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_GIVEREF(__pyx_t_30); PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_30); __pyx_t_30 = NULL;
    __Pyx_GIVEREF(__pyx_t_37);
    PyTuple_SET_ITEM(__pyx_t_2, 0+1, __pyx_t_37);
    __pyx_t_37 = 0;
    __pyx_t_34 = __Pyx_PyObject_Call(__pyx_t_1, __pyx_t_2, NULL); if (unlikely(!__pyx_t_34)) __PYX_ERR(0, 1499, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_34);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  }
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_1 = PyObject_GetItem(((PyObject *)__pyx_v_res), __pyx_t_34); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1499, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_DECREF(__pyx_t_34); __pyx_t_34 = 0;
  __pyx_r = __pyx_t_1;
  __pyx_t_1 = 0;
  goto __pyx_L0;

  /* "orb/cutils.pyx":1452
 *         return res
 * 
 *     def diff(np.ndarray[np.float64_t, ndim=1] free_p,             # <<<<<<<<<<<<<<
 *              np.ndarray[np.float64_t, ndim=1] fixed_p,
 *              np.ndarray[np.float64_t, ndim=1] stars_p_mask,
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_1);
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_XDECREF(__pyx_t_5);
  __Pyx_XDECREF(__pyx_t_6);
  __Pyx_XDECREF(__pyx_t_16);
  __Pyx_XDECREF(__pyx_t_28);
  __Pyx_XDECREF(__pyx_t_29);
  __Pyx_XDECREF(__pyx_t_30);
  __Pyx_XDECREF(__pyx_t_32);
  __Pyx_XDECREF(__pyx_t_34);
  __Pyx_XDECREF(__pyx_t_35);
  __Pyx_XDECREF(__pyx_t_37);
  { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
    __Pyx_PyThreadState_declare
    __Pyx_PyThreadState_assign
    __Pyx_ErrFetch(&__pyx_type, &__pyx_value, &__pyx_tb);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_cov_p.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_cov_p_mask.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_fixed_p.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_frame.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_free_p.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_noise.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_params.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_res.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_stars_p.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_stars_p_mask.rcbuffer->pybuffer);
  __Pyx_ErrRestore(__pyx_type, __pyx_value, __pyx_tb);}
  __Pyx_AddTraceback("orb.cutils.multi_fit_stars.diff", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  goto __pyx_L2;
  __pyx_L0:;
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_cov_p.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_cov_p_mask.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_fixed_p.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_frame.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_free_p.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_noise.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_params.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_res.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_stars_p.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_stars_p_mask.rcbuffer->pybuffer);
  __pyx_L2:;
  __Pyx_XDECREF((PyObject *)__pyx_v_params);
  __Pyx_XDECREF((PyObject *)__pyx_v_stars_p);
  __Pyx_XDECREF((PyObject *)__pyx_v_cov_p);
  __Pyx_XDECREF((PyObject *)__pyx_v_res);
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":1208
 *     return inside
 * 
 * def multi_fit_stars(np.ndarray[np.float64_t, ndim=2] frame,             # <<<<<<<<<<<<<<
 *                     np.ndarray[np.float64_t, ndim=2] pos,
 *                     int box_size,
 */

static PyObject *__pyx_pf_3orb_6cutils_58multi_fit_stars(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_frame, PyArrayObject *__pyx_v_pos, int __pyx_v_box_size, double __pyx_v_height_guess, PyArrayObject *__pyx_v_fwhm_guess, PyBoolObject *__pyx_v_cov_height, PyBoolObject *__pyx_v_cov_pos, PyBoolObject *__pyx_v_cov_fwhm, PyBoolObject *__pyx_v_fix_height, PyBoolObject *__pyx_v_fix_pos, PyBoolObject *__pyx_v_fix_fwhm, double __pyx_v_fit_tol, double __pyx_v_ron, double __pyx_v_dcl, PyBoolObject *__pyx_v_enable_zoom, PyBoolObject *__pyx_v_enable_rotation, PyBoolObject *__pyx_v_estimate_local_noise, double __pyx_v_saturation, PyObject *__pyx_v_sip) {
  struct __pyx_obj_3orb_6cutils___pyx_scope_struct__multi_fit_stars *__pyx_cur_scope;
  PyObject *__pyx_v_params_arrays2vect = 0;
  CYTHON_UNUSED PyObject *__pyx_v_sigma = 0;
  PyObject *__pyx_v_diff = 0;
  PyArrayObject *__pyx_v_pos_mask = 0;
  int __pyx_v_istar;
  PyArrayObject *__pyx_v_new_pos = 0;
  int __pyx_v_PARAMS_NB;
  int __pyx_v_star_nb;
  PyArrayObject *__pyx_v_stars_p = 0;
  CYTHON_UNUSED PyArrayObject *__pyx_v_fwhm_pix = 0;
  PyArrayObject *__pyx_v_stars_err = 0;
  PyArrayObject *__pyx_v_new_stars_p = 0;
  PyArrayObject *__pyx_v_new_stars_err = 0;
  PyArrayObject *__pyx_v_stars_p_mask = 0;
  PyArrayObject *__pyx_v_test_p = 0;
  PyArrayObject *__pyx_v_cov_p = 0;
  PyArrayObject *__pyx_v_cov_err = 0;
  PyArrayObject *__pyx_v_cov_p_mask = 0;
  PyArrayObject *__pyx_v_frame_mask = 0;
  PyArrayObject *__pyx_v_amp_guess = 0;
  PyArrayObject *__pyx_v_free_p = 0;
  PyArrayObject *__pyx_v_fixed_p = 0;
  PyArrayObject *__pyx_v_test_x = 0;
  PyArrayObject *__pyx_v_test_y = 0;
  int __pyx_v_x_min;
  int __pyx_v_x_max;
  int __pyx_v_y_min;
  int __pyx_v_y_max;
  double __pyx_v_rcx;
  double __pyx_v_rcy;
  PyArrayObject *__pyx_v_noise_guess = 0;
  PyArrayObject *__pyx_v_cov_matrix = 0;
  PyArrayObject *__pyx_v_box = 0;
  double __pyx_v_dx_guess;
  double __pyx_v_dy_guess;
  double __pyx_v_dx_guess_arg;
  double __pyx_v_dy_guess_arg;
  PyObject *__pyx_v_added_height = 0;
  PyObject *__pyx_v_frame_min = 0;
  double __pyx_v_FWHM_SKY_COEFF;
  int __pyx_v_SUB_DIV;
  PyObject *__pyx_v_nzi = NULL;
  PyObject *__pyx_v_nzj = NULL;
  PyObject *__pyx_v_S_sky = NULL;
  PyObject *__pyx_v_sky_pixels = NULL;
  PyObject *__pyx_v_fit = NULL;
  PyObject *__pyx_v_e = NULL;
  PyObject *__pyx_v_returned_data = NULL;
  PyObject *__pyx_v_last_diff = NULL;
  PyObject *__pyx_v_chisq = NULL;
  PyObject *__pyx_v_red_chisq = NULL;
  PyObject *__pyx_v_cov_diag = NULL;
  PyObject *__pyx_v_i = NULL;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_amp_guess;
  __Pyx_Buffer __pyx_pybuffer_amp_guess;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_box;
  __Pyx_Buffer __pyx_pybuffer_box;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_cov_err;
  __Pyx_Buffer __pyx_pybuffer_cov_err;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_cov_matrix;
  __Pyx_Buffer __pyx_pybuffer_cov_matrix;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_cov_p;
  __Pyx_Buffer __pyx_pybuffer_cov_p;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_cov_p_mask;
  __Pyx_Buffer __pyx_pybuffer_cov_p_mask;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_fixed_p;
  __Pyx_Buffer __pyx_pybuffer_fixed_p;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_frame;
  __Pyx_Buffer __pyx_pybuffer_frame;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_frame_mask;
  __Pyx_Buffer __pyx_pybuffer_frame_mask;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_free_p;
  __Pyx_Buffer __pyx_pybuffer_free_p;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_fwhm_guess;
  __Pyx_Buffer __pyx_pybuffer_fwhm_guess;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_fwhm_pix;
  __Pyx_Buffer __pyx_pybuffer_fwhm_pix;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_new_pos;
  __Pyx_Buffer __pyx_pybuffer_new_pos;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_new_stars_err;
  __Pyx_Buffer __pyx_pybuffer_new_stars_err;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_new_stars_p;
  __Pyx_Buffer __pyx_pybuffer_new_stars_p;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_noise_guess;
  __Pyx_Buffer __pyx_pybuffer_noise_guess;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_pos;
  __Pyx_Buffer __pyx_pybuffer_pos;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_pos_mask;
  __Pyx_Buffer __pyx_pybuffer_pos_mask;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_stars_err;
  __Pyx_Buffer __pyx_pybuffer_stars_err;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_stars_p;
  __Pyx_Buffer __pyx_pybuffer_stars_p;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_stars_p_mask;
  __Pyx_Buffer __pyx_pybuffer_stars_p_mask;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_test_p;
  __Pyx_Buffer __pyx_pybuffer_test_p;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_test_x;
  __Pyx_Buffer __pyx_pybuffer_test_x;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_test_y;
  __Pyx_Buffer __pyx_pybuffer_test_y;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  PyObject *__pyx_t_1 = NULL;
  PyObject *__pyx_t_2 = NULL;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  PyObject *__pyx_t_5 = NULL;
  PyArrayObject *__pyx_t_6 = NULL;
  npy_intp __pyx_t_7;
  int __pyx_t_8;
  int __pyx_t_9;
  Py_ssize_t __pyx_t_10;
  Py_ssize_t __pyx_t_11;
  int __pyx_t_12;
  int __pyx_t_13;
  Py_ssize_t __pyx_t_14;
  Py_ssize_t __pyx_t_15;
  Py_ssize_t __pyx_t_16;
  Py_ssize_t __pyx_t_17;
  Py_ssize_t __pyx_t_18;
  Py_ssize_t __pyx_t_19;
  Py_ssize_t __pyx_t_20;
  PyArrayObject *__pyx_t_21 = NULL;
  PyObject *__pyx_t_22 = NULL;
  PyObject *__pyx_t_23 = NULL;
  PyObject *__pyx_t_24 = NULL;
  PyArrayObject *__pyx_t_25 = NULL;
  PyArrayObject *__pyx_t_26 = NULL;
  PyArrayObject *__pyx_t_27 = NULL;
  PyArrayObject *__pyx_t_28 = NULL;
  PyArrayObject *__pyx_t_29 = NULL;
  PyArrayObject *__pyx_t_30 = NULL;
  PyArrayObject *__pyx_t_31 = NULL;
  PyArrayObject *__pyx_t_32 = NULL;
  PyArrayObject *__pyx_t_33 = NULL;
  PyArrayObject *__pyx_t_34 = NULL;
  PyArrayObject *__pyx_t_35 = NULL;
  PyArrayObject *__pyx_t_36 = NULL;
  PyArrayObject *__pyx_t_37 = NULL;
  PyArrayObject *__pyx_t_38 = NULL;
  PyArrayObject *__pyx_t_39 = NULL;
  PyObject *__pyx_t_40 = NULL;
  PyArrayObject *__pyx_t_41 = NULL;
  PyObject *__pyx_t_42 = NULL;
  PyObject *__pyx_t_43 = NULL;
  PyObject *__pyx_t_44 = NULL;
  double __pyx_t_45;
  Py_ssize_t __pyx_t_46;
  Py_ssize_t __pyx_t_47;
  Py_ssize_t __pyx_t_48;
  PyObject *__pyx_t_49 = NULL;
  Py_ssize_t __pyx_t_50;
  Py_ssize_t __pyx_t_51;
  int __pyx_t_52;
  Py_ssize_t __pyx_t_53;
  Py_ssize_t __pyx_t_54;
  Py_ssize_t __pyx_t_55;
  Py_ssize_t __pyx_t_56;
  PyObject *(*__pyx_t_57)(PyObject *);
  int __pyx_t_58;
  int __pyx_t_59;
  int __pyx_t_60;
  PyArrayObject *__pyx_t_61 = NULL;
  __pyx_t_5numpy_float64_t __pyx_t_62;
  Py_ssize_t __pyx_t_63;
  Py_ssize_t __pyx_t_64;
  Py_ssize_t __pyx_t_65;
  Py_ssize_t __pyx_t_66;
  Py_ssize_t __pyx_t_67;
  Py_ssize_t __pyx_t_68;
  Py_ssize_t __pyx_t_69;
  PyObject *__pyx_t_70 = NULL;
  PyObject *__pyx_t_71 = NULL;
  PyObject *__pyx_t_72 = NULL;
  Py_ssize_t __pyx_t_73;
  Py_ssize_t __pyx_t_74;
  Py_ssize_t __pyx_t_75;
  Py_ssize_t __pyx_t_76;
  Py_ssize_t __pyx_t_77;
  Py_ssize_t __pyx_t_78;
  Py_ssize_t __pyx_t_79;
  int __pyx_t_80;
  Py_ssize_t __pyx_t_81;
  Py_ssize_t __pyx_t_82;
  Py_ssize_t __pyx_t_83;
  Py_ssize_t __pyx_t_84;
  Py_ssize_t __pyx_t_85;
  Py_ssize_t __pyx_t_86;
  Py_ssize_t __pyx_t_87;
  Py_ssize_t __pyx_t_88;
  Py_ssize_t __pyx_t_89;
  Py_ssize_t __pyx_t_90;
  Py_ssize_t __pyx_t_91;
  PyArrayObject *__pyx_t_92 = NULL;
  PyArrayObject *__pyx_t_93 = NULL;
  Py_ssize_t __pyx_t_94;
  Py_ssize_t __pyx_t_95;
  Py_ssize_t __pyx_t_96;
  Py_ssize_t __pyx_t_97;
  Py_ssize_t __pyx_t_98;
  Py_ssize_t __pyx_t_99;
  Py_ssize_t __pyx_t_100;
  Py_ssize_t __pyx_t_101;
  Py_ssize_t __pyx_t_102;
  Py_ssize_t __pyx_t_103;
  Py_ssize_t __pyx_t_104;
  Py_ssize_t __pyx_t_105;
  Py_ssize_t __pyx_t_106;
  Py_ssize_t __pyx_t_107;
  Py_ssize_t __pyx_t_108;
  Py_ssize_t __pyx_t_109;
  PyObject *__pyx_t_110 = NULL;
  __pyx_t_5numpy_float64_t __pyx_t_111;
  Py_ssize_t __pyx_t_112;
  Py_ssize_t __pyx_t_113;
  Py_ssize_t __pyx_t_114;
  Py_ssize_t __pyx_t_115;
  PyObject *(*__pyx_t_116)(PyObject *);
  Py_ssize_t __pyx_t_117;
  Py_ssize_t __pyx_t_118;
  Py_ssize_t __pyx_t_119;
  Py_ssize_t __pyx_t_120;
  Py_ssize_t __pyx_t_121;
  Py_ssize_t __pyx_t_122;
  Py_ssize_t __pyx_t_123;
  Py_ssize_t __pyx_t_124;
  Py_ssize_t __pyx_t_125;
  Py_ssize_t __pyx_t_126;
  Py_ssize_t __pyx_t_127;
  Py_ssize_t __pyx_t_128;
  Py_ssize_t __pyx_t_129;
  Py_ssize_t __pyx_t_130;
  Py_ssize_t __pyx_t_131;
  Py_ssize_t __pyx_t_132;
  Py_ssize_t __pyx_t_133;
  Py_ssize_t __pyx_t_134;
  Py_ssize_t __pyx_t_135;
  Py_ssize_t __pyx_t_136;
  __pyx_t_5numpy_float64_t __pyx_t_137;
  __pyx_t_5numpy_float64_t __pyx_t_138;
  Py_ssize_t __pyx_t_139;
  Py_ssize_t __pyx_t_140;
  Py_ssize_t __pyx_t_141;
  Py_ssize_t __pyx_t_142;
  Py_ssize_t __pyx_t_143;
  Py_ssize_t __pyx_t_144;
  Py_ssize_t __pyx_t_145;
  Py_ssize_t __pyx_t_146;
  Py_ssize_t __pyx_t_147;
  __Pyx_RefNannySetupContext("multi_fit_stars", 0);
  __pyx_cur_scope = (struct __pyx_obj_3orb_6cutils___pyx_scope_struct__multi_fit_stars *)__pyx_tp_new_3orb_6cutils___pyx_scope_struct__multi_fit_stars(__pyx_ptype_3orb_6cutils___pyx_scope_struct__multi_fit_stars, __pyx_empty_tuple, NULL);
  if (unlikely(!__pyx_cur_scope)) {
    __Pyx_RefNannyFinishContext();
    return NULL;
  }
  __Pyx_GOTREF(__pyx_cur_scope);
  __Pyx_INCREF((PyObject *)__pyx_v_frame);
  __pyx_pybuffer_pos_mask.pybuffer.buf = NULL;
  __pyx_pybuffer_pos_mask.refcount = 0;
  __pyx_pybuffernd_pos_mask.data = NULL;
  __pyx_pybuffernd_pos_mask.rcbuffer = &__pyx_pybuffer_pos_mask;
  __pyx_pybuffer_new_pos.pybuffer.buf = NULL;
  __pyx_pybuffer_new_pos.refcount = 0;
  __pyx_pybuffernd_new_pos.data = NULL;
  __pyx_pybuffernd_new_pos.rcbuffer = &__pyx_pybuffer_new_pos;
  __pyx_pybuffer_stars_p.pybuffer.buf = NULL;
  __pyx_pybuffer_stars_p.refcount = 0;
  __pyx_pybuffernd_stars_p.data = NULL;
  __pyx_pybuffernd_stars_p.rcbuffer = &__pyx_pybuffer_stars_p;
  __pyx_pybuffer_fwhm_pix.pybuffer.buf = NULL;
  __pyx_pybuffer_fwhm_pix.refcount = 0;
  __pyx_pybuffernd_fwhm_pix.data = NULL;
  __pyx_pybuffernd_fwhm_pix.rcbuffer = &__pyx_pybuffer_fwhm_pix;
  __pyx_pybuffer_stars_err.pybuffer.buf = NULL;
  __pyx_pybuffer_stars_err.refcount = 0;
  __pyx_pybuffernd_stars_err.data = NULL;
  __pyx_pybuffernd_stars_err.rcbuffer = &__pyx_pybuffer_stars_err;
  __pyx_pybuffer_new_stars_p.pybuffer.buf = NULL;
  __pyx_pybuffer_new_stars_p.refcount = 0;
  __pyx_pybuffernd_new_stars_p.data = NULL;
  __pyx_pybuffernd_new_stars_p.rcbuffer = &__pyx_pybuffer_new_stars_p;
  __pyx_pybuffer_new_stars_err.pybuffer.buf = NULL;
  __pyx_pybuffer_new_stars_err.refcount = 0;
  __pyx_pybuffernd_new_stars_err.data = NULL;
  __pyx_pybuffernd_new_stars_err.rcbuffer = &__pyx_pybuffer_new_stars_err;
  __pyx_pybuffer_stars_p_mask.pybuffer.buf = NULL;
  __pyx_pybuffer_stars_p_mask.refcount = 0;
  __pyx_pybuffernd_stars_p_mask.data = NULL;
  __pyx_pybuffernd_stars_p_mask.rcbuffer = &__pyx_pybuffer_stars_p_mask;
  __pyx_pybuffer_test_p.pybuffer.buf = NULL;
  __pyx_pybuffer_test_p.refcount = 0;
  __pyx_pybuffernd_test_p.data = NULL;
  __pyx_pybuffernd_test_p.rcbuffer = &__pyx_pybuffer_test_p;
  __pyx_pybuffer_cov_p.pybuffer.buf = NULL;
  __pyx_pybuffer_cov_p.refcount = 0;
  __pyx_pybuffernd_cov_p.data = NULL;
  __pyx_pybuffernd_cov_p.rcbuffer = &__pyx_pybuffer_cov_p;
  __pyx_pybuffer_cov_err.pybuffer.buf = NULL;
  __pyx_pybuffer_cov_err.refcount = 0;
  __pyx_pybuffernd_cov_err.data = NULL;
  __pyx_pybuffernd_cov_err.rcbuffer = &__pyx_pybuffer_cov_err;
  __pyx_pybuffer_cov_p_mask.pybuffer.buf = NULL;
  __pyx_pybuffer_cov_p_mask.refcount = 0;
  __pyx_pybuffernd_cov_p_mask.data = NULL;
  __pyx_pybuffernd_cov_p_mask.rcbuffer = &__pyx_pybuffer_cov_p_mask;
  __pyx_pybuffer_frame_mask.pybuffer.buf = NULL;
  __pyx_pybuffer_frame_mask.refcount = 0;
  __pyx_pybuffernd_frame_mask.data = NULL;
  __pyx_pybuffernd_frame_mask.rcbuffer = &__pyx_pybuffer_frame_mask;
  __pyx_pybuffer_amp_guess.pybuffer.buf = NULL;
  __pyx_pybuffer_amp_guess.refcount = 0;
  __pyx_pybuffernd_amp_guess.data = NULL;
  __pyx_pybuffernd_amp_guess.rcbuffer = &__pyx_pybuffer_amp_guess;
  __pyx_pybuffer_free_p.pybuffer.buf = NULL;
  __pyx_pybuffer_free_p.refcount = 0;
  __pyx_pybuffernd_free_p.data = NULL;
  __pyx_pybuffernd_free_p.rcbuffer = &__pyx_pybuffer_free_p;
  __pyx_pybuffer_fixed_p.pybuffer.buf = NULL;
  __pyx_pybuffer_fixed_p.refcount = 0;
  __pyx_pybuffernd_fixed_p.data = NULL;
  __pyx_pybuffernd_fixed_p.rcbuffer = &__pyx_pybuffer_fixed_p;
  __pyx_pybuffer_test_x.pybuffer.buf = NULL;
  __pyx_pybuffer_test_x.refcount = 0;
  __pyx_pybuffernd_test_x.data = NULL;
  __pyx_pybuffernd_test_x.rcbuffer = &__pyx_pybuffer_test_x;
  __pyx_pybuffer_test_y.pybuffer.buf = NULL;
  __pyx_pybuffer_test_y.refcount = 0;
  __pyx_pybuffernd_test_y.data = NULL;
  __pyx_pybuffernd_test_y.rcbuffer = &__pyx_pybuffer_test_y;
  __pyx_pybuffer_noise_guess.pybuffer.buf = NULL;
  __pyx_pybuffer_noise_guess.refcount = 0;
  __pyx_pybuffernd_noise_guess.data = NULL;
  __pyx_pybuffernd_noise_guess.rcbuffer = &__pyx_pybuffer_noise_guess;
  __pyx_pybuffer_cov_matrix.pybuffer.buf = NULL;
  __pyx_pybuffer_cov_matrix.refcount = 0;
  __pyx_pybuffernd_cov_matrix.data = NULL;
  __pyx_pybuffernd_cov_matrix.rcbuffer = &__pyx_pybuffer_cov_matrix;
  __pyx_pybuffer_box.pybuffer.buf = NULL;
  __pyx_pybuffer_box.refcount = 0;
  __pyx_pybuffernd_box.data = NULL;
  __pyx_pybuffernd_box.rcbuffer = &__pyx_pybuffer_box;
  __pyx_pybuffer_frame.pybuffer.buf = NULL;
  __pyx_pybuffer_frame.refcount = 0;
  __pyx_pybuffernd_frame.data = NULL;
  __pyx_pybuffernd_frame.rcbuffer = &__pyx_pybuffer_frame;
  __pyx_pybuffer_pos.pybuffer.buf = NULL;
  __pyx_pybuffer_pos.refcount = 0;
  __pyx_pybuffernd_pos.data = NULL;
  __pyx_pybuffernd_pos.rcbuffer = &__pyx_pybuffer_pos;
  __pyx_pybuffer_fwhm_guess.pybuffer.buf = NULL;
  __pyx_pybuffer_fwhm_guess.refcount = 0;
  __pyx_pybuffernd_fwhm_guess.data = NULL;
  __pyx_pybuffernd_fwhm_guess.rcbuffer = &__pyx_pybuffer_fwhm_guess;
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_frame.rcbuffer->pybuffer, (PyObject*)__pyx_v_frame, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) __PYX_ERR(0, 1208, __pyx_L1_error)
  }
  __pyx_pybuffernd_frame.diminfo[0].strides = __pyx_pybuffernd_frame.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_frame.diminfo[0].shape = __pyx_pybuffernd_frame.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_frame.diminfo[1].strides = __pyx_pybuffernd_frame.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_frame.diminfo[1].shape = __pyx_pybuffernd_frame.rcbuffer->pybuffer.shape[1];
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_pos.rcbuffer->pybuffer, (PyObject*)__pyx_v_pos, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) __PYX_ERR(0, 1208, __pyx_L1_error)
  }
  __pyx_pybuffernd_pos.diminfo[0].strides = __pyx_pybuffernd_pos.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_pos.diminfo[0].shape = __pyx_pybuffernd_pos.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_pos.diminfo[1].strides = __pyx_pybuffernd_pos.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_pos.diminfo[1].shape = __pyx_pybuffernd_pos.rcbuffer->pybuffer.shape[1];
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_fwhm_guess.rcbuffer->pybuffer, (PyObject*)__pyx_v_fwhm_guess, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) __PYX_ERR(0, 1208, __pyx_L1_error)
  }
  __pyx_pybuffernd_fwhm_guess.diminfo[0].strides = __pyx_pybuffernd_fwhm_guess.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_fwhm_guess.diminfo[0].shape = __pyx_pybuffernd_fwhm_guess.rcbuffer->pybuffer.shape[0];

  /* "orb/cutils.pyx":1297
 *       distorsion correction (default None).
 *     """
 *     def params_arrays2vect(np.ndarray[np.float64_t, ndim=2] stars_p,             # <<<<<<<<<<<<<<
 *                            np.ndarray[np.float64_t, ndim=1] stars_p_mask,
 *                            np.ndarray[np.float64_t, ndim=1] cov_p,
 */
  __pyx_t_1 = __Pyx_CyFunction_NewEx(&__pyx_mdef_3orb_6cutils_15multi_fit_stars_1params_arrays2vect, 0, __pyx_n_s_multi_fit_stars_locals_params_ar, NULL, __pyx_n_s_orb_cutils, __pyx_d, ((PyObject *)__pyx_codeobj__81)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1297, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_v_params_arrays2vect = __pyx_t_1;
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1334
 *         return free_p, fixed_p
 * 
 *     def params_vect2arrays(np.ndarray[np.float64_t, ndim=1] free_p,             # <<<<<<<<<<<<<<
 *                            np.ndarray[np.float64_t, ndim=1] fixed_p,
 *                            np.ndarray[np.float64_t, ndim=1] stars_p_mask,
 */
  __pyx_t_1 = __Pyx_CyFunction_NewEx(&__pyx_mdef_3orb_6cutils_15multi_fit_stars_3params_vect2arrays, 0, __pyx_n_s_multi_fit_stars_locals_params_ve, NULL, __pyx_n_s_orb_cutils, __pyx_d, ((PyObject *)__pyx_codeobj__83)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1334, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_GIVEREF(__pyx_t_1);
  __pyx_cur_scope->__pyx_v_params_vect2arrays = __pyx_t_1;
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1367
 *         return stars_p, cov_p
 * 
 *     def sigma(np.ndarray[np.float64_t, ndim=2] data,             # <<<<<<<<<<<<<<
 *               double noise, double dcl):
 *         """guess sigma as sqrt(photon noise + readout noise^2 + dark
 */
  __pyx_t_1 = __Pyx_CyFunction_NewEx(&__pyx_mdef_3orb_6cutils_15multi_fit_stars_5sigma, 0, __pyx_n_s_multi_fit_stars_locals_sigma, NULL, __pyx_n_s_orb_cutils, __pyx_d, ((PyObject *)__pyx_codeobj__85)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1367, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_v_sigma = __pyx_t_1;
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1373
 *         return np.sqrt(np.abs(data) + (noise)**2. + dcl)
 * 
 *     def model_diff(int dimx, int dimy, np.ndarray[np.float64_t, ndim=2] params,             # <<<<<<<<<<<<<<
 *                    int box_size, np.ndarray[np.float64_t, ndim=2] frame,
 *                    np.ndarray[np.float64_t, ndim=1] noise, double dcl,
 */
  __pyx_t_1 = __Pyx_CyFunction_NewEx(&__pyx_mdef_3orb_6cutils_15multi_fit_stars_7model_diff, 0, __pyx_n_s_multi_fit_stars_locals_model_dif, NULL, __pyx_n_s_orb_cutils, __pyx_d, ((PyObject *)__pyx_codeobj__87)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1373, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_CyFunction_SetDefaultsTuple(__pyx_t_1, __pyx_tuple__88);
  __Pyx_GIVEREF(__pyx_t_1);
  __pyx_cur_scope->__pyx_v_model_diff = __pyx_t_1;
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1452
 *         return res
 * 
 *     def diff(np.ndarray[np.float64_t, ndim=1] free_p,             # <<<<<<<<<<<<<<
 *              np.ndarray[np.float64_t, ndim=1] fixed_p,
 *              np.ndarray[np.float64_t, ndim=1] stars_p_mask,
 */
  __pyx_t_1 = __Pyx_CyFunction_NewEx(&__pyx_mdef_3orb_6cutils_15multi_fit_stars_9diff, 0, __pyx_n_s_multi_fit_stars_locals_diff, ((PyObject*)__pyx_cur_scope), __pyx_n_s_orb_cutils, __pyx_d, ((PyObject *)__pyx_codeobj__90)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1452, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_v_diff = __pyx_t_1;
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1502
 * 
 *     ## filter pos list
 *     cdef np.ndarray[np.uint8_t, ndim=1] pos_mask = np.zeros(             # <<<<<<<<<<<<<<
 *         pos.shape[0], dtype=np.uint8)
 *     cdef int istar
 */
  __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1502, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_zeros); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1502, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1503
 *     ## filter pos list
 *     cdef np.ndarray[np.uint8_t, ndim=1] pos_mask = np.zeros(
 *         pos.shape[0], dtype=np.uint8)             # <<<<<<<<<<<<<<
 *     cdef int istar
 *     for istar in range(pos.shape[0]):
 */
  __pyx_t_1 = __Pyx_PyInt_From_Py_intptr_t((__pyx_v_pos->dimensions[0])); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1503, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);

  /* "orb/cutils.pyx":1502
 * 
 *     ## filter pos list
 *     cdef np.ndarray[np.uint8_t, ndim=1] pos_mask = np.zeros(             # <<<<<<<<<<<<<<
 *         pos.shape[0], dtype=np.uint8)
 *     cdef int istar
 */
  __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1502, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_GIVEREF(__pyx_t_1);
  PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_1);
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1503
 *     ## filter pos list
 *     cdef np.ndarray[np.uint8_t, ndim=1] pos_mask = np.zeros(
 *         pos.shape[0], dtype=np.uint8)             # <<<<<<<<<<<<<<
 *     cdef int istar
 *     for istar in range(pos.shape[0]):
 */
  __pyx_t_1 = PyDict_New(); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1503, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1503, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_uint8); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1503, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  if (PyDict_SetItem(__pyx_t_1, __pyx_n_s_dtype, __pyx_t_5) < 0) __PYX_ERR(0, 1503, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

  /* "orb/cutils.pyx":1502
 * 
 *     ## filter pos list
 *     cdef np.ndarray[np.uint8_t, ndim=1] pos_mask = np.zeros(             # <<<<<<<<<<<<<<
 *         pos.shape[0], dtype=np.uint8)
 *     cdef int istar
 */
  __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_3, __pyx_t_1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1502, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  if (!(likely(((__pyx_t_5) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_5, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1502, __pyx_L1_error)
  __pyx_t_6 = ((PyArrayObject *)__pyx_t_5);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_pos_mask.rcbuffer->pybuffer, (PyObject*)__pyx_t_6, &__Pyx_TypeInfo_nn___pyx_t_5numpy_uint8_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 1, 0, __pyx_stack) == -1)) {
      __pyx_v_pos_mask = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_pos_mask.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 1502, __pyx_L1_error)
    } else {__pyx_pybuffernd_pos_mask.diminfo[0].strides = __pyx_pybuffernd_pos_mask.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_pos_mask.diminfo[0].shape = __pyx_pybuffernd_pos_mask.rcbuffer->pybuffer.shape[0];
    }
  }
  __pyx_t_6 = 0;
  __pyx_v_pos_mask = ((PyArrayObject *)__pyx_t_5);
  __pyx_t_5 = 0;

  /* "orb/cutils.pyx":1505
 *         pos.shape[0], dtype=np.uint8)
 *     cdef int istar
 *     for istar in range(pos.shape[0]):             # <<<<<<<<<<<<<<
 *         if (pos[istar,0] > 0. and pos[istar,0] < <double> frame.shape[0]
 *             and pos[istar,1] > 0. and pos[istar,1] < <double> frame.shape[1]):
 */
  __pyx_t_7 = (__pyx_v_pos->dimensions[0]);
  for (__pyx_t_8 = 0; __pyx_t_8 < __pyx_t_7; __pyx_t_8+=1) {
    __pyx_v_istar = __pyx_t_8;

    /* "orb/cutils.pyx":1506
 *     cdef int istar
 *     for istar in range(pos.shape[0]):
 *         if (pos[istar,0] > 0. and pos[istar,0] < <double> frame.shape[0]             # <<<<<<<<<<<<<<
 *             and pos[istar,1] > 0. and pos[istar,1] < <double> frame.shape[1]):
 *             pos_mask[istar] = 1
 */
    __pyx_t_10 = __pyx_v_istar;
    __pyx_t_11 = 0;
    __pyx_t_12 = -1;
    if (__pyx_t_10 < 0) {
      __pyx_t_10 += __pyx_pybuffernd_pos.diminfo[0].shape;
      if (unlikely(__pyx_t_10 < 0)) __pyx_t_12 = 0;
    } else if (unlikely(__pyx_t_10 >= __pyx_pybuffernd_pos.diminfo[0].shape)) __pyx_t_12 = 0;
    if (__pyx_t_11 < 0) {
      __pyx_t_11 += __pyx_pybuffernd_pos.diminfo[1].shape;
      if (unlikely(__pyx_t_11 < 0)) __pyx_t_12 = 1;
    } else if (unlikely(__pyx_t_11 >= __pyx_pybuffernd_pos.diminfo[1].shape)) __pyx_t_12 = 1;
    if (unlikely(__pyx_t_12 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_12);
      __PYX_ERR(0, 1506, __pyx_L1_error)
    }
    __pyx_t_13 = (((*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_pos.rcbuffer->pybuffer.buf, __pyx_t_10, __pyx_pybuffernd_pos.diminfo[0].strides, __pyx_t_11, __pyx_pybuffernd_pos.diminfo[1].strides)) > 0.) != 0);
    if (__pyx_t_13) {
    } else {
      __pyx_t_9 = __pyx_t_13;
      goto __pyx_L6_bool_binop_done;
    }

    /* "orb/cutils.pyx":1507
 *     for istar in range(pos.shape[0]):
 *         if (pos[istar,0] > 0. and pos[istar,0] < <double> frame.shape[0]
 *             and pos[istar,1] > 0. and pos[istar,1] < <double> frame.shape[1]):             # <<<<<<<<<<<<<<
 *             pos_mask[istar] = 1
 * 
 */
    __pyx_t_14 = __pyx_v_istar;
    __pyx_t_15 = 0;
    __pyx_t_12 = -1;
    if (__pyx_t_14 < 0) {
      __pyx_t_14 += __pyx_pybuffernd_pos.diminfo[0].shape;
      if (unlikely(__pyx_t_14 < 0)) __pyx_t_12 = 0;
    } else if (unlikely(__pyx_t_14 >= __pyx_pybuffernd_pos.diminfo[0].shape)) __pyx_t_12 = 0;
    if (__pyx_t_15 < 0) {
      __pyx_t_15 += __pyx_pybuffernd_pos.diminfo[1].shape;
      if (unlikely(__pyx_t_15 < 0)) __pyx_t_12 = 1;
    } else if (unlikely(__pyx_t_15 >= __pyx_pybuffernd_pos.diminfo[1].shape)) __pyx_t_12 = 1;
    if (unlikely(__pyx_t_12 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_12);
      __PYX_ERR(0, 1506, __pyx_L1_error)
    }

    /* "orb/cutils.pyx":1506
 *     cdef int istar
 *     for istar in range(pos.shape[0]):
 *         if (pos[istar,0] > 0. and pos[istar,0] < <double> frame.shape[0]             # <<<<<<<<<<<<<<
 *             and pos[istar,1] > 0. and pos[istar,1] < <double> frame.shape[1]):
 *             pos_mask[istar] = 1
 */
    __pyx_t_13 = (((*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_pos.rcbuffer->pybuffer.buf, __pyx_t_14, __pyx_pybuffernd_pos.diminfo[0].strides, __pyx_t_15, __pyx_pybuffernd_pos.diminfo[1].strides)) < ((double)(__pyx_v_frame->dimensions[0]))) != 0);
    if (__pyx_t_13) {
    } else {
      __pyx_t_9 = __pyx_t_13;
      goto __pyx_L6_bool_binop_done;
    }

    /* "orb/cutils.pyx":1507
 *     for istar in range(pos.shape[0]):
 *         if (pos[istar,0] > 0. and pos[istar,0] < <double> frame.shape[0]
 *             and pos[istar,1] > 0. and pos[istar,1] < <double> frame.shape[1]):             # <<<<<<<<<<<<<<
 *             pos_mask[istar] = 1
 * 
 */
    __pyx_t_16 = __pyx_v_istar;
    __pyx_t_17 = 1;
    __pyx_t_12 = -1;
    if (__pyx_t_16 < 0) {
      __pyx_t_16 += __pyx_pybuffernd_pos.diminfo[0].shape;
      if (unlikely(__pyx_t_16 < 0)) __pyx_t_12 = 0;
    } else if (unlikely(__pyx_t_16 >= __pyx_pybuffernd_pos.diminfo[0].shape)) __pyx_t_12 = 0;
    if (__pyx_t_17 < 0) {
      __pyx_t_17 += __pyx_pybuffernd_pos.diminfo[1].shape;
      if (unlikely(__pyx_t_17 < 0)) __pyx_t_12 = 1;
    } else if (unlikely(__pyx_t_17 >= __pyx_pybuffernd_pos.diminfo[1].shape)) __pyx_t_12 = 1;
    if (unlikely(__pyx_t_12 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_12);
      __PYX_ERR(0, 1507, __pyx_L1_error)
    }
    __pyx_t_13 = (((*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_pos.rcbuffer->pybuffer.buf, __pyx_t_16, __pyx_pybuffernd_pos.diminfo[0].strides, __pyx_t_17, __pyx_pybuffernd_pos.diminfo[1].strides)) > 0.) != 0);
    if (__pyx_t_13) {
    } else {
      __pyx_t_9 = __pyx_t_13;
      goto __pyx_L6_bool_binop_done;
    }
    __pyx_t_18 = __pyx_v_istar;
    __pyx_t_19 = 1;
    __pyx_t_12 = -1;
    if (__pyx_t_18 < 0) {
      __pyx_t_18 += __pyx_pybuffernd_pos.diminfo[0].shape;
      if (unlikely(__pyx_t_18 < 0)) __pyx_t_12 = 0;
    } else if (unlikely(__pyx_t_18 >= __pyx_pybuffernd_pos.diminfo[0].shape)) __pyx_t_12 = 0;
    if (__pyx_t_19 < 0) {
      __pyx_t_19 += __pyx_pybuffernd_pos.diminfo[1].shape;
      if (unlikely(__pyx_t_19 < 0)) __pyx_t_12 = 1;
    } else if (unlikely(__pyx_t_19 >= __pyx_pybuffernd_pos.diminfo[1].shape)) __pyx_t_12 = 1;
    if (unlikely(__pyx_t_12 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_12);
      __PYX_ERR(0, 1507, __pyx_L1_error)
    }
    __pyx_t_13 = (((*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_pos.rcbuffer->pybuffer.buf, __pyx_t_18, __pyx_pybuffernd_pos.diminfo[0].strides, __pyx_t_19, __pyx_pybuffernd_pos.diminfo[1].strides)) < ((double)(__pyx_v_frame->dimensions[1]))) != 0);
    __pyx_t_9 = __pyx_t_13;
    __pyx_L6_bool_binop_done:;

    /* "orb/cutils.pyx":1506
 *     cdef int istar
 *     for istar in range(pos.shape[0]):
 *         if (pos[istar,0] > 0. and pos[istar,0] < <double> frame.shape[0]             # <<<<<<<<<<<<<<
 *             and pos[istar,1] > 0. and pos[istar,1] < <double> frame.shape[1]):
 *             pos_mask[istar] = 1
 */
    if (__pyx_t_9) {

      /* "orb/cutils.pyx":1508
 *         if (pos[istar,0] > 0. and pos[istar,0] < <double> frame.shape[0]
 *             and pos[istar,1] > 0. and pos[istar,1] < <double> frame.shape[1]):
 *             pos_mask[istar] = 1             # <<<<<<<<<<<<<<
 * 
 *     cdef np.ndarray[np.float64_t, ndim=2] new_pos = np.zeros(
 */
      __pyx_t_20 = __pyx_v_istar;
      __pyx_t_12 = -1;
      if (__pyx_t_20 < 0) {
        __pyx_t_20 += __pyx_pybuffernd_pos_mask.diminfo[0].shape;
        if (unlikely(__pyx_t_20 < 0)) __pyx_t_12 = 0;
      } else if (unlikely(__pyx_t_20 >= __pyx_pybuffernd_pos_mask.diminfo[0].shape)) __pyx_t_12 = 0;
      if (unlikely(__pyx_t_12 != -1)) {
        __Pyx_RaiseBufferIndexError(__pyx_t_12);
        __PYX_ERR(0, 1508, __pyx_L1_error)
      }
      *__Pyx_BufPtrStrided1d(__pyx_t_5numpy_uint8_t *, __pyx_pybuffernd_pos_mask.rcbuffer->pybuffer.buf, __pyx_t_20, __pyx_pybuffernd_pos_mask.diminfo[0].strides) = 1;

      /* "orb/cutils.pyx":1506
 *     cdef int istar
 *     for istar in range(pos.shape[0]):
 *         if (pos[istar,0] > 0. and pos[istar,0] < <double> frame.shape[0]             # <<<<<<<<<<<<<<
 *             and pos[istar,1] > 0. and pos[istar,1] < <double> frame.shape[1]):
 *             pos_mask[istar] = 1
 */
    }
  }

  /* "orb/cutils.pyx":1510
 *             pos_mask[istar] = 1
 * 
 *     cdef np.ndarray[np.float64_t, ndim=2] new_pos = np.zeros(             # <<<<<<<<<<<<<<
 *         (np.sum(pos_mask), 2), dtype=float)
 * 
 */
  __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1510, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_zeros); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1510, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

  /* "orb/cutils.pyx":1511
 * 
 *     cdef np.ndarray[np.float64_t, ndim=2] new_pos = np.zeros(
 *         (np.sum(pos_mask), 2), dtype=float)             # <<<<<<<<<<<<<<
 * 
 *     new_pos = pos[np.nonzero(pos_mask)]
 */
  __pyx_t_3 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1511, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_sum); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1511, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_3 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_2))) {
    __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_2);
    if (likely(__pyx_t_3)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
      __Pyx_INCREF(__pyx_t_3);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_2, function);
    }
  }
  if (!__pyx_t_3) {
    __pyx_t_5 = __Pyx_PyObject_CallOneArg(__pyx_t_2, ((PyObject *)__pyx_v_pos_mask)); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1511, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
  } else {
    __pyx_t_4 = PyTuple_New(1+1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1511, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_3); __pyx_t_3 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_pos_mask));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_pos_mask));
    PyTuple_SET_ITEM(__pyx_t_4, 0+1, ((PyObject *)__pyx_v_pos_mask));
    __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_4, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1511, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  }
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = PyTuple_New(2); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1511, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_GIVEREF(__pyx_t_5);
  PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_5);
  __Pyx_INCREF(__pyx_int_2);
  __Pyx_GIVEREF(__pyx_int_2);
  PyTuple_SET_ITEM(__pyx_t_2, 1, __pyx_int_2);
  __pyx_t_5 = 0;

  /* "orb/cutils.pyx":1510
 *             pos_mask[istar] = 1
 * 
 *     cdef np.ndarray[np.float64_t, ndim=2] new_pos = np.zeros(             # <<<<<<<<<<<<<<
 *         (np.sum(pos_mask), 2), dtype=float)
 * 
 */
  __pyx_t_5 = PyTuple_New(1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1510, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_GIVEREF(__pyx_t_2);
  PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_2);
  __pyx_t_2 = 0;

  /* "orb/cutils.pyx":1511
 * 
 *     cdef np.ndarray[np.float64_t, ndim=2] new_pos = np.zeros(
 *         (np.sum(pos_mask), 2), dtype=float)             # <<<<<<<<<<<<<<
 * 
 *     new_pos = pos[np.nonzero(pos_mask)]
 */
  __pyx_t_2 = PyDict_New(); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1511, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  if (PyDict_SetItem(__pyx_t_2, __pyx_n_s_dtype, ((PyObject *)(&PyFloat_Type))) < 0) __PYX_ERR(0, 1511, __pyx_L1_error)

  /* "orb/cutils.pyx":1510
 *             pos_mask[istar] = 1
 * 
 *     cdef np.ndarray[np.float64_t, ndim=2] new_pos = np.zeros(             # <<<<<<<<<<<<<<
 *         (np.sum(pos_mask), 2), dtype=float)
 * 
 */
  __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_1, __pyx_t_5, __pyx_t_2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1510, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  if (!(likely(((__pyx_t_4) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_4, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1510, __pyx_L1_error)
  __pyx_t_21 = ((PyArrayObject *)__pyx_t_4);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_new_pos.rcbuffer->pybuffer, (PyObject*)__pyx_t_21, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
      __pyx_v_new_pos = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_new_pos.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 1510, __pyx_L1_error)
    } else {__pyx_pybuffernd_new_pos.diminfo[0].strides = __pyx_pybuffernd_new_pos.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_new_pos.diminfo[0].shape = __pyx_pybuffernd_new_pos.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_new_pos.diminfo[1].strides = __pyx_pybuffernd_new_pos.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_new_pos.diminfo[1].shape = __pyx_pybuffernd_new_pos.rcbuffer->pybuffer.shape[1];
    }
  }
  __pyx_t_21 = 0;
  __pyx_v_new_pos = ((PyArrayObject *)__pyx_t_4);
  __pyx_t_4 = 0;

  /* "orb/cutils.pyx":1513
 *         (np.sum(pos_mask), 2), dtype=float)
 * 
 *     new_pos = pos[np.nonzero(pos_mask)]             # <<<<<<<<<<<<<<
 * 
 * 
 */
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1513, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_nonzero); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1513, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_5))) {
    __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_5);
    if (likely(__pyx_t_2)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_5);
      __Pyx_INCREF(__pyx_t_2);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_5, function);
    }
  }
  if (!__pyx_t_2) {
    __pyx_t_4 = __Pyx_PyObject_CallOneArg(__pyx_t_5, ((PyObject *)__pyx_v_pos_mask)); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1513, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
  } else {
    __pyx_t_1 = PyTuple_New(1+1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1513, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_1, 0, __pyx_t_2); __pyx_t_2 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_pos_mask));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_pos_mask));
    PyTuple_SET_ITEM(__pyx_t_1, 0+1, ((PyObject *)__pyx_v_pos_mask));
    __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_1, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1513, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  }
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_5 = PyObject_GetItem(((PyObject *)__pyx_v_pos), __pyx_t_4); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1513, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  if (!(likely(((__pyx_t_5) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_5, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1513, __pyx_L1_error)
  __pyx_t_21 = ((PyArrayObject *)__pyx_t_5);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_new_pos.rcbuffer->pybuffer);
    __pyx_t_8 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_new_pos.rcbuffer->pybuffer, (PyObject*)__pyx_t_21, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
    if (unlikely(__pyx_t_8 < 0)) {
      PyErr_Fetch(&__pyx_t_22, &__pyx_t_23, &__pyx_t_24);
      if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_new_pos.rcbuffer->pybuffer, (PyObject*)__pyx_v_new_pos, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_22); Py_XDECREF(__pyx_t_23); Py_XDECREF(__pyx_t_24);
        __Pyx_RaiseBufferFallbackError();
      } else {
        PyErr_Restore(__pyx_t_22, __pyx_t_23, __pyx_t_24);
      }
    }
    __pyx_pybuffernd_new_pos.diminfo[0].strides = __pyx_pybuffernd_new_pos.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_new_pos.diminfo[0].shape = __pyx_pybuffernd_new_pos.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_new_pos.diminfo[1].strides = __pyx_pybuffernd_new_pos.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_new_pos.diminfo[1].shape = __pyx_pybuffernd_new_pos.rcbuffer->pybuffer.shape[1];
    if (unlikely(__pyx_t_8 < 0)) __PYX_ERR(0, 1513, __pyx_L1_error)
  }
  __pyx_t_21 = 0;
  __Pyx_DECREF_SET(__pyx_v_new_pos, ((PyArrayObject *)__pyx_t_5));
  __pyx_t_5 = 0;

  /* "orb/cutils.pyx":1517
 * 
 *     # stop here if no star positions are in the frame
 *     if np.size(new_pos) == 0:             # <<<<<<<<<<<<<<
 *         return []
 * 
 */
  __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1517, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_size); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1517, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_4 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_1))) {
    __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_1);
    if (likely(__pyx_t_4)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_1);
      __Pyx_INCREF(__pyx_t_4);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_1, function);
    }
  }
  if (!__pyx_t_4) {
    __pyx_t_5 = __Pyx_PyObject_CallOneArg(__pyx_t_1, ((PyObject *)__pyx_v_new_pos)); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1517, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
  } else {
    __pyx_t_2 = PyTuple_New(1+1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1517, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_4); __pyx_t_4 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_new_pos));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_new_pos));
    PyTuple_SET_ITEM(__pyx_t_2, 0+1, ((PyObject *)__pyx_v_new_pos));
    __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_1, __pyx_t_2, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1517, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  }
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_1 = __Pyx_PyInt_EqObjC(__pyx_t_5, __pyx_int_0, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1517, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_9 = __Pyx_PyObject_IsTrue(__pyx_t_1); if (unlikely(__pyx_t_9 < 0)) __PYX_ERR(0, 1517, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  if (__pyx_t_9) {

    /* "orb/cutils.pyx":1518
 *     # stop here if no star positions are in the frame
 *     if np.size(new_pos) == 0:
 *         return []             # <<<<<<<<<<<<<<
 * 
 *     cdef int PARAMS_NB = 5
 */
    __Pyx_XDECREF(__pyx_r);
    __pyx_t_1 = PyList_New(0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1518, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __pyx_r = __pyx_t_1;
    __pyx_t_1 = 0;
    goto __pyx_L0;

    /* "orb/cutils.pyx":1517
 * 
 *     # stop here if no star positions are in the frame
 *     if np.size(new_pos) == 0:             # <<<<<<<<<<<<<<
 *         return []
 * 
 */
  }

  /* "orb/cutils.pyx":1520
 *         return []
 * 
 *     cdef int PARAMS_NB = 5             # <<<<<<<<<<<<<<
 *     cdef int star_nb = new_pos.shape[0]
 *     cdef np.ndarray[np.float64_t, ndim=2] stars_p = np.zeros(
 */
  __pyx_v_PARAMS_NB = 5;

  /* "orb/cutils.pyx":1521
 * 
 *     cdef int PARAMS_NB = 5
 *     cdef int star_nb = new_pos.shape[0]             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.float64_t, ndim=2] stars_p = np.zeros(
 *         (star_nb, PARAMS_NB), dtype=float) # [STARS_NB * (H,A,DX,DY,FWHM)]
 */
  __pyx_v_star_nb = (__pyx_v_new_pos->dimensions[0]);

  /* "orb/cutils.pyx":1522
 *     cdef int PARAMS_NB = 5
 *     cdef int star_nb = new_pos.shape[0]
 *     cdef np.ndarray[np.float64_t, ndim=2] stars_p = np.zeros(             # <<<<<<<<<<<<<<
 *         (star_nb, PARAMS_NB), dtype=float) # [STARS_NB * (H,A,DX,DY,FWHM)]
 * 
 */
  __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1522, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_zeros); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1522, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1523
 *     cdef int star_nb = new_pos.shape[0]
 *     cdef np.ndarray[np.float64_t, ndim=2] stars_p = np.zeros(
 *         (star_nb, PARAMS_NB), dtype=float) # [STARS_NB * (H,A,DX,DY,FWHM)]             # <<<<<<<<<<<<<<
 * 
 *     cdef np.ndarray[np.float64_t, ndim=1] fwhm_pix = np.zeros(
 */
  __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_star_nb); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1523, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_2 = __Pyx_PyInt_From_int(__pyx_v_PARAMS_NB); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1523, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_4 = PyTuple_New(2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1523, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_GIVEREF(__pyx_t_1);
  PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_1);
  __Pyx_GIVEREF(__pyx_t_2);
  PyTuple_SET_ITEM(__pyx_t_4, 1, __pyx_t_2);
  __pyx_t_1 = 0;
  __pyx_t_2 = 0;

  /* "orb/cutils.pyx":1522
 *     cdef int PARAMS_NB = 5
 *     cdef int star_nb = new_pos.shape[0]
 *     cdef np.ndarray[np.float64_t, ndim=2] stars_p = np.zeros(             # <<<<<<<<<<<<<<
 *         (star_nb, PARAMS_NB), dtype=float) # [STARS_NB * (H,A,DX,DY,FWHM)]
 * 
 */
  __pyx_t_2 = PyTuple_New(1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1522, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_GIVEREF(__pyx_t_4);
  PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_4);
  __pyx_t_4 = 0;

  /* "orb/cutils.pyx":1523
 *     cdef int star_nb = new_pos.shape[0]
 *     cdef np.ndarray[np.float64_t, ndim=2] stars_p = np.zeros(
 *         (star_nb, PARAMS_NB), dtype=float) # [STARS_NB * (H,A,DX,DY,FWHM)]             # <<<<<<<<<<<<<<
 * 
 *     cdef np.ndarray[np.float64_t, ndim=1] fwhm_pix = np.zeros(
 */
  __pyx_t_4 = PyDict_New(); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1523, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  if (PyDict_SetItem(__pyx_t_4, __pyx_n_s_dtype, ((PyObject *)(&PyFloat_Type))) < 0) __PYX_ERR(0, 1523, __pyx_L1_error)

  /* "orb/cutils.pyx":1522
 *     cdef int PARAMS_NB = 5
 *     cdef int star_nb = new_pos.shape[0]
 *     cdef np.ndarray[np.float64_t, ndim=2] stars_p = np.zeros(             # <<<<<<<<<<<<<<
 *         (star_nb, PARAMS_NB), dtype=float) # [STARS_NB * (H,A,DX,DY,FWHM)]
 * 
 */
  __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_2, __pyx_t_4); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1522, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1522, __pyx_L1_error)
  __pyx_t_25 = ((PyArrayObject *)__pyx_t_1);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_stars_p.rcbuffer->pybuffer, (PyObject*)__pyx_t_25, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 2, 0, __pyx_stack) == -1)) {
      __pyx_v_stars_p = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_stars_p.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 1522, __pyx_L1_error)
    } else {__pyx_pybuffernd_stars_p.diminfo[0].strides = __pyx_pybuffernd_stars_p.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_stars_p.diminfo[0].shape = __pyx_pybuffernd_stars_p.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_stars_p.diminfo[1].strides = __pyx_pybuffernd_stars_p.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_stars_p.diminfo[1].shape = __pyx_pybuffernd_stars_p.rcbuffer->pybuffer.shape[1];
    }
  }
  __pyx_t_25 = 0;
  __pyx_v_stars_p = ((PyArrayObject *)__pyx_t_1);
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1525
 *         (star_nb, PARAMS_NB), dtype=float) # [STARS_NB * (H,A,DX,DY,FWHM)]
 * 
 *     cdef np.ndarray[np.float64_t, ndim=1] fwhm_pix = np.zeros(             # <<<<<<<<<<<<<<
 *         (star_nb), dtype=float)
 * 
 */
  __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1525, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_zeros); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1525, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1526
 * 
 *     cdef np.ndarray[np.float64_t, ndim=1] fwhm_pix = np.zeros(
 *         (star_nb), dtype=float)             # <<<<<<<<<<<<<<
 * 
 *     cdef np.ndarray[np.float64_t, ndim=2] stars_err = np.zeros_like(
 */
  __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_star_nb); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1526, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);

  /* "orb/cutils.pyx":1525
 *         (star_nb, PARAMS_NB), dtype=float) # [STARS_NB * (H,A,DX,DY,FWHM)]
 * 
 *     cdef np.ndarray[np.float64_t, ndim=1] fwhm_pix = np.zeros(             # <<<<<<<<<<<<<<
 *         (star_nb), dtype=float)
 * 
 */
  __pyx_t_2 = PyTuple_New(1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1525, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_GIVEREF(__pyx_t_1);
  PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_1);
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1526
 * 
 *     cdef np.ndarray[np.float64_t, ndim=1] fwhm_pix = np.zeros(
 *         (star_nb), dtype=float)             # <<<<<<<<<<<<<<
 * 
 *     cdef np.ndarray[np.float64_t, ndim=2] stars_err = np.zeros_like(
 */
  __pyx_t_1 = PyDict_New(); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1526, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if (PyDict_SetItem(__pyx_t_1, __pyx_n_s_dtype, ((PyObject *)(&PyFloat_Type))) < 0) __PYX_ERR(0, 1526, __pyx_L1_error)

  /* "orb/cutils.pyx":1525
 *         (star_nb, PARAMS_NB), dtype=float) # [STARS_NB * (H,A,DX,DY,FWHM)]
 * 
 *     cdef np.ndarray[np.float64_t, ndim=1] fwhm_pix = np.zeros(             # <<<<<<<<<<<<<<
 *         (star_nb), dtype=float)
 * 
 */
  __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_2, __pyx_t_1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1525, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  if (!(likely(((__pyx_t_5) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_5, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1525, __pyx_L1_error)
  __pyx_t_26 = ((PyArrayObject *)__pyx_t_5);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_fwhm_pix.rcbuffer->pybuffer, (PyObject*)__pyx_t_26, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
      __pyx_v_fwhm_pix = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_fwhm_pix.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 1525, __pyx_L1_error)
    } else {__pyx_pybuffernd_fwhm_pix.diminfo[0].strides = __pyx_pybuffernd_fwhm_pix.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_fwhm_pix.diminfo[0].shape = __pyx_pybuffernd_fwhm_pix.rcbuffer->pybuffer.shape[0];
    }
  }
  __pyx_t_26 = 0;
  __pyx_v_fwhm_pix = ((PyArrayObject *)__pyx_t_5);
  __pyx_t_5 = 0;

  /* "orb/cutils.pyx":1528
 *         (star_nb), dtype=float)
 * 
 *     cdef np.ndarray[np.float64_t, ndim=2] stars_err = np.zeros_like(             # <<<<<<<<<<<<<<
 *         stars_p, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=2] new_stars_p = np.zeros(
 */
  __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1528, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_zeros_like); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1528, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

  /* "orb/cutils.pyx":1529
 * 
 *     cdef np.ndarray[np.float64_t, ndim=2] stars_err = np.zeros_like(
 *         stars_p, dtype=float)             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.float64_t, ndim=2] new_stars_p = np.zeros(
 *         (pos.shape[0], stars_p.shape[1]), dtype=float)
 */
  __pyx_t_5 = PyTuple_New(1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1528, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_INCREF(((PyObject *)__pyx_v_stars_p));
  __Pyx_GIVEREF(((PyObject *)__pyx_v_stars_p));
  PyTuple_SET_ITEM(__pyx_t_5, 0, ((PyObject *)__pyx_v_stars_p));
  __pyx_t_2 = PyDict_New(); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1529, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  if (PyDict_SetItem(__pyx_t_2, __pyx_n_s_dtype, ((PyObject *)(&PyFloat_Type))) < 0) __PYX_ERR(0, 1529, __pyx_L1_error)

  /* "orb/cutils.pyx":1528
 *         (star_nb), dtype=float)
 * 
 *     cdef np.ndarray[np.float64_t, ndim=2] stars_err = np.zeros_like(             # <<<<<<<<<<<<<<
 *         stars_p, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=2] new_stars_p = np.zeros(
 */
  __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_1, __pyx_t_5, __pyx_t_2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1528, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  if (!(likely(((__pyx_t_4) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_4, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1528, __pyx_L1_error)
  __pyx_t_27 = ((PyArrayObject *)__pyx_t_4);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_stars_err.rcbuffer->pybuffer, (PyObject*)__pyx_t_27, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 2, 0, __pyx_stack) == -1)) {
      __pyx_v_stars_err = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_stars_err.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 1528, __pyx_L1_error)
    } else {__pyx_pybuffernd_stars_err.diminfo[0].strides = __pyx_pybuffernd_stars_err.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_stars_err.diminfo[0].shape = __pyx_pybuffernd_stars_err.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_stars_err.diminfo[1].strides = __pyx_pybuffernd_stars_err.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_stars_err.diminfo[1].shape = __pyx_pybuffernd_stars_err.rcbuffer->pybuffer.shape[1];
    }
  }
  __pyx_t_27 = 0;
  __pyx_v_stars_err = ((PyArrayObject *)__pyx_t_4);
  __pyx_t_4 = 0;

  /* "orb/cutils.pyx":1530
 *     cdef np.ndarray[np.float64_t, ndim=2] stars_err = np.zeros_like(
 *         stars_p, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=2] new_stars_p = np.zeros(             # <<<<<<<<<<<<<<
 *         (pos.shape[0], stars_p.shape[1]), dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=2] new_stars_err = np.zeros_like(
 */
  __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1530, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_zeros); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1530, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;

  /* "orb/cutils.pyx":1531
 *         stars_p, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=2] new_stars_p = np.zeros(
 *         (pos.shape[0], stars_p.shape[1]), dtype=float)             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.float64_t, ndim=2] new_stars_err = np.zeros_like(
 *         new_stars_p, dtype=float)
 */
  __pyx_t_4 = __Pyx_PyInt_From_Py_intptr_t((__pyx_v_pos->dimensions[0])); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1531, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_5 = __Pyx_PyInt_From_Py_intptr_t((__pyx_v_stars_p->dimensions[1])); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1531, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_1 = PyTuple_New(2); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1531, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_GIVEREF(__pyx_t_4);
  PyTuple_SET_ITEM(__pyx_t_1, 0, __pyx_t_4);
  __Pyx_GIVEREF(__pyx_t_5);
  PyTuple_SET_ITEM(__pyx_t_1, 1, __pyx_t_5);
  __pyx_t_4 = 0;
  __pyx_t_5 = 0;

  /* "orb/cutils.pyx":1530
 *     cdef np.ndarray[np.float64_t, ndim=2] stars_err = np.zeros_like(
 *         stars_p, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=2] new_stars_p = np.zeros(             # <<<<<<<<<<<<<<
 *         (pos.shape[0], stars_p.shape[1]), dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=2] new_stars_err = np.zeros_like(
 */
  __pyx_t_5 = PyTuple_New(1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1530, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_GIVEREF(__pyx_t_1);
  PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_1);
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1531
 *         stars_p, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=2] new_stars_p = np.zeros(
 *         (pos.shape[0], stars_p.shape[1]), dtype=float)             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.float64_t, ndim=2] new_stars_err = np.zeros_like(
 *         new_stars_p, dtype=float)
 */
  __pyx_t_1 = PyDict_New(); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1531, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if (PyDict_SetItem(__pyx_t_1, __pyx_n_s_dtype, ((PyObject *)(&PyFloat_Type))) < 0) __PYX_ERR(0, 1531, __pyx_L1_error)

  /* "orb/cutils.pyx":1530
 *     cdef np.ndarray[np.float64_t, ndim=2] stars_err = np.zeros_like(
 *         stars_p, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=2] new_stars_p = np.zeros(             # <<<<<<<<<<<<<<
 *         (pos.shape[0], stars_p.shape[1]), dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=2] new_stars_err = np.zeros_like(
 */
  __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_5, __pyx_t_1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1530, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  if (!(likely(((__pyx_t_4) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_4, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1530, __pyx_L1_error)
  __pyx_t_28 = ((PyArrayObject *)__pyx_t_4);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_new_stars_p.rcbuffer->pybuffer, (PyObject*)__pyx_t_28, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
      __pyx_v_new_stars_p = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_new_stars_p.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 1530, __pyx_L1_error)
    } else {__pyx_pybuffernd_new_stars_p.diminfo[0].strides = __pyx_pybuffernd_new_stars_p.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_new_stars_p.diminfo[0].shape = __pyx_pybuffernd_new_stars_p.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_new_stars_p.diminfo[1].strides = __pyx_pybuffernd_new_stars_p.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_new_stars_p.diminfo[1].shape = __pyx_pybuffernd_new_stars_p.rcbuffer->pybuffer.shape[1];
    }
  }
  __pyx_t_28 = 0;
  __pyx_v_new_stars_p = ((PyArrayObject *)__pyx_t_4);
  __pyx_t_4 = 0;

  /* "orb/cutils.pyx":1532
 *     cdef np.ndarray[np.float64_t, ndim=2] new_stars_p = np.zeros(
 *         (pos.shape[0], stars_p.shape[1]), dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=2] new_stars_err = np.zeros_like(             # <<<<<<<<<<<<<<
 *         new_stars_p, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=1] stars_p_mask = np.ones(
 */
  __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1532, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_zeros_like); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1532, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;

  /* "orb/cutils.pyx":1533
 *         (pos.shape[0], stars_p.shape[1]), dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=2] new_stars_err = np.zeros_like(
 *         new_stars_p, dtype=float)             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.float64_t, ndim=1] stars_p_mask = np.ones(
 *         PARAMS_NB, dtype=float)
 */
  __pyx_t_4 = PyTuple_New(1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1532, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_INCREF(((PyObject *)__pyx_v_new_stars_p));
  __Pyx_GIVEREF(((PyObject *)__pyx_v_new_stars_p));
  PyTuple_SET_ITEM(__pyx_t_4, 0, ((PyObject *)__pyx_v_new_stars_p));
  __pyx_t_5 = PyDict_New(); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1533, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  if (PyDict_SetItem(__pyx_t_5, __pyx_n_s_dtype, ((PyObject *)(&PyFloat_Type))) < 0) __PYX_ERR(0, 1533, __pyx_L1_error)

  /* "orb/cutils.pyx":1532
 *     cdef np.ndarray[np.float64_t, ndim=2] new_stars_p = np.zeros(
 *         (pos.shape[0], stars_p.shape[1]), dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=2] new_stars_err = np.zeros_like(             # <<<<<<<<<<<<<<
 *         new_stars_p, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=1] stars_p_mask = np.ones(
 */
  __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_1, __pyx_t_4, __pyx_t_5); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1532, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  if (!(likely(((__pyx_t_2) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_2, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1532, __pyx_L1_error)
  __pyx_t_29 = ((PyArrayObject *)__pyx_t_2);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_new_stars_err.rcbuffer->pybuffer, (PyObject*)__pyx_t_29, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
      __pyx_v_new_stars_err = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_new_stars_err.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 1532, __pyx_L1_error)
    } else {__pyx_pybuffernd_new_stars_err.diminfo[0].strides = __pyx_pybuffernd_new_stars_err.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_new_stars_err.diminfo[0].shape = __pyx_pybuffernd_new_stars_err.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_new_stars_err.diminfo[1].strides = __pyx_pybuffernd_new_stars_err.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_new_stars_err.diminfo[1].shape = __pyx_pybuffernd_new_stars_err.rcbuffer->pybuffer.shape[1];
    }
  }
  __pyx_t_29 = 0;
  __pyx_v_new_stars_err = ((PyArrayObject *)__pyx_t_2);
  __pyx_t_2 = 0;

  /* "orb/cutils.pyx":1534
 *     cdef np.ndarray[np.float64_t, ndim=2] new_stars_err = np.zeros_like(
 *         new_stars_p, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=1] stars_p_mask = np.ones(             # <<<<<<<<<<<<<<
 *         PARAMS_NB, dtype=float)
 * 
 */
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1534, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_ones); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1534, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;

  /* "orb/cutils.pyx":1535
 *         new_stars_p, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=1] stars_p_mask = np.ones(
 *         PARAMS_NB, dtype=float)             # <<<<<<<<<<<<<<
 * 
 *     cdef np.ndarray[np.float64_t, ndim=2] test_p = np.zeros_like(
 */
  __pyx_t_2 = __Pyx_PyInt_From_int(__pyx_v_PARAMS_NB); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1535, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);

  /* "orb/cutils.pyx":1534
 *     cdef np.ndarray[np.float64_t, ndim=2] new_stars_err = np.zeros_like(
 *         new_stars_p, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=1] stars_p_mask = np.ones(             # <<<<<<<<<<<<<<
 *         PARAMS_NB, dtype=float)
 * 
 */
  __pyx_t_4 = PyTuple_New(1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1534, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_GIVEREF(__pyx_t_2);
  PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_2);
  __pyx_t_2 = 0;

  /* "orb/cutils.pyx":1535
 *         new_stars_p, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=1] stars_p_mask = np.ones(
 *         PARAMS_NB, dtype=float)             # <<<<<<<<<<<<<<
 * 
 *     cdef np.ndarray[np.float64_t, ndim=2] test_p = np.zeros_like(
 */
  __pyx_t_2 = PyDict_New(); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1535, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  if (PyDict_SetItem(__pyx_t_2, __pyx_n_s_dtype, ((PyObject *)(&PyFloat_Type))) < 0) __PYX_ERR(0, 1535, __pyx_L1_error)

  /* "orb/cutils.pyx":1534
 *     cdef np.ndarray[np.float64_t, ndim=2] new_stars_err = np.zeros_like(
 *         new_stars_p, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=1] stars_p_mask = np.ones(             # <<<<<<<<<<<<<<
 *         PARAMS_NB, dtype=float)
 * 
 */
  __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_4, __pyx_t_2); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1534, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1534, __pyx_L1_error)
  __pyx_t_30 = ((PyArrayObject *)__pyx_t_1);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_stars_p_mask.rcbuffer->pybuffer, (PyObject*)__pyx_t_30, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 1, 0, __pyx_stack) == -1)) {
      __pyx_v_stars_p_mask = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_stars_p_mask.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 1534, __pyx_L1_error)
    } else {__pyx_pybuffernd_stars_p_mask.diminfo[0].strides = __pyx_pybuffernd_stars_p_mask.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_stars_p_mask.diminfo[0].shape = __pyx_pybuffernd_stars_p_mask.rcbuffer->pybuffer.shape[0];
    }
  }
  __pyx_t_30 = 0;
  __pyx_v_stars_p_mask = ((PyArrayObject *)__pyx_t_1);
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1537
 *         PARAMS_NB, dtype=float)
 * 
 *     cdef np.ndarray[np.float64_t, ndim=2] test_p = np.zeros_like(             # <<<<<<<<<<<<<<
 *         stars_p, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=1] cov_p = np.zeros(
 */
  __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1537, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_zeros_like); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1537, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1538
 * 
 *     cdef np.ndarray[np.float64_t, ndim=2] test_p = np.zeros_like(
 *         stars_p, dtype=float)             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.float64_t, ndim=1] cov_p = np.zeros(
 *         7, dtype=float) # COV_P: HEIGHT, POSX, POSY, FWHM, ZOOMX, ZOOMY, ROT
 */
  __pyx_t_1 = PyTuple_New(1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1537, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_INCREF(((PyObject *)__pyx_v_stars_p));
  __Pyx_GIVEREF(((PyObject *)__pyx_v_stars_p));
  PyTuple_SET_ITEM(__pyx_t_1, 0, ((PyObject *)__pyx_v_stars_p));
  __pyx_t_4 = PyDict_New(); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1538, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  if (PyDict_SetItem(__pyx_t_4, __pyx_n_s_dtype, ((PyObject *)(&PyFloat_Type))) < 0) __PYX_ERR(0, 1538, __pyx_L1_error)

  /* "orb/cutils.pyx":1537
 *         PARAMS_NB, dtype=float)
 * 
 *     cdef np.ndarray[np.float64_t, ndim=2] test_p = np.zeros_like(             # <<<<<<<<<<<<<<
 *         stars_p, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=1] cov_p = np.zeros(
 */
  __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_1, __pyx_t_4); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1537, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  if (!(likely(((__pyx_t_5) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_5, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1537, __pyx_L1_error)
  __pyx_t_31 = ((PyArrayObject *)__pyx_t_5);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_test_p.rcbuffer->pybuffer, (PyObject*)__pyx_t_31, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
      __pyx_v_test_p = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_test_p.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 1537, __pyx_L1_error)
    } else {__pyx_pybuffernd_test_p.diminfo[0].strides = __pyx_pybuffernd_test_p.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_test_p.diminfo[0].shape = __pyx_pybuffernd_test_p.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_test_p.diminfo[1].strides = __pyx_pybuffernd_test_p.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_test_p.diminfo[1].shape = __pyx_pybuffernd_test_p.rcbuffer->pybuffer.shape[1];
    }
  }
  __pyx_t_31 = 0;
  __pyx_v_test_p = ((PyArrayObject *)__pyx_t_5);
  __pyx_t_5 = 0;

  /* "orb/cutils.pyx":1539
 *     cdef np.ndarray[np.float64_t, ndim=2] test_p = np.zeros_like(
 *         stars_p, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=1] cov_p = np.zeros(             # <<<<<<<<<<<<<<
 *         7, dtype=float) # COV_P: HEIGHT, POSX, POSY, FWHM, ZOOMX, ZOOMY, ROT
 *     cdef np.ndarray[np.float64_t, ndim=1] cov_err = np.zeros_like(
 */
  __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1539, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_zeros); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1539, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

  /* "orb/cutils.pyx":1540
 *         stars_p, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=1] cov_p = np.zeros(
 *         7, dtype=float) # COV_P: HEIGHT, POSX, POSY, FWHM, ZOOMX, ZOOMY, ROT             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.float64_t, ndim=1] cov_err = np.zeros_like(
 *         cov_p, dtype=float)
 */
  __pyx_t_5 = PyDict_New(); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1540, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  if (PyDict_SetItem(__pyx_t_5, __pyx_n_s_dtype, ((PyObject *)(&PyFloat_Type))) < 0) __PYX_ERR(0, 1540, __pyx_L1_error)

  /* "orb/cutils.pyx":1539
 *     cdef np.ndarray[np.float64_t, ndim=2] test_p = np.zeros_like(
 *         stars_p, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=1] cov_p = np.zeros(             # <<<<<<<<<<<<<<
 *         7, dtype=float) # COV_P: HEIGHT, POSX, POSY, FWHM, ZOOMX, ZOOMY, ROT
 *     cdef np.ndarray[np.float64_t, ndim=1] cov_err = np.zeros_like(
 */
  __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_tuple__91, __pyx_t_5); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1539, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1539, __pyx_L1_error)
  __pyx_t_32 = ((PyArrayObject *)__pyx_t_1);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_cov_p.rcbuffer->pybuffer, (PyObject*)__pyx_t_32, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 1, 0, __pyx_stack) == -1)) {
      __pyx_v_cov_p = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 1539, __pyx_L1_error)
    } else {__pyx_pybuffernd_cov_p.diminfo[0].strides = __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_cov_p.diminfo[0].shape = __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.shape[0];
    }
  }
  __pyx_t_32 = 0;
  __pyx_v_cov_p = ((PyArrayObject *)__pyx_t_1);
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1541
 *     cdef np.ndarray[np.float64_t, ndim=1] cov_p = np.zeros(
 *         7, dtype=float) # COV_P: HEIGHT, POSX, POSY, FWHM, ZOOMX, ZOOMY, ROT
 *     cdef np.ndarray[np.float64_t, ndim=1] cov_err = np.zeros_like(             # <<<<<<<<<<<<<<
 *         cov_p, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=1] cov_p_mask = np.zeros_like(
 */
  __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1541, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_zeros_like); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1541, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1542
 *         7, dtype=float) # COV_P: HEIGHT, POSX, POSY, FWHM, ZOOMX, ZOOMY, ROT
 *     cdef np.ndarray[np.float64_t, ndim=1] cov_err = np.zeros_like(
 *         cov_p, dtype=float)             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.float64_t, ndim=1] cov_p_mask = np.zeros_like(
 *         cov_p, dtype=float)
 */
  __pyx_t_1 = PyTuple_New(1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1541, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_INCREF(((PyObject *)__pyx_v_cov_p));
  __Pyx_GIVEREF(((PyObject *)__pyx_v_cov_p));
  PyTuple_SET_ITEM(__pyx_t_1, 0, ((PyObject *)__pyx_v_cov_p));
  __pyx_t_4 = PyDict_New(); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1542, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  if (PyDict_SetItem(__pyx_t_4, __pyx_n_s_dtype, ((PyObject *)(&PyFloat_Type))) < 0) __PYX_ERR(0, 1542, __pyx_L1_error)

  /* "orb/cutils.pyx":1541
 *     cdef np.ndarray[np.float64_t, ndim=1] cov_p = np.zeros(
 *         7, dtype=float) # COV_P: HEIGHT, POSX, POSY, FWHM, ZOOMX, ZOOMY, ROT
 *     cdef np.ndarray[np.float64_t, ndim=1] cov_err = np.zeros_like(             # <<<<<<<<<<<<<<
 *         cov_p, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=1] cov_p_mask = np.zeros_like(
 */
  __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_1, __pyx_t_4); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1541, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  if (!(likely(((__pyx_t_2) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_2, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1541, __pyx_L1_error)
  __pyx_t_33 = ((PyArrayObject *)__pyx_t_2);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_cov_err.rcbuffer->pybuffer, (PyObject*)__pyx_t_33, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
      __pyx_v_cov_err = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_cov_err.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 1541, __pyx_L1_error)
    } else {__pyx_pybuffernd_cov_err.diminfo[0].strides = __pyx_pybuffernd_cov_err.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_cov_err.diminfo[0].shape = __pyx_pybuffernd_cov_err.rcbuffer->pybuffer.shape[0];
    }
  }
  __pyx_t_33 = 0;
  __pyx_v_cov_err = ((PyArrayObject *)__pyx_t_2);
  __pyx_t_2 = 0;

  /* "orb/cutils.pyx":1543
 *     cdef np.ndarray[np.float64_t, ndim=1] cov_err = np.zeros_like(
 *         cov_p, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=1] cov_p_mask = np.zeros_like(             # <<<<<<<<<<<<<<
 *         cov_p, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=2] frame_mask = np.zeros_like(
 */
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1543, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_zeros_like); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1543, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;

  /* "orb/cutils.pyx":1544
 *         cov_p, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=1] cov_p_mask = np.zeros_like(
 *         cov_p, dtype=float)             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.float64_t, ndim=2] frame_mask = np.zeros_like(
 *         frame, dtype=float)
 */
  __pyx_t_2 = PyTuple_New(1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1543, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_INCREF(((PyObject *)__pyx_v_cov_p));
  __Pyx_GIVEREF(((PyObject *)__pyx_v_cov_p));
  PyTuple_SET_ITEM(__pyx_t_2, 0, ((PyObject *)__pyx_v_cov_p));
  __pyx_t_1 = PyDict_New(); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1544, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if (PyDict_SetItem(__pyx_t_1, __pyx_n_s_dtype, ((PyObject *)(&PyFloat_Type))) < 0) __PYX_ERR(0, 1544, __pyx_L1_error)

  /* "orb/cutils.pyx":1543
 *     cdef np.ndarray[np.float64_t, ndim=1] cov_err = np.zeros_like(
 *         cov_p, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=1] cov_p_mask = np.zeros_like(             # <<<<<<<<<<<<<<
 *         cov_p, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=2] frame_mask = np.zeros_like(
 */
  __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_2, __pyx_t_1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1543, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  if (!(likely(((__pyx_t_5) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_5, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1543, __pyx_L1_error)
  __pyx_t_34 = ((PyArrayObject *)__pyx_t_5);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_cov_p_mask.rcbuffer->pybuffer, (PyObject*)__pyx_t_34, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 1, 0, __pyx_stack) == -1)) {
      __pyx_v_cov_p_mask = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_cov_p_mask.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 1543, __pyx_L1_error)
    } else {__pyx_pybuffernd_cov_p_mask.diminfo[0].strides = __pyx_pybuffernd_cov_p_mask.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_cov_p_mask.diminfo[0].shape = __pyx_pybuffernd_cov_p_mask.rcbuffer->pybuffer.shape[0];
    }
  }
  __pyx_t_34 = 0;
  __pyx_v_cov_p_mask = ((PyArrayObject *)__pyx_t_5);
  __pyx_t_5 = 0;

  /* "orb/cutils.pyx":1545
 *     cdef np.ndarray[np.float64_t, ndim=1] cov_p_mask = np.zeros_like(
 *         cov_p, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=2] frame_mask = np.zeros_like(             # <<<<<<<<<<<<<<
 *         frame, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=1] amp_guess = np.ones(
 */
  __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1545, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_zeros_like); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1545, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

  /* "orb/cutils.pyx":1546
 *         cov_p, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=2] frame_mask = np.zeros_like(
 *         frame, dtype=float)             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.float64_t, ndim=1] amp_guess = np.ones(
 *         (star_nb), dtype=float)
 */
  __pyx_t_5 = PyTuple_New(1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1545, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_INCREF(((PyObject *)__pyx_v_frame));
  __Pyx_GIVEREF(((PyObject *)__pyx_v_frame));
  PyTuple_SET_ITEM(__pyx_t_5, 0, ((PyObject *)__pyx_v_frame));
  __pyx_t_2 = PyDict_New(); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1546, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  if (PyDict_SetItem(__pyx_t_2, __pyx_n_s_dtype, ((PyObject *)(&PyFloat_Type))) < 0) __PYX_ERR(0, 1546, __pyx_L1_error)

  /* "orb/cutils.pyx":1545
 *     cdef np.ndarray[np.float64_t, ndim=1] cov_p_mask = np.zeros_like(
 *         cov_p, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=2] frame_mask = np.zeros_like(             # <<<<<<<<<<<<<<
 *         frame, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=1] amp_guess = np.ones(
 */
  __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_1, __pyx_t_5, __pyx_t_2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1545, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  if (!(likely(((__pyx_t_4) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_4, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1545, __pyx_L1_error)
  __pyx_t_35 = ((PyArrayObject *)__pyx_t_4);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_frame_mask.rcbuffer->pybuffer, (PyObject*)__pyx_t_35, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
      __pyx_v_frame_mask = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_frame_mask.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 1545, __pyx_L1_error)
    } else {__pyx_pybuffernd_frame_mask.diminfo[0].strides = __pyx_pybuffernd_frame_mask.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_frame_mask.diminfo[0].shape = __pyx_pybuffernd_frame_mask.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_frame_mask.diminfo[1].strides = __pyx_pybuffernd_frame_mask.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_frame_mask.diminfo[1].shape = __pyx_pybuffernd_frame_mask.rcbuffer->pybuffer.shape[1];
    }
  }
  __pyx_t_35 = 0;
  __pyx_v_frame_mask = ((PyArrayObject *)__pyx_t_4);
  __pyx_t_4 = 0;

  /* "orb/cutils.pyx":1547
 *     cdef np.ndarray[np.float64_t, ndim=2] frame_mask = np.zeros_like(
 *         frame, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=1] amp_guess = np.ones(             # <<<<<<<<<<<<<<
 *         (star_nb), dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=1] free_p
 */
  __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1547, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_ones); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1547, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;

  /* "orb/cutils.pyx":1548
 *         frame, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=1] amp_guess = np.ones(
 *         (star_nb), dtype=float)             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.float64_t, ndim=1] free_p
 *     cdef np.ndarray[np.float64_t, ndim=1] fixed_p
 */
  __pyx_t_4 = __Pyx_PyInt_From_int(__pyx_v_star_nb); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1548, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);

  /* "orb/cutils.pyx":1547
 *     cdef np.ndarray[np.float64_t, ndim=2] frame_mask = np.zeros_like(
 *         frame, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=1] amp_guess = np.ones(             # <<<<<<<<<<<<<<
 *         (star_nb), dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=1] free_p
 */
  __pyx_t_5 = PyTuple_New(1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1547, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_GIVEREF(__pyx_t_4);
  PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_4);
  __pyx_t_4 = 0;

  /* "orb/cutils.pyx":1548
 *         frame, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=1] amp_guess = np.ones(
 *         (star_nb), dtype=float)             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.float64_t, ndim=1] free_p
 *     cdef np.ndarray[np.float64_t, ndim=1] fixed_p
 */
  __pyx_t_4 = PyDict_New(); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1548, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  if (PyDict_SetItem(__pyx_t_4, __pyx_n_s_dtype, ((PyObject *)(&PyFloat_Type))) < 0) __PYX_ERR(0, 1548, __pyx_L1_error)

  /* "orb/cutils.pyx":1547
 *     cdef np.ndarray[np.float64_t, ndim=2] frame_mask = np.zeros_like(
 *         frame, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=1] amp_guess = np.ones(             # <<<<<<<<<<<<<<
 *         (star_nb), dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=1] free_p
 */
  __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_5, __pyx_t_4); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1547, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1547, __pyx_L1_error)
  __pyx_t_36 = ((PyArrayObject *)__pyx_t_1);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_amp_guess.rcbuffer->pybuffer, (PyObject*)__pyx_t_36, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 1, 0, __pyx_stack) == -1)) {
      __pyx_v_amp_guess = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_amp_guess.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 1547, __pyx_L1_error)
    } else {__pyx_pybuffernd_amp_guess.diminfo[0].strides = __pyx_pybuffernd_amp_guess.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_amp_guess.diminfo[0].shape = __pyx_pybuffernd_amp_guess.rcbuffer->pybuffer.shape[0];
    }
  }
  __pyx_t_36 = 0;
  __pyx_v_amp_guess = ((PyArrayObject *)__pyx_t_1);
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1551
 *     cdef np.ndarray[np.float64_t, ndim=1] free_p
 *     cdef np.ndarray[np.float64_t, ndim=1] fixed_p
 *     cdef np.ndarray[np.float64_t, ndim=1] test_x = np.zeros(             # <<<<<<<<<<<<<<
 *         box_size, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=1] test_y = np.zeros(
 */
  __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1551, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_zeros); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1551, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1552
 *     cdef np.ndarray[np.float64_t, ndim=1] fixed_p
 *     cdef np.ndarray[np.float64_t, ndim=1] test_x = np.zeros(
 *         box_size, dtype=float)             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.float64_t, ndim=1] test_y = np.zeros(
 *         box_size, dtype=float)
 */
  __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_box_size); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1552, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);

  /* "orb/cutils.pyx":1551
 *     cdef np.ndarray[np.float64_t, ndim=1] free_p
 *     cdef np.ndarray[np.float64_t, ndim=1] fixed_p
 *     cdef np.ndarray[np.float64_t, ndim=1] test_x = np.zeros(             # <<<<<<<<<<<<<<
 *         box_size, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=1] test_y = np.zeros(
 */
  __pyx_t_5 = PyTuple_New(1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1551, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_GIVEREF(__pyx_t_1);
  PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_1);
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1552
 *     cdef np.ndarray[np.float64_t, ndim=1] fixed_p
 *     cdef np.ndarray[np.float64_t, ndim=1] test_x = np.zeros(
 *         box_size, dtype=float)             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.float64_t, ndim=1] test_y = np.zeros(
 *         box_size, dtype=float)
 */
  __pyx_t_1 = PyDict_New(); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1552, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if (PyDict_SetItem(__pyx_t_1, __pyx_n_s_dtype, ((PyObject *)(&PyFloat_Type))) < 0) __PYX_ERR(0, 1552, __pyx_L1_error)

  /* "orb/cutils.pyx":1551
 *     cdef np.ndarray[np.float64_t, ndim=1] free_p
 *     cdef np.ndarray[np.float64_t, ndim=1] fixed_p
 *     cdef np.ndarray[np.float64_t, ndim=1] test_x = np.zeros(             # <<<<<<<<<<<<<<
 *         box_size, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=1] test_y = np.zeros(
 */
  __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_5, __pyx_t_1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1551, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  if (!(likely(((__pyx_t_2) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_2, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1551, __pyx_L1_error)
  __pyx_t_37 = ((PyArrayObject *)__pyx_t_2);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_test_x.rcbuffer->pybuffer, (PyObject*)__pyx_t_37, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
      __pyx_v_test_x = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_test_x.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 1551, __pyx_L1_error)
    } else {__pyx_pybuffernd_test_x.diminfo[0].strides = __pyx_pybuffernd_test_x.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_test_x.diminfo[0].shape = __pyx_pybuffernd_test_x.rcbuffer->pybuffer.shape[0];
    }
  }
  __pyx_t_37 = 0;
  __pyx_v_test_x = ((PyArrayObject *)__pyx_t_2);
  __pyx_t_2 = 0;

  /* "orb/cutils.pyx":1553
 *     cdef np.ndarray[np.float64_t, ndim=1] test_x = np.zeros(
 *         box_size, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=1] test_y = np.zeros(             # <<<<<<<<<<<<<<
 *         box_size, dtype=float)
 *     cdef int x_min, x_max, y_min, y_max
 */
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1553, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_zeros); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1553, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;

  /* "orb/cutils.pyx":1554
 *         box_size, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=1] test_y = np.zeros(
 *         box_size, dtype=float)             # <<<<<<<<<<<<<<
 *     cdef int x_min, x_max, y_min, y_max
 *     cdef double rcx, rcy
 */
  __pyx_t_2 = __Pyx_PyInt_From_int(__pyx_v_box_size); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1554, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);

  /* "orb/cutils.pyx":1553
 *     cdef np.ndarray[np.float64_t, ndim=1] test_x = np.zeros(
 *         box_size, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=1] test_y = np.zeros(             # <<<<<<<<<<<<<<
 *         box_size, dtype=float)
 *     cdef int x_min, x_max, y_min, y_max
 */
  __pyx_t_5 = PyTuple_New(1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1553, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_GIVEREF(__pyx_t_2);
  PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_2);
  __pyx_t_2 = 0;

  /* "orb/cutils.pyx":1554
 *         box_size, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=1] test_y = np.zeros(
 *         box_size, dtype=float)             # <<<<<<<<<<<<<<
 *     cdef int x_min, x_max, y_min, y_max
 *     cdef double rcx, rcy
 */
  __pyx_t_2 = PyDict_New(); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1554, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  if (PyDict_SetItem(__pyx_t_2, __pyx_n_s_dtype, ((PyObject *)(&PyFloat_Type))) < 0) __PYX_ERR(0, 1554, __pyx_L1_error)

  /* "orb/cutils.pyx":1553
 *     cdef np.ndarray[np.float64_t, ndim=1] test_x = np.zeros(
 *         box_size, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=1] test_y = np.zeros(             # <<<<<<<<<<<<<<
 *         box_size, dtype=float)
 *     cdef int x_min, x_max, y_min, y_max
 */
  __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_1, __pyx_t_5, __pyx_t_2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1553, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  if (!(likely(((__pyx_t_4) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_4, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1553, __pyx_L1_error)
  __pyx_t_38 = ((PyArrayObject *)__pyx_t_4);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_test_y.rcbuffer->pybuffer, (PyObject*)__pyx_t_38, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
      __pyx_v_test_y = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_test_y.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 1553, __pyx_L1_error)
    } else {__pyx_pybuffernd_test_y.diminfo[0].strides = __pyx_pybuffernd_test_y.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_test_y.diminfo[0].shape = __pyx_pybuffernd_test_y.rcbuffer->pybuffer.shape[0];
    }
  }
  __pyx_t_38 = 0;
  __pyx_v_test_y = ((PyArrayObject *)__pyx_t_4);
  __pyx_t_4 = 0;

  /* "orb/cutils.pyx":1557
 *     cdef int x_min, x_max, y_min, y_max
 *     cdef double rcx, rcy
 *     cdef np.ndarray[np.float64_t, ndim=1] noise_guess = np.zeros(             # <<<<<<<<<<<<<<
 *         (star_nb), dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=2] cov_matrix, box
 */
  __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1557, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_zeros); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1557, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;

  /* "orb/cutils.pyx":1558
 *     cdef double rcx, rcy
 *     cdef np.ndarray[np.float64_t, ndim=1] noise_guess = np.zeros(
 *         (star_nb), dtype=float)             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.float64_t, ndim=2] cov_matrix, box
 *     cdef double dx_guess, dy_guess, dx_guess_arg, dy_guess_arg
 */
  __pyx_t_4 = __Pyx_PyInt_From_int(__pyx_v_star_nb); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1558, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);

  /* "orb/cutils.pyx":1557
 *     cdef int x_min, x_max, y_min, y_max
 *     cdef double rcx, rcy
 *     cdef np.ndarray[np.float64_t, ndim=1] noise_guess = np.zeros(             # <<<<<<<<<<<<<<
 *         (star_nb), dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=2] cov_matrix, box
 */
  __pyx_t_5 = PyTuple_New(1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1557, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_GIVEREF(__pyx_t_4);
  PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_4);
  __pyx_t_4 = 0;

  /* "orb/cutils.pyx":1558
 *     cdef double rcx, rcy
 *     cdef np.ndarray[np.float64_t, ndim=1] noise_guess = np.zeros(
 *         (star_nb), dtype=float)             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.float64_t, ndim=2] cov_matrix, box
 *     cdef double dx_guess, dy_guess, dx_guess_arg, dy_guess_arg
 */
  __pyx_t_4 = PyDict_New(); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1558, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  if (PyDict_SetItem(__pyx_t_4, __pyx_n_s_dtype, ((PyObject *)(&PyFloat_Type))) < 0) __PYX_ERR(0, 1558, __pyx_L1_error)

  /* "orb/cutils.pyx":1557
 *     cdef int x_min, x_max, y_min, y_max
 *     cdef double rcx, rcy
 *     cdef np.ndarray[np.float64_t, ndim=1] noise_guess = np.zeros(             # <<<<<<<<<<<<<<
 *         (star_nb), dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=2] cov_matrix, box
 */
  __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_5, __pyx_t_4); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1557, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1557, __pyx_L1_error)
  __pyx_t_39 = ((PyArrayObject *)__pyx_t_1);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_noise_guess.rcbuffer->pybuffer, (PyObject*)__pyx_t_39, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 1, 0, __pyx_stack) == -1)) {
      __pyx_v_noise_guess = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_noise_guess.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 1557, __pyx_L1_error)
    } else {__pyx_pybuffernd_noise_guess.diminfo[0].strides = __pyx_pybuffernd_noise_guess.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_noise_guess.diminfo[0].shape = __pyx_pybuffernd_noise_guess.rcbuffer->pybuffer.shape[0];
    }
  }
  __pyx_t_39 = 0;
  __pyx_v_noise_guess = ((PyArrayObject *)__pyx_t_1);
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1561
 *     cdef np.ndarray[np.float64_t, ndim=2] cov_matrix, box
 *     cdef double dx_guess, dy_guess, dx_guess_arg, dy_guess_arg
 *     cdef added_height = 0.             # <<<<<<<<<<<<<<
 *     cdef frame_min = 0.
 * 
 */
  __Pyx_INCREF(__pyx_float_0_);
  __pyx_v_added_height = __pyx_float_0_;

  /* "orb/cutils.pyx":1562
 *     cdef double dx_guess, dy_guess, dx_guess_arg, dy_guess_arg
 *     cdef added_height = 0.
 *     cdef frame_min = 0.             # <<<<<<<<<<<<<<
 * 
 *     cdef double FWHM_SKY_COEFF = 1.5
 */
  __Pyx_INCREF(__pyx_float_0_);
  __pyx_v_frame_min = __pyx_float_0_;

  /* "orb/cutils.pyx":1564
 *     cdef frame_min = 0.
 * 
 *     cdef double FWHM_SKY_COEFF = 1.5             # <<<<<<<<<<<<<<
 *     cdef int SUB_DIV = 10
 * 
 */
  __pyx_v_FWHM_SKY_COEFF = 1.5;

  /* "orb/cutils.pyx":1565
 * 
 *     cdef double FWHM_SKY_COEFF = 1.5
 *     cdef int SUB_DIV = 10             # <<<<<<<<<<<<<<
 * 
 *     # no fit on pure NaN frame
 */
  __pyx_v_SUB_DIV = 10;

  /* "orb/cutils.pyx":1568
 * 
 *     # no fit on pure NaN frame
 *     if np.all(np.isnan(frame)):             # <<<<<<<<<<<<<<
 *         return []
 * 
 */
  __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1568, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_all); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1568, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1568, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_isnan); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1568, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_3))) {
    __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_3);
    if (likely(__pyx_t_2)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
      __Pyx_INCREF(__pyx_t_2);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_3, function);
    }
  }
  if (!__pyx_t_2) {
    __pyx_t_4 = __Pyx_PyObject_CallOneArg(__pyx_t_3, ((PyObject *)__pyx_v_frame)); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1568, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
  } else {
    __pyx_t_40 = PyTuple_New(1+1); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1568, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_40);
    __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_40, 0, __pyx_t_2); __pyx_t_2 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_frame));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_frame));
    PyTuple_SET_ITEM(__pyx_t_40, 0+1, ((PyObject *)__pyx_v_frame));
    __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_40, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1568, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;
  }
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_3 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_5))) {
    __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_5);
    if (likely(__pyx_t_3)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_5);
      __Pyx_INCREF(__pyx_t_3);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_5, function);
    }
  }
  if (!__pyx_t_3) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_5, __pyx_t_4); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1568, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_40 = PyTuple_New(1+1); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1568, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_40);
    __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_40, 0, __pyx_t_3); __pyx_t_3 = NULL;
    __Pyx_GIVEREF(__pyx_t_4);
    PyTuple_SET_ITEM(__pyx_t_40, 0+1, __pyx_t_4);
    __pyx_t_4 = 0;
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_40, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1568, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;
  }
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_9 = __Pyx_PyObject_IsTrue(__pyx_t_1); if (unlikely(__pyx_t_9 < 0)) __PYX_ERR(0, 1568, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  if (__pyx_t_9) {

    /* "orb/cutils.pyx":1569
 *     # no fit on pure NaN frame
 *     if np.all(np.isnan(frame)):
 *         return []             # <<<<<<<<<<<<<<
 * 
 *     # avoid negative values by adding a height level to the frame
 */
    __Pyx_XDECREF(__pyx_r);
    __pyx_t_1 = PyList_New(0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1569, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __pyx_r = __pyx_t_1;
    __pyx_t_1 = 0;
    goto __pyx_L0;

    /* "orb/cutils.pyx":1568
 * 
 *     # no fit on pure NaN frame
 *     if np.all(np.isnan(frame)):             # <<<<<<<<<<<<<<
 *         return []
 * 
 */
  }

  /* "orb/cutils.pyx":1572
 * 
 *     # avoid negative values by adding a height level to the frame
 *     frame_min = np.nanmin(frame)             # <<<<<<<<<<<<<<
 *     if frame_min < 0.:
 *         added_height = -frame_min
 */
  __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1572, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_40 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_nanmin); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1572, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_40);
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_5 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_40))) {
    __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_40);
    if (likely(__pyx_t_5)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_40);
      __Pyx_INCREF(__pyx_t_5);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_40, function);
    }
  }
  if (!__pyx_t_5) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_40, ((PyObject *)__pyx_v_frame)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1572, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_4 = PyTuple_New(1+1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1572, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_5); __pyx_t_5 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_frame));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_frame));
    PyTuple_SET_ITEM(__pyx_t_4, 0+1, ((PyObject *)__pyx_v_frame));
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_40, __pyx_t_4, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1572, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  }
  __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;
  __Pyx_DECREF_SET(__pyx_v_frame_min, __pyx_t_1);
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1573
 *     # avoid negative values by adding a height level to the frame
 *     frame_min = np.nanmin(frame)
 *     if frame_min < 0.:             # <<<<<<<<<<<<<<
 *         added_height = -frame_min
 *         frame += added_height
 */
  __pyx_t_1 = PyObject_RichCompare(__pyx_v_frame_min, __pyx_float_0_, Py_LT); __Pyx_XGOTREF(__pyx_t_1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1573, __pyx_L1_error)
  __pyx_t_9 = __Pyx_PyObject_IsTrue(__pyx_t_1); if (unlikely(__pyx_t_9 < 0)) __PYX_ERR(0, 1573, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  if (__pyx_t_9) {

    /* "orb/cutils.pyx":1574
 *     frame_min = np.nanmin(frame)
 *     if frame_min < 0.:
 *         added_height = -frame_min             # <<<<<<<<<<<<<<
 *         frame += added_height
 * 
 */
    __pyx_t_1 = PyNumber_Negative(__pyx_v_frame_min); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1574, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF_SET(__pyx_v_added_height, __pyx_t_1);
    __pyx_t_1 = 0;

    /* "orb/cutils.pyx":1575
 *     if frame_min < 0.:
 *         added_height = -frame_min
 *         frame += added_height             # <<<<<<<<<<<<<<
 * 
 *     # box size must be odd
 */
    __pyx_t_1 = PyNumber_InPlaceAdd(((PyObject *)__pyx_v_frame), __pyx_v_added_height); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1575, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1575, __pyx_L1_error)
    __pyx_t_41 = ((PyArrayObject *)__pyx_t_1);
    {
      __Pyx_BufFmt_StackElem __pyx_stack[1];
      __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_frame.rcbuffer->pybuffer);
      __pyx_t_8 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_frame.rcbuffer->pybuffer, (PyObject*)__pyx_t_41, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
      if (unlikely(__pyx_t_8 < 0)) {
        PyErr_Fetch(&__pyx_t_24, &__pyx_t_23, &__pyx_t_22);
        if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_frame.rcbuffer->pybuffer, (PyObject*)__pyx_v_frame, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
          Py_XDECREF(__pyx_t_24); Py_XDECREF(__pyx_t_23); Py_XDECREF(__pyx_t_22);
          __Pyx_RaiseBufferFallbackError();
        } else {
          PyErr_Restore(__pyx_t_24, __pyx_t_23, __pyx_t_22);
        }
      }
      __pyx_pybuffernd_frame.diminfo[0].strides = __pyx_pybuffernd_frame.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_frame.diminfo[0].shape = __pyx_pybuffernd_frame.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_frame.diminfo[1].strides = __pyx_pybuffernd_frame.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_frame.diminfo[1].shape = __pyx_pybuffernd_frame.rcbuffer->pybuffer.shape[1];
      if (unlikely(__pyx_t_8 < 0)) __PYX_ERR(0, 1575, __pyx_L1_error)
    }
    __pyx_t_41 = 0;
    __Pyx_DECREF_SET(__pyx_v_frame, ((PyArrayObject *)__pyx_t_1));
    __pyx_t_1 = 0;

    /* "orb/cutils.pyx":1573
 *     # avoid negative values by adding a height level to the frame
 *     frame_min = np.nanmin(frame)
 *     if frame_min < 0.:             # <<<<<<<<<<<<<<
 *         added_height = -frame_min
 *         frame += added_height
 */
  }

  /* "orb/cutils.pyx":1578
 * 
 *     # box size must be odd
 *     if box_size % 2 == 0: box_size += 1             # <<<<<<<<<<<<<<
 * 
 *     # fwhm guess
 */
  __pyx_t_9 = ((__Pyx_mod_long(__pyx_v_box_size, 2) == 0) != 0);
  if (__pyx_t_9) {
    __pyx_v_box_size = (__pyx_v_box_size + 1);
  }

  /* "orb/cutils.pyx":1581
 * 
 *     # fwhm guess
 *     if np.any(np.isnan(fwhm_guess)):             # <<<<<<<<<<<<<<
 *         fwhm_guess[np.isnan(fwhm_guess)] = <double> box_size / 3.
 * 
 */
  __pyx_t_40 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1581, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_40);
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_40, __pyx_n_s_any); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1581, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;
  __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1581, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_isnan); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1581, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_5 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_3))) {
    __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_3);
    if (likely(__pyx_t_5)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
      __Pyx_INCREF(__pyx_t_5);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_3, function);
    }
  }
  if (!__pyx_t_5) {
    __pyx_t_40 = __Pyx_PyObject_CallOneArg(__pyx_t_3, ((PyObject *)__pyx_v_fwhm_guess)); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1581, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_40);
  } else {
    __pyx_t_2 = PyTuple_New(1+1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1581, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_5); __pyx_t_5 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_fwhm_guess));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_fwhm_guess));
    PyTuple_SET_ITEM(__pyx_t_2, 0+1, ((PyObject *)__pyx_v_fwhm_guess));
    __pyx_t_40 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_2, NULL); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1581, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_40);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  }
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_3 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_4))) {
    __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_4);
    if (likely(__pyx_t_3)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
      __Pyx_INCREF(__pyx_t_3);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_4, function);
    }
  }
  if (!__pyx_t_3) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_40); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1581, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_2 = PyTuple_New(1+1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1581, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_3); __pyx_t_3 = NULL;
    __Pyx_GIVEREF(__pyx_t_40);
    PyTuple_SET_ITEM(__pyx_t_2, 0+1, __pyx_t_40);
    __pyx_t_40 = 0;
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_2, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1581, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  }
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_9 = __Pyx_PyObject_IsTrue(__pyx_t_1); if (unlikely(__pyx_t_9 < 0)) __PYX_ERR(0, 1581, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  if (__pyx_t_9) {

    /* "orb/cutils.pyx":1582
 *     # fwhm guess
 *     if np.any(np.isnan(fwhm_guess)):
 *         fwhm_guess[np.isnan(fwhm_guess)] = <double> box_size / 3.             # <<<<<<<<<<<<<<
 * 
 *     # initial parameters
 */
    __pyx_t_1 = PyFloat_FromDouble((((double)__pyx_v_box_size) / 3.)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1582, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1582, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __pyx_t_40 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_isnan); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1582, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_40);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __pyx_t_2 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_40))) {
      __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_40);
      if (likely(__pyx_t_2)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_40);
        __Pyx_INCREF(__pyx_t_2);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_40, function);
      }
    }
    if (!__pyx_t_2) {
      __pyx_t_4 = __Pyx_PyObject_CallOneArg(__pyx_t_40, ((PyObject *)__pyx_v_fwhm_guess)); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1582, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
    } else {
      __pyx_t_3 = PyTuple_New(1+1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1582, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_2); __pyx_t_2 = NULL;
      __Pyx_INCREF(((PyObject *)__pyx_v_fwhm_guess));
      __Pyx_GIVEREF(((PyObject *)__pyx_v_fwhm_guess));
      PyTuple_SET_ITEM(__pyx_t_3, 0+1, ((PyObject *)__pyx_v_fwhm_guess));
      __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_40, __pyx_t_3, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1582, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    }
    __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;
    if (unlikely(PyObject_SetItem(((PyObject *)__pyx_v_fwhm_guess), __pyx_t_4, __pyx_t_1) < 0)) __PYX_ERR(0, 1582, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

    /* "orb/cutils.pyx":1581
 * 
 *     # fwhm guess
 *     if np.any(np.isnan(fwhm_guess)):             # <<<<<<<<<<<<<<
 *         fwhm_guess[np.isnan(fwhm_guess)] = <double> box_size / 3.
 * 
 */
  }

  /* "orb/cutils.pyx":1585
 * 
 *     # initial parameters
 *     stars_p[:,4] = fwhm_guess             # <<<<<<<<<<<<<<
 *     stars_p[:,2:4] = new_pos
 * 
 */
  if (unlikely(PyObject_SetItem(((PyObject *)__pyx_v_stars_p), __pyx_tuple__93, ((PyObject *)__pyx_v_fwhm_guess)) < 0)) __PYX_ERR(0, 1585, __pyx_L1_error)

  /* "orb/cutils.pyx":1586
 *     # initial parameters
 *     stars_p[:,4] = fwhm_guess
 *     stars_p[:,2:4] = new_pos             # <<<<<<<<<<<<<<
 * 
 *     # precise determination of the initial shift from the marginal
 */
  if (unlikely(PyObject_SetItem(((PyObject *)__pyx_v_stars_p), __pyx_tuple__96, ((PyObject *)__pyx_v_new_pos)) < 0)) __PYX_ERR(0, 1586, __pyx_L1_error)

  /* "orb/cutils.pyx":1590
 *     # precise determination of the initial shift from the marginal
 *     # distribution of the psf [e.g. Howell 2006]
 *     test_p = np.copy(stars_p)             # <<<<<<<<<<<<<<
 *     test_p[:,1] = 0.
 *     test_x = np.abs(bn.nansum(model_diff(frame.shape[0], frame.shape[1],
 */
  __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1590, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_40 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_copy); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1590, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_40);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_4 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_40))) {
    __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_40);
    if (likely(__pyx_t_4)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_40);
      __Pyx_INCREF(__pyx_t_4);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_40, function);
    }
  }
  if (!__pyx_t_4) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_40, ((PyObject *)__pyx_v_stars_p)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1590, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_3 = PyTuple_New(1+1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1590, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_4); __pyx_t_4 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_stars_p));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_stars_p));
    PyTuple_SET_ITEM(__pyx_t_3, 0+1, ((PyObject *)__pyx_v_stars_p));
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_40, __pyx_t_3, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1590, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  }
  __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;
  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1590, __pyx_L1_error)
  __pyx_t_31 = ((PyArrayObject *)__pyx_t_1);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_test_p.rcbuffer->pybuffer);
    __pyx_t_8 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_test_p.rcbuffer->pybuffer, (PyObject*)__pyx_t_31, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
    if (unlikely(__pyx_t_8 < 0)) {
      PyErr_Fetch(&__pyx_t_22, &__pyx_t_23, &__pyx_t_24);
      if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_test_p.rcbuffer->pybuffer, (PyObject*)__pyx_v_test_p, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_22); Py_XDECREF(__pyx_t_23); Py_XDECREF(__pyx_t_24);
        __Pyx_RaiseBufferFallbackError();
      } else {
        PyErr_Restore(__pyx_t_22, __pyx_t_23, __pyx_t_24);
      }
    }
    __pyx_pybuffernd_test_p.diminfo[0].strides = __pyx_pybuffernd_test_p.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_test_p.diminfo[0].shape = __pyx_pybuffernd_test_p.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_test_p.diminfo[1].strides = __pyx_pybuffernd_test_p.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_test_p.diminfo[1].shape = __pyx_pybuffernd_test_p.rcbuffer->pybuffer.shape[1];
    if (unlikely(__pyx_t_8 < 0)) __PYX_ERR(0, 1590, __pyx_L1_error)
  }
  __pyx_t_31 = 0;
  __Pyx_DECREF_SET(__pyx_v_test_p, ((PyArrayObject *)__pyx_t_1));
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1591
 *     # distribution of the psf [e.g. Howell 2006]
 *     test_p = np.copy(stars_p)
 *     test_p[:,1] = 0.             # <<<<<<<<<<<<<<
 *     test_x = np.abs(bn.nansum(model_diff(frame.shape[0], frame.shape[1],
 *                                          test_p, box_size, frame,
 */
  if (unlikely(PyObject_SetItem(((PyObject *)__pyx_v_test_p), __pyx_tuple__98, __pyx_float_0_) < 0)) __PYX_ERR(0, 1591, __pyx_L1_error)

  /* "orb/cutils.pyx":1592
 *     test_p = np.copy(stars_p)
 *     test_p[:,1] = 0.
 *     test_x = np.abs(bn.nansum(model_diff(frame.shape[0], frame.shape[1],             # <<<<<<<<<<<<<<
 *                                          test_p, box_size, frame,
 *                                          noise_guess * 0.,
 */
  __pyx_t_40 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1592, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_40);
  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_40, __pyx_n_s_abs); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1592, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;
  __pyx_t_40 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1592, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_40);
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_40, __pyx_n_s_nansum); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1592, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;
  __pyx_t_40 = __Pyx_PyInt_From_Py_intptr_t((__pyx_v_frame->dimensions[0])); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1592, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_40);
  __pyx_t_2 = __Pyx_PyInt_From_Py_intptr_t((__pyx_v_frame->dimensions[1])); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1592, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);

  /* "orb/cutils.pyx":1593
 *     test_p[:,1] = 0.
 *     test_x = np.abs(bn.nansum(model_diff(frame.shape[0], frame.shape[1],
 *                                          test_p, box_size, frame,             # <<<<<<<<<<<<<<
 *                                          noise_guess * 0.,
 *                                          0., saturation, transpose=True,
 */
  __pyx_t_5 = __Pyx_PyInt_From_int(__pyx_v_box_size); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1593, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);

  /* "orb/cutils.pyx":1594
 *     test_x = np.abs(bn.nansum(model_diff(frame.shape[0], frame.shape[1],
 *                                          test_p, box_size, frame,
 *                                          noise_guess * 0.,             # <<<<<<<<<<<<<<
 *                                          0., saturation, transpose=True,
 *                                          normalize=True), axis=1))
 */
  __pyx_t_42 = PyNumber_Multiply(((PyObject *)__pyx_v_noise_guess), __pyx_float_0_); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1594, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_42);

  /* "orb/cutils.pyx":1595
 *                                          test_p, box_size, frame,
 *                                          noise_guess * 0.,
 *                                          0., saturation, transpose=True,             # <<<<<<<<<<<<<<
 *                                          normalize=True), axis=1))
 *     test_y = np.abs(bn.nansum(model_diff(frame.shape[0], frame.shape[1],
 */
  __pyx_t_43 = PyFloat_FromDouble(__pyx_v_saturation); if (unlikely(!__pyx_t_43)) __PYX_ERR(0, 1595, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_43);

  /* "orb/cutils.pyx":1592
 *     test_p = np.copy(stars_p)
 *     test_p[:,1] = 0.
 *     test_x = np.abs(bn.nansum(model_diff(frame.shape[0], frame.shape[1],             # <<<<<<<<<<<<<<
 *                                          test_p, box_size, frame,
 *                                          noise_guess * 0.,
 */
  __pyx_t_44 = PyTuple_New(8); if (unlikely(!__pyx_t_44)) __PYX_ERR(0, 1592, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_44);
  __Pyx_GIVEREF(__pyx_t_40);
  PyTuple_SET_ITEM(__pyx_t_44, 0, __pyx_t_40);
  __Pyx_GIVEREF(__pyx_t_2);
  PyTuple_SET_ITEM(__pyx_t_44, 1, __pyx_t_2);
  __Pyx_INCREF(((PyObject *)__pyx_v_test_p));
  __Pyx_GIVEREF(((PyObject *)__pyx_v_test_p));
  PyTuple_SET_ITEM(__pyx_t_44, 2, ((PyObject *)__pyx_v_test_p));
  __Pyx_GIVEREF(__pyx_t_5);
  PyTuple_SET_ITEM(__pyx_t_44, 3, __pyx_t_5);
  __Pyx_INCREF(((PyObject *)__pyx_v_frame));
  __Pyx_GIVEREF(((PyObject *)__pyx_v_frame));
  PyTuple_SET_ITEM(__pyx_t_44, 4, ((PyObject *)__pyx_v_frame));
  __Pyx_GIVEREF(__pyx_t_42);
  PyTuple_SET_ITEM(__pyx_t_44, 5, __pyx_t_42);
  __Pyx_INCREF(__pyx_float_0_);
  __Pyx_GIVEREF(__pyx_float_0_);
  PyTuple_SET_ITEM(__pyx_t_44, 6, __pyx_float_0_);
  __Pyx_GIVEREF(__pyx_t_43);
  PyTuple_SET_ITEM(__pyx_t_44, 7, __pyx_t_43);
  __pyx_t_40 = 0;
  __pyx_t_2 = 0;
  __pyx_t_5 = 0;
  __pyx_t_42 = 0;
  __pyx_t_43 = 0;

  /* "orb/cutils.pyx":1595
 *                                          test_p, box_size, frame,
 *                                          noise_guess * 0.,
 *                                          0., saturation, transpose=True,             # <<<<<<<<<<<<<<
 *                                          normalize=True), axis=1))
 *     test_y = np.abs(bn.nansum(model_diff(frame.shape[0], frame.shape[1],
 */
  __pyx_t_43 = PyDict_New(); if (unlikely(!__pyx_t_43)) __PYX_ERR(0, 1595, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_43);
  if (PyDict_SetItem(__pyx_t_43, __pyx_n_s_transpose, Py_True) < 0) __PYX_ERR(0, 1595, __pyx_L1_error)

  /* "orb/cutils.pyx":1596
 *                                          noise_guess * 0.,
 *                                          0., saturation, transpose=True,
 *                                          normalize=True), axis=1))             # <<<<<<<<<<<<<<
 *     test_y = np.abs(bn.nansum(model_diff(frame.shape[0], frame.shape[1],
 *                                          test_p, box_size, frame,
 */
  if (PyDict_SetItem(__pyx_t_43, __pyx_n_s_normalize, Py_True) < 0) __PYX_ERR(0, 1595, __pyx_L1_error)

  /* "orb/cutils.pyx":1592
 *     test_p = np.copy(stars_p)
 *     test_p[:,1] = 0.
 *     test_x = np.abs(bn.nansum(model_diff(frame.shape[0], frame.shape[1],             # <<<<<<<<<<<<<<
 *                                          test_p, box_size, frame,
 *                                          noise_guess * 0.,
 */
  __pyx_t_42 = __Pyx_PyObject_Call(__pyx_cur_scope->__pyx_v_model_diff, __pyx_t_44, __pyx_t_43); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1592, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_42);
  __Pyx_DECREF(__pyx_t_44); __pyx_t_44 = 0;
  __Pyx_DECREF(__pyx_t_43); __pyx_t_43 = 0;
  __pyx_t_43 = PyTuple_New(1); if (unlikely(!__pyx_t_43)) __PYX_ERR(0, 1592, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_43);
  __Pyx_GIVEREF(__pyx_t_42);
  PyTuple_SET_ITEM(__pyx_t_43, 0, __pyx_t_42);
  __pyx_t_42 = 0;

  /* "orb/cutils.pyx":1596
 *                                          noise_guess * 0.,
 *                                          0., saturation, transpose=True,
 *                                          normalize=True), axis=1))             # <<<<<<<<<<<<<<
 *     test_y = np.abs(bn.nansum(model_diff(frame.shape[0], frame.shape[1],
 *                                          test_p, box_size, frame,
 */
  __pyx_t_42 = PyDict_New(); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1596, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_42);
  if (PyDict_SetItem(__pyx_t_42, __pyx_n_s_axis, __pyx_int_1) < 0) __PYX_ERR(0, 1596, __pyx_L1_error)

  /* "orb/cutils.pyx":1592
 *     test_p = np.copy(stars_p)
 *     test_p[:,1] = 0.
 *     test_x = np.abs(bn.nansum(model_diff(frame.shape[0], frame.shape[1],             # <<<<<<<<<<<<<<
 *                                          test_p, box_size, frame,
 *                                          noise_guess * 0.,
 */
  __pyx_t_44 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_43, __pyx_t_42); if (unlikely(!__pyx_t_44)) __PYX_ERR(0, 1592, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_44);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __Pyx_DECREF(__pyx_t_43); __pyx_t_43 = 0;
  __Pyx_DECREF(__pyx_t_42); __pyx_t_42 = 0;
  __pyx_t_42 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_3))) {
    __pyx_t_42 = PyMethod_GET_SELF(__pyx_t_3);
    if (likely(__pyx_t_42)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
      __Pyx_INCREF(__pyx_t_42);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_3, function);
    }
  }
  if (!__pyx_t_42) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_3, __pyx_t_44); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1592, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_44); __pyx_t_44 = 0;
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_43 = PyTuple_New(1+1); if (unlikely(!__pyx_t_43)) __PYX_ERR(0, 1592, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_43);
    __Pyx_GIVEREF(__pyx_t_42); PyTuple_SET_ITEM(__pyx_t_43, 0, __pyx_t_42); __pyx_t_42 = NULL;
    __Pyx_GIVEREF(__pyx_t_44);
    PyTuple_SET_ITEM(__pyx_t_43, 0+1, __pyx_t_44);
    __pyx_t_44 = 0;
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_43, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1592, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_43); __pyx_t_43 = 0;
  }
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1592, __pyx_L1_error)
  __pyx_t_37 = ((PyArrayObject *)__pyx_t_1);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_test_x.rcbuffer->pybuffer);
    __pyx_t_8 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_test_x.rcbuffer->pybuffer, (PyObject*)__pyx_t_37, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack);
    if (unlikely(__pyx_t_8 < 0)) {
      PyErr_Fetch(&__pyx_t_24, &__pyx_t_23, &__pyx_t_22);
      if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_test_x.rcbuffer->pybuffer, (PyObject*)__pyx_v_test_x, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_24); Py_XDECREF(__pyx_t_23); Py_XDECREF(__pyx_t_22);
        __Pyx_RaiseBufferFallbackError();
      } else {
        PyErr_Restore(__pyx_t_24, __pyx_t_23, __pyx_t_22);
      }
    }
    __pyx_pybuffernd_test_x.diminfo[0].strides = __pyx_pybuffernd_test_x.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_test_x.diminfo[0].shape = __pyx_pybuffernd_test_x.rcbuffer->pybuffer.shape[0];
    if (unlikely(__pyx_t_8 < 0)) __PYX_ERR(0, 1592, __pyx_L1_error)
  }
  __pyx_t_37 = 0;
  __Pyx_DECREF_SET(__pyx_v_test_x, ((PyArrayObject *)__pyx_t_1));
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1597
 *                                          0., saturation, transpose=True,
 *                                          normalize=True), axis=1))
 *     test_y = np.abs(bn.nansum(model_diff(frame.shape[0], frame.shape[1],             # <<<<<<<<<<<<<<
 *                                          test_p, box_size, frame,
 *                                          noise_guess * 0.,
 */
  __pyx_t_3 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1597, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_43 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_abs); if (unlikely(!__pyx_t_43)) __PYX_ERR(0, 1597, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_43);
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_3 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1597, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_44 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_nansum); if (unlikely(!__pyx_t_44)) __PYX_ERR(0, 1597, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_44);
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_3 = __Pyx_PyInt_From_Py_intptr_t((__pyx_v_frame->dimensions[0])); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1597, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_42 = __Pyx_PyInt_From_Py_intptr_t((__pyx_v_frame->dimensions[1])); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1597, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_42);

  /* "orb/cutils.pyx":1598
 *                                          normalize=True), axis=1))
 *     test_y = np.abs(bn.nansum(model_diff(frame.shape[0], frame.shape[1],
 *                                          test_p, box_size, frame,             # <<<<<<<<<<<<<<
 *                                          noise_guess * 0.,
 *                                          0., saturation, transpose=False,
 */
  __pyx_t_4 = __Pyx_PyInt_From_int(__pyx_v_box_size); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1598, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);

  /* "orb/cutils.pyx":1599
 *     test_y = np.abs(bn.nansum(model_diff(frame.shape[0], frame.shape[1],
 *                                          test_p, box_size, frame,
 *                                          noise_guess * 0.,             # <<<<<<<<<<<<<<
 *                                          0., saturation, transpose=False,
 *                                          normalize=True), axis=0))
 */
  __pyx_t_5 = PyNumber_Multiply(((PyObject *)__pyx_v_noise_guess), __pyx_float_0_); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1599, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);

  /* "orb/cutils.pyx":1600
 *                                          test_p, box_size, frame,
 *                                          noise_guess * 0.,
 *                                          0., saturation, transpose=False,             # <<<<<<<<<<<<<<
 *                                          normalize=True), axis=0))
 *     test_x = test_x - np.min(test_x)
 */
  __pyx_t_2 = PyFloat_FromDouble(__pyx_v_saturation); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1600, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);

  /* "orb/cutils.pyx":1597
 *                                          0., saturation, transpose=True,
 *                                          normalize=True), axis=1))
 *     test_y = np.abs(bn.nansum(model_diff(frame.shape[0], frame.shape[1],             # <<<<<<<<<<<<<<
 *                                          test_p, box_size, frame,
 *                                          noise_guess * 0.,
 */
  __pyx_t_40 = PyTuple_New(8); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1597, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_40);
  __Pyx_GIVEREF(__pyx_t_3);
  PyTuple_SET_ITEM(__pyx_t_40, 0, __pyx_t_3);
  __Pyx_GIVEREF(__pyx_t_42);
  PyTuple_SET_ITEM(__pyx_t_40, 1, __pyx_t_42);
  __Pyx_INCREF(((PyObject *)__pyx_v_test_p));
  __Pyx_GIVEREF(((PyObject *)__pyx_v_test_p));
  PyTuple_SET_ITEM(__pyx_t_40, 2, ((PyObject *)__pyx_v_test_p));
  __Pyx_GIVEREF(__pyx_t_4);
  PyTuple_SET_ITEM(__pyx_t_40, 3, __pyx_t_4);
  __Pyx_INCREF(((PyObject *)__pyx_v_frame));
  __Pyx_GIVEREF(((PyObject *)__pyx_v_frame));
  PyTuple_SET_ITEM(__pyx_t_40, 4, ((PyObject *)__pyx_v_frame));
  __Pyx_GIVEREF(__pyx_t_5);
  PyTuple_SET_ITEM(__pyx_t_40, 5, __pyx_t_5);
  __Pyx_INCREF(__pyx_float_0_);
  __Pyx_GIVEREF(__pyx_float_0_);
  PyTuple_SET_ITEM(__pyx_t_40, 6, __pyx_float_0_);
  __Pyx_GIVEREF(__pyx_t_2);
  PyTuple_SET_ITEM(__pyx_t_40, 7, __pyx_t_2);
  __pyx_t_3 = 0;
  __pyx_t_42 = 0;
  __pyx_t_4 = 0;
  __pyx_t_5 = 0;
  __pyx_t_2 = 0;

  /* "orb/cutils.pyx":1600
 *                                          test_p, box_size, frame,
 *                                          noise_guess * 0.,
 *                                          0., saturation, transpose=False,             # <<<<<<<<<<<<<<
 *                                          normalize=True), axis=0))
 *     test_x = test_x - np.min(test_x)
 */
  __pyx_t_2 = PyDict_New(); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1600, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  if (PyDict_SetItem(__pyx_t_2, __pyx_n_s_transpose, Py_False) < 0) __PYX_ERR(0, 1600, __pyx_L1_error)

  /* "orb/cutils.pyx":1601
 *                                          noise_guess * 0.,
 *                                          0., saturation, transpose=False,
 *                                          normalize=True), axis=0))             # <<<<<<<<<<<<<<
 *     test_x = test_x - np.min(test_x)
 *     test_y = test_y - np.min(test_y)
 */
  if (PyDict_SetItem(__pyx_t_2, __pyx_n_s_normalize, Py_True) < 0) __PYX_ERR(0, 1600, __pyx_L1_error)

  /* "orb/cutils.pyx":1597
 *                                          0., saturation, transpose=True,
 *                                          normalize=True), axis=1))
 *     test_y = np.abs(bn.nansum(model_diff(frame.shape[0], frame.shape[1],             # <<<<<<<<<<<<<<
 *                                          test_p, box_size, frame,
 *                                          noise_guess * 0.,
 */
  __pyx_t_5 = __Pyx_PyObject_Call(__pyx_cur_scope->__pyx_v_model_diff, __pyx_t_40, __pyx_t_2); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1597, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = PyTuple_New(1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1597, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_GIVEREF(__pyx_t_5);
  PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_5);
  __pyx_t_5 = 0;

  /* "orb/cutils.pyx":1601
 *                                          noise_guess * 0.,
 *                                          0., saturation, transpose=False,
 *                                          normalize=True), axis=0))             # <<<<<<<<<<<<<<
 *     test_x = test_x - np.min(test_x)
 *     test_y = test_y - np.min(test_y)
 */
  __pyx_t_5 = PyDict_New(); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1601, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  if (PyDict_SetItem(__pyx_t_5, __pyx_n_s_axis, __pyx_int_0) < 0) __PYX_ERR(0, 1601, __pyx_L1_error)

  /* "orb/cutils.pyx":1597
 *                                          0., saturation, transpose=True,
 *                                          normalize=True), axis=1))
 *     test_y = np.abs(bn.nansum(model_diff(frame.shape[0], frame.shape[1],             # <<<<<<<<<<<<<<
 *                                          test_p, box_size, frame,
 *                                          noise_guess * 0.,
 */
  __pyx_t_40 = __Pyx_PyObject_Call(__pyx_t_44, __pyx_t_2, __pyx_t_5); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1597, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_40);
  __Pyx_DECREF(__pyx_t_44); __pyx_t_44 = 0;
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_5 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_43))) {
    __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_43);
    if (likely(__pyx_t_5)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_43);
      __Pyx_INCREF(__pyx_t_5);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_43, function);
    }
  }
  if (!__pyx_t_5) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_43, __pyx_t_40); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1597, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_2 = PyTuple_New(1+1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1597, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_5); __pyx_t_5 = NULL;
    __Pyx_GIVEREF(__pyx_t_40);
    PyTuple_SET_ITEM(__pyx_t_2, 0+1, __pyx_t_40);
    __pyx_t_40 = 0;
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_43, __pyx_t_2, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1597, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  }
  __Pyx_DECREF(__pyx_t_43); __pyx_t_43 = 0;
  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1597, __pyx_L1_error)
  __pyx_t_38 = ((PyArrayObject *)__pyx_t_1);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_test_y.rcbuffer->pybuffer);
    __pyx_t_8 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_test_y.rcbuffer->pybuffer, (PyObject*)__pyx_t_38, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack);
    if (unlikely(__pyx_t_8 < 0)) {
      PyErr_Fetch(&__pyx_t_22, &__pyx_t_23, &__pyx_t_24);
      if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_test_y.rcbuffer->pybuffer, (PyObject*)__pyx_v_test_y, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_22); Py_XDECREF(__pyx_t_23); Py_XDECREF(__pyx_t_24);
        __Pyx_RaiseBufferFallbackError();
      } else {
        PyErr_Restore(__pyx_t_22, __pyx_t_23, __pyx_t_24);
      }
    }
    __pyx_pybuffernd_test_y.diminfo[0].strides = __pyx_pybuffernd_test_y.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_test_y.diminfo[0].shape = __pyx_pybuffernd_test_y.rcbuffer->pybuffer.shape[0];
    if (unlikely(__pyx_t_8 < 0)) __PYX_ERR(0, 1597, __pyx_L1_error)
  }
  __pyx_t_38 = 0;
  __Pyx_DECREF_SET(__pyx_v_test_y, ((PyArrayObject *)__pyx_t_1));
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1602
 *                                          0., saturation, transpose=False,
 *                                          normalize=True), axis=0))
 *     test_x = test_x - np.min(test_x)             # <<<<<<<<<<<<<<
 *     test_y = test_y - np.min(test_y)
 * 
 */
  __pyx_t_43 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_43)) __PYX_ERR(0, 1602, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_43);
  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_43, __pyx_n_s_min); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1602, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_43); __pyx_t_43 = 0;
  __pyx_t_43 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_2))) {
    __pyx_t_43 = PyMethod_GET_SELF(__pyx_t_2);
    if (likely(__pyx_t_43)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
      __Pyx_INCREF(__pyx_t_43);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_2, function);
    }
  }
  if (!__pyx_t_43) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_2, ((PyObject *)__pyx_v_test_x)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1602, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_40 = PyTuple_New(1+1); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1602, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_40);
    __Pyx_GIVEREF(__pyx_t_43); PyTuple_SET_ITEM(__pyx_t_40, 0, __pyx_t_43); __pyx_t_43 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_test_x));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_test_x));
    PyTuple_SET_ITEM(__pyx_t_40, 0+1, ((PyObject *)__pyx_v_test_x));
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_40, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1602, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;
  }
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = PyNumber_Subtract(((PyObject *)__pyx_v_test_x), __pyx_t_1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1602, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  if (!(likely(((__pyx_t_2) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_2, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1602, __pyx_L1_error)
  __pyx_t_37 = ((PyArrayObject *)__pyx_t_2);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_test_x.rcbuffer->pybuffer);
    __pyx_t_8 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_test_x.rcbuffer->pybuffer, (PyObject*)__pyx_t_37, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack);
    if (unlikely(__pyx_t_8 < 0)) {
      PyErr_Fetch(&__pyx_t_24, &__pyx_t_23, &__pyx_t_22);
      if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_test_x.rcbuffer->pybuffer, (PyObject*)__pyx_v_test_x, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_24); Py_XDECREF(__pyx_t_23); Py_XDECREF(__pyx_t_22);
        __Pyx_RaiseBufferFallbackError();
      } else {
        PyErr_Restore(__pyx_t_24, __pyx_t_23, __pyx_t_22);
      }
    }
    __pyx_pybuffernd_test_x.diminfo[0].strides = __pyx_pybuffernd_test_x.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_test_x.diminfo[0].shape = __pyx_pybuffernd_test_x.rcbuffer->pybuffer.shape[0];
    if (unlikely(__pyx_t_8 < 0)) __PYX_ERR(0, 1602, __pyx_L1_error)
  }
  __pyx_t_37 = 0;
  __Pyx_DECREF_SET(__pyx_v_test_x, ((PyArrayObject *)__pyx_t_2));
  __pyx_t_2 = 0;

  /* "orb/cutils.pyx":1603
 *                                          normalize=True), axis=0))
 *     test_x = test_x - np.min(test_x)
 *     test_y = test_y - np.min(test_y)             # <<<<<<<<<<<<<<
 * 
 *     dx_guess_arg = <double> np.argmax(test_x) - <double> box_size / 2.
 */
  __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1603, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_40 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_min); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1603, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_40);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_1 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_40))) {
    __pyx_t_1 = PyMethod_GET_SELF(__pyx_t_40);
    if (likely(__pyx_t_1)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_40);
      __Pyx_INCREF(__pyx_t_1);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_40, function);
    }
  }
  if (!__pyx_t_1) {
    __pyx_t_2 = __Pyx_PyObject_CallOneArg(__pyx_t_40, ((PyObject *)__pyx_v_test_y)); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1603, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
  } else {
    __pyx_t_43 = PyTuple_New(1+1); if (unlikely(!__pyx_t_43)) __PYX_ERR(0, 1603, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_43);
    __Pyx_GIVEREF(__pyx_t_1); PyTuple_SET_ITEM(__pyx_t_43, 0, __pyx_t_1); __pyx_t_1 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_test_y));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_test_y));
    PyTuple_SET_ITEM(__pyx_t_43, 0+1, ((PyObject *)__pyx_v_test_y));
    __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_40, __pyx_t_43, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1603, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_DECREF(__pyx_t_43); __pyx_t_43 = 0;
  }
  __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;
  __pyx_t_40 = PyNumber_Subtract(((PyObject *)__pyx_v_test_y), __pyx_t_2); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1603, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_40);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  if (!(likely(((__pyx_t_40) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_40, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1603, __pyx_L1_error)
  __pyx_t_38 = ((PyArrayObject *)__pyx_t_40);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_test_y.rcbuffer->pybuffer);
    __pyx_t_8 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_test_y.rcbuffer->pybuffer, (PyObject*)__pyx_t_38, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack);
    if (unlikely(__pyx_t_8 < 0)) {
      PyErr_Fetch(&__pyx_t_22, &__pyx_t_23, &__pyx_t_24);
      if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_test_y.rcbuffer->pybuffer, (PyObject*)__pyx_v_test_y, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_22); Py_XDECREF(__pyx_t_23); Py_XDECREF(__pyx_t_24);
        __Pyx_RaiseBufferFallbackError();
      } else {
        PyErr_Restore(__pyx_t_22, __pyx_t_23, __pyx_t_24);
      }
    }
    __pyx_pybuffernd_test_y.diminfo[0].strides = __pyx_pybuffernd_test_y.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_test_y.diminfo[0].shape = __pyx_pybuffernd_test_y.rcbuffer->pybuffer.shape[0];
    if (unlikely(__pyx_t_8 < 0)) __PYX_ERR(0, 1603, __pyx_L1_error)
  }
  __pyx_t_38 = 0;
  __Pyx_DECREF_SET(__pyx_v_test_y, ((PyArrayObject *)__pyx_t_40));
  __pyx_t_40 = 0;

  /* "orb/cutils.pyx":1605
 *     test_y = test_y - np.min(test_y)
 * 
 *     dx_guess_arg = <double> np.argmax(test_x) - <double> box_size / 2.             # <<<<<<<<<<<<<<
 *     dy_guess_arg = <double> np.argmax(test_y) - <double> box_size / 2.
 * 
 */
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1605, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_43 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_argmax); if (unlikely(!__pyx_t_43)) __PYX_ERR(0, 1605, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_43);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_43))) {
    __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_43);
    if (likely(__pyx_t_2)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_43);
      __Pyx_INCREF(__pyx_t_2);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_43, function);
    }
  }
  if (!__pyx_t_2) {
    __pyx_t_40 = __Pyx_PyObject_CallOneArg(__pyx_t_43, ((PyObject *)__pyx_v_test_x)); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1605, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_40);
  } else {
    __pyx_t_1 = PyTuple_New(1+1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1605, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_1, 0, __pyx_t_2); __pyx_t_2 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_test_x));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_test_x));
    PyTuple_SET_ITEM(__pyx_t_1, 0+1, ((PyObject *)__pyx_v_test_x));
    __pyx_t_40 = __Pyx_PyObject_Call(__pyx_t_43, __pyx_t_1, NULL); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1605, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_40);
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  }
  __Pyx_DECREF(__pyx_t_43); __pyx_t_43 = 0;
  __pyx_t_45 = __pyx_PyFloat_AsDouble(__pyx_t_40); if (unlikely((__pyx_t_45 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 1605, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;
  __pyx_v_dx_guess_arg = (((double)__pyx_t_45) - (((double)__pyx_v_box_size) / 2.));

  /* "orb/cutils.pyx":1606
 * 
 *     dx_guess_arg = <double> np.argmax(test_x) - <double> box_size / 2.
 *     dy_guess_arg = <double> np.argmax(test_y) - <double> box_size / 2.             # <<<<<<<<<<<<<<
 * 
 *     test_x *= gaussian1d(np.arange(test_x.shape[0]).astype(float),
 */
  __pyx_t_43 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_43)) __PYX_ERR(0, 1606, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_43);
  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_43, __pyx_n_s_argmax); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1606, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_DECREF(__pyx_t_43); __pyx_t_43 = 0;
  __pyx_t_43 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_1))) {
    __pyx_t_43 = PyMethod_GET_SELF(__pyx_t_1);
    if (likely(__pyx_t_43)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_1);
      __Pyx_INCREF(__pyx_t_43);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_1, function);
    }
  }
  if (!__pyx_t_43) {
    __pyx_t_40 = __Pyx_PyObject_CallOneArg(__pyx_t_1, ((PyObject *)__pyx_v_test_y)); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1606, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_40);
  } else {
    __pyx_t_2 = PyTuple_New(1+1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1606, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_GIVEREF(__pyx_t_43); PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_43); __pyx_t_43 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_test_y));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_test_y));
    PyTuple_SET_ITEM(__pyx_t_2, 0+1, ((PyObject *)__pyx_v_test_y));
    __pyx_t_40 = __Pyx_PyObject_Call(__pyx_t_1, __pyx_t_2, NULL); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1606, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_40);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  }
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_45 = __pyx_PyFloat_AsDouble(__pyx_t_40); if (unlikely((__pyx_t_45 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 1606, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;
  __pyx_v_dy_guess_arg = (((double)__pyx_t_45) - (((double)__pyx_v_box_size) / 2.));

  /* "orb/cutils.pyx":1608
 *     dy_guess_arg = <double> np.argmax(test_y) - <double> box_size / 2.
 * 
 *     test_x *= gaussian1d(np.arange(test_x.shape[0]).astype(float),             # <<<<<<<<<<<<<<
 *                          0., 1., <double> test_x.shape[0] / 2. - 0.5,
 *                          <double> test_x.shape[0] / 2.)
 */
  __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_gaussian1d); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1608, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1608, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_44 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_arange); if (unlikely(!__pyx_t_44)) __PYX_ERR(0, 1608, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_44);
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_5 = __Pyx_PyInt_From_Py_intptr_t((__pyx_v_test_x->dimensions[0])); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1608, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_4 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_44))) {
    __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_44);
    if (likely(__pyx_t_4)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_44);
      __Pyx_INCREF(__pyx_t_4);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_44, function);
    }
  }
  if (!__pyx_t_4) {
    __pyx_t_43 = __Pyx_PyObject_CallOneArg(__pyx_t_44, __pyx_t_5); if (unlikely(!__pyx_t_43)) __PYX_ERR(0, 1608, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    __Pyx_GOTREF(__pyx_t_43);
  } else {
    __pyx_t_42 = PyTuple_New(1+1); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1608, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_42);
    __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_42, 0, __pyx_t_4); __pyx_t_4 = NULL;
    __Pyx_GIVEREF(__pyx_t_5);
    PyTuple_SET_ITEM(__pyx_t_42, 0+1, __pyx_t_5);
    __pyx_t_5 = 0;
    __pyx_t_43 = __Pyx_PyObject_Call(__pyx_t_44, __pyx_t_42, NULL); if (unlikely(!__pyx_t_43)) __PYX_ERR(0, 1608, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_43);
    __Pyx_DECREF(__pyx_t_42); __pyx_t_42 = 0;
  }
  __Pyx_DECREF(__pyx_t_44); __pyx_t_44 = 0;
  __pyx_t_44 = __Pyx_PyObject_GetAttrStr(__pyx_t_43, __pyx_n_s_astype); if (unlikely(!__pyx_t_44)) __PYX_ERR(0, 1608, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_44);
  __Pyx_DECREF(__pyx_t_43); __pyx_t_43 = 0;
  __pyx_t_43 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && likely(PyMethod_Check(__pyx_t_44))) {
    __pyx_t_43 = PyMethod_GET_SELF(__pyx_t_44);
    if (likely(__pyx_t_43)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_44);
      __Pyx_INCREF(__pyx_t_43);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_44, function);
    }
  }
  if (!__pyx_t_43) {
    __pyx_t_2 = __Pyx_PyObject_CallOneArg(__pyx_t_44, ((PyObject *)(&PyFloat_Type))); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1608, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
  } else {
    __pyx_t_42 = PyTuple_New(1+1); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1608, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_42);
    __Pyx_GIVEREF(__pyx_t_43); PyTuple_SET_ITEM(__pyx_t_42, 0, __pyx_t_43); __pyx_t_43 = NULL;
    __Pyx_INCREF(((PyObject *)(&PyFloat_Type)));
    __Pyx_GIVEREF(((PyObject *)(&PyFloat_Type)));
    PyTuple_SET_ITEM(__pyx_t_42, 0+1, ((PyObject *)(&PyFloat_Type)));
    __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_44, __pyx_t_42, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1608, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_DECREF(__pyx_t_42); __pyx_t_42 = 0;
  }
  __Pyx_DECREF(__pyx_t_44); __pyx_t_44 = 0;

  /* "orb/cutils.pyx":1609
 * 
 *     test_x *= gaussian1d(np.arange(test_x.shape[0]).astype(float),
 *                          0., 1., <double> test_x.shape[0] / 2. - 0.5,             # <<<<<<<<<<<<<<
 *                          <double> test_x.shape[0] / 2.)
 *     test_y *= gaussian1d(np.arange(test_y.shape[0]).astype(float),
 */
  __pyx_t_44 = PyFloat_FromDouble(((((double)(__pyx_v_test_x->dimensions[0])) / 2.) - 0.5)); if (unlikely(!__pyx_t_44)) __PYX_ERR(0, 1609, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_44);

  /* "orb/cutils.pyx":1610
 *     test_x *= gaussian1d(np.arange(test_x.shape[0]).astype(float),
 *                          0., 1., <double> test_x.shape[0] / 2. - 0.5,
 *                          <double> test_x.shape[0] / 2.)             # <<<<<<<<<<<<<<
 *     test_y *= gaussian1d(np.arange(test_y.shape[0]).astype(float),
 *                          0., 1., <double> test_y.shape[0] / 2. - 0.5,
 */
  __pyx_t_42 = PyFloat_FromDouble((((double)(__pyx_v_test_x->dimensions[0])) / 2.)); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1610, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_42);
  __pyx_t_43 = NULL;
  __pyx_t_46 = 0;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_1))) {
    __pyx_t_43 = PyMethod_GET_SELF(__pyx_t_1);
    if (likely(__pyx_t_43)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_1);
      __Pyx_INCREF(__pyx_t_43);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_1, function);
      __pyx_t_46 = 1;
    }
  }
  __pyx_t_5 = PyTuple_New(5+__pyx_t_46); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1608, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  if (__pyx_t_43) {
    __Pyx_GIVEREF(__pyx_t_43); PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_43); __pyx_t_43 = NULL;
  }
  __Pyx_GIVEREF(__pyx_t_2);
  PyTuple_SET_ITEM(__pyx_t_5, 0+__pyx_t_46, __pyx_t_2);
  __Pyx_INCREF(__pyx_float_0_);
  __Pyx_GIVEREF(__pyx_float_0_);
  PyTuple_SET_ITEM(__pyx_t_5, 1+__pyx_t_46, __pyx_float_0_);
  __Pyx_INCREF(__pyx_float_1_);
  __Pyx_GIVEREF(__pyx_float_1_);
  PyTuple_SET_ITEM(__pyx_t_5, 2+__pyx_t_46, __pyx_float_1_);
  __Pyx_GIVEREF(__pyx_t_44);
  PyTuple_SET_ITEM(__pyx_t_5, 3+__pyx_t_46, __pyx_t_44);
  __Pyx_GIVEREF(__pyx_t_42);
  PyTuple_SET_ITEM(__pyx_t_5, 4+__pyx_t_46, __pyx_t_42);
  __pyx_t_2 = 0;
  __pyx_t_44 = 0;
  __pyx_t_42 = 0;
  __pyx_t_40 = __Pyx_PyObject_Call(__pyx_t_1, __pyx_t_5, NULL); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1608, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_40);
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1608
 *     dy_guess_arg = <double> np.argmax(test_y) - <double> box_size / 2.
 * 
 *     test_x *= gaussian1d(np.arange(test_x.shape[0]).astype(float),             # <<<<<<<<<<<<<<
 *                          0., 1., <double> test_x.shape[0] / 2. - 0.5,
 *                          <double> test_x.shape[0] / 2.)
 */
  __pyx_t_1 = PyNumber_InPlaceMultiply(((PyObject *)__pyx_v_test_x), __pyx_t_40); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1608, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;
  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1608, __pyx_L1_error)
  __pyx_t_37 = ((PyArrayObject *)__pyx_t_1);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_test_x.rcbuffer->pybuffer);
    __pyx_t_8 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_test_x.rcbuffer->pybuffer, (PyObject*)__pyx_t_37, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack);
    if (unlikely(__pyx_t_8 < 0)) {
      PyErr_Fetch(&__pyx_t_24, &__pyx_t_23, &__pyx_t_22);
      if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_test_x.rcbuffer->pybuffer, (PyObject*)__pyx_v_test_x, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_24); Py_XDECREF(__pyx_t_23); Py_XDECREF(__pyx_t_22);
        __Pyx_RaiseBufferFallbackError();
      } else {
        PyErr_Restore(__pyx_t_24, __pyx_t_23, __pyx_t_22);
      }
    }
    __pyx_pybuffernd_test_x.diminfo[0].strides = __pyx_pybuffernd_test_x.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_test_x.diminfo[0].shape = __pyx_pybuffernd_test_x.rcbuffer->pybuffer.shape[0];
    if (unlikely(__pyx_t_8 < 0)) __PYX_ERR(0, 1608, __pyx_L1_error)
  }
  __pyx_t_37 = 0;
  __Pyx_DECREF_SET(__pyx_v_test_x, ((PyArrayObject *)__pyx_t_1));
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1611
 *                          0., 1., <double> test_x.shape[0] / 2. - 0.5,
 *                          <double> test_x.shape[0] / 2.)
 *     test_y *= gaussian1d(np.arange(test_y.shape[0]).astype(float),             # <<<<<<<<<<<<<<
 *                          0., 1., <double> test_y.shape[0] / 2. - 0.5,
 *                          <double> test_y.shape[0] / 2.)
 */
  __pyx_t_40 = __Pyx_GetModuleGlobalName(__pyx_n_s_gaussian1d); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1611, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_40);
  __pyx_t_44 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_44)) __PYX_ERR(0, 1611, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_44);
  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_44, __pyx_n_s_arange); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1611, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_44); __pyx_t_44 = 0;
  __pyx_t_44 = __Pyx_PyInt_From_Py_intptr_t((__pyx_v_test_y->dimensions[0])); if (unlikely(!__pyx_t_44)) __PYX_ERR(0, 1611, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_44);
  __pyx_t_43 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_2))) {
    __pyx_t_43 = PyMethod_GET_SELF(__pyx_t_2);
    if (likely(__pyx_t_43)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
      __Pyx_INCREF(__pyx_t_43);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_2, function);
    }
  }
  if (!__pyx_t_43) {
    __pyx_t_42 = __Pyx_PyObject_CallOneArg(__pyx_t_2, __pyx_t_44); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1611, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_44); __pyx_t_44 = 0;
    __Pyx_GOTREF(__pyx_t_42);
  } else {
    __pyx_t_4 = PyTuple_New(1+1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1611, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_GIVEREF(__pyx_t_43); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_43); __pyx_t_43 = NULL;
    __Pyx_GIVEREF(__pyx_t_44);
    PyTuple_SET_ITEM(__pyx_t_4, 0+1, __pyx_t_44);
    __pyx_t_44 = 0;
    __pyx_t_42 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_4, NULL); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1611, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_42);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  }
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_42, __pyx_n_s_astype); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1611, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_42); __pyx_t_42 = 0;
  __pyx_t_42 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && likely(PyMethod_Check(__pyx_t_2))) {
    __pyx_t_42 = PyMethod_GET_SELF(__pyx_t_2);
    if (likely(__pyx_t_42)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
      __Pyx_INCREF(__pyx_t_42);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_2, function);
    }
  }
  if (!__pyx_t_42) {
    __pyx_t_5 = __Pyx_PyObject_CallOneArg(__pyx_t_2, ((PyObject *)(&PyFloat_Type))); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1611, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
  } else {
    __pyx_t_4 = PyTuple_New(1+1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1611, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_GIVEREF(__pyx_t_42); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_42); __pyx_t_42 = NULL;
    __Pyx_INCREF(((PyObject *)(&PyFloat_Type)));
    __Pyx_GIVEREF(((PyObject *)(&PyFloat_Type)));
    PyTuple_SET_ITEM(__pyx_t_4, 0+1, ((PyObject *)(&PyFloat_Type)));
    __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_4, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1611, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  }
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;

  /* "orb/cutils.pyx":1612
 *                          <double> test_x.shape[0] / 2.)
 *     test_y *= gaussian1d(np.arange(test_y.shape[0]).astype(float),
 *                          0., 1., <double> test_y.shape[0] / 2. - 0.5,             # <<<<<<<<<<<<<<
 *                          <double> test_y.shape[0] / 2.)
 * 
 */
  __pyx_t_2 = PyFloat_FromDouble(((((double)(__pyx_v_test_y->dimensions[0])) / 2.) - 0.5)); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1612, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);

  /* "orb/cutils.pyx":1613
 *     test_y *= gaussian1d(np.arange(test_y.shape[0]).astype(float),
 *                          0., 1., <double> test_y.shape[0] / 2. - 0.5,
 *                          <double> test_y.shape[0] / 2.)             # <<<<<<<<<<<<<<
 * 
 *     nzi = np.nonzero(test_x > 0.)
 */
  __pyx_t_4 = PyFloat_FromDouble((((double)(__pyx_v_test_y->dimensions[0])) / 2.)); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1613, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_42 = NULL;
  __pyx_t_46 = 0;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_40))) {
    __pyx_t_42 = PyMethod_GET_SELF(__pyx_t_40);
    if (likely(__pyx_t_42)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_40);
      __Pyx_INCREF(__pyx_t_42);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_40, function);
      __pyx_t_46 = 1;
    }
  }
  __pyx_t_44 = PyTuple_New(5+__pyx_t_46); if (unlikely(!__pyx_t_44)) __PYX_ERR(0, 1611, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_44);
  if (__pyx_t_42) {
    __Pyx_GIVEREF(__pyx_t_42); PyTuple_SET_ITEM(__pyx_t_44, 0, __pyx_t_42); __pyx_t_42 = NULL;
  }
  __Pyx_GIVEREF(__pyx_t_5);
  PyTuple_SET_ITEM(__pyx_t_44, 0+__pyx_t_46, __pyx_t_5);
  __Pyx_INCREF(__pyx_float_0_);
  __Pyx_GIVEREF(__pyx_float_0_);
  PyTuple_SET_ITEM(__pyx_t_44, 1+__pyx_t_46, __pyx_float_0_);
  __Pyx_INCREF(__pyx_float_1_);
  __Pyx_GIVEREF(__pyx_float_1_);
  PyTuple_SET_ITEM(__pyx_t_44, 2+__pyx_t_46, __pyx_float_1_);
  __Pyx_GIVEREF(__pyx_t_2);
  PyTuple_SET_ITEM(__pyx_t_44, 3+__pyx_t_46, __pyx_t_2);
  __Pyx_GIVEREF(__pyx_t_4);
  PyTuple_SET_ITEM(__pyx_t_44, 4+__pyx_t_46, __pyx_t_4);
  __pyx_t_5 = 0;
  __pyx_t_2 = 0;
  __pyx_t_4 = 0;
  __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_40, __pyx_t_44, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1611, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_DECREF(__pyx_t_44); __pyx_t_44 = 0;
  __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;

  /* "orb/cutils.pyx":1611
 *                          0., 1., <double> test_x.shape[0] / 2. - 0.5,
 *                          <double> test_x.shape[0] / 2.)
 *     test_y *= gaussian1d(np.arange(test_y.shape[0]).astype(float),             # <<<<<<<<<<<<<<
 *                          0., 1., <double> test_y.shape[0] / 2. - 0.5,
 *                          <double> test_y.shape[0] / 2.)
 */
  __pyx_t_40 = PyNumber_InPlaceMultiply(((PyObject *)__pyx_v_test_y), __pyx_t_1); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1611, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_40);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  if (!(likely(((__pyx_t_40) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_40, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1611, __pyx_L1_error)
  __pyx_t_38 = ((PyArrayObject *)__pyx_t_40);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_test_y.rcbuffer->pybuffer);
    __pyx_t_8 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_test_y.rcbuffer->pybuffer, (PyObject*)__pyx_t_38, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack);
    if (unlikely(__pyx_t_8 < 0)) {
      PyErr_Fetch(&__pyx_t_22, &__pyx_t_23, &__pyx_t_24);
      if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_test_y.rcbuffer->pybuffer, (PyObject*)__pyx_v_test_y, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_22); Py_XDECREF(__pyx_t_23); Py_XDECREF(__pyx_t_24);
        __Pyx_RaiseBufferFallbackError();
      } else {
        PyErr_Restore(__pyx_t_22, __pyx_t_23, __pyx_t_24);
      }
    }
    __pyx_pybuffernd_test_y.diminfo[0].strides = __pyx_pybuffernd_test_y.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_test_y.diminfo[0].shape = __pyx_pybuffernd_test_y.rcbuffer->pybuffer.shape[0];
    if (unlikely(__pyx_t_8 < 0)) __PYX_ERR(0, 1611, __pyx_L1_error)
  }
  __pyx_t_38 = 0;
  __Pyx_DECREF_SET(__pyx_v_test_y, ((PyArrayObject *)__pyx_t_40));
  __pyx_t_40 = 0;

  /* "orb/cutils.pyx":1615
 *                          <double> test_y.shape[0] / 2.)
 * 
 *     nzi = np.nonzero(test_x > 0.)             # <<<<<<<<<<<<<<
 *     nzj = np.nonzero(test_y > 0.)
 * 
 */
  __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1615, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_44 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_nonzero); if (unlikely(!__pyx_t_44)) __PYX_ERR(0, 1615, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_44);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_1 = PyObject_RichCompare(((PyObject *)__pyx_v_test_x), __pyx_float_0_, Py_GT); __Pyx_XGOTREF(__pyx_t_1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1615, __pyx_L1_error)
  __pyx_t_4 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_44))) {
    __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_44);
    if (likely(__pyx_t_4)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_44);
      __Pyx_INCREF(__pyx_t_4);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_44, function);
    }
  }
  if (!__pyx_t_4) {
    __pyx_t_40 = __Pyx_PyObject_CallOneArg(__pyx_t_44, __pyx_t_1); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1615, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    __Pyx_GOTREF(__pyx_t_40);
  } else {
    __pyx_t_2 = PyTuple_New(1+1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1615, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_4); __pyx_t_4 = NULL;
    __Pyx_GIVEREF(__pyx_t_1);
    PyTuple_SET_ITEM(__pyx_t_2, 0+1, __pyx_t_1);
    __pyx_t_1 = 0;
    __pyx_t_40 = __Pyx_PyObject_Call(__pyx_t_44, __pyx_t_2, NULL); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1615, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_40);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  }
  __Pyx_DECREF(__pyx_t_44); __pyx_t_44 = 0;
  __pyx_v_nzi = __pyx_t_40;
  __pyx_t_40 = 0;

  /* "orb/cutils.pyx":1616
 * 
 *     nzi = np.nonzero(test_x > 0.)
 *     nzj = np.nonzero(test_y > 0.)             # <<<<<<<<<<<<<<
 * 
 *     dx_guess = (np.sum((test_x[nzi]) * np.arange(box_size)[nzi])
 */
  __pyx_t_44 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_44)) __PYX_ERR(0, 1616, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_44);
  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_44, __pyx_n_s_nonzero); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1616, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_44); __pyx_t_44 = 0;
  __pyx_t_44 = PyObject_RichCompare(((PyObject *)__pyx_v_test_y), __pyx_float_0_, Py_GT); __Pyx_XGOTREF(__pyx_t_44); if (unlikely(!__pyx_t_44)) __PYX_ERR(0, 1616, __pyx_L1_error)
  __pyx_t_1 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_2))) {
    __pyx_t_1 = PyMethod_GET_SELF(__pyx_t_2);
    if (likely(__pyx_t_1)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
      __Pyx_INCREF(__pyx_t_1);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_2, function);
    }
  }
  if (!__pyx_t_1) {
    __pyx_t_40 = __Pyx_PyObject_CallOneArg(__pyx_t_2, __pyx_t_44); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1616, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_44); __pyx_t_44 = 0;
    __Pyx_GOTREF(__pyx_t_40);
  } else {
    __pyx_t_4 = PyTuple_New(1+1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1616, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_GIVEREF(__pyx_t_1); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_1); __pyx_t_1 = NULL;
    __Pyx_GIVEREF(__pyx_t_44);
    PyTuple_SET_ITEM(__pyx_t_4, 0+1, __pyx_t_44);
    __pyx_t_44 = 0;
    __pyx_t_40 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_4, NULL); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1616, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_40);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  }
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_v_nzj = __pyx_t_40;
  __pyx_t_40 = 0;

  /* "orb/cutils.pyx":1618
 *     nzj = np.nonzero(test_y > 0.)
 * 
 *     dx_guess = (np.sum((test_x[nzi]) * np.arange(box_size)[nzi])             # <<<<<<<<<<<<<<
 *                 / np.sum(test_x[nzi])
 *                 - (<double> box_size / 2. - 0.))
 */
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1618, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_sum); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1618, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = PyObject_GetItem(((PyObject *)__pyx_v_test_x), __pyx_v_nzi); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1618, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1618, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_arange); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1618, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_box_size); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1618, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_42 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_5))) {
    __pyx_t_42 = PyMethod_GET_SELF(__pyx_t_5);
    if (likely(__pyx_t_42)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_5);
      __Pyx_INCREF(__pyx_t_42);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_5, function);
    }
  }
  if (!__pyx_t_42) {
    __pyx_t_44 = __Pyx_PyObject_CallOneArg(__pyx_t_5, __pyx_t_1); if (unlikely(!__pyx_t_44)) __PYX_ERR(0, 1618, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    __Pyx_GOTREF(__pyx_t_44);
  } else {
    __pyx_t_43 = PyTuple_New(1+1); if (unlikely(!__pyx_t_43)) __PYX_ERR(0, 1618, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_43);
    __Pyx_GIVEREF(__pyx_t_42); PyTuple_SET_ITEM(__pyx_t_43, 0, __pyx_t_42); __pyx_t_42 = NULL;
    __Pyx_GIVEREF(__pyx_t_1);
    PyTuple_SET_ITEM(__pyx_t_43, 0+1, __pyx_t_1);
    __pyx_t_1 = 0;
    __pyx_t_44 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_43, NULL); if (unlikely(!__pyx_t_44)) __PYX_ERR(0, 1618, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_44);
    __Pyx_DECREF(__pyx_t_43); __pyx_t_43 = 0;
  }
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_5 = PyObject_GetItem(__pyx_t_44, __pyx_v_nzi); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1618, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_44); __pyx_t_44 = 0;
  __pyx_t_44 = PyNumber_Multiply(__pyx_t_2, __pyx_t_5); if (unlikely(!__pyx_t_44)) __PYX_ERR(0, 1618, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_44);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_5 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_4))) {
    __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_4);
    if (likely(__pyx_t_5)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
      __Pyx_INCREF(__pyx_t_5);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_4, function);
    }
  }
  if (!__pyx_t_5) {
    __pyx_t_40 = __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_44); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1618, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_44); __pyx_t_44 = 0;
    __Pyx_GOTREF(__pyx_t_40);
  } else {
    __pyx_t_2 = PyTuple_New(1+1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1618, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_5); __pyx_t_5 = NULL;
    __Pyx_GIVEREF(__pyx_t_44);
    PyTuple_SET_ITEM(__pyx_t_2, 0+1, __pyx_t_44);
    __pyx_t_44 = 0;
    __pyx_t_40 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_2, NULL); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1618, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_40);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  }
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;

  /* "orb/cutils.pyx":1619
 * 
 *     dx_guess = (np.sum((test_x[nzi]) * np.arange(box_size)[nzi])
 *                 / np.sum(test_x[nzi])             # <<<<<<<<<<<<<<
 *                 - (<double> box_size / 2. - 0.))
 *     dy_guess = (np.sum((test_y[nzj]) * np.arange(box_size)[nzj])
 */
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1619, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_44 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_sum); if (unlikely(!__pyx_t_44)) __PYX_ERR(0, 1619, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_44);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = PyObject_GetItem(((PyObject *)__pyx_v_test_x), __pyx_v_nzi); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1619, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_5 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_44))) {
    __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_44);
    if (likely(__pyx_t_5)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_44);
      __Pyx_INCREF(__pyx_t_5);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_44, function);
    }
  }
  if (!__pyx_t_5) {
    __pyx_t_4 = __Pyx_PyObject_CallOneArg(__pyx_t_44, __pyx_t_2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1619, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __Pyx_GOTREF(__pyx_t_4);
  } else {
    __pyx_t_43 = PyTuple_New(1+1); if (unlikely(!__pyx_t_43)) __PYX_ERR(0, 1619, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_43);
    __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_43, 0, __pyx_t_5); __pyx_t_5 = NULL;
    __Pyx_GIVEREF(__pyx_t_2);
    PyTuple_SET_ITEM(__pyx_t_43, 0+1, __pyx_t_2);
    __pyx_t_2 = 0;
    __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_44, __pyx_t_43, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1619, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_43); __pyx_t_43 = 0;
  }
  __Pyx_DECREF(__pyx_t_44); __pyx_t_44 = 0;
  __pyx_t_44 = __Pyx_PyNumber_Divide(__pyx_t_40, __pyx_t_4); if (unlikely(!__pyx_t_44)) __PYX_ERR(0, 1619, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_44);
  __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;

  /* "orb/cutils.pyx":1620
 *     dx_guess = (np.sum((test_x[nzi]) * np.arange(box_size)[nzi])
 *                 / np.sum(test_x[nzi])
 *                 - (<double> box_size / 2. - 0.))             # <<<<<<<<<<<<<<
 *     dy_guess = (np.sum((test_y[nzj]) * np.arange(box_size)[nzj])
 *                 /np.sum(test_y[nzj])
 */
  __pyx_t_4 = PyFloat_FromDouble(((((double)__pyx_v_box_size) / 2.) - 0.)); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1620, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_40 = PyNumber_Subtract(__pyx_t_44, __pyx_t_4); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1620, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_40);
  __Pyx_DECREF(__pyx_t_44); __pyx_t_44 = 0;
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_45 = __pyx_PyFloat_AsDouble(__pyx_t_40); if (unlikely((__pyx_t_45 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 1620, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;
  __pyx_v_dx_guess = __pyx_t_45;

  /* "orb/cutils.pyx":1621
 *                 / np.sum(test_x[nzi])
 *                 - (<double> box_size / 2. - 0.))
 *     dy_guess = (np.sum((test_y[nzj]) * np.arange(box_size)[nzj])             # <<<<<<<<<<<<<<
 *                 /np.sum(test_y[nzj])
 *                 - (<double> box_size / 2. - 0.))
 */
  __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1621, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_44 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_sum); if (unlikely(!__pyx_t_44)) __PYX_ERR(0, 1621, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_44);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_4 = PyObject_GetItem(((PyObject *)__pyx_v_test_y), __pyx_v_nzj); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1621, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1621, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_arange); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1621, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = __Pyx_PyInt_From_int(__pyx_v_box_size); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1621, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_1 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_5))) {
    __pyx_t_1 = PyMethod_GET_SELF(__pyx_t_5);
    if (likely(__pyx_t_1)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_5);
      __Pyx_INCREF(__pyx_t_1);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_5, function);
    }
  }
  if (!__pyx_t_1) {
    __pyx_t_43 = __Pyx_PyObject_CallOneArg(__pyx_t_5, __pyx_t_2); if (unlikely(!__pyx_t_43)) __PYX_ERR(0, 1621, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __Pyx_GOTREF(__pyx_t_43);
  } else {
    __pyx_t_42 = PyTuple_New(1+1); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1621, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_42);
    __Pyx_GIVEREF(__pyx_t_1); PyTuple_SET_ITEM(__pyx_t_42, 0, __pyx_t_1); __pyx_t_1 = NULL;
    __Pyx_GIVEREF(__pyx_t_2);
    PyTuple_SET_ITEM(__pyx_t_42, 0+1, __pyx_t_2);
    __pyx_t_2 = 0;
    __pyx_t_43 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_42, NULL); if (unlikely(!__pyx_t_43)) __PYX_ERR(0, 1621, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_43);
    __Pyx_DECREF(__pyx_t_42); __pyx_t_42 = 0;
  }
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_5 = PyObject_GetItem(__pyx_t_43, __pyx_v_nzj); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1621, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_43); __pyx_t_43 = 0;
  __pyx_t_43 = PyNumber_Multiply(__pyx_t_4, __pyx_t_5); if (unlikely(!__pyx_t_43)) __PYX_ERR(0, 1621, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_43);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_5 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_44))) {
    __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_44);
    if (likely(__pyx_t_5)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_44);
      __Pyx_INCREF(__pyx_t_5);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_44, function);
    }
  }
  if (!__pyx_t_5) {
    __pyx_t_40 = __Pyx_PyObject_CallOneArg(__pyx_t_44, __pyx_t_43); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1621, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_43); __pyx_t_43 = 0;
    __Pyx_GOTREF(__pyx_t_40);
  } else {
    __pyx_t_4 = PyTuple_New(1+1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1621, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_5); __pyx_t_5 = NULL;
    __Pyx_GIVEREF(__pyx_t_43);
    PyTuple_SET_ITEM(__pyx_t_4, 0+1, __pyx_t_43);
    __pyx_t_43 = 0;
    __pyx_t_40 = __Pyx_PyObject_Call(__pyx_t_44, __pyx_t_4, NULL); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1621, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_40);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  }
  __Pyx_DECREF(__pyx_t_44); __pyx_t_44 = 0;

  /* "orb/cutils.pyx":1622
 *                 - (<double> box_size / 2. - 0.))
 *     dy_guess = (np.sum((test_y[nzj]) * np.arange(box_size)[nzj])
 *                 /np.sum(test_y[nzj])             # <<<<<<<<<<<<<<
 *                 - (<double> box_size / 2. - 0.))
 * 
 */
  __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1622, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_43 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_sum); if (unlikely(!__pyx_t_43)) __PYX_ERR(0, 1622, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_43);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_4 = PyObject_GetItem(((PyObject *)__pyx_v_test_y), __pyx_v_nzj); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1622, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_5 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_43))) {
    __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_43);
    if (likely(__pyx_t_5)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_43);
      __Pyx_INCREF(__pyx_t_5);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_43, function);
    }
  }
  if (!__pyx_t_5) {
    __pyx_t_44 = __Pyx_PyObject_CallOneArg(__pyx_t_43, __pyx_t_4); if (unlikely(!__pyx_t_44)) __PYX_ERR(0, 1622, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __Pyx_GOTREF(__pyx_t_44);
  } else {
    __pyx_t_42 = PyTuple_New(1+1); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1622, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_42);
    __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_42, 0, __pyx_t_5); __pyx_t_5 = NULL;
    __Pyx_GIVEREF(__pyx_t_4);
    PyTuple_SET_ITEM(__pyx_t_42, 0+1, __pyx_t_4);
    __pyx_t_4 = 0;
    __pyx_t_44 = __Pyx_PyObject_Call(__pyx_t_43, __pyx_t_42, NULL); if (unlikely(!__pyx_t_44)) __PYX_ERR(0, 1622, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_44);
    __Pyx_DECREF(__pyx_t_42); __pyx_t_42 = 0;
  }
  __Pyx_DECREF(__pyx_t_43); __pyx_t_43 = 0;
  __pyx_t_43 = __Pyx_PyNumber_Divide(__pyx_t_40, __pyx_t_44); if (unlikely(!__pyx_t_43)) __PYX_ERR(0, 1622, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_43);
  __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;
  __Pyx_DECREF(__pyx_t_44); __pyx_t_44 = 0;

  /* "orb/cutils.pyx":1623
 *     dy_guess = (np.sum((test_y[nzj]) * np.arange(box_size)[nzj])
 *                 /np.sum(test_y[nzj])
 *                 - (<double> box_size / 2. - 0.))             # <<<<<<<<<<<<<<
 * 
 *     # far from the center the arg-based guess is generally better
 */
  __pyx_t_44 = PyFloat_FromDouble(((((double)__pyx_v_box_size) / 2.) - 0.)); if (unlikely(!__pyx_t_44)) __PYX_ERR(0, 1623, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_44);
  __pyx_t_40 = PyNumber_Subtract(__pyx_t_43, __pyx_t_44); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1623, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_40);
  __Pyx_DECREF(__pyx_t_43); __pyx_t_43 = 0;
  __Pyx_DECREF(__pyx_t_44); __pyx_t_44 = 0;
  __pyx_t_45 = __pyx_PyFloat_AsDouble(__pyx_t_40); if (unlikely((__pyx_t_45 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 1623, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;
  __pyx_v_dy_guess = __pyx_t_45;

  /* "orb/cutils.pyx":1626
 * 
 *     # far from the center the arg-based guess is generally better
 *     if (abs(dx_guess) > <double> box_size / 4.             # <<<<<<<<<<<<<<
 *         or np.isnan(dx_guess)): dx_guess = dx_guess_arg
 * 
 */
  __pyx_t_13 = ((fabs(__pyx_v_dx_guess) > (((double)__pyx_v_box_size) / 4.)) != 0);
  if (!__pyx_t_13) {
  } else {
    __pyx_t_9 = __pyx_t_13;
    goto __pyx_L16_bool_binop_done;
  }

  /* "orb/cutils.pyx":1627
 *     # far from the center the arg-based guess is generally better
 *     if (abs(dx_guess) > <double> box_size / 4.
 *         or np.isnan(dx_guess)): dx_guess = dx_guess_arg             # <<<<<<<<<<<<<<
 * 
 *     if (abs(dy_guess) > <double> box_size / 4.
 */
  __pyx_t_44 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_44)) __PYX_ERR(0, 1627, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_44);
  __pyx_t_43 = __Pyx_PyObject_GetAttrStr(__pyx_t_44, __pyx_n_s_isnan); if (unlikely(!__pyx_t_43)) __PYX_ERR(0, 1627, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_43);
  __Pyx_DECREF(__pyx_t_44); __pyx_t_44 = 0;
  __pyx_t_44 = PyFloat_FromDouble(__pyx_v_dx_guess); if (unlikely(!__pyx_t_44)) __PYX_ERR(0, 1627, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_44);
  __pyx_t_42 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_43))) {
    __pyx_t_42 = PyMethod_GET_SELF(__pyx_t_43);
    if (likely(__pyx_t_42)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_43);
      __Pyx_INCREF(__pyx_t_42);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_43, function);
    }
  }
  if (!__pyx_t_42) {
    __pyx_t_40 = __Pyx_PyObject_CallOneArg(__pyx_t_43, __pyx_t_44); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1627, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_44); __pyx_t_44 = 0;
    __Pyx_GOTREF(__pyx_t_40);
  } else {
    __pyx_t_4 = PyTuple_New(1+1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1627, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_GIVEREF(__pyx_t_42); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_42); __pyx_t_42 = NULL;
    __Pyx_GIVEREF(__pyx_t_44);
    PyTuple_SET_ITEM(__pyx_t_4, 0+1, __pyx_t_44);
    __pyx_t_44 = 0;
    __pyx_t_40 = __Pyx_PyObject_Call(__pyx_t_43, __pyx_t_4, NULL); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1627, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_40);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  }
  __Pyx_DECREF(__pyx_t_43); __pyx_t_43 = 0;
  __pyx_t_13 = __Pyx_PyObject_IsTrue(__pyx_t_40); if (unlikely(__pyx_t_13 < 0)) __PYX_ERR(0, 1627, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;
  __pyx_t_9 = __pyx_t_13;
  __pyx_L16_bool_binop_done:;

  /* "orb/cutils.pyx":1626
 * 
 *     # far from the center the arg-based guess is generally better
 *     if (abs(dx_guess) > <double> box_size / 4.             # <<<<<<<<<<<<<<
 *         or np.isnan(dx_guess)): dx_guess = dx_guess_arg
 * 
 */
  if (__pyx_t_9) {

    /* "orb/cutils.pyx":1627
 *     # far from the center the arg-based guess is generally better
 *     if (abs(dx_guess) > <double> box_size / 4.
 *         or np.isnan(dx_guess)): dx_guess = dx_guess_arg             # <<<<<<<<<<<<<<
 * 
 *     if (abs(dy_guess) > <double> box_size / 4.
 */
    __pyx_v_dx_guess = __pyx_v_dx_guess_arg;

    /* "orb/cutils.pyx":1626
 * 
 *     # far from the center the arg-based guess is generally better
 *     if (abs(dx_guess) > <double> box_size / 4.             # <<<<<<<<<<<<<<
 *         or np.isnan(dx_guess)): dx_guess = dx_guess_arg
 * 
 */
  }

  /* "orb/cutils.pyx":1629
 *         or np.isnan(dx_guess)): dx_guess = dx_guess_arg
 * 
 *     if (abs(dy_guess) > <double> box_size / 4.             # <<<<<<<<<<<<<<
 *         or np.isnan(dy_guess)): dy_guess = dy_guess_arg
 * 
 */
  __pyx_t_13 = ((fabs(__pyx_v_dy_guess) > (((double)__pyx_v_box_size) / 4.)) != 0);
  if (!__pyx_t_13) {
  } else {
    __pyx_t_9 = __pyx_t_13;
    goto __pyx_L19_bool_binop_done;
  }

  /* "orb/cutils.pyx":1630
 * 
 *     if (abs(dy_guess) > <double> box_size / 4.
 *         or np.isnan(dy_guess)): dy_guess = dy_guess_arg             # <<<<<<<<<<<<<<
 * 
 *     if cov_pos:
 */
  __pyx_t_43 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_43)) __PYX_ERR(0, 1630, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_43);
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_43, __pyx_n_s_isnan); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1630, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_43); __pyx_t_43 = 0;
  __pyx_t_43 = PyFloat_FromDouble(__pyx_v_dy_guess); if (unlikely(!__pyx_t_43)) __PYX_ERR(0, 1630, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_43);
  __pyx_t_44 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_4))) {
    __pyx_t_44 = PyMethod_GET_SELF(__pyx_t_4);
    if (likely(__pyx_t_44)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
      __Pyx_INCREF(__pyx_t_44);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_4, function);
    }
  }
  if (!__pyx_t_44) {
    __pyx_t_40 = __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_43); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1630, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_43); __pyx_t_43 = 0;
    __Pyx_GOTREF(__pyx_t_40);
  } else {
    __pyx_t_42 = PyTuple_New(1+1); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1630, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_42);
    __Pyx_GIVEREF(__pyx_t_44); PyTuple_SET_ITEM(__pyx_t_42, 0, __pyx_t_44); __pyx_t_44 = NULL;
    __Pyx_GIVEREF(__pyx_t_43);
    PyTuple_SET_ITEM(__pyx_t_42, 0+1, __pyx_t_43);
    __pyx_t_43 = 0;
    __pyx_t_40 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_42, NULL); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1630, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_40);
    __Pyx_DECREF(__pyx_t_42); __pyx_t_42 = 0;
  }
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_13 = __Pyx_PyObject_IsTrue(__pyx_t_40); if (unlikely(__pyx_t_13 < 0)) __PYX_ERR(0, 1630, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;
  __pyx_t_9 = __pyx_t_13;
  __pyx_L19_bool_binop_done:;

  /* "orb/cutils.pyx":1629
 *         or np.isnan(dx_guess)): dx_guess = dx_guess_arg
 * 
 *     if (abs(dy_guess) > <double> box_size / 4.             # <<<<<<<<<<<<<<
 *         or np.isnan(dy_guess)): dy_guess = dy_guess_arg
 * 
 */
  if (__pyx_t_9) {

    /* "orb/cutils.pyx":1630
 * 
 *     if (abs(dy_guess) > <double> box_size / 4.
 *         or np.isnan(dy_guess)): dy_guess = dy_guess_arg             # <<<<<<<<<<<<<<
 * 
 *     if cov_pos:
 */
    __pyx_v_dy_guess = __pyx_v_dy_guess_arg;

    /* "orb/cutils.pyx":1629
 *         or np.isnan(dx_guess)): dx_guess = dx_guess_arg
 * 
 *     if (abs(dy_guess) > <double> box_size / 4.             # <<<<<<<<<<<<<<
 *         or np.isnan(dy_guess)): dy_guess = dy_guess_arg
 * 
 */
  }

  /* "orb/cutils.pyx":1632
 *         or np.isnan(dy_guess)): dy_guess = dy_guess_arg
 * 
 *     if cov_pos:             # <<<<<<<<<<<<<<
 *         cov_p[1] = dx_guess
 *         cov_p[2] = dy_guess
 */
  __pyx_t_9 = __Pyx_PyObject_IsTrue(((PyObject *)__pyx_v_cov_pos)); if (unlikely(__pyx_t_9 < 0)) __PYX_ERR(0, 1632, __pyx_L1_error)
  if (__pyx_t_9) {

    /* "orb/cutils.pyx":1633
 * 
 *     if cov_pos:
 *         cov_p[1] = dx_guess             # <<<<<<<<<<<<<<
 *         cov_p[2] = dy_guess
 *     else:
 */
    __pyx_t_47 = 1;
    __pyx_t_8 = -1;
    if (__pyx_t_47 < 0) {
      __pyx_t_47 += __pyx_pybuffernd_cov_p.diminfo[0].shape;
      if (unlikely(__pyx_t_47 < 0)) __pyx_t_8 = 0;
    } else if (unlikely(__pyx_t_47 >= __pyx_pybuffernd_cov_p.diminfo[0].shape)) __pyx_t_8 = 0;
    if (unlikely(__pyx_t_8 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_8);
      __PYX_ERR(0, 1633, __pyx_L1_error)
    }
    *__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.buf, __pyx_t_47, __pyx_pybuffernd_cov_p.diminfo[0].strides) = __pyx_v_dx_guess;

    /* "orb/cutils.pyx":1634
 *     if cov_pos:
 *         cov_p[1] = dx_guess
 *         cov_p[2] = dy_guess             # <<<<<<<<<<<<<<
 *     else:
 *         stars_p[:,2] += dx_guess
 */
    __pyx_t_48 = 2;
    __pyx_t_8 = -1;
    if (__pyx_t_48 < 0) {
      __pyx_t_48 += __pyx_pybuffernd_cov_p.diminfo[0].shape;
      if (unlikely(__pyx_t_48 < 0)) __pyx_t_8 = 0;
    } else if (unlikely(__pyx_t_48 >= __pyx_pybuffernd_cov_p.diminfo[0].shape)) __pyx_t_8 = 0;
    if (unlikely(__pyx_t_8 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_8);
      __PYX_ERR(0, 1634, __pyx_L1_error)
    }
    *__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.buf, __pyx_t_48, __pyx_pybuffernd_cov_p.diminfo[0].strides) = __pyx_v_dy_guess;

    /* "orb/cutils.pyx":1632
 *         or np.isnan(dy_guess)): dy_guess = dy_guess_arg
 * 
 *     if cov_pos:             # <<<<<<<<<<<<<<
 *         cov_p[1] = dx_guess
 *         cov_p[2] = dy_guess
 */
    goto __pyx_L21;
  }

  /* "orb/cutils.pyx":1636
 *         cov_p[2] = dy_guess
 *     else:
 *         stars_p[:,2] += dx_guess             # <<<<<<<<<<<<<<
 *         stars_p[:,3] += dy_guess
 * 
 */
  /*else*/ {
    __Pyx_INCREF(__pyx_tuple__100);
    __pyx_t_49 = __pyx_tuple__100;
    __pyx_t_40 = PyObject_GetItem(((PyObject *)__pyx_v_stars_p), __pyx_t_49); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1636, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_40);
    __pyx_t_4 = PyFloat_FromDouble(__pyx_v_dx_guess); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1636, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __pyx_t_42 = PyNumber_InPlaceAdd(__pyx_t_40, __pyx_t_4); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1636, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_42);
    __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    if (unlikely(PyObject_SetItem(((PyObject *)__pyx_v_stars_p), __pyx_t_49, __pyx_t_42) < 0)) __PYX_ERR(0, 1636, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_42); __pyx_t_42 = 0;
    __Pyx_DECREF(__pyx_t_49); __pyx_t_49 = 0;

    /* "orb/cutils.pyx":1637
 *     else:
 *         stars_p[:,2] += dx_guess
 *         stars_p[:,3] += dy_guess             # <<<<<<<<<<<<<<
 * 
 *     # background and noise guess
 */
    __Pyx_INCREF(__pyx_tuple__102);
    __pyx_t_49 = __pyx_tuple__102;
    __pyx_t_42 = PyObject_GetItem(((PyObject *)__pyx_v_stars_p), __pyx_t_49); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1637, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_42);
    __pyx_t_4 = PyFloat_FromDouble(__pyx_v_dy_guess); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1637, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __pyx_t_40 = PyNumber_InPlaceAdd(__pyx_t_42, __pyx_t_4); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1637, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_40);
    __Pyx_DECREF(__pyx_t_42); __pyx_t_42 = 0;
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    if (unlikely(PyObject_SetItem(((PyObject *)__pyx_v_stars_p), __pyx_t_49, __pyx_t_40) < 0)) __PYX_ERR(0, 1637, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;
    __Pyx_DECREF(__pyx_t_49); __pyx_t_49 = 0;
  }
  __pyx_L21:;

  /* "orb/cutils.pyx":1640
 * 
 *     # background and noise guess
 *     for istar in range(star_nb):             # <<<<<<<<<<<<<<
 *         x_min, x_max, y_min, y_max = get_box_coords(
 *             stars_p[istar,2] + cov_p[1], stars_p[istar,3] + cov_p[2], box_size,
 */
  __pyx_t_8 = __pyx_v_star_nb;
  for (__pyx_t_12 = 0; __pyx_t_12 < __pyx_t_8; __pyx_t_12+=1) {
    __pyx_v_istar = __pyx_t_12;

    /* "orb/cutils.pyx":1641
 *     # background and noise guess
 *     for istar in range(star_nb):
 *         x_min, x_max, y_min, y_max = get_box_coords(             # <<<<<<<<<<<<<<
 *             stars_p[istar,2] + cov_p[1], stars_p[istar,3] + cov_p[2], box_size,
 *             0, frame.shape[0], 0, frame.shape[1])
 */
    __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_get_box_coords); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1641, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);

    /* "orb/cutils.pyx":1642
 *     for istar in range(star_nb):
 *         x_min, x_max, y_min, y_max = get_box_coords(
 *             stars_p[istar,2] + cov_p[1], stars_p[istar,3] + cov_p[2], box_size,             # <<<<<<<<<<<<<<
 *             0, frame.shape[0], 0, frame.shape[1])
 *         frame_mask[x_min:x_max, y_min:y_max] = 1
 */
    __pyx_t_50 = __pyx_v_istar;
    __pyx_t_51 = 2;
    __pyx_t_52 = -1;
    if (__pyx_t_50 < 0) {
      __pyx_t_50 += __pyx_pybuffernd_stars_p.diminfo[0].shape;
      if (unlikely(__pyx_t_50 < 0)) __pyx_t_52 = 0;
    } else if (unlikely(__pyx_t_50 >= __pyx_pybuffernd_stars_p.diminfo[0].shape)) __pyx_t_52 = 0;
    if (__pyx_t_51 < 0) {
      __pyx_t_51 += __pyx_pybuffernd_stars_p.diminfo[1].shape;
      if (unlikely(__pyx_t_51 < 0)) __pyx_t_52 = 1;
    } else if (unlikely(__pyx_t_51 >= __pyx_pybuffernd_stars_p.diminfo[1].shape)) __pyx_t_52 = 1;
    if (unlikely(__pyx_t_52 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_52);
      __PYX_ERR(0, 1642, __pyx_L1_error)
    }
    __pyx_t_53 = 1;
    __pyx_t_52 = -1;
    if (__pyx_t_53 < 0) {
      __pyx_t_53 += __pyx_pybuffernd_cov_p.diminfo[0].shape;
      if (unlikely(__pyx_t_53 < 0)) __pyx_t_52 = 0;
    } else if (unlikely(__pyx_t_53 >= __pyx_pybuffernd_cov_p.diminfo[0].shape)) __pyx_t_52 = 0;
    if (unlikely(__pyx_t_52 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_52);
      __PYX_ERR(0, 1642, __pyx_L1_error)
    }
    __pyx_t_42 = PyFloat_FromDouble(((*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_stars_p.rcbuffer->pybuffer.buf, __pyx_t_50, __pyx_pybuffernd_stars_p.diminfo[0].strides, __pyx_t_51, __pyx_pybuffernd_stars_p.diminfo[1].strides)) + (*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.buf, __pyx_t_53, __pyx_pybuffernd_cov_p.diminfo[0].strides)))); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1642, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_42);
    __pyx_t_54 = __pyx_v_istar;
    __pyx_t_55 = 3;
    __pyx_t_52 = -1;
    if (__pyx_t_54 < 0) {
      __pyx_t_54 += __pyx_pybuffernd_stars_p.diminfo[0].shape;
      if (unlikely(__pyx_t_54 < 0)) __pyx_t_52 = 0;
    } else if (unlikely(__pyx_t_54 >= __pyx_pybuffernd_stars_p.diminfo[0].shape)) __pyx_t_52 = 0;
    if (__pyx_t_55 < 0) {
      __pyx_t_55 += __pyx_pybuffernd_stars_p.diminfo[1].shape;
      if (unlikely(__pyx_t_55 < 0)) __pyx_t_52 = 1;
    } else if (unlikely(__pyx_t_55 >= __pyx_pybuffernd_stars_p.diminfo[1].shape)) __pyx_t_52 = 1;
    if (unlikely(__pyx_t_52 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_52);
      __PYX_ERR(0, 1642, __pyx_L1_error)
    }
    __pyx_t_56 = 2;
    __pyx_t_52 = -1;
    if (__pyx_t_56 < 0) {
      __pyx_t_56 += __pyx_pybuffernd_cov_p.diminfo[0].shape;
      if (unlikely(__pyx_t_56 < 0)) __pyx_t_52 = 0;
    } else if (unlikely(__pyx_t_56 >= __pyx_pybuffernd_cov_p.diminfo[0].shape)) __pyx_t_52 = 0;
    if (unlikely(__pyx_t_52 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_52);
      __PYX_ERR(0, 1642, __pyx_L1_error)
    }
    __pyx_t_43 = PyFloat_FromDouble(((*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_stars_p.rcbuffer->pybuffer.buf, __pyx_t_54, __pyx_pybuffernd_stars_p.diminfo[0].strides, __pyx_t_55, __pyx_pybuffernd_stars_p.diminfo[1].strides)) + (*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.buf, __pyx_t_56, __pyx_pybuffernd_cov_p.diminfo[0].strides)))); if (unlikely(!__pyx_t_43)) __PYX_ERR(0, 1642, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_43);
    __pyx_t_44 = __Pyx_PyInt_From_int(__pyx_v_box_size); if (unlikely(!__pyx_t_44)) __PYX_ERR(0, 1642, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_44);

    /* "orb/cutils.pyx":1643
 *         x_min, x_max, y_min, y_max = get_box_coords(
 *             stars_p[istar,2] + cov_p[1], stars_p[istar,3] + cov_p[2], box_size,
 *             0, frame.shape[0], 0, frame.shape[1])             # <<<<<<<<<<<<<<
 *         frame_mask[x_min:x_max, y_min:y_max] = 1
 *         box = frame[x_min:x_max, y_min:y_max]
 */
    __pyx_t_5 = __Pyx_PyInt_From_Py_intptr_t((__pyx_v_frame->dimensions[0])); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1643, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __pyx_t_2 = __Pyx_PyInt_From_Py_intptr_t((__pyx_v_frame->dimensions[1])); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1643, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __pyx_t_1 = NULL;
    __pyx_t_46 = 0;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_4))) {
      __pyx_t_1 = PyMethod_GET_SELF(__pyx_t_4);
      if (likely(__pyx_t_1)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
        __Pyx_INCREF(__pyx_t_1);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_4, function);
        __pyx_t_46 = 1;
      }
    }
    __pyx_t_3 = PyTuple_New(7+__pyx_t_46); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1641, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    if (__pyx_t_1) {
      __Pyx_GIVEREF(__pyx_t_1); PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_1); __pyx_t_1 = NULL;
    }
    __Pyx_GIVEREF(__pyx_t_42);
    PyTuple_SET_ITEM(__pyx_t_3, 0+__pyx_t_46, __pyx_t_42);
    __Pyx_GIVEREF(__pyx_t_43);
    PyTuple_SET_ITEM(__pyx_t_3, 1+__pyx_t_46, __pyx_t_43);
    __Pyx_GIVEREF(__pyx_t_44);
    PyTuple_SET_ITEM(__pyx_t_3, 2+__pyx_t_46, __pyx_t_44);
    __Pyx_INCREF(__pyx_int_0);
    __Pyx_GIVEREF(__pyx_int_0);
    PyTuple_SET_ITEM(__pyx_t_3, 3+__pyx_t_46, __pyx_int_0);
    __Pyx_GIVEREF(__pyx_t_5);
    PyTuple_SET_ITEM(__pyx_t_3, 4+__pyx_t_46, __pyx_t_5);
    __Pyx_INCREF(__pyx_int_0);
    __Pyx_GIVEREF(__pyx_int_0);
    PyTuple_SET_ITEM(__pyx_t_3, 5+__pyx_t_46, __pyx_int_0);
    __Pyx_GIVEREF(__pyx_t_2);
    PyTuple_SET_ITEM(__pyx_t_3, 6+__pyx_t_46, __pyx_t_2);
    __pyx_t_42 = 0;
    __pyx_t_43 = 0;
    __pyx_t_44 = 0;
    __pyx_t_5 = 0;
    __pyx_t_2 = 0;
    __pyx_t_40 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_3, NULL); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1641, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_40);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    if ((likely(PyTuple_CheckExact(__pyx_t_40))) || (PyList_CheckExact(__pyx_t_40))) {
      PyObject* sequence = __pyx_t_40;
      #if CYTHON_COMPILING_IN_CPYTHON
      Py_ssize_t size = Py_SIZE(sequence);
      #else
      Py_ssize_t size = PySequence_Size(sequence);
      #endif
      if (unlikely(size != 4)) {
        if (size > 4) __Pyx_RaiseTooManyValuesError(4);
        else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
        __PYX_ERR(0, 1641, __pyx_L1_error)
      }
      #if CYTHON_COMPILING_IN_CPYTHON
      if (likely(PyTuple_CheckExact(sequence))) {
        __pyx_t_4 = PyTuple_GET_ITEM(sequence, 0); 
        __pyx_t_3 = PyTuple_GET_ITEM(sequence, 1); 
        __pyx_t_2 = PyTuple_GET_ITEM(sequence, 2); 
        __pyx_t_5 = PyTuple_GET_ITEM(sequence, 3); 
      } else {
        __pyx_t_4 = PyList_GET_ITEM(sequence, 0); 
        __pyx_t_3 = PyList_GET_ITEM(sequence, 1); 
        __pyx_t_2 = PyList_GET_ITEM(sequence, 2); 
        __pyx_t_5 = PyList_GET_ITEM(sequence, 3); 
      }
      __Pyx_INCREF(__pyx_t_4);
      __Pyx_INCREF(__pyx_t_3);
      __Pyx_INCREF(__pyx_t_2);
      __Pyx_INCREF(__pyx_t_5);
      #else
      {
        Py_ssize_t i;
        PyObject** temps[4] = {&__pyx_t_4,&__pyx_t_3,&__pyx_t_2,&__pyx_t_5};
        for (i=0; i < 4; i++) {
          PyObject* item = PySequence_ITEM(sequence, i); if (unlikely(!item)) __PYX_ERR(0, 1641, __pyx_L1_error)
          __Pyx_GOTREF(item);
          *(temps[i]) = item;
        }
      }
      #endif
      __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;
    } else {
      Py_ssize_t index = -1;
      PyObject** temps[4] = {&__pyx_t_4,&__pyx_t_3,&__pyx_t_2,&__pyx_t_5};
      __pyx_t_44 = PyObject_GetIter(__pyx_t_40); if (unlikely(!__pyx_t_44)) __PYX_ERR(0, 1641, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_44);
      __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;
      __pyx_t_57 = Py_TYPE(__pyx_t_44)->tp_iternext;
      for (index=0; index < 4; index++) {
        PyObject* item = __pyx_t_57(__pyx_t_44); if (unlikely(!item)) goto __pyx_L24_unpacking_failed;
        __Pyx_GOTREF(item);
        *(temps[index]) = item;
      }
      if (__Pyx_IternextUnpackEndCheck(__pyx_t_57(__pyx_t_44), 4) < 0) __PYX_ERR(0, 1641, __pyx_L1_error)
      __pyx_t_57 = NULL;
      __Pyx_DECREF(__pyx_t_44); __pyx_t_44 = 0;
      goto __pyx_L25_unpacking_done;
      __pyx_L24_unpacking_failed:;
      __Pyx_DECREF(__pyx_t_44); __pyx_t_44 = 0;
      __pyx_t_57 = NULL;
      if (__Pyx_IterFinish() == 0) __Pyx_RaiseNeedMoreValuesError(index);
      __PYX_ERR(0, 1641, __pyx_L1_error)
      __pyx_L25_unpacking_done:;
    }

    /* "orb/cutils.pyx":1641
 *     # background and noise guess
 *     for istar in range(star_nb):
 *         x_min, x_max, y_min, y_max = get_box_coords(             # <<<<<<<<<<<<<<
 *             stars_p[istar,2] + cov_p[1], stars_p[istar,3] + cov_p[2], box_size,
 *             0, frame.shape[0], 0, frame.shape[1])
 */
    __pyx_t_52 = __Pyx_PyInt_As_int(__pyx_t_4); if (unlikely((__pyx_t_52 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 1641, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_t_58 = __Pyx_PyInt_As_int(__pyx_t_3); if (unlikely((__pyx_t_58 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 1641, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __pyx_t_59 = __Pyx_PyInt_As_int(__pyx_t_2); if (unlikely((__pyx_t_59 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 1641, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __pyx_t_60 = __Pyx_PyInt_As_int(__pyx_t_5); if (unlikely((__pyx_t_60 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 1641, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    __pyx_v_x_min = __pyx_t_52;
    __pyx_v_x_max = __pyx_t_58;
    __pyx_v_y_min = __pyx_t_59;
    __pyx_v_y_max = __pyx_t_60;

    /* "orb/cutils.pyx":1644
 *             stars_p[istar,2] + cov_p[1], stars_p[istar,3] + cov_p[2], box_size,
 *             0, frame.shape[0], 0, frame.shape[1])
 *         frame_mask[x_min:x_max, y_min:y_max] = 1             # <<<<<<<<<<<<<<
 *         box = frame[x_min:x_max, y_min:y_max]
 *         # amplitude guess
 */
    __pyx_t_40 = __Pyx_PyInt_From_int(__pyx_v_x_min); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1644, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_40);
    __pyx_t_5 = __Pyx_PyInt_From_int(__pyx_v_x_max); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1644, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __pyx_t_2 = PySlice_New(__pyx_t_40, __pyx_t_5, Py_None); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1644, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    __pyx_t_5 = __Pyx_PyInt_From_int(__pyx_v_y_min); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1644, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __pyx_t_40 = __Pyx_PyInt_From_int(__pyx_v_y_max); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1644, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_40);
    __pyx_t_3 = PySlice_New(__pyx_t_5, __pyx_t_40, Py_None); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1644, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;
    __pyx_t_40 = PyTuple_New(2); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1644, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_40);
    __Pyx_GIVEREF(__pyx_t_2);
    PyTuple_SET_ITEM(__pyx_t_40, 0, __pyx_t_2);
    __Pyx_GIVEREF(__pyx_t_3);
    PyTuple_SET_ITEM(__pyx_t_40, 1, __pyx_t_3);
    __pyx_t_2 = 0;
    __pyx_t_3 = 0;
    if (unlikely(PyObject_SetItem(((PyObject *)__pyx_v_frame_mask), __pyx_t_40, __pyx_int_1) < 0)) __PYX_ERR(0, 1644, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;

    /* "orb/cutils.pyx":1645
 *             0, frame.shape[0], 0, frame.shape[1])
 *         frame_mask[x_min:x_max, y_min:y_max] = 1
 *         box = frame[x_min:x_max, y_min:y_max]             # <<<<<<<<<<<<<<
 *         # amplitude guess
 *         # the 3 most intense pixels are skipped to determine the max
 */
    __pyx_t_40 = __Pyx_PyInt_From_int(__pyx_v_x_min); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1645, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_40);
    __pyx_t_3 = __Pyx_PyInt_From_int(__pyx_v_x_max); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1645, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __pyx_t_2 = PySlice_New(__pyx_t_40, __pyx_t_3, Py_None); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1645, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __pyx_t_3 = __Pyx_PyInt_From_int(__pyx_v_y_min); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1645, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __pyx_t_40 = __Pyx_PyInt_From_int(__pyx_v_y_max); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1645, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_40);
    __pyx_t_5 = PySlice_New(__pyx_t_3, __pyx_t_40, Py_None); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1645, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;
    __pyx_t_40 = PyTuple_New(2); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1645, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_40);
    __Pyx_GIVEREF(__pyx_t_2);
    PyTuple_SET_ITEM(__pyx_t_40, 0, __pyx_t_2);
    __Pyx_GIVEREF(__pyx_t_5);
    PyTuple_SET_ITEM(__pyx_t_40, 1, __pyx_t_5);
    __pyx_t_2 = 0;
    __pyx_t_5 = 0;
    __pyx_t_5 = PyObject_GetItem(((PyObject *)__pyx_v_frame), __pyx_t_40); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1645, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;
    if (!(likely(((__pyx_t_5) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_5, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1645, __pyx_L1_error)
    __pyx_t_61 = ((PyArrayObject *)__pyx_t_5);
    {
      __Pyx_BufFmt_StackElem __pyx_stack[1];
      __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_box.rcbuffer->pybuffer);
      __pyx_t_60 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_box.rcbuffer->pybuffer, (PyObject*)__pyx_t_61, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
      if (unlikely(__pyx_t_60 < 0)) {
        PyErr_Fetch(&__pyx_t_24, &__pyx_t_23, &__pyx_t_22);
        if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_box.rcbuffer->pybuffer, (PyObject*)__pyx_v_box, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
          Py_XDECREF(__pyx_t_24); Py_XDECREF(__pyx_t_23); Py_XDECREF(__pyx_t_22);
          __Pyx_RaiseBufferFallbackError();
        } else {
          PyErr_Restore(__pyx_t_24, __pyx_t_23, __pyx_t_22);
        }
      }
      __pyx_pybuffernd_box.diminfo[0].strides = __pyx_pybuffernd_box.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_box.diminfo[0].shape = __pyx_pybuffernd_box.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_box.diminfo[1].strides = __pyx_pybuffernd_box.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_box.diminfo[1].shape = __pyx_pybuffernd_box.rcbuffer->pybuffer.shape[1];
      if (unlikely(__pyx_t_60 < 0)) __PYX_ERR(0, 1645, __pyx_L1_error)
    }
    __pyx_t_61 = 0;
    __Pyx_XDECREF_SET(__pyx_v_box, ((PyArrayObject *)__pyx_t_5));
    __pyx_t_5 = 0;

    /* "orb/cutils.pyx":1649
 *         # the 3 most intense pixels are skipped to determine the max
 *         # in the box to avoid errors due to a cosmic ray.
 *         amp_guess[istar] = bn.nanmax(             # <<<<<<<<<<<<<<
 *             (np.sort(box.flatten()))[:-3])
 * 
 */
    __pyx_t_40 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1649, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_40);
    __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_40, __pyx_n_s_nanmax); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1649, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;

    /* "orb/cutils.pyx":1650
 *         # in the box to avoid errors due to a cosmic ray.
 *         amp_guess[istar] = bn.nanmax(
 *             (np.sort(box.flatten()))[:-3])             # <<<<<<<<<<<<<<
 * 
 *         # define 'sky pixels'
 */
    __pyx_t_3 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1650, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_sort); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1650, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __pyx_t_44 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_box), __pyx_n_s_flatten); if (unlikely(!__pyx_t_44)) __PYX_ERR(0, 1650, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_44);
    __pyx_t_43 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && likely(PyMethod_Check(__pyx_t_44))) {
      __pyx_t_43 = PyMethod_GET_SELF(__pyx_t_44);
      if (likely(__pyx_t_43)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_44);
        __Pyx_INCREF(__pyx_t_43);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_44, function);
      }
    }
    if (__pyx_t_43) {
      __pyx_t_3 = __Pyx_PyObject_CallOneArg(__pyx_t_44, __pyx_t_43); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1650, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_43); __pyx_t_43 = 0;
    } else {
      __pyx_t_3 = __Pyx_PyObject_CallNoArg(__pyx_t_44); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1650, __pyx_L1_error)
    }
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_DECREF(__pyx_t_44); __pyx_t_44 = 0;
    __pyx_t_44 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_4))) {
      __pyx_t_44 = PyMethod_GET_SELF(__pyx_t_4);
      if (likely(__pyx_t_44)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
        __Pyx_INCREF(__pyx_t_44);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_4, function);
      }
    }
    if (!__pyx_t_44) {
      __pyx_t_40 = __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_3); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1650, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      __Pyx_GOTREF(__pyx_t_40);
    } else {
      __pyx_t_43 = PyTuple_New(1+1); if (unlikely(!__pyx_t_43)) __PYX_ERR(0, 1650, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_43);
      __Pyx_GIVEREF(__pyx_t_44); PyTuple_SET_ITEM(__pyx_t_43, 0, __pyx_t_44); __pyx_t_44 = NULL;
      __Pyx_GIVEREF(__pyx_t_3);
      PyTuple_SET_ITEM(__pyx_t_43, 0+1, __pyx_t_3);
      __pyx_t_3 = 0;
      __pyx_t_40 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_43, NULL); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1650, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_40);
      __Pyx_DECREF(__pyx_t_43); __pyx_t_43 = 0;
    }
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_t_4 = __Pyx_PyObject_GetSlice(__pyx_t_40, 0, -3L, NULL, NULL, &__pyx_slice__103, 0, 1, 1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1650, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;
    __pyx_t_40 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_2))) {
      __pyx_t_40 = PyMethod_GET_SELF(__pyx_t_2);
      if (likely(__pyx_t_40)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
        __Pyx_INCREF(__pyx_t_40);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_2, function);
      }
    }
    if (!__pyx_t_40) {
      __pyx_t_5 = __Pyx_PyObject_CallOneArg(__pyx_t_2, __pyx_t_4); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1649, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __Pyx_GOTREF(__pyx_t_5);
    } else {
      __pyx_t_43 = PyTuple_New(1+1); if (unlikely(!__pyx_t_43)) __PYX_ERR(0, 1649, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_43);
      __Pyx_GIVEREF(__pyx_t_40); PyTuple_SET_ITEM(__pyx_t_43, 0, __pyx_t_40); __pyx_t_40 = NULL;
      __Pyx_GIVEREF(__pyx_t_4);
      PyTuple_SET_ITEM(__pyx_t_43, 0+1, __pyx_t_4);
      __pyx_t_4 = 0;
      __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_43, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1649, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __Pyx_DECREF(__pyx_t_43); __pyx_t_43 = 0;
    }
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;

    /* "orb/cutils.pyx":1649
 *         # the 3 most intense pixels are skipped to determine the max
 *         # in the box to avoid errors due to a cosmic ray.
 *         amp_guess[istar] = bn.nanmax(             # <<<<<<<<<<<<<<
 *             (np.sort(box.flatten()))[:-3])
 * 
 */
    __pyx_t_62 = __pyx_PyFloat_AsDouble(__pyx_t_5); if (unlikely((__pyx_t_62 == (npy_float64)-1) && PyErr_Occurred())) __PYX_ERR(0, 1649, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    __pyx_t_63 = __pyx_v_istar;
    __pyx_t_60 = -1;
    if (__pyx_t_63 < 0) {
      __pyx_t_63 += __pyx_pybuffernd_amp_guess.diminfo[0].shape;
      if (unlikely(__pyx_t_63 < 0)) __pyx_t_60 = 0;
    } else if (unlikely(__pyx_t_63 >= __pyx_pybuffernd_amp_guess.diminfo[0].shape)) __pyx_t_60 = 0;
    if (unlikely(__pyx_t_60 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_60);
      __PYX_ERR(0, 1649, __pyx_L1_error)
    }
    *__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_amp_guess.rcbuffer->pybuffer.buf, __pyx_t_63, __pyx_pybuffernd_amp_guess.diminfo[0].strides) = __pyx_t_62;

    /* "orb/cutils.pyx":1653
 * 
 *         # define 'sky pixels'
 *         S_sky = surface_value(             # <<<<<<<<<<<<<<
 *             box.shape[0], box.shape[1],
 *             stars_p[istar,2] + cov_p[1] - <double> x_min,
 */
    __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_surface_value); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1653, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);

    /* "orb/cutils.pyx":1654
 *         # define 'sky pixels'
 *         S_sky = surface_value(
 *             box.shape[0], box.shape[1],             # <<<<<<<<<<<<<<
 *             stars_p[istar,2] + cov_p[1] - <double> x_min,
 *             stars_p[istar,3] + cov_p[2] - <double> y_min,
 */
    __pyx_t_43 = __Pyx_PyInt_From_Py_intptr_t((__pyx_v_box->dimensions[0])); if (unlikely(!__pyx_t_43)) __PYX_ERR(0, 1654, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_43);
    __pyx_t_4 = __Pyx_PyInt_From_Py_intptr_t((__pyx_v_box->dimensions[1])); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1654, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);

    /* "orb/cutils.pyx":1655
 *         S_sky = surface_value(
 *             box.shape[0], box.shape[1],
 *             stars_p[istar,2] + cov_p[1] - <double> x_min,             # <<<<<<<<<<<<<<
 *             stars_p[istar,3] + cov_p[2] - <double> y_min,
 *             FWHM_SKY_COEFF * np.nanmedian(
 */
    __pyx_t_64 = __pyx_v_istar;
    __pyx_t_65 = 2;
    __pyx_t_60 = -1;
    if (__pyx_t_64 < 0) {
      __pyx_t_64 += __pyx_pybuffernd_stars_p.diminfo[0].shape;
      if (unlikely(__pyx_t_64 < 0)) __pyx_t_60 = 0;
    } else if (unlikely(__pyx_t_64 >= __pyx_pybuffernd_stars_p.diminfo[0].shape)) __pyx_t_60 = 0;
    if (__pyx_t_65 < 0) {
      __pyx_t_65 += __pyx_pybuffernd_stars_p.diminfo[1].shape;
      if (unlikely(__pyx_t_65 < 0)) __pyx_t_60 = 1;
    } else if (unlikely(__pyx_t_65 >= __pyx_pybuffernd_stars_p.diminfo[1].shape)) __pyx_t_60 = 1;
    if (unlikely(__pyx_t_60 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_60);
      __PYX_ERR(0, 1655, __pyx_L1_error)
    }
    __pyx_t_66 = 1;
    __pyx_t_60 = -1;
    if (__pyx_t_66 < 0) {
      __pyx_t_66 += __pyx_pybuffernd_cov_p.diminfo[0].shape;
      if (unlikely(__pyx_t_66 < 0)) __pyx_t_60 = 0;
    } else if (unlikely(__pyx_t_66 >= __pyx_pybuffernd_cov_p.diminfo[0].shape)) __pyx_t_60 = 0;
    if (unlikely(__pyx_t_60 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_60);
      __PYX_ERR(0, 1655, __pyx_L1_error)
    }
    __pyx_t_40 = PyFloat_FromDouble((((*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_stars_p.rcbuffer->pybuffer.buf, __pyx_t_64, __pyx_pybuffernd_stars_p.diminfo[0].strides, __pyx_t_65, __pyx_pybuffernd_stars_p.diminfo[1].strides)) + (*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.buf, __pyx_t_66, __pyx_pybuffernd_cov_p.diminfo[0].strides))) - ((double)__pyx_v_x_min))); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1655, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_40);

    /* "orb/cutils.pyx":1656
 *             box.shape[0], box.shape[1],
 *             stars_p[istar,2] + cov_p[1] - <double> x_min,
 *             stars_p[istar,3] + cov_p[2] - <double> y_min,             # <<<<<<<<<<<<<<
 *             FWHM_SKY_COEFF * np.nanmedian(
 *                 fwhm_guess),
 */
    __pyx_t_67 = __pyx_v_istar;
    __pyx_t_68 = 3;
    __pyx_t_60 = -1;
    if (__pyx_t_67 < 0) {
      __pyx_t_67 += __pyx_pybuffernd_stars_p.diminfo[0].shape;
      if (unlikely(__pyx_t_67 < 0)) __pyx_t_60 = 0;
    } else if (unlikely(__pyx_t_67 >= __pyx_pybuffernd_stars_p.diminfo[0].shape)) __pyx_t_60 = 0;
    if (__pyx_t_68 < 0) {
      __pyx_t_68 += __pyx_pybuffernd_stars_p.diminfo[1].shape;
      if (unlikely(__pyx_t_68 < 0)) __pyx_t_60 = 1;
    } else if (unlikely(__pyx_t_68 >= __pyx_pybuffernd_stars_p.diminfo[1].shape)) __pyx_t_60 = 1;
    if (unlikely(__pyx_t_60 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_60);
      __PYX_ERR(0, 1656, __pyx_L1_error)
    }
    __pyx_t_69 = 2;
    __pyx_t_60 = -1;
    if (__pyx_t_69 < 0) {
      __pyx_t_69 += __pyx_pybuffernd_cov_p.diminfo[0].shape;
      if (unlikely(__pyx_t_69 < 0)) __pyx_t_60 = 0;
    } else if (unlikely(__pyx_t_69 >= __pyx_pybuffernd_cov_p.diminfo[0].shape)) __pyx_t_60 = 0;
    if (unlikely(__pyx_t_60 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_60);
      __PYX_ERR(0, 1656, __pyx_L1_error)
    }
    __pyx_t_3 = PyFloat_FromDouble((((*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_stars_p.rcbuffer->pybuffer.buf, __pyx_t_67, __pyx_pybuffernd_stars_p.diminfo[0].strides, __pyx_t_68, __pyx_pybuffernd_stars_p.diminfo[1].strides)) + (*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.buf, __pyx_t_69, __pyx_pybuffernd_cov_p.diminfo[0].strides))) - ((double)__pyx_v_y_min))); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1656, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);

    /* "orb/cutils.pyx":1657
 *             stars_p[istar,2] + cov_p[1] - <double> x_min,
 *             stars_p[istar,3] + cov_p[2] - <double> y_min,
 *             FWHM_SKY_COEFF * np.nanmedian(             # <<<<<<<<<<<<<<
 *                 fwhm_guess),
 *             np.max([box.shape[0], box.shape[1]]), SUB_DIV)
 */
    __pyx_t_44 = PyFloat_FromDouble(__pyx_v_FWHM_SKY_COEFF); if (unlikely(!__pyx_t_44)) __PYX_ERR(0, 1657, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_44);
    __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1657, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __pyx_t_70 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_nanmedian); if (unlikely(!__pyx_t_70)) __PYX_ERR(0, 1657, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_70);
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

    /* "orb/cutils.pyx":1658
 *             stars_p[istar,3] + cov_p[2] - <double> y_min,
 *             FWHM_SKY_COEFF * np.nanmedian(
 *                 fwhm_guess),             # <<<<<<<<<<<<<<
 *             np.max([box.shape[0], box.shape[1]]), SUB_DIV)
 * 
 */
    __pyx_t_1 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_70))) {
      __pyx_t_1 = PyMethod_GET_SELF(__pyx_t_70);
      if (likely(__pyx_t_1)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_70);
        __Pyx_INCREF(__pyx_t_1);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_70, function);
      }
    }
    if (!__pyx_t_1) {
      __pyx_t_42 = __Pyx_PyObject_CallOneArg(__pyx_t_70, ((PyObject *)__pyx_v_fwhm_guess)); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1657, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_42);
    } else {
      __pyx_t_71 = PyTuple_New(1+1); if (unlikely(!__pyx_t_71)) __PYX_ERR(0, 1657, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_71);
      __Pyx_GIVEREF(__pyx_t_1); PyTuple_SET_ITEM(__pyx_t_71, 0, __pyx_t_1); __pyx_t_1 = NULL;
      __Pyx_INCREF(((PyObject *)__pyx_v_fwhm_guess));
      __Pyx_GIVEREF(((PyObject *)__pyx_v_fwhm_guess));
      PyTuple_SET_ITEM(__pyx_t_71, 0+1, ((PyObject *)__pyx_v_fwhm_guess));
      __pyx_t_42 = __Pyx_PyObject_Call(__pyx_t_70, __pyx_t_71, NULL); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1657, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_42);
      __Pyx_DECREF(__pyx_t_71); __pyx_t_71 = 0;
    }
    __Pyx_DECREF(__pyx_t_70); __pyx_t_70 = 0;

    /* "orb/cutils.pyx":1657
 *             stars_p[istar,2] + cov_p[1] - <double> x_min,
 *             stars_p[istar,3] + cov_p[2] - <double> y_min,
 *             FWHM_SKY_COEFF * np.nanmedian(             # <<<<<<<<<<<<<<
 *                 fwhm_guess),
 *             np.max([box.shape[0], box.shape[1]]), SUB_DIV)
 */
    __pyx_t_70 = PyNumber_Multiply(__pyx_t_44, __pyx_t_42); if (unlikely(!__pyx_t_70)) __PYX_ERR(0, 1657, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_70);
    __Pyx_DECREF(__pyx_t_44); __pyx_t_44 = 0;
    __Pyx_DECREF(__pyx_t_42); __pyx_t_42 = 0;

    /* "orb/cutils.pyx":1659
 *             FWHM_SKY_COEFF * np.nanmedian(
 *                 fwhm_guess),
 *             np.max([box.shape[0], box.shape[1]]), SUB_DIV)             # <<<<<<<<<<<<<<
 * 
 *         sky_pixels = box * S_sky
 */
    __pyx_t_44 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_44)) __PYX_ERR(0, 1659, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_44);
    __pyx_t_71 = __Pyx_PyObject_GetAttrStr(__pyx_t_44, __pyx_n_s_max); if (unlikely(!__pyx_t_71)) __PYX_ERR(0, 1659, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_71);
    __Pyx_DECREF(__pyx_t_44); __pyx_t_44 = 0;
    __pyx_t_44 = __Pyx_PyInt_From_Py_intptr_t((__pyx_v_box->dimensions[0])); if (unlikely(!__pyx_t_44)) __PYX_ERR(0, 1659, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_44);
    __pyx_t_1 = __Pyx_PyInt_From_Py_intptr_t((__pyx_v_box->dimensions[1])); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1659, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __pyx_t_72 = PyList_New(2); if (unlikely(!__pyx_t_72)) __PYX_ERR(0, 1659, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_72);
    __Pyx_GIVEREF(__pyx_t_44);
    PyList_SET_ITEM(__pyx_t_72, 0, __pyx_t_44);
    __Pyx_GIVEREF(__pyx_t_1);
    PyList_SET_ITEM(__pyx_t_72, 1, __pyx_t_1);
    __pyx_t_44 = 0;
    __pyx_t_1 = 0;
    __pyx_t_1 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_71))) {
      __pyx_t_1 = PyMethod_GET_SELF(__pyx_t_71);
      if (likely(__pyx_t_1)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_71);
        __Pyx_INCREF(__pyx_t_1);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_71, function);
      }
    }
    if (!__pyx_t_1) {
      __pyx_t_42 = __Pyx_PyObject_CallOneArg(__pyx_t_71, __pyx_t_72); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1659, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_72); __pyx_t_72 = 0;
      __Pyx_GOTREF(__pyx_t_42);
    } else {
      __pyx_t_44 = PyTuple_New(1+1); if (unlikely(!__pyx_t_44)) __PYX_ERR(0, 1659, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_44);
      __Pyx_GIVEREF(__pyx_t_1); PyTuple_SET_ITEM(__pyx_t_44, 0, __pyx_t_1); __pyx_t_1 = NULL;
      __Pyx_GIVEREF(__pyx_t_72);
      PyTuple_SET_ITEM(__pyx_t_44, 0+1, __pyx_t_72);
      __pyx_t_72 = 0;
      __pyx_t_42 = __Pyx_PyObject_Call(__pyx_t_71, __pyx_t_44, NULL); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1659, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_42);
      __Pyx_DECREF(__pyx_t_44); __pyx_t_44 = 0;
    }
    __Pyx_DECREF(__pyx_t_71); __pyx_t_71 = 0;
    __pyx_t_71 = __Pyx_PyInt_From_int(__pyx_v_SUB_DIV); if (unlikely(!__pyx_t_71)) __PYX_ERR(0, 1659, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_71);
    __pyx_t_44 = NULL;
    __pyx_t_46 = 0;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_2))) {
      __pyx_t_44 = PyMethod_GET_SELF(__pyx_t_2);
      if (likely(__pyx_t_44)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
        __Pyx_INCREF(__pyx_t_44);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_2, function);
        __pyx_t_46 = 1;
      }
    }
    __pyx_t_72 = PyTuple_New(7+__pyx_t_46); if (unlikely(!__pyx_t_72)) __PYX_ERR(0, 1653, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_72);
    if (__pyx_t_44) {
      __Pyx_GIVEREF(__pyx_t_44); PyTuple_SET_ITEM(__pyx_t_72, 0, __pyx_t_44); __pyx_t_44 = NULL;
    }
    __Pyx_GIVEREF(__pyx_t_43);
    PyTuple_SET_ITEM(__pyx_t_72, 0+__pyx_t_46, __pyx_t_43);
    __Pyx_GIVEREF(__pyx_t_4);
    PyTuple_SET_ITEM(__pyx_t_72, 1+__pyx_t_46, __pyx_t_4);
    __Pyx_GIVEREF(__pyx_t_40);
    PyTuple_SET_ITEM(__pyx_t_72, 2+__pyx_t_46, __pyx_t_40);
    __Pyx_GIVEREF(__pyx_t_3);
    PyTuple_SET_ITEM(__pyx_t_72, 3+__pyx_t_46, __pyx_t_3);
    __Pyx_GIVEREF(__pyx_t_70);
    PyTuple_SET_ITEM(__pyx_t_72, 4+__pyx_t_46, __pyx_t_70);
    __Pyx_GIVEREF(__pyx_t_42);
    PyTuple_SET_ITEM(__pyx_t_72, 5+__pyx_t_46, __pyx_t_42);
    __Pyx_GIVEREF(__pyx_t_71);
    PyTuple_SET_ITEM(__pyx_t_72, 6+__pyx_t_46, __pyx_t_71);
    __pyx_t_43 = 0;
    __pyx_t_4 = 0;
    __pyx_t_40 = 0;
    __pyx_t_3 = 0;
    __pyx_t_70 = 0;
    __pyx_t_42 = 0;
    __pyx_t_71 = 0;
    __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_72, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1653, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_DECREF(__pyx_t_72); __pyx_t_72 = 0;
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __Pyx_XDECREF_SET(__pyx_v_S_sky, __pyx_t_5);
    __pyx_t_5 = 0;

    /* "orb/cutils.pyx":1661
 *             np.max([box.shape[0], box.shape[1]]), SUB_DIV)
 * 
 *         sky_pixels = box * S_sky             # <<<<<<<<<<<<<<
 *         sky_pixels = np.sort(sky_pixels[np.nonzero(sky_pixels)])[1:-1]
 *         # guess background
 */
    __pyx_t_5 = PyNumber_Multiply(((PyObject *)__pyx_v_box), __pyx_v_S_sky); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1661, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_XDECREF_SET(__pyx_v_sky_pixels, __pyx_t_5);
    __pyx_t_5 = 0;

    /* "orb/cutils.pyx":1662
 * 
 *         sky_pixels = box * S_sky
 *         sky_pixels = np.sort(sky_pixels[np.nonzero(sky_pixels)])[1:-1]             # <<<<<<<<<<<<<<
 *         # guess background
 *         stars_p[istar,0] = bn.nanmedian(sky_pixels)
 */
    __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1662, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __pyx_t_72 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_sort); if (unlikely(!__pyx_t_72)) __PYX_ERR(0, 1662, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_72);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __pyx_t_71 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_71)) __PYX_ERR(0, 1662, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_71);
    __pyx_t_42 = __Pyx_PyObject_GetAttrStr(__pyx_t_71, __pyx_n_s_nonzero); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1662, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_42);
    __Pyx_DECREF(__pyx_t_71); __pyx_t_71 = 0;
    __pyx_t_71 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_42))) {
      __pyx_t_71 = PyMethod_GET_SELF(__pyx_t_42);
      if (likely(__pyx_t_71)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_42);
        __Pyx_INCREF(__pyx_t_71);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_42, function);
      }
    }
    if (!__pyx_t_71) {
      __pyx_t_2 = __Pyx_PyObject_CallOneArg(__pyx_t_42, __pyx_v_sky_pixels); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1662, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
    } else {
      __pyx_t_70 = PyTuple_New(1+1); if (unlikely(!__pyx_t_70)) __PYX_ERR(0, 1662, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_70);
      __Pyx_GIVEREF(__pyx_t_71); PyTuple_SET_ITEM(__pyx_t_70, 0, __pyx_t_71); __pyx_t_71 = NULL;
      __Pyx_INCREF(__pyx_v_sky_pixels);
      __Pyx_GIVEREF(__pyx_v_sky_pixels);
      PyTuple_SET_ITEM(__pyx_t_70, 0+1, __pyx_v_sky_pixels);
      __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_42, __pyx_t_70, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1662, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __Pyx_DECREF(__pyx_t_70); __pyx_t_70 = 0;
    }
    __Pyx_DECREF(__pyx_t_42); __pyx_t_42 = 0;
    __pyx_t_42 = PyObject_GetItem(__pyx_v_sky_pixels, __pyx_t_2); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1662, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_42);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __pyx_t_2 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_72))) {
      __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_72);
      if (likely(__pyx_t_2)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_72);
        __Pyx_INCREF(__pyx_t_2);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_72, function);
      }
    }
    if (!__pyx_t_2) {
      __pyx_t_5 = __Pyx_PyObject_CallOneArg(__pyx_t_72, __pyx_t_42); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1662, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_42); __pyx_t_42 = 0;
      __Pyx_GOTREF(__pyx_t_5);
    } else {
      __pyx_t_70 = PyTuple_New(1+1); if (unlikely(!__pyx_t_70)) __PYX_ERR(0, 1662, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_70);
      __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_70, 0, __pyx_t_2); __pyx_t_2 = NULL;
      __Pyx_GIVEREF(__pyx_t_42);
      PyTuple_SET_ITEM(__pyx_t_70, 0+1, __pyx_t_42);
      __pyx_t_42 = 0;
      __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_72, __pyx_t_70, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1662, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __Pyx_DECREF(__pyx_t_70); __pyx_t_70 = 0;
    }
    __Pyx_DECREF(__pyx_t_72); __pyx_t_72 = 0;
    __pyx_t_72 = __Pyx_PyObject_GetSlice(__pyx_t_5, 1, -1L, NULL, NULL, &__pyx_slice__104, 1, 1, 1); if (unlikely(!__pyx_t_72)) __PYX_ERR(0, 1662, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_72);
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    __Pyx_DECREF_SET(__pyx_v_sky_pixels, __pyx_t_72);
    __pyx_t_72 = 0;

    /* "orb/cutils.pyx":1664
 *         sky_pixels = np.sort(sky_pixels[np.nonzero(sky_pixels)])[1:-1]
 *         # guess background
 *         stars_p[istar,0] = bn.nanmedian(sky_pixels)             # <<<<<<<<<<<<<<
 *         if np.isnan(stars_p[istar,0]): stars_p[istar,0] = 0.
 * 
 */
    __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1664, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __pyx_t_70 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_nanmedian); if (unlikely(!__pyx_t_70)) __PYX_ERR(0, 1664, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_70);
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    __pyx_t_5 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_70))) {
      __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_70);
      if (likely(__pyx_t_5)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_70);
        __Pyx_INCREF(__pyx_t_5);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_70, function);
      }
    }
    if (!__pyx_t_5) {
      __pyx_t_72 = __Pyx_PyObject_CallOneArg(__pyx_t_70, __pyx_v_sky_pixels); if (unlikely(!__pyx_t_72)) __PYX_ERR(0, 1664, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_72);
    } else {
      __pyx_t_42 = PyTuple_New(1+1); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1664, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_42);
      __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_42, 0, __pyx_t_5); __pyx_t_5 = NULL;
      __Pyx_INCREF(__pyx_v_sky_pixels);
      __Pyx_GIVEREF(__pyx_v_sky_pixels);
      PyTuple_SET_ITEM(__pyx_t_42, 0+1, __pyx_v_sky_pixels);
      __pyx_t_72 = __Pyx_PyObject_Call(__pyx_t_70, __pyx_t_42, NULL); if (unlikely(!__pyx_t_72)) __PYX_ERR(0, 1664, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_72);
      __Pyx_DECREF(__pyx_t_42); __pyx_t_42 = 0;
    }
    __Pyx_DECREF(__pyx_t_70); __pyx_t_70 = 0;
    __pyx_t_62 = __pyx_PyFloat_AsDouble(__pyx_t_72); if (unlikely((__pyx_t_62 == (npy_float64)-1) && PyErr_Occurred())) __PYX_ERR(0, 1664, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_72); __pyx_t_72 = 0;
    __pyx_t_73 = __pyx_v_istar;
    __pyx_t_74 = 0;
    __pyx_t_60 = -1;
    if (__pyx_t_73 < 0) {
      __pyx_t_73 += __pyx_pybuffernd_stars_p.diminfo[0].shape;
      if (unlikely(__pyx_t_73 < 0)) __pyx_t_60 = 0;
    } else if (unlikely(__pyx_t_73 >= __pyx_pybuffernd_stars_p.diminfo[0].shape)) __pyx_t_60 = 0;
    if (__pyx_t_74 < 0) {
      __pyx_t_74 += __pyx_pybuffernd_stars_p.diminfo[1].shape;
      if (unlikely(__pyx_t_74 < 0)) __pyx_t_60 = 1;
    } else if (unlikely(__pyx_t_74 >= __pyx_pybuffernd_stars_p.diminfo[1].shape)) __pyx_t_60 = 1;
    if (unlikely(__pyx_t_60 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_60);
      __PYX_ERR(0, 1664, __pyx_L1_error)
    }
    *__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_stars_p.rcbuffer->pybuffer.buf, __pyx_t_73, __pyx_pybuffernd_stars_p.diminfo[0].strides, __pyx_t_74, __pyx_pybuffernd_stars_p.diminfo[1].strides) = __pyx_t_62;

    /* "orb/cutils.pyx":1665
 *         # guess background
 *         stars_p[istar,0] = bn.nanmedian(sky_pixels)
 *         if np.isnan(stars_p[istar,0]): stars_p[istar,0] = 0.             # <<<<<<<<<<<<<<
 * 
 *         # guess noise
 */
    __pyx_t_70 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_70)) __PYX_ERR(0, 1665, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_70);
    __pyx_t_42 = __Pyx_PyObject_GetAttrStr(__pyx_t_70, __pyx_n_s_isnan); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1665, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_42);
    __Pyx_DECREF(__pyx_t_70); __pyx_t_70 = 0;
    __pyx_t_75 = __pyx_v_istar;
    __pyx_t_76 = 0;
    __pyx_t_60 = -1;
    if (__pyx_t_75 < 0) {
      __pyx_t_75 += __pyx_pybuffernd_stars_p.diminfo[0].shape;
      if (unlikely(__pyx_t_75 < 0)) __pyx_t_60 = 0;
    } else if (unlikely(__pyx_t_75 >= __pyx_pybuffernd_stars_p.diminfo[0].shape)) __pyx_t_60 = 0;
    if (__pyx_t_76 < 0) {
      __pyx_t_76 += __pyx_pybuffernd_stars_p.diminfo[1].shape;
      if (unlikely(__pyx_t_76 < 0)) __pyx_t_60 = 1;
    } else if (unlikely(__pyx_t_76 >= __pyx_pybuffernd_stars_p.diminfo[1].shape)) __pyx_t_60 = 1;
    if (unlikely(__pyx_t_60 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_60);
      __PYX_ERR(0, 1665, __pyx_L1_error)
    }
    __pyx_t_70 = PyFloat_FromDouble((*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_stars_p.rcbuffer->pybuffer.buf, __pyx_t_75, __pyx_pybuffernd_stars_p.diminfo[0].strides, __pyx_t_76, __pyx_pybuffernd_stars_p.diminfo[1].strides))); if (unlikely(!__pyx_t_70)) __PYX_ERR(0, 1665, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_70);
    __pyx_t_5 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_42))) {
      __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_42);
      if (likely(__pyx_t_5)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_42);
        __Pyx_INCREF(__pyx_t_5);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_42, function);
      }
    }
    if (!__pyx_t_5) {
      __pyx_t_72 = __Pyx_PyObject_CallOneArg(__pyx_t_42, __pyx_t_70); if (unlikely(!__pyx_t_72)) __PYX_ERR(0, 1665, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_70); __pyx_t_70 = 0;
      __Pyx_GOTREF(__pyx_t_72);
    } else {
      __pyx_t_2 = PyTuple_New(1+1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1665, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_5); __pyx_t_5 = NULL;
      __Pyx_GIVEREF(__pyx_t_70);
      PyTuple_SET_ITEM(__pyx_t_2, 0+1, __pyx_t_70);
      __pyx_t_70 = 0;
      __pyx_t_72 = __Pyx_PyObject_Call(__pyx_t_42, __pyx_t_2, NULL); if (unlikely(!__pyx_t_72)) __PYX_ERR(0, 1665, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_72);
      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    }
    __Pyx_DECREF(__pyx_t_42); __pyx_t_42 = 0;
    __pyx_t_9 = __Pyx_PyObject_IsTrue(__pyx_t_72); if (unlikely(__pyx_t_9 < 0)) __PYX_ERR(0, 1665, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_72); __pyx_t_72 = 0;
    if (__pyx_t_9) {
      __pyx_t_77 = __pyx_v_istar;
      __pyx_t_78 = 0;
      __pyx_t_60 = -1;
      if (__pyx_t_77 < 0) {
        __pyx_t_77 += __pyx_pybuffernd_stars_p.diminfo[0].shape;
        if (unlikely(__pyx_t_77 < 0)) __pyx_t_60 = 0;
      } else if (unlikely(__pyx_t_77 >= __pyx_pybuffernd_stars_p.diminfo[0].shape)) __pyx_t_60 = 0;
      if (__pyx_t_78 < 0) {
        __pyx_t_78 += __pyx_pybuffernd_stars_p.diminfo[1].shape;
        if (unlikely(__pyx_t_78 < 0)) __pyx_t_60 = 1;
      } else if (unlikely(__pyx_t_78 >= __pyx_pybuffernd_stars_p.diminfo[1].shape)) __pyx_t_60 = 1;
      if (unlikely(__pyx_t_60 != -1)) {
        __Pyx_RaiseBufferIndexError(__pyx_t_60);
        __PYX_ERR(0, 1665, __pyx_L1_error)
      }
      *__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_stars_p.rcbuffer->pybuffer.buf, __pyx_t_77, __pyx_pybuffernd_stars_p.diminfo[0].strides, __pyx_t_78, __pyx_pybuffernd_stars_p.diminfo[1].strides) = 0.;
    }

    /* "orb/cutils.pyx":1668
 * 
 *         # guess noise
 *         noise_guess[istar] = bn.nanstd(sky_pixels) #- sqrt(stars_p[istar,0])             # <<<<<<<<<<<<<<
 * 
 *     if not np.isnan(height_guess):
 */
    __pyx_t_42 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1668, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_42);
    __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_42, __pyx_n_s_nanstd); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1668, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_DECREF(__pyx_t_42); __pyx_t_42 = 0;
    __pyx_t_42 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_2))) {
      __pyx_t_42 = PyMethod_GET_SELF(__pyx_t_2);
      if (likely(__pyx_t_42)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
        __Pyx_INCREF(__pyx_t_42);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_2, function);
      }
    }
    if (!__pyx_t_42) {
      __pyx_t_72 = __Pyx_PyObject_CallOneArg(__pyx_t_2, __pyx_v_sky_pixels); if (unlikely(!__pyx_t_72)) __PYX_ERR(0, 1668, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_72);
    } else {
      __pyx_t_70 = PyTuple_New(1+1); if (unlikely(!__pyx_t_70)) __PYX_ERR(0, 1668, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_70);
      __Pyx_GIVEREF(__pyx_t_42); PyTuple_SET_ITEM(__pyx_t_70, 0, __pyx_t_42); __pyx_t_42 = NULL;
      __Pyx_INCREF(__pyx_v_sky_pixels);
      __Pyx_GIVEREF(__pyx_v_sky_pixels);
      PyTuple_SET_ITEM(__pyx_t_70, 0+1, __pyx_v_sky_pixels);
      __pyx_t_72 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_70, NULL); if (unlikely(!__pyx_t_72)) __PYX_ERR(0, 1668, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_72);
      __Pyx_DECREF(__pyx_t_70); __pyx_t_70 = 0;
    }
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __pyx_t_62 = __pyx_PyFloat_AsDouble(__pyx_t_72); if (unlikely((__pyx_t_62 == (npy_float64)-1) && PyErr_Occurred())) __PYX_ERR(0, 1668, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_72); __pyx_t_72 = 0;
    __pyx_t_79 = __pyx_v_istar;
    __pyx_t_60 = -1;
    if (__pyx_t_79 < 0) {
      __pyx_t_79 += __pyx_pybuffernd_noise_guess.diminfo[0].shape;
      if (unlikely(__pyx_t_79 < 0)) __pyx_t_60 = 0;
    } else if (unlikely(__pyx_t_79 >= __pyx_pybuffernd_noise_guess.diminfo[0].shape)) __pyx_t_60 = 0;
    if (unlikely(__pyx_t_60 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_60);
      __PYX_ERR(0, 1668, __pyx_L1_error)
    }
    *__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_noise_guess.rcbuffer->pybuffer.buf, __pyx_t_79, __pyx_pybuffernd_noise_guess.diminfo[0].strides) = __pyx_t_62;
  }

  /* "orb/cutils.pyx":1670
 *         noise_guess[istar] = bn.nanstd(sky_pixels) #- sqrt(stars_p[istar,0])
 * 
 *     if not np.isnan(height_guess):             # <<<<<<<<<<<<<<
 *         stars_p[:,0] = height_guess
 * 
 */
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1670, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_70 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_isnan); if (unlikely(!__pyx_t_70)) __PYX_ERR(0, 1670, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_70);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = PyFloat_FromDouble(__pyx_v_height_guess); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1670, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_42 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_70))) {
    __pyx_t_42 = PyMethod_GET_SELF(__pyx_t_70);
    if (likely(__pyx_t_42)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_70);
      __Pyx_INCREF(__pyx_t_42);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_70, function);
    }
  }
  if (!__pyx_t_42) {
    __pyx_t_72 = __Pyx_PyObject_CallOneArg(__pyx_t_70, __pyx_t_2); if (unlikely(!__pyx_t_72)) __PYX_ERR(0, 1670, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __Pyx_GOTREF(__pyx_t_72);
  } else {
    __pyx_t_5 = PyTuple_New(1+1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1670, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_GIVEREF(__pyx_t_42); PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_42); __pyx_t_42 = NULL;
    __Pyx_GIVEREF(__pyx_t_2);
    PyTuple_SET_ITEM(__pyx_t_5, 0+1, __pyx_t_2);
    __pyx_t_2 = 0;
    __pyx_t_72 = __Pyx_PyObject_Call(__pyx_t_70, __pyx_t_5, NULL); if (unlikely(!__pyx_t_72)) __PYX_ERR(0, 1670, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_72);
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  }
  __Pyx_DECREF(__pyx_t_70); __pyx_t_70 = 0;
  __pyx_t_9 = __Pyx_PyObject_IsTrue(__pyx_t_72); if (unlikely(__pyx_t_9 < 0)) __PYX_ERR(0, 1670, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_72); __pyx_t_72 = 0;
  __pyx_t_13 = ((!__pyx_t_9) != 0);
  if (__pyx_t_13) {

    /* "orb/cutils.pyx":1671
 * 
 *     if not np.isnan(height_guess):
 *         stars_p[:,0] = height_guess             # <<<<<<<<<<<<<<
 * 
 *     # height guess
 */
    __pyx_t_72 = PyFloat_FromDouble(__pyx_v_height_guess); if (unlikely(!__pyx_t_72)) __PYX_ERR(0, 1671, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_72);
    if (unlikely(PyObject_SetItem(((PyObject *)__pyx_v_stars_p), __pyx_tuple__106, __pyx_t_72) < 0)) __PYX_ERR(0, 1671, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_72); __pyx_t_72 = 0;

    /* "orb/cutils.pyx":1670
 *         noise_guess[istar] = bn.nanstd(sky_pixels) #- sqrt(stars_p[istar,0])
 * 
 *     if not np.isnan(height_guess):             # <<<<<<<<<<<<<<
 *         stars_p[:,0] = height_guess
 * 
 */
  }

  /* "orb/cutils.pyx":1674
 * 
 *     # height guess
 *     amp_guess[np.isnan(amp_guess)] = 1.             # <<<<<<<<<<<<<<
 *     stars_p[:,1] = amp_guess - stars_p[:,0]
 * 
 */
  __pyx_t_70 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_70)) __PYX_ERR(0, 1674, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_70);
  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_70, __pyx_n_s_isnan); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1674, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_70); __pyx_t_70 = 0;
  __pyx_t_70 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_5))) {
    __pyx_t_70 = PyMethod_GET_SELF(__pyx_t_5);
    if (likely(__pyx_t_70)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_5);
      __Pyx_INCREF(__pyx_t_70);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_5, function);
    }
  }
  if (!__pyx_t_70) {
    __pyx_t_72 = __Pyx_PyObject_CallOneArg(__pyx_t_5, ((PyObject *)__pyx_v_amp_guess)); if (unlikely(!__pyx_t_72)) __PYX_ERR(0, 1674, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_72);
  } else {
    __pyx_t_2 = PyTuple_New(1+1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1674, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_GIVEREF(__pyx_t_70); PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_70); __pyx_t_70 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_amp_guess));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_amp_guess));
    PyTuple_SET_ITEM(__pyx_t_2, 0+1, ((PyObject *)__pyx_v_amp_guess));
    __pyx_t_72 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_2, NULL); if (unlikely(!__pyx_t_72)) __PYX_ERR(0, 1674, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_72);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  }
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  if (unlikely(PyObject_SetItem(((PyObject *)__pyx_v_amp_guess), __pyx_t_72, __pyx_float_1_) < 0)) __PYX_ERR(0, 1674, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_72); __pyx_t_72 = 0;

  /* "orb/cutils.pyx":1675
 *     # height guess
 *     amp_guess[np.isnan(amp_guess)] = 1.
 *     stars_p[:,1] = amp_guess - stars_p[:,0]             # <<<<<<<<<<<<<<
 * 
 *     if bn.anynan(stars_p): return []
 */
  __pyx_t_72 = PyObject_GetItem(((PyObject *)__pyx_v_stars_p), __pyx_tuple__108); if (unlikely(!__pyx_t_72)) __PYX_ERR(0, 1675, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_72);
  __pyx_t_5 = PyNumber_Subtract(((PyObject *)__pyx_v_amp_guess), __pyx_t_72); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1675, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_72); __pyx_t_72 = 0;
  if (unlikely(PyObject_SetItem(((PyObject *)__pyx_v_stars_p), __pyx_tuple__110, __pyx_t_5) < 0)) __PYX_ERR(0, 1675, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

  /* "orb/cutils.pyx":1677
 *     stars_p[:,1] = amp_guess - stars_p[:,0]
 * 
 *     if bn.anynan(stars_p): return []             # <<<<<<<<<<<<<<
 * 
 *     # guess ron and dcl
 */
  __pyx_t_72 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_72)) __PYX_ERR(0, 1677, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_72);
  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_72, __pyx_n_s_anynan); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1677, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_72); __pyx_t_72 = 0;
  __pyx_t_72 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_2))) {
    __pyx_t_72 = PyMethod_GET_SELF(__pyx_t_2);
    if (likely(__pyx_t_72)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
      __Pyx_INCREF(__pyx_t_72);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_2, function);
    }
  }
  if (!__pyx_t_72) {
    __pyx_t_5 = __Pyx_PyObject_CallOneArg(__pyx_t_2, ((PyObject *)__pyx_v_stars_p)); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1677, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
  } else {
    __pyx_t_70 = PyTuple_New(1+1); if (unlikely(!__pyx_t_70)) __PYX_ERR(0, 1677, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_70);
    __Pyx_GIVEREF(__pyx_t_72); PyTuple_SET_ITEM(__pyx_t_70, 0, __pyx_t_72); __pyx_t_72 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_stars_p));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_stars_p));
    PyTuple_SET_ITEM(__pyx_t_70, 0+1, ((PyObject *)__pyx_v_stars_p));
    __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_70, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1677, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_DECREF(__pyx_t_70); __pyx_t_70 = 0;
  }
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_13 = __Pyx_PyObject_IsTrue(__pyx_t_5); if (unlikely(__pyx_t_13 < 0)) __PYX_ERR(0, 1677, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  if (__pyx_t_13) {
    __Pyx_XDECREF(__pyx_r);
    __pyx_t_5 = PyList_New(0); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1677, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __pyx_r = __pyx_t_5;
    __pyx_t_5 = 0;
    goto __pyx_L0;
  }

  /* "orb/cutils.pyx":1680
 * 
 *     # guess ron and dcl
 *     if not np.isnan(ron) and not estimate_local_noise:             # <<<<<<<<<<<<<<
 *         noise_guess.fill(ron)
 * 
 */
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1680, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_70 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_isnan); if (unlikely(!__pyx_t_70)) __PYX_ERR(0, 1680, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_70);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = PyFloat_FromDouble(__pyx_v_ron); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1680, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_72 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_70))) {
    __pyx_t_72 = PyMethod_GET_SELF(__pyx_t_70);
    if (likely(__pyx_t_72)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_70);
      __Pyx_INCREF(__pyx_t_72);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_70, function);
    }
  }
  if (!__pyx_t_72) {
    __pyx_t_5 = __Pyx_PyObject_CallOneArg(__pyx_t_70, __pyx_t_2); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1680, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __Pyx_GOTREF(__pyx_t_5);
  } else {
    __pyx_t_42 = PyTuple_New(1+1); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1680, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_42);
    __Pyx_GIVEREF(__pyx_t_72); PyTuple_SET_ITEM(__pyx_t_42, 0, __pyx_t_72); __pyx_t_72 = NULL;
    __Pyx_GIVEREF(__pyx_t_2);
    PyTuple_SET_ITEM(__pyx_t_42, 0+1, __pyx_t_2);
    __pyx_t_2 = 0;
    __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_70, __pyx_t_42, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1680, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_DECREF(__pyx_t_42); __pyx_t_42 = 0;
  }
  __Pyx_DECREF(__pyx_t_70); __pyx_t_70 = 0;
  __pyx_t_9 = __Pyx_PyObject_IsTrue(__pyx_t_5); if (unlikely(__pyx_t_9 < 0)) __PYX_ERR(0, 1680, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_80 = ((!__pyx_t_9) != 0);
  if (__pyx_t_80) {
  } else {
    __pyx_t_13 = __pyx_t_80;
    goto __pyx_L30_bool_binop_done;
  }
  __pyx_t_80 = __Pyx_PyObject_IsTrue(((PyObject *)__pyx_v_estimate_local_noise)); if (unlikely(__pyx_t_80 < 0)) __PYX_ERR(0, 1680, __pyx_L1_error)
  __pyx_t_9 = ((!__pyx_t_80) != 0);
  __pyx_t_13 = __pyx_t_9;
  __pyx_L30_bool_binop_done:;
  if (__pyx_t_13) {

    /* "orb/cutils.pyx":1681
 *     # guess ron and dcl
 *     if not np.isnan(ron) and not estimate_local_noise:
 *         noise_guess.fill(ron)             # <<<<<<<<<<<<<<
 * 
 *     if np.isnan(dcl) or estimate_local_noise:
 */
    __pyx_t_70 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_noise_guess), __pyx_n_s_fill); if (unlikely(!__pyx_t_70)) __PYX_ERR(0, 1681, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_70);
    __pyx_t_42 = PyFloat_FromDouble(__pyx_v_ron); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1681, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_42);
    __pyx_t_2 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && likely(PyMethod_Check(__pyx_t_70))) {
      __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_70);
      if (likely(__pyx_t_2)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_70);
        __Pyx_INCREF(__pyx_t_2);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_70, function);
      }
    }
    if (!__pyx_t_2) {
      __pyx_t_5 = __Pyx_PyObject_CallOneArg(__pyx_t_70, __pyx_t_42); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1681, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_42); __pyx_t_42 = 0;
      __Pyx_GOTREF(__pyx_t_5);
    } else {
      __pyx_t_72 = PyTuple_New(1+1); if (unlikely(!__pyx_t_72)) __PYX_ERR(0, 1681, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_72);
      __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_72, 0, __pyx_t_2); __pyx_t_2 = NULL;
      __Pyx_GIVEREF(__pyx_t_42);
      PyTuple_SET_ITEM(__pyx_t_72, 0+1, __pyx_t_42);
      __pyx_t_42 = 0;
      __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_70, __pyx_t_72, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1681, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __Pyx_DECREF(__pyx_t_72); __pyx_t_72 = 0;
    }
    __Pyx_DECREF(__pyx_t_70); __pyx_t_70 = 0;
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

    /* "orb/cutils.pyx":1680
 * 
 *     # guess ron and dcl
 *     if not np.isnan(ron) and not estimate_local_noise:             # <<<<<<<<<<<<<<
 *         noise_guess.fill(ron)
 * 
 */
  }

  /* "orb/cutils.pyx":1683
 *         noise_guess.fill(ron)
 * 
 *     if np.isnan(dcl) or estimate_local_noise:             # <<<<<<<<<<<<<<
 *         dcl = 0.
 * 
 */
  __pyx_t_70 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_70)) __PYX_ERR(0, 1683, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_70);
  __pyx_t_72 = __Pyx_PyObject_GetAttrStr(__pyx_t_70, __pyx_n_s_isnan); if (unlikely(!__pyx_t_72)) __PYX_ERR(0, 1683, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_72);
  __Pyx_DECREF(__pyx_t_70); __pyx_t_70 = 0;
  __pyx_t_70 = PyFloat_FromDouble(__pyx_v_dcl); if (unlikely(!__pyx_t_70)) __PYX_ERR(0, 1683, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_70);
  __pyx_t_42 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_72))) {
    __pyx_t_42 = PyMethod_GET_SELF(__pyx_t_72);
    if (likely(__pyx_t_42)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_72);
      __Pyx_INCREF(__pyx_t_42);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_72, function);
    }
  }
  if (!__pyx_t_42) {
    __pyx_t_5 = __Pyx_PyObject_CallOneArg(__pyx_t_72, __pyx_t_70); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1683, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_70); __pyx_t_70 = 0;
    __Pyx_GOTREF(__pyx_t_5);
  } else {
    __pyx_t_2 = PyTuple_New(1+1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1683, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_GIVEREF(__pyx_t_42); PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_42); __pyx_t_42 = NULL;
    __Pyx_GIVEREF(__pyx_t_70);
    PyTuple_SET_ITEM(__pyx_t_2, 0+1, __pyx_t_70);
    __pyx_t_70 = 0;
    __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_72, __pyx_t_2, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1683, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  }
  __Pyx_DECREF(__pyx_t_72); __pyx_t_72 = 0;
  __pyx_t_9 = __Pyx_PyObject_IsTrue(__pyx_t_5); if (unlikely(__pyx_t_9 < 0)) __PYX_ERR(0, 1683, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  if (!__pyx_t_9) {
  } else {
    __pyx_t_13 = __pyx_t_9;
    goto __pyx_L33_bool_binop_done;
  }
  __pyx_t_9 = __Pyx_PyObject_IsTrue(((PyObject *)__pyx_v_estimate_local_noise)); if (unlikely(__pyx_t_9 < 0)) __PYX_ERR(0, 1683, __pyx_L1_error)
  __pyx_t_13 = __pyx_t_9;
  __pyx_L33_bool_binop_done:;
  if (__pyx_t_13) {

    /* "orb/cutils.pyx":1684
 * 
 *     if np.isnan(dcl) or estimate_local_noise:
 *         dcl = 0.             # <<<<<<<<<<<<<<
 * 
 *     # define masks and init cov_p
 */
    __pyx_v_dcl = 0.;

    /* "orb/cutils.pyx":1683
 *         noise_guess.fill(ron)
 * 
 *     if np.isnan(dcl) or estimate_local_noise:             # <<<<<<<<<<<<<<
 *         dcl = 0.
 * 
 */
  }

  /* "orb/cutils.pyx":1687
 * 
 *     # define masks and init cov_p
 *     cov_p_mask.fill(0)             # <<<<<<<<<<<<<<
 *     stars_p_mask.fill(1)
 *     cov_p[3] = 1. # cov fwhm starts at 1 for a quadratic sum
 */
  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_cov_p_mask), __pyx_n_s_fill); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1687, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_72 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_tuple__111, NULL); if (unlikely(!__pyx_t_72)) __PYX_ERR(0, 1687, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_72);
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __Pyx_DECREF(__pyx_t_72); __pyx_t_72 = 0;

  /* "orb/cutils.pyx":1688
 *     # define masks and init cov_p
 *     cov_p_mask.fill(0)
 *     stars_p_mask.fill(1)             # <<<<<<<<<<<<<<
 *     cov_p[3] = 1. # cov fwhm starts at 1 for a quadratic sum
 *     cov_p[4] = 1.
 */
  __pyx_t_72 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_stars_p_mask), __pyx_n_s_fill); if (unlikely(!__pyx_t_72)) __PYX_ERR(0, 1688, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_72);
  __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_72, __pyx_tuple__112, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1688, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_72); __pyx_t_72 = 0;
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

  /* "orb/cutils.pyx":1689
 *     cov_p_mask.fill(0)
 *     stars_p_mask.fill(1)
 *     cov_p[3] = 1. # cov fwhm starts at 1 for a quadratic sum             # <<<<<<<<<<<<<<
 *     cov_p[4] = 1.
 *     cov_p[5] = 1.
 */
  __pyx_t_81 = 3;
  __pyx_t_8 = -1;
  if (__pyx_t_81 < 0) {
    __pyx_t_81 += __pyx_pybuffernd_cov_p.diminfo[0].shape;
    if (unlikely(__pyx_t_81 < 0)) __pyx_t_8 = 0;
  } else if (unlikely(__pyx_t_81 >= __pyx_pybuffernd_cov_p.diminfo[0].shape)) __pyx_t_8 = 0;
  if (unlikely(__pyx_t_8 != -1)) {
    __Pyx_RaiseBufferIndexError(__pyx_t_8);
    __PYX_ERR(0, 1689, __pyx_L1_error)
  }
  *__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.buf, __pyx_t_81, __pyx_pybuffernd_cov_p.diminfo[0].strides) = 1.;

  /* "orb/cutils.pyx":1690
 *     stars_p_mask.fill(1)
 *     cov_p[3] = 1. # cov fwhm starts at 1 for a quadratic sum
 *     cov_p[4] = 1.             # <<<<<<<<<<<<<<
 *     cov_p[5] = 1.
 *     cov_p[6] = 0.
 */
  __pyx_t_82 = 4;
  __pyx_t_8 = -1;
  if (__pyx_t_82 < 0) {
    __pyx_t_82 += __pyx_pybuffernd_cov_p.diminfo[0].shape;
    if (unlikely(__pyx_t_82 < 0)) __pyx_t_8 = 0;
  } else if (unlikely(__pyx_t_82 >= __pyx_pybuffernd_cov_p.diminfo[0].shape)) __pyx_t_8 = 0;
  if (unlikely(__pyx_t_8 != -1)) {
    __Pyx_RaiseBufferIndexError(__pyx_t_8);
    __PYX_ERR(0, 1690, __pyx_L1_error)
  }
  *__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.buf, __pyx_t_82, __pyx_pybuffernd_cov_p.diminfo[0].strides) = 1.;

  /* "orb/cutils.pyx":1691
 *     cov_p[3] = 1. # cov fwhm starts at 1 for a quadratic sum
 *     cov_p[4] = 1.
 *     cov_p[5] = 1.             # <<<<<<<<<<<<<<
 *     cov_p[6] = 0.
 * 
 */
  __pyx_t_83 = 5;
  __pyx_t_8 = -1;
  if (__pyx_t_83 < 0) {
    __pyx_t_83 += __pyx_pybuffernd_cov_p.diminfo[0].shape;
    if (unlikely(__pyx_t_83 < 0)) __pyx_t_8 = 0;
  } else if (unlikely(__pyx_t_83 >= __pyx_pybuffernd_cov_p.diminfo[0].shape)) __pyx_t_8 = 0;
  if (unlikely(__pyx_t_8 != -1)) {
    __Pyx_RaiseBufferIndexError(__pyx_t_8);
    __PYX_ERR(0, 1691, __pyx_L1_error)
  }
  *__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.buf, __pyx_t_83, __pyx_pybuffernd_cov_p.diminfo[0].strides) = 1.;

  /* "orb/cutils.pyx":1692
 *     cov_p[4] = 1.
 *     cov_p[5] = 1.
 *     cov_p[6] = 0.             # <<<<<<<<<<<<<<
 * 
 *     if cov_height and not fix_height:
 */
  __pyx_t_84 = 6;
  __pyx_t_8 = -1;
  if (__pyx_t_84 < 0) {
    __pyx_t_84 += __pyx_pybuffernd_cov_p.diminfo[0].shape;
    if (unlikely(__pyx_t_84 < 0)) __pyx_t_8 = 0;
  } else if (unlikely(__pyx_t_84 >= __pyx_pybuffernd_cov_p.diminfo[0].shape)) __pyx_t_8 = 0;
  if (unlikely(__pyx_t_8 != -1)) {
    __Pyx_RaiseBufferIndexError(__pyx_t_8);
    __PYX_ERR(0, 1692, __pyx_L1_error)
  }
  *__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.buf, __pyx_t_84, __pyx_pybuffernd_cov_p.diminfo[0].strides) = 0.;

  /* "orb/cutils.pyx":1694
 *     cov_p[6] = 0.
 * 
 *     if cov_height and not fix_height:             # <<<<<<<<<<<<<<
 *         cov_p_mask[0] = 1
 *         stars_p_mask[0] = 0
 */
  __pyx_t_9 = __Pyx_PyObject_IsTrue(((PyObject *)__pyx_v_cov_height)); if (unlikely(__pyx_t_9 < 0)) __PYX_ERR(0, 1694, __pyx_L1_error)
  if (__pyx_t_9) {
  } else {
    __pyx_t_13 = __pyx_t_9;
    goto __pyx_L36_bool_binop_done;
  }
  __pyx_t_9 = __Pyx_PyObject_IsTrue(((PyObject *)__pyx_v_fix_height)); if (unlikely(__pyx_t_9 < 0)) __PYX_ERR(0, 1694, __pyx_L1_error)
  __pyx_t_80 = ((!__pyx_t_9) != 0);
  __pyx_t_13 = __pyx_t_80;
  __pyx_L36_bool_binop_done:;
  if (__pyx_t_13) {

    /* "orb/cutils.pyx":1695
 * 
 *     if cov_height and not fix_height:
 *         cov_p_mask[0] = 1             # <<<<<<<<<<<<<<
 *         stars_p_mask[0] = 0
 *     if cov_pos and not fix_pos:
 */
    __pyx_t_85 = 0;
    __pyx_t_8 = -1;
    if (__pyx_t_85 < 0) {
      __pyx_t_85 += __pyx_pybuffernd_cov_p_mask.diminfo[0].shape;
      if (unlikely(__pyx_t_85 < 0)) __pyx_t_8 = 0;
    } else if (unlikely(__pyx_t_85 >= __pyx_pybuffernd_cov_p_mask.diminfo[0].shape)) __pyx_t_8 = 0;
    if (unlikely(__pyx_t_8 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_8);
      __PYX_ERR(0, 1695, __pyx_L1_error)
    }
    *__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_cov_p_mask.rcbuffer->pybuffer.buf, __pyx_t_85, __pyx_pybuffernd_cov_p_mask.diminfo[0].strides) = 1.0;

    /* "orb/cutils.pyx":1696
 *     if cov_height and not fix_height:
 *         cov_p_mask[0] = 1
 *         stars_p_mask[0] = 0             # <<<<<<<<<<<<<<
 *     if cov_pos and not fix_pos:
 *         cov_p_mask[1:3] = 1
 */
    __pyx_t_86 = 0;
    __pyx_t_8 = -1;
    if (__pyx_t_86 < 0) {
      __pyx_t_86 += __pyx_pybuffernd_stars_p_mask.diminfo[0].shape;
      if (unlikely(__pyx_t_86 < 0)) __pyx_t_8 = 0;
    } else if (unlikely(__pyx_t_86 >= __pyx_pybuffernd_stars_p_mask.diminfo[0].shape)) __pyx_t_8 = 0;
    if (unlikely(__pyx_t_8 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_8);
      __PYX_ERR(0, 1696, __pyx_L1_error)
    }
    *__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_stars_p_mask.rcbuffer->pybuffer.buf, __pyx_t_86, __pyx_pybuffernd_stars_p_mask.diminfo[0].strides) = 0.0;

    /* "orb/cutils.pyx":1694
 *     cov_p[6] = 0.
 * 
 *     if cov_height and not fix_height:             # <<<<<<<<<<<<<<
 *         cov_p_mask[0] = 1
 *         stars_p_mask[0] = 0
 */
  }

  /* "orb/cutils.pyx":1697
 *         cov_p_mask[0] = 1
 *         stars_p_mask[0] = 0
 *     if cov_pos and not fix_pos:             # <<<<<<<<<<<<<<
 *         cov_p_mask[1:3] = 1
 *         stars_p_mask[2:4] = 0
 */
  __pyx_t_80 = __Pyx_PyObject_IsTrue(((PyObject *)__pyx_v_cov_pos)); if (unlikely(__pyx_t_80 < 0)) __PYX_ERR(0, 1697, __pyx_L1_error)
  if (__pyx_t_80) {
  } else {
    __pyx_t_13 = __pyx_t_80;
    goto __pyx_L39_bool_binop_done;
  }
  __pyx_t_80 = __Pyx_PyObject_IsTrue(((PyObject *)__pyx_v_fix_pos)); if (unlikely(__pyx_t_80 < 0)) __PYX_ERR(0, 1697, __pyx_L1_error)
  __pyx_t_9 = ((!__pyx_t_80) != 0);
  __pyx_t_13 = __pyx_t_9;
  __pyx_L39_bool_binop_done:;
  if (__pyx_t_13) {

    /* "orb/cutils.pyx":1698
 *         stars_p_mask[0] = 0
 *     if cov_pos and not fix_pos:
 *         cov_p_mask[1:3] = 1             # <<<<<<<<<<<<<<
 *         stars_p_mask[2:4] = 0
 *     if cov_fwhm and not fix_fwhm:
 */
    if (__Pyx_PyObject_SetSlice(((PyObject *)__pyx_v_cov_p_mask), __pyx_int_1, 1, 3, NULL, NULL, &__pyx_slice__113, 1, 1, 1) < 0) __PYX_ERR(0, 1698, __pyx_L1_error)

    /* "orb/cutils.pyx":1699
 *     if cov_pos and not fix_pos:
 *         cov_p_mask[1:3] = 1
 *         stars_p_mask[2:4] = 0             # <<<<<<<<<<<<<<
 *     if cov_fwhm and not fix_fwhm:
 *         cov_p_mask[3] = 1
 */
    if (__Pyx_PyObject_SetSlice(((PyObject *)__pyx_v_stars_p_mask), __pyx_int_0, 2, 4, NULL, NULL, &__pyx_slice__114, 1, 1, 1) < 0) __PYX_ERR(0, 1699, __pyx_L1_error)

    /* "orb/cutils.pyx":1697
 *         cov_p_mask[0] = 1
 *         stars_p_mask[0] = 0
 *     if cov_pos and not fix_pos:             # <<<<<<<<<<<<<<
 *         cov_p_mask[1:3] = 1
 *         stars_p_mask[2:4] = 0
 */
  }

  /* "orb/cutils.pyx":1700
 *         cov_p_mask[1:3] = 1
 *         stars_p_mask[2:4] = 0
 *     if cov_fwhm and not fix_fwhm:             # <<<<<<<<<<<<<<
 *         cov_p_mask[3] = 1
 *         stars_p_mask[4] = 0
 */
  __pyx_t_9 = __Pyx_PyObject_IsTrue(((PyObject *)__pyx_v_cov_fwhm)); if (unlikely(__pyx_t_9 < 0)) __PYX_ERR(0, 1700, __pyx_L1_error)
  if (__pyx_t_9) {
  } else {
    __pyx_t_13 = __pyx_t_9;
    goto __pyx_L42_bool_binop_done;
  }
  __pyx_t_9 = __Pyx_PyObject_IsTrue(((PyObject *)__pyx_v_fix_fwhm)); if (unlikely(__pyx_t_9 < 0)) __PYX_ERR(0, 1700, __pyx_L1_error)
  __pyx_t_80 = ((!__pyx_t_9) != 0);
  __pyx_t_13 = __pyx_t_80;
  __pyx_L42_bool_binop_done:;
  if (__pyx_t_13) {

    /* "orb/cutils.pyx":1701
 *         stars_p_mask[2:4] = 0
 *     if cov_fwhm and not fix_fwhm:
 *         cov_p_mask[3] = 1             # <<<<<<<<<<<<<<
 *         stars_p_mask[4] = 0
 *     if fix_height:  stars_p_mask[0] = 0
 */
    __pyx_t_87 = 3;
    __pyx_t_8 = -1;
    if (__pyx_t_87 < 0) {
      __pyx_t_87 += __pyx_pybuffernd_cov_p_mask.diminfo[0].shape;
      if (unlikely(__pyx_t_87 < 0)) __pyx_t_8 = 0;
    } else if (unlikely(__pyx_t_87 >= __pyx_pybuffernd_cov_p_mask.diminfo[0].shape)) __pyx_t_8 = 0;
    if (unlikely(__pyx_t_8 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_8);
      __PYX_ERR(0, 1701, __pyx_L1_error)
    }
    *__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_cov_p_mask.rcbuffer->pybuffer.buf, __pyx_t_87, __pyx_pybuffernd_cov_p_mask.diminfo[0].strides) = 1.0;

    /* "orb/cutils.pyx":1702
 *     if cov_fwhm and not fix_fwhm:
 *         cov_p_mask[3] = 1
 *         stars_p_mask[4] = 0             # <<<<<<<<<<<<<<
 *     if fix_height:  stars_p_mask[0] = 0
 *     if fix_pos: stars_p_mask[2:4] = 0
 */
    __pyx_t_88 = 4;
    __pyx_t_8 = -1;
    if (__pyx_t_88 < 0) {
      __pyx_t_88 += __pyx_pybuffernd_stars_p_mask.diminfo[0].shape;
      if (unlikely(__pyx_t_88 < 0)) __pyx_t_8 = 0;
    } else if (unlikely(__pyx_t_88 >= __pyx_pybuffernd_stars_p_mask.diminfo[0].shape)) __pyx_t_8 = 0;
    if (unlikely(__pyx_t_8 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_8);
      __PYX_ERR(0, 1702, __pyx_L1_error)
    }
    *__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_stars_p_mask.rcbuffer->pybuffer.buf, __pyx_t_88, __pyx_pybuffernd_stars_p_mask.diminfo[0].strides) = 0.0;

    /* "orb/cutils.pyx":1700
 *         cov_p_mask[1:3] = 1
 *         stars_p_mask[2:4] = 0
 *     if cov_fwhm and not fix_fwhm:             # <<<<<<<<<<<<<<
 *         cov_p_mask[3] = 1
 *         stars_p_mask[4] = 0
 */
  }

  /* "orb/cutils.pyx":1703
 *         cov_p_mask[3] = 1
 *         stars_p_mask[4] = 0
 *     if fix_height:  stars_p_mask[0] = 0             # <<<<<<<<<<<<<<
 *     if fix_pos: stars_p_mask[2:4] = 0
 *     if fix_fwhm: stars_p_mask[4] = 0
 */
  __pyx_t_13 = __Pyx_PyObject_IsTrue(((PyObject *)__pyx_v_fix_height)); if (unlikely(__pyx_t_13 < 0)) __PYX_ERR(0, 1703, __pyx_L1_error)
  if (__pyx_t_13) {
    __pyx_t_89 = 0;
    __pyx_t_8 = -1;
    if (__pyx_t_89 < 0) {
      __pyx_t_89 += __pyx_pybuffernd_stars_p_mask.diminfo[0].shape;
      if (unlikely(__pyx_t_89 < 0)) __pyx_t_8 = 0;
    } else if (unlikely(__pyx_t_89 >= __pyx_pybuffernd_stars_p_mask.diminfo[0].shape)) __pyx_t_8 = 0;
    if (unlikely(__pyx_t_8 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_8);
      __PYX_ERR(0, 1703, __pyx_L1_error)
    }
    *__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_stars_p_mask.rcbuffer->pybuffer.buf, __pyx_t_89, __pyx_pybuffernd_stars_p_mask.diminfo[0].strides) = 0.0;
  }

  /* "orb/cutils.pyx":1704
 *         stars_p_mask[4] = 0
 *     if fix_height:  stars_p_mask[0] = 0
 *     if fix_pos: stars_p_mask[2:4] = 0             # <<<<<<<<<<<<<<
 *     if fix_fwhm: stars_p_mask[4] = 0
 *     if enable_zoom: cov_p_mask[4:6] = 1
 */
  __pyx_t_13 = __Pyx_PyObject_IsTrue(((PyObject *)__pyx_v_fix_pos)); if (unlikely(__pyx_t_13 < 0)) __PYX_ERR(0, 1704, __pyx_L1_error)
  if (__pyx_t_13) {
    if (__Pyx_PyObject_SetSlice(((PyObject *)__pyx_v_stars_p_mask), __pyx_int_0, 2, 4, NULL, NULL, &__pyx_slice__115, 1, 1, 1) < 0) __PYX_ERR(0, 1704, __pyx_L1_error)
  }

  /* "orb/cutils.pyx":1705
 *     if fix_height:  stars_p_mask[0] = 0
 *     if fix_pos: stars_p_mask[2:4] = 0
 *     if fix_fwhm: stars_p_mask[4] = 0             # <<<<<<<<<<<<<<
 *     if enable_zoom: cov_p_mask[4:6] = 1
 *     if enable_rotation: cov_p_mask[6] = 1
 */
  __pyx_t_13 = __Pyx_PyObject_IsTrue(((PyObject *)__pyx_v_fix_fwhm)); if (unlikely(__pyx_t_13 < 0)) __PYX_ERR(0, 1705, __pyx_L1_error)
  if (__pyx_t_13) {
    __pyx_t_90 = 4;
    __pyx_t_8 = -1;
    if (__pyx_t_90 < 0) {
      __pyx_t_90 += __pyx_pybuffernd_stars_p_mask.diminfo[0].shape;
      if (unlikely(__pyx_t_90 < 0)) __pyx_t_8 = 0;
    } else if (unlikely(__pyx_t_90 >= __pyx_pybuffernd_stars_p_mask.diminfo[0].shape)) __pyx_t_8 = 0;
    if (unlikely(__pyx_t_8 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_8);
      __PYX_ERR(0, 1705, __pyx_L1_error)
    }
    *__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_stars_p_mask.rcbuffer->pybuffer.buf, __pyx_t_90, __pyx_pybuffernd_stars_p_mask.diminfo[0].strides) = 0.0;
  }

  /* "orb/cutils.pyx":1706
 *     if fix_pos: stars_p_mask[2:4] = 0
 *     if fix_fwhm: stars_p_mask[4] = 0
 *     if enable_zoom: cov_p_mask[4:6] = 1             # <<<<<<<<<<<<<<
 *     if enable_rotation: cov_p_mask[6] = 1
 * 
 */
  __pyx_t_13 = __Pyx_PyObject_IsTrue(((PyObject *)__pyx_v_enable_zoom)); if (unlikely(__pyx_t_13 < 0)) __PYX_ERR(0, 1706, __pyx_L1_error)
  if (__pyx_t_13) {
    if (__Pyx_PyObject_SetSlice(((PyObject *)__pyx_v_cov_p_mask), __pyx_int_1, 4, 6, NULL, NULL, &__pyx_slice__116, 1, 1, 1) < 0) __PYX_ERR(0, 1706, __pyx_L1_error)
  }

  /* "orb/cutils.pyx":1707
 *     if fix_fwhm: stars_p_mask[4] = 0
 *     if enable_zoom: cov_p_mask[4:6] = 1
 *     if enable_rotation: cov_p_mask[6] = 1             # <<<<<<<<<<<<<<
 * 
 *     free_p, fixed_p = params_arrays2vect(stars_p, stars_p_mask,
 */
  __pyx_t_13 = __Pyx_PyObject_IsTrue(((PyObject *)__pyx_v_enable_rotation)); if (unlikely(__pyx_t_13 < 0)) __PYX_ERR(0, 1707, __pyx_L1_error)
  if (__pyx_t_13) {
    __pyx_t_91 = 6;
    __pyx_t_8 = -1;
    if (__pyx_t_91 < 0) {
      __pyx_t_91 += __pyx_pybuffernd_cov_p_mask.diminfo[0].shape;
      if (unlikely(__pyx_t_91 < 0)) __pyx_t_8 = 0;
    } else if (unlikely(__pyx_t_91 >= __pyx_pybuffernd_cov_p_mask.diminfo[0].shape)) __pyx_t_8 = 0;
    if (unlikely(__pyx_t_8 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_8);
      __PYX_ERR(0, 1707, __pyx_L1_error)
    }
    *__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_cov_p_mask.rcbuffer->pybuffer.buf, __pyx_t_91, __pyx_pybuffernd_cov_p_mask.diminfo[0].strides) = 1.0;
  }

  /* "orb/cutils.pyx":1709
 *     if enable_rotation: cov_p_mask[6] = 1
 * 
 *     free_p, fixed_p = params_arrays2vect(stars_p, stars_p_mask,             # <<<<<<<<<<<<<<
 *                                          cov_p, cov_p_mask)
 *     ### FIT ###
 */
  __pyx_t_5 = __pyx_pf_3orb_6cutils_15multi_fit_stars_params_arrays2vect(__pyx_v_params_arrays2vect, ((PyArrayObject *)__pyx_v_stars_p), ((PyArrayObject *)__pyx_v_stars_p_mask), ((PyArrayObject *)__pyx_v_cov_p), ((PyArrayObject *)__pyx_v_cov_p_mask)); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1709, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  if ((likely(PyTuple_CheckExact(__pyx_t_5))) || (PyList_CheckExact(__pyx_t_5))) {
    PyObject* sequence = __pyx_t_5;
    #if CYTHON_COMPILING_IN_CPYTHON
    Py_ssize_t size = Py_SIZE(sequence);
    #else
    Py_ssize_t size = PySequence_Size(sequence);
    #endif
    if (unlikely(size != 2)) {
      if (size > 2) __Pyx_RaiseTooManyValuesError(2);
      else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
      __PYX_ERR(0, 1709, __pyx_L1_error)
    }
    #if CYTHON_COMPILING_IN_CPYTHON
    if (likely(PyTuple_CheckExact(sequence))) {
      __pyx_t_72 = PyTuple_GET_ITEM(sequence, 0); 
      __pyx_t_2 = PyTuple_GET_ITEM(sequence, 1); 
    } else {
      __pyx_t_72 = PyList_GET_ITEM(sequence, 0); 
      __pyx_t_2 = PyList_GET_ITEM(sequence, 1); 
    }
    __Pyx_INCREF(__pyx_t_72);
    __Pyx_INCREF(__pyx_t_2);
    #else
    __pyx_t_72 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_72)) __PYX_ERR(0, 1709, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_72);
    __pyx_t_2 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1709, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    #endif
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  } else {
    Py_ssize_t index = -1;
    __pyx_t_70 = PyObject_GetIter(__pyx_t_5); if (unlikely(!__pyx_t_70)) __PYX_ERR(0, 1709, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_70);
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    __pyx_t_57 = Py_TYPE(__pyx_t_70)->tp_iternext;
    index = 0; __pyx_t_72 = __pyx_t_57(__pyx_t_70); if (unlikely(!__pyx_t_72)) goto __pyx_L49_unpacking_failed;
    __Pyx_GOTREF(__pyx_t_72);
    index = 1; __pyx_t_2 = __pyx_t_57(__pyx_t_70); if (unlikely(!__pyx_t_2)) goto __pyx_L49_unpacking_failed;
    __Pyx_GOTREF(__pyx_t_2);
    if (__Pyx_IternextUnpackEndCheck(__pyx_t_57(__pyx_t_70), 2) < 0) __PYX_ERR(0, 1709, __pyx_L1_error)
    __pyx_t_57 = NULL;
    __Pyx_DECREF(__pyx_t_70); __pyx_t_70 = 0;
    goto __pyx_L50_unpacking_done;
    __pyx_L49_unpacking_failed:;
    __Pyx_DECREF(__pyx_t_70); __pyx_t_70 = 0;
    __pyx_t_57 = NULL;
    if (__Pyx_IterFinish() == 0) __Pyx_RaiseNeedMoreValuesError(index);
    __PYX_ERR(0, 1709, __pyx_L1_error)
    __pyx_L50_unpacking_done:;
  }
  if (!(likely(((__pyx_t_72) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_72, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1709, __pyx_L1_error)
  if (!(likely(((__pyx_t_2) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_2, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1709, __pyx_L1_error)
  __pyx_t_92 = ((PyArrayObject *)__pyx_t_72);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_free_p.rcbuffer->pybuffer);
    __pyx_t_8 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_free_p.rcbuffer->pybuffer, (PyObject*)__pyx_t_92, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack);
    if (unlikely(__pyx_t_8 < 0)) {
      PyErr_Fetch(&__pyx_t_22, &__pyx_t_23, &__pyx_t_24);
      if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_free_p.rcbuffer->pybuffer, (PyObject*)__pyx_v_free_p, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_22); Py_XDECREF(__pyx_t_23); Py_XDECREF(__pyx_t_24);
        __Pyx_RaiseBufferFallbackError();
      } else {
        PyErr_Restore(__pyx_t_22, __pyx_t_23, __pyx_t_24);
      }
    }
    __pyx_pybuffernd_free_p.diminfo[0].strides = __pyx_pybuffernd_free_p.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_free_p.diminfo[0].shape = __pyx_pybuffernd_free_p.rcbuffer->pybuffer.shape[0];
    if (unlikely(__pyx_t_8 < 0)) __PYX_ERR(0, 1709, __pyx_L1_error)
  }
  __pyx_t_92 = 0;
  __pyx_v_free_p = ((PyArrayObject *)__pyx_t_72);
  __pyx_t_72 = 0;
  __pyx_t_93 = ((PyArrayObject *)__pyx_t_2);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_fixed_p.rcbuffer->pybuffer);
    __pyx_t_8 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_fixed_p.rcbuffer->pybuffer, (PyObject*)__pyx_t_93, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack);
    if (unlikely(__pyx_t_8 < 0)) {
      PyErr_Fetch(&__pyx_t_24, &__pyx_t_23, &__pyx_t_22);
      if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_fixed_p.rcbuffer->pybuffer, (PyObject*)__pyx_v_fixed_p, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_24); Py_XDECREF(__pyx_t_23); Py_XDECREF(__pyx_t_22);
        __Pyx_RaiseBufferFallbackError();
      } else {
        PyErr_Restore(__pyx_t_24, __pyx_t_23, __pyx_t_22);
      }
    }
    __pyx_pybuffernd_fixed_p.diminfo[0].strides = __pyx_pybuffernd_fixed_p.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_fixed_p.diminfo[0].shape = __pyx_pybuffernd_fixed_p.rcbuffer->pybuffer.shape[0];
    if (unlikely(__pyx_t_8 < 0)) __PYX_ERR(0, 1709, __pyx_L1_error)
  }
  __pyx_t_93 = 0;
  __pyx_v_fixed_p = ((PyArrayObject *)__pyx_t_2);
  __pyx_t_2 = 0;

  /* "orb/cutils.pyx":1712
 *                                          cov_p, cov_p_mask)
 *     ### FIT ###
 *     try:             # <<<<<<<<<<<<<<
 *         fit = scipy.optimize.leastsq(diff, free_p,
 *                                      args=(fixed_p, stars_p_mask, cov_p_mask,
 */
  {
    __Pyx_PyThreadState_declare
    __Pyx_PyThreadState_assign
    __Pyx_ExceptionSave(&__pyx_t_22, &__pyx_t_23, &__pyx_t_24);
    __Pyx_XGOTREF(__pyx_t_22);
    __Pyx_XGOTREF(__pyx_t_23);
    __Pyx_XGOTREF(__pyx_t_24);
    /*try:*/ {

      /* "orb/cutils.pyx":1713
 *     ### FIT ###
 *     try:
 *         fit = scipy.optimize.leastsq(diff, free_p,             # <<<<<<<<<<<<<<
 *                                      args=(fixed_p, stars_p_mask, cov_p_mask,
 *                                            np.copy(frame), box_size, star_nb,
 */
      __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_scipy); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1713, __pyx_L51_error)
      __Pyx_GOTREF(__pyx_t_5);
      __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_optimize); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1713, __pyx_L51_error)
      __Pyx_GOTREF(__pyx_t_2);
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
      __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_leastsq); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1713, __pyx_L51_error)
      __Pyx_GOTREF(__pyx_t_5);
      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
      __pyx_t_2 = PyTuple_New(2); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1713, __pyx_L51_error)
      __Pyx_GOTREF(__pyx_t_2);
      __Pyx_INCREF(__pyx_v_diff);
      __Pyx_GIVEREF(__pyx_v_diff);
      PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_v_diff);
      __Pyx_INCREF(((PyObject *)__pyx_v_free_p));
      __Pyx_GIVEREF(((PyObject *)__pyx_v_free_p));
      PyTuple_SET_ITEM(__pyx_t_2, 1, ((PyObject *)__pyx_v_free_p));

      /* "orb/cutils.pyx":1714
 *     try:
 *         fit = scipy.optimize.leastsq(diff, free_p,
 *                                      args=(fixed_p, stars_p_mask, cov_p_mask,             # <<<<<<<<<<<<<<
 *                                            np.copy(frame), box_size, star_nb,
 *                                            noise_guess, dcl, saturation,
 */
      __pyx_t_72 = PyDict_New(); if (unlikely(!__pyx_t_72)) __PYX_ERR(0, 1714, __pyx_L51_error)
      __Pyx_GOTREF(__pyx_t_72);

      /* "orb/cutils.pyx":1715
 *         fit = scipy.optimize.leastsq(diff, free_p,
 *                                      args=(fixed_p, stars_p_mask, cov_p_mask,
 *                                            np.copy(frame), box_size, star_nb,             # <<<<<<<<<<<<<<
 *                                            noise_guess, dcl, saturation,
 *                                            sip),
 */
      __pyx_t_42 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1715, __pyx_L51_error)
      __Pyx_GOTREF(__pyx_t_42);
      __pyx_t_71 = __Pyx_PyObject_GetAttrStr(__pyx_t_42, __pyx_n_s_copy); if (unlikely(!__pyx_t_71)) __PYX_ERR(0, 1715, __pyx_L51_error)
      __Pyx_GOTREF(__pyx_t_71);
      __Pyx_DECREF(__pyx_t_42); __pyx_t_42 = 0;
      __pyx_t_42 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_71))) {
        __pyx_t_42 = PyMethod_GET_SELF(__pyx_t_71);
        if (likely(__pyx_t_42)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_71);
          __Pyx_INCREF(__pyx_t_42);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_71, function);
        }
      }
      if (!__pyx_t_42) {
        __pyx_t_70 = __Pyx_PyObject_CallOneArg(__pyx_t_71, ((PyObject *)__pyx_v_frame)); if (unlikely(!__pyx_t_70)) __PYX_ERR(0, 1715, __pyx_L51_error)
        __Pyx_GOTREF(__pyx_t_70);
      } else {
        __pyx_t_3 = PyTuple_New(1+1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1715, __pyx_L51_error)
        __Pyx_GOTREF(__pyx_t_3);
        __Pyx_GIVEREF(__pyx_t_42); PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_42); __pyx_t_42 = NULL;
        __Pyx_INCREF(((PyObject *)__pyx_v_frame));
        __Pyx_GIVEREF(((PyObject *)__pyx_v_frame));
        PyTuple_SET_ITEM(__pyx_t_3, 0+1, ((PyObject *)__pyx_v_frame));
        __pyx_t_70 = __Pyx_PyObject_Call(__pyx_t_71, __pyx_t_3, NULL); if (unlikely(!__pyx_t_70)) __PYX_ERR(0, 1715, __pyx_L51_error)
        __Pyx_GOTREF(__pyx_t_70);
        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      }
      __Pyx_DECREF(__pyx_t_71); __pyx_t_71 = 0;
      __pyx_t_71 = __Pyx_PyInt_From_int(__pyx_v_box_size); if (unlikely(!__pyx_t_71)) __PYX_ERR(0, 1715, __pyx_L51_error)
      __Pyx_GOTREF(__pyx_t_71);
      __pyx_t_3 = __Pyx_PyInt_From_int(__pyx_v_star_nb); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1715, __pyx_L51_error)
      __Pyx_GOTREF(__pyx_t_3);

      /* "orb/cutils.pyx":1716
 *                                      args=(fixed_p, stars_p_mask, cov_p_mask,
 *                                            np.copy(frame), box_size, star_nb,
 *                                            noise_guess, dcl, saturation,             # <<<<<<<<<<<<<<
 *                                            sip),
 *                                      maxfev=500, full_output=True,
 */
      __pyx_t_42 = PyFloat_FromDouble(__pyx_v_dcl); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1716, __pyx_L51_error)
      __Pyx_GOTREF(__pyx_t_42);
      __pyx_t_40 = PyFloat_FromDouble(__pyx_v_saturation); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1716, __pyx_L51_error)
      __Pyx_GOTREF(__pyx_t_40);

      /* "orb/cutils.pyx":1714
 *     try:
 *         fit = scipy.optimize.leastsq(diff, free_p,
 *                                      args=(fixed_p, stars_p_mask, cov_p_mask,             # <<<<<<<<<<<<<<
 *                                            np.copy(frame), box_size, star_nb,
 *                                            noise_guess, dcl, saturation,
 */
      __pyx_t_4 = PyTuple_New(10); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1714, __pyx_L51_error)
      __Pyx_GOTREF(__pyx_t_4);
      __Pyx_INCREF(((PyObject *)__pyx_v_fixed_p));
      __Pyx_GIVEREF(((PyObject *)__pyx_v_fixed_p));
      PyTuple_SET_ITEM(__pyx_t_4, 0, ((PyObject *)__pyx_v_fixed_p));
      __Pyx_INCREF(((PyObject *)__pyx_v_stars_p_mask));
      __Pyx_GIVEREF(((PyObject *)__pyx_v_stars_p_mask));
      PyTuple_SET_ITEM(__pyx_t_4, 1, ((PyObject *)__pyx_v_stars_p_mask));
      __Pyx_INCREF(((PyObject *)__pyx_v_cov_p_mask));
      __Pyx_GIVEREF(((PyObject *)__pyx_v_cov_p_mask));
      PyTuple_SET_ITEM(__pyx_t_4, 2, ((PyObject *)__pyx_v_cov_p_mask));
      __Pyx_GIVEREF(__pyx_t_70);
      PyTuple_SET_ITEM(__pyx_t_4, 3, __pyx_t_70);
      __Pyx_GIVEREF(__pyx_t_71);
      PyTuple_SET_ITEM(__pyx_t_4, 4, __pyx_t_71);
      __Pyx_GIVEREF(__pyx_t_3);
      PyTuple_SET_ITEM(__pyx_t_4, 5, __pyx_t_3);
      __Pyx_INCREF(((PyObject *)__pyx_v_noise_guess));
      __Pyx_GIVEREF(((PyObject *)__pyx_v_noise_guess));
      PyTuple_SET_ITEM(__pyx_t_4, 6, ((PyObject *)__pyx_v_noise_guess));
      __Pyx_GIVEREF(__pyx_t_42);
      PyTuple_SET_ITEM(__pyx_t_4, 7, __pyx_t_42);
      __Pyx_GIVEREF(__pyx_t_40);
      PyTuple_SET_ITEM(__pyx_t_4, 8, __pyx_t_40);
      __Pyx_INCREF(__pyx_v_sip);
      __Pyx_GIVEREF(__pyx_v_sip);
      PyTuple_SET_ITEM(__pyx_t_4, 9, __pyx_v_sip);
      __pyx_t_70 = 0;
      __pyx_t_71 = 0;
      __pyx_t_3 = 0;
      __pyx_t_42 = 0;
      __pyx_t_40 = 0;
      if (PyDict_SetItem(__pyx_t_72, __pyx_n_s_args, __pyx_t_4) < 0) __PYX_ERR(0, 1714, __pyx_L51_error)
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      if (PyDict_SetItem(__pyx_t_72, __pyx_n_s_maxfev, __pyx_int_500) < 0) __PYX_ERR(0, 1714, __pyx_L51_error)

      /* "orb/cutils.pyx":1718
 *                                            noise_guess, dcl, saturation,
 *                                            sip),
 *                                      maxfev=500, full_output=True,             # <<<<<<<<<<<<<<
 *                                      xtol=fit_tol)
 *     except Exception, e:
 */
      if (PyDict_SetItem(__pyx_t_72, __pyx_n_s_full_output, Py_True) < 0) __PYX_ERR(0, 1714, __pyx_L51_error)

      /* "orb/cutils.pyx":1719
 *                                            sip),
 *                                      maxfev=500, full_output=True,
 *                                      xtol=fit_tol)             # <<<<<<<<<<<<<<
 *     except Exception, e:
 *         print 'Exception raised during least square fit of cutils.multi_fit_stars:', e
 */
      __pyx_t_4 = PyFloat_FromDouble(__pyx_v_fit_tol); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1719, __pyx_L51_error)
      __Pyx_GOTREF(__pyx_t_4);
      if (PyDict_SetItem(__pyx_t_72, __pyx_n_s_xtol, __pyx_t_4) < 0) __PYX_ERR(0, 1714, __pyx_L51_error)
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;

      /* "orb/cutils.pyx":1713
 *     ### FIT ###
 *     try:
 *         fit = scipy.optimize.leastsq(diff, free_p,             # <<<<<<<<<<<<<<
 *                                      args=(fixed_p, stars_p_mask, cov_p_mask,
 *                                            np.copy(frame), box_size, star_nb,
 */
      __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_2, __pyx_t_72); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1713, __pyx_L51_error)
      __Pyx_GOTREF(__pyx_t_4);
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
      __Pyx_DECREF(__pyx_t_72); __pyx_t_72 = 0;
      __pyx_v_fit = __pyx_t_4;
      __pyx_t_4 = 0;

      /* "orb/cutils.pyx":1712
 *                                          cov_p, cov_p_mask)
 *     ### FIT ###
 *     try:             # <<<<<<<<<<<<<<
 *         fit = scipy.optimize.leastsq(diff, free_p,
 *                                      args=(fixed_p, stars_p_mask, cov_p_mask,
 */
    }
    __Pyx_XDECREF(__pyx_t_22); __pyx_t_22 = 0;
    __Pyx_XDECREF(__pyx_t_23); __pyx_t_23 = 0;
    __Pyx_XDECREF(__pyx_t_24); __pyx_t_24 = 0;
    goto __pyx_L58_try_end;
    __pyx_L51_error:;
    __Pyx_PyThreadState_assign
    __Pyx_XDECREF(__pyx_t_49); __pyx_t_49 = 0;
    __Pyx_XDECREF(__pyx_t_1); __pyx_t_1 = 0;
    __Pyx_XDECREF(__pyx_t_44); __pyx_t_44 = 0;
    __Pyx_XDECREF(__pyx_t_43); __pyx_t_43 = 0;
    __Pyx_XDECREF(__pyx_t_70); __pyx_t_70 = 0;
    __Pyx_XDECREF(__pyx_t_71); __pyx_t_71 = 0;
    __Pyx_XDECREF(__pyx_t_3); __pyx_t_3 = 0;
    __Pyx_XDECREF(__pyx_t_42); __pyx_t_42 = 0;
    __Pyx_XDECREF(__pyx_t_40); __pyx_t_40 = 0;
    __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
    __Pyx_XDECREF(__pyx_t_2); __pyx_t_2 = 0;
    __Pyx_XDECREF(__pyx_t_72); __pyx_t_72 = 0;
    __Pyx_XDECREF(__pyx_t_4); __pyx_t_4 = 0;

    /* "orb/cutils.pyx":1720
 *                                      maxfev=500, full_output=True,
 *                                      xtol=fit_tol)
 *     except Exception, e:             # <<<<<<<<<<<<<<
 *         print 'Exception raised during least square fit of cutils.multi_fit_stars:', e
 *         fit = [5]
 */
    __pyx_t_8 = __Pyx_PyErr_ExceptionMatches(__pyx_builtin_Exception);
    if (__pyx_t_8) {
      __Pyx_AddTraceback("orb.cutils.multi_fit_stars", __pyx_clineno, __pyx_lineno, __pyx_filename);
      if (__Pyx_GetException(&__pyx_t_4, &__pyx_t_72, &__pyx_t_2) < 0) __PYX_ERR(0, 1720, __pyx_L53_except_error)
      __Pyx_GOTREF(__pyx_t_4);
      __Pyx_GOTREF(__pyx_t_72);
      __Pyx_GOTREF(__pyx_t_2);
      __Pyx_INCREF(__pyx_t_72);
      __pyx_v_e = __pyx_t_72;

      /* "orb/cutils.pyx":1721
 *                                      xtol=fit_tol)
 *     except Exception, e:
 *         print 'Exception raised during least square fit of cutils.multi_fit_stars:', e             # <<<<<<<<<<<<<<
 *         fit = [5]
 * 
 */
      __pyx_t_5 = PyTuple_New(2); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1721, __pyx_L53_except_error)
      __Pyx_GOTREF(__pyx_t_5);
      __Pyx_INCREF(__pyx_kp_s_Exception_raised_during_least_sq);
      __Pyx_GIVEREF(__pyx_kp_s_Exception_raised_during_least_sq);
      PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_kp_s_Exception_raised_during_least_sq);
      __Pyx_INCREF(__pyx_v_e);
      __Pyx_GIVEREF(__pyx_v_e);
      PyTuple_SET_ITEM(__pyx_t_5, 1, __pyx_v_e);
      if (__Pyx_Print(0, __pyx_t_5, 1) < 0) __PYX_ERR(0, 1721, __pyx_L53_except_error)
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

      /* "orb/cutils.pyx":1722
 *     except Exception, e:
 *         print 'Exception raised during least square fit of cutils.multi_fit_stars:', e
 *         fit = [5]             # <<<<<<<<<<<<<<
 * 
 *     ### CHECK FIT RESULTS ###
 */
      __pyx_t_5 = PyList_New(1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1722, __pyx_L53_except_error)
      __Pyx_GOTREF(__pyx_t_5);
      __Pyx_INCREF(__pyx_int_5);
      __Pyx_GIVEREF(__pyx_int_5);
      PyList_SET_ITEM(__pyx_t_5, 0, __pyx_int_5);
      __Pyx_XDECREF_SET(__pyx_v_fit, __pyx_t_5);
      __pyx_t_5 = 0;
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __Pyx_DECREF(__pyx_t_72); __pyx_t_72 = 0;
      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
      goto __pyx_L52_exception_handled;
    }
    goto __pyx_L53_except_error;
    __pyx_L53_except_error:;

    /* "orb/cutils.pyx":1712
 *                                          cov_p, cov_p_mask)
 *     ### FIT ###
 *     try:             # <<<<<<<<<<<<<<
 *         fit = scipy.optimize.leastsq(diff, free_p,
 *                                      args=(fixed_p, stars_p_mask, cov_p_mask,
 */
    __Pyx_PyThreadState_assign
    __Pyx_XGIVEREF(__pyx_t_22);
    __Pyx_XGIVEREF(__pyx_t_23);
    __Pyx_XGIVEREF(__pyx_t_24);
    __Pyx_ExceptionReset(__pyx_t_22, __pyx_t_23, __pyx_t_24);
    goto __pyx_L1_error;
    __pyx_L52_exception_handled:;
    __Pyx_PyThreadState_assign
    __Pyx_XGIVEREF(__pyx_t_22);
    __Pyx_XGIVEREF(__pyx_t_23);
    __Pyx_XGIVEREF(__pyx_t_24);
    __Pyx_ExceptionReset(__pyx_t_22, __pyx_t_23, __pyx_t_24);
    __pyx_L58_try_end:;
  }

  /* "orb/cutils.pyx":1725
 * 
 *     ### CHECK FIT RESULTS ###
 *     if fit[-1] <= 4:             # <<<<<<<<<<<<<<
 *         returned_data = dict()
 *         last_diff = fit[2]['fvec']
 */
  __pyx_t_2 = __Pyx_GetItemInt(__pyx_v_fit, -1L, long, 1, __Pyx_PyInt_From_long, 0, 1, 1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1725, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_72 = PyObject_RichCompare(__pyx_t_2, __pyx_int_4, Py_LE); __Pyx_XGOTREF(__pyx_t_72); if (unlikely(!__pyx_t_72)) __PYX_ERR(0, 1725, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_13 = __Pyx_PyObject_IsTrue(__pyx_t_72); if (unlikely(__pyx_t_13 < 0)) __PYX_ERR(0, 1725, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_72); __pyx_t_72 = 0;
  if (__pyx_t_13) {

    /* "orb/cutils.pyx":1726
 *     ### CHECK FIT RESULTS ###
 *     if fit[-1] <= 4:
 *         returned_data = dict()             # <<<<<<<<<<<<<<
 *         last_diff = fit[2]['fvec']
 *         stars_p, cov_p = params_vect2arrays(
 */
    __pyx_t_72 = PyDict_New(); if (unlikely(!__pyx_t_72)) __PYX_ERR(0, 1726, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_72);
    __pyx_v_returned_data = ((PyObject*)__pyx_t_72);
    __pyx_t_72 = 0;

    /* "orb/cutils.pyx":1727
 *     if fit[-1] <= 4:
 *         returned_data = dict()
 *         last_diff = fit[2]['fvec']             # <<<<<<<<<<<<<<
 *         stars_p, cov_p = params_vect2arrays(
 *             fit[0], fixed_p, stars_p_mask, cov_p_mask, star_nb)
 */
    __pyx_t_72 = __Pyx_GetItemInt(__pyx_v_fit, 2, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_72)) __PYX_ERR(0, 1727, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_72);
    __pyx_t_2 = PyObject_GetItem(__pyx_t_72, __pyx_n_s_fvec); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1727, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_DECREF(__pyx_t_72); __pyx_t_72 = 0;
    __pyx_v_last_diff = __pyx_t_2;
    __pyx_t_2 = 0;

    /* "orb/cutils.pyx":1729
 *         last_diff = fit[2]['fvec']
 *         stars_p, cov_p = params_vect2arrays(
 *             fit[0], fixed_p, stars_p_mask, cov_p_mask, star_nb)             # <<<<<<<<<<<<<<
 * 
 *         # compute reduced chi square
 */
    __pyx_t_2 = __Pyx_GetItemInt(__pyx_v_fit, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1729, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    if (!(likely(((__pyx_t_2) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_2, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1729, __pyx_L1_error)

    /* "orb/cutils.pyx":1728
 *         returned_data = dict()
 *         last_diff = fit[2]['fvec']
 *         stars_p, cov_p = params_vect2arrays(             # <<<<<<<<<<<<<<
 *             fit[0], fixed_p, stars_p_mask, cov_p_mask, star_nb)
 * 
 */
    __pyx_t_72 = __pyx_pf_3orb_6cutils_15multi_fit_stars_2params_vect2arrays(__pyx_cur_scope->__pyx_v_params_vect2arrays, ((PyArrayObject *)__pyx_t_2), ((PyArrayObject *)__pyx_v_fixed_p), ((PyArrayObject *)__pyx_v_stars_p_mask), ((PyArrayObject *)__pyx_v_cov_p_mask), __pyx_v_star_nb); if (unlikely(!__pyx_t_72)) __PYX_ERR(0, 1728, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_72);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    if ((likely(PyTuple_CheckExact(__pyx_t_72))) || (PyList_CheckExact(__pyx_t_72))) {
      PyObject* sequence = __pyx_t_72;
      #if CYTHON_COMPILING_IN_CPYTHON
      Py_ssize_t size = Py_SIZE(sequence);
      #else
      Py_ssize_t size = PySequence_Size(sequence);
      #endif
      if (unlikely(size != 2)) {
        if (size > 2) __Pyx_RaiseTooManyValuesError(2);
        else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
        __PYX_ERR(0, 1728, __pyx_L1_error)
      }
      #if CYTHON_COMPILING_IN_CPYTHON
      if (likely(PyTuple_CheckExact(sequence))) {
        __pyx_t_2 = PyTuple_GET_ITEM(sequence, 0); 
        __pyx_t_4 = PyTuple_GET_ITEM(sequence, 1); 
      } else {
        __pyx_t_2 = PyList_GET_ITEM(sequence, 0); 
        __pyx_t_4 = PyList_GET_ITEM(sequence, 1); 
      }
      __Pyx_INCREF(__pyx_t_2);
      __Pyx_INCREF(__pyx_t_4);
      #else
      __pyx_t_2 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1728, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __pyx_t_4 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1728, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      #endif
      __Pyx_DECREF(__pyx_t_72); __pyx_t_72 = 0;
    } else {
      Py_ssize_t index = -1;
      __pyx_t_5 = PyObject_GetIter(__pyx_t_72); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1728, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __Pyx_DECREF(__pyx_t_72); __pyx_t_72 = 0;
      __pyx_t_57 = Py_TYPE(__pyx_t_5)->tp_iternext;
      index = 0; __pyx_t_2 = __pyx_t_57(__pyx_t_5); if (unlikely(!__pyx_t_2)) goto __pyx_L62_unpacking_failed;
      __Pyx_GOTREF(__pyx_t_2);
      index = 1; __pyx_t_4 = __pyx_t_57(__pyx_t_5); if (unlikely(!__pyx_t_4)) goto __pyx_L62_unpacking_failed;
      __Pyx_GOTREF(__pyx_t_4);
      if (__Pyx_IternextUnpackEndCheck(__pyx_t_57(__pyx_t_5), 2) < 0) __PYX_ERR(0, 1728, __pyx_L1_error)
      __pyx_t_57 = NULL;
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
      goto __pyx_L63_unpacking_done;
      __pyx_L62_unpacking_failed:;
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
      __pyx_t_57 = NULL;
      if (__Pyx_IterFinish() == 0) __Pyx_RaiseNeedMoreValuesError(index);
      __PYX_ERR(0, 1728, __pyx_L1_error)
      __pyx_L63_unpacking_done:;
    }
    if (!(likely(((__pyx_t_2) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_2, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1728, __pyx_L1_error)
    if (!(likely(((__pyx_t_4) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_4, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1728, __pyx_L1_error)
    __pyx_t_25 = ((PyArrayObject *)__pyx_t_2);
    {
      __Pyx_BufFmt_StackElem __pyx_stack[1];
      __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_stars_p.rcbuffer->pybuffer);
      __pyx_t_8 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_stars_p.rcbuffer->pybuffer, (PyObject*)__pyx_t_25, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 2, 0, __pyx_stack);
      if (unlikely(__pyx_t_8 < 0)) {
        PyErr_Fetch(&__pyx_t_24, &__pyx_t_23, &__pyx_t_22);
        if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_stars_p.rcbuffer->pybuffer, (PyObject*)__pyx_v_stars_p, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 2, 0, __pyx_stack) == -1)) {
          Py_XDECREF(__pyx_t_24); Py_XDECREF(__pyx_t_23); Py_XDECREF(__pyx_t_22);
          __Pyx_RaiseBufferFallbackError();
        } else {
          PyErr_Restore(__pyx_t_24, __pyx_t_23, __pyx_t_22);
        }
      }
      __pyx_pybuffernd_stars_p.diminfo[0].strides = __pyx_pybuffernd_stars_p.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_stars_p.diminfo[0].shape = __pyx_pybuffernd_stars_p.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_stars_p.diminfo[1].strides = __pyx_pybuffernd_stars_p.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_stars_p.diminfo[1].shape = __pyx_pybuffernd_stars_p.rcbuffer->pybuffer.shape[1];
      if (unlikely(__pyx_t_8 < 0)) __PYX_ERR(0, 1728, __pyx_L1_error)
    }
    __pyx_t_25 = 0;
    __Pyx_DECREF_SET(__pyx_v_stars_p, ((PyArrayObject *)__pyx_t_2));
    __pyx_t_2 = 0;
    __pyx_t_32 = ((PyArrayObject *)__pyx_t_4);
    {
      __Pyx_BufFmt_StackElem __pyx_stack[1];
      __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_cov_p.rcbuffer->pybuffer);
      __pyx_t_8 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_cov_p.rcbuffer->pybuffer, (PyObject*)__pyx_t_32, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 1, 0, __pyx_stack);
      if (unlikely(__pyx_t_8 < 0)) {
        PyErr_Fetch(&__pyx_t_22, &__pyx_t_23, &__pyx_t_24);
        if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_cov_p.rcbuffer->pybuffer, (PyObject*)__pyx_v_cov_p, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 1, 0, __pyx_stack) == -1)) {
          Py_XDECREF(__pyx_t_22); Py_XDECREF(__pyx_t_23); Py_XDECREF(__pyx_t_24);
          __Pyx_RaiseBufferFallbackError();
        } else {
          PyErr_Restore(__pyx_t_22, __pyx_t_23, __pyx_t_24);
        }
      }
      __pyx_pybuffernd_cov_p.diminfo[0].strides = __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_cov_p.diminfo[0].shape = __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.shape[0];
      if (unlikely(__pyx_t_8 < 0)) __PYX_ERR(0, 1728, __pyx_L1_error)
    }
    __pyx_t_32 = 0;
    __Pyx_DECREF_SET(__pyx_v_cov_p, ((PyArrayObject *)__pyx_t_4));
    __pyx_t_4 = 0;

    /* "orb/cutils.pyx":1732
 * 
 *         # compute reduced chi square
 *         chisq = np.sum(last_diff**2.)             # <<<<<<<<<<<<<<
 *         red_chisq = chisq / (np.sum(frame_mask) - np.size(free_p))
 *         returned_data['reduced-chi-square'] = red_chisq
 */
    __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1732, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_sum); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1732, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_t_4 = PyNumber_Power(__pyx_v_last_diff, __pyx_float_2_, Py_None); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1732, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __pyx_t_5 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_2))) {
      __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_2);
      if (likely(__pyx_t_5)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
        __Pyx_INCREF(__pyx_t_5);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_2, function);
      }
    }
    if (!__pyx_t_5) {
      __pyx_t_72 = __Pyx_PyObject_CallOneArg(__pyx_t_2, __pyx_t_4); if (unlikely(!__pyx_t_72)) __PYX_ERR(0, 1732, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __Pyx_GOTREF(__pyx_t_72);
    } else {
      __pyx_t_40 = PyTuple_New(1+1); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1732, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_40);
      __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_40, 0, __pyx_t_5); __pyx_t_5 = NULL;
      __Pyx_GIVEREF(__pyx_t_4);
      PyTuple_SET_ITEM(__pyx_t_40, 0+1, __pyx_t_4);
      __pyx_t_4 = 0;
      __pyx_t_72 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_40, NULL); if (unlikely(!__pyx_t_72)) __PYX_ERR(0, 1732, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_72);
      __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;
    }
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __pyx_v_chisq = __pyx_t_72;
    __pyx_t_72 = 0;

    /* "orb/cutils.pyx":1733
 *         # compute reduced chi square
 *         chisq = np.sum(last_diff**2.)
 *         red_chisq = chisq / (np.sum(frame_mask) - np.size(free_p))             # <<<<<<<<<<<<<<
 *         returned_data['reduced-chi-square'] = red_chisq
 *         returned_data['chi-square'] = chisq
 */
    __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1733, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __pyx_t_40 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_sum); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1733, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_40);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __pyx_t_2 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_40))) {
      __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_40);
      if (likely(__pyx_t_2)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_40);
        __Pyx_INCREF(__pyx_t_2);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_40, function);
      }
    }
    if (!__pyx_t_2) {
      __pyx_t_72 = __Pyx_PyObject_CallOneArg(__pyx_t_40, ((PyObject *)__pyx_v_frame_mask)); if (unlikely(!__pyx_t_72)) __PYX_ERR(0, 1733, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_72);
    } else {
      __pyx_t_4 = PyTuple_New(1+1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1733, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_2); __pyx_t_2 = NULL;
      __Pyx_INCREF(((PyObject *)__pyx_v_frame_mask));
      __Pyx_GIVEREF(((PyObject *)__pyx_v_frame_mask));
      PyTuple_SET_ITEM(__pyx_t_4, 0+1, ((PyObject *)__pyx_v_frame_mask));
      __pyx_t_72 = __Pyx_PyObject_Call(__pyx_t_40, __pyx_t_4, NULL); if (unlikely(!__pyx_t_72)) __PYX_ERR(0, 1733, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_72);
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    }
    __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;
    __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1733, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_size); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1733, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_t_4 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_2))) {
      __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_2);
      if (likely(__pyx_t_4)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
        __Pyx_INCREF(__pyx_t_4);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_2, function);
      }
    }
    if (!__pyx_t_4) {
      __pyx_t_40 = __Pyx_PyObject_CallOneArg(__pyx_t_2, ((PyObject *)__pyx_v_free_p)); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1733, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_40);
    } else {
      __pyx_t_5 = PyTuple_New(1+1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1733, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_4); __pyx_t_4 = NULL;
      __Pyx_INCREF(((PyObject *)__pyx_v_free_p));
      __Pyx_GIVEREF(((PyObject *)__pyx_v_free_p));
      PyTuple_SET_ITEM(__pyx_t_5, 0+1, ((PyObject *)__pyx_v_free_p));
      __pyx_t_40 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_5, NULL); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1733, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_40);
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    }
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __pyx_t_2 = PyNumber_Subtract(__pyx_t_72, __pyx_t_40); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1733, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_DECREF(__pyx_t_72); __pyx_t_72 = 0;
    __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;
    __pyx_t_40 = __Pyx_PyNumber_Divide(__pyx_v_chisq, __pyx_t_2); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1733, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_40);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __pyx_v_red_chisq = __pyx_t_40;
    __pyx_t_40 = 0;

    /* "orb/cutils.pyx":1734
 *         chisq = np.sum(last_diff**2.)
 *         red_chisq = chisq / (np.sum(frame_mask) - np.size(free_p))
 *         returned_data['reduced-chi-square'] = red_chisq             # <<<<<<<<<<<<<<
 *         returned_data['chi-square'] = chisq
 *         returned_data['cov_angle'] = cov_p[6]
 */
    if (unlikely(PyDict_SetItem(__pyx_v_returned_data, __pyx_kp_s_reduced_chi_square, __pyx_v_red_chisq) < 0)) __PYX_ERR(0, 1734, __pyx_L1_error)

    /* "orb/cutils.pyx":1735
 *         red_chisq = chisq / (np.sum(frame_mask) - np.size(free_p))
 *         returned_data['reduced-chi-square'] = red_chisq
 *         returned_data['chi-square'] = chisq             # <<<<<<<<<<<<<<
 *         returned_data['cov_angle'] = cov_p[6]
 *         returned_data['cov_zx'] = cov_p[4]
 */
    if (unlikely(PyDict_SetItem(__pyx_v_returned_data, __pyx_kp_s_chi_square, __pyx_v_chisq) < 0)) __PYX_ERR(0, 1735, __pyx_L1_error)

    /* "orb/cutils.pyx":1736
 *         returned_data['reduced-chi-square'] = red_chisq
 *         returned_data['chi-square'] = chisq
 *         returned_data['cov_angle'] = cov_p[6]             # <<<<<<<<<<<<<<
 *         returned_data['cov_zx'] = cov_p[4]
 *         returned_data['cov_zy'] = cov_p[5]
 */
    __pyx_t_94 = 6;
    __pyx_t_8 = -1;
    if (__pyx_t_94 < 0) {
      __pyx_t_94 += __pyx_pybuffernd_cov_p.diminfo[0].shape;
      if (unlikely(__pyx_t_94 < 0)) __pyx_t_8 = 0;
    } else if (unlikely(__pyx_t_94 >= __pyx_pybuffernd_cov_p.diminfo[0].shape)) __pyx_t_8 = 0;
    if (unlikely(__pyx_t_8 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_8);
      __PYX_ERR(0, 1736, __pyx_L1_error)
    }
    __pyx_t_40 = PyFloat_FromDouble((*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.buf, __pyx_t_94, __pyx_pybuffernd_cov_p.diminfo[0].strides))); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1736, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_40);
    if (unlikely(PyDict_SetItem(__pyx_v_returned_data, __pyx_n_s_cov_angle, __pyx_t_40) < 0)) __PYX_ERR(0, 1736, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;

    /* "orb/cutils.pyx":1737
 *         returned_data['chi-square'] = chisq
 *         returned_data['cov_angle'] = cov_p[6]
 *         returned_data['cov_zx'] = cov_p[4]             # <<<<<<<<<<<<<<
 *         returned_data['cov_zy'] = cov_p[5]
 *         returned_data['cov_dx'] = cov_p[1]
 */
    __pyx_t_95 = 4;
    __pyx_t_8 = -1;
    if (__pyx_t_95 < 0) {
      __pyx_t_95 += __pyx_pybuffernd_cov_p.diminfo[0].shape;
      if (unlikely(__pyx_t_95 < 0)) __pyx_t_8 = 0;
    } else if (unlikely(__pyx_t_95 >= __pyx_pybuffernd_cov_p.diminfo[0].shape)) __pyx_t_8 = 0;
    if (unlikely(__pyx_t_8 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_8);
      __PYX_ERR(0, 1737, __pyx_L1_error)
    }
    __pyx_t_40 = PyFloat_FromDouble((*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.buf, __pyx_t_95, __pyx_pybuffernd_cov_p.diminfo[0].strides))); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1737, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_40);
    if (unlikely(PyDict_SetItem(__pyx_v_returned_data, __pyx_n_s_cov_zx, __pyx_t_40) < 0)) __PYX_ERR(0, 1737, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;

    /* "orb/cutils.pyx":1738
 *         returned_data['cov_angle'] = cov_p[6]
 *         returned_data['cov_zx'] = cov_p[4]
 *         returned_data['cov_zy'] = cov_p[5]             # <<<<<<<<<<<<<<
 *         returned_data['cov_dx'] = cov_p[1]
 *         returned_data['cov_dy'] = cov_p[2]
 */
    __pyx_t_96 = 5;
    __pyx_t_8 = -1;
    if (__pyx_t_96 < 0) {
      __pyx_t_96 += __pyx_pybuffernd_cov_p.diminfo[0].shape;
      if (unlikely(__pyx_t_96 < 0)) __pyx_t_8 = 0;
    } else if (unlikely(__pyx_t_96 >= __pyx_pybuffernd_cov_p.diminfo[0].shape)) __pyx_t_8 = 0;
    if (unlikely(__pyx_t_8 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_8);
      __PYX_ERR(0, 1738, __pyx_L1_error)
    }
    __pyx_t_40 = PyFloat_FromDouble((*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.buf, __pyx_t_96, __pyx_pybuffernd_cov_p.diminfo[0].strides))); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1738, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_40);
    if (unlikely(PyDict_SetItem(__pyx_v_returned_data, __pyx_n_s_cov_zy, __pyx_t_40) < 0)) __PYX_ERR(0, 1738, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;

    /* "orb/cutils.pyx":1739
 *         returned_data['cov_zx'] = cov_p[4]
 *         returned_data['cov_zy'] = cov_p[5]
 *         returned_data['cov_dx'] = cov_p[1]             # <<<<<<<<<<<<<<
 *         returned_data['cov_dy'] = cov_p[2]
 * 
 */
    __pyx_t_97 = 1;
    __pyx_t_8 = -1;
    if (__pyx_t_97 < 0) {
      __pyx_t_97 += __pyx_pybuffernd_cov_p.diminfo[0].shape;
      if (unlikely(__pyx_t_97 < 0)) __pyx_t_8 = 0;
    } else if (unlikely(__pyx_t_97 >= __pyx_pybuffernd_cov_p.diminfo[0].shape)) __pyx_t_8 = 0;
    if (unlikely(__pyx_t_8 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_8);
      __PYX_ERR(0, 1739, __pyx_L1_error)
    }
    __pyx_t_40 = PyFloat_FromDouble((*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.buf, __pyx_t_97, __pyx_pybuffernd_cov_p.diminfo[0].strides))); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1739, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_40);
    if (unlikely(PyDict_SetItem(__pyx_v_returned_data, __pyx_n_s_cov_dx, __pyx_t_40) < 0)) __PYX_ERR(0, 1739, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;

    /* "orb/cutils.pyx":1740
 *         returned_data['cov_zy'] = cov_p[5]
 *         returned_data['cov_dx'] = cov_p[1]
 *         returned_data['cov_dy'] = cov_p[2]             # <<<<<<<<<<<<<<
 * 
 *         # cov height and fwhm
 */
    __pyx_t_98 = 2;
    __pyx_t_8 = -1;
    if (__pyx_t_98 < 0) {
      __pyx_t_98 += __pyx_pybuffernd_cov_p.diminfo[0].shape;
      if (unlikely(__pyx_t_98 < 0)) __pyx_t_8 = 0;
    } else if (unlikely(__pyx_t_98 >= __pyx_pybuffernd_cov_p.diminfo[0].shape)) __pyx_t_8 = 0;
    if (unlikely(__pyx_t_8 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_8);
      __PYX_ERR(0, 1740, __pyx_L1_error)
    }
    __pyx_t_40 = PyFloat_FromDouble((*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.buf, __pyx_t_98, __pyx_pybuffernd_cov_p.diminfo[0].strides))); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1740, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_40);
    if (unlikely(PyDict_SetItem(__pyx_v_returned_data, __pyx_n_s_cov_dy, __pyx_t_40) < 0)) __PYX_ERR(0, 1740, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;

    /* "orb/cutils.pyx":1743
 * 
 *         # cov height and fwhm
 *         stars_p[:,0] += cov_p[0] - added_height # HEIGHT             # <<<<<<<<<<<<<<
 *         stars_p[:,4] = np.sqrt(stars_p[:,4]**2. + cov_p[3]**2.) # FWHM
 *         # compute least square fit errors and add cov dx, dy and zoom
 */
    __Pyx_INCREF(__pyx_tuple__118);
    __pyx_t_49 = __pyx_tuple__118;
    __pyx_t_40 = PyObject_GetItem(((PyObject *)__pyx_v_stars_p), __pyx_t_49); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1743, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_40);
    __pyx_t_99 = 0;
    __pyx_t_8 = -1;
    if (__pyx_t_99 < 0) {
      __pyx_t_99 += __pyx_pybuffernd_cov_p.diminfo[0].shape;
      if (unlikely(__pyx_t_99 < 0)) __pyx_t_8 = 0;
    } else if (unlikely(__pyx_t_99 >= __pyx_pybuffernd_cov_p.diminfo[0].shape)) __pyx_t_8 = 0;
    if (unlikely(__pyx_t_8 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_8);
      __PYX_ERR(0, 1743, __pyx_L1_error)
    }
    __pyx_t_2 = PyFloat_FromDouble((*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.buf, __pyx_t_99, __pyx_pybuffernd_cov_p.diminfo[0].strides))); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1743, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __pyx_t_72 = PyNumber_Subtract(__pyx_t_2, __pyx_v_added_height); if (unlikely(!__pyx_t_72)) __PYX_ERR(0, 1743, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_72);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __pyx_t_2 = PyNumber_InPlaceAdd(__pyx_t_40, __pyx_t_72); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1743, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;
    __Pyx_DECREF(__pyx_t_72); __pyx_t_72 = 0;
    if (unlikely(PyObject_SetItem(((PyObject *)__pyx_v_stars_p), __pyx_t_49, __pyx_t_2) < 0)) __PYX_ERR(0, 1743, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __Pyx_DECREF(__pyx_t_49); __pyx_t_49 = 0;

    /* "orb/cutils.pyx":1744
 *         # cov height and fwhm
 *         stars_p[:,0] += cov_p[0] - added_height # HEIGHT
 *         stars_p[:,4] = np.sqrt(stars_p[:,4]**2. + cov_p[3]**2.) # FWHM             # <<<<<<<<<<<<<<
 *         # compute least square fit errors and add cov dx, dy and zoom
 *         rcx = <double> frame.shape[0] / 2.
 */
    __pyx_t_72 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_72)) __PYX_ERR(0, 1744, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_72);
    __pyx_t_40 = __Pyx_PyObject_GetAttrStr(__pyx_t_72, __pyx_n_s_sqrt); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1744, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_40);
    __Pyx_DECREF(__pyx_t_72); __pyx_t_72 = 0;
    __pyx_t_72 = PyObject_GetItem(((PyObject *)__pyx_v_stars_p), __pyx_tuple__120); if (unlikely(!__pyx_t_72)) __PYX_ERR(0, 1744, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_72);
    __pyx_t_5 = PyNumber_Power(__pyx_t_72, __pyx_float_2_, Py_None); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1744, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_DECREF(__pyx_t_72); __pyx_t_72 = 0;
    __pyx_t_100 = 3;
    __pyx_t_8 = -1;
    if (__pyx_t_100 < 0) {
      __pyx_t_100 += __pyx_pybuffernd_cov_p.diminfo[0].shape;
      if (unlikely(__pyx_t_100 < 0)) __pyx_t_8 = 0;
    } else if (unlikely(__pyx_t_100 >= __pyx_pybuffernd_cov_p.diminfo[0].shape)) __pyx_t_8 = 0;
    if (unlikely(__pyx_t_8 != -1)) {
      __Pyx_RaiseBufferIndexError(__pyx_t_8);
      __PYX_ERR(0, 1744, __pyx_L1_error)
    }
    __pyx_t_72 = PyFloat_FromDouble(pow((*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.buf, __pyx_t_100, __pyx_pybuffernd_cov_p.diminfo[0].strides)), ((__pyx_t_5numpy_float64_t)2.))); if (unlikely(!__pyx_t_72)) __PYX_ERR(0, 1744, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_72);
    __pyx_t_4 = PyNumber_Add(__pyx_t_5, __pyx_t_72); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1744, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    __Pyx_DECREF(__pyx_t_72); __pyx_t_72 = 0;
    __pyx_t_72 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_40))) {
      __pyx_t_72 = PyMethod_GET_SELF(__pyx_t_40);
      if (likely(__pyx_t_72)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_40);
        __Pyx_INCREF(__pyx_t_72);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_40, function);
      }
    }
    if (!__pyx_t_72) {
      __pyx_t_2 = __Pyx_PyObject_CallOneArg(__pyx_t_40, __pyx_t_4); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1744, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __Pyx_GOTREF(__pyx_t_2);
    } else {
      __pyx_t_5 = PyTuple_New(1+1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1744, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __Pyx_GIVEREF(__pyx_t_72); PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_72); __pyx_t_72 = NULL;
      __Pyx_GIVEREF(__pyx_t_4);
      PyTuple_SET_ITEM(__pyx_t_5, 0+1, __pyx_t_4);
      __pyx_t_4 = 0;
      __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_40, __pyx_t_5, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1744, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    }
    __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;
    if (unlikely(PyObject_SetItem(((PyObject *)__pyx_v_stars_p), __pyx_tuple__122, __pyx_t_2) < 0)) __PYX_ERR(0, 1744, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;

    /* "orb/cutils.pyx":1746
 *         stars_p[:,4] = np.sqrt(stars_p[:,4]**2. + cov_p[3]**2.) # FWHM
 *         # compute least square fit errors and add cov dx, dy and zoom
 *         rcx = <double> frame.shape[0] / 2.             # <<<<<<<<<<<<<<
 *         rcy = <double> frame.shape[1] / 2.
 *         cov_matrix = fit[1]
 */
    __pyx_v_rcx = (((double)(__pyx_v_frame->dimensions[0])) / 2.);

    /* "orb/cutils.pyx":1747
 *         # compute least square fit errors and add cov dx, dy and zoom
 *         rcx = <double> frame.shape[0] / 2.
 *         rcy = <double> frame.shape[1] / 2.             # <<<<<<<<<<<<<<
 *         cov_matrix = fit[1]
 * 
 */
    __pyx_v_rcy = (((double)(__pyx_v_frame->dimensions[1])) / 2.);

    /* "orb/cutils.pyx":1748
 *         rcx = <double> frame.shape[0] / 2.
 *         rcy = <double> frame.shape[1] / 2.
 *         cov_matrix = fit[1]             # <<<<<<<<<<<<<<
 * 
 *         if cov_matrix is None: # no covariance : no error estimation
 */
    __pyx_t_2 = __Pyx_GetItemInt(__pyx_v_fit, 1, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1748, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    if (!(likely(((__pyx_t_2) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_2, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1748, __pyx_L1_error)
    __pyx_t_61 = ((PyArrayObject *)__pyx_t_2);
    {
      __Pyx_BufFmt_StackElem __pyx_stack[1];
      __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_cov_matrix.rcbuffer->pybuffer);
      __pyx_t_8 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_cov_matrix.rcbuffer->pybuffer, (PyObject*)__pyx_t_61, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
      if (unlikely(__pyx_t_8 < 0)) {
        PyErr_Fetch(&__pyx_t_24, &__pyx_t_23, &__pyx_t_22);
        if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_cov_matrix.rcbuffer->pybuffer, (PyObject*)__pyx_v_cov_matrix, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
          Py_XDECREF(__pyx_t_24); Py_XDECREF(__pyx_t_23); Py_XDECREF(__pyx_t_22);
          __Pyx_RaiseBufferFallbackError();
        } else {
          PyErr_Restore(__pyx_t_24, __pyx_t_23, __pyx_t_22);
        }
      }
      __pyx_pybuffernd_cov_matrix.diminfo[0].strides = __pyx_pybuffernd_cov_matrix.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_cov_matrix.diminfo[0].shape = __pyx_pybuffernd_cov_matrix.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_cov_matrix.diminfo[1].strides = __pyx_pybuffernd_cov_matrix.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_cov_matrix.diminfo[1].shape = __pyx_pybuffernd_cov_matrix.rcbuffer->pybuffer.shape[1];
      if (unlikely(__pyx_t_8 < 0)) __PYX_ERR(0, 1748, __pyx_L1_error)
    }
    __pyx_t_61 = 0;
    __pyx_v_cov_matrix = ((PyArrayObject *)__pyx_t_2);
    __pyx_t_2 = 0;

    /* "orb/cutils.pyx":1750
 *         cov_matrix = fit[1]
 * 
 *         if cov_matrix is None: # no covariance : no error estimation             # <<<<<<<<<<<<<<
 *             stars_err.fill(np.nan)
 *             # compute transformed postitions
 */
    __pyx_t_13 = (((PyObject *)__pyx_v_cov_matrix) == Py_None);
    __pyx_t_80 = (__pyx_t_13 != 0);
    if (__pyx_t_80) {

      /* "orb/cutils.pyx":1751
 * 
 *         if cov_matrix is None: # no covariance : no error estimation
 *             stars_err.fill(np.nan)             # <<<<<<<<<<<<<<
 *             # compute transformed postitions
 *             for istar in range(stars_p.shape[0]):
 */
      __pyx_t_40 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_stars_err), __pyx_n_s_fill); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1751, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_40);
      __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1751, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_nan); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1751, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
      __pyx_t_5 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && likely(PyMethod_Check(__pyx_t_40))) {
        __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_40);
        if (likely(__pyx_t_5)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_40);
          __Pyx_INCREF(__pyx_t_5);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_40, function);
        }
      }
      if (!__pyx_t_5) {
        __pyx_t_2 = __Pyx_PyObject_CallOneArg(__pyx_t_40, __pyx_t_4); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1751, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
        __Pyx_GOTREF(__pyx_t_2);
      } else {
        __pyx_t_72 = PyTuple_New(1+1); if (unlikely(!__pyx_t_72)) __PYX_ERR(0, 1751, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_72);
        __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_72, 0, __pyx_t_5); __pyx_t_5 = NULL;
        __Pyx_GIVEREF(__pyx_t_4);
        PyTuple_SET_ITEM(__pyx_t_72, 0+1, __pyx_t_4);
        __pyx_t_4 = 0;
        __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_40, __pyx_t_72, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1751, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_2);
        __Pyx_DECREF(__pyx_t_72); __pyx_t_72 = 0;
      }
      __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;
      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;

      /* "orb/cutils.pyx":1753
 *             stars_err.fill(np.nan)
 *             # compute transformed postitions
 *             for istar in range(stars_p.shape[0]):             # <<<<<<<<<<<<<<
 *                 stars_p[istar,2], stars_p[istar,3] = transform_A_to_B(
 *                     stars_p[istar,2], stars_p[istar,3], -cov_p[1], -cov_p[2],
 */
      __pyx_t_7 = (__pyx_v_stars_p->dimensions[0]);
      for (__pyx_t_8 = 0; __pyx_t_8 < __pyx_t_7; __pyx_t_8+=1) {
        __pyx_v_istar = __pyx_t_8;

        /* "orb/cutils.pyx":1754
 *             # compute transformed postitions
 *             for istar in range(stars_p.shape[0]):
 *                 stars_p[istar,2], stars_p[istar,3] = transform_A_to_B(             # <<<<<<<<<<<<<<
 *                     stars_p[istar,2], stars_p[istar,3], -cov_p[1], -cov_p[2],
 *                     cov_p[6], 0., 0., rcx, rcy, cov_p[4], cov_p[5])
 */
        __pyx_t_40 = __Pyx_GetModuleGlobalName(__pyx_n_s_transform_A_to_B); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1754, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_40);

        /* "orb/cutils.pyx":1755
 *             for istar in range(stars_p.shape[0]):
 *                 stars_p[istar,2], stars_p[istar,3] = transform_A_to_B(
 *                     stars_p[istar,2], stars_p[istar,3], -cov_p[1], -cov_p[2],             # <<<<<<<<<<<<<<
 *                     cov_p[6], 0., 0., rcx, rcy, cov_p[4], cov_p[5])
 *             if sip is not None:
 */
        __pyx_t_101 = __pyx_v_istar;
        __pyx_t_102 = 2;
        __pyx_t_12 = -1;
        if (__pyx_t_101 < 0) {
          __pyx_t_101 += __pyx_pybuffernd_stars_p.diminfo[0].shape;
          if (unlikely(__pyx_t_101 < 0)) __pyx_t_12 = 0;
        } else if (unlikely(__pyx_t_101 >= __pyx_pybuffernd_stars_p.diminfo[0].shape)) __pyx_t_12 = 0;
        if (__pyx_t_102 < 0) {
          __pyx_t_102 += __pyx_pybuffernd_stars_p.diminfo[1].shape;
          if (unlikely(__pyx_t_102 < 0)) __pyx_t_12 = 1;
        } else if (unlikely(__pyx_t_102 >= __pyx_pybuffernd_stars_p.diminfo[1].shape)) __pyx_t_12 = 1;
        if (unlikely(__pyx_t_12 != -1)) {
          __Pyx_RaiseBufferIndexError(__pyx_t_12);
          __PYX_ERR(0, 1755, __pyx_L1_error)
        }
        __pyx_t_72 = PyFloat_FromDouble((*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_stars_p.rcbuffer->pybuffer.buf, __pyx_t_101, __pyx_pybuffernd_stars_p.diminfo[0].strides, __pyx_t_102, __pyx_pybuffernd_stars_p.diminfo[1].strides))); if (unlikely(!__pyx_t_72)) __PYX_ERR(0, 1755, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_72);
        __pyx_t_103 = __pyx_v_istar;
        __pyx_t_104 = 3;
        __pyx_t_12 = -1;
        if (__pyx_t_103 < 0) {
          __pyx_t_103 += __pyx_pybuffernd_stars_p.diminfo[0].shape;
          if (unlikely(__pyx_t_103 < 0)) __pyx_t_12 = 0;
        } else if (unlikely(__pyx_t_103 >= __pyx_pybuffernd_stars_p.diminfo[0].shape)) __pyx_t_12 = 0;
        if (__pyx_t_104 < 0) {
          __pyx_t_104 += __pyx_pybuffernd_stars_p.diminfo[1].shape;
          if (unlikely(__pyx_t_104 < 0)) __pyx_t_12 = 1;
        } else if (unlikely(__pyx_t_104 >= __pyx_pybuffernd_stars_p.diminfo[1].shape)) __pyx_t_12 = 1;
        if (unlikely(__pyx_t_12 != -1)) {
          __Pyx_RaiseBufferIndexError(__pyx_t_12);
          __PYX_ERR(0, 1755, __pyx_L1_error)
        }
        __pyx_t_4 = PyFloat_FromDouble((*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_stars_p.rcbuffer->pybuffer.buf, __pyx_t_103, __pyx_pybuffernd_stars_p.diminfo[0].strides, __pyx_t_104, __pyx_pybuffernd_stars_p.diminfo[1].strides))); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1755, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_4);
        __pyx_t_105 = 1;
        __pyx_t_12 = -1;
        if (__pyx_t_105 < 0) {
          __pyx_t_105 += __pyx_pybuffernd_cov_p.diminfo[0].shape;
          if (unlikely(__pyx_t_105 < 0)) __pyx_t_12 = 0;
        } else if (unlikely(__pyx_t_105 >= __pyx_pybuffernd_cov_p.diminfo[0].shape)) __pyx_t_12 = 0;
        if (unlikely(__pyx_t_12 != -1)) {
          __Pyx_RaiseBufferIndexError(__pyx_t_12);
          __PYX_ERR(0, 1755, __pyx_L1_error)
        }
        __pyx_t_5 = PyFloat_FromDouble((-(*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.buf, __pyx_t_105, __pyx_pybuffernd_cov_p.diminfo[0].strides)))); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1755, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_5);
        __pyx_t_106 = 2;
        __pyx_t_12 = -1;
        if (__pyx_t_106 < 0) {
          __pyx_t_106 += __pyx_pybuffernd_cov_p.diminfo[0].shape;
          if (unlikely(__pyx_t_106 < 0)) __pyx_t_12 = 0;
        } else if (unlikely(__pyx_t_106 >= __pyx_pybuffernd_cov_p.diminfo[0].shape)) __pyx_t_12 = 0;
        if (unlikely(__pyx_t_12 != -1)) {
          __Pyx_RaiseBufferIndexError(__pyx_t_12);
          __PYX_ERR(0, 1755, __pyx_L1_error)
        }
        __pyx_t_42 = PyFloat_FromDouble((-(*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.buf, __pyx_t_106, __pyx_pybuffernd_cov_p.diminfo[0].strides)))); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1755, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_42);

        /* "orb/cutils.pyx":1756
 *                 stars_p[istar,2], stars_p[istar,3] = transform_A_to_B(
 *                     stars_p[istar,2], stars_p[istar,3], -cov_p[1], -cov_p[2],
 *                     cov_p[6], 0., 0., rcx, rcy, cov_p[4], cov_p[5])             # <<<<<<<<<<<<<<
 *             if sip is not None:
 *                 stars_p[:,2:4] = sip_im2pix(stars_p[:,2:4], sip)
 */
        __pyx_t_107 = 6;
        __pyx_t_12 = -1;
        if (__pyx_t_107 < 0) {
          __pyx_t_107 += __pyx_pybuffernd_cov_p.diminfo[0].shape;
          if (unlikely(__pyx_t_107 < 0)) __pyx_t_12 = 0;
        } else if (unlikely(__pyx_t_107 >= __pyx_pybuffernd_cov_p.diminfo[0].shape)) __pyx_t_12 = 0;
        if (unlikely(__pyx_t_12 != -1)) {
          __Pyx_RaiseBufferIndexError(__pyx_t_12);
          __PYX_ERR(0, 1756, __pyx_L1_error)
        }
        __pyx_t_3 = PyFloat_FromDouble((*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.buf, __pyx_t_107, __pyx_pybuffernd_cov_p.diminfo[0].strides))); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1756, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_3);
        __pyx_t_71 = PyFloat_FromDouble(__pyx_v_rcx); if (unlikely(!__pyx_t_71)) __PYX_ERR(0, 1756, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_71);
        __pyx_t_70 = PyFloat_FromDouble(__pyx_v_rcy); if (unlikely(!__pyx_t_70)) __PYX_ERR(0, 1756, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_70);
        __pyx_t_108 = 4;
        __pyx_t_12 = -1;
        if (__pyx_t_108 < 0) {
          __pyx_t_108 += __pyx_pybuffernd_cov_p.diminfo[0].shape;
          if (unlikely(__pyx_t_108 < 0)) __pyx_t_12 = 0;
        } else if (unlikely(__pyx_t_108 >= __pyx_pybuffernd_cov_p.diminfo[0].shape)) __pyx_t_12 = 0;
        if (unlikely(__pyx_t_12 != -1)) {
          __Pyx_RaiseBufferIndexError(__pyx_t_12);
          __PYX_ERR(0, 1756, __pyx_L1_error)
        }
        __pyx_t_43 = PyFloat_FromDouble((*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.buf, __pyx_t_108, __pyx_pybuffernd_cov_p.diminfo[0].strides))); if (unlikely(!__pyx_t_43)) __PYX_ERR(0, 1756, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_43);
        __pyx_t_109 = 5;
        __pyx_t_12 = -1;
        if (__pyx_t_109 < 0) {
          __pyx_t_109 += __pyx_pybuffernd_cov_p.diminfo[0].shape;
          if (unlikely(__pyx_t_109 < 0)) __pyx_t_12 = 0;
        } else if (unlikely(__pyx_t_109 >= __pyx_pybuffernd_cov_p.diminfo[0].shape)) __pyx_t_12 = 0;
        if (unlikely(__pyx_t_12 != -1)) {
          __Pyx_RaiseBufferIndexError(__pyx_t_12);
          __PYX_ERR(0, 1756, __pyx_L1_error)
        }
        __pyx_t_44 = PyFloat_FromDouble((*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.buf, __pyx_t_109, __pyx_pybuffernd_cov_p.diminfo[0].strides))); if (unlikely(!__pyx_t_44)) __PYX_ERR(0, 1756, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_44);
        __pyx_t_1 = NULL;
        __pyx_t_46 = 0;
        if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_40))) {
          __pyx_t_1 = PyMethod_GET_SELF(__pyx_t_40);
          if (likely(__pyx_t_1)) {
            PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_40);
            __Pyx_INCREF(__pyx_t_1);
            __Pyx_INCREF(function);
            __Pyx_DECREF_SET(__pyx_t_40, function);
            __pyx_t_46 = 1;
          }
        }
        __pyx_t_110 = PyTuple_New(11+__pyx_t_46); if (unlikely(!__pyx_t_110)) __PYX_ERR(0, 1754, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_110);
        if (__pyx_t_1) {
          __Pyx_GIVEREF(__pyx_t_1); PyTuple_SET_ITEM(__pyx_t_110, 0, __pyx_t_1); __pyx_t_1 = NULL;
        }
        __Pyx_GIVEREF(__pyx_t_72);
        PyTuple_SET_ITEM(__pyx_t_110, 0+__pyx_t_46, __pyx_t_72);
        __Pyx_GIVEREF(__pyx_t_4);
        PyTuple_SET_ITEM(__pyx_t_110, 1+__pyx_t_46, __pyx_t_4);
        __Pyx_GIVEREF(__pyx_t_5);
        PyTuple_SET_ITEM(__pyx_t_110, 2+__pyx_t_46, __pyx_t_5);
        __Pyx_GIVEREF(__pyx_t_42);
        PyTuple_SET_ITEM(__pyx_t_110, 3+__pyx_t_46, __pyx_t_42);
        __Pyx_GIVEREF(__pyx_t_3);
        PyTuple_SET_ITEM(__pyx_t_110, 4+__pyx_t_46, __pyx_t_3);
        __Pyx_INCREF(__pyx_float_0_);
        __Pyx_GIVEREF(__pyx_float_0_);
        PyTuple_SET_ITEM(__pyx_t_110, 5+__pyx_t_46, __pyx_float_0_);
        __Pyx_INCREF(__pyx_float_0_);
        __Pyx_GIVEREF(__pyx_float_0_);
        PyTuple_SET_ITEM(__pyx_t_110, 6+__pyx_t_46, __pyx_float_0_);
        __Pyx_GIVEREF(__pyx_t_71);
        PyTuple_SET_ITEM(__pyx_t_110, 7+__pyx_t_46, __pyx_t_71);
        __Pyx_GIVEREF(__pyx_t_70);
        PyTuple_SET_ITEM(__pyx_t_110, 8+__pyx_t_46, __pyx_t_70);
        __Pyx_GIVEREF(__pyx_t_43);
        PyTuple_SET_ITEM(__pyx_t_110, 9+__pyx_t_46, __pyx_t_43);
        __Pyx_GIVEREF(__pyx_t_44);
        PyTuple_SET_ITEM(__pyx_t_110, 10+__pyx_t_46, __pyx_t_44);
        __pyx_t_72 = 0;
        __pyx_t_4 = 0;
        __pyx_t_5 = 0;
        __pyx_t_42 = 0;
        __pyx_t_3 = 0;
        __pyx_t_71 = 0;
        __pyx_t_70 = 0;
        __pyx_t_43 = 0;
        __pyx_t_44 = 0;
        __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_40, __pyx_t_110, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1754, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_2);
        __Pyx_DECREF(__pyx_t_110); __pyx_t_110 = 0;
        __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;
        if ((likely(PyTuple_CheckExact(__pyx_t_2))) || (PyList_CheckExact(__pyx_t_2))) {
          PyObject* sequence = __pyx_t_2;
          #if CYTHON_COMPILING_IN_CPYTHON
          Py_ssize_t size = Py_SIZE(sequence);
          #else
          Py_ssize_t size = PySequence_Size(sequence);
          #endif
          if (unlikely(size != 2)) {
            if (size > 2) __Pyx_RaiseTooManyValuesError(2);
            else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
            __PYX_ERR(0, 1754, __pyx_L1_error)
          }
          #if CYTHON_COMPILING_IN_CPYTHON
          if (likely(PyTuple_CheckExact(sequence))) {
            __pyx_t_40 = PyTuple_GET_ITEM(sequence, 0); 
            __pyx_t_110 = PyTuple_GET_ITEM(sequence, 1); 
          } else {
            __pyx_t_40 = PyList_GET_ITEM(sequence, 0); 
            __pyx_t_110 = PyList_GET_ITEM(sequence, 1); 
          }
          __Pyx_INCREF(__pyx_t_40);
          __Pyx_INCREF(__pyx_t_110);
          #else
          __pyx_t_40 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1754, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_40);
          __pyx_t_110 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_110)) __PYX_ERR(0, 1754, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_110);
          #endif
          __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
        } else {
          Py_ssize_t index = -1;
          __pyx_t_44 = PyObject_GetIter(__pyx_t_2); if (unlikely(!__pyx_t_44)) __PYX_ERR(0, 1754, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_44);
          __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
          __pyx_t_57 = Py_TYPE(__pyx_t_44)->tp_iternext;
          index = 0; __pyx_t_40 = __pyx_t_57(__pyx_t_44); if (unlikely(!__pyx_t_40)) goto __pyx_L67_unpacking_failed;
          __Pyx_GOTREF(__pyx_t_40);
          index = 1; __pyx_t_110 = __pyx_t_57(__pyx_t_44); if (unlikely(!__pyx_t_110)) goto __pyx_L67_unpacking_failed;
          __Pyx_GOTREF(__pyx_t_110);
          if (__Pyx_IternextUnpackEndCheck(__pyx_t_57(__pyx_t_44), 2) < 0) __PYX_ERR(0, 1754, __pyx_L1_error)
          __pyx_t_57 = NULL;
          __Pyx_DECREF(__pyx_t_44); __pyx_t_44 = 0;
          goto __pyx_L68_unpacking_done;
          __pyx_L67_unpacking_failed:;
          __Pyx_DECREF(__pyx_t_44); __pyx_t_44 = 0;
          __pyx_t_57 = NULL;
          if (__Pyx_IterFinish() == 0) __Pyx_RaiseNeedMoreValuesError(index);
          __PYX_ERR(0, 1754, __pyx_L1_error)
          __pyx_L68_unpacking_done:;
        }

        /* "orb/cutils.pyx":1754
 *             # compute transformed postitions
 *             for istar in range(stars_p.shape[0]):
 *                 stars_p[istar,2], stars_p[istar,3] = transform_A_to_B(             # <<<<<<<<<<<<<<
 *                     stars_p[istar,2], stars_p[istar,3], -cov_p[1], -cov_p[2],
 *                     cov_p[6], 0., 0., rcx, rcy, cov_p[4], cov_p[5])
 */
        __pyx_t_62 = __pyx_PyFloat_AsDouble(__pyx_t_40); if (unlikely((__pyx_t_62 == (npy_float64)-1) && PyErr_Occurred())) __PYX_ERR(0, 1754, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;
        __pyx_t_111 = __pyx_PyFloat_AsDouble(__pyx_t_110); if (unlikely((__pyx_t_111 == (npy_float64)-1) && PyErr_Occurred())) __PYX_ERR(0, 1754, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_110); __pyx_t_110 = 0;
        __pyx_t_112 = __pyx_v_istar;
        __pyx_t_113 = 2;
        __pyx_t_12 = -1;
        if (__pyx_t_112 < 0) {
          __pyx_t_112 += __pyx_pybuffernd_stars_p.diminfo[0].shape;
          if (unlikely(__pyx_t_112 < 0)) __pyx_t_12 = 0;
        } else if (unlikely(__pyx_t_112 >= __pyx_pybuffernd_stars_p.diminfo[0].shape)) __pyx_t_12 = 0;
        if (__pyx_t_113 < 0) {
          __pyx_t_113 += __pyx_pybuffernd_stars_p.diminfo[1].shape;
          if (unlikely(__pyx_t_113 < 0)) __pyx_t_12 = 1;
        } else if (unlikely(__pyx_t_113 >= __pyx_pybuffernd_stars_p.diminfo[1].shape)) __pyx_t_12 = 1;
        if (unlikely(__pyx_t_12 != -1)) {
          __Pyx_RaiseBufferIndexError(__pyx_t_12);
          __PYX_ERR(0, 1754, __pyx_L1_error)
        }
        *__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_stars_p.rcbuffer->pybuffer.buf, __pyx_t_112, __pyx_pybuffernd_stars_p.diminfo[0].strides, __pyx_t_113, __pyx_pybuffernd_stars_p.diminfo[1].strides) = __pyx_t_62;
        __pyx_t_114 = __pyx_v_istar;
        __pyx_t_115 = 3;
        __pyx_t_12 = -1;
        if (__pyx_t_114 < 0) {
          __pyx_t_114 += __pyx_pybuffernd_stars_p.diminfo[0].shape;
          if (unlikely(__pyx_t_114 < 0)) __pyx_t_12 = 0;
        } else if (unlikely(__pyx_t_114 >= __pyx_pybuffernd_stars_p.diminfo[0].shape)) __pyx_t_12 = 0;
        if (__pyx_t_115 < 0) {
          __pyx_t_115 += __pyx_pybuffernd_stars_p.diminfo[1].shape;
          if (unlikely(__pyx_t_115 < 0)) __pyx_t_12 = 1;
        } else if (unlikely(__pyx_t_115 >= __pyx_pybuffernd_stars_p.diminfo[1].shape)) __pyx_t_12 = 1;
        if (unlikely(__pyx_t_12 != -1)) {
          __Pyx_RaiseBufferIndexError(__pyx_t_12);
          __PYX_ERR(0, 1754, __pyx_L1_error)
        }
        *__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_stars_p.rcbuffer->pybuffer.buf, __pyx_t_114, __pyx_pybuffernd_stars_p.diminfo[0].strides, __pyx_t_115, __pyx_pybuffernd_stars_p.diminfo[1].strides) = __pyx_t_111;
      }

      /* "orb/cutils.pyx":1757
 *                     stars_p[istar,2], stars_p[istar,3], -cov_p[1], -cov_p[2],
 *                     cov_p[6], 0., 0., rcx, rcy, cov_p[4], cov_p[5])
 *             if sip is not None:             # <<<<<<<<<<<<<<
 *                 stars_p[:,2:4] = sip_im2pix(stars_p[:,2:4], sip)
 * 
 */
      __pyx_t_80 = (__pyx_v_sip != Py_None);
      __pyx_t_13 = (__pyx_t_80 != 0);
      if (__pyx_t_13) {

        /* "orb/cutils.pyx":1758
 *                     cov_p[6], 0., 0., rcx, rcy, cov_p[4], cov_p[5])
 *             if sip is not None:
 *                 stars_p[:,2:4] = sip_im2pix(stars_p[:,2:4], sip)             # <<<<<<<<<<<<<<
 * 
 * 
 */
        __pyx_t_110 = __Pyx_GetModuleGlobalName(__pyx_n_s_sip_im2pix); if (unlikely(!__pyx_t_110)) __PYX_ERR(0, 1758, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_110);
        __pyx_t_40 = PyObject_GetItem(((PyObject *)__pyx_v_stars_p), __pyx_tuple__125); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1758, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_40);
        __pyx_t_44 = NULL;
        __pyx_t_46 = 0;
        if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_110))) {
          __pyx_t_44 = PyMethod_GET_SELF(__pyx_t_110);
          if (likely(__pyx_t_44)) {
            PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_110);
            __Pyx_INCREF(__pyx_t_44);
            __Pyx_INCREF(function);
            __Pyx_DECREF_SET(__pyx_t_110, function);
            __pyx_t_46 = 1;
          }
        }
        __pyx_t_43 = PyTuple_New(2+__pyx_t_46); if (unlikely(!__pyx_t_43)) __PYX_ERR(0, 1758, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_43);
        if (__pyx_t_44) {
          __Pyx_GIVEREF(__pyx_t_44); PyTuple_SET_ITEM(__pyx_t_43, 0, __pyx_t_44); __pyx_t_44 = NULL;
        }
        __Pyx_GIVEREF(__pyx_t_40);
        PyTuple_SET_ITEM(__pyx_t_43, 0+__pyx_t_46, __pyx_t_40);
        __Pyx_INCREF(__pyx_v_sip);
        __Pyx_GIVEREF(__pyx_v_sip);
        PyTuple_SET_ITEM(__pyx_t_43, 1+__pyx_t_46, __pyx_v_sip);
        __pyx_t_40 = 0;
        __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_110, __pyx_t_43, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1758, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_2);
        __Pyx_DECREF(__pyx_t_43); __pyx_t_43 = 0;
        __Pyx_DECREF(__pyx_t_110); __pyx_t_110 = 0;
        if (unlikely(PyObject_SetItem(((PyObject *)__pyx_v_stars_p), __pyx_tuple__128, __pyx_t_2) < 0)) __PYX_ERR(0, 1758, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;

        /* "orb/cutils.pyx":1757
 *                     stars_p[istar,2], stars_p[istar,3], -cov_p[1], -cov_p[2],
 *                     cov_p[6], 0., 0., rcx, rcy, cov_p[4], cov_p[5])
 *             if sip is not None:             # <<<<<<<<<<<<<<
 *                 stars_p[:,2:4] = sip_im2pix(stars_p[:,2:4], sip)
 * 
 */
      }

      /* "orb/cutils.pyx":1750
 *         cov_matrix = fit[1]
 * 
 *         if cov_matrix is None: # no covariance : no error estimation             # <<<<<<<<<<<<<<
 *             stars_err.fill(np.nan)
 *             # compute transformed postitions
 */
      goto __pyx_L64;
    }

    /* "orb/cutils.pyx":1762
 * 
 *         else:
 *             cov_matrix *= returned_data['reduced-chi-square']             # <<<<<<<<<<<<<<
 *             cov_diag = np.sqrt(np.abs(
 *                 np.array([cov_matrix[i,i]
 */
    /*else*/ {
      __pyx_t_2 = __Pyx_PyDict_GetItem(__pyx_v_returned_data, __pyx_kp_s_reduced_chi_square); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1762, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __pyx_t_110 = PyNumber_InPlaceMultiply(((PyObject *)__pyx_v_cov_matrix), __pyx_t_2); if (unlikely(!__pyx_t_110)) __PYX_ERR(0, 1762, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_110);
      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
      if (!(likely(((__pyx_t_110) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_110, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1762, __pyx_L1_error)
      __pyx_t_61 = ((PyArrayObject *)__pyx_t_110);
      {
        __Pyx_BufFmt_StackElem __pyx_stack[1];
        __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_cov_matrix.rcbuffer->pybuffer);
        __pyx_t_8 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_cov_matrix.rcbuffer->pybuffer, (PyObject*)__pyx_t_61, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
        if (unlikely(__pyx_t_8 < 0)) {
          PyErr_Fetch(&__pyx_t_22, &__pyx_t_23, &__pyx_t_24);
          if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_cov_matrix.rcbuffer->pybuffer, (PyObject*)__pyx_v_cov_matrix, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
            Py_XDECREF(__pyx_t_22); Py_XDECREF(__pyx_t_23); Py_XDECREF(__pyx_t_24);
            __Pyx_RaiseBufferFallbackError();
          } else {
            PyErr_Restore(__pyx_t_22, __pyx_t_23, __pyx_t_24);
          }
        }
        __pyx_pybuffernd_cov_matrix.diminfo[0].strides = __pyx_pybuffernd_cov_matrix.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_cov_matrix.diminfo[0].shape = __pyx_pybuffernd_cov_matrix.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_cov_matrix.diminfo[1].strides = __pyx_pybuffernd_cov_matrix.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_cov_matrix.diminfo[1].shape = __pyx_pybuffernd_cov_matrix.rcbuffer->pybuffer.shape[1];
        if (unlikely(__pyx_t_8 < 0)) __PYX_ERR(0, 1762, __pyx_L1_error)
      }
      __pyx_t_61 = 0;
      __Pyx_DECREF_SET(__pyx_v_cov_matrix, ((PyArrayObject *)__pyx_t_110));
      __pyx_t_110 = 0;

      /* "orb/cutils.pyx":1763
 *         else:
 *             cov_matrix *= returned_data['reduced-chi-square']
 *             cov_diag = np.sqrt(np.abs(             # <<<<<<<<<<<<<<
 *                 np.array([cov_matrix[i,i]
 *                           for i in range(cov_matrix.shape[0])])))
 */
      __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1763, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __pyx_t_43 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_sqrt); if (unlikely(!__pyx_t_43)) __PYX_ERR(0, 1763, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_43);
      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
      __pyx_t_40 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1763, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_40);
      __pyx_t_44 = __Pyx_PyObject_GetAttrStr(__pyx_t_40, __pyx_n_s_abs); if (unlikely(!__pyx_t_44)) __PYX_ERR(0, 1763, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_44);
      __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;

      /* "orb/cutils.pyx":1764
 *             cov_matrix *= returned_data['reduced-chi-square']
 *             cov_diag = np.sqrt(np.abs(
 *                 np.array([cov_matrix[i,i]             # <<<<<<<<<<<<<<
 *                           for i in range(cov_matrix.shape[0])])))
 * 
 */
      __pyx_t_70 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_70)) __PYX_ERR(0, 1764, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_70);
      __pyx_t_71 = __Pyx_PyObject_GetAttrStr(__pyx_t_70, __pyx_n_s_array); if (unlikely(!__pyx_t_71)) __PYX_ERR(0, 1764, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_71);
      __Pyx_DECREF(__pyx_t_70); __pyx_t_70 = 0;
      __pyx_t_70 = PyList_New(0); if (unlikely(!__pyx_t_70)) __PYX_ERR(0, 1764, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_70);

      /* "orb/cutils.pyx":1765
 *             cov_diag = np.sqrt(np.abs(
 *                 np.array([cov_matrix[i,i]
 *                           for i in range(cov_matrix.shape[0])])))             # <<<<<<<<<<<<<<
 * 
 *             fixed_p.fill(0.)
 */
      __pyx_t_3 = __Pyx_PyInt_From_Py_intptr_t((__pyx_v_cov_matrix->dimensions[0])); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1765, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __pyx_t_42 = PyTuple_New(1); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1765, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_42);
      __Pyx_GIVEREF(__pyx_t_3);
      PyTuple_SET_ITEM(__pyx_t_42, 0, __pyx_t_3);
      __pyx_t_3 = 0;
      __pyx_t_3 = __Pyx_PyObject_Call(__pyx_builtin_range, __pyx_t_42, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1765, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __Pyx_DECREF(__pyx_t_42); __pyx_t_42 = 0;
      if (likely(PyList_CheckExact(__pyx_t_3)) || PyTuple_CheckExact(__pyx_t_3)) {
        __pyx_t_42 = __pyx_t_3; __Pyx_INCREF(__pyx_t_42); __pyx_t_46 = 0;
        __pyx_t_116 = NULL;
      } else {
        __pyx_t_46 = -1; __pyx_t_42 = PyObject_GetIter(__pyx_t_3); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1765, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_42);
        __pyx_t_116 = Py_TYPE(__pyx_t_42)->tp_iternext; if (unlikely(!__pyx_t_116)) __PYX_ERR(0, 1765, __pyx_L1_error)
      }
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      for (;;) {
        if (likely(!__pyx_t_116)) {
          if (likely(PyList_CheckExact(__pyx_t_42))) {
            if (__pyx_t_46 >= PyList_GET_SIZE(__pyx_t_42)) break;
            #if CYTHON_COMPILING_IN_CPYTHON
            __pyx_t_3 = PyList_GET_ITEM(__pyx_t_42, __pyx_t_46); __Pyx_INCREF(__pyx_t_3); __pyx_t_46++; if (unlikely(0 < 0)) __PYX_ERR(0, 1765, __pyx_L1_error)
            #else
            __pyx_t_3 = PySequence_ITEM(__pyx_t_42, __pyx_t_46); __pyx_t_46++; if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1765, __pyx_L1_error)
            __Pyx_GOTREF(__pyx_t_3);
            #endif
          } else {
            if (__pyx_t_46 >= PyTuple_GET_SIZE(__pyx_t_42)) break;
            #if CYTHON_COMPILING_IN_CPYTHON
            __pyx_t_3 = PyTuple_GET_ITEM(__pyx_t_42, __pyx_t_46); __Pyx_INCREF(__pyx_t_3); __pyx_t_46++; if (unlikely(0 < 0)) __PYX_ERR(0, 1765, __pyx_L1_error)
            #else
            __pyx_t_3 = PySequence_ITEM(__pyx_t_42, __pyx_t_46); __pyx_t_46++; if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1765, __pyx_L1_error)
            __Pyx_GOTREF(__pyx_t_3);
            #endif
          }
        } else {
          __pyx_t_3 = __pyx_t_116(__pyx_t_42);
          if (unlikely(!__pyx_t_3)) {
            PyObject* exc_type = PyErr_Occurred();
            if (exc_type) {
              if (likely(exc_type == PyExc_StopIteration || PyErr_GivenExceptionMatches(exc_type, PyExc_StopIteration))) PyErr_Clear();
              else __PYX_ERR(0, 1765, __pyx_L1_error)
            }
            break;
          }
          __Pyx_GOTREF(__pyx_t_3);
        }
        __Pyx_XDECREF_SET(__pyx_v_i, __pyx_t_3);
        __pyx_t_3 = 0;

        /* "orb/cutils.pyx":1764
 *             cov_matrix *= returned_data['reduced-chi-square']
 *             cov_diag = np.sqrt(np.abs(
 *                 np.array([cov_matrix[i,i]             # <<<<<<<<<<<<<<
 *                           for i in range(cov_matrix.shape[0])])))
 * 
 */
        __pyx_t_3 = PyTuple_New(2); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1764, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_3);
        __Pyx_INCREF(__pyx_v_i);
        __Pyx_GIVEREF(__pyx_v_i);
        PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_v_i);
        __Pyx_INCREF(__pyx_v_i);
        __Pyx_GIVEREF(__pyx_v_i);
        PyTuple_SET_ITEM(__pyx_t_3, 1, __pyx_v_i);
        __pyx_t_5 = PyObject_GetItem(((PyObject *)__pyx_v_cov_matrix), __pyx_t_3); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1764, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_5);
        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
        if (unlikely(__Pyx_ListComp_Append(__pyx_t_70, (PyObject*)__pyx_t_5))) __PYX_ERR(0, 1764, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

        /* "orb/cutils.pyx":1765
 *             cov_diag = np.sqrt(np.abs(
 *                 np.array([cov_matrix[i,i]
 *                           for i in range(cov_matrix.shape[0])])))             # <<<<<<<<<<<<<<
 * 
 *             fixed_p.fill(0.)
 */
      }
      __Pyx_DECREF(__pyx_t_42); __pyx_t_42 = 0;
      __pyx_t_42 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_71))) {
        __pyx_t_42 = PyMethod_GET_SELF(__pyx_t_71);
        if (likely(__pyx_t_42)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_71);
          __Pyx_INCREF(__pyx_t_42);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_71, function);
        }
      }
      if (!__pyx_t_42) {
        __pyx_t_40 = __Pyx_PyObject_CallOneArg(__pyx_t_71, __pyx_t_70); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1764, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_70); __pyx_t_70 = 0;
        __Pyx_GOTREF(__pyx_t_40);
      } else {
        __pyx_t_5 = PyTuple_New(1+1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1764, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_5);
        __Pyx_GIVEREF(__pyx_t_42); PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_42); __pyx_t_42 = NULL;
        __Pyx_GIVEREF(__pyx_t_70);
        PyTuple_SET_ITEM(__pyx_t_5, 0+1, __pyx_t_70);
        __pyx_t_70 = 0;
        __pyx_t_40 = __Pyx_PyObject_Call(__pyx_t_71, __pyx_t_5, NULL); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1764, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_40);
        __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
      }
      __Pyx_DECREF(__pyx_t_71); __pyx_t_71 = 0;
      __pyx_t_71 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_44))) {
        __pyx_t_71 = PyMethod_GET_SELF(__pyx_t_44);
        if (likely(__pyx_t_71)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_44);
          __Pyx_INCREF(__pyx_t_71);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_44, function);
        }
      }
      if (!__pyx_t_71) {
        __pyx_t_2 = __Pyx_PyObject_CallOneArg(__pyx_t_44, __pyx_t_40); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1763, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_40); __pyx_t_40 = 0;
        __Pyx_GOTREF(__pyx_t_2);
      } else {
        __pyx_t_5 = PyTuple_New(1+1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1763, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_5);
        __Pyx_GIVEREF(__pyx_t_71); PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_71); __pyx_t_71 = NULL;
        __Pyx_GIVEREF(__pyx_t_40);
        PyTuple_SET_ITEM(__pyx_t_5, 0+1, __pyx_t_40);
        __pyx_t_40 = 0;
        __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_44, __pyx_t_5, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1763, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_2);
        __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
      }
      __Pyx_DECREF(__pyx_t_44); __pyx_t_44 = 0;
      __pyx_t_44 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_43))) {
        __pyx_t_44 = PyMethod_GET_SELF(__pyx_t_43);
        if (likely(__pyx_t_44)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_43);
          __Pyx_INCREF(__pyx_t_44);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_43, function);
        }
      }
      if (!__pyx_t_44) {
        __pyx_t_110 = __Pyx_PyObject_CallOneArg(__pyx_t_43, __pyx_t_2); if (unlikely(!__pyx_t_110)) __PYX_ERR(0, 1763, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
        __Pyx_GOTREF(__pyx_t_110);
      } else {
        __pyx_t_5 = PyTuple_New(1+1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1763, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_5);
        __Pyx_GIVEREF(__pyx_t_44); PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_44); __pyx_t_44 = NULL;
        __Pyx_GIVEREF(__pyx_t_2);
        PyTuple_SET_ITEM(__pyx_t_5, 0+1, __pyx_t_2);
        __pyx_t_2 = 0;
        __pyx_t_110 = __Pyx_PyObject_Call(__pyx_t_43, __pyx_t_5, NULL); if (unlikely(!__pyx_t_110)) __PYX_ERR(0, 1763, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_110);
        __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
      }
      __Pyx_DECREF(__pyx_t_43); __pyx_t_43 = 0;
      __pyx_v_cov_diag = __pyx_t_110;
      __pyx_t_110 = 0;

      /* "orb/cutils.pyx":1767
 *                           for i in range(cov_matrix.shape[0])])))
 * 
 *             fixed_p.fill(0.)             # <<<<<<<<<<<<<<
 *             stars_err, cov_err = params_vect2arrays(
 *                 cov_diag, fixed_p, stars_p_mask, cov_p_mask, star_nb)
 */
      __pyx_t_110 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_fixed_p), __pyx_n_s_fill); if (unlikely(!__pyx_t_110)) __PYX_ERR(0, 1767, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_110);
      __pyx_t_43 = __Pyx_PyObject_Call(__pyx_t_110, __pyx_tuple__129, NULL); if (unlikely(!__pyx_t_43)) __PYX_ERR(0, 1767, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_43);
      __Pyx_DECREF(__pyx_t_110); __pyx_t_110 = 0;
      __Pyx_DECREF(__pyx_t_43); __pyx_t_43 = 0;

      /* "orb/cutils.pyx":1769
 *             fixed_p.fill(0.)
 *             stars_err, cov_err = params_vect2arrays(
 *                 cov_diag, fixed_p, stars_p_mask, cov_p_mask, star_nb)             # <<<<<<<<<<<<<<
 * 
 *             stars_err[:,0] += cov_err[0] # HEIGHT
 */
      if (!(likely(((__pyx_v_cov_diag) == Py_None) || likely(__Pyx_TypeTest(__pyx_v_cov_diag, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1769, __pyx_L1_error)

      /* "orb/cutils.pyx":1768
 * 
 *             fixed_p.fill(0.)
 *             stars_err, cov_err = params_vect2arrays(             # <<<<<<<<<<<<<<
 *                 cov_diag, fixed_p, stars_p_mask, cov_p_mask, star_nb)
 * 
 */
      __pyx_t_43 = __pyx_pf_3orb_6cutils_15multi_fit_stars_2params_vect2arrays(__pyx_cur_scope->__pyx_v_params_vect2arrays, ((PyArrayObject *)__pyx_v_cov_diag), ((PyArrayObject *)__pyx_v_fixed_p), ((PyArrayObject *)__pyx_v_stars_p_mask), ((PyArrayObject *)__pyx_v_cov_p_mask), __pyx_v_star_nb); if (unlikely(!__pyx_t_43)) __PYX_ERR(0, 1768, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_43);
      if ((likely(PyTuple_CheckExact(__pyx_t_43))) || (PyList_CheckExact(__pyx_t_43))) {
        PyObject* sequence = __pyx_t_43;
        #if CYTHON_COMPILING_IN_CPYTHON
        Py_ssize_t size = Py_SIZE(sequence);
        #else
        Py_ssize_t size = PySequence_Size(sequence);
        #endif
        if (unlikely(size != 2)) {
          if (size > 2) __Pyx_RaiseTooManyValuesError(2);
          else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
          __PYX_ERR(0, 1768, __pyx_L1_error)
        }
        #if CYTHON_COMPILING_IN_CPYTHON
        if (likely(PyTuple_CheckExact(sequence))) {
          __pyx_t_110 = PyTuple_GET_ITEM(sequence, 0); 
          __pyx_t_5 = PyTuple_GET_ITEM(sequence, 1); 
        } else {
          __pyx_t_110 = PyList_GET_ITEM(sequence, 0); 
          __pyx_t_5 = PyList_GET_ITEM(sequence, 1); 
        }
        __Pyx_INCREF(__pyx_t_110);
        __Pyx_INCREF(__pyx_t_5);
        #else
        __pyx_t_110 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_110)) __PYX_ERR(0, 1768, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_110);
        __pyx_t_5 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1768, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_5);
        #endif
        __Pyx_DECREF(__pyx_t_43); __pyx_t_43 = 0;
      } else {
        Py_ssize_t index = -1;
        __pyx_t_2 = PyObject_GetIter(__pyx_t_43); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1768, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_2);
        __Pyx_DECREF(__pyx_t_43); __pyx_t_43 = 0;
        __pyx_t_57 = Py_TYPE(__pyx_t_2)->tp_iternext;
        index = 0; __pyx_t_110 = __pyx_t_57(__pyx_t_2); if (unlikely(!__pyx_t_110)) goto __pyx_L72_unpacking_failed;
        __Pyx_GOTREF(__pyx_t_110);
        index = 1; __pyx_t_5 = __pyx_t_57(__pyx_t_2); if (unlikely(!__pyx_t_5)) goto __pyx_L72_unpacking_failed;
        __Pyx_GOTREF(__pyx_t_5);
        if (__Pyx_IternextUnpackEndCheck(__pyx_t_57(__pyx_t_2), 2) < 0) __PYX_ERR(0, 1768, __pyx_L1_error)
        __pyx_t_57 = NULL;
        __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
        goto __pyx_L73_unpacking_done;
        __pyx_L72_unpacking_failed:;
        __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
        __pyx_t_57 = NULL;
        if (__Pyx_IterFinish() == 0) __Pyx_RaiseNeedMoreValuesError(index);
        __PYX_ERR(0, 1768, __pyx_L1_error)
        __pyx_L73_unpacking_done:;
      }
      if (!(likely(((__pyx_t_110) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_110, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1768, __pyx_L1_error)
      if (!(likely(((__pyx_t_5) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_5, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1768, __pyx_L1_error)
      __pyx_t_27 = ((PyArrayObject *)__pyx_t_110);
      {
        __Pyx_BufFmt_StackElem __pyx_stack[1];
        __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_stars_err.rcbuffer->pybuffer);
        __pyx_t_8 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_stars_err.rcbuffer->pybuffer, (PyObject*)__pyx_t_27, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 2, 0, __pyx_stack);
        if (unlikely(__pyx_t_8 < 0)) {
          PyErr_Fetch(&__pyx_t_24, &__pyx_t_23, &__pyx_t_22);
          if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_stars_err.rcbuffer->pybuffer, (PyObject*)__pyx_v_stars_err, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 2, 0, __pyx_stack) == -1)) {
            Py_XDECREF(__pyx_t_24); Py_XDECREF(__pyx_t_23); Py_XDECREF(__pyx_t_22);
            __Pyx_RaiseBufferFallbackError();
          } else {
            PyErr_Restore(__pyx_t_24, __pyx_t_23, __pyx_t_22);
          }
        }
        __pyx_pybuffernd_stars_err.diminfo[0].strides = __pyx_pybuffernd_stars_err.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_stars_err.diminfo[0].shape = __pyx_pybuffernd_stars_err.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_stars_err.diminfo[1].strides = __pyx_pybuffernd_stars_err.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_stars_err.diminfo[1].shape = __pyx_pybuffernd_stars_err.rcbuffer->pybuffer.shape[1];
        if (unlikely(__pyx_t_8 < 0)) __PYX_ERR(0, 1768, __pyx_L1_error)
      }
      __pyx_t_27 = 0;
      __Pyx_DECREF_SET(__pyx_v_stars_err, ((PyArrayObject *)__pyx_t_110));
      __pyx_t_110 = 0;
      __pyx_t_33 = ((PyArrayObject *)__pyx_t_5);
      {
        __Pyx_BufFmt_StackElem __pyx_stack[1];
        __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_cov_err.rcbuffer->pybuffer);
        __pyx_t_8 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_cov_err.rcbuffer->pybuffer, (PyObject*)__pyx_t_33, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack);
        if (unlikely(__pyx_t_8 < 0)) {
          PyErr_Fetch(&__pyx_t_22, &__pyx_t_23, &__pyx_t_24);
          if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_cov_err.rcbuffer->pybuffer, (PyObject*)__pyx_v_cov_err, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
            Py_XDECREF(__pyx_t_22); Py_XDECREF(__pyx_t_23); Py_XDECREF(__pyx_t_24);
            __Pyx_RaiseBufferFallbackError();
          } else {
            PyErr_Restore(__pyx_t_22, __pyx_t_23, __pyx_t_24);
          }
        }
        __pyx_pybuffernd_cov_err.diminfo[0].strides = __pyx_pybuffernd_cov_err.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_cov_err.diminfo[0].shape = __pyx_pybuffernd_cov_err.rcbuffer->pybuffer.shape[0];
        if (unlikely(__pyx_t_8 < 0)) __PYX_ERR(0, 1768, __pyx_L1_error)
      }
      __pyx_t_33 = 0;
      __Pyx_DECREF_SET(__pyx_v_cov_err, ((PyArrayObject *)__pyx_t_5));
      __pyx_t_5 = 0;

      /* "orb/cutils.pyx":1771
 *                 cov_diag, fixed_p, stars_p_mask, cov_p_mask, star_nb)
 * 
 *             stars_err[:,0] += cov_err[0] # HEIGHT             # <<<<<<<<<<<<<<
 *             stars_err[:,4] += cov_err[3] # FWHM
 * 
 */
      __Pyx_INCREF(__pyx_tuple__131);
      __pyx_t_49 = __pyx_tuple__131;
      __pyx_t_43 = PyObject_GetItem(((PyObject *)__pyx_v_stars_err), __pyx_t_49); if (unlikely(!__pyx_t_43)) __PYX_ERR(0, 1771, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_43);
      __pyx_t_117 = 0;
      __pyx_t_8 = -1;
      if (__pyx_t_117 < 0) {
        __pyx_t_117 += __pyx_pybuffernd_cov_err.diminfo[0].shape;
        if (unlikely(__pyx_t_117 < 0)) __pyx_t_8 = 0;
      } else if (unlikely(__pyx_t_117 >= __pyx_pybuffernd_cov_err.diminfo[0].shape)) __pyx_t_8 = 0;
      if (unlikely(__pyx_t_8 != -1)) {
        __Pyx_RaiseBufferIndexError(__pyx_t_8);
        __PYX_ERR(0, 1771, __pyx_L1_error)
      }
      __pyx_t_5 = PyFloat_FromDouble((*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_cov_err.rcbuffer->pybuffer.buf, __pyx_t_117, __pyx_pybuffernd_cov_err.diminfo[0].strides))); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1771, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __pyx_t_110 = PyNumber_InPlaceAdd(__pyx_t_43, __pyx_t_5); if (unlikely(!__pyx_t_110)) __PYX_ERR(0, 1771, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_110);
      __Pyx_DECREF(__pyx_t_43); __pyx_t_43 = 0;
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
      if (unlikely(PyObject_SetItem(((PyObject *)__pyx_v_stars_err), __pyx_t_49, __pyx_t_110) < 0)) __PYX_ERR(0, 1771, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_110); __pyx_t_110 = 0;
      __Pyx_DECREF(__pyx_t_49); __pyx_t_49 = 0;

      /* "orb/cutils.pyx":1772
 * 
 *             stars_err[:,0] += cov_err[0] # HEIGHT
 *             stars_err[:,4] += cov_err[3] # FWHM             # <<<<<<<<<<<<<<
 * 
 *             # compute transformed positions + error
 */
      __Pyx_INCREF(__pyx_tuple__133);
      __pyx_t_49 = __pyx_tuple__133;
      __pyx_t_110 = PyObject_GetItem(((PyObject *)__pyx_v_stars_err), __pyx_t_49); if (unlikely(!__pyx_t_110)) __PYX_ERR(0, 1772, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_110);
      __pyx_t_118 = 3;
      __pyx_t_8 = -1;
      if (__pyx_t_118 < 0) {
        __pyx_t_118 += __pyx_pybuffernd_cov_err.diminfo[0].shape;
        if (unlikely(__pyx_t_118 < 0)) __pyx_t_8 = 0;
      } else if (unlikely(__pyx_t_118 >= __pyx_pybuffernd_cov_err.diminfo[0].shape)) __pyx_t_8 = 0;
      if (unlikely(__pyx_t_8 != -1)) {
        __Pyx_RaiseBufferIndexError(__pyx_t_8);
        __PYX_ERR(0, 1772, __pyx_L1_error)
      }
      __pyx_t_5 = PyFloat_FromDouble((*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_cov_err.rcbuffer->pybuffer.buf, __pyx_t_118, __pyx_pybuffernd_cov_err.diminfo[0].strides))); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1772, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __pyx_t_43 = PyNumber_InPlaceAdd(__pyx_t_110, __pyx_t_5); if (unlikely(!__pyx_t_43)) __PYX_ERR(0, 1772, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_43);
      __Pyx_DECREF(__pyx_t_110); __pyx_t_110 = 0;
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
      if (unlikely(PyObject_SetItem(((PyObject *)__pyx_v_stars_err), __pyx_t_49, __pyx_t_43) < 0)) __PYX_ERR(0, 1772, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_43); __pyx_t_43 = 0;
      __Pyx_DECREF(__pyx_t_49); __pyx_t_49 = 0;

      /* "orb/cutils.pyx":1775
 * 
 *             # compute transformed positions + error
 *             for istar in range(stars_p.shape[0]):             # <<<<<<<<<<<<<<
 *                 (stars_p[istar,2], stars_p[istar,3],
 *                  stars_err[istar,2], stars_err[istar,3]) = transform_A_to_B(
 */
      __pyx_t_7 = (__pyx_v_stars_p->dimensions[0]);
      for (__pyx_t_8 = 0; __pyx_t_8 < __pyx_t_7; __pyx_t_8+=1) {
        __pyx_v_istar = __pyx_t_8;

        /* "orb/cutils.pyx":1777
 *             for istar in range(stars_p.shape[0]):
 *                 (stars_p[istar,2], stars_p[istar,3],
 *                  stars_err[istar,2], stars_err[istar,3]) = transform_A_to_B(             # <<<<<<<<<<<<<<
 *                     stars_p[istar,2], stars_p[istar,3], -cov_p[1], -cov_p[2],
 *                     cov_p[6], 0., 0., rcx, rcy, cov_p[4], cov_p[5],
 */
        __pyx_t_43 = __Pyx_GetModuleGlobalName(__pyx_n_s_transform_A_to_B); if (unlikely(!__pyx_t_43)) __PYX_ERR(0, 1777, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_43);

        /* "orb/cutils.pyx":1778
 *                 (stars_p[istar,2], stars_p[istar,3],
 *                  stars_err[istar,2], stars_err[istar,3]) = transform_A_to_B(
 *                     stars_p[istar,2], stars_p[istar,3], -cov_p[1], -cov_p[2],             # <<<<<<<<<<<<<<
 *                     cov_p[6], 0., 0., rcx, rcy, cov_p[4], cov_p[5],
 *                     x1_err=stars_err[istar,2],
 */
        __pyx_t_119 = __pyx_v_istar;
        __pyx_t_120 = 2;
        __pyx_t_12 = -1;
        if (__pyx_t_119 < 0) {
          __pyx_t_119 += __pyx_pybuffernd_stars_p.diminfo[0].shape;
          if (unlikely(__pyx_t_119 < 0)) __pyx_t_12 = 0;
        } else if (unlikely(__pyx_t_119 >= __pyx_pybuffernd_stars_p.diminfo[0].shape)) __pyx_t_12 = 0;
        if (__pyx_t_120 < 0) {
          __pyx_t_120 += __pyx_pybuffernd_stars_p.diminfo[1].shape;
          if (unlikely(__pyx_t_120 < 0)) __pyx_t_12 = 1;
        } else if (unlikely(__pyx_t_120 >= __pyx_pybuffernd_stars_p.diminfo[1].shape)) __pyx_t_12 = 1;
        if (unlikely(__pyx_t_12 != -1)) {
          __Pyx_RaiseBufferIndexError(__pyx_t_12);
          __PYX_ERR(0, 1778, __pyx_L1_error)
        }
        __pyx_t_5 = PyFloat_FromDouble((*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_stars_p.rcbuffer->pybuffer.buf, __pyx_t_119, __pyx_pybuffernd_stars_p.diminfo[0].strides, __pyx_t_120, __pyx_pybuffernd_stars_p.diminfo[1].strides))); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1778, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_5);
        __pyx_t_121 = __pyx_v_istar;
        __pyx_t_122 = 3;
        __pyx_t_12 = -1;
        if (__pyx_t_121 < 0) {
          __pyx_t_121 += __pyx_pybuffernd_stars_p.diminfo[0].shape;
          if (unlikely(__pyx_t_121 < 0)) __pyx_t_12 = 0;
        } else if (unlikely(__pyx_t_121 >= __pyx_pybuffernd_stars_p.diminfo[0].shape)) __pyx_t_12 = 0;
        if (__pyx_t_122 < 0) {
          __pyx_t_122 += __pyx_pybuffernd_stars_p.diminfo[1].shape;
          if (unlikely(__pyx_t_122 < 0)) __pyx_t_12 = 1;
        } else if (unlikely(__pyx_t_122 >= __pyx_pybuffernd_stars_p.diminfo[1].shape)) __pyx_t_12 = 1;
        if (unlikely(__pyx_t_12 != -1)) {
          __Pyx_RaiseBufferIndexError(__pyx_t_12);
          __PYX_ERR(0, 1778, __pyx_L1_error)
        }
        __pyx_t_110 = PyFloat_FromDouble((*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_stars_p.rcbuffer->pybuffer.buf, __pyx_t_121, __pyx_pybuffernd_stars_p.diminfo[0].strides, __pyx_t_122, __pyx_pybuffernd_stars_p.diminfo[1].strides))); if (unlikely(!__pyx_t_110)) __PYX_ERR(0, 1778, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_110);
        __pyx_t_123 = 1;
        __pyx_t_12 = -1;
        if (__pyx_t_123 < 0) {
          __pyx_t_123 += __pyx_pybuffernd_cov_p.diminfo[0].shape;
          if (unlikely(__pyx_t_123 < 0)) __pyx_t_12 = 0;
        } else if (unlikely(__pyx_t_123 >= __pyx_pybuffernd_cov_p.diminfo[0].shape)) __pyx_t_12 = 0;
        if (unlikely(__pyx_t_12 != -1)) {
          __Pyx_RaiseBufferIndexError(__pyx_t_12);
          __PYX_ERR(0, 1778, __pyx_L1_error)
        }
        __pyx_t_2 = PyFloat_FromDouble((-(*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.buf, __pyx_t_123, __pyx_pybuffernd_cov_p.diminfo[0].strides)))); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1778, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_2);
        __pyx_t_124 = 2;
        __pyx_t_12 = -1;
        if (__pyx_t_124 < 0) {
          __pyx_t_124 += __pyx_pybuffernd_cov_p.diminfo[0].shape;
          if (unlikely(__pyx_t_124 < 0)) __pyx_t_12 = 0;
        } else if (unlikely(__pyx_t_124 >= __pyx_pybuffernd_cov_p.diminfo[0].shape)) __pyx_t_12 = 0;
        if (unlikely(__pyx_t_12 != -1)) {
          __Pyx_RaiseBufferIndexError(__pyx_t_12);
          __PYX_ERR(0, 1778, __pyx_L1_error)
        }
        __pyx_t_44 = PyFloat_FromDouble((-(*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.buf, __pyx_t_124, __pyx_pybuffernd_cov_p.diminfo[0].strides)))); if (unlikely(!__pyx_t_44)) __PYX_ERR(0, 1778, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_44);

        /* "orb/cutils.pyx":1779
 *                  stars_err[istar,2], stars_err[istar,3]) = transform_A_to_B(
 *                     stars_p[istar,2], stars_p[istar,3], -cov_p[1], -cov_p[2],
 *                     cov_p[6], 0., 0., rcx, rcy, cov_p[4], cov_p[5],             # <<<<<<<<<<<<<<
 *                     x1_err=stars_err[istar,2],
 *                     y1_err=stars_err[istar,3],
 */
        __pyx_t_125 = 6;
        __pyx_t_12 = -1;
        if (__pyx_t_125 < 0) {
          __pyx_t_125 += __pyx_pybuffernd_cov_p.diminfo[0].shape;
          if (unlikely(__pyx_t_125 < 0)) __pyx_t_12 = 0;
        } else if (unlikely(__pyx_t_125 >= __pyx_pybuffernd_cov_p.diminfo[0].shape)) __pyx_t_12 = 0;
        if (unlikely(__pyx_t_12 != -1)) {
          __Pyx_RaiseBufferIndexError(__pyx_t_12);
          __PYX_ERR(0, 1779, __pyx_L1_error)
        }
        __pyx_t_40 = PyFloat_FromDouble((*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.buf, __pyx_t_125, __pyx_pybuffernd_cov_p.diminfo[0].strides))); if (unlikely(!__pyx_t_40)) __PYX_ERR(0, 1779, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_40);
        __pyx_t_71 = PyFloat_FromDouble(__pyx_v_rcx); if (unlikely(!__pyx_t_71)) __PYX_ERR(0, 1779, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_71);
        __pyx_t_70 = PyFloat_FromDouble(__pyx_v_rcy); if (unlikely(!__pyx_t_70)) __PYX_ERR(0, 1779, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_70);
        __pyx_t_126 = 4;
        __pyx_t_12 = -1;
        if (__pyx_t_126 < 0) {
          __pyx_t_126 += __pyx_pybuffernd_cov_p.diminfo[0].shape;
          if (unlikely(__pyx_t_126 < 0)) __pyx_t_12 = 0;
        } else if (unlikely(__pyx_t_126 >= __pyx_pybuffernd_cov_p.diminfo[0].shape)) __pyx_t_12 = 0;
        if (unlikely(__pyx_t_12 != -1)) {
          __Pyx_RaiseBufferIndexError(__pyx_t_12);
          __PYX_ERR(0, 1779, __pyx_L1_error)
        }
        __pyx_t_42 = PyFloat_FromDouble((*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.buf, __pyx_t_126, __pyx_pybuffernd_cov_p.diminfo[0].strides))); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1779, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_42);
        __pyx_t_127 = 5;
        __pyx_t_12 = -1;
        if (__pyx_t_127 < 0) {
          __pyx_t_127 += __pyx_pybuffernd_cov_p.diminfo[0].shape;
          if (unlikely(__pyx_t_127 < 0)) __pyx_t_12 = 0;
        } else if (unlikely(__pyx_t_127 >= __pyx_pybuffernd_cov_p.diminfo[0].shape)) __pyx_t_12 = 0;
        if (unlikely(__pyx_t_12 != -1)) {
          __Pyx_RaiseBufferIndexError(__pyx_t_12);
          __PYX_ERR(0, 1779, __pyx_L1_error)
        }
        __pyx_t_3 = PyFloat_FromDouble((*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_cov_p.rcbuffer->pybuffer.buf, __pyx_t_127, __pyx_pybuffernd_cov_p.diminfo[0].strides))); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1779, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_3);

        /* "orb/cutils.pyx":1777
 *             for istar in range(stars_p.shape[0]):
 *                 (stars_p[istar,2], stars_p[istar,3],
 *                  stars_err[istar,2], stars_err[istar,3]) = transform_A_to_B(             # <<<<<<<<<<<<<<
 *                     stars_p[istar,2], stars_p[istar,3], -cov_p[1], -cov_p[2],
 *                     cov_p[6], 0., 0., rcx, rcy, cov_p[4], cov_p[5],
 */
        __pyx_t_4 = PyTuple_New(11); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1777, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_4);
        __Pyx_GIVEREF(__pyx_t_5);
        PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_5);
        __Pyx_GIVEREF(__pyx_t_110);
        PyTuple_SET_ITEM(__pyx_t_4, 1, __pyx_t_110);
        __Pyx_GIVEREF(__pyx_t_2);
        PyTuple_SET_ITEM(__pyx_t_4, 2, __pyx_t_2);
        __Pyx_GIVEREF(__pyx_t_44);
        PyTuple_SET_ITEM(__pyx_t_4, 3, __pyx_t_44);
        __Pyx_GIVEREF(__pyx_t_40);
        PyTuple_SET_ITEM(__pyx_t_4, 4, __pyx_t_40);
        __Pyx_INCREF(__pyx_float_0_);
        __Pyx_GIVEREF(__pyx_float_0_);
        PyTuple_SET_ITEM(__pyx_t_4, 5, __pyx_float_0_);
        __Pyx_INCREF(__pyx_float_0_);
        __Pyx_GIVEREF(__pyx_float_0_);
        PyTuple_SET_ITEM(__pyx_t_4, 6, __pyx_float_0_);
        __Pyx_GIVEREF(__pyx_t_71);
        PyTuple_SET_ITEM(__pyx_t_4, 7, __pyx_t_71);
        __Pyx_GIVEREF(__pyx_t_70);
        PyTuple_SET_ITEM(__pyx_t_4, 8, __pyx_t_70);
        __Pyx_GIVEREF(__pyx_t_42);
        PyTuple_SET_ITEM(__pyx_t_4, 9, __pyx_t_42);
        __Pyx_GIVEREF(__pyx_t_3);
        PyTuple_SET_ITEM(__pyx_t_4, 10, __pyx_t_3);
        __pyx_t_5 = 0;
        __pyx_t_110 = 0;
        __pyx_t_2 = 0;
        __pyx_t_44 = 0;
        __pyx_t_40 = 0;
        __pyx_t_71 = 0;
        __pyx_t_70 = 0;
        __pyx_t_42 = 0;
        __pyx_t_3 = 0;

        /* "orb/cutils.pyx":1780
 *                     stars_p[istar,2], stars_p[istar,3], -cov_p[1], -cov_p[2],
 *                     cov_p[6], 0., 0., rcx, rcy, cov_p[4], cov_p[5],
 *                     x1_err=stars_err[istar,2],             # <<<<<<<<<<<<<<
 *                     y1_err=stars_err[istar,3],
 *                     dx_err=cov_err[1],
 */
        __pyx_t_3 = PyDict_New(); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1780, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_3);
        __pyx_t_128 = __pyx_v_istar;
        __pyx_t_129 = 2;
        __pyx_t_12 = -1;
        if (__pyx_t_128 < 0) {
          __pyx_t_128 += __pyx_pybuffernd_stars_err.diminfo[0].shape;
          if (unlikely(__pyx_t_128 < 0)) __pyx_t_12 = 0;
        } else if (unlikely(__pyx_t_128 >= __pyx_pybuffernd_stars_err.diminfo[0].shape)) __pyx_t_12 = 0;
        if (__pyx_t_129 < 0) {
          __pyx_t_129 += __pyx_pybuffernd_stars_err.diminfo[1].shape;
          if (unlikely(__pyx_t_129 < 0)) __pyx_t_12 = 1;
        } else if (unlikely(__pyx_t_129 >= __pyx_pybuffernd_stars_err.diminfo[1].shape)) __pyx_t_12 = 1;
        if (unlikely(__pyx_t_12 != -1)) {
          __Pyx_RaiseBufferIndexError(__pyx_t_12);
          __PYX_ERR(0, 1780, __pyx_L1_error)
        }
        __pyx_t_42 = PyFloat_FromDouble((*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_stars_err.rcbuffer->pybuffer.buf, __pyx_t_128, __pyx_pybuffernd_stars_err.diminfo[0].strides, __pyx_t_129, __pyx_pybuffernd_stars_err.diminfo[1].strides))); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1780, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_42);
        if (PyDict_SetItem(__pyx_t_3, __pyx_n_s_x1_err, __pyx_t_42) < 0) __PYX_ERR(0, 1780, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_42); __pyx_t_42 = 0;

        /* "orb/cutils.pyx":1781
 *                     cov_p[6], 0., 0., rcx, rcy, cov_p[4], cov_p[5],
 *                     x1_err=stars_err[istar,2],
 *                     y1_err=stars_err[istar,3],             # <<<<<<<<<<<<<<
 *                     dx_err=cov_err[1],
 *                     dy_err=cov_err[2],
 */
        __pyx_t_130 = __pyx_v_istar;
        __pyx_t_131 = 3;
        __pyx_t_12 = -1;
        if (__pyx_t_130 < 0) {
          __pyx_t_130 += __pyx_pybuffernd_stars_err.diminfo[0].shape;
          if (unlikely(__pyx_t_130 < 0)) __pyx_t_12 = 0;
        } else if (unlikely(__pyx_t_130 >= __pyx_pybuffernd_stars_err.diminfo[0].shape)) __pyx_t_12 = 0;
        if (__pyx_t_131 < 0) {
          __pyx_t_131 += __pyx_pybuffernd_stars_err.diminfo[1].shape;
          if (unlikely(__pyx_t_131 < 0)) __pyx_t_12 = 1;
        } else if (unlikely(__pyx_t_131 >= __pyx_pybuffernd_stars_err.diminfo[1].shape)) __pyx_t_12 = 1;
        if (unlikely(__pyx_t_12 != -1)) {
          __Pyx_RaiseBufferIndexError(__pyx_t_12);
          __PYX_ERR(0, 1781, __pyx_L1_error)
        }
        __pyx_t_42 = PyFloat_FromDouble((*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_stars_err.rcbuffer->pybuffer.buf, __pyx_t_130, __pyx_pybuffernd_stars_err.diminfo[0].strides, __pyx_t_131, __pyx_pybuffernd_stars_err.diminfo[1].strides))); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1781, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_42);
        if (PyDict_SetItem(__pyx_t_3, __pyx_n_s_y1_err, __pyx_t_42) < 0) __PYX_ERR(0, 1780, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_42); __pyx_t_42 = 0;

        /* "orb/cutils.pyx":1782
 *                     x1_err=stars_err[istar,2],
 *                     y1_err=stars_err[istar,3],
 *                     dx_err=cov_err[1],             # <<<<<<<<<<<<<<
 *                     dy_err=cov_err[2],
 *                     zx_err=cov_err[4],
 */
        __pyx_t_132 = 1;
        __pyx_t_12 = -1;
        if (__pyx_t_132 < 0) {
          __pyx_t_132 += __pyx_pybuffernd_cov_err.diminfo[0].shape;
          if (unlikely(__pyx_t_132 < 0)) __pyx_t_12 = 0;
        } else if (unlikely(__pyx_t_132 >= __pyx_pybuffernd_cov_err.diminfo[0].shape)) __pyx_t_12 = 0;
        if (unlikely(__pyx_t_12 != -1)) {
          __Pyx_RaiseBufferIndexError(__pyx_t_12);
          __PYX_ERR(0, 1782, __pyx_L1_error)
        }
        __pyx_t_42 = PyFloat_FromDouble((*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_cov_err.rcbuffer->pybuffer.buf, __pyx_t_132, __pyx_pybuffernd_cov_err.diminfo[0].strides))); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1782, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_42);
        if (PyDict_SetItem(__pyx_t_3, __pyx_n_s_dx_err, __pyx_t_42) < 0) __PYX_ERR(0, 1780, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_42); __pyx_t_42 = 0;

        /* "orb/cutils.pyx":1783
 *                     y1_err=stars_err[istar,3],
 *                     dx_err=cov_err[1],
 *                     dy_err=cov_err[2],             # <<<<<<<<<<<<<<
 *                     zx_err=cov_err[4],
 *                     zy_err=cov_err[5],
 */
        __pyx_t_133 = 2;
        __pyx_t_12 = -1;
        if (__pyx_t_133 < 0) {
          __pyx_t_133 += __pyx_pybuffernd_cov_err.diminfo[0].shape;
          if (unlikely(__pyx_t_133 < 0)) __pyx_t_12 = 0;
        } else if (unlikely(__pyx_t_133 >= __pyx_pybuffernd_cov_err.diminfo[0].shape)) __pyx_t_12 = 0;
        if (unlikely(__pyx_t_12 != -1)) {
          __Pyx_RaiseBufferIndexError(__pyx_t_12);
          __PYX_ERR(0, 1783, __pyx_L1_error)
        }
        __pyx_t_42 = PyFloat_FromDouble((*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_cov_err.rcbuffer->pybuffer.buf, __pyx_t_133, __pyx_pybuffernd_cov_err.diminfo[0].strides))); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1783, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_42);
        if (PyDict_SetItem(__pyx_t_3, __pyx_n_s_dy_err, __pyx_t_42) < 0) __PYX_ERR(0, 1780, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_42); __pyx_t_42 = 0;

        /* "orb/cutils.pyx":1784
 *                     dx_err=cov_err[1],
 *                     dy_err=cov_err[2],
 *                     zx_err=cov_err[4],             # <<<<<<<<<<<<<<
 *                     zy_err=cov_err[5],
 *                     dr_err=cov_err[6],
 */
        __pyx_t_134 = 4;
        __pyx_t_12 = -1;
        if (__pyx_t_134 < 0) {
          __pyx_t_134 += __pyx_pybuffernd_cov_err.diminfo[0].shape;
          if (unlikely(__pyx_t_134 < 0)) __pyx_t_12 = 0;
        } else if (unlikely(__pyx_t_134 >= __pyx_pybuffernd_cov_err.diminfo[0].shape)) __pyx_t_12 = 0;
        if (unlikely(__pyx_t_12 != -1)) {
          __Pyx_RaiseBufferIndexError(__pyx_t_12);
          __PYX_ERR(0, 1784, __pyx_L1_error)
        }
        __pyx_t_42 = PyFloat_FromDouble((*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_cov_err.rcbuffer->pybuffer.buf, __pyx_t_134, __pyx_pybuffernd_cov_err.diminfo[0].strides))); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1784, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_42);
        if (PyDict_SetItem(__pyx_t_3, __pyx_n_s_zx_err, __pyx_t_42) < 0) __PYX_ERR(0, 1780, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_42); __pyx_t_42 = 0;

        /* "orb/cutils.pyx":1785
 *                     dy_err=cov_err[2],
 *                     zx_err=cov_err[4],
 *                     zy_err=cov_err[5],             # <<<<<<<<<<<<<<
 *                     dr_err=cov_err[6],
 *                     return_err=True)
 */
        __pyx_t_135 = 5;
        __pyx_t_12 = -1;
        if (__pyx_t_135 < 0) {
          __pyx_t_135 += __pyx_pybuffernd_cov_err.diminfo[0].shape;
          if (unlikely(__pyx_t_135 < 0)) __pyx_t_12 = 0;
        } else if (unlikely(__pyx_t_135 >= __pyx_pybuffernd_cov_err.diminfo[0].shape)) __pyx_t_12 = 0;
        if (unlikely(__pyx_t_12 != -1)) {
          __Pyx_RaiseBufferIndexError(__pyx_t_12);
          __PYX_ERR(0, 1785, __pyx_L1_error)
        }
        __pyx_t_42 = PyFloat_FromDouble((*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_cov_err.rcbuffer->pybuffer.buf, __pyx_t_135, __pyx_pybuffernd_cov_err.diminfo[0].strides))); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1785, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_42);
        if (PyDict_SetItem(__pyx_t_3, __pyx_n_s_zy_err, __pyx_t_42) < 0) __PYX_ERR(0, 1780, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_42); __pyx_t_42 = 0;

        /* "orb/cutils.pyx":1786
 *                     zx_err=cov_err[4],
 *                     zy_err=cov_err[5],
 *                     dr_err=cov_err[6],             # <<<<<<<<<<<<<<
 *                     return_err=True)
 *             if sip is not None:
 */
        __pyx_t_136 = 6;
        __pyx_t_12 = -1;
        if (__pyx_t_136 < 0) {
          __pyx_t_136 += __pyx_pybuffernd_cov_err.diminfo[0].shape;
          if (unlikely(__pyx_t_136 < 0)) __pyx_t_12 = 0;
        } else if (unlikely(__pyx_t_136 >= __pyx_pybuffernd_cov_err.diminfo[0].shape)) __pyx_t_12 = 0;
        if (unlikely(__pyx_t_12 != -1)) {
          __Pyx_RaiseBufferIndexError(__pyx_t_12);
          __PYX_ERR(0, 1786, __pyx_L1_error)
        }
        __pyx_t_42 = PyFloat_FromDouble((*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_cov_err.rcbuffer->pybuffer.buf, __pyx_t_136, __pyx_pybuffernd_cov_err.diminfo[0].strides))); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1786, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_42);
        if (PyDict_SetItem(__pyx_t_3, __pyx_n_s_dr_err, __pyx_t_42) < 0) __PYX_ERR(0, 1780, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_42); __pyx_t_42 = 0;

        /* "orb/cutils.pyx":1787
 *                     zy_err=cov_err[5],
 *                     dr_err=cov_err[6],
 *                     return_err=True)             # <<<<<<<<<<<<<<
 *             if sip is not None:
 *                 stars_p[:,2:4] = sip_im2pix(stars_p[:,2:4], sip)
 */
        if (PyDict_SetItem(__pyx_t_3, __pyx_n_s_return_err, Py_True) < 0) __PYX_ERR(0, 1780, __pyx_L1_error)

        /* "orb/cutils.pyx":1777
 *             for istar in range(stars_p.shape[0]):
 *                 (stars_p[istar,2], stars_p[istar,3],
 *                  stars_err[istar,2], stars_err[istar,3]) = transform_A_to_B(             # <<<<<<<<<<<<<<
 *                     stars_p[istar,2], stars_p[istar,3], -cov_p[1], -cov_p[2],
 *                     cov_p[6], 0., 0., rcx, rcy, cov_p[4], cov_p[5],
 */
        __pyx_t_42 = __Pyx_PyObject_Call(__pyx_t_43, __pyx_t_4, __pyx_t_3); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1777, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_42);
        __Pyx_DECREF(__pyx_t_43); __pyx_t_43 = 0;
        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
        if ((likely(PyTuple_CheckExact(__pyx_t_42))) || (PyList_CheckExact(__pyx_t_42))) {
          PyObject* sequence = __pyx_t_42;
          #if CYTHON_COMPILING_IN_CPYTHON
          Py_ssize_t size = Py_SIZE(sequence);
          #else
          Py_ssize_t size = PySequence_Size(sequence);
          #endif
          if (unlikely(size != 4)) {
            if (size > 4) __Pyx_RaiseTooManyValuesError(4);
            else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
            __PYX_ERR(0, 1776, __pyx_L1_error)
          }
          #if CYTHON_COMPILING_IN_CPYTHON
          if (likely(PyTuple_CheckExact(sequence))) {
            __pyx_t_3 = PyTuple_GET_ITEM(sequence, 0); 
            __pyx_t_4 = PyTuple_GET_ITEM(sequence, 1); 
            __pyx_t_43 = PyTuple_GET_ITEM(sequence, 2); 
            __pyx_t_70 = PyTuple_GET_ITEM(sequence, 3); 
          } else {
            __pyx_t_3 = PyList_GET_ITEM(sequence, 0); 
            __pyx_t_4 = PyList_GET_ITEM(sequence, 1); 
            __pyx_t_43 = PyList_GET_ITEM(sequence, 2); 
            __pyx_t_70 = PyList_GET_ITEM(sequence, 3); 
          }
          __Pyx_INCREF(__pyx_t_3);
          __Pyx_INCREF(__pyx_t_4);
          __Pyx_INCREF(__pyx_t_43);
          __Pyx_INCREF(__pyx_t_70);
          #else
          {
            Py_ssize_t i;
            PyObject** temps[4] = {&__pyx_t_3,&__pyx_t_4,&__pyx_t_43,&__pyx_t_70};
            for (i=0; i < 4; i++) {
              PyObject* item = PySequence_ITEM(sequence, i); if (unlikely(!item)) __PYX_ERR(0, 1776, __pyx_L1_error)
              __Pyx_GOTREF(item);
              *(temps[i]) = item;
            }
          }
          #endif
          __Pyx_DECREF(__pyx_t_42); __pyx_t_42 = 0;
        } else {
          Py_ssize_t index = -1;
          PyObject** temps[4] = {&__pyx_t_3,&__pyx_t_4,&__pyx_t_43,&__pyx_t_70};
          __pyx_t_71 = PyObject_GetIter(__pyx_t_42); if (unlikely(!__pyx_t_71)) __PYX_ERR(0, 1776, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_71);
          __Pyx_DECREF(__pyx_t_42); __pyx_t_42 = 0;
          __pyx_t_57 = Py_TYPE(__pyx_t_71)->tp_iternext;
          for (index=0; index < 4; index++) {
            PyObject* item = __pyx_t_57(__pyx_t_71); if (unlikely(!item)) goto __pyx_L76_unpacking_failed;
            __Pyx_GOTREF(item);
            *(temps[index]) = item;
          }
          if (__Pyx_IternextUnpackEndCheck(__pyx_t_57(__pyx_t_71), 4) < 0) __PYX_ERR(0, 1776, __pyx_L1_error)
          __pyx_t_57 = NULL;
          __Pyx_DECREF(__pyx_t_71); __pyx_t_71 = 0;
          goto __pyx_L77_unpacking_done;
          __pyx_L76_unpacking_failed:;
          __Pyx_DECREF(__pyx_t_71); __pyx_t_71 = 0;
          __pyx_t_57 = NULL;
          if (__Pyx_IterFinish() == 0) __Pyx_RaiseNeedMoreValuesError(index);
          __PYX_ERR(0, 1776, __pyx_L1_error)
          __pyx_L77_unpacking_done:;
        }

        /* "orb/cutils.pyx":1776
 *             # compute transformed positions + error
 *             for istar in range(stars_p.shape[0]):
 *                 (stars_p[istar,2], stars_p[istar,3],             # <<<<<<<<<<<<<<
 *                  stars_err[istar,2], stars_err[istar,3]) = transform_A_to_B(
 *                     stars_p[istar,2], stars_p[istar,3], -cov_p[1], -cov_p[2],
 */
        __pyx_t_111 = __pyx_PyFloat_AsDouble(__pyx_t_3); if (unlikely((__pyx_t_111 == (npy_float64)-1) && PyErr_Occurred())) __PYX_ERR(0, 1776, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
        __pyx_t_62 = __pyx_PyFloat_AsDouble(__pyx_t_4); if (unlikely((__pyx_t_62 == (npy_float64)-1) && PyErr_Occurred())) __PYX_ERR(0, 1776, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
        __pyx_t_137 = __pyx_PyFloat_AsDouble(__pyx_t_43); if (unlikely((__pyx_t_137 == (npy_float64)-1) && PyErr_Occurred())) __PYX_ERR(0, 1776, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_43); __pyx_t_43 = 0;
        __pyx_t_138 = __pyx_PyFloat_AsDouble(__pyx_t_70); if (unlikely((__pyx_t_138 == (npy_float64)-1) && PyErr_Occurred())) __PYX_ERR(0, 1776, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_70); __pyx_t_70 = 0;
        __pyx_t_139 = __pyx_v_istar;
        __pyx_t_140 = 2;
        __pyx_t_12 = -1;
        if (__pyx_t_139 < 0) {
          __pyx_t_139 += __pyx_pybuffernd_stars_p.diminfo[0].shape;
          if (unlikely(__pyx_t_139 < 0)) __pyx_t_12 = 0;
        } else if (unlikely(__pyx_t_139 >= __pyx_pybuffernd_stars_p.diminfo[0].shape)) __pyx_t_12 = 0;
        if (__pyx_t_140 < 0) {
          __pyx_t_140 += __pyx_pybuffernd_stars_p.diminfo[1].shape;
          if (unlikely(__pyx_t_140 < 0)) __pyx_t_12 = 1;
        } else if (unlikely(__pyx_t_140 >= __pyx_pybuffernd_stars_p.diminfo[1].shape)) __pyx_t_12 = 1;
        if (unlikely(__pyx_t_12 != -1)) {
          __Pyx_RaiseBufferIndexError(__pyx_t_12);
          __PYX_ERR(0, 1776, __pyx_L1_error)
        }
        *__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_stars_p.rcbuffer->pybuffer.buf, __pyx_t_139, __pyx_pybuffernd_stars_p.diminfo[0].strides, __pyx_t_140, __pyx_pybuffernd_stars_p.diminfo[1].strides) = __pyx_t_111;
        __pyx_t_141 = __pyx_v_istar;
        __pyx_t_142 = 3;
        __pyx_t_12 = -1;
        if (__pyx_t_141 < 0) {
          __pyx_t_141 += __pyx_pybuffernd_stars_p.diminfo[0].shape;
          if (unlikely(__pyx_t_141 < 0)) __pyx_t_12 = 0;
        } else if (unlikely(__pyx_t_141 >= __pyx_pybuffernd_stars_p.diminfo[0].shape)) __pyx_t_12 = 0;
        if (__pyx_t_142 < 0) {
          __pyx_t_142 += __pyx_pybuffernd_stars_p.diminfo[1].shape;
          if (unlikely(__pyx_t_142 < 0)) __pyx_t_12 = 1;
        } else if (unlikely(__pyx_t_142 >= __pyx_pybuffernd_stars_p.diminfo[1].shape)) __pyx_t_12 = 1;
        if (unlikely(__pyx_t_12 != -1)) {
          __Pyx_RaiseBufferIndexError(__pyx_t_12);
          __PYX_ERR(0, 1776, __pyx_L1_error)
        }
        *__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_stars_p.rcbuffer->pybuffer.buf, __pyx_t_141, __pyx_pybuffernd_stars_p.diminfo[0].strides, __pyx_t_142, __pyx_pybuffernd_stars_p.diminfo[1].strides) = __pyx_t_62;

        /* "orb/cutils.pyx":1777
 *             for istar in range(stars_p.shape[0]):
 *                 (stars_p[istar,2], stars_p[istar,3],
 *                  stars_err[istar,2], stars_err[istar,3]) = transform_A_to_B(             # <<<<<<<<<<<<<<
 *                     stars_p[istar,2], stars_p[istar,3], -cov_p[1], -cov_p[2],
 *                     cov_p[6], 0., 0., rcx, rcy, cov_p[4], cov_p[5],
 */
        __pyx_t_143 = __pyx_v_istar;
        __pyx_t_144 = 2;
        __pyx_t_12 = -1;
        if (__pyx_t_143 < 0) {
          __pyx_t_143 += __pyx_pybuffernd_stars_err.diminfo[0].shape;
          if (unlikely(__pyx_t_143 < 0)) __pyx_t_12 = 0;
        } else if (unlikely(__pyx_t_143 >= __pyx_pybuffernd_stars_err.diminfo[0].shape)) __pyx_t_12 = 0;
        if (__pyx_t_144 < 0) {
          __pyx_t_144 += __pyx_pybuffernd_stars_err.diminfo[1].shape;
          if (unlikely(__pyx_t_144 < 0)) __pyx_t_12 = 1;
        } else if (unlikely(__pyx_t_144 >= __pyx_pybuffernd_stars_err.diminfo[1].shape)) __pyx_t_12 = 1;
        if (unlikely(__pyx_t_12 != -1)) {
          __Pyx_RaiseBufferIndexError(__pyx_t_12);
          __PYX_ERR(0, 1777, __pyx_L1_error)
        }
        *__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_stars_err.rcbuffer->pybuffer.buf, __pyx_t_143, __pyx_pybuffernd_stars_err.diminfo[0].strides, __pyx_t_144, __pyx_pybuffernd_stars_err.diminfo[1].strides) = __pyx_t_137;
        __pyx_t_145 = __pyx_v_istar;
        __pyx_t_146 = 3;
        __pyx_t_12 = -1;
        if (__pyx_t_145 < 0) {
          __pyx_t_145 += __pyx_pybuffernd_stars_err.diminfo[0].shape;
          if (unlikely(__pyx_t_145 < 0)) __pyx_t_12 = 0;
        } else if (unlikely(__pyx_t_145 >= __pyx_pybuffernd_stars_err.diminfo[0].shape)) __pyx_t_12 = 0;
        if (__pyx_t_146 < 0) {
          __pyx_t_146 += __pyx_pybuffernd_stars_err.diminfo[1].shape;
          if (unlikely(__pyx_t_146 < 0)) __pyx_t_12 = 1;
        } else if (unlikely(__pyx_t_146 >= __pyx_pybuffernd_stars_err.diminfo[1].shape)) __pyx_t_12 = 1;
        if (unlikely(__pyx_t_12 != -1)) {
          __Pyx_RaiseBufferIndexError(__pyx_t_12);
          __PYX_ERR(0, 1777, __pyx_L1_error)
        }
        *__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_stars_err.rcbuffer->pybuffer.buf, __pyx_t_145, __pyx_pybuffernd_stars_err.diminfo[0].strides, __pyx_t_146, __pyx_pybuffernd_stars_err.diminfo[1].strides) = __pyx_t_138;
      }

      /* "orb/cutils.pyx":1788
 *                     dr_err=cov_err[6],
 *                     return_err=True)
 *             if sip is not None:             # <<<<<<<<<<<<<<
 *                 stars_p[:,2:4] = sip_im2pix(stars_p[:,2:4], sip)
 * 
 */
      __pyx_t_13 = (__pyx_v_sip != Py_None);
      __pyx_t_80 = (__pyx_t_13 != 0);
      if (__pyx_t_80) {

        /* "orb/cutils.pyx":1789
 *                     return_err=True)
 *             if sip is not None:
 *                 stars_p[:,2:4] = sip_im2pix(stars_p[:,2:4], sip)             # <<<<<<<<<<<<<<
 * 
 *         # put nan in place of filtered stars
 */
        __pyx_t_70 = __Pyx_GetModuleGlobalName(__pyx_n_s_sip_im2pix); if (unlikely(!__pyx_t_70)) __PYX_ERR(0, 1789, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_70);
        __pyx_t_43 = PyObject_GetItem(((PyObject *)__pyx_v_stars_p), __pyx_tuple__136); if (unlikely(!__pyx_t_43)) __PYX_ERR(0, 1789, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_43);
        __pyx_t_4 = NULL;
        __pyx_t_46 = 0;
        if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_70))) {
          __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_70);
          if (likely(__pyx_t_4)) {
            PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_70);
            __Pyx_INCREF(__pyx_t_4);
            __Pyx_INCREF(function);
            __Pyx_DECREF_SET(__pyx_t_70, function);
            __pyx_t_46 = 1;
          }
        }
        __pyx_t_3 = PyTuple_New(2+__pyx_t_46); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1789, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_3);
        if (__pyx_t_4) {
          __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_4); __pyx_t_4 = NULL;
        }
        __Pyx_GIVEREF(__pyx_t_43);
        PyTuple_SET_ITEM(__pyx_t_3, 0+__pyx_t_46, __pyx_t_43);
        __Pyx_INCREF(__pyx_v_sip);
        __Pyx_GIVEREF(__pyx_v_sip);
        PyTuple_SET_ITEM(__pyx_t_3, 1+__pyx_t_46, __pyx_v_sip);
        __pyx_t_43 = 0;
        __pyx_t_42 = __Pyx_PyObject_Call(__pyx_t_70, __pyx_t_3, NULL); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1789, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_42);
        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
        __Pyx_DECREF(__pyx_t_70); __pyx_t_70 = 0;
        if (unlikely(PyObject_SetItem(((PyObject *)__pyx_v_stars_p), __pyx_tuple__139, __pyx_t_42) < 0)) __PYX_ERR(0, 1789, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_42); __pyx_t_42 = 0;

        /* "orb/cutils.pyx":1788
 *                     dr_err=cov_err[6],
 *                     return_err=True)
 *             if sip is not None:             # <<<<<<<<<<<<<<
 *                 stars_p[:,2:4] = sip_im2pix(stars_p[:,2:4], sip)
 * 
 */
      }
    }
    __pyx_L64:;

    /* "orb/cutils.pyx":1792
 * 
 *         # put nan in place of filtered stars
 *         new_stars_p.fill(np.nan)             # <<<<<<<<<<<<<<
 *         new_stars_err.fill(np.nan)
 *         i = 0
 */
    __pyx_t_70 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_new_stars_p), __pyx_n_s_fill); if (unlikely(!__pyx_t_70)) __PYX_ERR(0, 1792, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_70);
    __pyx_t_3 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1792, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __pyx_t_43 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_nan); if (unlikely(!__pyx_t_43)) __PYX_ERR(0, 1792, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_43);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __pyx_t_3 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && likely(PyMethod_Check(__pyx_t_70))) {
      __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_70);
      if (likely(__pyx_t_3)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_70);
        __Pyx_INCREF(__pyx_t_3);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_70, function);
      }
    }
    if (!__pyx_t_3) {
      __pyx_t_42 = __Pyx_PyObject_CallOneArg(__pyx_t_70, __pyx_t_43); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1792, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_43); __pyx_t_43 = 0;
      __Pyx_GOTREF(__pyx_t_42);
    } else {
      __pyx_t_4 = PyTuple_New(1+1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1792, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_3); __pyx_t_3 = NULL;
      __Pyx_GIVEREF(__pyx_t_43);
      PyTuple_SET_ITEM(__pyx_t_4, 0+1, __pyx_t_43);
      __pyx_t_43 = 0;
      __pyx_t_42 = __Pyx_PyObject_Call(__pyx_t_70, __pyx_t_4, NULL); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1792, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_42);
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    }
    __Pyx_DECREF(__pyx_t_70); __pyx_t_70 = 0;
    __Pyx_DECREF(__pyx_t_42); __pyx_t_42 = 0;

    /* "orb/cutils.pyx":1793
 *         # put nan in place of filtered stars
 *         new_stars_p.fill(np.nan)
 *         new_stars_err.fill(np.nan)             # <<<<<<<<<<<<<<
 *         i = 0
 *         for istar in range(pos.shape[0]):
 */
    __pyx_t_70 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_new_stars_err), __pyx_n_s_fill); if (unlikely(!__pyx_t_70)) __PYX_ERR(0, 1793, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_70);
    __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1793, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __pyx_t_43 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_nan); if (unlikely(!__pyx_t_43)) __PYX_ERR(0, 1793, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_43);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_t_4 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && likely(PyMethod_Check(__pyx_t_70))) {
      __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_70);
      if (likely(__pyx_t_4)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_70);
        __Pyx_INCREF(__pyx_t_4);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_70, function);
      }
    }
    if (!__pyx_t_4) {
      __pyx_t_42 = __Pyx_PyObject_CallOneArg(__pyx_t_70, __pyx_t_43); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1793, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_43); __pyx_t_43 = 0;
      __Pyx_GOTREF(__pyx_t_42);
    } else {
      __pyx_t_3 = PyTuple_New(1+1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1793, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_4); __pyx_t_4 = NULL;
      __Pyx_GIVEREF(__pyx_t_43);
      PyTuple_SET_ITEM(__pyx_t_3, 0+1, __pyx_t_43);
      __pyx_t_43 = 0;
      __pyx_t_42 = __Pyx_PyObject_Call(__pyx_t_70, __pyx_t_3, NULL); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1793, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_42);
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    }
    __Pyx_DECREF(__pyx_t_70); __pyx_t_70 = 0;
    __Pyx_DECREF(__pyx_t_42); __pyx_t_42 = 0;

    /* "orb/cutils.pyx":1794
 *         new_stars_p.fill(np.nan)
 *         new_stars_err.fill(np.nan)
 *         i = 0             # <<<<<<<<<<<<<<
 *         for istar in range(pos.shape[0]):
 *             if pos_mask[istar] == 1:
 */
    __Pyx_INCREF(__pyx_int_0);
    __Pyx_XDECREF_SET(__pyx_v_i, __pyx_int_0);

    /* "orb/cutils.pyx":1795
 *         new_stars_err.fill(np.nan)
 *         i = 0
 *         for istar in range(pos.shape[0]):             # <<<<<<<<<<<<<<
 *             if pos_mask[istar] == 1:
 *                 new_stars_p[istar,:] = stars_p[i]
 */
    __pyx_t_7 = (__pyx_v_pos->dimensions[0]);
    for (__pyx_t_8 = 0; __pyx_t_8 < __pyx_t_7; __pyx_t_8+=1) {
      __pyx_v_istar = __pyx_t_8;

      /* "orb/cutils.pyx":1796
 *         i = 0
 *         for istar in range(pos.shape[0]):
 *             if pos_mask[istar] == 1:             # <<<<<<<<<<<<<<
 *                 new_stars_p[istar,:] = stars_p[i]
 *                 new_stars_err[istar,:] = stars_err[i]
 */
      __pyx_t_147 = __pyx_v_istar;
      __pyx_t_12 = -1;
      if (__pyx_t_147 < 0) {
        __pyx_t_147 += __pyx_pybuffernd_pos_mask.diminfo[0].shape;
        if (unlikely(__pyx_t_147 < 0)) __pyx_t_12 = 0;
      } else if (unlikely(__pyx_t_147 >= __pyx_pybuffernd_pos_mask.diminfo[0].shape)) __pyx_t_12 = 0;
      if (unlikely(__pyx_t_12 != -1)) {
        __Pyx_RaiseBufferIndexError(__pyx_t_12);
        __PYX_ERR(0, 1796, __pyx_L1_error)
      }
      __pyx_t_80 = (((*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_uint8_t *, __pyx_pybuffernd_pos_mask.rcbuffer->pybuffer.buf, __pyx_t_147, __pyx_pybuffernd_pos_mask.diminfo[0].strides)) == 1) != 0);
      if (__pyx_t_80) {

        /* "orb/cutils.pyx":1797
 *         for istar in range(pos.shape[0]):
 *             if pos_mask[istar] == 1:
 *                 new_stars_p[istar,:] = stars_p[i]             # <<<<<<<<<<<<<<
 *                 new_stars_err[istar,:] = stars_err[i]
 *                 i += 1
 */
        __pyx_t_42 = PyObject_GetItem(((PyObject *)__pyx_v_stars_p), __pyx_v_i); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1797, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_42);
        __pyx_t_70 = __Pyx_PyInt_From_int(__pyx_v_istar); if (unlikely(!__pyx_t_70)) __PYX_ERR(0, 1797, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_70);
        __pyx_t_3 = PyTuple_New(2); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1797, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_3);
        __Pyx_GIVEREF(__pyx_t_70);
        PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_70);
        __Pyx_INCREF(__pyx_slice__140);
        __Pyx_GIVEREF(__pyx_slice__140);
        PyTuple_SET_ITEM(__pyx_t_3, 1, __pyx_slice__140);
        __pyx_t_70 = 0;
        if (unlikely(PyObject_SetItem(((PyObject *)__pyx_v_new_stars_p), __pyx_t_3, __pyx_t_42) < 0)) __PYX_ERR(0, 1797, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
        __Pyx_DECREF(__pyx_t_42); __pyx_t_42 = 0;

        /* "orb/cutils.pyx":1798
 *             if pos_mask[istar] == 1:
 *                 new_stars_p[istar,:] = stars_p[i]
 *                 new_stars_err[istar,:] = stars_err[i]             # <<<<<<<<<<<<<<
 *                 i += 1
 *         stars_err = np.copy(new_stars_err)
 */
        __pyx_t_42 = PyObject_GetItem(((PyObject *)__pyx_v_stars_err), __pyx_v_i); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1798, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_42);
        __pyx_t_3 = __Pyx_PyInt_From_int(__pyx_v_istar); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1798, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_3);
        __pyx_t_70 = PyTuple_New(2); if (unlikely(!__pyx_t_70)) __PYX_ERR(0, 1798, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_70);
        __Pyx_GIVEREF(__pyx_t_3);
        PyTuple_SET_ITEM(__pyx_t_70, 0, __pyx_t_3);
        __Pyx_INCREF(__pyx_slice__141);
        __Pyx_GIVEREF(__pyx_slice__141);
        PyTuple_SET_ITEM(__pyx_t_70, 1, __pyx_slice__141);
        __pyx_t_3 = 0;
        if (unlikely(PyObject_SetItem(((PyObject *)__pyx_v_new_stars_err), __pyx_t_70, __pyx_t_42) < 0)) __PYX_ERR(0, 1798, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_70); __pyx_t_70 = 0;
        __Pyx_DECREF(__pyx_t_42); __pyx_t_42 = 0;

        /* "orb/cutils.pyx":1799
 *                 new_stars_p[istar,:] = stars_p[i]
 *                 new_stars_err[istar,:] = stars_err[i]
 *                 i += 1             # <<<<<<<<<<<<<<
 *         stars_err = np.copy(new_stars_err)
 *         stars_p = np.copy(new_stars_p)
 */
        __pyx_t_42 = __Pyx_PyInt_AddObjC(__pyx_v_i, __pyx_int_1, 1, 1); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1799, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_42);
        __Pyx_DECREF_SET(__pyx_v_i, __pyx_t_42);
        __pyx_t_42 = 0;

        /* "orb/cutils.pyx":1796
 *         i = 0
 *         for istar in range(pos.shape[0]):
 *             if pos_mask[istar] == 1:             # <<<<<<<<<<<<<<
 *                 new_stars_p[istar,:] = stars_p[i]
 *                 new_stars_err[istar,:] = stars_err[i]
 */
      }
    }

    /* "orb/cutils.pyx":1800
 *                 new_stars_err[istar,:] = stars_err[i]
 *                 i += 1
 *         stars_err = np.copy(new_stars_err)             # <<<<<<<<<<<<<<
 *         stars_p = np.copy(new_stars_p)
 * 
 */
    __pyx_t_70 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_70)) __PYX_ERR(0, 1800, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_70);
    __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_70, __pyx_n_s_copy); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1800, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_DECREF(__pyx_t_70); __pyx_t_70 = 0;
    __pyx_t_70 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_3))) {
      __pyx_t_70 = PyMethod_GET_SELF(__pyx_t_3);
      if (likely(__pyx_t_70)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
        __Pyx_INCREF(__pyx_t_70);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_3, function);
      }
    }
    if (!__pyx_t_70) {
      __pyx_t_42 = __Pyx_PyObject_CallOneArg(__pyx_t_3, ((PyObject *)__pyx_v_new_stars_err)); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1800, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_42);
    } else {
      __pyx_t_43 = PyTuple_New(1+1); if (unlikely(!__pyx_t_43)) __PYX_ERR(0, 1800, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_43);
      __Pyx_GIVEREF(__pyx_t_70); PyTuple_SET_ITEM(__pyx_t_43, 0, __pyx_t_70); __pyx_t_70 = NULL;
      __Pyx_INCREF(((PyObject *)__pyx_v_new_stars_err));
      __Pyx_GIVEREF(((PyObject *)__pyx_v_new_stars_err));
      PyTuple_SET_ITEM(__pyx_t_43, 0+1, ((PyObject *)__pyx_v_new_stars_err));
      __pyx_t_42 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_43, NULL); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1800, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_42);
      __Pyx_DECREF(__pyx_t_43); __pyx_t_43 = 0;
    }
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    if (!(likely(((__pyx_t_42) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_42, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1800, __pyx_L1_error)
    __pyx_t_27 = ((PyArrayObject *)__pyx_t_42);
    {
      __Pyx_BufFmt_StackElem __pyx_stack[1];
      __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_stars_err.rcbuffer->pybuffer);
      __pyx_t_8 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_stars_err.rcbuffer->pybuffer, (PyObject*)__pyx_t_27, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 2, 0, __pyx_stack);
      if (unlikely(__pyx_t_8 < 0)) {
        PyErr_Fetch(&__pyx_t_24, &__pyx_t_23, &__pyx_t_22);
        if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_stars_err.rcbuffer->pybuffer, (PyObject*)__pyx_v_stars_err, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 2, 0, __pyx_stack) == -1)) {
          Py_XDECREF(__pyx_t_24); Py_XDECREF(__pyx_t_23); Py_XDECREF(__pyx_t_22);
          __Pyx_RaiseBufferFallbackError();
        } else {
          PyErr_Restore(__pyx_t_24, __pyx_t_23, __pyx_t_22);
        }
      }
      __pyx_pybuffernd_stars_err.diminfo[0].strides = __pyx_pybuffernd_stars_err.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_stars_err.diminfo[0].shape = __pyx_pybuffernd_stars_err.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_stars_err.diminfo[1].strides = __pyx_pybuffernd_stars_err.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_stars_err.diminfo[1].shape = __pyx_pybuffernd_stars_err.rcbuffer->pybuffer.shape[1];
      if (unlikely(__pyx_t_8 < 0)) __PYX_ERR(0, 1800, __pyx_L1_error)
    }
    __pyx_t_27 = 0;
    __Pyx_DECREF_SET(__pyx_v_stars_err, ((PyArrayObject *)__pyx_t_42));
    __pyx_t_42 = 0;

    /* "orb/cutils.pyx":1801
 *                 i += 1
 *         stars_err = np.copy(new_stars_err)
 *         stars_p = np.copy(new_stars_p)             # <<<<<<<<<<<<<<
 * 
 *         returned_data['stars-params-err'] = stars_err
 */
    __pyx_t_3 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1801, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __pyx_t_43 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_copy); if (unlikely(!__pyx_t_43)) __PYX_ERR(0, 1801, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_43);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __pyx_t_3 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_43))) {
      __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_43);
      if (likely(__pyx_t_3)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_43);
        __Pyx_INCREF(__pyx_t_3);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_43, function);
      }
    }
    if (!__pyx_t_3) {
      __pyx_t_42 = __Pyx_PyObject_CallOneArg(__pyx_t_43, ((PyObject *)__pyx_v_new_stars_p)); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1801, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_42);
    } else {
      __pyx_t_70 = PyTuple_New(1+1); if (unlikely(!__pyx_t_70)) __PYX_ERR(0, 1801, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_70);
      __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_70, 0, __pyx_t_3); __pyx_t_3 = NULL;
      __Pyx_INCREF(((PyObject *)__pyx_v_new_stars_p));
      __Pyx_GIVEREF(((PyObject *)__pyx_v_new_stars_p));
      PyTuple_SET_ITEM(__pyx_t_70, 0+1, ((PyObject *)__pyx_v_new_stars_p));
      __pyx_t_42 = __Pyx_PyObject_Call(__pyx_t_43, __pyx_t_70, NULL); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1801, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_42);
      __Pyx_DECREF(__pyx_t_70); __pyx_t_70 = 0;
    }
    __Pyx_DECREF(__pyx_t_43); __pyx_t_43 = 0;
    if (!(likely(((__pyx_t_42) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_42, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1801, __pyx_L1_error)
    __pyx_t_25 = ((PyArrayObject *)__pyx_t_42);
    {
      __Pyx_BufFmt_StackElem __pyx_stack[1];
      __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_stars_p.rcbuffer->pybuffer);
      __pyx_t_8 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_stars_p.rcbuffer->pybuffer, (PyObject*)__pyx_t_25, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 2, 0, __pyx_stack);
      if (unlikely(__pyx_t_8 < 0)) {
        PyErr_Fetch(&__pyx_t_22, &__pyx_t_23, &__pyx_t_24);
        if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_stars_p.rcbuffer->pybuffer, (PyObject*)__pyx_v_stars_p, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 2, 0, __pyx_stack) == -1)) {
          Py_XDECREF(__pyx_t_22); Py_XDECREF(__pyx_t_23); Py_XDECREF(__pyx_t_24);
          __Pyx_RaiseBufferFallbackError();
        } else {
          PyErr_Restore(__pyx_t_22, __pyx_t_23, __pyx_t_24);
        }
      }
      __pyx_pybuffernd_stars_p.diminfo[0].strides = __pyx_pybuffernd_stars_p.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_stars_p.diminfo[0].shape = __pyx_pybuffernd_stars_p.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_stars_p.diminfo[1].strides = __pyx_pybuffernd_stars_p.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_stars_p.diminfo[1].shape = __pyx_pybuffernd_stars_p.rcbuffer->pybuffer.shape[1];
      if (unlikely(__pyx_t_8 < 0)) __PYX_ERR(0, 1801, __pyx_L1_error)
    }
    __pyx_t_25 = 0;
    __Pyx_DECREF_SET(__pyx_v_stars_p, ((PyArrayObject *)__pyx_t_42));
    __pyx_t_42 = 0;

    /* "orb/cutils.pyx":1803
 *         stars_p = np.copy(new_stars_p)
 * 
 *         returned_data['stars-params-err'] = stars_err             # <<<<<<<<<<<<<<
 *         returned_data['stars-params'] = stars_p
 *         return returned_data
 */
    if (unlikely(PyDict_SetItem(__pyx_v_returned_data, __pyx_kp_s_stars_params_err, ((PyObject *)__pyx_v_stars_err)) < 0)) __PYX_ERR(0, 1803, __pyx_L1_error)

    /* "orb/cutils.pyx":1804
 * 
 *         returned_data['stars-params-err'] = stars_err
 *         returned_data['stars-params'] = stars_p             # <<<<<<<<<<<<<<
 *         return returned_data
 * 
 */
    if (unlikely(PyDict_SetItem(__pyx_v_returned_data, __pyx_kp_s_stars_params, ((PyObject *)__pyx_v_stars_p)) < 0)) __PYX_ERR(0, 1804, __pyx_L1_error)

    /* "orb/cutils.pyx":1805
 *         returned_data['stars-params-err'] = stars_err
 *         returned_data['stars-params'] = stars_p
 *         return returned_data             # <<<<<<<<<<<<<<
 * 
 *     else:
 */
    __Pyx_XDECREF(__pyx_r);
    __Pyx_INCREF(__pyx_v_returned_data);
    __pyx_r = __pyx_v_returned_data;
    goto __pyx_L0;

    /* "orb/cutils.pyx":1725
 * 
 *     ### CHECK FIT RESULTS ###
 *     if fit[-1] <= 4:             # <<<<<<<<<<<<<<
 *         returned_data = dict()
 *         last_diff = fit[2]['fvec']
 */
  }

  /* "orb/cutils.pyx":1808
 * 
 *     else:
 *         return []             # <<<<<<<<<<<<<<
 * 
 * 
 */
  /*else*/ {
    __Pyx_XDECREF(__pyx_r);
    __pyx_t_42 = PyList_New(0); if (unlikely(!__pyx_t_42)) __PYX_ERR(0, 1808, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_42);
    __pyx_r = __pyx_t_42;
    __pyx_t_42 = 0;
    goto __pyx_L0;
  }

  /* "orb/cutils.pyx":1208
 *     return inside
 * 
 * def multi_fit_stars(np.ndarray[np.float64_t, ndim=2] frame,             # <<<<<<<<<<<<<<
 *                     np.ndarray[np.float64_t, ndim=2] pos,
 *                     int box_size,
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_1);
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_XDECREF(__pyx_t_5);
  __Pyx_XDECREF(__pyx_t_40);
  __Pyx_XDECREF(__pyx_t_42);
  __Pyx_XDECREF(__pyx_t_43);
  __Pyx_XDECREF(__pyx_t_44);
  __Pyx_XDECREF(__pyx_t_49);
  __Pyx_XDECREF(__pyx_t_70);
  __Pyx_XDECREF(__pyx_t_71);
  __Pyx_XDECREF(__pyx_t_72);
  __Pyx_XDECREF(__pyx_t_110);
  { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
    __Pyx_PyThreadState_declare
    __Pyx_PyThreadState_assign
    __Pyx_ErrFetch(&__pyx_type, &__pyx_value, &__pyx_tb);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_amp_guess.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_box.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_cov_err.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_cov_matrix.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_cov_p.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_cov_p_mask.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_fixed_p.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_frame.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_frame_mask.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_free_p.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_fwhm_guess.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_fwhm_pix.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_new_pos.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_new_stars_err.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_new_stars_p.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_noise_guess.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_pos.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_pos_mask.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_stars_err.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_stars_p.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_stars_p_mask.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_test_p.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_test_x.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_test_y.rcbuffer->pybuffer);
  __Pyx_ErrRestore(__pyx_type, __pyx_value, __pyx_tb);}
  __Pyx_AddTraceback("orb.cutils.multi_fit_stars", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  goto __pyx_L2;
  __pyx_L0:;
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_amp_guess.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_box.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_cov_err.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_cov_matrix.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_cov_p.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_cov_p_mask.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_fixed_p.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_frame.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_frame_mask.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_free_p.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_fwhm_guess.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_fwhm_pix.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_new_pos.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_new_stars_err.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_new_stars_p.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_noise_guess.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_pos.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_pos_mask.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_stars_err.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_stars_p.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_stars_p_mask.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_test_p.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_test_x.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_test_y.rcbuffer->pybuffer);
  __pyx_L2:;
  __Pyx_XDECREF(__pyx_v_params_arrays2vect);
  __Pyx_XDECREF(__pyx_v_sigma);
  __Pyx_XDECREF(__pyx_v_diff);
  __Pyx_XDECREF((PyObject *)__pyx_v_pos_mask);
  __Pyx_XDECREF((PyObject *)__pyx_v_new_pos);
  __Pyx_XDECREF((PyObject *)__pyx_v_stars_p);
  __Pyx_XDECREF((PyObject *)__pyx_v_fwhm_pix);
  __Pyx_XDECREF((PyObject *)__pyx_v_stars_err);
  __Pyx_XDECREF((PyObject *)__pyx_v_new_stars_p);
  __Pyx_XDECREF((PyObject *)__pyx_v_new_stars_err);
  __Pyx_XDECREF((PyObject *)__pyx_v_stars_p_mask);
  __Pyx_XDECREF((PyObject *)__pyx_v_test_p);
  __Pyx_XDECREF((PyObject *)__pyx_v_cov_p);
  __Pyx_XDECREF((PyObject *)__pyx_v_cov_err);
  __Pyx_XDECREF((PyObject *)__pyx_v_cov_p_mask);
  __Pyx_XDECREF((PyObject *)__pyx_v_frame_mask);
  __Pyx_XDECREF((PyObject *)__pyx_v_amp_guess);
  __Pyx_XDECREF((PyObject *)__pyx_v_free_p);
  __Pyx_XDECREF((PyObject *)__pyx_v_fixed_p);
  __Pyx_XDECREF((PyObject *)__pyx_v_test_x);
  __Pyx_XDECREF((PyObject *)__pyx_v_test_y);
  __Pyx_XDECREF((PyObject *)__pyx_v_noise_guess);
  __Pyx_XDECREF((PyObject *)__pyx_v_cov_matrix);
  __Pyx_XDECREF((PyObject *)__pyx_v_box);
  __Pyx_XDECREF(__pyx_v_added_height);
  __Pyx_XDECREF(__pyx_v_frame_min);
  __Pyx_XDECREF(__pyx_v_nzi);
  __Pyx_XDECREF(__pyx_v_nzj);
  __Pyx_XDECREF(__pyx_v_S_sky);
  __Pyx_XDECREF(__pyx_v_sky_pixels);
  __Pyx_XDECREF(__pyx_v_fit);
  __Pyx_XDECREF(__pyx_v_e);
  __Pyx_XDECREF(__pyx_v_returned_data);
  __Pyx_XDECREF(__pyx_v_last_diff);
  __Pyx_XDECREF(__pyx_v_chisq);
  __Pyx_XDECREF(__pyx_v_red_chisq);
  __Pyx_XDECREF(__pyx_v_cov_diag);
  __Pyx_XDECREF(__pyx_v_i);
  __Pyx_XDECREF((PyObject *)__pyx_v_frame);
  __Pyx_DECREF(((PyObject *)__pyx_cur_scope));
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":1811
 * 
 * 
 * def part_value(np.ndarray[np.float64_t, ndim=1] distrib, double coeff):             # <<<<<<<<<<<<<<
 *     """Return the value lying between two parts of a partition
 * 
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_61part_value(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_3orb_6cutils_60part_value[] = "part_value(ndarray distrib, double coeff)\nReturn the value lying between two parts of a partition \n\n    The partition process is nan robusts. It is made over a\n    distribution cleaned from nans.\n    \n    :param distrib: A 1D array of floats.\n    \n    :param coeff: Partition coefficient (must be >= 0. and <= 1.). If\n      0 return the min of the distribution and if 1 return the max.\n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_61part_value = {"part_value", (PyCFunction)__pyx_pw_3orb_6cutils_61part_value, METH_VARARGS|METH_KEYWORDS, __pyx_doc_3orb_6cutils_60part_value};
static PyObject *__pyx_pw_3orb_6cutils_61part_value(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  PyArrayObject *__pyx_v_distrib = 0;
  double __pyx_v_coeff;
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("part_value (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_distrib,&__pyx_n_s_coeff,0};
    PyObject* values[2] = {0,0};
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
      switch (pos_args) {
        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = PyDict_Size(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_distrib)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        case  1:
        if (likely((values[1] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_coeff)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("part_value", 1, 2, 2, 1); __PYX_ERR(0, 1811, __pyx_L3_error)
        }
      }
      if (unlikely(kw_args > 0)) {
        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "part_value") < 0)) __PYX_ERR(0, 1811, __pyx_L3_error)
      }
    } else if (PyTuple_GET_SIZE(__pyx_args) != 2) {
      goto __pyx_L5_argtuple_error;
    } else {
      values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
      values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
    }
    __pyx_v_distrib = ((PyArrayObject *)values[0]);
    __pyx_v_coeff = __pyx_PyFloat_AsDouble(values[1]); if (unlikely((__pyx_v_coeff == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 1811, __pyx_L3_error)
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  __Pyx_RaiseArgtupleInvalid("part_value", 1, 2, 2, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 1811, __pyx_L3_error)
  __pyx_L3_error:;
  __Pyx_AddTraceback("orb.cutils.part_value", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __Pyx_RefNannyFinishContext();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_distrib), __pyx_ptype_5numpy_ndarray, 1, "distrib", 0))) __PYX_ERR(0, 1811, __pyx_L1_error)
  __pyx_r = __pyx_pf_3orb_6cutils_60part_value(__pyx_self, __pyx_v_distrib, __pyx_v_coeff);

  /* function exit code */
  goto __pyx_L0;
  __pyx_L1_error:;
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_60part_value(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_distrib, double __pyx_v_coeff) {
  PyArrayObject *__pyx_v_cleaned_distrib = 0;
  int __pyx_v_k;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_cleaned_distrib;
  __Pyx_Buffer __pyx_pybuffer_cleaned_distrib;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_distrib;
  __Pyx_Buffer __pyx_pybuffer_distrib;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  PyObject *__pyx_t_1 = NULL;
  PyObject *__pyx_t_2 = NULL;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  PyObject *__pyx_t_5 = NULL;
  PyObject *__pyx_t_6 = NULL;
  PyArrayObject *__pyx_t_7 = NULL;
  double __pyx_t_8;
  double __pyx_t_9;
  double __pyx_t_10;
  int __pyx_t_11;
  int __pyx_t_12;
  int __pyx_t_13;
  long __pyx_t_14;
  Py_ssize_t __pyx_t_15;
  __Pyx_RefNannySetupContext("part_value", 0);
  __pyx_pybuffer_cleaned_distrib.pybuffer.buf = NULL;
  __pyx_pybuffer_cleaned_distrib.refcount = 0;
  __pyx_pybuffernd_cleaned_distrib.data = NULL;
  __pyx_pybuffernd_cleaned_distrib.rcbuffer = &__pyx_pybuffer_cleaned_distrib;
  __pyx_pybuffer_distrib.pybuffer.buf = NULL;
  __pyx_pybuffer_distrib.refcount = 0;
  __pyx_pybuffernd_distrib.data = NULL;
  __pyx_pybuffernd_distrib.rcbuffer = &__pyx_pybuffer_distrib;
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_distrib.rcbuffer->pybuffer, (PyObject*)__pyx_v_distrib, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) __PYX_ERR(0, 1811, __pyx_L1_error)
  }
  __pyx_pybuffernd_distrib.diminfo[0].strides = __pyx_pybuffernd_distrib.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_distrib.diminfo[0].shape = __pyx_pybuffernd_distrib.rcbuffer->pybuffer.shape[0];

  /* "orb/cutils.pyx":1823
 *     """
 *     cdef np.ndarray[np.float64_t, ndim=1] cleaned_distrib = distrib[
 *         np.nonzero(~np.isnan(distrib))]             # <<<<<<<<<<<<<<
 *     cdef int k
 * 
 */
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1823, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_nonzero); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1823, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1823, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_isnan); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1823, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_4 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_5))) {
    __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_5);
    if (likely(__pyx_t_4)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_5);
      __Pyx_INCREF(__pyx_t_4);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_5, function);
    }
  }
  if (!__pyx_t_4) {
    __pyx_t_2 = __Pyx_PyObject_CallOneArg(__pyx_t_5, ((PyObject *)__pyx_v_distrib)); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1823, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
  } else {
    __pyx_t_6 = PyTuple_New(1+1); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1823, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
    __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_4); __pyx_t_4 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_distrib));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_distrib));
    PyTuple_SET_ITEM(__pyx_t_6, 0+1, ((PyObject *)__pyx_v_distrib));
    __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_6, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1823, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
  }
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_5 = PyNumber_Invert(__pyx_t_2); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1823, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_3))) {
    __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_3);
    if (likely(__pyx_t_2)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
      __Pyx_INCREF(__pyx_t_2);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_3, function);
    }
  }
  if (!__pyx_t_2) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_3, __pyx_t_5); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1823, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_6 = PyTuple_New(1+1); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1823, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
    __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_2); __pyx_t_2 = NULL;
    __Pyx_GIVEREF(__pyx_t_5);
    PyTuple_SET_ITEM(__pyx_t_6, 0+1, __pyx_t_5);
    __pyx_t_5 = 0;
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_6, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1823, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
  }
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;

  /* "orb/cutils.pyx":1822
 *       0 return the min of the distribution and if 1 return the max.
 *     """
 *     cdef np.ndarray[np.float64_t, ndim=1] cleaned_distrib = distrib[             # <<<<<<<<<<<<<<
 *         np.nonzero(~np.isnan(distrib))]
 *     cdef int k
 */
  __pyx_t_3 = PyObject_GetItem(((PyObject *)__pyx_v_distrib), __pyx_t_1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1822, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  if (!(likely(((__pyx_t_3) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_3, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1822, __pyx_L1_error)
  __pyx_t_7 = ((PyArrayObject *)__pyx_t_3);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_cleaned_distrib.rcbuffer->pybuffer, (PyObject*)__pyx_t_7, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
      __pyx_v_cleaned_distrib = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_cleaned_distrib.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 1822, __pyx_L1_error)
    } else {__pyx_pybuffernd_cleaned_distrib.diminfo[0].strides = __pyx_pybuffernd_cleaned_distrib.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_cleaned_distrib.diminfo[0].shape = __pyx_pybuffernd_cleaned_distrib.rcbuffer->pybuffer.shape[0];
    }
  }
  __pyx_t_7 = 0;
  __pyx_v_cleaned_distrib = ((PyArrayObject *)__pyx_t_3);
  __pyx_t_3 = 0;

  /* "orb/cutils.pyx":1826
 *     cdef int k
 * 
 *     coeff = max(0., min(1., coeff)) # coeff is coerced between 0 and 1             # <<<<<<<<<<<<<<
 * 
 *     if coeff == 0:
 */
  __pyx_t_8 = __pyx_v_coeff;
  __pyx_t_9 = 1.;
  if (((__pyx_t_8 < __pyx_t_9) != 0)) {
    __pyx_t_10 = __pyx_t_8;
  } else {
    __pyx_t_10 = __pyx_t_9;
  }
  __pyx_t_8 = __pyx_t_10;
  __pyx_t_10 = 0.;
  if (((__pyx_t_8 > __pyx_t_10) != 0)) {
    __pyx_t_9 = __pyx_t_8;
  } else {
    __pyx_t_9 = __pyx_t_10;
  }
  __pyx_v_coeff = __pyx_t_9;

  /* "orb/cutils.pyx":1828
 *     coeff = max(0., min(1., coeff)) # coeff is coerced between 0 and 1
 * 
 *     if coeff == 0:             # <<<<<<<<<<<<<<
 *         return bn.nanmin(distrib)
 *     if coeff == 1:
 */
  __pyx_t_11 = ((__pyx_v_coeff == 0.0) != 0);
  if (__pyx_t_11) {

    /* "orb/cutils.pyx":1829
 * 
 *     if coeff == 0:
 *         return bn.nanmin(distrib)             # <<<<<<<<<<<<<<
 *     if coeff == 1:
 *         return bn.nanmax(distrib)
 */
    __Pyx_XDECREF(__pyx_r);
    __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1829, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_nanmin); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1829, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    __pyx_t_1 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_6))) {
      __pyx_t_1 = PyMethod_GET_SELF(__pyx_t_6);
      if (likely(__pyx_t_1)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_6);
        __Pyx_INCREF(__pyx_t_1);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_6, function);
      }
    }
    if (!__pyx_t_1) {
      __pyx_t_3 = __Pyx_PyObject_CallOneArg(__pyx_t_6, ((PyObject *)__pyx_v_distrib)); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1829, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
    } else {
      __pyx_t_5 = PyTuple_New(1+1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1829, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __Pyx_GIVEREF(__pyx_t_1); PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_1); __pyx_t_1 = NULL;
      __Pyx_INCREF(((PyObject *)__pyx_v_distrib));
      __Pyx_GIVEREF(((PyObject *)__pyx_v_distrib));
      PyTuple_SET_ITEM(__pyx_t_5, 0+1, ((PyObject *)__pyx_v_distrib));
      __pyx_t_3 = __Pyx_PyObject_Call(__pyx_t_6, __pyx_t_5, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1829, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    }
    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
    __pyx_r = __pyx_t_3;
    __pyx_t_3 = 0;
    goto __pyx_L0;

    /* "orb/cutils.pyx":1828
 *     coeff = max(0., min(1., coeff)) # coeff is coerced between 0 and 1
 * 
 *     if coeff == 0:             # <<<<<<<<<<<<<<
 *         return bn.nanmin(distrib)
 *     if coeff == 1:
 */
  }

  /* "orb/cutils.pyx":1830
 *     if coeff == 0:
 *         return bn.nanmin(distrib)
 *     if coeff == 1:             # <<<<<<<<<<<<<<
 *         return bn.nanmax(distrib)
 * 
 */
  __pyx_t_11 = ((__pyx_v_coeff == 1.0) != 0);
  if (__pyx_t_11) {

    /* "orb/cutils.pyx":1831
 *         return bn.nanmin(distrib)
 *     if coeff == 1:
 *         return bn.nanmax(distrib)             # <<<<<<<<<<<<<<
 * 
 *     k = max(1, (min(<int> (coeff * np.size(cleaned_distrib)),
 */
    __Pyx_XDECREF(__pyx_r);
    __pyx_t_6 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1831, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
    __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_6, __pyx_n_s_nanmax); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1831, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
    __pyx_t_6 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_5))) {
      __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_5);
      if (likely(__pyx_t_6)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_5);
        __Pyx_INCREF(__pyx_t_6);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_5, function);
      }
    }
    if (!__pyx_t_6) {
      __pyx_t_3 = __Pyx_PyObject_CallOneArg(__pyx_t_5, ((PyObject *)__pyx_v_distrib)); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1831, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
    } else {
      __pyx_t_1 = PyTuple_New(1+1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1831, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);
      __Pyx_GIVEREF(__pyx_t_6); PyTuple_SET_ITEM(__pyx_t_1, 0, __pyx_t_6); __pyx_t_6 = NULL;
      __Pyx_INCREF(((PyObject *)__pyx_v_distrib));
      __Pyx_GIVEREF(((PyObject *)__pyx_v_distrib));
      PyTuple_SET_ITEM(__pyx_t_1, 0+1, ((PyObject *)__pyx_v_distrib));
      __pyx_t_3 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_1, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1831, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    }
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    __pyx_r = __pyx_t_3;
    __pyx_t_3 = 0;
    goto __pyx_L0;

    /* "orb/cutils.pyx":1830
 *     if coeff == 0:
 *         return bn.nanmin(distrib)
 *     if coeff == 1:             # <<<<<<<<<<<<<<
 *         return bn.nanmax(distrib)
 * 
 */
  }

  /* "orb/cutils.pyx":1834
 * 
 *     k = max(1, (min(<int> (coeff * np.size(cleaned_distrib)),
 *                     np.size(cleaned_distrib) - 1)))             # <<<<<<<<<<<<<<
 * 
 *     return bn.partition(cleaned_distrib, k)[k]
 */
  __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1834, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_size); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1834, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_5 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_1))) {
    __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_1);
    if (likely(__pyx_t_5)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_1);
      __Pyx_INCREF(__pyx_t_5);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_1, function);
    }
  }
  if (!__pyx_t_5) {
    __pyx_t_3 = __Pyx_PyObject_CallOneArg(__pyx_t_1, ((PyObject *)__pyx_v_cleaned_distrib)); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1834, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
  } else {
    __pyx_t_6 = PyTuple_New(1+1); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1834, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
    __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_5); __pyx_t_5 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_cleaned_distrib));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_cleaned_distrib));
    PyTuple_SET_ITEM(__pyx_t_6, 0+1, ((PyObject *)__pyx_v_cleaned_distrib));
    __pyx_t_3 = __Pyx_PyObject_Call(__pyx_t_1, __pyx_t_6, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1834, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
  }
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_1 = __Pyx_PyInt_SubtractObjC(__pyx_t_3, __pyx_int_1, 1, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1834, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;

  /* "orb/cutils.pyx":1833
 *         return bn.nanmax(distrib)
 * 
 *     k = max(1, (min(<int> (coeff * np.size(cleaned_distrib)),             # <<<<<<<<<<<<<<
 *                     np.size(cleaned_distrib) - 1)))
 * 
 */
  __pyx_t_3 = PyFloat_FromDouble(__pyx_v_coeff); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1833, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1833, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_size); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1833, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_5 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_2))) {
    __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_2);
    if (likely(__pyx_t_5)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
      __Pyx_INCREF(__pyx_t_5);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_2, function);
    }
  }
  if (!__pyx_t_5) {
    __pyx_t_6 = __Pyx_PyObject_CallOneArg(__pyx_t_2, ((PyObject *)__pyx_v_cleaned_distrib)); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1833, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
  } else {
    __pyx_t_4 = PyTuple_New(1+1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1833, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_5); __pyx_t_5 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_cleaned_distrib));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_cleaned_distrib));
    PyTuple_SET_ITEM(__pyx_t_4, 0+1, ((PyObject *)__pyx_v_cleaned_distrib));
    __pyx_t_6 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_4, NULL); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1833, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  }
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = PyNumber_Multiply(__pyx_t_3, __pyx_t_6); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1833, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
  __pyx_t_12 = __Pyx_PyInt_As_int(__pyx_t_2); if (unlikely((__pyx_t_12 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 1833, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_13 = ((int)__pyx_t_12);

  /* "orb/cutils.pyx":1834
 * 
 *     k = max(1, (min(<int> (coeff * np.size(cleaned_distrib)),
 *                     np.size(cleaned_distrib) - 1)))             # <<<<<<<<<<<<<<
 * 
 *     return bn.partition(cleaned_distrib, k)[k]
 */
  __pyx_t_6 = __Pyx_PyInt_From_int(__pyx_t_13); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1833, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __pyx_t_3 = PyObject_RichCompare(__pyx_t_1, __pyx_t_6, Py_LT); __Pyx_XGOTREF(__pyx_t_3); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1834, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
  __pyx_t_11 = __Pyx_PyObject_IsTrue(__pyx_t_3); if (unlikely(__pyx_t_11 < 0)) __PYX_ERR(0, 1834, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  if (__pyx_t_11) {
    __Pyx_INCREF(__pyx_t_1);
    __pyx_t_2 = __pyx_t_1;
  } else {

    /* "orb/cutils.pyx":1833
 *         return bn.nanmax(distrib)
 * 
 *     k = max(1, (min(<int> (coeff * np.size(cleaned_distrib)),             # <<<<<<<<<<<<<<
 *                     np.size(cleaned_distrib) - 1)))
 * 
 */
    __pyx_t_3 = __Pyx_PyInt_From_int(__pyx_t_13); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1833, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __pyx_t_2 = __pyx_t_3;
    __pyx_t_3 = 0;
  }
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __Pyx_INCREF(__pyx_t_2);
  __pyx_t_1 = __pyx_t_2;
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_14 = 1;

  /* "orb/cutils.pyx":1834
 * 
 *     k = max(1, (min(<int> (coeff * np.size(cleaned_distrib)),
 *                     np.size(cleaned_distrib) - 1)))             # <<<<<<<<<<<<<<
 * 
 *     return bn.partition(cleaned_distrib, k)[k]
 */
  __pyx_t_3 = __Pyx_PyInt_From_long(__pyx_t_14); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1833, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_6 = PyObject_RichCompare(__pyx_t_1, __pyx_t_3, Py_GT); __Pyx_XGOTREF(__pyx_t_6); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1834, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_11 = __Pyx_PyObject_IsTrue(__pyx_t_6); if (unlikely(__pyx_t_11 < 0)) __PYX_ERR(0, 1834, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
  if (__pyx_t_11) {
    __Pyx_INCREF(__pyx_t_1);
    __pyx_t_2 = __pyx_t_1;
  } else {

    /* "orb/cutils.pyx":1833
 *         return bn.nanmax(distrib)
 * 
 *     k = max(1, (min(<int> (coeff * np.size(cleaned_distrib)),             # <<<<<<<<<<<<<<
 *                     np.size(cleaned_distrib) - 1)))
 * 
 */
    __pyx_t_6 = __Pyx_PyInt_From_long(__pyx_t_14); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1833, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
    __pyx_t_2 = __pyx_t_6;
    __pyx_t_6 = 0;
  }
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1834
 * 
 *     k = max(1, (min(<int> (coeff * np.size(cleaned_distrib)),
 *                     np.size(cleaned_distrib) - 1)))             # <<<<<<<<<<<<<<
 * 
 *     return bn.partition(cleaned_distrib, k)[k]
 */
  __pyx_t_13 = __Pyx_PyInt_As_int(__pyx_t_2); if (unlikely((__pyx_t_13 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 1834, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_v_k = __pyx_t_13;

  /* "orb/cutils.pyx":1836
 *                     np.size(cleaned_distrib) - 1)))
 * 
 *     return bn.partition(cleaned_distrib, k)[k]             # <<<<<<<<<<<<<<
 * 
 * def indft(np.ndarray[np.float64_t, ndim=1] a,
 */
  __Pyx_XDECREF(__pyx_r);
  __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1836, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_partition); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1836, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_k); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1836, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_3 = NULL;
  __pyx_t_15 = 0;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_6))) {
    __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_6);
    if (likely(__pyx_t_3)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_6);
      __Pyx_INCREF(__pyx_t_3);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_6, function);
      __pyx_t_15 = 1;
    }
  }
  __pyx_t_4 = PyTuple_New(2+__pyx_t_15); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1836, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  if (__pyx_t_3) {
    __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_3); __pyx_t_3 = NULL;
  }
  __Pyx_INCREF(((PyObject *)__pyx_v_cleaned_distrib));
  __Pyx_GIVEREF(((PyObject *)__pyx_v_cleaned_distrib));
  PyTuple_SET_ITEM(__pyx_t_4, 0+__pyx_t_15, ((PyObject *)__pyx_v_cleaned_distrib));
  __Pyx_GIVEREF(__pyx_t_1);
  PyTuple_SET_ITEM(__pyx_t_4, 1+__pyx_t_15, __pyx_t_1);
  __pyx_t_1 = 0;
  __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_6, __pyx_t_4, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1836, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
  __pyx_t_6 = __Pyx_GetItemInt(__pyx_t_2, __pyx_v_k, int, 1, __Pyx_PyInt_From_int, 0, 1, 1); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1836, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_r = __pyx_t_6;
  __pyx_t_6 = 0;
  goto __pyx_L0;

  /* "orb/cutils.pyx":1811
 * 
 * 
 * def part_value(np.ndarray[np.float64_t, ndim=1] distrib, double coeff):             # <<<<<<<<<<<<<<
 *     """Return the value lying between two parts of a partition
 * 
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_1);
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_XDECREF(__pyx_t_5);
  __Pyx_XDECREF(__pyx_t_6);
  { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
    __Pyx_PyThreadState_declare
    __Pyx_PyThreadState_assign
    __Pyx_ErrFetch(&__pyx_type, &__pyx_value, &__pyx_tb);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_cleaned_distrib.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_distrib.rcbuffer->pybuffer);
  __Pyx_ErrRestore(__pyx_type, __pyx_value, __pyx_tb);}
  __Pyx_AddTraceback("orb.cutils.part_value", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  goto __pyx_L2;
  __pyx_L0:;
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_cleaned_distrib.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_distrib.rcbuffer->pybuffer);
  __pyx_L2:;
  __Pyx_XDECREF((PyObject *)__pyx_v_cleaned_distrib);
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":1838
 *     return bn.partition(cleaned_distrib, k)[k]
 * 
 * def indft(np.ndarray[np.float64_t, ndim=1] a,             # <<<<<<<<<<<<<<
 *           np.ndarray[np.float64_t, ndim=1] x):
 *     """Inverse Non-uniform Discret Fourier Transform.
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_63indft(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_3orb_6cutils_62indft[] = "indft(ndarray a, ndarray x)\nInverse Non-uniform Discret Fourier Transform.\n\n    Compute the irregularly sampled interferogram from a regularly\n    sampled spectrum.\n\n    :param a: regularly sampled spectrum.\n    \n    :param x: positions of the interferogram samples. If x =\n      range(size(a)), this function is equivalent to an idft or a\n      ifft. Note that the ifft is of course much faster to\n      compute. This vector may have any length.\n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_63indft = {"indft", (PyCFunction)__pyx_pw_3orb_6cutils_63indft, METH_VARARGS|METH_KEYWORDS, __pyx_doc_3orb_6cutils_62indft};
static PyObject *__pyx_pw_3orb_6cutils_63indft(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  PyArrayObject *__pyx_v_a = 0;
  PyArrayObject *__pyx_v_x = 0;
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("indft (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_a,&__pyx_n_s_x,0};
    PyObject* values[2] = {0,0};
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
      switch (pos_args) {
        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = PyDict_Size(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_a)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        case  1:
        if (likely((values[1] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_x)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("indft", 1, 2, 2, 1); __PYX_ERR(0, 1838, __pyx_L3_error)
        }
      }
      if (unlikely(kw_args > 0)) {
        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "indft") < 0)) __PYX_ERR(0, 1838, __pyx_L3_error)
      }
    } else if (PyTuple_GET_SIZE(__pyx_args) != 2) {
      goto __pyx_L5_argtuple_error;
    } else {
      values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
      values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
    }
    __pyx_v_a = ((PyArrayObject *)values[0]);
    __pyx_v_x = ((PyArrayObject *)values[1]);
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  __Pyx_RaiseArgtupleInvalid("indft", 1, 2, 2, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 1838, __pyx_L3_error)
  __pyx_L3_error:;
  __Pyx_AddTraceback("orb.cutils.indft", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __Pyx_RefNannyFinishContext();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_a), __pyx_ptype_5numpy_ndarray, 1, "a", 0))) __PYX_ERR(0, 1838, __pyx_L1_error)
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_x), __pyx_ptype_5numpy_ndarray, 1, "x", 0))) __PYX_ERR(0, 1839, __pyx_L1_error)
  __pyx_r = __pyx_pf_3orb_6cutils_62indft(__pyx_self, __pyx_v_a, __pyx_v_x);

  /* function exit code */
  goto __pyx_L0;
  __pyx_L1_error:;
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_62indft(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_a, PyArrayObject *__pyx_v_x) {
  int __pyx_v_N;
  int __pyx_v_M;
  float __pyx_v_angle;
  int __pyx_v_m;
  int __pyx_v_n;
  PyObject *__pyx_v_f = NULL;
  PyArrayObject *__pyx_v_freal = 0;
  PyArrayObject *__pyx_v_fimag = 0;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_a;
  __Pyx_Buffer __pyx_pybuffer_a;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_fimag;
  __Pyx_Buffer __pyx_pybuffer_fimag;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_freal;
  __Pyx_Buffer __pyx_pybuffer_freal;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_x;
  __Pyx_Buffer __pyx_pybuffer_x;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  PyObject *__pyx_t_1 = NULL;
  PyObject *__pyx_t_2 = NULL;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  PyArrayObject *__pyx_t_5 = NULL;
  PyArrayObject *__pyx_t_6 = NULL;
  int __pyx_t_7;
  int __pyx_t_8;
  int __pyx_t_9;
  int __pyx_t_10;
  Py_ssize_t __pyx_t_11;
  int __pyx_t_12;
  __pyx_t_5numpy_float64_t __pyx_t_13;
  Py_ssize_t __pyx_t_14;
  Py_ssize_t __pyx_t_15;
  Py_ssize_t __pyx_t_16;
  Py_ssize_t __pyx_t_17;
  __Pyx_RefNannySetupContext("indft", 0);
  __pyx_pybuffer_freal.pybuffer.buf = NULL;
  __pyx_pybuffer_freal.refcount = 0;
  __pyx_pybuffernd_freal.data = NULL;
  __pyx_pybuffernd_freal.rcbuffer = &__pyx_pybuffer_freal;
  __pyx_pybuffer_fimag.pybuffer.buf = NULL;
  __pyx_pybuffer_fimag.refcount = 0;
  __pyx_pybuffernd_fimag.data = NULL;
  __pyx_pybuffernd_fimag.rcbuffer = &__pyx_pybuffer_fimag;
  __pyx_pybuffer_a.pybuffer.buf = NULL;
  __pyx_pybuffer_a.refcount = 0;
  __pyx_pybuffernd_a.data = NULL;
  __pyx_pybuffernd_a.rcbuffer = &__pyx_pybuffer_a;
  __pyx_pybuffer_x.pybuffer.buf = NULL;
  __pyx_pybuffer_x.refcount = 0;
  __pyx_pybuffernd_x.data = NULL;
  __pyx_pybuffernd_x.rcbuffer = &__pyx_pybuffer_x;
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_a.rcbuffer->pybuffer, (PyObject*)__pyx_v_a, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) __PYX_ERR(0, 1838, __pyx_L1_error)
  }
  __pyx_pybuffernd_a.diminfo[0].strides = __pyx_pybuffernd_a.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_a.diminfo[0].shape = __pyx_pybuffernd_a.rcbuffer->pybuffer.shape[0];
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_x.rcbuffer->pybuffer, (PyObject*)__pyx_v_x, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) __PYX_ERR(0, 1838, __pyx_L1_error)
  }
  __pyx_pybuffernd_x.diminfo[0].strides = __pyx_pybuffernd_x.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_x.diminfo[0].shape = __pyx_pybuffernd_x.rcbuffer->pybuffer.shape[0];

  /* "orb/cutils.pyx":1852
 *       compute. This vector may have any length.
 *     """
 *     cdef int N = a.shape[0]             # <<<<<<<<<<<<<<
 *     cdef int M = x.shape[0]
 *     cdef float angle = 0.
 */
  __pyx_v_N = (__pyx_v_a->dimensions[0]);

  /* "orb/cutils.pyx":1853
 *     """
 *     cdef int N = a.shape[0]
 *     cdef int M = x.shape[0]             # <<<<<<<<<<<<<<
 *     cdef float angle = 0.
 *     cdef int m, n
 */
  __pyx_v_M = (__pyx_v_x->dimensions[0]);

  /* "orb/cutils.pyx":1854
 *     cdef int N = a.shape[0]
 *     cdef int M = x.shape[0]
 *     cdef float angle = 0.             # <<<<<<<<<<<<<<
 *     cdef int m, n
 * 
 */
  __pyx_v_angle = 0.;

  /* "orb/cutils.pyx":1857
 *     cdef int m, n
 * 
 *     f = np.zeros(M, dtype=complex)             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.float64_t, ndim=1] freal = np.zeros(M, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=1] fimag = np.zeros(M, dtype=float)
 */
  __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1857, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_zeros); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1857, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_M); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1857, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1857, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_GIVEREF(__pyx_t_1);
  PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_1);
  __pyx_t_1 = 0;
  __pyx_t_1 = PyDict_New(); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1857, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if (PyDict_SetItem(__pyx_t_1, __pyx_n_s_dtype, ((PyObject *)(&PyComplex_Type))) < 0) __PYX_ERR(0, 1857, __pyx_L1_error)
  __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_3, __pyx_t_1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1857, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_v_f = __pyx_t_4;
  __pyx_t_4 = 0;

  /* "orb/cutils.pyx":1858
 * 
 *     f = np.zeros(M, dtype=complex)
 *     cdef np.ndarray[np.float64_t, ndim=1] freal = np.zeros(M, dtype=float)             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.float64_t, ndim=1] fimag = np.zeros(M, dtype=float)
 *     for m in xrange(M):
 */
  __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1858, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_zeros); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1858, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_4 = __Pyx_PyInt_From_int(__pyx_v_M); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1858, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1858, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_GIVEREF(__pyx_t_4);
  PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_4);
  __pyx_t_4 = 0;
  __pyx_t_4 = PyDict_New(); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1858, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  if (PyDict_SetItem(__pyx_t_4, __pyx_n_s_dtype, ((PyObject *)(&PyFloat_Type))) < 0) __PYX_ERR(0, 1858, __pyx_L1_error)
  __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_1, __pyx_t_3, __pyx_t_4); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1858, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  if (!(likely(((__pyx_t_2) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_2, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1858, __pyx_L1_error)
  __pyx_t_5 = ((PyArrayObject *)__pyx_t_2);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_freal.rcbuffer->pybuffer, (PyObject*)__pyx_t_5, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 1, 0, __pyx_stack) == -1)) {
      __pyx_v_freal = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_freal.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 1858, __pyx_L1_error)
    } else {__pyx_pybuffernd_freal.diminfo[0].strides = __pyx_pybuffernd_freal.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_freal.diminfo[0].shape = __pyx_pybuffernd_freal.rcbuffer->pybuffer.shape[0];
    }
  }
  __pyx_t_5 = 0;
  __pyx_v_freal = ((PyArrayObject *)__pyx_t_2);
  __pyx_t_2 = 0;

  /* "orb/cutils.pyx":1859
 *     f = np.zeros(M, dtype=complex)
 *     cdef np.ndarray[np.float64_t, ndim=1] freal = np.zeros(M, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=1] fimag = np.zeros(M, dtype=float)             # <<<<<<<<<<<<<<
 *     for m in xrange(M):
 *         for n in xrange(N):
 */
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1859, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_zeros); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1859, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = __Pyx_PyInt_From_int(__pyx_v_M); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1859, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1859, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_GIVEREF(__pyx_t_2);
  PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_2);
  __pyx_t_2 = 0;
  __pyx_t_2 = PyDict_New(); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1859, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  if (PyDict_SetItem(__pyx_t_2, __pyx_n_s_dtype, ((PyObject *)(&PyFloat_Type))) < 0) __PYX_ERR(0, 1859, __pyx_L1_error)
  __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_3, __pyx_t_2); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1859, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1859, __pyx_L1_error)
  __pyx_t_6 = ((PyArrayObject *)__pyx_t_1);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_fimag.rcbuffer->pybuffer, (PyObject*)__pyx_t_6, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 1, 0, __pyx_stack) == -1)) {
      __pyx_v_fimag = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_fimag.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 1859, __pyx_L1_error)
    } else {__pyx_pybuffernd_fimag.diminfo[0].strides = __pyx_pybuffernd_fimag.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_fimag.diminfo[0].shape = __pyx_pybuffernd_fimag.rcbuffer->pybuffer.shape[0];
    }
  }
  __pyx_t_6 = 0;
  __pyx_v_fimag = ((PyArrayObject *)__pyx_t_1);
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1860
 *     cdef np.ndarray[np.float64_t, ndim=1] freal = np.zeros(M, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=1] fimag = np.zeros(M, dtype=float)
 *     for m in xrange(M):             # <<<<<<<<<<<<<<
 *         for n in xrange(N):
 *             angle = 2. * M_PI * x[m] * n / N
 */
  __pyx_t_7 = __pyx_v_M;
  for (__pyx_t_8 = 0; __pyx_t_8 < __pyx_t_7; __pyx_t_8+=1) {
    __pyx_v_m = __pyx_t_8;

    /* "orb/cutils.pyx":1861
 *     cdef np.ndarray[np.float64_t, ndim=1] fimag = np.zeros(M, dtype=float)
 *     for m in xrange(M):
 *         for n in xrange(N):             # <<<<<<<<<<<<<<
 *             angle = 2. * M_PI * x[m] * n / N
 *             freal[m] += a[n] * cos(angle)
 */
    __pyx_t_9 = __pyx_v_N;
    for (__pyx_t_10 = 0; __pyx_t_10 < __pyx_t_9; __pyx_t_10+=1) {
      __pyx_v_n = __pyx_t_10;

      /* "orb/cutils.pyx":1862
 *     for m in xrange(M):
 *         for n in xrange(N):
 *             angle = 2. * M_PI * x[m] * n / N             # <<<<<<<<<<<<<<
 *             freal[m] += a[n] * cos(angle)
 *             fimag[m] += a[n] * sin(angle)
 */
      __pyx_t_11 = __pyx_v_m;
      __pyx_t_12 = -1;
      if (__pyx_t_11 < 0) {
        __pyx_t_11 += __pyx_pybuffernd_x.diminfo[0].shape;
        if (unlikely(__pyx_t_11 < 0)) __pyx_t_12 = 0;
      } else if (unlikely(__pyx_t_11 >= __pyx_pybuffernd_x.diminfo[0].shape)) __pyx_t_12 = 0;
      if (unlikely(__pyx_t_12 != -1)) {
        __Pyx_RaiseBufferIndexError(__pyx_t_12);
        __PYX_ERR(0, 1862, __pyx_L1_error)
      }
      __pyx_t_13 = (((2. * M_PI) * (*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_x.rcbuffer->pybuffer.buf, __pyx_t_11, __pyx_pybuffernd_x.diminfo[0].strides))) * __pyx_v_n);
      if (unlikely(__pyx_v_N == 0)) {
        PyErr_SetString(PyExc_ZeroDivisionError, "float division");
        __PYX_ERR(0, 1862, __pyx_L1_error)
      }
      __pyx_v_angle = (__pyx_t_13 / __pyx_v_N);

      /* "orb/cutils.pyx":1863
 *         for n in xrange(N):
 *             angle = 2. * M_PI * x[m] * n / N
 *             freal[m] += a[n] * cos(angle)             # <<<<<<<<<<<<<<
 *             fimag[m] += a[n] * sin(angle)
 *     f.real = freal
 */
      __pyx_t_14 = __pyx_v_n;
      __pyx_t_12 = -1;
      if (__pyx_t_14 < 0) {
        __pyx_t_14 += __pyx_pybuffernd_a.diminfo[0].shape;
        if (unlikely(__pyx_t_14 < 0)) __pyx_t_12 = 0;
      } else if (unlikely(__pyx_t_14 >= __pyx_pybuffernd_a.diminfo[0].shape)) __pyx_t_12 = 0;
      if (unlikely(__pyx_t_12 != -1)) {
        __Pyx_RaiseBufferIndexError(__pyx_t_12);
        __PYX_ERR(0, 1863, __pyx_L1_error)
      }
      __pyx_t_15 = __pyx_v_m;
      __pyx_t_12 = -1;
      if (__pyx_t_15 < 0) {
        __pyx_t_15 += __pyx_pybuffernd_freal.diminfo[0].shape;
        if (unlikely(__pyx_t_15 < 0)) __pyx_t_12 = 0;
      } else if (unlikely(__pyx_t_15 >= __pyx_pybuffernd_freal.diminfo[0].shape)) __pyx_t_12 = 0;
      if (unlikely(__pyx_t_12 != -1)) {
        __Pyx_RaiseBufferIndexError(__pyx_t_12);
        __PYX_ERR(0, 1863, __pyx_L1_error)
      }
      *__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_freal.rcbuffer->pybuffer.buf, __pyx_t_15, __pyx_pybuffernd_freal.diminfo[0].strides) += ((*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_a.rcbuffer->pybuffer.buf, __pyx_t_14, __pyx_pybuffernd_a.diminfo[0].strides)) * cos(__pyx_v_angle));

      /* "orb/cutils.pyx":1864
 *             angle = 2. * M_PI * x[m] * n / N
 *             freal[m] += a[n] * cos(angle)
 *             fimag[m] += a[n] * sin(angle)             # <<<<<<<<<<<<<<
 *     f.real = freal
 *     f.imag = fimag
 */
      __pyx_t_16 = __pyx_v_n;
      __pyx_t_12 = -1;
      if (__pyx_t_16 < 0) {
        __pyx_t_16 += __pyx_pybuffernd_a.diminfo[0].shape;
        if (unlikely(__pyx_t_16 < 0)) __pyx_t_12 = 0;
      } else if (unlikely(__pyx_t_16 >= __pyx_pybuffernd_a.diminfo[0].shape)) __pyx_t_12 = 0;
      if (unlikely(__pyx_t_12 != -1)) {
        __Pyx_RaiseBufferIndexError(__pyx_t_12);
        __PYX_ERR(0, 1864, __pyx_L1_error)
      }
      __pyx_t_17 = __pyx_v_m;
      __pyx_t_12 = -1;
      if (__pyx_t_17 < 0) {
        __pyx_t_17 += __pyx_pybuffernd_fimag.diminfo[0].shape;
        if (unlikely(__pyx_t_17 < 0)) __pyx_t_12 = 0;
      } else if (unlikely(__pyx_t_17 >= __pyx_pybuffernd_fimag.diminfo[0].shape)) __pyx_t_12 = 0;
      if (unlikely(__pyx_t_12 != -1)) {
        __Pyx_RaiseBufferIndexError(__pyx_t_12);
        __PYX_ERR(0, 1864, __pyx_L1_error)
      }
      *__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_fimag.rcbuffer->pybuffer.buf, __pyx_t_17, __pyx_pybuffernd_fimag.diminfo[0].strides) += ((*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_a.rcbuffer->pybuffer.buf, __pyx_t_16, __pyx_pybuffernd_a.diminfo[0].strides)) * sin(__pyx_v_angle));
    }
  }

  /* "orb/cutils.pyx":1865
 *             freal[m] += a[n] * cos(angle)
 *             fimag[m] += a[n] * sin(angle)
 *     f.real = freal             # <<<<<<<<<<<<<<
 *     f.imag = fimag
 *     return f / N
 */
  if (__Pyx_PyObject_SetAttrStr(__pyx_v_f, __pyx_n_s_real, ((PyObject *)__pyx_v_freal)) < 0) __PYX_ERR(0, 1865, __pyx_L1_error)

  /* "orb/cutils.pyx":1866
 *             fimag[m] += a[n] * sin(angle)
 *     f.real = freal
 *     f.imag = fimag             # <<<<<<<<<<<<<<
 *     return f / N
 * 
 */
  if (__Pyx_PyObject_SetAttrStr(__pyx_v_f, __pyx_n_s_imag, ((PyObject *)__pyx_v_fimag)) < 0) __PYX_ERR(0, 1866, __pyx_L1_error)

  /* "orb/cutils.pyx":1867
 *     f.real = freal
 *     f.imag = fimag
 *     return f / N             # <<<<<<<<<<<<<<
 * 
 * def dft(np.ndarray[np.float64_t, ndim=1] a,
 */
  __Pyx_XDECREF(__pyx_r);
  __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_N); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1867, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_2 = __Pyx_PyNumber_Divide(__pyx_v_f, __pyx_t_1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1867, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_r = __pyx_t_2;
  __pyx_t_2 = 0;
  goto __pyx_L0;

  /* "orb/cutils.pyx":1838
 *     return bn.partition(cleaned_distrib, k)[k]
 * 
 * def indft(np.ndarray[np.float64_t, ndim=1] a,             # <<<<<<<<<<<<<<
 *           np.ndarray[np.float64_t, ndim=1] x):
 *     """Inverse Non-uniform Discret Fourier Transform.
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_1);
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
    __Pyx_PyThreadState_declare
    __Pyx_PyThreadState_assign
    __Pyx_ErrFetch(&__pyx_type, &__pyx_value, &__pyx_tb);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_a.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_fimag.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_freal.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_x.rcbuffer->pybuffer);
  __Pyx_ErrRestore(__pyx_type, __pyx_value, __pyx_tb);}
  __Pyx_AddTraceback("orb.cutils.indft", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  goto __pyx_L2;
  __pyx_L0:;
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_a.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_fimag.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_freal.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_x.rcbuffer->pybuffer);
  __pyx_L2:;
  __Pyx_XDECREF(__pyx_v_f);
  __Pyx_XDECREF((PyObject *)__pyx_v_freal);
  __Pyx_XDECREF((PyObject *)__pyx_v_fimag);
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":1869
 *     return f / N
 * 
 * def dft(np.ndarray[np.float64_t, ndim=1] a,             # <<<<<<<<<<<<<<
 *         np.ndarray[np.float64_t, ndim=1] x):
 *     """Discret Fourier Transform.
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_65dft(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_3orb_6cutils_64dft[] = "dft(ndarray a, ndarray x)\nDiscret Fourier Transform.\n\n    Compute an irregularly sampled spectrum from a regularly\n    sampled interferogram.\n\n    :param a: regularly sampled interferogram.\n    \n    :param x: positions of the spectrum samples. If x =\n      range(size(a)), this function is equivalent to an fft. Note that\n      the fft is of course much faster to compute. This vector may\n      have any length.\n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_65dft = {"dft", (PyCFunction)__pyx_pw_3orb_6cutils_65dft, METH_VARARGS|METH_KEYWORDS, __pyx_doc_3orb_6cutils_64dft};
static PyObject *__pyx_pw_3orb_6cutils_65dft(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  PyArrayObject *__pyx_v_a = 0;
  PyArrayObject *__pyx_v_x = 0;
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("dft (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_a,&__pyx_n_s_x,0};
    PyObject* values[2] = {0,0};
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
      switch (pos_args) {
        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = PyDict_Size(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_a)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        case  1:
        if (likely((values[1] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_x)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("dft", 1, 2, 2, 1); __PYX_ERR(0, 1869, __pyx_L3_error)
        }
      }
      if (unlikely(kw_args > 0)) {
        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "dft") < 0)) __PYX_ERR(0, 1869, __pyx_L3_error)
      }
    } else if (PyTuple_GET_SIZE(__pyx_args) != 2) {
      goto __pyx_L5_argtuple_error;
    } else {
      values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
      values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
    }
    __pyx_v_a = ((PyArrayObject *)values[0]);
    __pyx_v_x = ((PyArrayObject *)values[1]);
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  __Pyx_RaiseArgtupleInvalid("dft", 1, 2, 2, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 1869, __pyx_L3_error)
  __pyx_L3_error:;
  __Pyx_AddTraceback("orb.cutils.dft", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __Pyx_RefNannyFinishContext();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_a), __pyx_ptype_5numpy_ndarray, 1, "a", 0))) __PYX_ERR(0, 1869, __pyx_L1_error)
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_x), __pyx_ptype_5numpy_ndarray, 1, "x", 0))) __PYX_ERR(0, 1870, __pyx_L1_error)
  __pyx_r = __pyx_pf_3orb_6cutils_64dft(__pyx_self, __pyx_v_a, __pyx_v_x);

  /* function exit code */
  goto __pyx_L0;
  __pyx_L1_error:;
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_64dft(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_a, PyArrayObject *__pyx_v_x) {
  int __pyx_v_N;
  int __pyx_v_M;
  float __pyx_v_angle;
  int __pyx_v_m;
  int __pyx_v_n;
  PyObject *__pyx_v_f = NULL;
  PyArrayObject *__pyx_v_freal = 0;
  PyArrayObject *__pyx_v_fimag = 0;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_a;
  __Pyx_Buffer __pyx_pybuffer_a;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_fimag;
  __Pyx_Buffer __pyx_pybuffer_fimag;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_freal;
  __Pyx_Buffer __pyx_pybuffer_freal;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_x;
  __Pyx_Buffer __pyx_pybuffer_x;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  PyObject *__pyx_t_1 = NULL;
  PyObject *__pyx_t_2 = NULL;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  PyArrayObject *__pyx_t_5 = NULL;
  PyArrayObject *__pyx_t_6 = NULL;
  int __pyx_t_7;
  int __pyx_t_8;
  int __pyx_t_9;
  int __pyx_t_10;
  Py_ssize_t __pyx_t_11;
  int __pyx_t_12;
  __pyx_t_5numpy_float64_t __pyx_t_13;
  Py_ssize_t __pyx_t_14;
  Py_ssize_t __pyx_t_15;
  Py_ssize_t __pyx_t_16;
  Py_ssize_t __pyx_t_17;
  __Pyx_RefNannySetupContext("dft", 0);
  __pyx_pybuffer_freal.pybuffer.buf = NULL;
  __pyx_pybuffer_freal.refcount = 0;
  __pyx_pybuffernd_freal.data = NULL;
  __pyx_pybuffernd_freal.rcbuffer = &__pyx_pybuffer_freal;
  __pyx_pybuffer_fimag.pybuffer.buf = NULL;
  __pyx_pybuffer_fimag.refcount = 0;
  __pyx_pybuffernd_fimag.data = NULL;
  __pyx_pybuffernd_fimag.rcbuffer = &__pyx_pybuffer_fimag;
  __pyx_pybuffer_a.pybuffer.buf = NULL;
  __pyx_pybuffer_a.refcount = 0;
  __pyx_pybuffernd_a.data = NULL;
  __pyx_pybuffernd_a.rcbuffer = &__pyx_pybuffer_a;
  __pyx_pybuffer_x.pybuffer.buf = NULL;
  __pyx_pybuffer_x.refcount = 0;
  __pyx_pybuffernd_x.data = NULL;
  __pyx_pybuffernd_x.rcbuffer = &__pyx_pybuffer_x;
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_a.rcbuffer->pybuffer, (PyObject*)__pyx_v_a, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) __PYX_ERR(0, 1869, __pyx_L1_error)
  }
  __pyx_pybuffernd_a.diminfo[0].strides = __pyx_pybuffernd_a.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_a.diminfo[0].shape = __pyx_pybuffernd_a.rcbuffer->pybuffer.shape[0];
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_x.rcbuffer->pybuffer, (PyObject*)__pyx_v_x, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) __PYX_ERR(0, 1869, __pyx_L1_error)
  }
  __pyx_pybuffernd_x.diminfo[0].strides = __pyx_pybuffernd_x.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_x.diminfo[0].shape = __pyx_pybuffernd_x.rcbuffer->pybuffer.shape[0];

  /* "orb/cutils.pyx":1883
 *       have any length.
 *     """
 *     cdef int N = a.shape[0]             # <<<<<<<<<<<<<<
 *     cdef int M = x.shape[0]
 *     cdef float angle = 0.
 */
  __pyx_v_N = (__pyx_v_a->dimensions[0]);

  /* "orb/cutils.pyx":1884
 *     """
 *     cdef int N = a.shape[0]
 *     cdef int M = x.shape[0]             # <<<<<<<<<<<<<<
 *     cdef float angle = 0.
 *     cdef int m, n
 */
  __pyx_v_M = (__pyx_v_x->dimensions[0]);

  /* "orb/cutils.pyx":1885
 *     cdef int N = a.shape[0]
 *     cdef int M = x.shape[0]
 *     cdef float angle = 0.             # <<<<<<<<<<<<<<
 *     cdef int m, n
 * 
 */
  __pyx_v_angle = 0.;

  /* "orb/cutils.pyx":1888
 *     cdef int m, n
 * 
 *     f = np.zeros(M, dtype=complex)             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.float64_t, ndim=1] freal = np.zeros(M, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=1] fimag = np.zeros(M, dtype=float)
 */
  __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1888, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_zeros); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1888, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_M); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1888, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1888, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_GIVEREF(__pyx_t_1);
  PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_1);
  __pyx_t_1 = 0;
  __pyx_t_1 = PyDict_New(); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1888, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if (PyDict_SetItem(__pyx_t_1, __pyx_n_s_dtype, ((PyObject *)(&PyComplex_Type))) < 0) __PYX_ERR(0, 1888, __pyx_L1_error)
  __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_3, __pyx_t_1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1888, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_v_f = __pyx_t_4;
  __pyx_t_4 = 0;

  /* "orb/cutils.pyx":1889
 * 
 *     f = np.zeros(M, dtype=complex)
 *     cdef np.ndarray[np.float64_t, ndim=1] freal = np.zeros(M, dtype=float)             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.float64_t, ndim=1] fimag = np.zeros(M, dtype=float)
 *     for m in xrange(M):
 */
  __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1889, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_zeros); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1889, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_4 = __Pyx_PyInt_From_int(__pyx_v_M); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1889, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1889, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_GIVEREF(__pyx_t_4);
  PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_4);
  __pyx_t_4 = 0;
  __pyx_t_4 = PyDict_New(); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1889, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  if (PyDict_SetItem(__pyx_t_4, __pyx_n_s_dtype, ((PyObject *)(&PyFloat_Type))) < 0) __PYX_ERR(0, 1889, __pyx_L1_error)
  __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_1, __pyx_t_3, __pyx_t_4); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1889, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  if (!(likely(((__pyx_t_2) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_2, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1889, __pyx_L1_error)
  __pyx_t_5 = ((PyArrayObject *)__pyx_t_2);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_freal.rcbuffer->pybuffer, (PyObject*)__pyx_t_5, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 1, 0, __pyx_stack) == -1)) {
      __pyx_v_freal = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_freal.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 1889, __pyx_L1_error)
    } else {__pyx_pybuffernd_freal.diminfo[0].strides = __pyx_pybuffernd_freal.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_freal.diminfo[0].shape = __pyx_pybuffernd_freal.rcbuffer->pybuffer.shape[0];
    }
  }
  __pyx_t_5 = 0;
  __pyx_v_freal = ((PyArrayObject *)__pyx_t_2);
  __pyx_t_2 = 0;

  /* "orb/cutils.pyx":1890
 *     f = np.zeros(M, dtype=complex)
 *     cdef np.ndarray[np.float64_t, ndim=1] freal = np.zeros(M, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=1] fimag = np.zeros(M, dtype=float)             # <<<<<<<<<<<<<<
 *     for m in xrange(M):
 *         for n in xrange(N):
 */
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1890, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_zeros); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1890, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = __Pyx_PyInt_From_int(__pyx_v_M); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1890, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1890, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_GIVEREF(__pyx_t_2);
  PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_2);
  __pyx_t_2 = 0;
  __pyx_t_2 = PyDict_New(); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1890, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  if (PyDict_SetItem(__pyx_t_2, __pyx_n_s_dtype, ((PyObject *)(&PyFloat_Type))) < 0) __PYX_ERR(0, 1890, __pyx_L1_error)
  __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_3, __pyx_t_2); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1890, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1890, __pyx_L1_error)
  __pyx_t_6 = ((PyArrayObject *)__pyx_t_1);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_fimag.rcbuffer->pybuffer, (PyObject*)__pyx_t_6, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 1, 0, __pyx_stack) == -1)) {
      __pyx_v_fimag = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_fimag.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 1890, __pyx_L1_error)
    } else {__pyx_pybuffernd_fimag.diminfo[0].strides = __pyx_pybuffernd_fimag.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_fimag.diminfo[0].shape = __pyx_pybuffernd_fimag.rcbuffer->pybuffer.shape[0];
    }
  }
  __pyx_t_6 = 0;
  __pyx_v_fimag = ((PyArrayObject *)__pyx_t_1);
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1891
 *     cdef np.ndarray[np.float64_t, ndim=1] freal = np.zeros(M, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=1] fimag = np.zeros(M, dtype=float)
 *     for m in xrange(M):             # <<<<<<<<<<<<<<
 *         for n in xrange(N):
 *             angle = -2. * M_PI * x[m] * n / N
 */
  __pyx_t_7 = __pyx_v_M;
  for (__pyx_t_8 = 0; __pyx_t_8 < __pyx_t_7; __pyx_t_8+=1) {
    __pyx_v_m = __pyx_t_8;

    /* "orb/cutils.pyx":1892
 *     cdef np.ndarray[np.float64_t, ndim=1] fimag = np.zeros(M, dtype=float)
 *     for m in xrange(M):
 *         for n in xrange(N):             # <<<<<<<<<<<<<<
 *             angle = -2. * M_PI * x[m] * n / N
 *             freal[m] += a[n] * cos(angle)
 */
    __pyx_t_9 = __pyx_v_N;
    for (__pyx_t_10 = 0; __pyx_t_10 < __pyx_t_9; __pyx_t_10+=1) {
      __pyx_v_n = __pyx_t_10;

      /* "orb/cutils.pyx":1893
 *     for m in xrange(M):
 *         for n in xrange(N):
 *             angle = -2. * M_PI * x[m] * n / N             # <<<<<<<<<<<<<<
 *             freal[m] += a[n] * cos(angle)
 *             fimag[m] += a[n] * sin(angle)
 */
      __pyx_t_11 = __pyx_v_m;
      __pyx_t_12 = -1;
      if (__pyx_t_11 < 0) {
        __pyx_t_11 += __pyx_pybuffernd_x.diminfo[0].shape;
        if (unlikely(__pyx_t_11 < 0)) __pyx_t_12 = 0;
      } else if (unlikely(__pyx_t_11 >= __pyx_pybuffernd_x.diminfo[0].shape)) __pyx_t_12 = 0;
      if (unlikely(__pyx_t_12 != -1)) {
        __Pyx_RaiseBufferIndexError(__pyx_t_12);
        __PYX_ERR(0, 1893, __pyx_L1_error)
      }
      __pyx_t_13 = (((-2. * M_PI) * (*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_x.rcbuffer->pybuffer.buf, __pyx_t_11, __pyx_pybuffernd_x.diminfo[0].strides))) * __pyx_v_n);
      if (unlikely(__pyx_v_N == 0)) {
        PyErr_SetString(PyExc_ZeroDivisionError, "float division");
        __PYX_ERR(0, 1893, __pyx_L1_error)
      }
      __pyx_v_angle = (__pyx_t_13 / __pyx_v_N);

      /* "orb/cutils.pyx":1894
 *         for n in xrange(N):
 *             angle = -2. * M_PI * x[m] * n / N
 *             freal[m] += a[n] * cos(angle)             # <<<<<<<<<<<<<<
 *             fimag[m] += a[n] * sin(angle)
 *     f.real = freal
 */
      __pyx_t_14 = __pyx_v_n;
      __pyx_t_12 = -1;
      if (__pyx_t_14 < 0) {
        __pyx_t_14 += __pyx_pybuffernd_a.diminfo[0].shape;
        if (unlikely(__pyx_t_14 < 0)) __pyx_t_12 = 0;
      } else if (unlikely(__pyx_t_14 >= __pyx_pybuffernd_a.diminfo[0].shape)) __pyx_t_12 = 0;
      if (unlikely(__pyx_t_12 != -1)) {
        __Pyx_RaiseBufferIndexError(__pyx_t_12);
        __PYX_ERR(0, 1894, __pyx_L1_error)
      }
      __pyx_t_15 = __pyx_v_m;
      __pyx_t_12 = -1;
      if (__pyx_t_15 < 0) {
        __pyx_t_15 += __pyx_pybuffernd_freal.diminfo[0].shape;
        if (unlikely(__pyx_t_15 < 0)) __pyx_t_12 = 0;
      } else if (unlikely(__pyx_t_15 >= __pyx_pybuffernd_freal.diminfo[0].shape)) __pyx_t_12 = 0;
      if (unlikely(__pyx_t_12 != -1)) {
        __Pyx_RaiseBufferIndexError(__pyx_t_12);
        __PYX_ERR(0, 1894, __pyx_L1_error)
      }
      *__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_freal.rcbuffer->pybuffer.buf, __pyx_t_15, __pyx_pybuffernd_freal.diminfo[0].strides) += ((*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_a.rcbuffer->pybuffer.buf, __pyx_t_14, __pyx_pybuffernd_a.diminfo[0].strides)) * cos(__pyx_v_angle));

      /* "orb/cutils.pyx":1895
 *             angle = -2. * M_PI * x[m] * n / N
 *             freal[m] += a[n] * cos(angle)
 *             fimag[m] += a[n] * sin(angle)             # <<<<<<<<<<<<<<
 *     f.real = freal
 *     f.imag = fimag
 */
      __pyx_t_16 = __pyx_v_n;
      __pyx_t_12 = -1;
      if (__pyx_t_16 < 0) {
        __pyx_t_16 += __pyx_pybuffernd_a.diminfo[0].shape;
        if (unlikely(__pyx_t_16 < 0)) __pyx_t_12 = 0;
      } else if (unlikely(__pyx_t_16 >= __pyx_pybuffernd_a.diminfo[0].shape)) __pyx_t_12 = 0;
      if (unlikely(__pyx_t_12 != -1)) {
        __Pyx_RaiseBufferIndexError(__pyx_t_12);
        __PYX_ERR(0, 1895, __pyx_L1_error)
      }
      __pyx_t_17 = __pyx_v_m;
      __pyx_t_12 = -1;
      if (__pyx_t_17 < 0) {
        __pyx_t_17 += __pyx_pybuffernd_fimag.diminfo[0].shape;
        if (unlikely(__pyx_t_17 < 0)) __pyx_t_12 = 0;
      } else if (unlikely(__pyx_t_17 >= __pyx_pybuffernd_fimag.diminfo[0].shape)) __pyx_t_12 = 0;
      if (unlikely(__pyx_t_12 != -1)) {
        __Pyx_RaiseBufferIndexError(__pyx_t_12);
        __PYX_ERR(0, 1895, __pyx_L1_error)
      }
      *__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_fimag.rcbuffer->pybuffer.buf, __pyx_t_17, __pyx_pybuffernd_fimag.diminfo[0].strides) += ((*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_a.rcbuffer->pybuffer.buf, __pyx_t_16, __pyx_pybuffernd_a.diminfo[0].strides)) * sin(__pyx_v_angle));
    }
  }

  /* "orb/cutils.pyx":1896
 *             freal[m] += a[n] * cos(angle)
 *             fimag[m] += a[n] * sin(angle)
 *     f.real = freal             # <<<<<<<<<<<<<<
 *     f.imag = fimag
 *     return f
 */
  if (__Pyx_PyObject_SetAttrStr(__pyx_v_f, __pyx_n_s_real, ((PyObject *)__pyx_v_freal)) < 0) __PYX_ERR(0, 1896, __pyx_L1_error)

  /* "orb/cutils.pyx":1897
 *             fimag[m] += a[n] * sin(angle)
 *     f.real = freal
 *     f.imag = fimag             # <<<<<<<<<<<<<<
 *     return f
 * 
 */
  if (__Pyx_PyObject_SetAttrStr(__pyx_v_f, __pyx_n_s_imag, ((PyObject *)__pyx_v_fimag)) < 0) __PYX_ERR(0, 1897, __pyx_L1_error)

  /* "orb/cutils.pyx":1898
 *     f.real = freal
 *     f.imag = fimag
 *     return f             # <<<<<<<<<<<<<<
 * 
 * 
 */
  __Pyx_XDECREF(__pyx_r);
  __Pyx_INCREF(__pyx_v_f);
  __pyx_r = __pyx_v_f;
  goto __pyx_L0;

  /* "orb/cutils.pyx":1869
 *     return f / N
 * 
 * def dft(np.ndarray[np.float64_t, ndim=1] a,             # <<<<<<<<<<<<<<
 *         np.ndarray[np.float64_t, ndim=1] x):
 *     """Discret Fourier Transform.
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_1);
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
    __Pyx_PyThreadState_declare
    __Pyx_PyThreadState_assign
    __Pyx_ErrFetch(&__pyx_type, &__pyx_value, &__pyx_tb);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_a.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_fimag.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_freal.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_x.rcbuffer->pybuffer);
  __Pyx_ErrRestore(__pyx_type, __pyx_value, __pyx_tb);}
  __Pyx_AddTraceback("orb.cutils.dft", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  goto __pyx_L2;
  __pyx_L0:;
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_a.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_fimag.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_freal.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_x.rcbuffer->pybuffer);
  __pyx_L2:;
  __Pyx_XDECREF(__pyx_v_f);
  __Pyx_XDECREF((PyObject *)__pyx_v_freal);
  __Pyx_XDECREF((PyObject *)__pyx_v_fimag);
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":1901
 * 
 * 
 * def map_me(np.ndarray[np.float64_t, ndim=2] frame):             # <<<<<<<<<<<<<<
 *     """Create a map of the modulation efficiency from a laser frame.
 * 
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_67map_me(PyObject *__pyx_self, PyObject *__pyx_v_frame); /*proto*/
static char __pyx_doc_3orb_6cutils_66map_me[] = "map_me(ndarray frame)\nCreate a map of the modulation efficiency from a laser frame.\n\n    The more fringes the best are the results.\n\n    :param frame: laser frame.\n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_67map_me = {"map_me", (PyCFunction)__pyx_pw_3orb_6cutils_67map_me, METH_O, __pyx_doc_3orb_6cutils_66map_me};
static PyObject *__pyx_pw_3orb_6cutils_67map_me(PyObject *__pyx_self, PyObject *__pyx_v_frame) {
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("map_me (wrapper)", 0);
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_frame), __pyx_ptype_5numpy_ndarray, 1, "frame", 0))) __PYX_ERR(0, 1901, __pyx_L1_error)
  __pyx_r = __pyx_pf_3orb_6cutils_66map_me(__pyx_self, ((PyArrayObject *)__pyx_v_frame));

  /* function exit code */
  goto __pyx_L0;
  __pyx_L1_error:;
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_66map_me(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_frame) {
  PyArrayObject *__pyx_v_me = 0;
  PyArrayObject *__pyx_v_icol = 0;
  PyArrayObject *__pyx_v_sign = 0;
  PyArrayObject *__pyx_v_diff = 0;
  int __pyx_v_ii;
  int __pyx_v_ij;
  int __pyx_v_imin;
  int __pyx_v_imax;
  double __pyx_v_vmin;
  double __pyx_v_vmax;
  CYTHON_UNUSED long __pyx_v_nans;
  PyObject *__pyx_v_maxs = NULL;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_diff;
  __Pyx_Buffer __pyx_pybuffer_diff;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_frame;
  __Pyx_Buffer __pyx_pybuffer_frame;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_icol;
  __Pyx_Buffer __pyx_pybuffer_icol;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_me;
  __Pyx_Buffer __pyx_pybuffer_me;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_sign;
  __Pyx_Buffer __pyx_pybuffer_sign;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  PyObject *__pyx_t_1 = NULL;
  PyObject *__pyx_t_2 = NULL;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  PyArrayObject *__pyx_t_5 = NULL;
  PyObject *__pyx_t_6 = NULL;
  PyArrayObject *__pyx_t_7 = NULL;
  PyArrayObject *__pyx_t_8 = NULL;
  PyArrayObject *__pyx_t_9 = NULL;
  npy_intp __pyx_t_10;
  int __pyx_t_11;
  int __pyx_t_12;
  PyObject *__pyx_t_13 = NULL;
  PyObject *__pyx_t_14 = NULL;
  PyObject *__pyx_t_15 = NULL;
  PyObject *__pyx_t_16 = NULL;
  PyObject *__pyx_t_17 = NULL;
  long __pyx_t_18;
  int __pyx_t_19;
  long __pyx_t_20;
  double __pyx_t_21;
  int __pyx_t_22;
  __Pyx_RefNannySetupContext("map_me", 0);
  __pyx_pybuffer_me.pybuffer.buf = NULL;
  __pyx_pybuffer_me.refcount = 0;
  __pyx_pybuffernd_me.data = NULL;
  __pyx_pybuffernd_me.rcbuffer = &__pyx_pybuffer_me;
  __pyx_pybuffer_icol.pybuffer.buf = NULL;
  __pyx_pybuffer_icol.refcount = 0;
  __pyx_pybuffernd_icol.data = NULL;
  __pyx_pybuffernd_icol.rcbuffer = &__pyx_pybuffer_icol;
  __pyx_pybuffer_sign.pybuffer.buf = NULL;
  __pyx_pybuffer_sign.refcount = 0;
  __pyx_pybuffernd_sign.data = NULL;
  __pyx_pybuffernd_sign.rcbuffer = &__pyx_pybuffer_sign;
  __pyx_pybuffer_diff.pybuffer.buf = NULL;
  __pyx_pybuffer_diff.refcount = 0;
  __pyx_pybuffernd_diff.data = NULL;
  __pyx_pybuffernd_diff.rcbuffer = &__pyx_pybuffer_diff;
  __pyx_pybuffer_frame.pybuffer.buf = NULL;
  __pyx_pybuffer_frame.refcount = 0;
  __pyx_pybuffernd_frame.data = NULL;
  __pyx_pybuffernd_frame.rcbuffer = &__pyx_pybuffer_frame;
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_frame.rcbuffer->pybuffer, (PyObject*)__pyx_v_frame, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) __PYX_ERR(0, 1901, __pyx_L1_error)
  }
  __pyx_pybuffernd_frame.diminfo[0].strides = __pyx_pybuffernd_frame.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_frame.diminfo[0].shape = __pyx_pybuffernd_frame.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_frame.diminfo[1].strides = __pyx_pybuffernd_frame.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_frame.diminfo[1].shape = __pyx_pybuffernd_frame.rcbuffer->pybuffer.shape[1];

  /* "orb/cutils.pyx":1909
 *     """
 * 
 *     cdef np.ndarray[np.float64_t, ndim=2] me = np.empty_like(frame)             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.float64_t, ndim=1] icol = np.empty(frame.shape[1],
 *                                                           dtype=np.float64)
 */
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1909, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_empty_like); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1909, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_3))) {
    __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_3);
    if (likely(__pyx_t_2)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
      __Pyx_INCREF(__pyx_t_2);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_3, function);
    }
  }
  if (!__pyx_t_2) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_3, ((PyObject *)__pyx_v_frame)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1909, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_4 = PyTuple_New(1+1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1909, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_2); __pyx_t_2 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_frame));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_frame));
    PyTuple_SET_ITEM(__pyx_t_4, 0+1, ((PyObject *)__pyx_v_frame));
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_4, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1909, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  }
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1909, __pyx_L1_error)
  __pyx_t_5 = ((PyArrayObject *)__pyx_t_1);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_me.rcbuffer->pybuffer, (PyObject*)__pyx_t_5, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
      __pyx_v_me = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_me.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 1909, __pyx_L1_error)
    } else {__pyx_pybuffernd_me.diminfo[0].strides = __pyx_pybuffernd_me.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_me.diminfo[0].shape = __pyx_pybuffernd_me.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_me.diminfo[1].strides = __pyx_pybuffernd_me.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_me.diminfo[1].shape = __pyx_pybuffernd_me.rcbuffer->pybuffer.shape[1];
    }
  }
  __pyx_t_5 = 0;
  __pyx_v_me = ((PyArrayObject *)__pyx_t_1);
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1910
 * 
 *     cdef np.ndarray[np.float64_t, ndim=2] me = np.empty_like(frame)
 *     cdef np.ndarray[np.float64_t, ndim=1] icol = np.empty(frame.shape[1],             # <<<<<<<<<<<<<<
 *                                                           dtype=np.float64)
 *     cdef np.ndarray[np.float64_t, ndim=1] sign = np.empty_like(icol)
 */
  __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1910, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_empty); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1910, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_1 = __Pyx_PyInt_From_Py_intptr_t((__pyx_v_frame->dimensions[1])); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1910, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_4 = PyTuple_New(1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1910, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_GIVEREF(__pyx_t_1);
  PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_1);
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1911
 *     cdef np.ndarray[np.float64_t, ndim=2] me = np.empty_like(frame)
 *     cdef np.ndarray[np.float64_t, ndim=1] icol = np.empty(frame.shape[1],
 *                                                           dtype=np.float64)             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.float64_t, ndim=1] sign = np.empty_like(icol)
 *     cdef np.ndarray[np.float64_t, ndim=1] diff = np.empty(frame.shape[1] - 1,
 */
  __pyx_t_1 = PyDict_New(); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1911, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1911, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_float64); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1911, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  if (PyDict_SetItem(__pyx_t_1, __pyx_n_s_dtype, __pyx_t_6) < 0) __PYX_ERR(0, 1911, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;

  /* "orb/cutils.pyx":1910
 * 
 *     cdef np.ndarray[np.float64_t, ndim=2] me = np.empty_like(frame)
 *     cdef np.ndarray[np.float64_t, ndim=1] icol = np.empty(frame.shape[1],             # <<<<<<<<<<<<<<
 *                                                           dtype=np.float64)
 *     cdef np.ndarray[np.float64_t, ndim=1] sign = np.empty_like(icol)
 */
  __pyx_t_6 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_4, __pyx_t_1); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1910, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  if (!(likely(((__pyx_t_6) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_6, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1910, __pyx_L1_error)
  __pyx_t_7 = ((PyArrayObject *)__pyx_t_6);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_icol.rcbuffer->pybuffer, (PyObject*)__pyx_t_7, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
      __pyx_v_icol = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_icol.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 1910, __pyx_L1_error)
    } else {__pyx_pybuffernd_icol.diminfo[0].strides = __pyx_pybuffernd_icol.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_icol.diminfo[0].shape = __pyx_pybuffernd_icol.rcbuffer->pybuffer.shape[0];
    }
  }
  __pyx_t_7 = 0;
  __pyx_v_icol = ((PyArrayObject *)__pyx_t_6);
  __pyx_t_6 = 0;

  /* "orb/cutils.pyx":1912
 *     cdef np.ndarray[np.float64_t, ndim=1] icol = np.empty(frame.shape[1],
 *                                                           dtype=np.float64)
 *     cdef np.ndarray[np.float64_t, ndim=1] sign = np.empty_like(icol)             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.float64_t, ndim=1] diff = np.empty(frame.shape[1] - 1,
 *                                                           dtype=np.float64)
 */
  __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1912, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_empty_like); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1912, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_1 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_4))) {
    __pyx_t_1 = PyMethod_GET_SELF(__pyx_t_4);
    if (likely(__pyx_t_1)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
      __Pyx_INCREF(__pyx_t_1);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_4, function);
    }
  }
  if (!__pyx_t_1) {
    __pyx_t_6 = __Pyx_PyObject_CallOneArg(__pyx_t_4, ((PyObject *)__pyx_v_icol)); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1912, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
  } else {
    __pyx_t_3 = PyTuple_New(1+1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1912, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_GIVEREF(__pyx_t_1); PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_1); __pyx_t_1 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_icol));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_icol));
    PyTuple_SET_ITEM(__pyx_t_3, 0+1, ((PyObject *)__pyx_v_icol));
    __pyx_t_6 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_3, NULL); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1912, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  }
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  if (!(likely(((__pyx_t_6) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_6, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1912, __pyx_L1_error)
  __pyx_t_8 = ((PyArrayObject *)__pyx_t_6);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_sign.rcbuffer->pybuffer, (PyObject*)__pyx_t_8, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
      __pyx_v_sign = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_sign.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 1912, __pyx_L1_error)
    } else {__pyx_pybuffernd_sign.diminfo[0].strides = __pyx_pybuffernd_sign.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_sign.diminfo[0].shape = __pyx_pybuffernd_sign.rcbuffer->pybuffer.shape[0];
    }
  }
  __pyx_t_8 = 0;
  __pyx_v_sign = ((PyArrayObject *)__pyx_t_6);
  __pyx_t_6 = 0;

  /* "orb/cutils.pyx":1913
 *                                                           dtype=np.float64)
 *     cdef np.ndarray[np.float64_t, ndim=1] sign = np.empty_like(icol)
 *     cdef np.ndarray[np.float64_t, ndim=1] diff = np.empty(frame.shape[1] - 1,             # <<<<<<<<<<<<<<
 *                                                           dtype=np.float64)
 * 
 */
  __pyx_t_6 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1913, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_6, __pyx_n_s_empty); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1913, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
  __pyx_t_6 = __Pyx_PyInt_From_long(((__pyx_v_frame->dimensions[1]) - 1)); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1913, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1913, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_GIVEREF(__pyx_t_6);
  PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_6);
  __pyx_t_6 = 0;

  /* "orb/cutils.pyx":1914
 *     cdef np.ndarray[np.float64_t, ndim=1] sign = np.empty_like(icol)
 *     cdef np.ndarray[np.float64_t, ndim=1] diff = np.empty(frame.shape[1] - 1,
 *                                                           dtype=np.float64)             # <<<<<<<<<<<<<<
 * 
 *     cdef int ii, ij, imin, imax
 */
  __pyx_t_6 = PyDict_New(); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1914, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1914, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_float64); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1914, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  if (PyDict_SetItem(__pyx_t_6, __pyx_n_s_dtype, __pyx_t_2) < 0) __PYX_ERR(0, 1914, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;

  /* "orb/cutils.pyx":1913
 *                                                           dtype=np.float64)
 *     cdef np.ndarray[np.float64_t, ndim=1] sign = np.empty_like(icol)
 *     cdef np.ndarray[np.float64_t, ndim=1] diff = np.empty(frame.shape[1] - 1,             # <<<<<<<<<<<<<<
 *                                                           dtype=np.float64)
 * 
 */
  __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_3, __pyx_t_6); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1913, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
  if (!(likely(((__pyx_t_2) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_2, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1913, __pyx_L1_error)
  __pyx_t_9 = ((PyArrayObject *)__pyx_t_2);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_diff.rcbuffer->pybuffer, (PyObject*)__pyx_t_9, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
      __pyx_v_diff = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_diff.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 1913, __pyx_L1_error)
    } else {__pyx_pybuffernd_diff.diminfo[0].strides = __pyx_pybuffernd_diff.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_diff.diminfo[0].shape = __pyx_pybuffernd_diff.rcbuffer->pybuffer.shape[0];
    }
  }
  __pyx_t_9 = 0;
  __pyx_v_diff = ((PyArrayObject *)__pyx_t_2);
  __pyx_t_2 = 0;

  /* "orb/cutils.pyx":1919
 *     cdef double vmin, vmax
 * 
 *     me.fill(np.nan)             # <<<<<<<<<<<<<<
 * 
 *     for ii in range(frame.shape[0]):
 */
  __pyx_t_6 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_me), __pyx_n_s_fill); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1919, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __pyx_t_3 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1919, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_nan); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1919, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_3 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && likely(PyMethod_Check(__pyx_t_6))) {
    __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_6);
    if (likely(__pyx_t_3)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_6);
      __Pyx_INCREF(__pyx_t_3);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_6, function);
    }
  }
  if (!__pyx_t_3) {
    __pyx_t_2 = __Pyx_PyObject_CallOneArg(__pyx_t_6, __pyx_t_4); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1919, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __Pyx_GOTREF(__pyx_t_2);
  } else {
    __pyx_t_1 = PyTuple_New(1+1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1919, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_1, 0, __pyx_t_3); __pyx_t_3 = NULL;
    __Pyx_GIVEREF(__pyx_t_4);
    PyTuple_SET_ITEM(__pyx_t_1, 0+1, __pyx_t_4);
    __pyx_t_4 = 0;
    __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_6, __pyx_t_1, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1919, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  }
  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;

  /* "orb/cutils.pyx":1921
 *     me.fill(np.nan)
 * 
 *     for ii in range(frame.shape[0]):             # <<<<<<<<<<<<<<
 *         icol = frame[ii,:]
 *         sign = np.sign(np.gradient(icol))
 */
  __pyx_t_10 = (__pyx_v_frame->dimensions[0]);
  for (__pyx_t_11 = 0; __pyx_t_11 < __pyx_t_10; __pyx_t_11+=1) {
    __pyx_v_ii = __pyx_t_11;

    /* "orb/cutils.pyx":1922
 * 
 *     for ii in range(frame.shape[0]):
 *         icol = frame[ii,:]             # <<<<<<<<<<<<<<
 *         sign = np.sign(np.gradient(icol))
 *         diff = np.diff(sign)
 */
    __pyx_t_2 = __Pyx_PyInt_From_int(__pyx_v_ii); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1922, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __pyx_t_6 = PyTuple_New(2); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1922, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
    __Pyx_GIVEREF(__pyx_t_2);
    PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_2);
    __Pyx_INCREF(__pyx_slice__142);
    __Pyx_GIVEREF(__pyx_slice__142);
    PyTuple_SET_ITEM(__pyx_t_6, 1, __pyx_slice__142);
    __pyx_t_2 = 0;
    __pyx_t_2 = PyObject_GetItem(((PyObject *)__pyx_v_frame), __pyx_t_6); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1922, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
    if (!(likely(((__pyx_t_2) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_2, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1922, __pyx_L1_error)
    __pyx_t_7 = ((PyArrayObject *)__pyx_t_2);
    {
      __Pyx_BufFmt_StackElem __pyx_stack[1];
      __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_icol.rcbuffer->pybuffer);
      __pyx_t_12 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_icol.rcbuffer->pybuffer, (PyObject*)__pyx_t_7, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack);
      if (unlikely(__pyx_t_12 < 0)) {
        PyErr_Fetch(&__pyx_t_13, &__pyx_t_14, &__pyx_t_15);
        if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_icol.rcbuffer->pybuffer, (PyObject*)__pyx_v_icol, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
          Py_XDECREF(__pyx_t_13); Py_XDECREF(__pyx_t_14); Py_XDECREF(__pyx_t_15);
          __Pyx_RaiseBufferFallbackError();
        } else {
          PyErr_Restore(__pyx_t_13, __pyx_t_14, __pyx_t_15);
        }
      }
      __pyx_pybuffernd_icol.diminfo[0].strides = __pyx_pybuffernd_icol.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_icol.diminfo[0].shape = __pyx_pybuffernd_icol.rcbuffer->pybuffer.shape[0];
      if (unlikely(__pyx_t_12 < 0)) __PYX_ERR(0, 1922, __pyx_L1_error)
    }
    __pyx_t_7 = 0;
    __Pyx_DECREF_SET(__pyx_v_icol, ((PyArrayObject *)__pyx_t_2));
    __pyx_t_2 = 0;

    /* "orb/cutils.pyx":1923
 *     for ii in range(frame.shape[0]):
 *         icol = frame[ii,:]
 *         sign = np.sign(np.gradient(icol))             # <<<<<<<<<<<<<<
 *         diff = np.diff(sign)
 *         nans = diff[np.nonzero(np.isnan(diff))] = 0
 */
    __pyx_t_6 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1923, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
    __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_6, __pyx_n_s_sign); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1923, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
    __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1923, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_gradient); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1923, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_t_4 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_3))) {
      __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_3);
      if (likely(__pyx_t_4)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
        __Pyx_INCREF(__pyx_t_4);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_3, function);
      }
    }
    if (!__pyx_t_4) {
      __pyx_t_6 = __Pyx_PyObject_CallOneArg(__pyx_t_3, ((PyObject *)__pyx_v_icol)); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1923, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_6);
    } else {
      __pyx_t_16 = PyTuple_New(1+1); if (unlikely(!__pyx_t_16)) __PYX_ERR(0, 1923, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_16);
      __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_16, 0, __pyx_t_4); __pyx_t_4 = NULL;
      __Pyx_INCREF(((PyObject *)__pyx_v_icol));
      __Pyx_GIVEREF(((PyObject *)__pyx_v_icol));
      PyTuple_SET_ITEM(__pyx_t_16, 0+1, ((PyObject *)__pyx_v_icol));
      __pyx_t_6 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_16, NULL); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1923, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_6);
      __Pyx_DECREF(__pyx_t_16); __pyx_t_16 = 0;
    }
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __pyx_t_3 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_1))) {
      __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_1);
      if (likely(__pyx_t_3)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_1);
        __Pyx_INCREF(__pyx_t_3);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_1, function);
      }
    }
    if (!__pyx_t_3) {
      __pyx_t_2 = __Pyx_PyObject_CallOneArg(__pyx_t_1, __pyx_t_6); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1923, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
      __Pyx_GOTREF(__pyx_t_2);
    } else {
      __pyx_t_16 = PyTuple_New(1+1); if (unlikely(!__pyx_t_16)) __PYX_ERR(0, 1923, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_16);
      __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_16, 0, __pyx_t_3); __pyx_t_3 = NULL;
      __Pyx_GIVEREF(__pyx_t_6);
      PyTuple_SET_ITEM(__pyx_t_16, 0+1, __pyx_t_6);
      __pyx_t_6 = 0;
      __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_1, __pyx_t_16, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1923, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __Pyx_DECREF(__pyx_t_16); __pyx_t_16 = 0;
    }
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    if (!(likely(((__pyx_t_2) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_2, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1923, __pyx_L1_error)
    __pyx_t_8 = ((PyArrayObject *)__pyx_t_2);
    {
      __Pyx_BufFmt_StackElem __pyx_stack[1];
      __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_sign.rcbuffer->pybuffer);
      __pyx_t_12 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_sign.rcbuffer->pybuffer, (PyObject*)__pyx_t_8, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack);
      if (unlikely(__pyx_t_12 < 0)) {
        PyErr_Fetch(&__pyx_t_15, &__pyx_t_14, &__pyx_t_13);
        if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_sign.rcbuffer->pybuffer, (PyObject*)__pyx_v_sign, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
          Py_XDECREF(__pyx_t_15); Py_XDECREF(__pyx_t_14); Py_XDECREF(__pyx_t_13);
          __Pyx_RaiseBufferFallbackError();
        } else {
          PyErr_Restore(__pyx_t_15, __pyx_t_14, __pyx_t_13);
        }
      }
      __pyx_pybuffernd_sign.diminfo[0].strides = __pyx_pybuffernd_sign.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_sign.diminfo[0].shape = __pyx_pybuffernd_sign.rcbuffer->pybuffer.shape[0];
      if (unlikely(__pyx_t_12 < 0)) __PYX_ERR(0, 1923, __pyx_L1_error)
    }
    __pyx_t_8 = 0;
    __Pyx_DECREF_SET(__pyx_v_sign, ((PyArrayObject *)__pyx_t_2));
    __pyx_t_2 = 0;

    /* "orb/cutils.pyx":1924
 *         icol = frame[ii,:]
 *         sign = np.sign(np.gradient(icol))
 *         diff = np.diff(sign)             # <<<<<<<<<<<<<<
 *         nans = diff[np.nonzero(np.isnan(diff))] = 0
 *         maxs = np.nonzero(np.abs(diff) > 0)[0]
 */
    __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1924, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __pyx_t_16 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_diff); if (unlikely(!__pyx_t_16)) __PYX_ERR(0, 1924, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_16);
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    __pyx_t_1 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_16))) {
      __pyx_t_1 = PyMethod_GET_SELF(__pyx_t_16);
      if (likely(__pyx_t_1)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_16);
        __Pyx_INCREF(__pyx_t_1);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_16, function);
      }
    }
    if (!__pyx_t_1) {
      __pyx_t_2 = __Pyx_PyObject_CallOneArg(__pyx_t_16, ((PyObject *)__pyx_v_sign)); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1924, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
    } else {
      __pyx_t_6 = PyTuple_New(1+1); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1924, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_6);
      __Pyx_GIVEREF(__pyx_t_1); PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_1); __pyx_t_1 = NULL;
      __Pyx_INCREF(((PyObject *)__pyx_v_sign));
      __Pyx_GIVEREF(((PyObject *)__pyx_v_sign));
      PyTuple_SET_ITEM(__pyx_t_6, 0+1, ((PyObject *)__pyx_v_sign));
      __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_16, __pyx_t_6, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1924, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
    }
    __Pyx_DECREF(__pyx_t_16); __pyx_t_16 = 0;
    if (!(likely(((__pyx_t_2) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_2, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1924, __pyx_L1_error)
    __pyx_t_9 = ((PyArrayObject *)__pyx_t_2);
    {
      __Pyx_BufFmt_StackElem __pyx_stack[1];
      __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_diff.rcbuffer->pybuffer);
      __pyx_t_12 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_diff.rcbuffer->pybuffer, (PyObject*)__pyx_t_9, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack);
      if (unlikely(__pyx_t_12 < 0)) {
        PyErr_Fetch(&__pyx_t_13, &__pyx_t_14, &__pyx_t_15);
        if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_diff.rcbuffer->pybuffer, (PyObject*)__pyx_v_diff, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
          Py_XDECREF(__pyx_t_13); Py_XDECREF(__pyx_t_14); Py_XDECREF(__pyx_t_15);
          __Pyx_RaiseBufferFallbackError();
        } else {
          PyErr_Restore(__pyx_t_13, __pyx_t_14, __pyx_t_15);
        }
      }
      __pyx_pybuffernd_diff.diminfo[0].strides = __pyx_pybuffernd_diff.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_diff.diminfo[0].shape = __pyx_pybuffernd_diff.rcbuffer->pybuffer.shape[0];
      if (unlikely(__pyx_t_12 < 0)) __PYX_ERR(0, 1924, __pyx_L1_error)
    }
    __pyx_t_9 = 0;
    __Pyx_DECREF_SET(__pyx_v_diff, ((PyArrayObject *)__pyx_t_2));
    __pyx_t_2 = 0;

    /* "orb/cutils.pyx":1925
 *         sign = np.sign(np.gradient(icol))
 *         diff = np.diff(sign)
 *         nans = diff[np.nonzero(np.isnan(diff))] = 0             # <<<<<<<<<<<<<<
 *         maxs = np.nonzero(np.abs(diff) > 0)[0]
 * 
 */
    __pyx_v_nans = 0;
    __pyx_t_16 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_16)) __PYX_ERR(0, 1925, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_16);
    __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_t_16, __pyx_n_s_nonzero); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1925, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
    __Pyx_DECREF(__pyx_t_16); __pyx_t_16 = 0;
    __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1925, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_isnan); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1925, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    __pyx_t_1 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_3))) {
      __pyx_t_1 = PyMethod_GET_SELF(__pyx_t_3);
      if (likely(__pyx_t_1)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
        __Pyx_INCREF(__pyx_t_1);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_3, function);
      }
    }
    if (!__pyx_t_1) {
      __pyx_t_16 = __Pyx_PyObject_CallOneArg(__pyx_t_3, ((PyObject *)__pyx_v_diff)); if (unlikely(!__pyx_t_16)) __PYX_ERR(0, 1925, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_16);
    } else {
      __pyx_t_4 = PyTuple_New(1+1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1925, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __Pyx_GIVEREF(__pyx_t_1); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_1); __pyx_t_1 = NULL;
      __Pyx_INCREF(((PyObject *)__pyx_v_diff));
      __Pyx_GIVEREF(((PyObject *)__pyx_v_diff));
      PyTuple_SET_ITEM(__pyx_t_4, 0+1, ((PyObject *)__pyx_v_diff));
      __pyx_t_16 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_4, NULL); if (unlikely(!__pyx_t_16)) __PYX_ERR(0, 1925, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_16);
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    }
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __pyx_t_3 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_6))) {
      __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_6);
      if (likely(__pyx_t_3)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_6);
        __Pyx_INCREF(__pyx_t_3);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_6, function);
      }
    }
    if (!__pyx_t_3) {
      __pyx_t_2 = __Pyx_PyObject_CallOneArg(__pyx_t_6, __pyx_t_16); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1925, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_16); __pyx_t_16 = 0;
      __Pyx_GOTREF(__pyx_t_2);
    } else {
      __pyx_t_4 = PyTuple_New(1+1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1925, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_3); __pyx_t_3 = NULL;
      __Pyx_GIVEREF(__pyx_t_16);
      PyTuple_SET_ITEM(__pyx_t_4, 0+1, __pyx_t_16);
      __pyx_t_16 = 0;
      __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_6, __pyx_t_4, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1925, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    }
    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
    if (unlikely(PyObject_SetItem(((PyObject *)__pyx_v_diff), __pyx_t_2, __pyx_int_0) < 0)) __PYX_ERR(0, 1925, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;

    /* "orb/cutils.pyx":1926
 *         diff = np.diff(sign)
 *         nans = diff[np.nonzero(np.isnan(diff))] = 0
 *         maxs = np.nonzero(np.abs(diff) > 0)[0]             # <<<<<<<<<<<<<<
 * 
 *         maxs = np.concatenate([maxs, np.array([frame.shape[1]-1])])
 */
    __pyx_t_6 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1926, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_6, __pyx_n_s_nonzero); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1926, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
    __pyx_t_16 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_16)) __PYX_ERR(0, 1926, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_16);
    __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_16, __pyx_n_s_abs); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1926, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_DECREF(__pyx_t_16); __pyx_t_16 = 0;
    __pyx_t_16 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_3))) {
      __pyx_t_16 = PyMethod_GET_SELF(__pyx_t_3);
      if (likely(__pyx_t_16)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
        __Pyx_INCREF(__pyx_t_16);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_3, function);
      }
    }
    if (!__pyx_t_16) {
      __pyx_t_6 = __Pyx_PyObject_CallOneArg(__pyx_t_3, ((PyObject *)__pyx_v_diff)); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1926, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_6);
    } else {
      __pyx_t_1 = PyTuple_New(1+1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1926, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);
      __Pyx_GIVEREF(__pyx_t_16); PyTuple_SET_ITEM(__pyx_t_1, 0, __pyx_t_16); __pyx_t_16 = NULL;
      __Pyx_INCREF(((PyObject *)__pyx_v_diff));
      __Pyx_GIVEREF(((PyObject *)__pyx_v_diff));
      PyTuple_SET_ITEM(__pyx_t_1, 0+1, ((PyObject *)__pyx_v_diff));
      __pyx_t_6 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_1, NULL); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1926, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_6);
      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    }
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __pyx_t_3 = PyObject_RichCompare(__pyx_t_6, __pyx_int_0, Py_GT); __Pyx_XGOTREF(__pyx_t_3); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1926, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
    __pyx_t_6 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_4))) {
      __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_4);
      if (likely(__pyx_t_6)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
        __Pyx_INCREF(__pyx_t_6);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_4, function);
      }
    }
    if (!__pyx_t_6) {
      __pyx_t_2 = __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_3); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1926, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      __Pyx_GOTREF(__pyx_t_2);
    } else {
      __pyx_t_1 = PyTuple_New(1+1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1926, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);
      __Pyx_GIVEREF(__pyx_t_6); PyTuple_SET_ITEM(__pyx_t_1, 0, __pyx_t_6); __pyx_t_6 = NULL;
      __Pyx_GIVEREF(__pyx_t_3);
      PyTuple_SET_ITEM(__pyx_t_1, 0+1, __pyx_t_3);
      __pyx_t_3 = 0;
      __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_1, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1926, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    }
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_t_4 = __Pyx_GetItemInt(__pyx_t_2, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1926, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __Pyx_XDECREF_SET(__pyx_v_maxs, __pyx_t_4);
    __pyx_t_4 = 0;

    /* "orb/cutils.pyx":1928
 *         maxs = np.nonzero(np.abs(diff) > 0)[0]
 * 
 *         maxs = np.concatenate([maxs, np.array([frame.shape[1]-1])])             # <<<<<<<<<<<<<<
 * 
 *         for ij in range(maxs.shape[0] - 1):
 */
    __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1928, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_concatenate); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1928, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __pyx_t_3 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1928, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_array); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1928, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __pyx_t_3 = __Pyx_PyInt_From_long(((__pyx_v_frame->dimensions[1]) - 1)); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1928, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __pyx_t_16 = PyList_New(1); if (unlikely(!__pyx_t_16)) __PYX_ERR(0, 1928, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_16);
    __Pyx_GIVEREF(__pyx_t_3);
    PyList_SET_ITEM(__pyx_t_16, 0, __pyx_t_3);
    __pyx_t_3 = 0;
    __pyx_t_3 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_6))) {
      __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_6);
      if (likely(__pyx_t_3)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_6);
        __Pyx_INCREF(__pyx_t_3);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_6, function);
      }
    }
    if (!__pyx_t_3) {
      __pyx_t_2 = __Pyx_PyObject_CallOneArg(__pyx_t_6, __pyx_t_16); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1928, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_16); __pyx_t_16 = 0;
      __Pyx_GOTREF(__pyx_t_2);
    } else {
      __pyx_t_17 = PyTuple_New(1+1); if (unlikely(!__pyx_t_17)) __PYX_ERR(0, 1928, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_17);
      __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_17, 0, __pyx_t_3); __pyx_t_3 = NULL;
      __Pyx_GIVEREF(__pyx_t_16);
      PyTuple_SET_ITEM(__pyx_t_17, 0+1, __pyx_t_16);
      __pyx_t_16 = 0;
      __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_6, __pyx_t_17, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1928, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __Pyx_DECREF(__pyx_t_17); __pyx_t_17 = 0;
    }
    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
    __pyx_t_6 = PyList_New(2); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1928, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
    __Pyx_INCREF(__pyx_v_maxs);
    __Pyx_GIVEREF(__pyx_v_maxs);
    PyList_SET_ITEM(__pyx_t_6, 0, __pyx_v_maxs);
    __Pyx_GIVEREF(__pyx_t_2);
    PyList_SET_ITEM(__pyx_t_6, 1, __pyx_t_2);
    __pyx_t_2 = 0;
    __pyx_t_2 = NULL;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_1))) {
      __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_1);
      if (likely(__pyx_t_2)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_1);
        __Pyx_INCREF(__pyx_t_2);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_1, function);
      }
    }
    if (!__pyx_t_2) {
      __pyx_t_4 = __Pyx_PyObject_CallOneArg(__pyx_t_1, __pyx_t_6); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1928, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
      __Pyx_GOTREF(__pyx_t_4);
    } else {
      __pyx_t_17 = PyTuple_New(1+1); if (unlikely(!__pyx_t_17)) __PYX_ERR(0, 1928, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_17);
      __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_17, 0, __pyx_t_2); __pyx_t_2 = NULL;
      __Pyx_GIVEREF(__pyx_t_6);
      PyTuple_SET_ITEM(__pyx_t_17, 0+1, __pyx_t_6);
      __pyx_t_6 = 0;
      __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_1, __pyx_t_17, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1928, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __Pyx_DECREF(__pyx_t_17); __pyx_t_17 = 0;
    }
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    __Pyx_DECREF_SET(__pyx_v_maxs, __pyx_t_4);
    __pyx_t_4 = 0;

    /* "orb/cutils.pyx":1930
 *         maxs = np.concatenate([maxs, np.array([frame.shape[1]-1])])
 * 
 *         for ij in range(maxs.shape[0] - 1):             # <<<<<<<<<<<<<<
 *             imin = maxs[ij]
 *             imax = maxs[ij+1]
 */
    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_v_maxs, __pyx_n_s_shape); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1930, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __pyx_t_1 = __Pyx_GetItemInt(__pyx_t_4, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1930, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_t_4 = __Pyx_PyInt_SubtractObjC(__pyx_t_1, __pyx_int_1, 1, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1930, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    __pyx_t_18 = __Pyx_PyInt_As_long(__pyx_t_4); if (unlikely((__pyx_t_18 == (long)-1) && PyErr_Occurred())) __PYX_ERR(0, 1930, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    for (__pyx_t_12 = 0; __pyx_t_12 < __pyx_t_18; __pyx_t_12+=1) {
      __pyx_v_ij = __pyx_t_12;

      /* "orb/cutils.pyx":1931
 * 
 *         for ij in range(maxs.shape[0] - 1):
 *             imin = maxs[ij]             # <<<<<<<<<<<<<<
 *             imax = maxs[ij+1]
 *             vmin = np.nanmin(icol[imin:imax])
 */
      __pyx_t_4 = __Pyx_GetItemInt(__pyx_v_maxs, __pyx_v_ij, int, 1, __Pyx_PyInt_From_int, 0, 1, 1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1931, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __pyx_t_19 = __Pyx_PyInt_As_int(__pyx_t_4); if (unlikely((__pyx_t_19 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 1931, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __pyx_v_imin = __pyx_t_19;

      /* "orb/cutils.pyx":1932
 *         for ij in range(maxs.shape[0] - 1):
 *             imin = maxs[ij]
 *             imax = maxs[ij+1]             # <<<<<<<<<<<<<<
 *             vmin = np.nanmin(icol[imin:imax])
 *             vmax = np.nanmax(icol[imin:imax])
 */
      __pyx_t_20 = (__pyx_v_ij + 1);
      __pyx_t_4 = __Pyx_GetItemInt(__pyx_v_maxs, __pyx_t_20, long, 1, __Pyx_PyInt_From_long, 0, 1, 1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1932, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __pyx_t_19 = __Pyx_PyInt_As_int(__pyx_t_4); if (unlikely((__pyx_t_19 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 1932, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __pyx_v_imax = __pyx_t_19;

      /* "orb/cutils.pyx":1933
 *             imin = maxs[ij]
 *             imax = maxs[ij+1]
 *             vmin = np.nanmin(icol[imin:imax])             # <<<<<<<<<<<<<<
 *             vmax = np.nanmax(icol[imin:imax])
 *             if vmax != 0.:
 */
      __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1933, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);
      __pyx_t_17 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_nanmin); if (unlikely(!__pyx_t_17)) __PYX_ERR(0, 1933, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_17);
      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
      __pyx_t_1 = __Pyx_PyObject_GetSlice(((PyObject *)__pyx_v_icol), __pyx_v_imin, __pyx_v_imax, NULL, NULL, NULL, 1, 1, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1933, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);
      __pyx_t_6 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_17))) {
        __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_17);
        if (likely(__pyx_t_6)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_17);
          __Pyx_INCREF(__pyx_t_6);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_17, function);
        }
      }
      if (!__pyx_t_6) {
        __pyx_t_4 = __Pyx_PyObject_CallOneArg(__pyx_t_17, __pyx_t_1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1933, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
        __Pyx_GOTREF(__pyx_t_4);
      } else {
        __pyx_t_2 = PyTuple_New(1+1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1933, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_2);
        __Pyx_GIVEREF(__pyx_t_6); PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_6); __pyx_t_6 = NULL;
        __Pyx_GIVEREF(__pyx_t_1);
        PyTuple_SET_ITEM(__pyx_t_2, 0+1, __pyx_t_1);
        __pyx_t_1 = 0;
        __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_17, __pyx_t_2, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1933, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_4);
        __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
      }
      __Pyx_DECREF(__pyx_t_17); __pyx_t_17 = 0;
      __pyx_t_21 = __pyx_PyFloat_AsDouble(__pyx_t_4); if (unlikely((__pyx_t_21 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 1933, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __pyx_v_vmin = __pyx_t_21;

      /* "orb/cutils.pyx":1934
 *             imax = maxs[ij+1]
 *             vmin = np.nanmin(icol[imin:imax])
 *             vmax = np.nanmax(icol[imin:imax])             # <<<<<<<<<<<<<<
 *             if vmax != 0.:
 *                 me[ii, imin:imax] = (vmax-vmin)/vmax
 */
      __pyx_t_17 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_17)) __PYX_ERR(0, 1934, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_17);
      __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_17, __pyx_n_s_nanmax); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1934, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __Pyx_DECREF(__pyx_t_17); __pyx_t_17 = 0;
      __pyx_t_17 = __Pyx_PyObject_GetSlice(((PyObject *)__pyx_v_icol), __pyx_v_imin, __pyx_v_imax, NULL, NULL, NULL, 1, 1, 1); if (unlikely(!__pyx_t_17)) __PYX_ERR(0, 1934, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_17);
      __pyx_t_1 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_2))) {
        __pyx_t_1 = PyMethod_GET_SELF(__pyx_t_2);
        if (likely(__pyx_t_1)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
          __Pyx_INCREF(__pyx_t_1);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_2, function);
        }
      }
      if (!__pyx_t_1) {
        __pyx_t_4 = __Pyx_PyObject_CallOneArg(__pyx_t_2, __pyx_t_17); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1934, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_17); __pyx_t_17 = 0;
        __Pyx_GOTREF(__pyx_t_4);
      } else {
        __pyx_t_6 = PyTuple_New(1+1); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1934, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_6);
        __Pyx_GIVEREF(__pyx_t_1); PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_1); __pyx_t_1 = NULL;
        __Pyx_GIVEREF(__pyx_t_17);
        PyTuple_SET_ITEM(__pyx_t_6, 0+1, __pyx_t_17);
        __pyx_t_17 = 0;
        __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_6, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1934, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_4);
        __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
      }
      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
      __pyx_t_21 = __pyx_PyFloat_AsDouble(__pyx_t_4); if (unlikely((__pyx_t_21 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 1934, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __pyx_v_vmax = __pyx_t_21;

      /* "orb/cutils.pyx":1935
 *             vmin = np.nanmin(icol[imin:imax])
 *             vmax = np.nanmax(icol[imin:imax])
 *             if vmax != 0.:             # <<<<<<<<<<<<<<
 *                 me[ii, imin:imax] = (vmax-vmin)/vmax
 * 
 */
      __pyx_t_22 = ((__pyx_v_vmax != 0.) != 0);
      if (__pyx_t_22) {

        /* "orb/cutils.pyx":1936
 *             vmax = np.nanmax(icol[imin:imax])
 *             if vmax != 0.:
 *                 me[ii, imin:imax] = (vmax-vmin)/vmax             # <<<<<<<<<<<<<<
 * 
 *     return me
 */
        __pyx_t_21 = (__pyx_v_vmax - __pyx_v_vmin);
        if (unlikely(__pyx_v_vmax == 0)) {
          PyErr_SetString(PyExc_ZeroDivisionError, "float division");
          __PYX_ERR(0, 1936, __pyx_L1_error)
        }
        __pyx_t_4 = PyFloat_FromDouble((__pyx_t_21 / __pyx_v_vmax)); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1936, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_4);
        __pyx_t_2 = __Pyx_PyInt_From_int(__pyx_v_ii); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1936, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_2);
        __pyx_t_6 = __Pyx_PyInt_From_int(__pyx_v_imin); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 1936, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_6);
        __pyx_t_17 = __Pyx_PyInt_From_int(__pyx_v_imax); if (unlikely(!__pyx_t_17)) __PYX_ERR(0, 1936, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_17);
        __pyx_t_1 = PySlice_New(__pyx_t_6, __pyx_t_17, Py_None); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1936, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_1);
        __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
        __Pyx_DECREF(__pyx_t_17); __pyx_t_17 = 0;
        __pyx_t_17 = PyTuple_New(2); if (unlikely(!__pyx_t_17)) __PYX_ERR(0, 1936, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_17);
        __Pyx_GIVEREF(__pyx_t_2);
        PyTuple_SET_ITEM(__pyx_t_17, 0, __pyx_t_2);
        __Pyx_GIVEREF(__pyx_t_1);
        PyTuple_SET_ITEM(__pyx_t_17, 1, __pyx_t_1);
        __pyx_t_2 = 0;
        __pyx_t_1 = 0;
        if (unlikely(PyObject_SetItem(((PyObject *)__pyx_v_me), __pyx_t_17, __pyx_t_4) < 0)) __PYX_ERR(0, 1936, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_17); __pyx_t_17 = 0;
        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;

        /* "orb/cutils.pyx":1935
 *             vmin = np.nanmin(icol[imin:imax])
 *             vmax = np.nanmax(icol[imin:imax])
 *             if vmax != 0.:             # <<<<<<<<<<<<<<
 *                 me[ii, imin:imax] = (vmax-vmin)/vmax
 * 
 */
      }
    }
  }

  /* "orb/cutils.pyx":1938
 *                 me[ii, imin:imax] = (vmax-vmin)/vmax
 * 
 *     return me             # <<<<<<<<<<<<<<
 * 
 * 
 */
  __Pyx_XDECREF(__pyx_r);
  __Pyx_INCREF(((PyObject *)__pyx_v_me));
  __pyx_r = ((PyObject *)__pyx_v_me);
  goto __pyx_L0;

  /* "orb/cutils.pyx":1901
 * 
 * 
 * def map_me(np.ndarray[np.float64_t, ndim=2] frame):             # <<<<<<<<<<<<<<
 *     """Create a map of the modulation efficiency from a laser frame.
 * 
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_1);
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_XDECREF(__pyx_t_6);
  __Pyx_XDECREF(__pyx_t_16);
  __Pyx_XDECREF(__pyx_t_17);
  { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
    __Pyx_PyThreadState_declare
    __Pyx_PyThreadState_assign
    __Pyx_ErrFetch(&__pyx_type, &__pyx_value, &__pyx_tb);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_diff.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_frame.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_icol.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_me.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_sign.rcbuffer->pybuffer);
  __Pyx_ErrRestore(__pyx_type, __pyx_value, __pyx_tb);}
  __Pyx_AddTraceback("orb.cutils.map_me", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  goto __pyx_L2;
  __pyx_L0:;
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_diff.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_frame.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_icol.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_me.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_sign.rcbuffer->pybuffer);
  __pyx_L2:;
  __Pyx_XDECREF((PyObject *)__pyx_v_me);
  __Pyx_XDECREF((PyObject *)__pyx_v_icol);
  __Pyx_XDECREF((PyObject *)__pyx_v_sign);
  __Pyx_XDECREF((PyObject *)__pyx_v_diff);
  __Pyx_XDECREF(__pyx_v_maxs);
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":1942
 * 
 * 
 * def nanbin_image(np.ndarray[np.float64_t, ndim=2] im, int binning):             # <<<<<<<<<<<<<<
 *     """Mean image binning robust to NaNs.
 * 
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_69nanbin_image(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_3orb_6cutils_68nanbin_image[] = "nanbin_image(ndarray im, int binning)\nMean image binning robust to NaNs.\n\n    :param im: Image to bin\n    :param binning: Binning factor (must be an integer)\n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_69nanbin_image = {"nanbin_image", (PyCFunction)__pyx_pw_3orb_6cutils_69nanbin_image, METH_VARARGS|METH_KEYWORDS, __pyx_doc_3orb_6cutils_68nanbin_image};
static PyObject *__pyx_pw_3orb_6cutils_69nanbin_image(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  PyArrayObject *__pyx_v_im = 0;
  int __pyx_v_binning;
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("nanbin_image (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_im,&__pyx_n_s_binning,0};
    PyObject* values[2] = {0,0};
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
      switch (pos_args) {
        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = PyDict_Size(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_im)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        case  1:
        if (likely((values[1] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_binning)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("nanbin_image", 1, 2, 2, 1); __PYX_ERR(0, 1942, __pyx_L3_error)
        }
      }
      if (unlikely(kw_args > 0)) {
        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "nanbin_image") < 0)) __PYX_ERR(0, 1942, __pyx_L3_error)
      }
    } else if (PyTuple_GET_SIZE(__pyx_args) != 2) {
      goto __pyx_L5_argtuple_error;
    } else {
      values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
      values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
    }
    __pyx_v_im = ((PyArrayObject *)values[0]);
    __pyx_v_binning = __Pyx_PyInt_As_int(values[1]); if (unlikely((__pyx_v_binning == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 1942, __pyx_L3_error)
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  __Pyx_RaiseArgtupleInvalid("nanbin_image", 1, 2, 2, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 1942, __pyx_L3_error)
  __pyx_L3_error:;
  __Pyx_AddTraceback("orb.cutils.nanbin_image", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __Pyx_RefNannyFinishContext();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_im), __pyx_ptype_5numpy_ndarray, 1, "im", 0))) __PYX_ERR(0, 1942, __pyx_L1_error)
  __pyx_r = __pyx_pf_3orb_6cutils_68nanbin_image(__pyx_self, __pyx_v_im, __pyx_v_binning);

  /* function exit code */
  goto __pyx_L0;
  __pyx_L1_error:;
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_68nanbin_image(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_im, int __pyx_v_binning) {
  PyArrayObject *__pyx_v_out = 0;
  PyArrayObject *__pyx_v_x_range = 0;
  PyArrayObject *__pyx_v_y_range = 0;
  int __pyx_v_ii;
  int __pyx_v_ij;
  int __pyx_v_xmin;
  int __pyx_v_xmax;
  int __pyx_v_ymin;
  int __pyx_v_ymax;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_im;
  __Pyx_Buffer __pyx_pybuffer_im;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_out;
  __Pyx_Buffer __pyx_pybuffer_out;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_x_range;
  __Pyx_Buffer __pyx_pybuffer_x_range;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_y_range;
  __Pyx_Buffer __pyx_pybuffer_y_range;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  PyObject *__pyx_t_1 = NULL;
  PyObject *__pyx_t_2 = NULL;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  PyObject *__pyx_t_5 = NULL;
  Py_ssize_t __pyx_t_6;
  PyObject *__pyx_t_7 = NULL;
  PyArrayObject *__pyx_t_8 = NULL;
  int __pyx_t_9;
  PyObject *__pyx_t_10 = NULL;
  PyObject *__pyx_t_11 = NULL;
  PyObject *__pyx_t_12 = NULL;
  PyArrayObject *__pyx_t_13 = NULL;
  PyArrayObject *__pyx_t_14 = NULL;
  npy_intp __pyx_t_15;
  npy_intp __pyx_t_16;
  int __pyx_t_17;
  Py_ssize_t __pyx_t_18;
  int __pyx_t_19;
  int __pyx_t_20;
  Py_ssize_t __pyx_t_21;
  __pyx_t_5numpy_float64_t __pyx_t_22;
  Py_ssize_t __pyx_t_23;
  Py_ssize_t __pyx_t_24;
  __Pyx_RefNannySetupContext("nanbin_image", 0);
  __pyx_pybuffer_out.pybuffer.buf = NULL;
  __pyx_pybuffer_out.refcount = 0;
  __pyx_pybuffernd_out.data = NULL;
  __pyx_pybuffernd_out.rcbuffer = &__pyx_pybuffer_out;
  __pyx_pybuffer_x_range.pybuffer.buf = NULL;
  __pyx_pybuffer_x_range.refcount = 0;
  __pyx_pybuffernd_x_range.data = NULL;
  __pyx_pybuffernd_x_range.rcbuffer = &__pyx_pybuffer_x_range;
  __pyx_pybuffer_y_range.pybuffer.buf = NULL;
  __pyx_pybuffer_y_range.refcount = 0;
  __pyx_pybuffernd_y_range.data = NULL;
  __pyx_pybuffernd_y_range.rcbuffer = &__pyx_pybuffer_y_range;
  __pyx_pybuffer_im.pybuffer.buf = NULL;
  __pyx_pybuffer_im.refcount = 0;
  __pyx_pybuffernd_im.data = NULL;
  __pyx_pybuffernd_im.rcbuffer = &__pyx_pybuffer_im;
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_im.rcbuffer->pybuffer, (PyObject*)__pyx_v_im, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) __PYX_ERR(0, 1942, __pyx_L1_error)
  }
  __pyx_pybuffernd_im.diminfo[0].strides = __pyx_pybuffernd_im.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_im.diminfo[0].shape = __pyx_pybuffernd_im.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_im.diminfo[1].strides = __pyx_pybuffernd_im.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_im.diminfo[1].shape = __pyx_pybuffernd_im.rcbuffer->pybuffer.shape[1];

  /* "orb/cutils.pyx":1953
 *     cdef int ii, ij, xmin, xmax, ymin, ymax
 * 
 *     x_range = np.arange(0, im.shape[0]/binning*binning, binning)             # <<<<<<<<<<<<<<
 *     y_range = np.arange(0, im.shape[1]/binning*binning, binning)
 *     out = np.empty((x_range.shape[0], y_range.shape[0]), dtype=im.dtype)
 */
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1953, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_arange); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1953, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  if (unlikely(__pyx_v_binning == 0)) {
    PyErr_SetString(PyExc_ZeroDivisionError, "integer division or modulo by zero");
    __PYX_ERR(0, 1953, __pyx_L1_error)
  }
  else if (sizeof(npy_intp) == sizeof(long) && (!(((int)-1) > 0)) && unlikely(__pyx_v_binning == (int)-1)  && unlikely(UNARY_NEG_WOULD_OVERFLOW((__pyx_v_im->dimensions[0])))) {
    PyErr_SetString(PyExc_OverflowError, "value too large to perform division");
    __PYX_ERR(0, 1953, __pyx_L1_error)
  }
  __pyx_t_2 = __Pyx_PyInt_From_Py_intptr_t((__Pyx_div_npy_intp((__pyx_v_im->dimensions[0]), __pyx_v_binning) * __pyx_v_binning)); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1953, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_4 = __Pyx_PyInt_From_int(__pyx_v_binning); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1953, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_5 = NULL;
  __pyx_t_6 = 0;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_3))) {
    __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_3);
    if (likely(__pyx_t_5)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
      __Pyx_INCREF(__pyx_t_5);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_3, function);
      __pyx_t_6 = 1;
    }
  }
  __pyx_t_7 = PyTuple_New(3+__pyx_t_6); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 1953, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_7);
  if (__pyx_t_5) {
    __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_7, 0, __pyx_t_5); __pyx_t_5 = NULL;
  }
  __Pyx_INCREF(__pyx_int_0);
  __Pyx_GIVEREF(__pyx_int_0);
  PyTuple_SET_ITEM(__pyx_t_7, 0+__pyx_t_6, __pyx_int_0);
  __Pyx_GIVEREF(__pyx_t_2);
  PyTuple_SET_ITEM(__pyx_t_7, 1+__pyx_t_6, __pyx_t_2);
  __Pyx_GIVEREF(__pyx_t_4);
  PyTuple_SET_ITEM(__pyx_t_7, 2+__pyx_t_6, __pyx_t_4);
  __pyx_t_2 = 0;
  __pyx_t_4 = 0;
  __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_7, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1953, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1953, __pyx_L1_error)
  __pyx_t_8 = ((PyArrayObject *)__pyx_t_1);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_x_range.rcbuffer->pybuffer);
    __pyx_t_9 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_x_range.rcbuffer->pybuffer, (PyObject*)__pyx_t_8, &__Pyx_TypeInfo_nn___pyx_t_5numpy_int64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack);
    if (unlikely(__pyx_t_9 < 0)) {
      PyErr_Fetch(&__pyx_t_10, &__pyx_t_11, &__pyx_t_12);
      if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_x_range.rcbuffer->pybuffer, (PyObject*)__pyx_v_x_range, &__Pyx_TypeInfo_nn___pyx_t_5numpy_int64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_10); Py_XDECREF(__pyx_t_11); Py_XDECREF(__pyx_t_12);
        __Pyx_RaiseBufferFallbackError();
      } else {
        PyErr_Restore(__pyx_t_10, __pyx_t_11, __pyx_t_12);
      }
    }
    __pyx_pybuffernd_x_range.diminfo[0].strides = __pyx_pybuffernd_x_range.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_x_range.diminfo[0].shape = __pyx_pybuffernd_x_range.rcbuffer->pybuffer.shape[0];
    if (unlikely(__pyx_t_9 < 0)) __PYX_ERR(0, 1953, __pyx_L1_error)
  }
  __pyx_t_8 = 0;
  __pyx_v_x_range = ((PyArrayObject *)__pyx_t_1);
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1954
 * 
 *     x_range = np.arange(0, im.shape[0]/binning*binning, binning)
 *     y_range = np.arange(0, im.shape[1]/binning*binning, binning)             # <<<<<<<<<<<<<<
 *     out = np.empty((x_range.shape[0], y_range.shape[0]), dtype=im.dtype)
 * 
 */
  __pyx_t_3 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1954, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_7 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_arange); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 1954, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_7);
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  if (unlikely(__pyx_v_binning == 0)) {
    PyErr_SetString(PyExc_ZeroDivisionError, "integer division or modulo by zero");
    __PYX_ERR(0, 1954, __pyx_L1_error)
  }
  else if (sizeof(npy_intp) == sizeof(long) && (!(((int)-1) > 0)) && unlikely(__pyx_v_binning == (int)-1)  && unlikely(UNARY_NEG_WOULD_OVERFLOW((__pyx_v_im->dimensions[1])))) {
    PyErr_SetString(PyExc_OverflowError, "value too large to perform division");
    __PYX_ERR(0, 1954, __pyx_L1_error)
  }
  __pyx_t_3 = __Pyx_PyInt_From_Py_intptr_t((__Pyx_div_npy_intp((__pyx_v_im->dimensions[1]), __pyx_v_binning) * __pyx_v_binning)); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1954, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_4 = __Pyx_PyInt_From_int(__pyx_v_binning); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1954, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_2 = NULL;
  __pyx_t_6 = 0;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_7))) {
    __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_7);
    if (likely(__pyx_t_2)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_7);
      __Pyx_INCREF(__pyx_t_2);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_7, function);
      __pyx_t_6 = 1;
    }
  }
  __pyx_t_5 = PyTuple_New(3+__pyx_t_6); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1954, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  if (__pyx_t_2) {
    __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_2); __pyx_t_2 = NULL;
  }
  __Pyx_INCREF(__pyx_int_0);
  __Pyx_GIVEREF(__pyx_int_0);
  PyTuple_SET_ITEM(__pyx_t_5, 0+__pyx_t_6, __pyx_int_0);
  __Pyx_GIVEREF(__pyx_t_3);
  PyTuple_SET_ITEM(__pyx_t_5, 1+__pyx_t_6, __pyx_t_3);
  __Pyx_GIVEREF(__pyx_t_4);
  PyTuple_SET_ITEM(__pyx_t_5, 2+__pyx_t_6, __pyx_t_4);
  __pyx_t_3 = 0;
  __pyx_t_4 = 0;
  __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_7, __pyx_t_5, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1954, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1954, __pyx_L1_error)
  __pyx_t_13 = ((PyArrayObject *)__pyx_t_1);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_y_range.rcbuffer->pybuffer);
    __pyx_t_9 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_y_range.rcbuffer->pybuffer, (PyObject*)__pyx_t_13, &__Pyx_TypeInfo_nn___pyx_t_5numpy_int64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack);
    if (unlikely(__pyx_t_9 < 0)) {
      PyErr_Fetch(&__pyx_t_12, &__pyx_t_11, &__pyx_t_10);
      if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_y_range.rcbuffer->pybuffer, (PyObject*)__pyx_v_y_range, &__Pyx_TypeInfo_nn___pyx_t_5numpy_int64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_12); Py_XDECREF(__pyx_t_11); Py_XDECREF(__pyx_t_10);
        __Pyx_RaiseBufferFallbackError();
      } else {
        PyErr_Restore(__pyx_t_12, __pyx_t_11, __pyx_t_10);
      }
    }
    __pyx_pybuffernd_y_range.diminfo[0].strides = __pyx_pybuffernd_y_range.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_y_range.diminfo[0].shape = __pyx_pybuffernd_y_range.rcbuffer->pybuffer.shape[0];
    if (unlikely(__pyx_t_9 < 0)) __PYX_ERR(0, 1954, __pyx_L1_error)
  }
  __pyx_t_13 = 0;
  __pyx_v_y_range = ((PyArrayObject *)__pyx_t_1);
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1955
 *     x_range = np.arange(0, im.shape[0]/binning*binning, binning)
 *     y_range = np.arange(0, im.shape[1]/binning*binning, binning)
 *     out = np.empty((x_range.shape[0], y_range.shape[0]), dtype=im.dtype)             # <<<<<<<<<<<<<<
 * 
 *     for ii in range(x_range.shape[0]):
 */
  __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1955, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_7 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_empty); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 1955, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_7);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_1 = __Pyx_PyInt_From_Py_intptr_t((__pyx_v_x_range->dimensions[0])); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1955, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_5 = __Pyx_PyInt_From_Py_intptr_t((__pyx_v_y_range->dimensions[0])); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1955, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_4 = PyTuple_New(2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1955, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_GIVEREF(__pyx_t_1);
  PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_1);
  __Pyx_GIVEREF(__pyx_t_5);
  PyTuple_SET_ITEM(__pyx_t_4, 1, __pyx_t_5);
  __pyx_t_1 = 0;
  __pyx_t_5 = 0;
  __pyx_t_5 = PyTuple_New(1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1955, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_GIVEREF(__pyx_t_4);
  PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_4);
  __pyx_t_4 = 0;
  __pyx_t_4 = PyDict_New(); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1955, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_im), __pyx_n_s_dtype); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1955, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if (PyDict_SetItem(__pyx_t_4, __pyx_n_s_dtype, __pyx_t_1) < 0) __PYX_ERR(0, 1955, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_7, __pyx_t_5, __pyx_t_4); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1955, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1955, __pyx_L1_error)
  __pyx_t_14 = ((PyArrayObject *)__pyx_t_1);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_out.rcbuffer->pybuffer);
    __pyx_t_9 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_out.rcbuffer->pybuffer, (PyObject*)__pyx_t_14, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 2, 0, __pyx_stack);
    if (unlikely(__pyx_t_9 < 0)) {
      PyErr_Fetch(&__pyx_t_10, &__pyx_t_11, &__pyx_t_12);
      if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_out.rcbuffer->pybuffer, (PyObject*)__pyx_v_out, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 2, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_10); Py_XDECREF(__pyx_t_11); Py_XDECREF(__pyx_t_12);
        __Pyx_RaiseBufferFallbackError();
      } else {
        PyErr_Restore(__pyx_t_10, __pyx_t_11, __pyx_t_12);
      }
    }
    __pyx_pybuffernd_out.diminfo[0].strides = __pyx_pybuffernd_out.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_out.diminfo[0].shape = __pyx_pybuffernd_out.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_out.diminfo[1].strides = __pyx_pybuffernd_out.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_out.diminfo[1].shape = __pyx_pybuffernd_out.rcbuffer->pybuffer.shape[1];
    if (unlikely(__pyx_t_9 < 0)) __PYX_ERR(0, 1955, __pyx_L1_error)
  }
  __pyx_t_14 = 0;
  __pyx_v_out = ((PyArrayObject *)__pyx_t_1);
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1957
 *     out = np.empty((x_range.shape[0], y_range.shape[0]), dtype=im.dtype)
 * 
 *     for ii in range(x_range.shape[0]):             # <<<<<<<<<<<<<<
 *         for ij in range(y_range.shape[0]):
 *             xmin = x_range[ii]
 */
  __pyx_t_15 = (__pyx_v_x_range->dimensions[0]);
  for (__pyx_t_9 = 0; __pyx_t_9 < __pyx_t_15; __pyx_t_9+=1) {
    __pyx_v_ii = __pyx_t_9;

    /* "orb/cutils.pyx":1958
 * 
 *     for ii in range(x_range.shape[0]):
 *         for ij in range(y_range.shape[0]):             # <<<<<<<<<<<<<<
 *             xmin = x_range[ii]
 *             xmax = xmin + binning
 */
    __pyx_t_16 = (__pyx_v_y_range->dimensions[0]);
    for (__pyx_t_17 = 0; __pyx_t_17 < __pyx_t_16; __pyx_t_17+=1) {
      __pyx_v_ij = __pyx_t_17;

      /* "orb/cutils.pyx":1959
 *     for ii in range(x_range.shape[0]):
 *         for ij in range(y_range.shape[0]):
 *             xmin = x_range[ii]             # <<<<<<<<<<<<<<
 *             xmax = xmin + binning
 *             if xmax > im.shape[0]: xmax=im.shape[0]
 */
      __pyx_t_18 = __pyx_v_ii;
      __pyx_t_19 = -1;
      if (__pyx_t_18 < 0) {
        __pyx_t_18 += __pyx_pybuffernd_x_range.diminfo[0].shape;
        if (unlikely(__pyx_t_18 < 0)) __pyx_t_19 = 0;
      } else if (unlikely(__pyx_t_18 >= __pyx_pybuffernd_x_range.diminfo[0].shape)) __pyx_t_19 = 0;
      if (unlikely(__pyx_t_19 != -1)) {
        __Pyx_RaiseBufferIndexError(__pyx_t_19);
        __PYX_ERR(0, 1959, __pyx_L1_error)
      }
      __pyx_v_xmin = (*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_int64_t *, __pyx_pybuffernd_x_range.rcbuffer->pybuffer.buf, __pyx_t_18, __pyx_pybuffernd_x_range.diminfo[0].strides));

      /* "orb/cutils.pyx":1960
 *         for ij in range(y_range.shape[0]):
 *             xmin = x_range[ii]
 *             xmax = xmin + binning             # <<<<<<<<<<<<<<
 *             if xmax > im.shape[0]: xmax=im.shape[0]
 *             ymin = y_range[ij]
 */
      __pyx_v_xmax = (__pyx_v_xmin + __pyx_v_binning);

      /* "orb/cutils.pyx":1961
 *             xmin = x_range[ii]
 *             xmax = xmin + binning
 *             if xmax > im.shape[0]: xmax=im.shape[0]             # <<<<<<<<<<<<<<
 *             ymin = y_range[ij]
 *             ymax = ymin + binning
 */
      __pyx_t_20 = ((__pyx_v_xmax > (__pyx_v_im->dimensions[0])) != 0);
      if (__pyx_t_20) {
        __pyx_v_xmax = (__pyx_v_im->dimensions[0]);
      }

      /* "orb/cutils.pyx":1962
 *             xmax = xmin + binning
 *             if xmax > im.shape[0]: xmax=im.shape[0]
 *             ymin = y_range[ij]             # <<<<<<<<<<<<<<
 *             ymax = ymin + binning
 *             if ymax > im.shape[1]: ymax=im.shape[1]
 */
      __pyx_t_21 = __pyx_v_ij;
      __pyx_t_19 = -1;
      if (__pyx_t_21 < 0) {
        __pyx_t_21 += __pyx_pybuffernd_y_range.diminfo[0].shape;
        if (unlikely(__pyx_t_21 < 0)) __pyx_t_19 = 0;
      } else if (unlikely(__pyx_t_21 >= __pyx_pybuffernd_y_range.diminfo[0].shape)) __pyx_t_19 = 0;
      if (unlikely(__pyx_t_19 != -1)) {
        __Pyx_RaiseBufferIndexError(__pyx_t_19);
        __PYX_ERR(0, 1962, __pyx_L1_error)
      }
      __pyx_v_ymin = (*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_int64_t *, __pyx_pybuffernd_y_range.rcbuffer->pybuffer.buf, __pyx_t_21, __pyx_pybuffernd_y_range.diminfo[0].strides));

      /* "orb/cutils.pyx":1963
 *             if xmax > im.shape[0]: xmax=im.shape[0]
 *             ymin = y_range[ij]
 *             ymax = ymin + binning             # <<<<<<<<<<<<<<
 *             if ymax > im.shape[1]: ymax=im.shape[1]
 * 
 */
      __pyx_v_ymax = (__pyx_v_ymin + __pyx_v_binning);

      /* "orb/cutils.pyx":1964
 *             ymin = y_range[ij]
 *             ymax = ymin + binning
 *             if ymax > im.shape[1]: ymax=im.shape[1]             # <<<<<<<<<<<<<<
 * 
 *             out[ii,ij] = bn.nanmean(im[xmin:xmax,ymin:ymax])
 */
      __pyx_t_20 = ((__pyx_v_ymax > (__pyx_v_im->dimensions[1])) != 0);
      if (__pyx_t_20) {
        __pyx_v_ymax = (__pyx_v_im->dimensions[1]);
      }

      /* "orb/cutils.pyx":1966
 *             if ymax > im.shape[1]: ymax=im.shape[1]
 * 
 *             out[ii,ij] = bn.nanmean(im[xmin:xmax,ymin:ymax])             # <<<<<<<<<<<<<<
 * 
 *     return out
 */
      __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1966, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_nanmean); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1966, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_5);
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __pyx_t_4 = __Pyx_PyInt_From_int(__pyx_v_xmin); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1966, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __pyx_t_7 = __Pyx_PyInt_From_int(__pyx_v_xmax); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 1966, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_7);
      __pyx_t_3 = PySlice_New(__pyx_t_4, __pyx_t_7, Py_None); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1966, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
      __pyx_t_7 = __Pyx_PyInt_From_int(__pyx_v_ymin); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 1966, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_7);
      __pyx_t_4 = __Pyx_PyInt_From_int(__pyx_v_ymax); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1966, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __pyx_t_2 = PySlice_New(__pyx_t_7, __pyx_t_4, Py_None); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1966, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __pyx_t_4 = PyTuple_New(2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1966, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __Pyx_GIVEREF(__pyx_t_3);
      PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_3);
      __Pyx_GIVEREF(__pyx_t_2);
      PyTuple_SET_ITEM(__pyx_t_4, 1, __pyx_t_2);
      __pyx_t_3 = 0;
      __pyx_t_2 = 0;
      __pyx_t_2 = PyObject_GetItem(((PyObject *)__pyx_v_im), __pyx_t_4); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1966, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __pyx_t_4 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_5))) {
        __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_5);
        if (likely(__pyx_t_4)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_5);
          __Pyx_INCREF(__pyx_t_4);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_5, function);
        }
      }
      if (!__pyx_t_4) {
        __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_5, __pyx_t_2); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1966, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
        __Pyx_GOTREF(__pyx_t_1);
      } else {
        __pyx_t_3 = PyTuple_New(1+1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1966, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_3);
        __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_4); __pyx_t_4 = NULL;
        __Pyx_GIVEREF(__pyx_t_2);
        PyTuple_SET_ITEM(__pyx_t_3, 0+1, __pyx_t_2);
        __pyx_t_2 = 0;
        __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_3, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1966, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_1);
        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      }
      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
      __pyx_t_22 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_22 == (npy_float64)-1) && PyErr_Occurred())) __PYX_ERR(0, 1966, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
      __pyx_t_23 = __pyx_v_ii;
      __pyx_t_24 = __pyx_v_ij;
      __pyx_t_19 = -1;
      if (__pyx_t_23 < 0) {
        __pyx_t_23 += __pyx_pybuffernd_out.diminfo[0].shape;
        if (unlikely(__pyx_t_23 < 0)) __pyx_t_19 = 0;
      } else if (unlikely(__pyx_t_23 >= __pyx_pybuffernd_out.diminfo[0].shape)) __pyx_t_19 = 0;
      if (__pyx_t_24 < 0) {
        __pyx_t_24 += __pyx_pybuffernd_out.diminfo[1].shape;
        if (unlikely(__pyx_t_24 < 0)) __pyx_t_19 = 1;
      } else if (unlikely(__pyx_t_24 >= __pyx_pybuffernd_out.diminfo[1].shape)) __pyx_t_19 = 1;
      if (unlikely(__pyx_t_19 != -1)) {
        __Pyx_RaiseBufferIndexError(__pyx_t_19);
        __PYX_ERR(0, 1966, __pyx_L1_error)
      }
      *__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_out.rcbuffer->pybuffer.buf, __pyx_t_23, __pyx_pybuffernd_out.diminfo[0].strides, __pyx_t_24, __pyx_pybuffernd_out.diminfo[1].strides) = __pyx_t_22;
    }
  }

  /* "orb/cutils.pyx":1968
 *             out[ii,ij] = bn.nanmean(im[xmin:xmax,ymin:ymax])
 * 
 *     return out             # <<<<<<<<<<<<<<
 * 
 * 
 */
  __Pyx_XDECREF(__pyx_r);
  __Pyx_INCREF(((PyObject *)__pyx_v_out));
  __pyx_r = ((PyObject *)__pyx_v_out);
  goto __pyx_L0;

  /* "orb/cutils.pyx":1942
 * 
 * 
 * def nanbin_image(np.ndarray[np.float64_t, ndim=2] im, int binning):             # <<<<<<<<<<<<<<
 *     """Mean image binning robust to NaNs.
 * 
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_1);
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_XDECREF(__pyx_t_5);
  __Pyx_XDECREF(__pyx_t_7);
  { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
    __Pyx_PyThreadState_declare
    __Pyx_PyThreadState_assign
    __Pyx_ErrFetch(&__pyx_type, &__pyx_value, &__pyx_tb);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_im.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_out.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_x_range.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_y_range.rcbuffer->pybuffer);
  __Pyx_ErrRestore(__pyx_type, __pyx_value, __pyx_tb);}
  __Pyx_AddTraceback("orb.cutils.nanbin_image", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  goto __pyx_L2;
  __pyx_L0:;
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_im.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_out.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_x_range.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_y_range.rcbuffer->pybuffer);
  __pyx_L2:;
  __Pyx_XDECREF((PyObject *)__pyx_v_out);
  __Pyx_XDECREF((PyObject *)__pyx_v_x_range);
  __Pyx_XDECREF((PyObject *)__pyx_v_y_range);
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":1974
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def unbin_image(np.ndarray[np.float64_t, ndim=2] im,             # <<<<<<<<<<<<<<
 *                 int nx, int ny):
 *     """Unbin a binned image (restore the image binned with the
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_71unbin_image(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_3orb_6cutils_70unbin_image[] = "unbin_image(ndarray im, int nx, int ny)\nUnbin a binned image (restore the image binned with the\n    function :py:func:`~orb.cutils.nanbin_image`).\n\n    :param im: Image to unbin.\n\n    :param nx: X dimension of the unbinned image.\n    \n    :param ny: Y dimension of the unbinned image.\n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_71unbin_image = {"unbin_image", (PyCFunction)__pyx_pw_3orb_6cutils_71unbin_image, METH_VARARGS|METH_KEYWORDS, __pyx_doc_3orb_6cutils_70unbin_image};
static PyObject *__pyx_pw_3orb_6cutils_71unbin_image(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  PyArrayObject *__pyx_v_im = 0;
  int __pyx_v_nx;
  int __pyx_v_ny;
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("unbin_image (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_im,&__pyx_n_s_nx,&__pyx_n_s_ny,0};
    PyObject* values[3] = {0,0,0};
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
      switch (pos_args) {
        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = PyDict_Size(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_im)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        case  1:
        if (likely((values[1] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_nx)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("unbin_image", 1, 3, 3, 1); __PYX_ERR(0, 1974, __pyx_L3_error)
        }
        case  2:
        if (likely((values[2] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_ny)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("unbin_image", 1, 3, 3, 2); __PYX_ERR(0, 1974, __pyx_L3_error)
        }
      }
      if (unlikely(kw_args > 0)) {
        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "unbin_image") < 0)) __PYX_ERR(0, 1974, __pyx_L3_error)
      }
    } else if (PyTuple_GET_SIZE(__pyx_args) != 3) {
      goto __pyx_L5_argtuple_error;
    } else {
      values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
      values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
      values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
    }
    __pyx_v_im = ((PyArrayObject *)values[0]);
    __pyx_v_nx = __Pyx_PyInt_As_int(values[1]); if (unlikely((__pyx_v_nx == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 1975, __pyx_L3_error)
    __pyx_v_ny = __Pyx_PyInt_As_int(values[2]); if (unlikely((__pyx_v_ny == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 1975, __pyx_L3_error)
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  __Pyx_RaiseArgtupleInvalid("unbin_image", 1, 3, 3, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 1974, __pyx_L3_error)
  __pyx_L3_error:;
  __Pyx_AddTraceback("orb.cutils.unbin_image", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __Pyx_RefNannyFinishContext();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_im), __pyx_ptype_5numpy_ndarray, 1, "im", 0))) __PYX_ERR(0, 1974, __pyx_L1_error)
  __pyx_r = __pyx_pf_3orb_6cutils_70unbin_image(__pyx_self, __pyx_v_im, __pyx_v_nx, __pyx_v_ny);

  /* function exit code */
  goto __pyx_L0;
  __pyx_L1_error:;
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_70unbin_image(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_im, int __pyx_v_nx, int __pyx_v_ny) {
  PyArrayObject *__pyx_v_out = 0;
  PyArrayObject *__pyx_v_xaxis = 0;
  PyArrayObject *__pyx_v_yaxis = 0;
  int __pyx_v_binx;
  int __pyx_v_biny;
  int __pyx_v_ii;
  int __pyx_v_ij;
  int __pyx_v_x1;
  int __pyx_v_x2;
  int __pyx_v_y1;
  int __pyx_v_y2;
  double __pyx_v_q11;
  double __pyx_v_q12;
  double __pyx_v_q21;
  double __pyx_v_q22;
  double __pyx_v_x;
  double __pyx_v_y;
  int __pyx_v_dimx;
  int __pyx_v_dimy;
  double __pyx_v_x1d;
  double __pyx_v_y1d;
  double __pyx_v_x2d;
  double __pyx_v_y2d;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_im;
  __Pyx_Buffer __pyx_pybuffer_im;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_out;
  __Pyx_Buffer __pyx_pybuffer_out;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_xaxis;
  __Pyx_Buffer __pyx_pybuffer_xaxis;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_yaxis;
  __Pyx_Buffer __pyx_pybuffer_yaxis;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  PyObject *__pyx_t_1 = NULL;
  PyObject *__pyx_t_2 = NULL;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  PyArrayObject *__pyx_t_5 = NULL;
  int __pyx_t_6;
  PyObject *__pyx_t_7 = NULL;
  PyObject *__pyx_t_8 = NULL;
  PyObject *__pyx_t_9 = NULL;
  PyObject *__pyx_t_10 = NULL;
  PyArrayObject *__pyx_t_11 = NULL;
  PyArrayObject *__pyx_t_12 = NULL;
  int __pyx_t_13;
  int __pyx_t_14;
  int __pyx_t_15;
  Py_ssize_t __pyx_t_16;
  Py_ssize_t __pyx_t_17;
  int __pyx_t_18;
  int __pyx_t_19;
  Py_ssize_t __pyx_t_20;
  Py_ssize_t __pyx_t_21;
  Py_ssize_t __pyx_t_22;
  Py_ssize_t __pyx_t_23;
  Py_ssize_t __pyx_t_24;
  Py_ssize_t __pyx_t_25;
  Py_ssize_t __pyx_t_26;
  Py_ssize_t __pyx_t_27;
  Py_ssize_t __pyx_t_28;
  Py_ssize_t __pyx_t_29;
  __Pyx_RefNannySetupContext("unbin_image", 0);
  __pyx_pybuffer_out.pybuffer.buf = NULL;
  __pyx_pybuffer_out.refcount = 0;
  __pyx_pybuffernd_out.data = NULL;
  __pyx_pybuffernd_out.rcbuffer = &__pyx_pybuffer_out;
  __pyx_pybuffer_xaxis.pybuffer.buf = NULL;
  __pyx_pybuffer_xaxis.refcount = 0;
  __pyx_pybuffernd_xaxis.data = NULL;
  __pyx_pybuffernd_xaxis.rcbuffer = &__pyx_pybuffer_xaxis;
  __pyx_pybuffer_yaxis.pybuffer.buf = NULL;
  __pyx_pybuffer_yaxis.refcount = 0;
  __pyx_pybuffernd_yaxis.data = NULL;
  __pyx_pybuffernd_yaxis.rcbuffer = &__pyx_pybuffer_yaxis;
  __pyx_pybuffer_im.pybuffer.buf = NULL;
  __pyx_pybuffer_im.refcount = 0;
  __pyx_pybuffernd_im.data = NULL;
  __pyx_pybuffernd_im.rcbuffer = &__pyx_pybuffer_im;
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_im.rcbuffer->pybuffer, (PyObject*)__pyx_v_im, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) __PYX_ERR(0, 1974, __pyx_L1_error)
  }
  __pyx_pybuffernd_im.diminfo[0].strides = __pyx_pybuffernd_im.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_im.diminfo[0].shape = __pyx_pybuffernd_im.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_im.diminfo[1].strides = __pyx_pybuffernd_im.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_im.diminfo[1].shape = __pyx_pybuffernd_im.rcbuffer->pybuffer.shape[1];

  /* "orb/cutils.pyx":1992
 *     cdef int ii, ij, x1, x2, y1, y2
 *     cdef double q11, q12, q21, q22, x, y
 *     cdef int dimx = im.shape[0]             # <<<<<<<<<<<<<<
 *     cdef int dimy = im.shape[1]
 *     cdef double x1d, y1d, x2d, y2d
 */
  __pyx_v_dimx = (__pyx_v_im->dimensions[0]);

  /* "orb/cutils.pyx":1993
 *     cdef double q11, q12, q21, q22, x, y
 *     cdef int dimx = im.shape[0]
 *     cdef int dimy = im.shape[1]             # <<<<<<<<<<<<<<
 *     cdef double x1d, y1d, x2d, y2d
 * 
 */
  __pyx_v_dimy = (__pyx_v_im->dimensions[1]);

  /* "orb/cutils.pyx":1996
 *     cdef double x1d, y1d, x2d, y2d
 * 
 *     out = np.empty((nx, ny), dtype=float)             # <<<<<<<<<<<<<<
 *     out.fill(np.nan)
 * 
 */
  __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1996, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_empty); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1996, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_nx); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1996, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_3 = __Pyx_PyInt_From_int(__pyx_v_ny); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1996, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_4 = PyTuple_New(2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1996, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_GIVEREF(__pyx_t_1);
  PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_1);
  __Pyx_GIVEREF(__pyx_t_3);
  PyTuple_SET_ITEM(__pyx_t_4, 1, __pyx_t_3);
  __pyx_t_1 = 0;
  __pyx_t_3 = 0;
  __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1996, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_GIVEREF(__pyx_t_4);
  PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_4);
  __pyx_t_4 = 0;
  __pyx_t_4 = PyDict_New(); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1996, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  if (PyDict_SetItem(__pyx_t_4, __pyx_n_s_dtype, ((PyObject *)(&PyFloat_Type))) < 0) __PYX_ERR(0, 1996, __pyx_L1_error)
  __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_3, __pyx_t_4); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1996, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1996, __pyx_L1_error)
  __pyx_t_5 = ((PyArrayObject *)__pyx_t_1);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_out.rcbuffer->pybuffer);
    __pyx_t_6 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_out.rcbuffer->pybuffer, (PyObject*)__pyx_t_5, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 2, 0, __pyx_stack);
    if (unlikely(__pyx_t_6 < 0)) {
      PyErr_Fetch(&__pyx_t_7, &__pyx_t_8, &__pyx_t_9);
      if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_out.rcbuffer->pybuffer, (PyObject*)__pyx_v_out, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 2, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_7); Py_XDECREF(__pyx_t_8); Py_XDECREF(__pyx_t_9);
        __Pyx_RaiseBufferFallbackError();
      } else {
        PyErr_Restore(__pyx_t_7, __pyx_t_8, __pyx_t_9);
      }
    }
    __pyx_pybuffernd_out.diminfo[0].strides = __pyx_pybuffernd_out.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_out.diminfo[0].shape = __pyx_pybuffernd_out.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_out.diminfo[1].strides = __pyx_pybuffernd_out.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_out.diminfo[1].shape = __pyx_pybuffernd_out.rcbuffer->pybuffer.shape[1];
    if (unlikely(__pyx_t_6 < 0)) __PYX_ERR(0, 1996, __pyx_L1_error)
  }
  __pyx_t_5 = 0;
  __pyx_v_out = ((PyArrayObject *)__pyx_t_1);
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1997
 * 
 *     out = np.empty((nx, ny), dtype=float)
 *     out.fill(np.nan)             # <<<<<<<<<<<<<<
 * 
 *     binx = nx / dimx
 */
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_out), __pyx_n_s_fill); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1997, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_3 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1997, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_nan); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1997, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_3 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && likely(PyMethod_Check(__pyx_t_4))) {
    __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_4);
    if (likely(__pyx_t_3)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
      __Pyx_INCREF(__pyx_t_3);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_4, function);
    }
  }
  if (!__pyx_t_3) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_2); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1997, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_10 = PyTuple_New(1+1); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 1997, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_10);
    __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_10, 0, __pyx_t_3); __pyx_t_3 = NULL;
    __Pyx_GIVEREF(__pyx_t_2);
    PyTuple_SET_ITEM(__pyx_t_10, 0+1, __pyx_t_2);
    __pyx_t_2 = 0;
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_10, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1997, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
  }
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1999
 *     out.fill(np.nan)
 * 
 *     binx = nx / dimx             # <<<<<<<<<<<<<<
 *     biny = ny / dimy
 * 
 */
  if (unlikely(__pyx_v_dimx == 0)) {
    PyErr_SetString(PyExc_ZeroDivisionError, "integer division or modulo by zero");
    __PYX_ERR(0, 1999, __pyx_L1_error)
  }
  else if (sizeof(int) == sizeof(long) && (!(((int)-1) > 0)) && unlikely(__pyx_v_dimx == (int)-1)  && unlikely(UNARY_NEG_WOULD_OVERFLOW(__pyx_v_nx))) {
    PyErr_SetString(PyExc_OverflowError, "value too large to perform division");
    __PYX_ERR(0, 1999, __pyx_L1_error)
  }
  __pyx_v_binx = __Pyx_div_int(__pyx_v_nx, __pyx_v_dimx);

  /* "orb/cutils.pyx":2000
 * 
 *     binx = nx / dimx
 *     biny = ny / dimy             # <<<<<<<<<<<<<<
 * 
 *     xaxis = (np.arange(dimx * binx) - (<double> binx / 2. - 0.5)) / (<double> binx)
 */
  if (unlikely(__pyx_v_dimy == 0)) {
    PyErr_SetString(PyExc_ZeroDivisionError, "integer division or modulo by zero");
    __PYX_ERR(0, 2000, __pyx_L1_error)
  }
  else if (sizeof(int) == sizeof(long) && (!(((int)-1) > 0)) && unlikely(__pyx_v_dimy == (int)-1)  && unlikely(UNARY_NEG_WOULD_OVERFLOW(__pyx_v_ny))) {
    PyErr_SetString(PyExc_OverflowError, "value too large to perform division");
    __PYX_ERR(0, 2000, __pyx_L1_error)
  }
  __pyx_v_biny = __Pyx_div_int(__pyx_v_ny, __pyx_v_dimy);

  /* "orb/cutils.pyx":2002
 *     biny = ny / dimy
 * 
 *     xaxis = (np.arange(dimx * binx) - (<double> binx / 2. - 0.5)) / (<double> binx)             # <<<<<<<<<<<<<<
 *     yaxis = (np.arange(dimy * biny) - (<double> biny / 2. - 0.5)) / (<double> biny)
 *     with nogil:
 */
  __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2002, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_10 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_arange); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 2002, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_10);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_4 = __Pyx_PyInt_From_int((__pyx_v_dimx * __pyx_v_binx)); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2002, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_2 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_10))) {
    __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_10);
    if (likely(__pyx_t_2)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_10);
      __Pyx_INCREF(__pyx_t_2);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_10, function);
    }
  }
  if (!__pyx_t_2) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_10, __pyx_t_4); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2002, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_3 = PyTuple_New(1+1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 2002, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_2); __pyx_t_2 = NULL;
    __Pyx_GIVEREF(__pyx_t_4);
    PyTuple_SET_ITEM(__pyx_t_3, 0+1, __pyx_t_4);
    __pyx_t_4 = 0;
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_10, __pyx_t_3, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2002, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  }
  __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
  __pyx_t_10 = PyFloat_FromDouble(((((double)__pyx_v_binx) / 2.) - 0.5)); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 2002, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_10);
  __pyx_t_3 = PyNumber_Subtract(__pyx_t_1, __pyx_t_10); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 2002, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
  __pyx_t_10 = PyFloat_FromDouble(((double)__pyx_v_binx)); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 2002, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_10);
  __pyx_t_1 = __Pyx_PyNumber_Divide(__pyx_t_3, __pyx_t_10); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2002, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 2002, __pyx_L1_error)
  __pyx_t_11 = ((PyArrayObject *)__pyx_t_1);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_xaxis.rcbuffer->pybuffer);
    __pyx_t_6 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_xaxis.rcbuffer->pybuffer, (PyObject*)__pyx_t_11, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack);
    if (unlikely(__pyx_t_6 < 0)) {
      PyErr_Fetch(&__pyx_t_9, &__pyx_t_8, &__pyx_t_7);
      if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_xaxis.rcbuffer->pybuffer, (PyObject*)__pyx_v_xaxis, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_9); Py_XDECREF(__pyx_t_8); Py_XDECREF(__pyx_t_7);
        __Pyx_RaiseBufferFallbackError();
      } else {
        PyErr_Restore(__pyx_t_9, __pyx_t_8, __pyx_t_7);
      }
    }
    __pyx_pybuffernd_xaxis.diminfo[0].strides = __pyx_pybuffernd_xaxis.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_xaxis.diminfo[0].shape = __pyx_pybuffernd_xaxis.rcbuffer->pybuffer.shape[0];
    if (unlikely(__pyx_t_6 < 0)) __PYX_ERR(0, 2002, __pyx_L1_error)
  }
  __pyx_t_11 = 0;
  __pyx_v_xaxis = ((PyArrayObject *)__pyx_t_1);
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":2003
 * 
 *     xaxis = (np.arange(dimx * binx) - (<double> binx / 2. - 0.5)) / (<double> binx)
 *     yaxis = (np.arange(dimy * biny) - (<double> biny / 2. - 0.5)) / (<double> biny)             # <<<<<<<<<<<<<<
 *     with nogil:
 *         for ii in range(dimx * binx):
 */
  __pyx_t_10 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 2003, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_10);
  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_10, __pyx_n_s_arange); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 2003, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
  __pyx_t_10 = __Pyx_PyInt_From_int((__pyx_v_dimy * __pyx_v_biny)); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 2003, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_10);
  __pyx_t_4 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_3))) {
    __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_3);
    if (likely(__pyx_t_4)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
      __Pyx_INCREF(__pyx_t_4);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_3, function);
    }
  }
  if (!__pyx_t_4) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_3, __pyx_t_10); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2003, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_2 = PyTuple_New(1+1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 2003, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_4); __pyx_t_4 = NULL;
    __Pyx_GIVEREF(__pyx_t_10);
    PyTuple_SET_ITEM(__pyx_t_2, 0+1, __pyx_t_10);
    __pyx_t_10 = 0;
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_2, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2003, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  }
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_3 = PyFloat_FromDouble(((((double)__pyx_v_biny) / 2.) - 0.5)); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 2003, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_2 = PyNumber_Subtract(__pyx_t_1, __pyx_t_3); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 2003, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_3 = PyFloat_FromDouble(((double)__pyx_v_biny)); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 2003, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_1 = __Pyx_PyNumber_Divide(__pyx_t_2, __pyx_t_3); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2003, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 2003, __pyx_L1_error)
  __pyx_t_12 = ((PyArrayObject *)__pyx_t_1);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_yaxis.rcbuffer->pybuffer);
    __pyx_t_6 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_yaxis.rcbuffer->pybuffer, (PyObject*)__pyx_t_12, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack);
    if (unlikely(__pyx_t_6 < 0)) {
      PyErr_Fetch(&__pyx_t_7, &__pyx_t_8, &__pyx_t_9);
      if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_yaxis.rcbuffer->pybuffer, (PyObject*)__pyx_v_yaxis, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_7); Py_XDECREF(__pyx_t_8); Py_XDECREF(__pyx_t_9);
        __Pyx_RaiseBufferFallbackError();
      } else {
        PyErr_Restore(__pyx_t_7, __pyx_t_8, __pyx_t_9);
      }
    }
    __pyx_pybuffernd_yaxis.diminfo[0].strides = __pyx_pybuffernd_yaxis.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_yaxis.diminfo[0].shape = __pyx_pybuffernd_yaxis.rcbuffer->pybuffer.shape[0];
    if (unlikely(__pyx_t_6 < 0)) __PYX_ERR(0, 2003, __pyx_L1_error)
  }
  __pyx_t_12 = 0;
  __pyx_v_yaxis = ((PyArrayObject *)__pyx_t_1);
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":2004
 *     xaxis = (np.arange(dimx * binx) - (<double> binx / 2. - 0.5)) / (<double> binx)
 *     yaxis = (np.arange(dimy * biny) - (<double> biny / 2. - 0.5)) / (<double> biny)
 *     with nogil:             # <<<<<<<<<<<<<<
 *         for ii in range(dimx * binx):
 *             for ij in range(dimy * biny):
 */
  {
      #ifdef WITH_THREAD
      PyThreadState *_save;
      Py_UNBLOCK_THREADS
      #endif
      /*try:*/ {

        /* "orb/cutils.pyx":2005
 *     yaxis = (np.arange(dimy * biny) - (<double> biny / 2. - 0.5)) / (<double> biny)
 *     with nogil:
 *         for ii in range(dimx * binx):             # <<<<<<<<<<<<<<
 *             for ij in range(dimy * biny):
 *                 x = xaxis[ii]
 */
        __pyx_t_6 = (__pyx_v_dimx * __pyx_v_binx);
        for (__pyx_t_13 = 0; __pyx_t_13 < __pyx_t_6; __pyx_t_13+=1) {
          __pyx_v_ii = __pyx_t_13;

          /* "orb/cutils.pyx":2006
 *     with nogil:
 *         for ii in range(dimx * binx):
 *             for ij in range(dimy * biny):             # <<<<<<<<<<<<<<
 *                 x = xaxis[ii]
 *                 y = yaxis[ij]
 */
          __pyx_t_14 = (__pyx_v_dimy * __pyx_v_biny);
          for (__pyx_t_15 = 0; __pyx_t_15 < __pyx_t_14; __pyx_t_15+=1) {
            __pyx_v_ij = __pyx_t_15;

            /* "orb/cutils.pyx":2007
 *         for ii in range(dimx * binx):
 *             for ij in range(dimy * biny):
 *                 x = xaxis[ii]             # <<<<<<<<<<<<<<
 *                 y = yaxis[ij]
 *                 if x >= 0. and y >= 0.:
 */
            __pyx_t_16 = __pyx_v_ii;
            __pyx_v_x = (*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_xaxis.rcbuffer->pybuffer.buf, __pyx_t_16, __pyx_pybuffernd_xaxis.diminfo[0].strides));

            /* "orb/cutils.pyx":2008
 *             for ij in range(dimy * biny):
 *                 x = xaxis[ii]
 *                 y = yaxis[ij]             # <<<<<<<<<<<<<<
 *                 if x >= 0. and y >= 0.:
 *                     x1 = <int> x
 */
            __pyx_t_17 = __pyx_v_ij;
            __pyx_v_y = (*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_yaxis.rcbuffer->pybuffer.buf, __pyx_t_17, __pyx_pybuffernd_yaxis.diminfo[0].strides));

            /* "orb/cutils.pyx":2009
 *                 x = xaxis[ii]
 *                 y = yaxis[ij]
 *                 if x >= 0. and y >= 0.:             # <<<<<<<<<<<<<<
 *                     x1 = <int> x
 *                     x2 = x1 + 1
 */
            __pyx_t_19 = ((__pyx_v_x >= 0.) != 0);
            if (__pyx_t_19) {
            } else {
              __pyx_t_18 = __pyx_t_19;
              goto __pyx_L11_bool_binop_done;
            }
            __pyx_t_19 = ((__pyx_v_y >= 0.) != 0);
            __pyx_t_18 = __pyx_t_19;
            __pyx_L11_bool_binop_done:;
            if (__pyx_t_18) {

              /* "orb/cutils.pyx":2010
 *                 y = yaxis[ij]
 *                 if x >= 0. and y >= 0.:
 *                     x1 = <int> x             # <<<<<<<<<<<<<<
 *                     x2 = x1 + 1
 *                     y1 = <int> y
 */
              __pyx_v_x1 = ((int)__pyx_v_x);

              /* "orb/cutils.pyx":2011
 *                 if x >= 0. and y >= 0.:
 *                     x1 = <int> x
 *                     x2 = x1 + 1             # <<<<<<<<<<<<<<
 *                     y1 = <int> y
 *                     y2 = y1 + 1
 */
              __pyx_v_x2 = (__pyx_v_x1 + 1);

              /* "orb/cutils.pyx":2012
 *                     x1 = <int> x
 *                     x2 = x1 + 1
 *                     y1 = <int> y             # <<<<<<<<<<<<<<
 *                     y2 = y1 + 1
 *                     x1d = <double> x1
 */
              __pyx_v_y1 = ((int)__pyx_v_y);

              /* "orb/cutils.pyx":2013
 *                     x2 = x1 + 1
 *                     y1 = <int> y
 *                     y2 = y1 + 1             # <<<<<<<<<<<<<<
 *                     x1d = <double> x1
 *                     x2d = <double> x2
 */
              __pyx_v_y2 = (__pyx_v_y1 + 1);

              /* "orb/cutils.pyx":2014
 *                     y1 = <int> y
 *                     y2 = y1 + 1
 *                     x1d = <double> x1             # <<<<<<<<<<<<<<
 *                     x2d = <double> x2
 *                     y1d = <double> y1
 */
              __pyx_v_x1d = ((double)__pyx_v_x1);

              /* "orb/cutils.pyx":2015
 *                     y2 = y1 + 1
 *                     x1d = <double> x1
 *                     x2d = <double> x2             # <<<<<<<<<<<<<<
 *                     y1d = <double> y1
 *                     y2d = <double> y2
 */
              __pyx_v_x2d = ((double)__pyx_v_x2);

              /* "orb/cutils.pyx":2016
 *                     x1d = <double> x1
 *                     x2d = <double> x2
 *                     y1d = <double> y1             # <<<<<<<<<<<<<<
 *                     y2d = <double> y2
 * 
 */
              __pyx_v_y1d = ((double)__pyx_v_y1);

              /* "orb/cutils.pyx":2017
 *                     x2d = <double> x2
 *                     y1d = <double> y1
 *                     y2d = <double> y2             # <<<<<<<<<<<<<<
 * 
 *                     if x1 >= 0 and y1 >= 0 and x2 < dimx and y2 < dimy:
 */
              __pyx_v_y2d = ((double)__pyx_v_y2);

              /* "orb/cutils.pyx":2019
 *                     y2d = <double> y2
 * 
 *                     if x1 >= 0 and y1 >= 0 and x2 < dimx and y2 < dimy:             # <<<<<<<<<<<<<<
 *                         q11 = <double> im[x1, y1]
 *                         q12 = <double> im[x1, y2]
 */
              __pyx_t_19 = ((__pyx_v_x1 >= 0) != 0);
              if (__pyx_t_19) {
              } else {
                __pyx_t_18 = __pyx_t_19;
                goto __pyx_L14_bool_binop_done;
              }
              __pyx_t_19 = ((__pyx_v_y1 >= 0) != 0);
              if (__pyx_t_19) {
              } else {
                __pyx_t_18 = __pyx_t_19;
                goto __pyx_L14_bool_binop_done;
              }
              __pyx_t_19 = ((__pyx_v_x2 < __pyx_v_dimx) != 0);
              if (__pyx_t_19) {
              } else {
                __pyx_t_18 = __pyx_t_19;
                goto __pyx_L14_bool_binop_done;
              }
              __pyx_t_19 = ((__pyx_v_y2 < __pyx_v_dimy) != 0);
              __pyx_t_18 = __pyx_t_19;
              __pyx_L14_bool_binop_done:;
              if (__pyx_t_18) {

                /* "orb/cutils.pyx":2020
 * 
 *                     if x1 >= 0 and y1 >= 0 and x2 < dimx and y2 < dimy:
 *                         q11 = <double> im[x1, y1]             # <<<<<<<<<<<<<<
 *                         q12 = <double> im[x1, y2]
 *                         q21 = <double> im[x2, y1]
 */
                __pyx_t_20 = __pyx_v_x1;
                __pyx_t_21 = __pyx_v_y1;
                __pyx_v_q11 = ((double)(*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_im.rcbuffer->pybuffer.buf, __pyx_t_20, __pyx_pybuffernd_im.diminfo[0].strides, __pyx_t_21, __pyx_pybuffernd_im.diminfo[1].strides)));

                /* "orb/cutils.pyx":2021
 *                     if x1 >= 0 and y1 >= 0 and x2 < dimx and y2 < dimy:
 *                         q11 = <double> im[x1, y1]
 *                         q12 = <double> im[x1, y2]             # <<<<<<<<<<<<<<
 *                         q21 = <double> im[x2, y1]
 *                         q22 = <double> im[x2, y2]
 */
                __pyx_t_22 = __pyx_v_x1;
                __pyx_t_23 = __pyx_v_y2;
                __pyx_v_q12 = ((double)(*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_im.rcbuffer->pybuffer.buf, __pyx_t_22, __pyx_pybuffernd_im.diminfo[0].strides, __pyx_t_23, __pyx_pybuffernd_im.diminfo[1].strides)));

                /* "orb/cutils.pyx":2022
 *                         q11 = <double> im[x1, y1]
 *                         q12 = <double> im[x1, y2]
 *                         q21 = <double> im[x2, y1]             # <<<<<<<<<<<<<<
 *                         q22 = <double> im[x2, y2]
 *                         out[ii,ij] = (q11 * (x2d - x) * (y2d - y)
 */
                __pyx_t_24 = __pyx_v_x2;
                __pyx_t_25 = __pyx_v_y1;
                __pyx_v_q21 = ((double)(*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_im.rcbuffer->pybuffer.buf, __pyx_t_24, __pyx_pybuffernd_im.diminfo[0].strides, __pyx_t_25, __pyx_pybuffernd_im.diminfo[1].strides)));

                /* "orb/cutils.pyx":2023
 *                         q12 = <double> im[x1, y2]
 *                         q21 = <double> im[x2, y1]
 *                         q22 = <double> im[x2, y2]             # <<<<<<<<<<<<<<
 *                         out[ii,ij] = (q11 * (x2d - x) * (y2d - y)
 *                                       + q21 * (x - x1d) * (y2d - y)
 */
                __pyx_t_26 = __pyx_v_x2;
                __pyx_t_27 = __pyx_v_y2;
                __pyx_v_q22 = ((double)(*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_im.rcbuffer->pybuffer.buf, __pyx_t_26, __pyx_pybuffernd_im.diminfo[0].strides, __pyx_t_27, __pyx_pybuffernd_im.diminfo[1].strides)));

                /* "orb/cutils.pyx":2024
 *                         q21 = <double> im[x2, y1]
 *                         q22 = <double> im[x2, y2]
 *                         out[ii,ij] = (q11 * (x2d - x) * (y2d - y)             # <<<<<<<<<<<<<<
 *                                       + q21 * (x - x1d) * (y2d - y)
 *                                       + q12 * (x2d - x) * (y - y1d)
 */
                __pyx_t_28 = __pyx_v_ii;
                __pyx_t_29 = __pyx_v_ij;
                *__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_out.rcbuffer->pybuffer.buf, __pyx_t_28, __pyx_pybuffernd_out.diminfo[0].strides, __pyx_t_29, __pyx_pybuffernd_out.diminfo[1].strides) = (((((__pyx_v_q11 * (__pyx_v_x2d - __pyx_v_x)) * (__pyx_v_y2d - __pyx_v_y)) + ((__pyx_v_q21 * (__pyx_v_x - __pyx_v_x1d)) * (__pyx_v_y2d - __pyx_v_y))) + ((__pyx_v_q12 * (__pyx_v_x2d - __pyx_v_x)) * (__pyx_v_y - __pyx_v_y1d))) + ((__pyx_v_q22 * (__pyx_v_x - __pyx_v_x1d)) * (__pyx_v_y - __pyx_v_y1d)));

                /* "orb/cutils.pyx":2019
 *                     y2d = <double> y2
 * 
 *                     if x1 >= 0 and y1 >= 0 and x2 < dimx and y2 < dimy:             # <<<<<<<<<<<<<<
 *                         q11 = <double> im[x1, y1]
 *                         q12 = <double> im[x1, y2]
 */
              }

              /* "orb/cutils.pyx":2009
 *                 x = xaxis[ii]
 *                 y = yaxis[ij]
 *                 if x >= 0. and y >= 0.:             # <<<<<<<<<<<<<<
 *                     x1 = <int> x
 *                     x2 = x1 + 1
 */
            }
          }
        }
      }

      /* "orb/cutils.pyx":2004
 *     xaxis = (np.arange(dimx * binx) - (<double> binx / 2. - 0.5)) / (<double> binx)
 *     yaxis = (np.arange(dimy * biny) - (<double> biny / 2. - 0.5)) / (<double> biny)
 *     with nogil:             # <<<<<<<<<<<<<<
 *         for ii in range(dimx * binx):
 *             for ij in range(dimy * biny):
 */
      /*finally:*/ {
        /*normal exit:*/{
          #ifdef WITH_THREAD
          Py_BLOCK_THREADS
          #endif
          goto __pyx_L5;
        }
        __pyx_L5:;
      }
  }

  /* "orb/cutils.pyx":2029
 *                                       + q22 * (x - x1d) * (y - y1d))
 * 
 *     return out             # <<<<<<<<<<<<<<
 * 
 * 
 */
  __Pyx_XDECREF(__pyx_r);
  __Pyx_INCREF(((PyObject *)__pyx_v_out));
  __pyx_r = ((PyObject *)__pyx_v_out);
  goto __pyx_L0;

  /* "orb/cutils.pyx":1974
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def unbin_image(np.ndarray[np.float64_t, ndim=2] im,             # <<<<<<<<<<<<<<
 *                 int nx, int ny):
 *     """Unbin a binned image (restore the image binned with the
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_1);
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_XDECREF(__pyx_t_10);
  { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
    __Pyx_PyThreadState_declare
    __Pyx_PyThreadState_assign
    __Pyx_ErrFetch(&__pyx_type, &__pyx_value, &__pyx_tb);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_im.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_out.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_xaxis.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_yaxis.rcbuffer->pybuffer);
  __Pyx_ErrRestore(__pyx_type, __pyx_value, __pyx_tb);}
  __Pyx_AddTraceback("orb.cutils.unbin_image", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  goto __pyx_L2;
  __pyx_L0:;
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_im.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_out.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_xaxis.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_yaxis.rcbuffer->pybuffer);
  __pyx_L2:;
  __Pyx_XDECREF((PyObject *)__pyx_v_out);
  __Pyx_XDECREF((PyObject *)__pyx_v_xaxis);
  __Pyx_XDECREF((PyObject *)__pyx_v_yaxis);
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":2034
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def im2rgba(np.ndarray[np.float64_t, ndim=2] im,             # <<<<<<<<<<<<<<
 *             mpl_colorbar,
 *             double vmin, double vmax,
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_73im2rgba(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_3orb_6cutils_72im2rgba[] = "im2rgba(ndarray im, mpl_colorbar, double vmin, double vmax, int xmin, int xmax, int ymin, int ymax, ndarray computed_pixels, last_arr8, int res=1000)\nCompute RGBA from image given a matplotlib colorbar instance.\n\n    This is a function used by :py:class:`orb.visual.ImageCanvas`. It\n    is not a generalist function. It has been written to accelerate\n    matplotlib function colorbar.to_rgba().\n\n    :param im: Image\n    :param mpl_colorbar: A matplotlib colorbar instance\n    :param vmin: min value of the colorbar\n    :param vmax: max value of the colorbar\n    :param xmin: min x index of the region to compute\n    :param xmax: max x index of the region to compute\n    :param ymin: min y index of the region to compute\n    :param ymax: max y index of the region to compute\n    :param computed_pixels: Array giving the already computed pixels\n    :param last_arr8: If not None, last computed array.\n    :param res: (Optional) Lookup table resolution (default 1000)\n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_73im2rgba = {"im2rgba", (PyCFunction)__pyx_pw_3orb_6cutils_73im2rgba, METH_VARARGS|METH_KEYWORDS, __pyx_doc_3orb_6cutils_72im2rgba};
static PyObject *__pyx_pw_3orb_6cutils_73im2rgba(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  PyArrayObject *__pyx_v_im = 0;
  PyObject *__pyx_v_mpl_colorbar = 0;
  double __pyx_v_vmin;
  double __pyx_v_vmax;
  int __pyx_v_xmin;
  int __pyx_v_xmax;
  int __pyx_v_ymin;
  int __pyx_v_ymax;
  PyArrayObject *__pyx_v_computed_pixels = 0;
  PyObject *__pyx_v_last_arr8 = 0;
  int __pyx_v_res;
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("im2rgba (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_im,&__pyx_n_s_mpl_colorbar,&__pyx_n_s_vmin,&__pyx_n_s_vmax,&__pyx_n_s_xmin,&__pyx_n_s_xmax,&__pyx_n_s_ymin,&__pyx_n_s_ymax,&__pyx_n_s_computed_pixels,&__pyx_n_s_last_arr8,&__pyx_n_s_res,0};
    PyObject* values[11] = {0,0,0,0,0,0,0,0,0,0,0};
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
      switch (pos_args) {
        case 11: values[10] = PyTuple_GET_ITEM(__pyx_args, 10);
        case 10: values[9] = PyTuple_GET_ITEM(__pyx_args, 9);
        case  9: values[8] = PyTuple_GET_ITEM(__pyx_args, 8);
        case  8: values[7] = PyTuple_GET_ITEM(__pyx_args, 7);
        case  7: values[6] = PyTuple_GET_ITEM(__pyx_args, 6);
        case  6: values[5] = PyTuple_GET_ITEM(__pyx_args, 5);
        case  5: values[4] = PyTuple_GET_ITEM(__pyx_args, 4);
        case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = PyDict_Size(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_im)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        case  1:
        if (likely((values[1] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_mpl_colorbar)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("im2rgba", 0, 10, 11, 1); __PYX_ERR(0, 2034, __pyx_L3_error)
        }
        case  2:
        if (likely((values[2] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_vmin)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("im2rgba", 0, 10, 11, 2); __PYX_ERR(0, 2034, __pyx_L3_error)
        }
        case  3:
        if (likely((values[3] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_vmax)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("im2rgba", 0, 10, 11, 3); __PYX_ERR(0, 2034, __pyx_L3_error)
        }
        case  4:
        if (likely((values[4] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_xmin)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("im2rgba", 0, 10, 11, 4); __PYX_ERR(0, 2034, __pyx_L3_error)
        }
        case  5:
        if (likely((values[5] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_xmax)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("im2rgba", 0, 10, 11, 5); __PYX_ERR(0, 2034, __pyx_L3_error)
        }
        case  6:
        if (likely((values[6] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_ymin)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("im2rgba", 0, 10, 11, 6); __PYX_ERR(0, 2034, __pyx_L3_error)
        }
        case  7:
        if (likely((values[7] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_ymax)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("im2rgba", 0, 10, 11, 7); __PYX_ERR(0, 2034, __pyx_L3_error)
        }
        case  8:
        if (likely((values[8] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_computed_pixels)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("im2rgba", 0, 10, 11, 8); __PYX_ERR(0, 2034, __pyx_L3_error)
        }
        case  9:
        if (likely((values[9] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_last_arr8)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("im2rgba", 0, 10, 11, 9); __PYX_ERR(0, 2034, __pyx_L3_error)
        }
        case 10:
        if (kw_args > 0) {
          PyObject* value = PyDict_GetItem(__pyx_kwds, __pyx_n_s_res);
          if (value) { values[10] = value; kw_args--; }
        }
      }
      if (unlikely(kw_args > 0)) {
        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "im2rgba") < 0)) __PYX_ERR(0, 2034, __pyx_L3_error)
      }
    } else {
      switch (PyTuple_GET_SIZE(__pyx_args)) {
        case 11: values[10] = PyTuple_GET_ITEM(__pyx_args, 10);
        case 10: values[9] = PyTuple_GET_ITEM(__pyx_args, 9);
        values[8] = PyTuple_GET_ITEM(__pyx_args, 8);
        values[7] = PyTuple_GET_ITEM(__pyx_args, 7);
        values[6] = PyTuple_GET_ITEM(__pyx_args, 6);
        values[5] = PyTuple_GET_ITEM(__pyx_args, 5);
        values[4] = PyTuple_GET_ITEM(__pyx_args, 4);
        values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
        values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        break;
        default: goto __pyx_L5_argtuple_error;
      }
    }
    __pyx_v_im = ((PyArrayObject *)values[0]);
    __pyx_v_mpl_colorbar = values[1];
    __pyx_v_vmin = __pyx_PyFloat_AsDouble(values[2]); if (unlikely((__pyx_v_vmin == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 2036, __pyx_L3_error)
    __pyx_v_vmax = __pyx_PyFloat_AsDouble(values[3]); if (unlikely((__pyx_v_vmax == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 2036, __pyx_L3_error)
    __pyx_v_xmin = __Pyx_PyInt_As_int(values[4]); if (unlikely((__pyx_v_xmin == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 2037, __pyx_L3_error)
    __pyx_v_xmax = __Pyx_PyInt_As_int(values[5]); if (unlikely((__pyx_v_xmax == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 2037, __pyx_L3_error)
    __pyx_v_ymin = __Pyx_PyInt_As_int(values[6]); if (unlikely((__pyx_v_ymin == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 2037, __pyx_L3_error)
    __pyx_v_ymax = __Pyx_PyInt_As_int(values[7]); if (unlikely((__pyx_v_ymax == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 2037, __pyx_L3_error)
    __pyx_v_computed_pixels = ((PyArrayObject *)values[8]);
    __pyx_v_last_arr8 = values[9];
    if (values[10]) {
      __pyx_v_res = __Pyx_PyInt_As_int(values[10]); if (unlikely((__pyx_v_res == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 2040, __pyx_L3_error)
    } else {
      __pyx_v_res = ((int)0x3E8);
    }
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  __Pyx_RaiseArgtupleInvalid("im2rgba", 0, 10, 11, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 2034, __pyx_L3_error)
  __pyx_L3_error:;
  __Pyx_AddTraceback("orb.cutils.im2rgba", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __Pyx_RefNannyFinishContext();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_im), __pyx_ptype_5numpy_ndarray, 1, "im", 0))) __PYX_ERR(0, 2034, __pyx_L1_error)
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_computed_pixels), __pyx_ptype_5numpy_ndarray, 1, "computed_pixels", 0))) __PYX_ERR(0, 2038, __pyx_L1_error)
  __pyx_r = __pyx_pf_3orb_6cutils_72im2rgba(__pyx_self, __pyx_v_im, __pyx_v_mpl_colorbar, __pyx_v_vmin, __pyx_v_vmax, __pyx_v_xmin, __pyx_v_xmax, __pyx_v_ymin, __pyx_v_ymax, __pyx_v_computed_pixels, __pyx_v_last_arr8, __pyx_v_res);

  /* function exit code */
  goto __pyx_L0;
  __pyx_L1_error:;
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_72im2rgba(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_im, PyObject *__pyx_v_mpl_colorbar, double __pyx_v_vmin, double __pyx_v_vmax, int __pyx_v_xmin, int __pyx_v_xmax, int __pyx_v_ymin, int __pyx_v_ymax, PyArrayObject *__pyx_v_computed_pixels, PyObject *__pyx_v_last_arr8, int __pyx_v_res) {
  PyArrayObject *__pyx_v_color_values = 0;
  PyArrayObject *__pyx_v_color_mapper = 0;
  PyArrayObject *__pyx_v_arr8 = 0;
  PyArrayObject *__pyx_v_x_range = 0;
  PyArrayObject *__pyx_v_y_range = 0;
  int __pyx_v_ii;
  int __pyx_v_ij;
  int __pyx_v_index;
  int __pyx_v_ir;
  int __pyx_v_n;
  PyObject *__pyx_v_pix_to_compute = NULL;
  long __pyx_v_ik;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_arr8;
  __Pyx_Buffer __pyx_pybuffer_arr8;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_color_mapper;
  __Pyx_Buffer __pyx_pybuffer_color_mapper;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_color_values;
  __Pyx_Buffer __pyx_pybuffer_color_values;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_computed_pixels;
  __Pyx_Buffer __pyx_pybuffer_computed_pixels;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_im;
  __Pyx_Buffer __pyx_pybuffer_im;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_x_range;
  __Pyx_Buffer __pyx_pybuffer_x_range;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_y_range;
  __Pyx_Buffer __pyx_pybuffer_y_range;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  PyObject *__pyx_t_1 = NULL;
  PyObject *__pyx_t_2 = NULL;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  PyObject *__pyx_t_5 = NULL;
  PyObject *__pyx_t_6 = NULL;
  Py_ssize_t __pyx_t_7;
  PyObject *__pyx_t_8 = NULL;
  PyArrayObject *__pyx_t_9 = NULL;
  int __pyx_t_10;
  PyObject *__pyx_t_11 = NULL;
  PyObject *__pyx_t_12 = NULL;
  PyObject *__pyx_t_13 = NULL;
  PyArrayObject *__pyx_t_14 = NULL;
  int __pyx_t_15;
  int __pyx_t_16;
  PyArrayObject *__pyx_t_17 = NULL;
  PyArrayObject *__pyx_t_18 = NULL;
  int __pyx_t_19;
  Py_ssize_t __pyx_t_20;
  Py_ssize_t __pyx_t_21;
  Py_ssize_t __pyx_t_22;
  Py_ssize_t __pyx_t_23;
  Py_ssize_t __pyx_t_24;
  Py_ssize_t __pyx_t_25;
  Py_ssize_t __pyx_t_26;
  Py_ssize_t __pyx_t_27;
  Py_ssize_t __pyx_t_28;
  Py_ssize_t __pyx_t_29;
  Py_ssize_t __pyx_t_30;
  Py_ssize_t __pyx_t_31;
  __pyx_t_5numpy_float64_t __pyx_t_32;
  double __pyx_t_33;
  long __pyx_t_34;
  Py_ssize_t __pyx_t_35;
  Py_ssize_t __pyx_t_36;
  Py_ssize_t __pyx_t_37;
  Py_ssize_t __pyx_t_38;
  Py_ssize_t __pyx_t_39;
  Py_ssize_t __pyx_t_40;
  Py_ssize_t __pyx_t_41;
  Py_ssize_t __pyx_t_42;
  __Pyx_RefNannySetupContext("im2rgba", 0);
  __pyx_pybuffer_color_values.pybuffer.buf = NULL;
  __pyx_pybuffer_color_values.refcount = 0;
  __pyx_pybuffernd_color_values.data = NULL;
  __pyx_pybuffernd_color_values.rcbuffer = &__pyx_pybuffer_color_values;
  __pyx_pybuffer_color_mapper.pybuffer.buf = NULL;
  __pyx_pybuffer_color_mapper.refcount = 0;
  __pyx_pybuffernd_color_mapper.data = NULL;
  __pyx_pybuffernd_color_mapper.rcbuffer = &__pyx_pybuffer_color_mapper;
  __pyx_pybuffer_arr8.pybuffer.buf = NULL;
  __pyx_pybuffer_arr8.refcount = 0;
  __pyx_pybuffernd_arr8.data = NULL;
  __pyx_pybuffernd_arr8.rcbuffer = &__pyx_pybuffer_arr8;
  __pyx_pybuffer_x_range.pybuffer.buf = NULL;
  __pyx_pybuffer_x_range.refcount = 0;
  __pyx_pybuffernd_x_range.data = NULL;
  __pyx_pybuffernd_x_range.rcbuffer = &__pyx_pybuffer_x_range;
  __pyx_pybuffer_y_range.pybuffer.buf = NULL;
  __pyx_pybuffer_y_range.refcount = 0;
  __pyx_pybuffernd_y_range.data = NULL;
  __pyx_pybuffernd_y_range.rcbuffer = &__pyx_pybuffer_y_range;
  __pyx_pybuffer_im.pybuffer.buf = NULL;
  __pyx_pybuffer_im.refcount = 0;
  __pyx_pybuffernd_im.data = NULL;
  __pyx_pybuffernd_im.rcbuffer = &__pyx_pybuffer_im;
  __pyx_pybuffer_computed_pixels.pybuffer.buf = NULL;
  __pyx_pybuffer_computed_pixels.refcount = 0;
  __pyx_pybuffernd_computed_pixels.data = NULL;
  __pyx_pybuffernd_computed_pixels.rcbuffer = &__pyx_pybuffer_computed_pixels;
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_im.rcbuffer->pybuffer, (PyObject*)__pyx_v_im, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) __PYX_ERR(0, 2034, __pyx_L1_error)
  }
  __pyx_pybuffernd_im.diminfo[0].strides = __pyx_pybuffernd_im.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_im.diminfo[0].shape = __pyx_pybuffernd_im.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_im.diminfo[1].strides = __pyx_pybuffernd_im.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_im.diminfo[1].shape = __pyx_pybuffernd_im.rcbuffer->pybuffer.shape[1];
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_computed_pixels.rcbuffer->pybuffer, (PyObject*)__pyx_v_computed_pixels, &__Pyx_TypeInfo_nn___pyx_t_5numpy_uint8_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) __PYX_ERR(0, 2034, __pyx_L1_error)
  }
  __pyx_pybuffernd_computed_pixels.diminfo[0].strides = __pyx_pybuffernd_computed_pixels.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_computed_pixels.diminfo[0].shape = __pyx_pybuffernd_computed_pixels.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_computed_pixels.diminfo[1].strides = __pyx_pybuffernd_computed_pixels.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_computed_pixels.diminfo[1].shape = __pyx_pybuffernd_computed_pixels.rcbuffer->pybuffer.shape[1];

  /* "orb/cutils.pyx":2067
 *     cdef int ii, ij, index, ir, n
 * 
 *     color_values = np.linspace(vmin, vmax, res)             # <<<<<<<<<<<<<<
 *     color_mapper = mpl_colorbar.to_rgba(
 *         color_values, alpha=None, bytes=True)
 */
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 2067, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_linspace); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 2067, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = PyFloat_FromDouble(__pyx_v_vmin); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 2067, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_4 = PyFloat_FromDouble(__pyx_v_vmax); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2067, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_5 = __Pyx_PyInt_From_int(__pyx_v_res); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 2067, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_6 = NULL;
  __pyx_t_7 = 0;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_3))) {
    __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_3);
    if (likely(__pyx_t_6)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
      __Pyx_INCREF(__pyx_t_6);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_3, function);
      __pyx_t_7 = 1;
    }
  }
  __pyx_t_8 = PyTuple_New(3+__pyx_t_7); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 2067, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_8);
  if (__pyx_t_6) {
    __Pyx_GIVEREF(__pyx_t_6); PyTuple_SET_ITEM(__pyx_t_8, 0, __pyx_t_6); __pyx_t_6 = NULL;
  }
  __Pyx_GIVEREF(__pyx_t_2);
  PyTuple_SET_ITEM(__pyx_t_8, 0+__pyx_t_7, __pyx_t_2);
  __Pyx_GIVEREF(__pyx_t_4);
  PyTuple_SET_ITEM(__pyx_t_8, 1+__pyx_t_7, __pyx_t_4);
  __Pyx_GIVEREF(__pyx_t_5);
  PyTuple_SET_ITEM(__pyx_t_8, 2+__pyx_t_7, __pyx_t_5);
  __pyx_t_2 = 0;
  __pyx_t_4 = 0;
  __pyx_t_5 = 0;
  __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_8, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2067, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 2067, __pyx_L1_error)
  __pyx_t_9 = ((PyArrayObject *)__pyx_t_1);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_color_values.rcbuffer->pybuffer);
    __pyx_t_10 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_color_values.rcbuffer->pybuffer, (PyObject*)__pyx_t_9, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack);
    if (unlikely(__pyx_t_10 < 0)) {
      PyErr_Fetch(&__pyx_t_11, &__pyx_t_12, &__pyx_t_13);
      if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_color_values.rcbuffer->pybuffer, (PyObject*)__pyx_v_color_values, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_11); Py_XDECREF(__pyx_t_12); Py_XDECREF(__pyx_t_13);
        __Pyx_RaiseBufferFallbackError();
      } else {
        PyErr_Restore(__pyx_t_11, __pyx_t_12, __pyx_t_13);
      }
    }
    __pyx_pybuffernd_color_values.diminfo[0].strides = __pyx_pybuffernd_color_values.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_color_values.diminfo[0].shape = __pyx_pybuffernd_color_values.rcbuffer->pybuffer.shape[0];
    if (unlikely(__pyx_t_10 < 0)) __PYX_ERR(0, 2067, __pyx_L1_error)
  }
  __pyx_t_9 = 0;
  __pyx_v_color_values = ((PyArrayObject *)__pyx_t_1);
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":2068
 * 
 *     color_values = np.linspace(vmin, vmax, res)
 *     color_mapper = mpl_colorbar.to_rgba(             # <<<<<<<<<<<<<<
 *         color_values, alpha=None, bytes=True)
 *     if last_arr8 is None:
 */
  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_mpl_colorbar, __pyx_n_s_to_rgba); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2068, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);

  /* "orb/cutils.pyx":2069
 *     color_values = np.linspace(vmin, vmax, res)
 *     color_mapper = mpl_colorbar.to_rgba(
 *         color_values, alpha=None, bytes=True)             # <<<<<<<<<<<<<<
 *     if last_arr8 is None:
 *         arr8 = np.ones((im.shape[1], im.shape[0], 4),
 */
  __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 2068, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_INCREF(((PyObject *)__pyx_v_color_values));
  __Pyx_GIVEREF(((PyObject *)__pyx_v_color_values));
  PyTuple_SET_ITEM(__pyx_t_3, 0, ((PyObject *)__pyx_v_color_values));
  __pyx_t_8 = PyDict_New(); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 2069, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_8);
  if (PyDict_SetItem(__pyx_t_8, __pyx_n_s_alpha, Py_None) < 0) __PYX_ERR(0, 2069, __pyx_L1_error)
  if (PyDict_SetItem(__pyx_t_8, __pyx_n_s_bytes, Py_True) < 0) __PYX_ERR(0, 2069, __pyx_L1_error)

  /* "orb/cutils.pyx":2068
 * 
 *     color_values = np.linspace(vmin, vmax, res)
 *     color_mapper = mpl_colorbar.to_rgba(             # <<<<<<<<<<<<<<
 *         color_values, alpha=None, bytes=True)
 *     if last_arr8 is None:
 */
  __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_1, __pyx_t_3, __pyx_t_8); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 2068, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
  if (!(likely(((__pyx_t_5) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_5, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 2068, __pyx_L1_error)
  __pyx_t_14 = ((PyArrayObject *)__pyx_t_5);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_color_mapper.rcbuffer->pybuffer);
    __pyx_t_10 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_color_mapper.rcbuffer->pybuffer, (PyObject*)__pyx_t_14, &__Pyx_TypeInfo_nn___pyx_t_5numpy_uint8_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
    if (unlikely(__pyx_t_10 < 0)) {
      PyErr_Fetch(&__pyx_t_13, &__pyx_t_12, &__pyx_t_11);
      if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_color_mapper.rcbuffer->pybuffer, (PyObject*)__pyx_v_color_mapper, &__Pyx_TypeInfo_nn___pyx_t_5numpy_uint8_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_13); Py_XDECREF(__pyx_t_12); Py_XDECREF(__pyx_t_11);
        __Pyx_RaiseBufferFallbackError();
      } else {
        PyErr_Restore(__pyx_t_13, __pyx_t_12, __pyx_t_11);
      }
    }
    __pyx_pybuffernd_color_mapper.diminfo[0].strides = __pyx_pybuffernd_color_mapper.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_color_mapper.diminfo[0].shape = __pyx_pybuffernd_color_mapper.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_color_mapper.diminfo[1].strides = __pyx_pybuffernd_color_mapper.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_color_mapper.diminfo[1].shape = __pyx_pybuffernd_color_mapper.rcbuffer->pybuffer.shape[1];
    if (unlikely(__pyx_t_10 < 0)) __PYX_ERR(0, 2068, __pyx_L1_error)
  }
  __pyx_t_14 = 0;
  __pyx_v_color_mapper = ((PyArrayObject *)__pyx_t_5);
  __pyx_t_5 = 0;

  /* "orb/cutils.pyx":2070
 *     color_mapper = mpl_colorbar.to_rgba(
 *         color_values, alpha=None, bytes=True)
 *     if last_arr8 is None:             # <<<<<<<<<<<<<<
 *         arr8 = np.ones((im.shape[1], im.shape[0], 4),
 *                        dtype=np.uint8) * 255
 */
  __pyx_t_15 = (__pyx_v_last_arr8 == Py_None);
  __pyx_t_16 = (__pyx_t_15 != 0);
  if (__pyx_t_16) {

    /* "orb/cutils.pyx":2071
 *         color_values, alpha=None, bytes=True)
 *     if last_arr8 is None:
 *         arr8 = np.ones((im.shape[1], im.shape[0], 4),             # <<<<<<<<<<<<<<
 *                        dtype=np.uint8) * 255
 *     else:
 */
    __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 2071, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __pyx_t_8 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_ones); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 2071, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_8);
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    __pyx_t_5 = __Pyx_PyInt_From_Py_intptr_t((__pyx_v_im->dimensions[1])); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 2071, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __pyx_t_3 = __Pyx_PyInt_From_Py_intptr_t((__pyx_v_im->dimensions[0])); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 2071, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __pyx_t_1 = PyTuple_New(3); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2071, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_GIVEREF(__pyx_t_5);
    PyTuple_SET_ITEM(__pyx_t_1, 0, __pyx_t_5);
    __Pyx_GIVEREF(__pyx_t_3);
    PyTuple_SET_ITEM(__pyx_t_1, 1, __pyx_t_3);
    __Pyx_INCREF(__pyx_int_4);
    __Pyx_GIVEREF(__pyx_int_4);
    PyTuple_SET_ITEM(__pyx_t_1, 2, __pyx_int_4);
    __pyx_t_5 = 0;
    __pyx_t_3 = 0;
    __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 2071, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_GIVEREF(__pyx_t_1);
    PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_1);
    __pyx_t_1 = 0;

    /* "orb/cutils.pyx":2072
 *     if last_arr8 is None:
 *         arr8 = np.ones((im.shape[1], im.shape[0], 4),
 *                        dtype=np.uint8) * 255             # <<<<<<<<<<<<<<
 *     else:
 *         arr8 = last_arr8
 */
    __pyx_t_1 = PyDict_New(); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2072, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 2072, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_uint8); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2072, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    if (PyDict_SetItem(__pyx_t_1, __pyx_n_s_dtype, __pyx_t_4) < 0) __PYX_ERR(0, 2072, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;

    /* "orb/cutils.pyx":2071
 *         color_values, alpha=None, bytes=True)
 *     if last_arr8 is None:
 *         arr8 = np.ones((im.shape[1], im.shape[0], 4),             # <<<<<<<<<<<<<<
 *                        dtype=np.uint8) * 255
 *     else:
 */
    __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_8, __pyx_t_3, __pyx_t_1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2071, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

    /* "orb/cutils.pyx":2072
 *     if last_arr8 is None:
 *         arr8 = np.ones((im.shape[1], im.shape[0], 4),
 *                        dtype=np.uint8) * 255             # <<<<<<<<<<<<<<
 *     else:
 *         arr8 = last_arr8
 */
    __pyx_t_1 = PyNumber_Multiply(__pyx_t_4, __pyx_int_255); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2072, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 2072, __pyx_L1_error)
    __pyx_t_17 = ((PyArrayObject *)__pyx_t_1);
    {
      __Pyx_BufFmt_StackElem __pyx_stack[1];
      __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_arr8.rcbuffer->pybuffer);
      __pyx_t_10 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_arr8.rcbuffer->pybuffer, (PyObject*)__pyx_t_17, &__Pyx_TypeInfo_nn___pyx_t_5numpy_uint8_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 3, 0, __pyx_stack);
      if (unlikely(__pyx_t_10 < 0)) {
        PyErr_Fetch(&__pyx_t_11, &__pyx_t_12, &__pyx_t_13);
        if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_arr8.rcbuffer->pybuffer, (PyObject*)__pyx_v_arr8, &__Pyx_TypeInfo_nn___pyx_t_5numpy_uint8_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 3, 0, __pyx_stack) == -1)) {
          Py_XDECREF(__pyx_t_11); Py_XDECREF(__pyx_t_12); Py_XDECREF(__pyx_t_13);
          __Pyx_RaiseBufferFallbackError();
        } else {
          PyErr_Restore(__pyx_t_11, __pyx_t_12, __pyx_t_13);
        }
      }
      __pyx_pybuffernd_arr8.diminfo[0].strides = __pyx_pybuffernd_arr8.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_arr8.diminfo[0].shape = __pyx_pybuffernd_arr8.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_arr8.diminfo[1].strides = __pyx_pybuffernd_arr8.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_arr8.diminfo[1].shape = __pyx_pybuffernd_arr8.rcbuffer->pybuffer.shape[1]; __pyx_pybuffernd_arr8.diminfo[2].strides = __pyx_pybuffernd_arr8.rcbuffer->pybuffer.strides[2]; __pyx_pybuffernd_arr8.diminfo[2].shape = __pyx_pybuffernd_arr8.rcbuffer->pybuffer.shape[2];
      if (unlikely(__pyx_t_10 < 0)) __PYX_ERR(0, 2071, __pyx_L1_error)
    }
    __pyx_t_17 = 0;
    __pyx_v_arr8 = ((PyArrayObject *)__pyx_t_1);
    __pyx_t_1 = 0;

    /* "orb/cutils.pyx":2070
 *     color_mapper = mpl_colorbar.to_rgba(
 *         color_values, alpha=None, bytes=True)
 *     if last_arr8 is None:             # <<<<<<<<<<<<<<
 *         arr8 = np.ones((im.shape[1], im.shape[0], 4),
 *                        dtype=np.uint8) * 255
 */
    goto __pyx_L3;
  }

  /* "orb/cutils.pyx":2074
 *                        dtype=np.uint8) * 255
 *     else:
 *         arr8 = last_arr8             # <<<<<<<<<<<<<<
 * 
 *     pix_to_compute = np.nonzero(computed_pixels[xmin:xmax, ymin:ymax] < 1)
 */
  /*else*/ {
    if (!(likely(((__pyx_v_last_arr8) == Py_None) || likely(__Pyx_TypeTest(__pyx_v_last_arr8, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 2074, __pyx_L1_error)
    __pyx_t_1 = __pyx_v_last_arr8;
    __Pyx_INCREF(__pyx_t_1);
    {
      __Pyx_BufFmt_StackElem __pyx_stack[1];
      __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_arr8.rcbuffer->pybuffer);
      __pyx_t_10 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_arr8.rcbuffer->pybuffer, (PyObject*)((PyArrayObject *)__pyx_t_1), &__Pyx_TypeInfo_nn___pyx_t_5numpy_uint8_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 3, 0, __pyx_stack);
      if (unlikely(__pyx_t_10 < 0)) {
        PyErr_Fetch(&__pyx_t_13, &__pyx_t_12, &__pyx_t_11);
        if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_arr8.rcbuffer->pybuffer, (PyObject*)__pyx_v_arr8, &__Pyx_TypeInfo_nn___pyx_t_5numpy_uint8_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 3, 0, __pyx_stack) == -1)) {
          Py_XDECREF(__pyx_t_13); Py_XDECREF(__pyx_t_12); Py_XDECREF(__pyx_t_11);
          __Pyx_RaiseBufferFallbackError();
        } else {
          PyErr_Restore(__pyx_t_13, __pyx_t_12, __pyx_t_11);
        }
      }
      __pyx_pybuffernd_arr8.diminfo[0].strides = __pyx_pybuffernd_arr8.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_arr8.diminfo[0].shape = __pyx_pybuffernd_arr8.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_arr8.diminfo[1].strides = __pyx_pybuffernd_arr8.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_arr8.diminfo[1].shape = __pyx_pybuffernd_arr8.rcbuffer->pybuffer.shape[1]; __pyx_pybuffernd_arr8.diminfo[2].strides = __pyx_pybuffernd_arr8.rcbuffer->pybuffer.strides[2]; __pyx_pybuffernd_arr8.diminfo[2].shape = __pyx_pybuffernd_arr8.rcbuffer->pybuffer.shape[2];
      if (unlikely(__pyx_t_10 < 0)) __PYX_ERR(0, 2074, __pyx_L1_error)
    }
    __pyx_v_arr8 = ((PyArrayObject *)__pyx_t_1);
    __pyx_t_1 = 0;
  }
  __pyx_L3:;

  /* "orb/cutils.pyx":2076
 *         arr8 = last_arr8
 * 
 *     pix_to_compute = np.nonzero(computed_pixels[xmin:xmax, ymin:ymax] < 1)             # <<<<<<<<<<<<<<
 *     x_range = pix_to_compute[0].astype(np.uint16)
 *     y_range = pix_to_compute[1].astype(np.uint16)
 */
  __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2076, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_nonzero); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 2076, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_4 = __Pyx_PyInt_From_int(__pyx_v_xmin); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2076, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_8 = __Pyx_PyInt_From_int(__pyx_v_xmax); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 2076, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_8);
  __pyx_t_5 = PySlice_New(__pyx_t_4, __pyx_t_8, Py_None); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 2076, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
  __pyx_t_8 = __Pyx_PyInt_From_int(__pyx_v_ymin); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 2076, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_8);
  __pyx_t_4 = __Pyx_PyInt_From_int(__pyx_v_ymax); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2076, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_2 = PySlice_New(__pyx_t_8, __pyx_t_4, Py_None); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 2076, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_4 = PyTuple_New(2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2076, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_GIVEREF(__pyx_t_5);
  PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_5);
  __Pyx_GIVEREF(__pyx_t_2);
  PyTuple_SET_ITEM(__pyx_t_4, 1, __pyx_t_2);
  __pyx_t_5 = 0;
  __pyx_t_2 = 0;
  __pyx_t_2 = PyObject_GetItem(((PyObject *)__pyx_v_computed_pixels), __pyx_t_4); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 2076, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_4 = PyObject_RichCompare(__pyx_t_2, __pyx_int_1, Py_LT); __Pyx_XGOTREF(__pyx_t_4); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2076, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_3))) {
    __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_3);
    if (likely(__pyx_t_2)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
      __Pyx_INCREF(__pyx_t_2);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_3, function);
    }
  }
  if (!__pyx_t_2) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_3, __pyx_t_4); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2076, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_5 = PyTuple_New(1+1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 2076, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_2); __pyx_t_2 = NULL;
    __Pyx_GIVEREF(__pyx_t_4);
    PyTuple_SET_ITEM(__pyx_t_5, 0+1, __pyx_t_4);
    __pyx_t_4 = 0;
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_5, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2076, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  }
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_v_pix_to_compute = __pyx_t_1;
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":2077
 * 
 *     pix_to_compute = np.nonzero(computed_pixels[xmin:xmax, ymin:ymax] < 1)
 *     x_range = pix_to_compute[0].astype(np.uint16)             # <<<<<<<<<<<<<<
 *     y_range = pix_to_compute[1].astype(np.uint16)
 *     n = <int> len(x_range)
 */
  __pyx_t_3 = __Pyx_GetItemInt(__pyx_v_pix_to_compute, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 2077, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_astype); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 2077, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_3 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 2077, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_uint16); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2077, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_3 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && likely(PyMethod_Check(__pyx_t_5))) {
    __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_5);
    if (likely(__pyx_t_3)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_5);
      __Pyx_INCREF(__pyx_t_3);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_5, function);
    }
  }
  if (!__pyx_t_3) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_5, __pyx_t_4); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2077, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_2 = PyTuple_New(1+1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 2077, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_3); __pyx_t_3 = NULL;
    __Pyx_GIVEREF(__pyx_t_4);
    PyTuple_SET_ITEM(__pyx_t_2, 0+1, __pyx_t_4);
    __pyx_t_4 = 0;
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_2, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2077, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  }
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 2077, __pyx_L1_error)
  __pyx_t_18 = ((PyArrayObject *)__pyx_t_1);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_x_range.rcbuffer->pybuffer);
    __pyx_t_10 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_x_range.rcbuffer->pybuffer, (PyObject*)__pyx_t_18, &__Pyx_TypeInfo_nn___pyx_t_5numpy_uint16_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack);
    if (unlikely(__pyx_t_10 < 0)) {
      PyErr_Fetch(&__pyx_t_11, &__pyx_t_12, &__pyx_t_13);
      if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_x_range.rcbuffer->pybuffer, (PyObject*)__pyx_v_x_range, &__Pyx_TypeInfo_nn___pyx_t_5numpy_uint16_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_11); Py_XDECREF(__pyx_t_12); Py_XDECREF(__pyx_t_13);
        __Pyx_RaiseBufferFallbackError();
      } else {
        PyErr_Restore(__pyx_t_11, __pyx_t_12, __pyx_t_13);
      }
    }
    __pyx_pybuffernd_x_range.diminfo[0].strides = __pyx_pybuffernd_x_range.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_x_range.diminfo[0].shape = __pyx_pybuffernd_x_range.rcbuffer->pybuffer.shape[0];
    if (unlikely(__pyx_t_10 < 0)) __PYX_ERR(0, 2077, __pyx_L1_error)
  }
  __pyx_t_18 = 0;
  __pyx_v_x_range = ((PyArrayObject *)__pyx_t_1);
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":2078
 *     pix_to_compute = np.nonzero(computed_pixels[xmin:xmax, ymin:ymax] < 1)
 *     x_range = pix_to_compute[0].astype(np.uint16)
 *     y_range = pix_to_compute[1].astype(np.uint16)             # <<<<<<<<<<<<<<
 *     n = <int> len(x_range)
 * 
 */
  __pyx_t_5 = __Pyx_GetItemInt(__pyx_v_pix_to_compute, 1, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 2078, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_astype); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 2078, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 2078, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_uint16); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2078, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_5 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && likely(PyMethod_Check(__pyx_t_2))) {
    __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_2);
    if (likely(__pyx_t_5)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
      __Pyx_INCREF(__pyx_t_5);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_2, function);
    }
  }
  if (!__pyx_t_5) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_2, __pyx_t_4); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2078, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_3 = PyTuple_New(1+1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 2078, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_5); __pyx_t_5 = NULL;
    __Pyx_GIVEREF(__pyx_t_4);
    PyTuple_SET_ITEM(__pyx_t_3, 0+1, __pyx_t_4);
    __pyx_t_4 = 0;
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_3, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2078, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  }
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 2078, __pyx_L1_error)
  __pyx_t_18 = ((PyArrayObject *)__pyx_t_1);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_y_range.rcbuffer->pybuffer);
    __pyx_t_10 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_y_range.rcbuffer->pybuffer, (PyObject*)__pyx_t_18, &__Pyx_TypeInfo_nn___pyx_t_5numpy_uint16_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack);
    if (unlikely(__pyx_t_10 < 0)) {
      PyErr_Fetch(&__pyx_t_13, &__pyx_t_12, &__pyx_t_11);
      if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_y_range.rcbuffer->pybuffer, (PyObject*)__pyx_v_y_range, &__Pyx_TypeInfo_nn___pyx_t_5numpy_uint16_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_13); Py_XDECREF(__pyx_t_12); Py_XDECREF(__pyx_t_11);
        __Pyx_RaiseBufferFallbackError();
      } else {
        PyErr_Restore(__pyx_t_13, __pyx_t_12, __pyx_t_11);
      }
    }
    __pyx_pybuffernd_y_range.diminfo[0].strides = __pyx_pybuffernd_y_range.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_y_range.diminfo[0].shape = __pyx_pybuffernd_y_range.rcbuffer->pybuffer.shape[0];
    if (unlikely(__pyx_t_10 < 0)) __PYX_ERR(0, 2078, __pyx_L1_error)
  }
  __pyx_t_18 = 0;
  __pyx_v_y_range = ((PyArrayObject *)__pyx_t_1);
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":2079
 *     x_range = pix_to_compute[0].astype(np.uint16)
 *     y_range = pix_to_compute[1].astype(np.uint16)
 *     n = <int> len(x_range)             # <<<<<<<<<<<<<<
 * 
 *     with nogil:
 */
  __pyx_t_7 = PyObject_Length(((PyObject *)__pyx_v_x_range)); if (unlikely(__pyx_t_7 == -1)) __PYX_ERR(0, 2079, __pyx_L1_error)
  __pyx_v_n = ((int)__pyx_t_7);

  /* "orb/cutils.pyx":2081
 *     n = <int> len(x_range)
 * 
 *     with nogil:             # <<<<<<<<<<<<<<
 *         for ir in range(n):
 *             ii = <int> x_range[ir] + xmin
 */
  {
      #ifdef WITH_THREAD
      PyThreadState *_save;
      Py_UNBLOCK_THREADS
      #endif
      /*try:*/ {

        /* "orb/cutils.pyx":2082
 * 
 *     with nogil:
 *         for ir in range(n):             # <<<<<<<<<<<<<<
 *             ii = <int> x_range[ir] + xmin
 *             ij = <int> y_range[ir] + ymin
 */
        __pyx_t_10 = __pyx_v_n;
        for (__pyx_t_19 = 0; __pyx_t_19 < __pyx_t_10; __pyx_t_19+=1) {
          __pyx_v_ir = __pyx_t_19;

          /* "orb/cutils.pyx":2083
 *     with nogil:
 *         for ir in range(n):
 *             ii = <int> x_range[ir] + xmin             # <<<<<<<<<<<<<<
 *             ij = <int> y_range[ir] + ymin
 *             if computed_pixels[ii,ij] < 1:
 */
          __pyx_t_20 = __pyx_v_ir;
          __pyx_v_ii = (((int)(*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_uint16_t *, __pyx_pybuffernd_x_range.rcbuffer->pybuffer.buf, __pyx_t_20, __pyx_pybuffernd_x_range.diminfo[0].strides))) + __pyx_v_xmin);

          /* "orb/cutils.pyx":2084
 *         for ir in range(n):
 *             ii = <int> x_range[ir] + xmin
 *             ij = <int> y_range[ir] + ymin             # <<<<<<<<<<<<<<
 *             if computed_pixels[ii,ij] < 1:
 *                 if isnan(im[ii,ij]): index = -1
 */
          __pyx_t_21 = __pyx_v_ir;
          __pyx_v_ij = (((int)(*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_uint16_t *, __pyx_pybuffernd_y_range.rcbuffer->pybuffer.buf, __pyx_t_21, __pyx_pybuffernd_y_range.diminfo[0].strides))) + __pyx_v_ymin);

          /* "orb/cutils.pyx":2085
 *             ii = <int> x_range[ir] + xmin
 *             ij = <int> y_range[ir] + ymin
 *             if computed_pixels[ii,ij] < 1:             # <<<<<<<<<<<<<<
 *                 if isnan(im[ii,ij]): index = -1
 *                 elif im[ii,ij] <= vmin: index = 0
 */
          __pyx_t_22 = __pyx_v_ii;
          __pyx_t_23 = __pyx_v_ij;
          __pyx_t_16 = (((*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_uint8_t *, __pyx_pybuffernd_computed_pixels.rcbuffer->pybuffer.buf, __pyx_t_22, __pyx_pybuffernd_computed_pixels.diminfo[0].strides, __pyx_t_23, __pyx_pybuffernd_computed_pixels.diminfo[1].strides)) < 1) != 0);
          if (__pyx_t_16) {

            /* "orb/cutils.pyx":2086
 *             ij = <int> y_range[ir] + ymin
 *             if computed_pixels[ii,ij] < 1:
 *                 if isnan(im[ii,ij]): index = -1             # <<<<<<<<<<<<<<
 *                 elif im[ii,ij] <= vmin: index = 0
 *                 elif im[ii,ij] >= vmax: index = res - 1
 */
            __pyx_t_24 = __pyx_v_ii;
            __pyx_t_25 = __pyx_v_ij;
            __pyx_t_16 = (isnan((*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_im.rcbuffer->pybuffer.buf, __pyx_t_24, __pyx_pybuffernd_im.diminfo[0].strides, __pyx_t_25, __pyx_pybuffernd_im.diminfo[1].strides))) != 0);
            if (__pyx_t_16) {
              __pyx_v_index = -1;
              goto __pyx_L10;
            }

            /* "orb/cutils.pyx":2087
 *             if computed_pixels[ii,ij] < 1:
 *                 if isnan(im[ii,ij]): index = -1
 *                 elif im[ii,ij] <= vmin: index = 0             # <<<<<<<<<<<<<<
 *                 elif im[ii,ij] >= vmax: index = res - 1
 *                 else:
 */
            __pyx_t_26 = __pyx_v_ii;
            __pyx_t_27 = __pyx_v_ij;
            __pyx_t_16 = (((*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_im.rcbuffer->pybuffer.buf, __pyx_t_26, __pyx_pybuffernd_im.diminfo[0].strides, __pyx_t_27, __pyx_pybuffernd_im.diminfo[1].strides)) <= __pyx_v_vmin) != 0);
            if (__pyx_t_16) {
              __pyx_v_index = 0;
              goto __pyx_L10;
            }

            /* "orb/cutils.pyx":2088
 *                 if isnan(im[ii,ij]): index = -1
 *                 elif im[ii,ij] <= vmin: index = 0
 *                 elif im[ii,ij] >= vmax: index = res - 1             # <<<<<<<<<<<<<<
 *                 else:
 *                     index = <int> (((im[ii,ij] - vmin) / (vmax - vmin)) * (res - 1))
 */
            __pyx_t_28 = __pyx_v_ii;
            __pyx_t_29 = __pyx_v_ij;
            __pyx_t_16 = (((*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_im.rcbuffer->pybuffer.buf, __pyx_t_28, __pyx_pybuffernd_im.diminfo[0].strides, __pyx_t_29, __pyx_pybuffernd_im.diminfo[1].strides)) >= __pyx_v_vmax) != 0);
            if (__pyx_t_16) {
              __pyx_v_index = (__pyx_v_res - 1);
              goto __pyx_L10;
            }

            /* "orb/cutils.pyx":2090
 *                 elif im[ii,ij] >= vmax: index = res - 1
 *                 else:
 *                     index = <int> (((im[ii,ij] - vmin) / (vmax - vmin)) * (res - 1))             # <<<<<<<<<<<<<<
 *                 for ik in range(3):
 *                     if index < 0:
 */
            /*else*/ {
              __pyx_t_30 = __pyx_v_ii;
              __pyx_t_31 = __pyx_v_ij;
              __pyx_t_32 = ((*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_im.rcbuffer->pybuffer.buf, __pyx_t_30, __pyx_pybuffernd_im.diminfo[0].strides, __pyx_t_31, __pyx_pybuffernd_im.diminfo[1].strides)) - __pyx_v_vmin);
              __pyx_t_33 = (__pyx_v_vmax - __pyx_v_vmin);
              if (unlikely(__pyx_t_33 == 0)) {
                #ifdef WITH_THREAD
                PyGILState_STATE __pyx_gilstate_save = PyGILState_Ensure();
                #endif
                PyErr_SetString(PyExc_ZeroDivisionError, "float division");
                #ifdef WITH_THREAD
                PyGILState_Release(__pyx_gilstate_save);
                #endif
                __PYX_ERR(0, 2090, __pyx_L5_error)
              }
              __pyx_v_index = ((int)((__pyx_t_32 / __pyx_t_33) * (__pyx_v_res - 1)));
            }
            __pyx_L10:;

            /* "orb/cutils.pyx":2091
 *                 else:
 *                     index = <int> (((im[ii,ij] - vmin) / (vmax - vmin)) * (res - 1))
 *                 for ik in range(3):             # <<<<<<<<<<<<<<
 *                     if index < 0:
 *                         arr8[ij,ii,ik] = 255
 */
            for (__pyx_t_34 = 0; __pyx_t_34 < 3; __pyx_t_34+=1) {
              __pyx_v_ik = __pyx_t_34;

              /* "orb/cutils.pyx":2092
 *                     index = <int> (((im[ii,ij] - vmin) / (vmax - vmin)) * (res - 1))
 *                 for ik in range(3):
 *                     if index < 0:             # <<<<<<<<<<<<<<
 *                         arr8[ij,ii,ik] = 255
 *                     else:
 */
              __pyx_t_16 = ((__pyx_v_index < 0) != 0);
              if (__pyx_t_16) {

                /* "orb/cutils.pyx":2093
 *                 for ik in range(3):
 *                     if index < 0:
 *                         arr8[ij,ii,ik] = 255             # <<<<<<<<<<<<<<
 *                     else:
 *                         arr8[ij,ii,ik] = color_mapper[index, ik]
 */
                __pyx_t_35 = __pyx_v_ij;
                __pyx_t_36 = __pyx_v_ii;
                __pyx_t_37 = __pyx_v_ik;
                *__Pyx_BufPtrStrided3d(__pyx_t_5numpy_uint8_t *, __pyx_pybuffernd_arr8.rcbuffer->pybuffer.buf, __pyx_t_35, __pyx_pybuffernd_arr8.diminfo[0].strides, __pyx_t_36, __pyx_pybuffernd_arr8.diminfo[1].strides, __pyx_t_37, __pyx_pybuffernd_arr8.diminfo[2].strides) = 0xFF;

                /* "orb/cutils.pyx":2092
 *                     index = <int> (((im[ii,ij] - vmin) / (vmax - vmin)) * (res - 1))
 *                 for ik in range(3):
 *                     if index < 0:             # <<<<<<<<<<<<<<
 *                         arr8[ij,ii,ik] = 255
 *                     else:
 */
                goto __pyx_L13;
              }

              /* "orb/cutils.pyx":2095
 *                         arr8[ij,ii,ik] = 255
 *                     else:
 *                         arr8[ij,ii,ik] = color_mapper[index, ik]             # <<<<<<<<<<<<<<
 * 
 *     return arr8
 */
              /*else*/ {
                __pyx_t_38 = __pyx_v_index;
                __pyx_t_39 = __pyx_v_ik;
                __pyx_t_40 = __pyx_v_ij;
                __pyx_t_41 = __pyx_v_ii;
                __pyx_t_42 = __pyx_v_ik;
                *__Pyx_BufPtrStrided3d(__pyx_t_5numpy_uint8_t *, __pyx_pybuffernd_arr8.rcbuffer->pybuffer.buf, __pyx_t_40, __pyx_pybuffernd_arr8.diminfo[0].strides, __pyx_t_41, __pyx_pybuffernd_arr8.diminfo[1].strides, __pyx_t_42, __pyx_pybuffernd_arr8.diminfo[2].strides) = (*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_uint8_t *, __pyx_pybuffernd_color_mapper.rcbuffer->pybuffer.buf, __pyx_t_38, __pyx_pybuffernd_color_mapper.diminfo[0].strides, __pyx_t_39, __pyx_pybuffernd_color_mapper.diminfo[1].strides));
              }
              __pyx_L13:;
            }

            /* "orb/cutils.pyx":2085
 *             ii = <int> x_range[ir] + xmin
 *             ij = <int> y_range[ir] + ymin
 *             if computed_pixels[ii,ij] < 1:             # <<<<<<<<<<<<<<
 *                 if isnan(im[ii,ij]): index = -1
 *                 elif im[ii,ij] <= vmin: index = 0
 */
          }
        }
      }

      /* "orb/cutils.pyx":2081
 *     n = <int> len(x_range)
 * 
 *     with nogil:             # <<<<<<<<<<<<<<
 *         for ir in range(n):
 *             ii = <int> x_range[ir] + xmin
 */
      /*finally:*/ {
        /*normal exit:*/{
          #ifdef WITH_THREAD
          Py_BLOCK_THREADS
          #endif
          goto __pyx_L6;
        }
        __pyx_L5_error: {
          #ifdef WITH_THREAD
          Py_BLOCK_THREADS
          #endif
          goto __pyx_L1_error;
        }
        __pyx_L6:;
      }
  }

  /* "orb/cutils.pyx":2097
 *                         arr8[ij,ii,ik] = color_mapper[index, ik]
 * 
 *     return arr8             # <<<<<<<<<<<<<<
 * 
 * @cython.boundscheck(False)
 */
  __Pyx_XDECREF(__pyx_r);
  __Pyx_INCREF(((PyObject *)__pyx_v_arr8));
  __pyx_r = ((PyObject *)__pyx_v_arr8);
  goto __pyx_L0;

  /* "orb/cutils.pyx":2034
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def im2rgba(np.ndarray[np.float64_t, ndim=2] im,             # <<<<<<<<<<<<<<
 *             mpl_colorbar,
 *             double vmin, double vmax,
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_1);
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_XDECREF(__pyx_t_5);
  __Pyx_XDECREF(__pyx_t_6);
  __Pyx_XDECREF(__pyx_t_8);
  { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
    __Pyx_PyThreadState_declare
    __Pyx_PyThreadState_assign
    __Pyx_ErrFetch(&__pyx_type, &__pyx_value, &__pyx_tb);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_arr8.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_color_mapper.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_color_values.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_computed_pixels.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_im.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_x_range.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_y_range.rcbuffer->pybuffer);
  __Pyx_ErrRestore(__pyx_type, __pyx_value, __pyx_tb);}
  __Pyx_AddTraceback("orb.cutils.im2rgba", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  goto __pyx_L2;
  __pyx_L0:;
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_arr8.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_color_mapper.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_color_values.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_computed_pixels.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_im.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_x_range.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_y_range.rcbuffer->pybuffer);
  __pyx_L2:;
  __Pyx_XDECREF((PyObject *)__pyx_v_color_values);
  __Pyx_XDECREF((PyObject *)__pyx_v_color_mapper);
  __Pyx_XDECREF((PyObject *)__pyx_v_arr8);
  __Pyx_XDECREF((PyObject *)__pyx_v_x_range);
  __Pyx_XDECREF((PyObject *)__pyx_v_y_range);
  __Pyx_XDECREF(__pyx_v_pix_to_compute);
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":2101
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def brute_photometry(np.ndarray[np.float64_t, ndim=2] im,             # <<<<<<<<<<<<<<
 *                      np.ndarray[np.float64_t, ndim=2] star_list,
 *                      np.ndarray[np.float64_t, ndim=2] kernel,
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_75brute_photometry(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_3orb_6cutils_74brute_photometry[] = "brute_photometry(ndarray im, ndarray star_list, ndarray kernel, int box_size)";
static PyMethodDef __pyx_mdef_3orb_6cutils_75brute_photometry = {"brute_photometry", (PyCFunction)__pyx_pw_3orb_6cutils_75brute_photometry, METH_VARARGS|METH_KEYWORDS, __pyx_doc_3orb_6cutils_74brute_photometry};
static PyObject *__pyx_pw_3orb_6cutils_75brute_photometry(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  PyArrayObject *__pyx_v_im = 0;
  PyArrayObject *__pyx_v_star_list = 0;
  PyArrayObject *__pyx_v_kernel = 0;
  int __pyx_v_box_size;
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("brute_photometry (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_im,&__pyx_n_s_star_list,&__pyx_n_s_kernel,&__pyx_n_s_box_size,0};
    PyObject* values[4] = {0,0,0,0};
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
      switch (pos_args) {
        case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = PyDict_Size(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_im)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        case  1:
        if (likely((values[1] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_star_list)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("brute_photometry", 1, 4, 4, 1); __PYX_ERR(0, 2101, __pyx_L3_error)
        }
        case  2:
        if (likely((values[2] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_kernel)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("brute_photometry", 1, 4, 4, 2); __PYX_ERR(0, 2101, __pyx_L3_error)
        }
        case  3:
        if (likely((values[3] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_box_size)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("brute_photometry", 1, 4, 4, 3); __PYX_ERR(0, 2101, __pyx_L3_error)
        }
      }
      if (unlikely(kw_args > 0)) {
        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "brute_photometry") < 0)) __PYX_ERR(0, 2101, __pyx_L3_error)
      }
    } else if (PyTuple_GET_SIZE(__pyx_args) != 4) {
      goto __pyx_L5_argtuple_error;
    } else {
      values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
      values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
      values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
      values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
    }
    __pyx_v_im = ((PyArrayObject *)values[0]);
    __pyx_v_star_list = ((PyArrayObject *)values[1]);
    __pyx_v_kernel = ((PyArrayObject *)values[2]);
    __pyx_v_box_size = __Pyx_PyInt_As_int(values[3]); if (unlikely((__pyx_v_box_size == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 2104, __pyx_L3_error)
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  __Pyx_RaiseArgtupleInvalid("brute_photometry", 1, 4, 4, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 2101, __pyx_L3_error)
  __pyx_L3_error:;
  __Pyx_AddTraceback("orb.cutils.brute_photometry", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __Pyx_RefNannyFinishContext();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_im), __pyx_ptype_5numpy_ndarray, 1, "im", 0))) __PYX_ERR(0, 2101, __pyx_L1_error)
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_star_list), __pyx_ptype_5numpy_ndarray, 1, "star_list", 0))) __PYX_ERR(0, 2102, __pyx_L1_error)
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_kernel), __pyx_ptype_5numpy_ndarray, 1, "kernel", 0))) __PYX_ERR(0, 2103, __pyx_L1_error)
  __pyx_r = __pyx_pf_3orb_6cutils_74brute_photometry(__pyx_self, __pyx_v_im, __pyx_v_star_list, __pyx_v_kernel, __pyx_v_box_size);

  /* function exit code */
  goto __pyx_L0;
  __pyx_L1_error:;
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_74brute_photometry(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_im, PyArrayObject *__pyx_v_star_list, PyArrayObject *__pyx_v_kernel, int __pyx_v_box_size) {
  double __pyx_v_total_flux;
  int __pyx_v_star_nb;
  int __pyx_v_istar;
  int __pyx_v_x_min;
  int __pyx_v_y_min;
  int __pyx_v_dimx;
  int __pyx_v_dimy;
  int __pyx_v_ii;
  int __pyx_v_ij;
  double __pyx_v_ix;
  double __pyx_v_iy;
  double __pyx_v_val;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_im;
  __Pyx_Buffer __pyx_pybuffer_im;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_kernel;
  __Pyx_Buffer __pyx_pybuffer_kernel;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_star_list;
  __Pyx_Buffer __pyx_pybuffer_star_list;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  int __pyx_t_1;
  int __pyx_t_2;
  Py_ssize_t __pyx_t_3;
  Py_ssize_t __pyx_t_4;
  Py_ssize_t __pyx_t_5;
  Py_ssize_t __pyx_t_6;
  int __pyx_t_7;
  int __pyx_t_8;
  int __pyx_t_9;
  int __pyx_t_10;
  int __pyx_t_11;
  int __pyx_t_12;
  Py_ssize_t __pyx_t_13;
  Py_ssize_t __pyx_t_14;
  Py_ssize_t __pyx_t_15;
  Py_ssize_t __pyx_t_16;
  PyObject *__pyx_t_17 = NULL;
  __Pyx_RefNannySetupContext("brute_photometry", 0);
  __pyx_pybuffer_im.pybuffer.buf = NULL;
  __pyx_pybuffer_im.refcount = 0;
  __pyx_pybuffernd_im.data = NULL;
  __pyx_pybuffernd_im.rcbuffer = &__pyx_pybuffer_im;
  __pyx_pybuffer_star_list.pybuffer.buf = NULL;
  __pyx_pybuffer_star_list.refcount = 0;
  __pyx_pybuffernd_star_list.data = NULL;
  __pyx_pybuffernd_star_list.rcbuffer = &__pyx_pybuffer_star_list;
  __pyx_pybuffer_kernel.pybuffer.buf = NULL;
  __pyx_pybuffer_kernel.refcount = 0;
  __pyx_pybuffernd_kernel.data = NULL;
  __pyx_pybuffernd_kernel.rcbuffer = &__pyx_pybuffer_kernel;
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_im.rcbuffer->pybuffer, (PyObject*)__pyx_v_im, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) __PYX_ERR(0, 2101, __pyx_L1_error)
  }
  __pyx_pybuffernd_im.diminfo[0].strides = __pyx_pybuffernd_im.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_im.diminfo[0].shape = __pyx_pybuffernd_im.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_im.diminfo[1].strides = __pyx_pybuffernd_im.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_im.diminfo[1].shape = __pyx_pybuffernd_im.rcbuffer->pybuffer.shape[1];
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_star_list.rcbuffer->pybuffer, (PyObject*)__pyx_v_star_list, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) __PYX_ERR(0, 2101, __pyx_L1_error)
  }
  __pyx_pybuffernd_star_list.diminfo[0].strides = __pyx_pybuffernd_star_list.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_star_list.diminfo[0].shape = __pyx_pybuffernd_star_list.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_star_list.diminfo[1].strides = __pyx_pybuffernd_star_list.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_star_list.diminfo[1].shape = __pyx_pybuffernd_star_list.rcbuffer->pybuffer.shape[1];
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_kernel.rcbuffer->pybuffer, (PyObject*)__pyx_v_kernel, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) __PYX_ERR(0, 2101, __pyx_L1_error)
  }
  __pyx_pybuffernd_kernel.diminfo[0].strides = __pyx_pybuffernd_kernel.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_kernel.diminfo[0].shape = __pyx_pybuffernd_kernel.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_kernel.diminfo[1].strides = __pyx_pybuffernd_kernel.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_kernel.diminfo[1].shape = __pyx_pybuffernd_kernel.rcbuffer->pybuffer.shape[1];

  /* "orb/cutils.pyx":2106
 *                      int box_size):
 * 
 *     cdef double total_flux = 0.             # <<<<<<<<<<<<<<
 *     cdef int star_nb = star_list.shape[0]
 *     cdef int istar
 */
  __pyx_v_total_flux = 0.;

  /* "orb/cutils.pyx":2107
 * 
 *     cdef double total_flux = 0.
 *     cdef int star_nb = star_list.shape[0]             # <<<<<<<<<<<<<<
 *     cdef int istar
 *     cdef int x_min, x_max, y_min, y_max
 */
  __pyx_v_star_nb = (__pyx_v_star_list->dimensions[0]);

  /* "orb/cutils.pyx":2110
 *     cdef int istar
 *     cdef int x_min, x_max, y_min, y_max
 *     cdef int dimx = im.shape[0]             # <<<<<<<<<<<<<<
 *     cdef int dimy = im.shape[1]
 *     cdef int ii, ij
 */
  __pyx_v_dimx = (__pyx_v_im->dimensions[0]);

  /* "orb/cutils.pyx":2111
 *     cdef int x_min, x_max, y_min, y_max
 *     cdef int dimx = im.shape[0]
 *     cdef int dimy = im.shape[1]             # <<<<<<<<<<<<<<
 *     cdef int ii, ij
 *     cdef double ix, iy
 */
  __pyx_v_dimy = (__pyx_v_im->dimensions[1]);

  /* "orb/cutils.pyx":2116
 *     cdef double val
 * 
 *     with nogil:             # <<<<<<<<<<<<<<
 *         for istar in range(star_nb):
 *             ix = star_list[istar,0]
 */
  {
      #ifdef WITH_THREAD
      PyThreadState *_save;
      Py_UNBLOCK_THREADS
      #endif
      /*try:*/ {

        /* "orb/cutils.pyx":2117
 * 
 *     with nogil:
 *         for istar in range(star_nb):             # <<<<<<<<<<<<<<
 *             ix = star_list[istar,0]
 *             iy = star_list[istar,1]
 */
        __pyx_t_1 = __pyx_v_star_nb;
        for (__pyx_t_2 = 0; __pyx_t_2 < __pyx_t_1; __pyx_t_2+=1) {
          __pyx_v_istar = __pyx_t_2;

          /* "orb/cutils.pyx":2118
 *     with nogil:
 *         for istar in range(star_nb):
 *             ix = star_list[istar,0]             # <<<<<<<<<<<<<<
 *             iy = star_list[istar,1]
 *             if not isnan(ix) and not isnan(iy):
 */
          __pyx_t_3 = __pyx_v_istar;
          __pyx_t_4 = 0;
          __pyx_v_ix = (*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_star_list.rcbuffer->pybuffer.buf, __pyx_t_3, __pyx_pybuffernd_star_list.diminfo[0].strides, __pyx_t_4, __pyx_pybuffernd_star_list.diminfo[1].strides));

          /* "orb/cutils.pyx":2119
 *         for istar in range(star_nb):
 *             ix = star_list[istar,0]
 *             iy = star_list[istar,1]             # <<<<<<<<<<<<<<
 *             if not isnan(ix) and not isnan(iy):
 *                 x_min = <int> (ix - box_size/2)
 */
          __pyx_t_5 = __pyx_v_istar;
          __pyx_t_6 = 1;
          __pyx_v_iy = (*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_star_list.rcbuffer->pybuffer.buf, __pyx_t_5, __pyx_pybuffernd_star_list.diminfo[0].strides, __pyx_t_6, __pyx_pybuffernd_star_list.diminfo[1].strides));

          /* "orb/cutils.pyx":2120
 *             ix = star_list[istar,0]
 *             iy = star_list[istar,1]
 *             if not isnan(ix) and not isnan(iy):             # <<<<<<<<<<<<<<
 *                 x_min = <int> (ix - box_size/2)
 *                 y_min = <int> (iy - box_size/2)
 */
          __pyx_t_8 = ((!(isnan(__pyx_v_ix) != 0)) != 0);
          if (__pyx_t_8) {
          } else {
            __pyx_t_7 = __pyx_t_8;
            goto __pyx_L9_bool_binop_done;
          }
          __pyx_t_8 = ((!(isnan(__pyx_v_iy) != 0)) != 0);
          __pyx_t_7 = __pyx_t_8;
          __pyx_L9_bool_binop_done:;
          if (__pyx_t_7) {

            /* "orb/cutils.pyx":2121
 *             iy = star_list[istar,1]
 *             if not isnan(ix) and not isnan(iy):
 *                 x_min = <int> (ix - box_size/2)             # <<<<<<<<<<<<<<
 *                 y_min = <int> (iy - box_size/2)
 * 
 */
            __pyx_v_x_min = ((int)(__pyx_v_ix - __Pyx_div_long(__pyx_v_box_size, 2)));

            /* "orb/cutils.pyx":2122
 *             if not isnan(ix) and not isnan(iy):
 *                 x_min = <int> (ix - box_size/2)
 *                 y_min = <int> (iy - box_size/2)             # <<<<<<<<<<<<<<
 * 
 *                 if (ix + box_size < dimx
 */
            __pyx_v_y_min = ((int)(__pyx_v_iy - __Pyx_div_long(__pyx_v_box_size, 2)));

            /* "orb/cutils.pyx":2124
 *                 y_min = <int> (iy - box_size/2)
 * 
 *                 if (ix + box_size < dimx             # <<<<<<<<<<<<<<
 *                     and iy + box_size < dimy
 *                     and x_min > 0
 */
            __pyx_t_8 = (((__pyx_v_ix + __pyx_v_box_size) < __pyx_v_dimx) != 0);
            if (__pyx_t_8) {
            } else {
              __pyx_t_7 = __pyx_t_8;
              goto __pyx_L12_bool_binop_done;
            }

            /* "orb/cutils.pyx":2125
 * 
 *                 if (ix + box_size < dimx
 *                     and iy + box_size < dimy             # <<<<<<<<<<<<<<
 *                     and x_min > 0
 *                     and y_min > 0):
 */
            __pyx_t_8 = (((__pyx_v_iy + __pyx_v_box_size) < __pyx_v_dimy) != 0);
            if (__pyx_t_8) {
            } else {
              __pyx_t_7 = __pyx_t_8;
              goto __pyx_L12_bool_binop_done;
            }

            /* "orb/cutils.pyx":2126
 *                 if (ix + box_size < dimx
 *                     and iy + box_size < dimy
 *                     and x_min > 0             # <<<<<<<<<<<<<<
 *                     and y_min > 0):
 *                     for ii in range(box_size):
 */
            __pyx_t_8 = ((__pyx_v_x_min > 0) != 0);
            if (__pyx_t_8) {
            } else {
              __pyx_t_7 = __pyx_t_8;
              goto __pyx_L12_bool_binop_done;
            }

            /* "orb/cutils.pyx":2127
 *                     and iy + box_size < dimy
 *                     and x_min > 0
 *                     and y_min > 0):             # <<<<<<<<<<<<<<
 *                     for ii in range(box_size):
 *                         for ij in range(box_size):
 */
            __pyx_t_8 = ((__pyx_v_y_min > 0) != 0);
            __pyx_t_7 = __pyx_t_8;
            __pyx_L12_bool_binop_done:;

            /* "orb/cutils.pyx":2124
 *                 y_min = <int> (iy - box_size/2)
 * 
 *                 if (ix + box_size < dimx             # <<<<<<<<<<<<<<
 *                     and iy + box_size < dimy
 *                     and x_min > 0
 */
            if (__pyx_t_7) {

              /* "orb/cutils.pyx":2128
 *                     and x_min > 0
 *                     and y_min > 0):
 *                     for ii in range(box_size):             # <<<<<<<<<<<<<<
 *                         for ij in range(box_size):
 *                             val = (im[x_min+ii, y_min+ij]
 */
              __pyx_t_9 = __pyx_v_box_size;
              for (__pyx_t_10 = 0; __pyx_t_10 < __pyx_t_9; __pyx_t_10+=1) {
                __pyx_v_ii = __pyx_t_10;

                /* "orb/cutils.pyx":2129
 *                     and y_min > 0):
 *                     for ii in range(box_size):
 *                         for ij in range(box_size):             # <<<<<<<<<<<<<<
 *                             val = (im[x_min+ii, y_min+ij]
 *                                    * kernel[ii, ij])
 */
                __pyx_t_11 = __pyx_v_box_size;
                for (__pyx_t_12 = 0; __pyx_t_12 < __pyx_t_11; __pyx_t_12+=1) {
                  __pyx_v_ij = __pyx_t_12;

                  /* "orb/cutils.pyx":2130
 *                     for ii in range(box_size):
 *                         for ij in range(box_size):
 *                             val = (im[x_min+ii, y_min+ij]             # <<<<<<<<<<<<<<
 *                                    * kernel[ii, ij])
 *                             if not isnan(val):
 */
                  __pyx_t_13 = (__pyx_v_x_min + __pyx_v_ii);
                  __pyx_t_14 = (__pyx_v_y_min + __pyx_v_ij);

                  /* "orb/cutils.pyx":2131
 *                         for ij in range(box_size):
 *                             val = (im[x_min+ii, y_min+ij]
 *                                    * kernel[ii, ij])             # <<<<<<<<<<<<<<
 *                             if not isnan(val):
 *                                 total_flux += val
 */
                  __pyx_t_15 = __pyx_v_ii;
                  __pyx_t_16 = __pyx_v_ij;
                  __pyx_v_val = ((*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_im.rcbuffer->pybuffer.buf, __pyx_t_13, __pyx_pybuffernd_im.diminfo[0].strides, __pyx_t_14, __pyx_pybuffernd_im.diminfo[1].strides)) * (*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_kernel.rcbuffer->pybuffer.buf, __pyx_t_15, __pyx_pybuffernd_kernel.diminfo[0].strides, __pyx_t_16, __pyx_pybuffernd_kernel.diminfo[1].strides)));

                  /* "orb/cutils.pyx":2132
 *                             val = (im[x_min+ii, y_min+ij]
 *                                    * kernel[ii, ij])
 *                             if not isnan(val):             # <<<<<<<<<<<<<<
 *                                 total_flux += val
 *     return total_flux
 */
                  __pyx_t_7 = ((!(isnan(__pyx_v_val) != 0)) != 0);
                  if (__pyx_t_7) {

                    /* "orb/cutils.pyx":2133
 *                                    * kernel[ii, ij])
 *                             if not isnan(val):
 *                                 total_flux += val             # <<<<<<<<<<<<<<
 *     return total_flux
 * 
 */
                    __pyx_v_total_flux = (__pyx_v_total_flux + __pyx_v_val);

                    /* "orb/cutils.pyx":2132
 *                             val = (im[x_min+ii, y_min+ij]
 *                                    * kernel[ii, ij])
 *                             if not isnan(val):             # <<<<<<<<<<<<<<
 *                                 total_flux += val
 *     return total_flux
 */
                  }
                }
              }

              /* "orb/cutils.pyx":2124
 *                 y_min = <int> (iy - box_size/2)
 * 
 *                 if (ix + box_size < dimx             # <<<<<<<<<<<<<<
 *                     and iy + box_size < dimy
 *                     and x_min > 0
 */
            }

            /* "orb/cutils.pyx":2120
 *             ix = star_list[istar,0]
 *             iy = star_list[istar,1]
 *             if not isnan(ix) and not isnan(iy):             # <<<<<<<<<<<<<<
 *                 x_min = <int> (ix - box_size/2)
 *                 y_min = <int> (iy - box_size/2)
 */
          }
        }
      }

      /* "orb/cutils.pyx":2116
 *     cdef double val
 * 
 *     with nogil:             # <<<<<<<<<<<<<<
 *         for istar in range(star_nb):
 *             ix = star_list[istar,0]
 */
      /*finally:*/ {
        /*normal exit:*/{
          #ifdef WITH_THREAD
          Py_BLOCK_THREADS
          #endif
          goto __pyx_L5;
        }
        __pyx_L5:;
      }
  }

  /* "orb/cutils.pyx":2134
 *                             if not isnan(val):
 *                                 total_flux += val
 *     return total_flux             # <<<<<<<<<<<<<<
 * 
 * @cython.boundscheck(False)
 */
  __Pyx_XDECREF(__pyx_r);
  __pyx_t_17 = PyFloat_FromDouble(__pyx_v_total_flux); if (unlikely(!__pyx_t_17)) __PYX_ERR(0, 2134, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_17);
  __pyx_r = __pyx_t_17;
  __pyx_t_17 = 0;
  goto __pyx_L0;

  /* "orb/cutils.pyx":2101
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def brute_photometry(np.ndarray[np.float64_t, ndim=2] im,             # <<<<<<<<<<<<<<
 *                      np.ndarray[np.float64_t, ndim=2] star_list,
 *                      np.ndarray[np.float64_t, ndim=2] kernel,
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_17);
  { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
    __Pyx_PyThreadState_declare
    __Pyx_PyThreadState_assign
    __Pyx_ErrFetch(&__pyx_type, &__pyx_value, &__pyx_tb);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_im.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_kernel.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_star_list.rcbuffer->pybuffer);
  __Pyx_ErrRestore(__pyx_type, __pyx_value, __pyx_tb);}
  __Pyx_AddTraceback("orb.cutils.brute_photometry", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  goto __pyx_L2;
  __pyx_L0:;
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_im.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_kernel.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_star_list.rcbuffer->pybuffer);
  __pyx_L2:;
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":2138
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def detect_cosmic_rays(np.ndarray[np.float64_t, ndim=2] frame,             # <<<<<<<<<<<<<<
 *                        crs_list, int box_size, double detect_coeff):
 *     """Check if a given pixel is a cosmic ray (classic detection).
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_77detect_cosmic_rays(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_3orb_6cutils_76detect_cosmic_rays[] = "detect_cosmic_rays(ndarray frame, crs_list, int box_size, double detect_coeff)\nCheck if a given pixel is a cosmic ray (classic detection).\n    \n    classic detection: pixel value is checked against standard\n    deviation of values in a box around the pixel.\n\n    :param frame: Frame to check\n    \n    :param crs_list: List of pixels to check\n    \n    :param box_size: Size of the box in pixels\n    \n    :param detect_coeff: Coefficient of detection (number of sigmas\n      threshold)\n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_77detect_cosmic_rays = {"detect_cosmic_rays", (PyCFunction)__pyx_pw_3orb_6cutils_77detect_cosmic_rays, METH_VARARGS|METH_KEYWORDS, __pyx_doc_3orb_6cutils_76detect_cosmic_rays};
static PyObject *__pyx_pw_3orb_6cutils_77detect_cosmic_rays(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  PyArrayObject *__pyx_v_frame = 0;
  PyObject *__pyx_v_crs_list = 0;
  int __pyx_v_box_size;
  double __pyx_v_detect_coeff;
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("detect_cosmic_rays (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_frame,&__pyx_n_s_crs_list,&__pyx_n_s_box_size,&__pyx_n_s_detect_coeff,0};
    PyObject* values[4] = {0,0,0,0};
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
      switch (pos_args) {
        case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = PyDict_Size(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_frame)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        case  1:
        if (likely((values[1] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_crs_list)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("detect_cosmic_rays", 1, 4, 4, 1); __PYX_ERR(0, 2138, __pyx_L3_error)
        }
        case  2:
        if (likely((values[2] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_box_size)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("detect_cosmic_rays", 1, 4, 4, 2); __PYX_ERR(0, 2138, __pyx_L3_error)
        }
        case  3:
        if (likely((values[3] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_detect_coeff)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("detect_cosmic_rays", 1, 4, 4, 3); __PYX_ERR(0, 2138, __pyx_L3_error)
        }
      }
      if (unlikely(kw_args > 0)) {
        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "detect_cosmic_rays") < 0)) __PYX_ERR(0, 2138, __pyx_L3_error)
      }
    } else if (PyTuple_GET_SIZE(__pyx_args) != 4) {
      goto __pyx_L5_argtuple_error;
    } else {
      values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
      values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
      values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
      values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
    }
    __pyx_v_frame = ((PyArrayObject *)values[0]);
    __pyx_v_crs_list = values[1];
    __pyx_v_box_size = __Pyx_PyInt_As_int(values[2]); if (unlikely((__pyx_v_box_size == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 2139, __pyx_L3_error)
    __pyx_v_detect_coeff = __pyx_PyFloat_AsDouble(values[3]); if (unlikely((__pyx_v_detect_coeff == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 2139, __pyx_L3_error)
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  __Pyx_RaiseArgtupleInvalid("detect_cosmic_rays", 1, 4, 4, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 2138, __pyx_L3_error)
  __pyx_L3_error:;
  __Pyx_AddTraceback("orb.cutils.detect_cosmic_rays", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __Pyx_RefNannyFinishContext();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_frame), __pyx_ptype_5numpy_ndarray, 1, "frame", 0))) __PYX_ERR(0, 2138, __pyx_L1_error)
  __pyx_r = __pyx_pf_3orb_6cutils_76detect_cosmic_rays(__pyx_self, __pyx_v_frame, __pyx_v_crs_list, __pyx_v_box_size, __pyx_v_detect_coeff);

  /* function exit code */
  goto __pyx_L0;
  __pyx_L1_error:;
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_76detect_cosmic_rays(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_frame, PyObject *__pyx_v_crs_list, int __pyx_v_box_size, double __pyx_v_detect_coeff) {
  PyArrayObject *__pyx_v_workframe = 0;
  PyArrayObject *__pyx_v_cr_map = 0;
  int __pyx_v_cr_list_len;
  int __pyx_v_icr;
  int __pyx_v_ix;
  int __pyx_v_iy;
  int __pyx_v_xmin;
  int __pyx_v_xmax;
  int __pyx_v_ymin;
  int __pyx_v_ymax;
  double __pyx_v_boxmed;
  double __pyx_v_boxstd;
  PyArrayObject *__pyx_v_box = 0;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_box;
  __Pyx_Buffer __pyx_pybuffer_box;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_cr_map;
  __Pyx_Buffer __pyx_pybuffer_cr_map;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_frame;
  __Pyx_Buffer __pyx_pybuffer_frame;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_workframe;
  __Pyx_Buffer __pyx_pybuffer_workframe;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  PyObject *__pyx_t_1 = NULL;
  PyObject *__pyx_t_2 = NULL;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  PyArrayObject *__pyx_t_5 = NULL;
  PyObject *__pyx_t_6 = NULL;
  PyArrayObject *__pyx_t_7 = NULL;
  Py_ssize_t __pyx_t_8;
  int __pyx_t_9;
  int __pyx_t_10;
  int __pyx_t_11;
  PyObject *__pyx_t_12 = NULL;
  PyObject *__pyx_t_13 = NULL;
  PyObject *__pyx_t_14 = NULL;
  PyObject *__pyx_t_15 = NULL;
  PyObject *(*__pyx_t_16)(PyObject *);
  int __pyx_t_17;
  int __pyx_t_18;
  int __pyx_t_19;
  int __pyx_t_20;
  int __pyx_t_21;
  PyArrayObject *__pyx_t_22 = NULL;
  PyObject *__pyx_t_23 = NULL;
  PyObject *__pyx_t_24 = NULL;
  PyObject *__pyx_t_25 = NULL;
  double __pyx_t_26;
  Py_ssize_t __pyx_t_27;
  Py_ssize_t __pyx_t_28;
  Py_ssize_t __pyx_t_29;
  Py_ssize_t __pyx_t_30;
  __Pyx_RefNannySetupContext("detect_cosmic_rays", 0);
  __pyx_pybuffer_workframe.pybuffer.buf = NULL;
  __pyx_pybuffer_workframe.refcount = 0;
  __pyx_pybuffernd_workframe.data = NULL;
  __pyx_pybuffernd_workframe.rcbuffer = &__pyx_pybuffer_workframe;
  __pyx_pybuffer_cr_map.pybuffer.buf = NULL;
  __pyx_pybuffer_cr_map.refcount = 0;
  __pyx_pybuffernd_cr_map.data = NULL;
  __pyx_pybuffernd_cr_map.rcbuffer = &__pyx_pybuffer_cr_map;
  __pyx_pybuffer_box.pybuffer.buf = NULL;
  __pyx_pybuffer_box.refcount = 0;
  __pyx_pybuffernd_box.data = NULL;
  __pyx_pybuffernd_box.rcbuffer = &__pyx_pybuffer_box;
  __pyx_pybuffer_frame.pybuffer.buf = NULL;
  __pyx_pybuffer_frame.refcount = 0;
  __pyx_pybuffernd_frame.data = NULL;
  __pyx_pybuffernd_frame.rcbuffer = &__pyx_pybuffer_frame;
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_frame.rcbuffer->pybuffer, (PyObject*)__pyx_v_frame, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) __PYX_ERR(0, 2138, __pyx_L1_error)
  }
  __pyx_pybuffernd_frame.diminfo[0].strides = __pyx_pybuffernd_frame.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_frame.diminfo[0].shape = __pyx_pybuffernd_frame.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_frame.diminfo[1].strides = __pyx_pybuffernd_frame.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_frame.diminfo[1].shape = __pyx_pybuffernd_frame.rcbuffer->pybuffer.shape[1];

  /* "orb/cutils.pyx":2155
 *     """
 * 
 *     cdef np.ndarray[np.float64_t, ndim=2] workframe = np.copy(frame)             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.uint8_t, ndim=2] cr_map = np.zeros_like(
 *         frame, dtype=np.uint8)
 */
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 2155, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_copy); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 2155, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_3))) {
    __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_3);
    if (likely(__pyx_t_2)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
      __Pyx_INCREF(__pyx_t_2);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_3, function);
    }
  }
  if (!__pyx_t_2) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_3, ((PyObject *)__pyx_v_frame)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2155, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_4 = PyTuple_New(1+1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2155, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_2); __pyx_t_2 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_frame));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_frame));
    PyTuple_SET_ITEM(__pyx_t_4, 0+1, ((PyObject *)__pyx_v_frame));
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_4, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2155, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  }
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 2155, __pyx_L1_error)
  __pyx_t_5 = ((PyArrayObject *)__pyx_t_1);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_workframe.rcbuffer->pybuffer, (PyObject*)__pyx_t_5, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
      __pyx_v_workframe = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_workframe.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 2155, __pyx_L1_error)
    } else {__pyx_pybuffernd_workframe.diminfo[0].strides = __pyx_pybuffernd_workframe.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_workframe.diminfo[0].shape = __pyx_pybuffernd_workframe.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_workframe.diminfo[1].strides = __pyx_pybuffernd_workframe.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_workframe.diminfo[1].shape = __pyx_pybuffernd_workframe.rcbuffer->pybuffer.shape[1];
    }
  }
  __pyx_t_5 = 0;
  __pyx_v_workframe = ((PyArrayObject *)__pyx_t_1);
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":2156
 * 
 *     cdef np.ndarray[np.float64_t, ndim=2] workframe = np.copy(frame)
 *     cdef np.ndarray[np.uint8_t, ndim=2] cr_map = np.zeros_like(             # <<<<<<<<<<<<<<
 *         frame, dtype=np.uint8)
 *     cdef int cr_list_len = len(crs_list[0])
 */
  __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2156, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_zeros_like); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 2156, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":2157
 *     cdef np.ndarray[np.float64_t, ndim=2] workframe = np.copy(frame)
 *     cdef np.ndarray[np.uint8_t, ndim=2] cr_map = np.zeros_like(
 *         frame, dtype=np.uint8)             # <<<<<<<<<<<<<<
 *     cdef int cr_list_len = len(crs_list[0])
 *     cdef int icr, ix, iy, xmin, xmax, ymin, ymax
 */
  __pyx_t_1 = PyTuple_New(1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2156, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_INCREF(((PyObject *)__pyx_v_frame));
  __Pyx_GIVEREF(((PyObject *)__pyx_v_frame));
  PyTuple_SET_ITEM(__pyx_t_1, 0, ((PyObject *)__pyx_v_frame));
  __pyx_t_4 = PyDict_New(); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2157, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 2157, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_uint8); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 2157, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  if (PyDict_SetItem(__pyx_t_4, __pyx_n_s_dtype, __pyx_t_6) < 0) __PYX_ERR(0, 2157, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;

  /* "orb/cutils.pyx":2156
 * 
 *     cdef np.ndarray[np.float64_t, ndim=2] workframe = np.copy(frame)
 *     cdef np.ndarray[np.uint8_t, ndim=2] cr_map = np.zeros_like(             # <<<<<<<<<<<<<<
 *         frame, dtype=np.uint8)
 *     cdef int cr_list_len = len(crs_list[0])
 */
  __pyx_t_6 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_1, __pyx_t_4); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 2156, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  if (!(likely(((__pyx_t_6) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_6, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 2156, __pyx_L1_error)
  __pyx_t_7 = ((PyArrayObject *)__pyx_t_6);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_cr_map.rcbuffer->pybuffer, (PyObject*)__pyx_t_7, &__Pyx_TypeInfo_nn___pyx_t_5numpy_uint8_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 2, 0, __pyx_stack) == -1)) {
      __pyx_v_cr_map = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_cr_map.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 2156, __pyx_L1_error)
    } else {__pyx_pybuffernd_cr_map.diminfo[0].strides = __pyx_pybuffernd_cr_map.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_cr_map.diminfo[0].shape = __pyx_pybuffernd_cr_map.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_cr_map.diminfo[1].strides = __pyx_pybuffernd_cr_map.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_cr_map.diminfo[1].shape = __pyx_pybuffernd_cr_map.rcbuffer->pybuffer.shape[1];
    }
  }
  __pyx_t_7 = 0;
  __pyx_v_cr_map = ((PyArrayObject *)__pyx_t_6);
  __pyx_t_6 = 0;

  /* "orb/cutils.pyx":2158
 *     cdef np.ndarray[np.uint8_t, ndim=2] cr_map = np.zeros_like(
 *         frame, dtype=np.uint8)
 *     cdef int cr_list_len = len(crs_list[0])             # <<<<<<<<<<<<<<
 *     cdef int icr, ix, iy, xmin, xmax, ymin, ymax
 *     cdef double boxmed, boxstd
 */
  __pyx_t_6 = __Pyx_GetItemInt(__pyx_v_crs_list, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 2158, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __pyx_t_8 = PyObject_Length(__pyx_t_6); if (unlikely(__pyx_t_8 == -1)) __PYX_ERR(0, 2158, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
  __pyx_v_cr_list_len = __pyx_t_8;

  /* "orb/cutils.pyx":2163
 *     cdef np.ndarray[np.float64_t, ndim=2] box
 * 
 *     workframe[crs_list] = np.nan             # <<<<<<<<<<<<<<
 * 
 *     for icr in range(cr_list_len):
 */
  __pyx_t_6 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 2163, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_6, __pyx_n_s_nan); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2163, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
  if (unlikely(PyObject_SetItem(((PyObject *)__pyx_v_workframe), __pyx_v_crs_list, __pyx_t_4) < 0)) __PYX_ERR(0, 2163, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;

  /* "orb/cutils.pyx":2165
 *     workframe[crs_list] = np.nan
 * 
 *     for icr in range(cr_list_len):             # <<<<<<<<<<<<<<
 *         ix = crs_list[0][icr]
 *         iy = crs_list[1][icr]
 */
  __pyx_t_9 = __pyx_v_cr_list_len;
  for (__pyx_t_10 = 0; __pyx_t_10 < __pyx_t_9; __pyx_t_10+=1) {
    __pyx_v_icr = __pyx_t_10;

    /* "orb/cutils.pyx":2166
 * 
 *     for icr in range(cr_list_len):
 *         ix = crs_list[0][icr]             # <<<<<<<<<<<<<<
 *         iy = crs_list[1][icr]
 * 
 */
    __pyx_t_4 = __Pyx_GetItemInt(__pyx_v_crs_list, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2166, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __pyx_t_6 = __Pyx_GetItemInt(__pyx_t_4, __pyx_v_icr, int, 1, __Pyx_PyInt_From_int, 0, 0, 0); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 2166, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_t_11 = __Pyx_PyInt_As_int(__pyx_t_6); if (unlikely((__pyx_t_11 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 2166, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
    __pyx_v_ix = __pyx_t_11;

    /* "orb/cutils.pyx":2167
 *     for icr in range(cr_list_len):
 *         ix = crs_list[0][icr]
 *         iy = crs_list[1][icr]             # <<<<<<<<<<<<<<
 * 
 *         xmin, xmax, ymin, ymax = get_box_coords(
 */
    __pyx_t_6 = __Pyx_GetItemInt(__pyx_v_crs_list, 1, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 2167, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
    __pyx_t_4 = __Pyx_GetItemInt(__pyx_t_6, __pyx_v_icr, int, 1, __Pyx_PyInt_From_int, 0, 0, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2167, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
    __pyx_t_11 = __Pyx_PyInt_As_int(__pyx_t_4); if (unlikely((__pyx_t_11 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 2167, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_v_iy = __pyx_t_11;

    /* "orb/cutils.pyx":2169
 *         iy = crs_list[1][icr]
 * 
 *         xmin, xmax, ymin, ymax = get_box_coords(             # <<<<<<<<<<<<<<
 *             ix, iy, box_size,
 *             0, workframe.shape[0], 0, workframe.shape[1])
 */
    __pyx_t_6 = __Pyx_GetModuleGlobalName(__pyx_n_s_get_box_coords); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 2169, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);

    /* "orb/cutils.pyx":2170
 * 
 *         xmin, xmax, ymin, ymax = get_box_coords(
 *             ix, iy, box_size,             # <<<<<<<<<<<<<<
 *             0, workframe.shape[0], 0, workframe.shape[1])
 * 
 */
    __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_ix); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2170, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __pyx_t_3 = __Pyx_PyInt_From_int(__pyx_v_iy); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 2170, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __pyx_t_2 = __Pyx_PyInt_From_int(__pyx_v_box_size); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 2170, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);

    /* "orb/cutils.pyx":2171
 *         xmin, xmax, ymin, ymax = get_box_coords(
 *             ix, iy, box_size,
 *             0, workframe.shape[0], 0, workframe.shape[1])             # <<<<<<<<<<<<<<
 * 
 *         if xmax - xmin == box_size and ymax - ymin == box_size:
 */
    __pyx_t_12 = __Pyx_PyInt_From_Py_intptr_t((__pyx_v_workframe->dimensions[0])); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 2171, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_12);
    __pyx_t_13 = __Pyx_PyInt_From_Py_intptr_t((__pyx_v_workframe->dimensions[1])); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 2171, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_13);
    __pyx_t_14 = NULL;
    __pyx_t_8 = 0;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_6))) {
      __pyx_t_14 = PyMethod_GET_SELF(__pyx_t_6);
      if (likely(__pyx_t_14)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_6);
        __Pyx_INCREF(__pyx_t_14);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_6, function);
        __pyx_t_8 = 1;
      }
    }
    __pyx_t_15 = PyTuple_New(7+__pyx_t_8); if (unlikely(!__pyx_t_15)) __PYX_ERR(0, 2169, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_15);
    if (__pyx_t_14) {
      __Pyx_GIVEREF(__pyx_t_14); PyTuple_SET_ITEM(__pyx_t_15, 0, __pyx_t_14); __pyx_t_14 = NULL;
    }
    __Pyx_GIVEREF(__pyx_t_1);
    PyTuple_SET_ITEM(__pyx_t_15, 0+__pyx_t_8, __pyx_t_1);
    __Pyx_GIVEREF(__pyx_t_3);
    PyTuple_SET_ITEM(__pyx_t_15, 1+__pyx_t_8, __pyx_t_3);
    __Pyx_GIVEREF(__pyx_t_2);
    PyTuple_SET_ITEM(__pyx_t_15, 2+__pyx_t_8, __pyx_t_2);
    __Pyx_INCREF(__pyx_int_0);
    __Pyx_GIVEREF(__pyx_int_0);
    PyTuple_SET_ITEM(__pyx_t_15, 3+__pyx_t_8, __pyx_int_0);
    __Pyx_GIVEREF(__pyx_t_12);
    PyTuple_SET_ITEM(__pyx_t_15, 4+__pyx_t_8, __pyx_t_12);
    __Pyx_INCREF(__pyx_int_0);
    __Pyx_GIVEREF(__pyx_int_0);
    PyTuple_SET_ITEM(__pyx_t_15, 5+__pyx_t_8, __pyx_int_0);
    __Pyx_GIVEREF(__pyx_t_13);
    PyTuple_SET_ITEM(__pyx_t_15, 6+__pyx_t_8, __pyx_t_13);
    __pyx_t_1 = 0;
    __pyx_t_3 = 0;
    __pyx_t_2 = 0;
    __pyx_t_12 = 0;
    __pyx_t_13 = 0;
    __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_6, __pyx_t_15, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2169, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_15); __pyx_t_15 = 0;
    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
    if ((likely(PyTuple_CheckExact(__pyx_t_4))) || (PyList_CheckExact(__pyx_t_4))) {
      PyObject* sequence = __pyx_t_4;
      #if CYTHON_COMPILING_IN_CPYTHON
      Py_ssize_t size = Py_SIZE(sequence);
      #else
      Py_ssize_t size = PySequence_Size(sequence);
      #endif
      if (unlikely(size != 4)) {
        if (size > 4) __Pyx_RaiseTooManyValuesError(4);
        else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
        __PYX_ERR(0, 2169, __pyx_L1_error)
      }
      #if CYTHON_COMPILING_IN_CPYTHON
      if (likely(PyTuple_CheckExact(sequence))) {
        __pyx_t_6 = PyTuple_GET_ITEM(sequence, 0); 
        __pyx_t_15 = PyTuple_GET_ITEM(sequence, 1); 
        __pyx_t_13 = PyTuple_GET_ITEM(sequence, 2); 
        __pyx_t_12 = PyTuple_GET_ITEM(sequence, 3); 
      } else {
        __pyx_t_6 = PyList_GET_ITEM(sequence, 0); 
        __pyx_t_15 = PyList_GET_ITEM(sequence, 1); 
        __pyx_t_13 = PyList_GET_ITEM(sequence, 2); 
        __pyx_t_12 = PyList_GET_ITEM(sequence, 3); 
      }
      __Pyx_INCREF(__pyx_t_6);
      __Pyx_INCREF(__pyx_t_15);
      __Pyx_INCREF(__pyx_t_13);
      __Pyx_INCREF(__pyx_t_12);
      #else
      {
        Py_ssize_t i;
        PyObject** temps[4] = {&__pyx_t_6,&__pyx_t_15,&__pyx_t_13,&__pyx_t_12};
        for (i=0; i < 4; i++) {
          PyObject* item = PySequence_ITEM(sequence, i); if (unlikely(!item)) __PYX_ERR(0, 2169, __pyx_L1_error)
          __Pyx_GOTREF(item);
          *(temps[i]) = item;
        }
      }
      #endif
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    } else {
      Py_ssize_t index = -1;
      PyObject** temps[4] = {&__pyx_t_6,&__pyx_t_15,&__pyx_t_13,&__pyx_t_12};
      __pyx_t_2 = PyObject_GetIter(__pyx_t_4); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 2169, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __pyx_t_16 = Py_TYPE(__pyx_t_2)->tp_iternext;
      for (index=0; index < 4; index++) {
        PyObject* item = __pyx_t_16(__pyx_t_2); if (unlikely(!item)) goto __pyx_L5_unpacking_failed;
        __Pyx_GOTREF(item);
        *(temps[index]) = item;
      }
      if (__Pyx_IternextUnpackEndCheck(__pyx_t_16(__pyx_t_2), 4) < 0) __PYX_ERR(0, 2169, __pyx_L1_error)
      __pyx_t_16 = NULL;
      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
      goto __pyx_L6_unpacking_done;
      __pyx_L5_unpacking_failed:;
      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
      __pyx_t_16 = NULL;
      if (__Pyx_IterFinish() == 0) __Pyx_RaiseNeedMoreValuesError(index);
      __PYX_ERR(0, 2169, __pyx_L1_error)
      __pyx_L6_unpacking_done:;
    }

    /* "orb/cutils.pyx":2169
 *         iy = crs_list[1][icr]
 * 
 *         xmin, xmax, ymin, ymax = get_box_coords(             # <<<<<<<<<<<<<<
 *             ix, iy, box_size,
 *             0, workframe.shape[0], 0, workframe.shape[1])
 */
    __pyx_t_11 = __Pyx_PyInt_As_int(__pyx_t_6); if (unlikely((__pyx_t_11 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 2169, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
    __pyx_t_17 = __Pyx_PyInt_As_int(__pyx_t_15); if (unlikely((__pyx_t_17 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 2169, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_15); __pyx_t_15 = 0;
    __pyx_t_18 = __Pyx_PyInt_As_int(__pyx_t_13); if (unlikely((__pyx_t_18 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 2169, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
    __pyx_t_19 = __Pyx_PyInt_As_int(__pyx_t_12); if (unlikely((__pyx_t_19 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 2169, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_12); __pyx_t_12 = 0;
    __pyx_v_xmin = __pyx_t_11;
    __pyx_v_xmax = __pyx_t_17;
    __pyx_v_ymin = __pyx_t_18;
    __pyx_v_ymax = __pyx_t_19;

    /* "orb/cutils.pyx":2173
 *             0, workframe.shape[0], 0, workframe.shape[1])
 * 
 *         if xmax - xmin == box_size and ymax - ymin == box_size:             # <<<<<<<<<<<<<<
 * 
 *             box = np.copy(workframe[xmin:xmax, ymin:ymax])
 */
    __pyx_t_21 = (((__pyx_v_xmax - __pyx_v_xmin) == __pyx_v_box_size) != 0);
    if (__pyx_t_21) {
    } else {
      __pyx_t_20 = __pyx_t_21;
      goto __pyx_L8_bool_binop_done;
    }
    __pyx_t_21 = (((__pyx_v_ymax - __pyx_v_ymin) == __pyx_v_box_size) != 0);
    __pyx_t_20 = __pyx_t_21;
    __pyx_L8_bool_binop_done:;
    if (__pyx_t_20) {

      /* "orb/cutils.pyx":2175
 *         if xmax - xmin == box_size and ymax - ymin == box_size:
 * 
 *             box = np.copy(workframe[xmin:xmax, ymin:ymax])             # <<<<<<<<<<<<<<
 * 
 *             if not np.all(np.isnan(box)):
 */
      __pyx_t_12 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 2175, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_12);
      __pyx_t_13 = __Pyx_PyObject_GetAttrStr(__pyx_t_12, __pyx_n_s_copy); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 2175, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_13);
      __Pyx_DECREF(__pyx_t_12); __pyx_t_12 = 0;
      __pyx_t_12 = __Pyx_PyInt_From_int(__pyx_v_xmin); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 2175, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_12);
      __pyx_t_15 = __Pyx_PyInt_From_int(__pyx_v_xmax); if (unlikely(!__pyx_t_15)) __PYX_ERR(0, 2175, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_15);
      __pyx_t_6 = PySlice_New(__pyx_t_12, __pyx_t_15, Py_None); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 2175, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_6);
      __Pyx_DECREF(__pyx_t_12); __pyx_t_12 = 0;
      __Pyx_DECREF(__pyx_t_15); __pyx_t_15 = 0;
      __pyx_t_15 = __Pyx_PyInt_From_int(__pyx_v_ymin); if (unlikely(!__pyx_t_15)) __PYX_ERR(0, 2175, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_15);
      __pyx_t_12 = __Pyx_PyInt_From_int(__pyx_v_ymax); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 2175, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_12);
      __pyx_t_2 = PySlice_New(__pyx_t_15, __pyx_t_12, Py_None); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 2175, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __Pyx_DECREF(__pyx_t_15); __pyx_t_15 = 0;
      __Pyx_DECREF(__pyx_t_12); __pyx_t_12 = 0;
      __pyx_t_12 = PyTuple_New(2); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 2175, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_12);
      __Pyx_GIVEREF(__pyx_t_6);
      PyTuple_SET_ITEM(__pyx_t_12, 0, __pyx_t_6);
      __Pyx_GIVEREF(__pyx_t_2);
      PyTuple_SET_ITEM(__pyx_t_12, 1, __pyx_t_2);
      __pyx_t_6 = 0;
      __pyx_t_2 = 0;
      __pyx_t_2 = PyObject_GetItem(((PyObject *)__pyx_v_workframe), __pyx_t_12); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 2175, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __Pyx_DECREF(__pyx_t_12); __pyx_t_12 = 0;
      __pyx_t_12 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_13))) {
        __pyx_t_12 = PyMethod_GET_SELF(__pyx_t_13);
        if (likely(__pyx_t_12)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_13);
          __Pyx_INCREF(__pyx_t_12);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_13, function);
        }
      }
      if (!__pyx_t_12) {
        __pyx_t_4 = __Pyx_PyObject_CallOneArg(__pyx_t_13, __pyx_t_2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2175, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
        __Pyx_GOTREF(__pyx_t_4);
      } else {
        __pyx_t_6 = PyTuple_New(1+1); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 2175, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_6);
        __Pyx_GIVEREF(__pyx_t_12); PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_12); __pyx_t_12 = NULL;
        __Pyx_GIVEREF(__pyx_t_2);
        PyTuple_SET_ITEM(__pyx_t_6, 0+1, __pyx_t_2);
        __pyx_t_2 = 0;
        __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_13, __pyx_t_6, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2175, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_4);
        __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
      }
      __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
      if (!(likely(((__pyx_t_4) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_4, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 2175, __pyx_L1_error)
      __pyx_t_22 = ((PyArrayObject *)__pyx_t_4);
      {
        __Pyx_BufFmt_StackElem __pyx_stack[1];
        __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_box.rcbuffer->pybuffer);
        __pyx_t_19 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_box.rcbuffer->pybuffer, (PyObject*)__pyx_t_22, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
        if (unlikely(__pyx_t_19 < 0)) {
          PyErr_Fetch(&__pyx_t_23, &__pyx_t_24, &__pyx_t_25);
          if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_box.rcbuffer->pybuffer, (PyObject*)__pyx_v_box, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
            Py_XDECREF(__pyx_t_23); Py_XDECREF(__pyx_t_24); Py_XDECREF(__pyx_t_25);
            __Pyx_RaiseBufferFallbackError();
          } else {
            PyErr_Restore(__pyx_t_23, __pyx_t_24, __pyx_t_25);
          }
        }
        __pyx_pybuffernd_box.diminfo[0].strides = __pyx_pybuffernd_box.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_box.diminfo[0].shape = __pyx_pybuffernd_box.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_box.diminfo[1].strides = __pyx_pybuffernd_box.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_box.diminfo[1].shape = __pyx_pybuffernd_box.rcbuffer->pybuffer.shape[1];
        if (unlikely(__pyx_t_19 < 0)) __PYX_ERR(0, 2175, __pyx_L1_error)
      }
      __pyx_t_22 = 0;
      __Pyx_XDECREF_SET(__pyx_v_box, ((PyArrayObject *)__pyx_t_4));
      __pyx_t_4 = 0;

      /* "orb/cutils.pyx":2177
 *             box = np.copy(workframe[xmin:xmax, ymin:ymax])
 * 
 *             if not np.all(np.isnan(box)):             # <<<<<<<<<<<<<<
 *                 boxstd = bn.nanstd(box)
 *                 boxmed = bn.nanmedian(box)
 */
      __pyx_t_13 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 2177, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_13);
      __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_t_13, __pyx_n_s_all); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 2177, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_6);
      __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
      __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 2177, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __pyx_t_12 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_isnan); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 2177, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_12);
      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
      __pyx_t_2 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_12))) {
        __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_12);
        if (likely(__pyx_t_2)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_12);
          __Pyx_INCREF(__pyx_t_2);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_12, function);
        }
      }
      if (!__pyx_t_2) {
        __pyx_t_13 = __Pyx_PyObject_CallOneArg(__pyx_t_12, ((PyObject *)__pyx_v_box)); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 2177, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_13);
      } else {
        __pyx_t_15 = PyTuple_New(1+1); if (unlikely(!__pyx_t_15)) __PYX_ERR(0, 2177, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_15);
        __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_15, 0, __pyx_t_2); __pyx_t_2 = NULL;
        __Pyx_INCREF(((PyObject *)__pyx_v_box));
        __Pyx_GIVEREF(((PyObject *)__pyx_v_box));
        PyTuple_SET_ITEM(__pyx_t_15, 0+1, ((PyObject *)__pyx_v_box));
        __pyx_t_13 = __Pyx_PyObject_Call(__pyx_t_12, __pyx_t_15, NULL); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 2177, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_13);
        __Pyx_DECREF(__pyx_t_15); __pyx_t_15 = 0;
      }
      __Pyx_DECREF(__pyx_t_12); __pyx_t_12 = 0;
      __pyx_t_12 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_6))) {
        __pyx_t_12 = PyMethod_GET_SELF(__pyx_t_6);
        if (likely(__pyx_t_12)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_6);
          __Pyx_INCREF(__pyx_t_12);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_6, function);
        }
      }
      if (!__pyx_t_12) {
        __pyx_t_4 = __Pyx_PyObject_CallOneArg(__pyx_t_6, __pyx_t_13); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2177, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
        __Pyx_GOTREF(__pyx_t_4);
      } else {
        __pyx_t_15 = PyTuple_New(1+1); if (unlikely(!__pyx_t_15)) __PYX_ERR(0, 2177, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_15);
        __Pyx_GIVEREF(__pyx_t_12); PyTuple_SET_ITEM(__pyx_t_15, 0, __pyx_t_12); __pyx_t_12 = NULL;
        __Pyx_GIVEREF(__pyx_t_13);
        PyTuple_SET_ITEM(__pyx_t_15, 0+1, __pyx_t_13);
        __pyx_t_13 = 0;
        __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_6, __pyx_t_15, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2177, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_4);
        __Pyx_DECREF(__pyx_t_15); __pyx_t_15 = 0;
      }
      __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
      __pyx_t_20 = __Pyx_PyObject_IsTrue(__pyx_t_4); if (unlikely(__pyx_t_20 < 0)) __PYX_ERR(0, 2177, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __pyx_t_21 = ((!__pyx_t_20) != 0);
      if (__pyx_t_21) {

        /* "orb/cutils.pyx":2178
 * 
 *             if not np.all(np.isnan(box)):
 *                 boxstd = bn.nanstd(box)             # <<<<<<<<<<<<<<
 *                 boxmed = bn.nanmedian(box)
 *                 if frame[ix,iy] > boxmed + detect_coeff * boxstd:
 */
        __pyx_t_6 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 2178, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_6);
        __pyx_t_15 = __Pyx_PyObject_GetAttrStr(__pyx_t_6, __pyx_n_s_nanstd); if (unlikely(!__pyx_t_15)) __PYX_ERR(0, 2178, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_15);
        __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
        __pyx_t_6 = NULL;
        if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_15))) {
          __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_15);
          if (likely(__pyx_t_6)) {
            PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_15);
            __Pyx_INCREF(__pyx_t_6);
            __Pyx_INCREF(function);
            __Pyx_DECREF_SET(__pyx_t_15, function);
          }
        }
        if (!__pyx_t_6) {
          __pyx_t_4 = __Pyx_PyObject_CallOneArg(__pyx_t_15, ((PyObject *)__pyx_v_box)); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2178, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_4);
        } else {
          __pyx_t_13 = PyTuple_New(1+1); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 2178, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_13);
          __Pyx_GIVEREF(__pyx_t_6); PyTuple_SET_ITEM(__pyx_t_13, 0, __pyx_t_6); __pyx_t_6 = NULL;
          __Pyx_INCREF(((PyObject *)__pyx_v_box));
          __Pyx_GIVEREF(((PyObject *)__pyx_v_box));
          PyTuple_SET_ITEM(__pyx_t_13, 0+1, ((PyObject *)__pyx_v_box));
          __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_15, __pyx_t_13, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2178, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_4);
          __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
        }
        __Pyx_DECREF(__pyx_t_15); __pyx_t_15 = 0;
        __pyx_t_26 = __pyx_PyFloat_AsDouble(__pyx_t_4); if (unlikely((__pyx_t_26 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 2178, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
        __pyx_v_boxstd = __pyx_t_26;

        /* "orb/cutils.pyx":2179
 *             if not np.all(np.isnan(box)):
 *                 boxstd = bn.nanstd(box)
 *                 boxmed = bn.nanmedian(box)             # <<<<<<<<<<<<<<
 *                 if frame[ix,iy] > boxmed + detect_coeff * boxstd:
 *                     cr_map[ix,iy] = 1
 */
        __pyx_t_15 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_15)) __PYX_ERR(0, 2179, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_15);
        __pyx_t_13 = __Pyx_PyObject_GetAttrStr(__pyx_t_15, __pyx_n_s_nanmedian); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 2179, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_13);
        __Pyx_DECREF(__pyx_t_15); __pyx_t_15 = 0;
        __pyx_t_15 = NULL;
        if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_13))) {
          __pyx_t_15 = PyMethod_GET_SELF(__pyx_t_13);
          if (likely(__pyx_t_15)) {
            PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_13);
            __Pyx_INCREF(__pyx_t_15);
            __Pyx_INCREF(function);
            __Pyx_DECREF_SET(__pyx_t_13, function);
          }
        }
        if (!__pyx_t_15) {
          __pyx_t_4 = __Pyx_PyObject_CallOneArg(__pyx_t_13, ((PyObject *)__pyx_v_box)); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2179, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_4);
        } else {
          __pyx_t_6 = PyTuple_New(1+1); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 2179, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_6);
          __Pyx_GIVEREF(__pyx_t_15); PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_15); __pyx_t_15 = NULL;
          __Pyx_INCREF(((PyObject *)__pyx_v_box));
          __Pyx_GIVEREF(((PyObject *)__pyx_v_box));
          PyTuple_SET_ITEM(__pyx_t_6, 0+1, ((PyObject *)__pyx_v_box));
          __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_13, __pyx_t_6, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2179, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_4);
          __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
        }
        __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
        __pyx_t_26 = __pyx_PyFloat_AsDouble(__pyx_t_4); if (unlikely((__pyx_t_26 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 2179, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
        __pyx_v_boxmed = __pyx_t_26;

        /* "orb/cutils.pyx":2180
 *                 boxstd = bn.nanstd(box)
 *                 boxmed = bn.nanmedian(box)
 *                 if frame[ix,iy] > boxmed + detect_coeff * boxstd:             # <<<<<<<<<<<<<<
 *                     cr_map[ix,iy] = 1
 * 
 */
        __pyx_t_27 = __pyx_v_ix;
        __pyx_t_28 = __pyx_v_iy;
        __pyx_t_21 = (((*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_frame.rcbuffer->pybuffer.buf, __pyx_t_27, __pyx_pybuffernd_frame.diminfo[0].strides, __pyx_t_28, __pyx_pybuffernd_frame.diminfo[1].strides)) > (__pyx_v_boxmed + (__pyx_v_detect_coeff * __pyx_v_boxstd))) != 0);
        if (__pyx_t_21) {

          /* "orb/cutils.pyx":2181
 *                 boxmed = bn.nanmedian(box)
 *                 if frame[ix,iy] > boxmed + detect_coeff * boxstd:
 *                     cr_map[ix,iy] = 1             # <<<<<<<<<<<<<<
 * 
 *     return cr_map
 */
          __pyx_t_29 = __pyx_v_ix;
          __pyx_t_30 = __pyx_v_iy;
          *__Pyx_BufPtrStrided2d(__pyx_t_5numpy_uint8_t *, __pyx_pybuffernd_cr_map.rcbuffer->pybuffer.buf, __pyx_t_29, __pyx_pybuffernd_cr_map.diminfo[0].strides, __pyx_t_30, __pyx_pybuffernd_cr_map.diminfo[1].strides) = 1;

          /* "orb/cutils.pyx":2180
 *                 boxstd = bn.nanstd(box)
 *                 boxmed = bn.nanmedian(box)
 *                 if frame[ix,iy] > boxmed + detect_coeff * boxstd:             # <<<<<<<<<<<<<<
 *                     cr_map[ix,iy] = 1
 * 
 */
        }

        /* "orb/cutils.pyx":2177
 *             box = np.copy(workframe[xmin:xmax, ymin:ymax])
 * 
 *             if not np.all(np.isnan(box)):             # <<<<<<<<<<<<<<
 *                 boxstd = bn.nanstd(box)
 *                 boxmed = bn.nanmedian(box)
 */
      }

      /* "orb/cutils.pyx":2173
 *             0, workframe.shape[0], 0, workframe.shape[1])
 * 
 *         if xmax - xmin == box_size and ymax - ymin == box_size:             # <<<<<<<<<<<<<<
 * 
 *             box = np.copy(workframe[xmin:xmax, ymin:ymax])
 */
    }
  }

  /* "orb/cutils.pyx":2183
 *                     cr_map[ix,iy] = 1
 * 
 *     return cr_map             # <<<<<<<<<<<<<<
 * 
 * @cython.boundscheck(False)
 */
  __Pyx_XDECREF(__pyx_r);
  __Pyx_INCREF(((PyObject *)__pyx_v_cr_map));
  __pyx_r = ((PyObject *)__pyx_v_cr_map);
  goto __pyx_L0;

  /* "orb/cutils.pyx":2138
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def detect_cosmic_rays(np.ndarray[np.float64_t, ndim=2] frame,             # <<<<<<<<<<<<<<
 *                        crs_list, int box_size, double detect_coeff):
 *     """Check if a given pixel is a cosmic ray (classic detection).
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_1);
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_XDECREF(__pyx_t_6);
  __Pyx_XDECREF(__pyx_t_12);
  __Pyx_XDECREF(__pyx_t_13);
  __Pyx_XDECREF(__pyx_t_14);
  __Pyx_XDECREF(__pyx_t_15);
  { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
    __Pyx_PyThreadState_declare
    __Pyx_PyThreadState_assign
    __Pyx_ErrFetch(&__pyx_type, &__pyx_value, &__pyx_tb);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_box.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_cr_map.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_frame.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_workframe.rcbuffer->pybuffer);
  __Pyx_ErrRestore(__pyx_type, __pyx_value, __pyx_tb);}
  __Pyx_AddTraceback("orb.cutils.detect_cosmic_rays", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  goto __pyx_L2;
  __pyx_L0:;
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_box.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_cr_map.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_frame.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_workframe.rcbuffer->pybuffer);
  __pyx_L2:;
  __Pyx_XDECREF((PyObject *)__pyx_v_workframe);
  __Pyx_XDECREF((PyObject *)__pyx_v_cr_map);
  __Pyx_XDECREF((PyObject *)__pyx_v_box);
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":2187
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def check_cosmic_rays_neighbourhood(             # <<<<<<<<<<<<<<
 *     np.ndarray[np.float64_t, ndim=2] frame,
 *     np.ndarray[np.uint8_t, ndim=2] cr_map,
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_79check_cosmic_rays_neighbourhood(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_3orb_6cutils_78check_cosmic_rays_neighbourhood[] = "check_cosmic_rays_neighbourhood(ndarray frame, ndarray cr_map, int box_size, double detect_coeff)\nCheck the neighbourhood around detected cosmic rays in a frame.\n\n    :param frame: Frame to check\n    \n    :param cr_map: Map of the cosimic-rays positions (boolean map, 1\n      is a cosmic ray)\n\n    :param box_size: Size of the box checked around each cr.\n\n    :param detect_coeff: Coefficient of detection (number of sigmas\n      threshold)\n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_79check_cosmic_rays_neighbourhood = {"check_cosmic_rays_neighbourhood", (PyCFunction)__pyx_pw_3orb_6cutils_79check_cosmic_rays_neighbourhood, METH_VARARGS|METH_KEYWORDS, __pyx_doc_3orb_6cutils_78check_cosmic_rays_neighbourhood};
static PyObject *__pyx_pw_3orb_6cutils_79check_cosmic_rays_neighbourhood(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  PyArrayObject *__pyx_v_frame = 0;
  PyArrayObject *__pyx_v_cr_map = 0;
  int __pyx_v_box_size;
  double __pyx_v_detect_coeff;
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("check_cosmic_rays_neighbourhood (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_frame,&__pyx_n_s_cr_map,&__pyx_n_s_box_size,&__pyx_n_s_detect_coeff,0};
    PyObject* values[4] = {0,0,0,0};
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
      switch (pos_args) {
        case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = PyDict_Size(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_frame)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        case  1:
        if (likely((values[1] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_cr_map)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("check_cosmic_rays_neighbourhood", 1, 4, 4, 1); __PYX_ERR(0, 2187, __pyx_L3_error)
        }
        case  2:
        if (likely((values[2] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_box_size)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("check_cosmic_rays_neighbourhood", 1, 4, 4, 2); __PYX_ERR(0, 2187, __pyx_L3_error)
        }
        case  3:
        if (likely((values[3] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_detect_coeff)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("check_cosmic_rays_neighbourhood", 1, 4, 4, 3); __PYX_ERR(0, 2187, __pyx_L3_error)
        }
      }
      if (unlikely(kw_args > 0)) {
        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "check_cosmic_rays_neighbourhood") < 0)) __PYX_ERR(0, 2187, __pyx_L3_error)
      }
    } else if (PyTuple_GET_SIZE(__pyx_args) != 4) {
      goto __pyx_L5_argtuple_error;
    } else {
      values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
      values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
      values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
      values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
    }
    __pyx_v_frame = ((PyArrayObject *)values[0]);
    __pyx_v_cr_map = ((PyArrayObject *)values[1]);
    __pyx_v_box_size = __Pyx_PyInt_As_int(values[2]); if (unlikely((__pyx_v_box_size == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 2190, __pyx_L3_error)
    __pyx_v_detect_coeff = __pyx_PyFloat_AsDouble(values[3]); if (unlikely((__pyx_v_detect_coeff == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 2190, __pyx_L3_error)
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  __Pyx_RaiseArgtupleInvalid("check_cosmic_rays_neighbourhood", 1, 4, 4, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 2187, __pyx_L3_error)
  __pyx_L3_error:;
  __Pyx_AddTraceback("orb.cutils.check_cosmic_rays_neighbourhood", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __Pyx_RefNannyFinishContext();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_frame), __pyx_ptype_5numpy_ndarray, 1, "frame", 0))) __PYX_ERR(0, 2188, __pyx_L1_error)
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_cr_map), __pyx_ptype_5numpy_ndarray, 1, "cr_map", 0))) __PYX_ERR(0, 2189, __pyx_L1_error)
  __pyx_r = __pyx_pf_3orb_6cutils_78check_cosmic_rays_neighbourhood(__pyx_self, __pyx_v_frame, __pyx_v_cr_map, __pyx_v_box_size, __pyx_v_detect_coeff);

  /* function exit code */
  goto __pyx_L0;
  __pyx_L1_error:;
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_78check_cosmic_rays_neighbourhood(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_frame, PyArrayObject *__pyx_v_cr_map, int __pyx_v_box_size, double __pyx_v_detect_coeff) {
  PyArrayObject *__pyx_v_workframe = 0;
  int __pyx_v_icr;
  int __pyx_v_ix;
  int __pyx_v_iy;
  int __pyx_v_xmin;
  int __pyx_v_xmax;
  int __pyx_v_ymin;
  int __pyx_v_ymax;
  int __pyx_v_ii;
  int __pyx_v_ij;
  PyArrayObject *__pyx_v_box = 0;
  double __pyx_v_boxmed;
  double __pyx_v_boxstd;
  PyObject *__pyx_v_crs_list = NULL;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_box;
  __Pyx_Buffer __pyx_pybuffer_box;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_cr_map;
  __Pyx_Buffer __pyx_pybuffer_cr_map;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_frame;
  __Pyx_Buffer __pyx_pybuffer_frame;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_workframe;
  __Pyx_Buffer __pyx_pybuffer_workframe;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  PyObject *__pyx_t_1 = NULL;
  PyObject *__pyx_t_2 = NULL;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  PyArrayObject *__pyx_t_5 = NULL;
  Py_ssize_t __pyx_t_6;
  int __pyx_t_7;
  int __pyx_t_8;
  PyObject *__pyx_t_9 = NULL;
  PyObject *__pyx_t_10 = NULL;
  PyObject *__pyx_t_11 = NULL;
  PyObject *__pyx_t_12 = NULL;
  Py_ssize_t __pyx_t_13;
  PyObject *__pyx_t_14 = NULL;
  PyObject *(*__pyx_t_15)(PyObject *);
  int __pyx_t_16;
  int __pyx_t_17;
  int __pyx_t_18;
  int __pyx_t_19;
  int __pyx_t_20;
  PyArrayObject *__pyx_t_21 = NULL;
  PyObject *__pyx_t_22 = NULL;
  PyObject *__pyx_t_23 = NULL;
  PyObject *__pyx_t_24 = NULL;
  double __pyx_t_25;
  Py_ssize_t __pyx_t_26;
  Py_ssize_t __pyx_t_27;
  Py_ssize_t __pyx_t_28;
  Py_ssize_t __pyx_t_29;
  __Pyx_RefNannySetupContext("check_cosmic_rays_neighbourhood", 0);
  __pyx_pybuffer_workframe.pybuffer.buf = NULL;
  __pyx_pybuffer_workframe.refcount = 0;
  __pyx_pybuffernd_workframe.data = NULL;
  __pyx_pybuffernd_workframe.rcbuffer = &__pyx_pybuffer_workframe;
  __pyx_pybuffer_box.pybuffer.buf = NULL;
  __pyx_pybuffer_box.refcount = 0;
  __pyx_pybuffernd_box.data = NULL;
  __pyx_pybuffernd_box.rcbuffer = &__pyx_pybuffer_box;
  __pyx_pybuffer_frame.pybuffer.buf = NULL;
  __pyx_pybuffer_frame.refcount = 0;
  __pyx_pybuffernd_frame.data = NULL;
  __pyx_pybuffernd_frame.rcbuffer = &__pyx_pybuffer_frame;
  __pyx_pybuffer_cr_map.pybuffer.buf = NULL;
  __pyx_pybuffer_cr_map.refcount = 0;
  __pyx_pybuffernd_cr_map.data = NULL;
  __pyx_pybuffernd_cr_map.rcbuffer = &__pyx_pybuffer_cr_map;
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_frame.rcbuffer->pybuffer, (PyObject*)__pyx_v_frame, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) __PYX_ERR(0, 2187, __pyx_L1_error)
  }
  __pyx_pybuffernd_frame.diminfo[0].strides = __pyx_pybuffernd_frame.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_frame.diminfo[0].shape = __pyx_pybuffernd_frame.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_frame.diminfo[1].strides = __pyx_pybuffernd_frame.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_frame.diminfo[1].shape = __pyx_pybuffernd_frame.rcbuffer->pybuffer.shape[1];
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_cr_map.rcbuffer->pybuffer, (PyObject*)__pyx_v_cr_map, &__Pyx_TypeInfo_nn___pyx_t_5numpy_uint8_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 2, 0, __pyx_stack) == -1)) __PYX_ERR(0, 2187, __pyx_L1_error)
  }
  __pyx_pybuffernd_cr_map.diminfo[0].strides = __pyx_pybuffernd_cr_map.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_cr_map.diminfo[0].shape = __pyx_pybuffernd_cr_map.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_cr_map.diminfo[1].strides = __pyx_pybuffernd_cr_map.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_cr_map.diminfo[1].shape = __pyx_pybuffernd_cr_map.rcbuffer->pybuffer.shape[1];

  /* "orb/cutils.pyx":2204
 *     """
 * 
 *     cdef np.ndarray[np.float64_t, ndim=2] workframe = np.copy(frame)             # <<<<<<<<<<<<<<
 *     cdef int inewcr, icr, ix, iy, xmin, xmax, ymin, ymax, ii, ij
 *     cdef np.ndarray[np.float64_t, ndim=2] box
 */
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 2204, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_copy); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 2204, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_3))) {
    __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_3);
    if (likely(__pyx_t_2)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
      __Pyx_INCREF(__pyx_t_2);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_3, function);
    }
  }
  if (!__pyx_t_2) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_3, ((PyObject *)__pyx_v_frame)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2204, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_4 = PyTuple_New(1+1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2204, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_2); __pyx_t_2 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_frame));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_frame));
    PyTuple_SET_ITEM(__pyx_t_4, 0+1, ((PyObject *)__pyx_v_frame));
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_4, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2204, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  }
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 2204, __pyx_L1_error)
  __pyx_t_5 = ((PyArrayObject *)__pyx_t_1);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_workframe.rcbuffer->pybuffer, (PyObject*)__pyx_t_5, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
      __pyx_v_workframe = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_workframe.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 2204, __pyx_L1_error)
    } else {__pyx_pybuffernd_workframe.diminfo[0].strides = __pyx_pybuffernd_workframe.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_workframe.diminfo[0].shape = __pyx_pybuffernd_workframe.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_workframe.diminfo[1].strides = __pyx_pybuffernd_workframe.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_workframe.diminfo[1].shape = __pyx_pybuffernd_workframe.rcbuffer->pybuffer.shape[1];
    }
  }
  __pyx_t_5 = 0;
  __pyx_v_workframe = ((PyArrayObject *)__pyx_t_1);
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":2209
 *     cdef double boxmed, boxstd
 * 
 *     crs_list = np.nonzero(cr_map)             # <<<<<<<<<<<<<<
 *     workframe[crs_list] = np.nan
 * 
 */
  __pyx_t_3 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 2209, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_nonzero); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2209, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_3 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_4))) {
    __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_4);
    if (likely(__pyx_t_3)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
      __Pyx_INCREF(__pyx_t_3);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_4, function);
    }
  }
  if (!__pyx_t_3) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_4, ((PyObject *)__pyx_v_cr_map)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2209, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_2 = PyTuple_New(1+1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 2209, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_3); __pyx_t_3 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_cr_map));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_cr_map));
    PyTuple_SET_ITEM(__pyx_t_2, 0+1, ((PyObject *)__pyx_v_cr_map));
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_2, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2209, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  }
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_v_crs_list = __pyx_t_1;
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":2210
 * 
 *     crs_list = np.nonzero(cr_map)
 *     workframe[crs_list] = np.nan             # <<<<<<<<<<<<<<
 * 
 *     for icr in range(len(crs_list[0])):
 */
  __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2210, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_nan); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2210, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  if (unlikely(PyObject_SetItem(((PyObject *)__pyx_v_workframe), __pyx_v_crs_list, __pyx_t_4) < 0)) __PYX_ERR(0, 2210, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;

  /* "orb/cutils.pyx":2212
 *     workframe[crs_list] = np.nan
 * 
 *     for icr in range(len(crs_list[0])):             # <<<<<<<<<<<<<<
 *         ix = crs_list[0][icr]
 *         iy = crs_list[1][icr]
 */
  __pyx_t_4 = __Pyx_GetItemInt(__pyx_v_crs_list, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2212, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_6 = PyObject_Length(__pyx_t_4); if (unlikely(__pyx_t_6 == -1)) __PYX_ERR(0, 2212, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  for (__pyx_t_7 = 0; __pyx_t_7 < __pyx_t_6; __pyx_t_7+=1) {
    __pyx_v_icr = __pyx_t_7;

    /* "orb/cutils.pyx":2213
 * 
 *     for icr in range(len(crs_list[0])):
 *         ix = crs_list[0][icr]             # <<<<<<<<<<<<<<
 *         iy = crs_list[1][icr]
 *         xmin, xmax, ymin, ymax = get_box_coords(
 */
    __pyx_t_4 = __Pyx_GetItemInt(__pyx_v_crs_list, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2213, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __pyx_t_1 = __Pyx_GetItemInt(__pyx_t_4, __pyx_v_icr, int, 1, __Pyx_PyInt_From_int, 0, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2213, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_t_8 = __Pyx_PyInt_As_int(__pyx_t_1); if (unlikely((__pyx_t_8 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 2213, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    __pyx_v_ix = __pyx_t_8;

    /* "orb/cutils.pyx":2214
 *     for icr in range(len(crs_list[0])):
 *         ix = crs_list[0][icr]
 *         iy = crs_list[1][icr]             # <<<<<<<<<<<<<<
 *         xmin, xmax, ymin, ymax = get_box_coords(
 *             ix, iy, box_size,
 */
    __pyx_t_1 = __Pyx_GetItemInt(__pyx_v_crs_list, 1, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2214, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __pyx_t_4 = __Pyx_GetItemInt(__pyx_t_1, __pyx_v_icr, int, 1, __Pyx_PyInt_From_int, 0, 0, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2214, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    __pyx_t_8 = __Pyx_PyInt_As_int(__pyx_t_4); if (unlikely((__pyx_t_8 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 2214, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_v_iy = __pyx_t_8;

    /* "orb/cutils.pyx":2215
 *         ix = crs_list[0][icr]
 *         iy = crs_list[1][icr]
 *         xmin, xmax, ymin, ymax = get_box_coords(             # <<<<<<<<<<<<<<
 *             ix, iy, box_size,
 *             0, workframe.shape[0], 0, workframe.shape[1])
 */
    __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_get_box_coords); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2215, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);

    /* "orb/cutils.pyx":2216
 *         iy = crs_list[1][icr]
 *         xmin, xmax, ymin, ymax = get_box_coords(
 *             ix, iy, box_size,             # <<<<<<<<<<<<<<
 *             0, workframe.shape[0], 0, workframe.shape[1])
 * 
 */
    __pyx_t_2 = __Pyx_PyInt_From_int(__pyx_v_ix); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 2216, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __pyx_t_3 = __Pyx_PyInt_From_int(__pyx_v_iy); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 2216, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __pyx_t_9 = __Pyx_PyInt_From_int(__pyx_v_box_size); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 2216, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_9);

    /* "orb/cutils.pyx":2217
 *         xmin, xmax, ymin, ymax = get_box_coords(
 *             ix, iy, box_size,
 *             0, workframe.shape[0], 0, workframe.shape[1])             # <<<<<<<<<<<<<<
 * 
 *         if xmax - xmin == box_size and ymax - ymin == box_size:
 */
    __pyx_t_10 = __Pyx_PyInt_From_Py_intptr_t((__pyx_v_workframe->dimensions[0])); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 2217, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_10);
    __pyx_t_11 = __Pyx_PyInt_From_Py_intptr_t((__pyx_v_workframe->dimensions[1])); if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 2217, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_11);
    __pyx_t_12 = NULL;
    __pyx_t_13 = 0;
    if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_1))) {
      __pyx_t_12 = PyMethod_GET_SELF(__pyx_t_1);
      if (likely(__pyx_t_12)) {
        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_1);
        __Pyx_INCREF(__pyx_t_12);
        __Pyx_INCREF(function);
        __Pyx_DECREF_SET(__pyx_t_1, function);
        __pyx_t_13 = 1;
      }
    }
    __pyx_t_14 = PyTuple_New(7+__pyx_t_13); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 2215, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_14);
    if (__pyx_t_12) {
      __Pyx_GIVEREF(__pyx_t_12); PyTuple_SET_ITEM(__pyx_t_14, 0, __pyx_t_12); __pyx_t_12 = NULL;
    }
    __Pyx_GIVEREF(__pyx_t_2);
    PyTuple_SET_ITEM(__pyx_t_14, 0+__pyx_t_13, __pyx_t_2);
    __Pyx_GIVEREF(__pyx_t_3);
    PyTuple_SET_ITEM(__pyx_t_14, 1+__pyx_t_13, __pyx_t_3);
    __Pyx_GIVEREF(__pyx_t_9);
    PyTuple_SET_ITEM(__pyx_t_14, 2+__pyx_t_13, __pyx_t_9);
    __Pyx_INCREF(__pyx_int_0);
    __Pyx_GIVEREF(__pyx_int_0);
    PyTuple_SET_ITEM(__pyx_t_14, 3+__pyx_t_13, __pyx_int_0);
    __Pyx_GIVEREF(__pyx_t_10);
    PyTuple_SET_ITEM(__pyx_t_14, 4+__pyx_t_13, __pyx_t_10);
    __Pyx_INCREF(__pyx_int_0);
    __Pyx_GIVEREF(__pyx_int_0);
    PyTuple_SET_ITEM(__pyx_t_14, 5+__pyx_t_13, __pyx_int_0);
    __Pyx_GIVEREF(__pyx_t_11);
    PyTuple_SET_ITEM(__pyx_t_14, 6+__pyx_t_13, __pyx_t_11);
    __pyx_t_2 = 0;
    __pyx_t_3 = 0;
    __pyx_t_9 = 0;
    __pyx_t_10 = 0;
    __pyx_t_11 = 0;
    __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_1, __pyx_t_14, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2215, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    if ((likely(PyTuple_CheckExact(__pyx_t_4))) || (PyList_CheckExact(__pyx_t_4))) {
      PyObject* sequence = __pyx_t_4;
      #if CYTHON_COMPILING_IN_CPYTHON
      Py_ssize_t size = Py_SIZE(sequence);
      #else
      Py_ssize_t size = PySequence_Size(sequence);
      #endif
      if (unlikely(size != 4)) {
        if (size > 4) __Pyx_RaiseTooManyValuesError(4);
        else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
        __PYX_ERR(0, 2215, __pyx_L1_error)
      }
      #if CYTHON_COMPILING_IN_CPYTHON
      if (likely(PyTuple_CheckExact(sequence))) {
        __pyx_t_1 = PyTuple_GET_ITEM(sequence, 0); 
        __pyx_t_14 = PyTuple_GET_ITEM(sequence, 1); 
        __pyx_t_11 = PyTuple_GET_ITEM(sequence, 2); 
        __pyx_t_10 = PyTuple_GET_ITEM(sequence, 3); 
      } else {
        __pyx_t_1 = PyList_GET_ITEM(sequence, 0); 
        __pyx_t_14 = PyList_GET_ITEM(sequence, 1); 
        __pyx_t_11 = PyList_GET_ITEM(sequence, 2); 
        __pyx_t_10 = PyList_GET_ITEM(sequence, 3); 
      }
      __Pyx_INCREF(__pyx_t_1);
      __Pyx_INCREF(__pyx_t_14);
      __Pyx_INCREF(__pyx_t_11);
      __Pyx_INCREF(__pyx_t_10);
      #else
      {
        Py_ssize_t i;
        PyObject** temps[4] = {&__pyx_t_1,&__pyx_t_14,&__pyx_t_11,&__pyx_t_10};
        for (i=0; i < 4; i++) {
          PyObject* item = PySequence_ITEM(sequence, i); if (unlikely(!item)) __PYX_ERR(0, 2215, __pyx_L1_error)
          __Pyx_GOTREF(item);
          *(temps[i]) = item;
        }
      }
      #endif
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    } else {
      Py_ssize_t index = -1;
      PyObject** temps[4] = {&__pyx_t_1,&__pyx_t_14,&__pyx_t_11,&__pyx_t_10};
      __pyx_t_9 = PyObject_GetIter(__pyx_t_4); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 2215, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_9);
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __pyx_t_15 = Py_TYPE(__pyx_t_9)->tp_iternext;
      for (index=0; index < 4; index++) {
        PyObject* item = __pyx_t_15(__pyx_t_9); if (unlikely(!item)) goto __pyx_L5_unpacking_failed;
        __Pyx_GOTREF(item);
        *(temps[index]) = item;
      }
      if (__Pyx_IternextUnpackEndCheck(__pyx_t_15(__pyx_t_9), 4) < 0) __PYX_ERR(0, 2215, __pyx_L1_error)
      __pyx_t_15 = NULL;
      __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
      goto __pyx_L6_unpacking_done;
      __pyx_L5_unpacking_failed:;
      __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
      __pyx_t_15 = NULL;
      if (__Pyx_IterFinish() == 0) __Pyx_RaiseNeedMoreValuesError(index);
      __PYX_ERR(0, 2215, __pyx_L1_error)
      __pyx_L6_unpacking_done:;
    }

    /* "orb/cutils.pyx":2215
 *         ix = crs_list[0][icr]
 *         iy = crs_list[1][icr]
 *         xmin, xmax, ymin, ymax = get_box_coords(             # <<<<<<<<<<<<<<
 *             ix, iy, box_size,
 *             0, workframe.shape[0], 0, workframe.shape[1])
 */
    __pyx_t_8 = __Pyx_PyInt_As_int(__pyx_t_1); if (unlikely((__pyx_t_8 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 2215, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    __pyx_t_16 = __Pyx_PyInt_As_int(__pyx_t_14); if (unlikely((__pyx_t_16 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 2215, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
    __pyx_t_17 = __Pyx_PyInt_As_int(__pyx_t_11); if (unlikely((__pyx_t_17 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 2215, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_11); __pyx_t_11 = 0;
    __pyx_t_18 = __Pyx_PyInt_As_int(__pyx_t_10); if (unlikely((__pyx_t_18 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 2215, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
    __pyx_v_xmin = __pyx_t_8;
    __pyx_v_xmax = __pyx_t_16;
    __pyx_v_ymin = __pyx_t_17;
    __pyx_v_ymax = __pyx_t_18;

    /* "orb/cutils.pyx":2219
 *             0, workframe.shape[0], 0, workframe.shape[1])
 * 
 *         if xmax - xmin == box_size and ymax - ymin == box_size:             # <<<<<<<<<<<<<<
 *             box = np.copy(workframe[xmin:xmax, ymin:ymax])
 *             if not np.all(np.isnan(box)):
 */
    __pyx_t_20 = (((__pyx_v_xmax - __pyx_v_xmin) == __pyx_v_box_size) != 0);
    if (__pyx_t_20) {
    } else {
      __pyx_t_19 = __pyx_t_20;
      goto __pyx_L8_bool_binop_done;
    }
    __pyx_t_20 = (((__pyx_v_ymax - __pyx_v_ymin) == __pyx_v_box_size) != 0);
    __pyx_t_19 = __pyx_t_20;
    __pyx_L8_bool_binop_done:;
    if (__pyx_t_19) {

      /* "orb/cutils.pyx":2220
 * 
 *         if xmax - xmin == box_size and ymax - ymin == box_size:
 *             box = np.copy(workframe[xmin:xmax, ymin:ymax])             # <<<<<<<<<<<<<<
 *             if not np.all(np.isnan(box)):
 *                 boxstd = bn.nanstd(box)
 */
      __pyx_t_10 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 2220, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_10);
      __pyx_t_11 = __Pyx_PyObject_GetAttrStr(__pyx_t_10, __pyx_n_s_copy); if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 2220, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_11);
      __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
      __pyx_t_10 = __Pyx_PyInt_From_int(__pyx_v_xmin); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 2220, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_10);
      __pyx_t_14 = __Pyx_PyInt_From_int(__pyx_v_xmax); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 2220, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_14);
      __pyx_t_1 = PySlice_New(__pyx_t_10, __pyx_t_14, Py_None); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2220, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);
      __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
      __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
      __pyx_t_14 = __Pyx_PyInt_From_int(__pyx_v_ymin); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 2220, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_14);
      __pyx_t_10 = __Pyx_PyInt_From_int(__pyx_v_ymax); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 2220, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_10);
      __pyx_t_9 = PySlice_New(__pyx_t_14, __pyx_t_10, Py_None); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 2220, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_9);
      __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
      __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
      __pyx_t_10 = PyTuple_New(2); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 2220, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_10);
      __Pyx_GIVEREF(__pyx_t_1);
      PyTuple_SET_ITEM(__pyx_t_10, 0, __pyx_t_1);
      __Pyx_GIVEREF(__pyx_t_9);
      PyTuple_SET_ITEM(__pyx_t_10, 1, __pyx_t_9);
      __pyx_t_1 = 0;
      __pyx_t_9 = 0;
      __pyx_t_9 = PyObject_GetItem(((PyObject *)__pyx_v_workframe), __pyx_t_10); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 2220, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_9);
      __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
      __pyx_t_10 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_11))) {
        __pyx_t_10 = PyMethod_GET_SELF(__pyx_t_11);
        if (likely(__pyx_t_10)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_11);
          __Pyx_INCREF(__pyx_t_10);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_11, function);
        }
      }
      if (!__pyx_t_10) {
        __pyx_t_4 = __Pyx_PyObject_CallOneArg(__pyx_t_11, __pyx_t_9); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2220, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
        __Pyx_GOTREF(__pyx_t_4);
      } else {
        __pyx_t_1 = PyTuple_New(1+1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2220, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_1);
        __Pyx_GIVEREF(__pyx_t_10); PyTuple_SET_ITEM(__pyx_t_1, 0, __pyx_t_10); __pyx_t_10 = NULL;
        __Pyx_GIVEREF(__pyx_t_9);
        PyTuple_SET_ITEM(__pyx_t_1, 0+1, __pyx_t_9);
        __pyx_t_9 = 0;
        __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_11, __pyx_t_1, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2220, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_4);
        __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
      }
      __Pyx_DECREF(__pyx_t_11); __pyx_t_11 = 0;
      if (!(likely(((__pyx_t_4) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_4, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 2220, __pyx_L1_error)
      __pyx_t_21 = ((PyArrayObject *)__pyx_t_4);
      {
        __Pyx_BufFmt_StackElem __pyx_stack[1];
        __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_box.rcbuffer->pybuffer);
        __pyx_t_18 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_box.rcbuffer->pybuffer, (PyObject*)__pyx_t_21, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
        if (unlikely(__pyx_t_18 < 0)) {
          PyErr_Fetch(&__pyx_t_22, &__pyx_t_23, &__pyx_t_24);
          if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_box.rcbuffer->pybuffer, (PyObject*)__pyx_v_box, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
            Py_XDECREF(__pyx_t_22); Py_XDECREF(__pyx_t_23); Py_XDECREF(__pyx_t_24);
            __Pyx_RaiseBufferFallbackError();
          } else {
            PyErr_Restore(__pyx_t_22, __pyx_t_23, __pyx_t_24);
          }
        }
        __pyx_pybuffernd_box.diminfo[0].strides = __pyx_pybuffernd_box.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_box.diminfo[0].shape = __pyx_pybuffernd_box.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_box.diminfo[1].strides = __pyx_pybuffernd_box.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_box.diminfo[1].shape = __pyx_pybuffernd_box.rcbuffer->pybuffer.shape[1];
        if (unlikely(__pyx_t_18 < 0)) __PYX_ERR(0, 2220, __pyx_L1_error)
      }
      __pyx_t_21 = 0;
      __Pyx_XDECREF_SET(__pyx_v_box, ((PyArrayObject *)__pyx_t_4));
      __pyx_t_4 = 0;

      /* "orb/cutils.pyx":2221
 *         if xmax - xmin == box_size and ymax - ymin == box_size:
 *             box = np.copy(workframe[xmin:xmax, ymin:ymax])
 *             if not np.all(np.isnan(box)):             # <<<<<<<<<<<<<<
 *                 boxstd = bn.nanstd(box)
 *                 boxmed = bn.nanmedian(box)
 */
      __pyx_t_11 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 2221, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_11);
      __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_11, __pyx_n_s_all); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2221, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);
      __Pyx_DECREF(__pyx_t_11); __pyx_t_11 = 0;
      __pyx_t_9 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 2221, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_9);
      __pyx_t_10 = __Pyx_PyObject_GetAttrStr(__pyx_t_9, __pyx_n_s_isnan); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 2221, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_10);
      __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
      __pyx_t_9 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_10))) {
        __pyx_t_9 = PyMethod_GET_SELF(__pyx_t_10);
        if (likely(__pyx_t_9)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_10);
          __Pyx_INCREF(__pyx_t_9);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_10, function);
        }
      }
      if (!__pyx_t_9) {
        __pyx_t_11 = __Pyx_PyObject_CallOneArg(__pyx_t_10, ((PyObject *)__pyx_v_box)); if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 2221, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_11);
      } else {
        __pyx_t_14 = PyTuple_New(1+1); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 2221, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_14);
        __Pyx_GIVEREF(__pyx_t_9); PyTuple_SET_ITEM(__pyx_t_14, 0, __pyx_t_9); __pyx_t_9 = NULL;
        __Pyx_INCREF(((PyObject *)__pyx_v_box));
        __Pyx_GIVEREF(((PyObject *)__pyx_v_box));
        PyTuple_SET_ITEM(__pyx_t_14, 0+1, ((PyObject *)__pyx_v_box));
        __pyx_t_11 = __Pyx_PyObject_Call(__pyx_t_10, __pyx_t_14, NULL); if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 2221, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_11);
        __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
      }
      __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
      __pyx_t_10 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_1))) {
        __pyx_t_10 = PyMethod_GET_SELF(__pyx_t_1);
        if (likely(__pyx_t_10)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_1);
          __Pyx_INCREF(__pyx_t_10);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_1, function);
        }
      }
      if (!__pyx_t_10) {
        __pyx_t_4 = __Pyx_PyObject_CallOneArg(__pyx_t_1, __pyx_t_11); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2221, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_11); __pyx_t_11 = 0;
        __Pyx_GOTREF(__pyx_t_4);
      } else {
        __pyx_t_14 = PyTuple_New(1+1); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 2221, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_14);
        __Pyx_GIVEREF(__pyx_t_10); PyTuple_SET_ITEM(__pyx_t_14, 0, __pyx_t_10); __pyx_t_10 = NULL;
        __Pyx_GIVEREF(__pyx_t_11);
        PyTuple_SET_ITEM(__pyx_t_14, 0+1, __pyx_t_11);
        __pyx_t_11 = 0;
        __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_1, __pyx_t_14, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2221, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_4);
        __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
      }
      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
      __pyx_t_19 = __Pyx_PyObject_IsTrue(__pyx_t_4); if (unlikely(__pyx_t_19 < 0)) __PYX_ERR(0, 2221, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __pyx_t_20 = ((!__pyx_t_19) != 0);
      if (__pyx_t_20) {

        /* "orb/cutils.pyx":2222
 *             box = np.copy(workframe[xmin:xmax, ymin:ymax])
 *             if not np.all(np.isnan(box)):
 *                 boxstd = bn.nanstd(box)             # <<<<<<<<<<<<<<
 *                 boxmed = bn.nanmedian(box)
 *                 for ii in range(xmin, xmax):
 */
        __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2222, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_1);
        __pyx_t_14 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_nanstd); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 2222, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_14);
        __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
        __pyx_t_1 = NULL;
        if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_14))) {
          __pyx_t_1 = PyMethod_GET_SELF(__pyx_t_14);
          if (likely(__pyx_t_1)) {
            PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_14);
            __Pyx_INCREF(__pyx_t_1);
            __Pyx_INCREF(function);
            __Pyx_DECREF_SET(__pyx_t_14, function);
          }
        }
        if (!__pyx_t_1) {
          __pyx_t_4 = __Pyx_PyObject_CallOneArg(__pyx_t_14, ((PyObject *)__pyx_v_box)); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2222, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_4);
        } else {
          __pyx_t_11 = PyTuple_New(1+1); if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 2222, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_11);
          __Pyx_GIVEREF(__pyx_t_1); PyTuple_SET_ITEM(__pyx_t_11, 0, __pyx_t_1); __pyx_t_1 = NULL;
          __Pyx_INCREF(((PyObject *)__pyx_v_box));
          __Pyx_GIVEREF(((PyObject *)__pyx_v_box));
          PyTuple_SET_ITEM(__pyx_t_11, 0+1, ((PyObject *)__pyx_v_box));
          __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_14, __pyx_t_11, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2222, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_4);
          __Pyx_DECREF(__pyx_t_11); __pyx_t_11 = 0;
        }
        __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
        __pyx_t_25 = __pyx_PyFloat_AsDouble(__pyx_t_4); if (unlikely((__pyx_t_25 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 2222, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
        __pyx_v_boxstd = __pyx_t_25;

        /* "orb/cutils.pyx":2223
 *             if not np.all(np.isnan(box)):
 *                 boxstd = bn.nanstd(box)
 *                 boxmed = bn.nanmedian(box)             # <<<<<<<<<<<<<<
 *                 for ii in range(xmin, xmax):
 *                     for ij in range(ymin, ymax):
 */
        __pyx_t_14 = __Pyx_GetModuleGlobalName(__pyx_n_s_bn); if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 2223, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_14);
        __pyx_t_11 = __Pyx_PyObject_GetAttrStr(__pyx_t_14, __pyx_n_s_nanmedian); if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 2223, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_11);
        __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
        __pyx_t_14 = NULL;
        if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_11))) {
          __pyx_t_14 = PyMethod_GET_SELF(__pyx_t_11);
          if (likely(__pyx_t_14)) {
            PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_11);
            __Pyx_INCREF(__pyx_t_14);
            __Pyx_INCREF(function);
            __Pyx_DECREF_SET(__pyx_t_11, function);
          }
        }
        if (!__pyx_t_14) {
          __pyx_t_4 = __Pyx_PyObject_CallOneArg(__pyx_t_11, ((PyObject *)__pyx_v_box)); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2223, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_4);
        } else {
          __pyx_t_1 = PyTuple_New(1+1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2223, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_1);
          __Pyx_GIVEREF(__pyx_t_14); PyTuple_SET_ITEM(__pyx_t_1, 0, __pyx_t_14); __pyx_t_14 = NULL;
          __Pyx_INCREF(((PyObject *)__pyx_v_box));
          __Pyx_GIVEREF(((PyObject *)__pyx_v_box));
          PyTuple_SET_ITEM(__pyx_t_1, 0+1, ((PyObject *)__pyx_v_box));
          __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_11, __pyx_t_1, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2223, __pyx_L1_error)
          __Pyx_GOTREF(__pyx_t_4);
          __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
        }
        __Pyx_DECREF(__pyx_t_11); __pyx_t_11 = 0;
        __pyx_t_25 = __pyx_PyFloat_AsDouble(__pyx_t_4); if (unlikely((__pyx_t_25 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 2223, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
        __pyx_v_boxmed = __pyx_t_25;

        /* "orb/cutils.pyx":2224
 *                 boxstd = bn.nanstd(box)
 *                 boxmed = bn.nanmedian(box)
 *                 for ii in range(xmin, xmax):             # <<<<<<<<<<<<<<
 *                     for ij in range(ymin, ymax):
 *                         if frame[ii, ij] > boxmed + detect_coeff * boxstd:
 */
        __pyx_t_18 = __pyx_v_xmax;
        for (__pyx_t_17 = __pyx_v_xmin; __pyx_t_17 < __pyx_t_18; __pyx_t_17+=1) {
          __pyx_v_ii = __pyx_t_17;

          /* "orb/cutils.pyx":2225
 *                 boxmed = bn.nanmedian(box)
 *                 for ii in range(xmin, xmax):
 *                     for ij in range(ymin, ymax):             # <<<<<<<<<<<<<<
 *                         if frame[ii, ij] > boxmed + detect_coeff * boxstd:
 *                             cr_map[ii,ij] = 1
 */
          __pyx_t_16 = __pyx_v_ymax;
          for (__pyx_t_8 = __pyx_v_ymin; __pyx_t_8 < __pyx_t_16; __pyx_t_8+=1) {
            __pyx_v_ij = __pyx_t_8;

            /* "orb/cutils.pyx":2226
 *                 for ii in range(xmin, xmax):
 *                     for ij in range(ymin, ymax):
 *                         if frame[ii, ij] > boxmed + detect_coeff * boxstd:             # <<<<<<<<<<<<<<
 *                             cr_map[ii,ij] = 1
 * 
 */
            __pyx_t_26 = __pyx_v_ii;
            __pyx_t_27 = __pyx_v_ij;
            __pyx_t_20 = (((*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_frame.rcbuffer->pybuffer.buf, __pyx_t_26, __pyx_pybuffernd_frame.diminfo[0].strides, __pyx_t_27, __pyx_pybuffernd_frame.diminfo[1].strides)) > (__pyx_v_boxmed + (__pyx_v_detect_coeff * __pyx_v_boxstd))) != 0);
            if (__pyx_t_20) {

              /* "orb/cutils.pyx":2227
 *                     for ij in range(ymin, ymax):
 *                         if frame[ii, ij] > boxmed + detect_coeff * boxstd:
 *                             cr_map[ii,ij] = 1             # <<<<<<<<<<<<<<
 * 
 *     return cr_map
 */
              __pyx_t_28 = __pyx_v_ii;
              __pyx_t_29 = __pyx_v_ij;
              *__Pyx_BufPtrStrided2d(__pyx_t_5numpy_uint8_t *, __pyx_pybuffernd_cr_map.rcbuffer->pybuffer.buf, __pyx_t_28, __pyx_pybuffernd_cr_map.diminfo[0].strides, __pyx_t_29, __pyx_pybuffernd_cr_map.diminfo[1].strides) = 1;

              /* "orb/cutils.pyx":2226
 *                 for ii in range(xmin, xmax):
 *                     for ij in range(ymin, ymax):
 *                         if frame[ii, ij] > boxmed + detect_coeff * boxstd:             # <<<<<<<<<<<<<<
 *                             cr_map[ii,ij] = 1
 * 
 */
            }
          }
        }

        /* "orb/cutils.pyx":2221
 *         if xmax - xmin == box_size and ymax - ymin == box_size:
 *             box = np.copy(workframe[xmin:xmax, ymin:ymax])
 *             if not np.all(np.isnan(box)):             # <<<<<<<<<<<<<<
 *                 boxstd = bn.nanstd(box)
 *                 boxmed = bn.nanmedian(box)
 */
      }

      /* "orb/cutils.pyx":2219
 *             0, workframe.shape[0], 0, workframe.shape[1])
 * 
 *         if xmax - xmin == box_size and ymax - ymin == box_size:             # <<<<<<<<<<<<<<
 *             box = np.copy(workframe[xmin:xmax, ymin:ymax])
 *             if not np.all(np.isnan(box)):
 */
    }
  }

  /* "orb/cutils.pyx":2229
 *                             cr_map[ii,ij] = 1
 * 
 *     return cr_map             # <<<<<<<<<<<<<<
 * 
 * 
 */
  __Pyx_XDECREF(__pyx_r);
  __Pyx_INCREF(((PyObject *)__pyx_v_cr_map));
  __pyx_r = ((PyObject *)__pyx_v_cr_map);
  goto __pyx_L0;

  /* "orb/cutils.pyx":2187
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def check_cosmic_rays_neighbourhood(             # <<<<<<<<<<<<<<
 *     np.ndarray[np.float64_t, ndim=2] frame,
 *     np.ndarray[np.uint8_t, ndim=2] cr_map,
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_1);
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_XDECREF(__pyx_t_9);
  __Pyx_XDECREF(__pyx_t_10);
  __Pyx_XDECREF(__pyx_t_11);
  __Pyx_XDECREF(__pyx_t_12);
  __Pyx_XDECREF(__pyx_t_14);
  { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
    __Pyx_PyThreadState_declare
    __Pyx_PyThreadState_assign
    __Pyx_ErrFetch(&__pyx_type, &__pyx_value, &__pyx_tb);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_box.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_cr_map.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_frame.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_workframe.rcbuffer->pybuffer);
  __Pyx_ErrRestore(__pyx_type, __pyx_value, __pyx_tb);}
  __Pyx_AddTraceback("orb.cutils.check_cosmic_rays_neighbourhood", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  goto __pyx_L2;
  __pyx_L0:;
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_box.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_cr_map.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_frame.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_workframe.rcbuffer->pybuffer);
  __pyx_L2:;
  __Pyx_XDECREF((PyObject *)__pyx_v_workframe);
  __Pyx_XDECREF((PyObject *)__pyx_v_box);
  __Pyx_XDECREF(__pyx_v_crs_list);
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":2234
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def fast_w2pix(np.ndarray[np.float64_t, ndim=1] w,             # <<<<<<<<<<<<<<
 *                double axis_min, double axis_step):
 *     """Fast conversion of wavelength/wavenumber to pixel
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_81fast_w2pix(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_3orb_6cutils_80fast_w2pix[] = "fast_w2pix(ndarray w, double axis_min, double axis_step)\nFast conversion of wavelength/wavenumber to pixel\n\n    :param w: wavelength/wavenumber\n    \n    :param axis_min: min axis wavelength/wavenumber\n    \n    :param axis_step: axis step size in wavelength/wavenumber\n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_81fast_w2pix = {"fast_w2pix", (PyCFunction)__pyx_pw_3orb_6cutils_81fast_w2pix, METH_VARARGS|METH_KEYWORDS, __pyx_doc_3orb_6cutils_80fast_w2pix};
static PyObject *__pyx_pw_3orb_6cutils_81fast_w2pix(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  PyArrayObject *__pyx_v_w = 0;
  double __pyx_v_axis_min;
  double __pyx_v_axis_step;
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("fast_w2pix (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_w,&__pyx_n_s_axis_min,&__pyx_n_s_axis_step,0};
    PyObject* values[3] = {0,0,0};
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
      switch (pos_args) {
        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = PyDict_Size(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_w)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        case  1:
        if (likely((values[1] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_axis_min)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("fast_w2pix", 1, 3, 3, 1); __PYX_ERR(0, 2234, __pyx_L3_error)
        }
        case  2:
        if (likely((values[2] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_axis_step)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("fast_w2pix", 1, 3, 3, 2); __PYX_ERR(0, 2234, __pyx_L3_error)
        }
      }
      if (unlikely(kw_args > 0)) {
        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "fast_w2pix") < 0)) __PYX_ERR(0, 2234, __pyx_L3_error)
      }
    } else if (PyTuple_GET_SIZE(__pyx_args) != 3) {
      goto __pyx_L5_argtuple_error;
    } else {
      values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
      values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
      values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
    }
    __pyx_v_w = ((PyArrayObject *)values[0]);
    __pyx_v_axis_min = __pyx_PyFloat_AsDouble(values[1]); if (unlikely((__pyx_v_axis_min == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 2235, __pyx_L3_error)
    __pyx_v_axis_step = __pyx_PyFloat_AsDouble(values[2]); if (unlikely((__pyx_v_axis_step == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 2235, __pyx_L3_error)
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  __Pyx_RaiseArgtupleInvalid("fast_w2pix", 1, 3, 3, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 2234, __pyx_L3_error)
  __pyx_L3_error:;
  __Pyx_AddTraceback("orb.cutils.fast_w2pix", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __Pyx_RefNannyFinishContext();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_w), __pyx_ptype_5numpy_ndarray, 1, "w", 0))) __PYX_ERR(0, 2234, __pyx_L1_error)
  __pyx_r = __pyx_pf_3orb_6cutils_80fast_w2pix(__pyx_self, __pyx_v_w, __pyx_v_axis_min, __pyx_v_axis_step);

  /* function exit code */
  goto __pyx_L0;
  __pyx_L1_error:;
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_80fast_w2pix(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_w, double __pyx_v_axis_min, double __pyx_v_axis_step) {
  __Pyx_LocalBuf_ND __pyx_pybuffernd_w;
  __Pyx_Buffer __pyx_pybuffer_w;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  PyObject *__pyx_t_1 = NULL;
  PyObject *__pyx_t_2 = NULL;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  PyObject *__pyx_t_5 = NULL;
  __Pyx_RefNannySetupContext("fast_w2pix", 0);
  __pyx_pybuffer_w.pybuffer.buf = NULL;
  __pyx_pybuffer_w.refcount = 0;
  __pyx_pybuffernd_w.data = NULL;
  __pyx_pybuffernd_w.rcbuffer = &__pyx_pybuffer_w;
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_w.rcbuffer->pybuffer, (PyObject*)__pyx_v_w, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) __PYX_ERR(0, 2234, __pyx_L1_error)
  }
  __pyx_pybuffernd_w.diminfo[0].strides = __pyx_pybuffernd_w.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_w.diminfo[0].shape = __pyx_pybuffernd_w.rcbuffer->pybuffer.shape[0];

  /* "orb/cutils.pyx":2244
 *     :param axis_step: axis step size in wavelength/wavenumber
 *     """
 *     return np.abs(w - axis_min) / axis_step             # <<<<<<<<<<<<<<
 * 
 * @cython.boundscheck(False)
 */
  __Pyx_XDECREF(__pyx_r);
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 2244, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_abs); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 2244, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = PyFloat_FromDouble(__pyx_v_axis_min); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 2244, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_4 = PyNumber_Subtract(((PyObject *)__pyx_v_w), __pyx_t_2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2244, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_3))) {
    __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_3);
    if (likely(__pyx_t_2)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
      __Pyx_INCREF(__pyx_t_2);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_3, function);
    }
  }
  if (!__pyx_t_2) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_3, __pyx_t_4); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2244, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_5 = PyTuple_New(1+1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 2244, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_2); __pyx_t_2 = NULL;
    __Pyx_GIVEREF(__pyx_t_4);
    PyTuple_SET_ITEM(__pyx_t_5, 0+1, __pyx_t_4);
    __pyx_t_4 = 0;
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_5, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2244, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  }
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_3 = PyFloat_FromDouble(__pyx_v_axis_step); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 2244, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_5 = __Pyx_PyNumber_Divide(__pyx_t_1, __pyx_t_3); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 2244, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_r = __pyx_t_5;
  __pyx_t_5 = 0;
  goto __pyx_L0;

  /* "orb/cutils.pyx":2234
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def fast_w2pix(np.ndarray[np.float64_t, ndim=1] w,             # <<<<<<<<<<<<<<
 *                double axis_min, double axis_step):
 *     """Fast conversion of wavelength/wavenumber to pixel
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_1);
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_XDECREF(__pyx_t_5);
  { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
    __Pyx_PyThreadState_declare
    __Pyx_PyThreadState_assign
    __Pyx_ErrFetch(&__pyx_type, &__pyx_value, &__pyx_tb);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_w.rcbuffer->pybuffer);
  __Pyx_ErrRestore(__pyx_type, __pyx_value, __pyx_tb);}
  __Pyx_AddTraceback("orb.cutils.fast_w2pix", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  goto __pyx_L2;
  __pyx_L0:;
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_w.rcbuffer->pybuffer);
  __pyx_L2:;
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":2248
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def fast_pix2w(np.ndarray[np.float64_t, ndim=1] pix,             # <<<<<<<<<<<<<<
 *                double axis_min, double axis_step):
 *     """Fast conversion of pixel to wavelength/wavenumber
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_83fast_pix2w(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_3orb_6cutils_82fast_pix2w[] = "fast_pix2w(ndarray pix, double axis_min, double axis_step)\nFast conversion of pixel to wavelength/wavenumber\n\n    :param pix: position along axis in pixels\n    \n    :param axis_min: min axis wavelength/wavenumber\n    \n    :param axis_step: axis step size in wavelength/wavenumber\n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_83fast_pix2w = {"fast_pix2w", (PyCFunction)__pyx_pw_3orb_6cutils_83fast_pix2w, METH_VARARGS|METH_KEYWORDS, __pyx_doc_3orb_6cutils_82fast_pix2w};
static PyObject *__pyx_pw_3orb_6cutils_83fast_pix2w(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  PyArrayObject *__pyx_v_pix = 0;
  double __pyx_v_axis_min;
  double __pyx_v_axis_step;
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("fast_pix2w (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_pix,&__pyx_n_s_axis_min,&__pyx_n_s_axis_step,0};
    PyObject* values[3] = {0,0,0};
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
      switch (pos_args) {
        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = PyDict_Size(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_pix)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        case  1:
        if (likely((values[1] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_axis_min)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("fast_pix2w", 1, 3, 3, 1); __PYX_ERR(0, 2248, __pyx_L3_error)
        }
        case  2:
        if (likely((values[2] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_axis_step)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("fast_pix2w", 1, 3, 3, 2); __PYX_ERR(0, 2248, __pyx_L3_error)
        }
      }
      if (unlikely(kw_args > 0)) {
        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "fast_pix2w") < 0)) __PYX_ERR(0, 2248, __pyx_L3_error)
      }
    } else if (PyTuple_GET_SIZE(__pyx_args) != 3) {
      goto __pyx_L5_argtuple_error;
    } else {
      values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
      values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
      values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
    }
    __pyx_v_pix = ((PyArrayObject *)values[0]);
    __pyx_v_axis_min = __pyx_PyFloat_AsDouble(values[1]); if (unlikely((__pyx_v_axis_min == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 2249, __pyx_L3_error)
    __pyx_v_axis_step = __pyx_PyFloat_AsDouble(values[2]); if (unlikely((__pyx_v_axis_step == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 2249, __pyx_L3_error)
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  __Pyx_RaiseArgtupleInvalid("fast_pix2w", 1, 3, 3, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 2248, __pyx_L3_error)
  __pyx_L3_error:;
  __Pyx_AddTraceback("orb.cutils.fast_pix2w", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __Pyx_RefNannyFinishContext();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_pix), __pyx_ptype_5numpy_ndarray, 1, "pix", 0))) __PYX_ERR(0, 2248, __pyx_L1_error)
  __pyx_r = __pyx_pf_3orb_6cutils_82fast_pix2w(__pyx_self, __pyx_v_pix, __pyx_v_axis_min, __pyx_v_axis_step);

  /* function exit code */
  goto __pyx_L0;
  __pyx_L1_error:;
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_82fast_pix2w(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_pix, double __pyx_v_axis_min, double __pyx_v_axis_step) {
  __Pyx_LocalBuf_ND __pyx_pybuffernd_pix;
  __Pyx_Buffer __pyx_pybuffer_pix;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  PyObject *__pyx_t_1 = NULL;
  PyObject *__pyx_t_2 = NULL;
  PyObject *__pyx_t_3 = NULL;
  __Pyx_RefNannySetupContext("fast_pix2w", 0);
  __pyx_pybuffer_pix.pybuffer.buf = NULL;
  __pyx_pybuffer_pix.refcount = 0;
  __pyx_pybuffernd_pix.data = NULL;
  __pyx_pybuffernd_pix.rcbuffer = &__pyx_pybuffer_pix;
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_pix.rcbuffer->pybuffer, (PyObject*)__pyx_v_pix, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) __PYX_ERR(0, 2248, __pyx_L1_error)
  }
  __pyx_pybuffernd_pix.diminfo[0].strides = __pyx_pybuffernd_pix.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_pix.diminfo[0].shape = __pyx_pybuffernd_pix.rcbuffer->pybuffer.shape[0];

  /* "orb/cutils.pyx":2258
 *     :param axis_step: axis step size in wavelength/wavenumber
 *     """
 *     return pix * axis_step + axis_min             # <<<<<<<<<<<<<<
 * 
 * 
 */
  __Pyx_XDECREF(__pyx_r);
  __pyx_t_1 = PyFloat_FromDouble(__pyx_v_axis_step); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2258, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_2 = PyNumber_Multiply(((PyObject *)__pyx_v_pix), __pyx_t_1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 2258, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_1 = PyFloat_FromDouble(__pyx_v_axis_min); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2258, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_3 = PyNumber_Add(__pyx_t_2, __pyx_t_1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 2258, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_r = __pyx_t_3;
  __pyx_t_3 = 0;
  goto __pyx_L0;

  /* "orb/cutils.pyx":2248
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def fast_pix2w(np.ndarray[np.float64_t, ndim=1] pix,             # <<<<<<<<<<<<<<
 *                double axis_min, double axis_step):
 *     """Fast conversion of pixel to wavelength/wavenumber
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_1);
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_3);
  { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
    __Pyx_PyThreadState_declare
    __Pyx_PyThreadState_assign
    __Pyx_ErrFetch(&__pyx_type, &__pyx_value, &__pyx_tb);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_pix.rcbuffer->pybuffer);
  __Pyx_ErrRestore(__pyx_type, __pyx_value, __pyx_tb);}
  __Pyx_AddTraceback("orb.cutils.fast_pix2w", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  goto __pyx_L2;
  __pyx_L0:;
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_pix.rcbuffer->pybuffer);
  __pyx_L2:;
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":2261
 * 
 * 
 * def get_cm1_axis_min(int n, double step, int order, double corr=1.):             # <<<<<<<<<<<<<<
 *     """Return min wavenumber of a regular wavenumber axis in cm-1.
 * 
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_85get_cm1_axis_min(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_3orb_6cutils_84get_cm1_axis_min[] = "get_cm1_axis_min(int n, double step, int order, double corr=1.0)\nReturn min wavenumber of a regular wavenumber axis in cm-1.\n\n    :param n: Number of steps on the axis\n\n    :param step: Step size in nm\n    \n    :param order: Folding order\n    \n    :param corr: (Optional) Coefficient of correction (default 1.)\n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_85get_cm1_axis_min = {"get_cm1_axis_min", (PyCFunction)__pyx_pw_3orb_6cutils_85get_cm1_axis_min, METH_VARARGS|METH_KEYWORDS, __pyx_doc_3orb_6cutils_84get_cm1_axis_min};
static PyObject *__pyx_pw_3orb_6cutils_85get_cm1_axis_min(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  int __pyx_v_n;
  double __pyx_v_step;
  int __pyx_v_order;
  double __pyx_v_corr;
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("get_cm1_axis_min (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_n,&__pyx_n_s_step,&__pyx_n_s_order,&__pyx_n_s_corr,0};
    PyObject* values[4] = {0,0,0,0};
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
      switch (pos_args) {
        case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = PyDict_Size(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_n)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        case  1:
        if (likely((values[1] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_step)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("get_cm1_axis_min", 0, 3, 4, 1); __PYX_ERR(0, 2261, __pyx_L3_error)
        }
        case  2:
        if (likely((values[2] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_order)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("get_cm1_axis_min", 0, 3, 4, 2); __PYX_ERR(0, 2261, __pyx_L3_error)
        }
        case  3:
        if (kw_args > 0) {
          PyObject* value = PyDict_GetItem(__pyx_kwds, __pyx_n_s_corr);
          if (value) { values[3] = value; kw_args--; }
        }
      }
      if (unlikely(kw_args > 0)) {
        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "get_cm1_axis_min") < 0)) __PYX_ERR(0, 2261, __pyx_L3_error)
      }
    } else {
      switch (PyTuple_GET_SIZE(__pyx_args)) {
        case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        break;
        default: goto __pyx_L5_argtuple_error;
      }
    }
    __pyx_v_n = __Pyx_PyInt_As_int(values[0]); if (unlikely((__pyx_v_n == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 2261, __pyx_L3_error)
    __pyx_v_step = __pyx_PyFloat_AsDouble(values[1]); if (unlikely((__pyx_v_step == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 2261, __pyx_L3_error)
    __pyx_v_order = __Pyx_PyInt_As_int(values[2]); if (unlikely((__pyx_v_order == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 2261, __pyx_L3_error)
    if (values[3]) {
      __pyx_v_corr = __pyx_PyFloat_AsDouble(values[3]); if (unlikely((__pyx_v_corr == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 2261, __pyx_L3_error)
    } else {
      __pyx_v_corr = ((double)1.);
    }
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  __Pyx_RaiseArgtupleInvalid("get_cm1_axis_min", 0, 3, 4, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 2261, __pyx_L3_error)
  __pyx_L3_error:;
  __Pyx_AddTraceback("orb.cutils.get_cm1_axis_min", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __Pyx_RefNannyFinishContext();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  __pyx_r = __pyx_pf_3orb_6cutils_84get_cm1_axis_min(__pyx_self, __pyx_v_n, __pyx_v_step, __pyx_v_order, __pyx_v_corr);

  /* function exit code */
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_84get_cm1_axis_min(CYTHON_UNUSED PyObject *__pyx_self, int __pyx_v_n, double __pyx_v_step, int __pyx_v_order, double __pyx_v_corr) {
  double __pyx_v_cm1_min;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  double __pyx_t_1;
  int __pyx_t_2;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  PyObject *__pyx_t_5 = NULL;
  PyObject *__pyx_t_6 = NULL;
  PyObject *__pyx_t_7 = NULL;
  __Pyx_RefNannySetupContext("get_cm1_axis_min", 0);

  /* "orb/cutils.pyx":2275
 *     # removed in orb.utils.fft.transform_interferogram (after fft
 *     # spectrum is cropped to step_nb/2 instead of step_nb/2 + 1)
 *     cdef double cm1_min = <double> order / (2.* step) * corr * 1e7             # <<<<<<<<<<<<<<
 *     if order & 1:
 *         cm1_min += get_cm1_axis_step(n, step, corr=corr)
 */
  __pyx_t_1 = (2. * __pyx_v_step);
  if (unlikely(__pyx_t_1 == 0)) {
    PyErr_SetString(PyExc_ZeroDivisionError, "float division");
    __PYX_ERR(0, 2275, __pyx_L1_error)
  }
  __pyx_v_cm1_min = (((((double)__pyx_v_order) / __pyx_t_1) * __pyx_v_corr) * 1e7);

  /* "orb/cutils.pyx":2276
 *     # spectrum is cropped to step_nb/2 instead of step_nb/2 + 1)
 *     cdef double cm1_min = <double> order / (2.* step) * corr * 1e7
 *     if order & 1:             # <<<<<<<<<<<<<<
 *         cm1_min += get_cm1_axis_step(n, step, corr=corr)
 *     return cm1_min
 */
  __pyx_t_2 = ((__pyx_v_order & 1) != 0);
  if (__pyx_t_2) {

    /* "orb/cutils.pyx":2277
 *     cdef double cm1_min = <double> order / (2.* step) * corr * 1e7
 *     if order & 1:
 *         cm1_min += get_cm1_axis_step(n, step, corr=corr)             # <<<<<<<<<<<<<<
 *     return cm1_min
 * 
 */
    __pyx_t_3 = PyFloat_FromDouble(__pyx_v_cm1_min); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 2277, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __pyx_t_4 = __Pyx_GetModuleGlobalName(__pyx_n_s_get_cm1_axis_step); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2277, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __pyx_t_5 = __Pyx_PyInt_From_int(__pyx_v_n); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 2277, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __pyx_t_6 = PyFloat_FromDouble(__pyx_v_step); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 2277, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
    __pyx_t_7 = PyTuple_New(2); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 2277, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_7);
    __Pyx_GIVEREF(__pyx_t_5);
    PyTuple_SET_ITEM(__pyx_t_7, 0, __pyx_t_5);
    __Pyx_GIVEREF(__pyx_t_6);
    PyTuple_SET_ITEM(__pyx_t_7, 1, __pyx_t_6);
    __pyx_t_5 = 0;
    __pyx_t_6 = 0;
    __pyx_t_6 = PyDict_New(); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 2277, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
    __pyx_t_5 = PyFloat_FromDouble(__pyx_v_corr); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 2277, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    if (PyDict_SetItem(__pyx_t_6, __pyx_n_s_corr, __pyx_t_5) < 0) __PYX_ERR(0, 2277, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_7, __pyx_t_6); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 2277, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
    __pyx_t_6 = PyNumber_InPlaceAdd(__pyx_t_3, __pyx_t_5); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 2277, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    __pyx_t_1 = __pyx_PyFloat_AsDouble(__pyx_t_6); if (unlikely((__pyx_t_1 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 2277, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
    __pyx_v_cm1_min = __pyx_t_1;

    /* "orb/cutils.pyx":2276
 *     # spectrum is cropped to step_nb/2 instead of step_nb/2 + 1)
 *     cdef double cm1_min = <double> order / (2.* step) * corr * 1e7
 *     if order & 1:             # <<<<<<<<<<<<<<
 *         cm1_min += get_cm1_axis_step(n, step, corr=corr)
 *     return cm1_min
 */
  }

  /* "orb/cutils.pyx":2278
 *     if order & 1:
 *         cm1_min += get_cm1_axis_step(n, step, corr=corr)
 *     return cm1_min             # <<<<<<<<<<<<<<
 * 
 * def get_cm1_axis_max(int n, double step, int order, double corr=1.):
 */
  __Pyx_XDECREF(__pyx_r);
  __pyx_t_6 = PyFloat_FromDouble(__pyx_v_cm1_min); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 2278, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __pyx_r = __pyx_t_6;
  __pyx_t_6 = 0;
  goto __pyx_L0;

  /* "orb/cutils.pyx":2261
 * 
 * 
 * def get_cm1_axis_min(int n, double step, int order, double corr=1.):             # <<<<<<<<<<<<<<
 *     """Return min wavenumber of a regular wavenumber axis in cm-1.
 * 
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_XDECREF(__pyx_t_5);
  __Pyx_XDECREF(__pyx_t_6);
  __Pyx_XDECREF(__pyx_t_7);
  __Pyx_AddTraceback("orb.cutils.get_cm1_axis_min", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":2280
 *     return cm1_min
 * 
 * def get_cm1_axis_max(int n, double step, int order, double corr=1.):             # <<<<<<<<<<<<<<
 *     """Return max wavenumber of a regular wavenumber axis in cm-1.
 * 
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_87get_cm1_axis_max(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_3orb_6cutils_86get_cm1_axis_max[] = "get_cm1_axis_max(int n, double step, int order, double corr=1.0)\nReturn max wavenumber of a regular wavenumber axis in cm-1.\n\n    :param n: Number of steps on the axis\n\n    :param step: Step size in nm\n    \n    :param order: Folding order\n    \n    :param corr: (Optional) Coefficient of correction (default 1.)\n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_87get_cm1_axis_max = {"get_cm1_axis_max", (PyCFunction)__pyx_pw_3orb_6cutils_87get_cm1_axis_max, METH_VARARGS|METH_KEYWORDS, __pyx_doc_3orb_6cutils_86get_cm1_axis_max};
static PyObject *__pyx_pw_3orb_6cutils_87get_cm1_axis_max(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  int __pyx_v_n;
  double __pyx_v_step;
  int __pyx_v_order;
  double __pyx_v_corr;
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("get_cm1_axis_max (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_n,&__pyx_n_s_step,&__pyx_n_s_order,&__pyx_n_s_corr,0};
    PyObject* values[4] = {0,0,0,0};
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
      switch (pos_args) {
        case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = PyDict_Size(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_n)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        case  1:
        if (likely((values[1] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_step)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("get_cm1_axis_max", 0, 3, 4, 1); __PYX_ERR(0, 2280, __pyx_L3_error)
        }
        case  2:
        if (likely((values[2] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_order)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("get_cm1_axis_max", 0, 3, 4, 2); __PYX_ERR(0, 2280, __pyx_L3_error)
        }
        case  3:
        if (kw_args > 0) {
          PyObject* value = PyDict_GetItem(__pyx_kwds, __pyx_n_s_corr);
          if (value) { values[3] = value; kw_args--; }
        }
      }
      if (unlikely(kw_args > 0)) {
        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "get_cm1_axis_max") < 0)) __PYX_ERR(0, 2280, __pyx_L3_error)
      }
    } else {
      switch (PyTuple_GET_SIZE(__pyx_args)) {
        case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        break;
        default: goto __pyx_L5_argtuple_error;
      }
    }
    __pyx_v_n = __Pyx_PyInt_As_int(values[0]); if (unlikely((__pyx_v_n == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 2280, __pyx_L3_error)
    __pyx_v_step = __pyx_PyFloat_AsDouble(values[1]); if (unlikely((__pyx_v_step == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 2280, __pyx_L3_error)
    __pyx_v_order = __Pyx_PyInt_As_int(values[2]); if (unlikely((__pyx_v_order == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 2280, __pyx_L3_error)
    if (values[3]) {
      __pyx_v_corr = __pyx_PyFloat_AsDouble(values[3]); if (unlikely((__pyx_v_corr == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 2280, __pyx_L3_error)
    } else {
      __pyx_v_corr = ((double)1.);
    }
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  __Pyx_RaiseArgtupleInvalid("get_cm1_axis_max", 0, 3, 4, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 2280, __pyx_L3_error)
  __pyx_L3_error:;
  __Pyx_AddTraceback("orb.cutils.get_cm1_axis_max", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __Pyx_RefNannyFinishContext();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  __pyx_r = __pyx_pf_3orb_6cutils_86get_cm1_axis_max(__pyx_self, __pyx_v_n, __pyx_v_step, __pyx_v_order, __pyx_v_corr);

  /* function exit code */
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_86get_cm1_axis_max(CYTHON_UNUSED PyObject *__pyx_self, int __pyx_v_n, double __pyx_v_step, int __pyx_v_order, double __pyx_v_corr) {
  double __pyx_v_cm1_max;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  double __pyx_t_1;
  double __pyx_t_2;
  int __pyx_t_3;
  PyObject *__pyx_t_4 = NULL;
  PyObject *__pyx_t_5 = NULL;
  PyObject *__pyx_t_6 = NULL;
  PyObject *__pyx_t_7 = NULL;
  PyObject *__pyx_t_8 = NULL;
  __Pyx_RefNannySetupContext("get_cm1_axis_max", 0);

  /* "orb/cutils.pyx":2294
 *     # removed in orb.utils.fft.transform_interferogram (after fft
 *     # spectrum is cropped to step_nb/2 instead of step_nb/2 + 1)
 *     cdef double cm1_max = <double> (order + 1.) / (2. * step) * corr * 1e7             # <<<<<<<<<<<<<<
 *     if not order & 1:
 *         cm1_max -= get_cm1_axis_step(n, step, corr=corr)
 */
  __pyx_t_1 = ((double)(__pyx_v_order + 1.));
  __pyx_t_2 = (2. * __pyx_v_step);
  if (unlikely(__pyx_t_2 == 0)) {
    PyErr_SetString(PyExc_ZeroDivisionError, "float division");
    __PYX_ERR(0, 2294, __pyx_L1_error)
  }
  __pyx_v_cm1_max = (((__pyx_t_1 / __pyx_t_2) * __pyx_v_corr) * 1e7);

  /* "orb/cutils.pyx":2295
 *     # spectrum is cropped to step_nb/2 instead of step_nb/2 + 1)
 *     cdef double cm1_max = <double> (order + 1.) / (2. * step) * corr * 1e7
 *     if not order & 1:             # <<<<<<<<<<<<<<
 *         cm1_max -= get_cm1_axis_step(n, step, corr=corr)
 *     return cm1_max
 */
  __pyx_t_3 = ((!((__pyx_v_order & 1) != 0)) != 0);
  if (__pyx_t_3) {

    /* "orb/cutils.pyx":2296
 *     cdef double cm1_max = <double> (order + 1.) / (2. * step) * corr * 1e7
 *     if not order & 1:
 *         cm1_max -= get_cm1_axis_step(n, step, corr=corr)             # <<<<<<<<<<<<<<
 *     return cm1_max
 * 
 */
    __pyx_t_4 = PyFloat_FromDouble(__pyx_v_cm1_max); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2296, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_get_cm1_axis_step); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 2296, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __pyx_t_6 = __Pyx_PyInt_From_int(__pyx_v_n); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 2296, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
    __pyx_t_7 = PyFloat_FromDouble(__pyx_v_step); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 2296, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_7);
    __pyx_t_8 = PyTuple_New(2); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 2296, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_8);
    __Pyx_GIVEREF(__pyx_t_6);
    PyTuple_SET_ITEM(__pyx_t_8, 0, __pyx_t_6);
    __Pyx_GIVEREF(__pyx_t_7);
    PyTuple_SET_ITEM(__pyx_t_8, 1, __pyx_t_7);
    __pyx_t_6 = 0;
    __pyx_t_7 = 0;
    __pyx_t_7 = PyDict_New(); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 2296, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_7);
    __pyx_t_6 = PyFloat_FromDouble(__pyx_v_corr); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 2296, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
    if (PyDict_SetItem(__pyx_t_7, __pyx_n_s_corr, __pyx_t_6) < 0) __PYX_ERR(0, 2296, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
    __pyx_t_6 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_8, __pyx_t_7); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 2296, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_6);
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
    __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
    __pyx_t_7 = PyNumber_InPlaceSubtract(__pyx_t_4, __pyx_t_6); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 2296, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_7);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
    __pyx_t_2 = __pyx_PyFloat_AsDouble(__pyx_t_7); if (unlikely((__pyx_t_2 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 2296, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
    __pyx_v_cm1_max = __pyx_t_2;

    /* "orb/cutils.pyx":2295
 *     # spectrum is cropped to step_nb/2 instead of step_nb/2 + 1)
 *     cdef double cm1_max = <double> (order + 1.) / (2. * step) * corr * 1e7
 *     if not order & 1:             # <<<<<<<<<<<<<<
 *         cm1_max -= get_cm1_axis_step(n, step, corr=corr)
 *     return cm1_max
 */
  }

  /* "orb/cutils.pyx":2297
 *     if not order & 1:
 *         cm1_max -= get_cm1_axis_step(n, step, corr=corr)
 *     return cm1_max             # <<<<<<<<<<<<<<
 * 
 * def get_cm1_axis_step(int n, double step, double corr=1.):
 */
  __Pyx_XDECREF(__pyx_r);
  __pyx_t_7 = PyFloat_FromDouble(__pyx_v_cm1_max); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 2297, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_7);
  __pyx_r = __pyx_t_7;
  __pyx_t_7 = 0;
  goto __pyx_L0;

  /* "orb/cutils.pyx":2280
 *     return cm1_min
 * 
 * def get_cm1_axis_max(int n, double step, int order, double corr=1.):             # <<<<<<<<<<<<<<
 *     """Return max wavenumber of a regular wavenumber axis in cm-1.
 * 
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_XDECREF(__pyx_t_5);
  __Pyx_XDECREF(__pyx_t_6);
  __Pyx_XDECREF(__pyx_t_7);
  __Pyx_XDECREF(__pyx_t_8);
  __Pyx_AddTraceback("orb.cutils.get_cm1_axis_max", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":2299
 *     return cm1_max
 * 
 * def get_cm1_axis_step(int n, double step, double corr=1.):             # <<<<<<<<<<<<<<
 *     """Return step size of a regular wavenumber axis in cm-1.
 * 
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_89get_cm1_axis_step(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_3orb_6cutils_88get_cm1_axis_step[] = "get_cm1_axis_step(int n, double step, double corr=1.0)\nReturn step size of a regular wavenumber axis in cm-1.\n\n    :param n: Number of steps on the axis\n    \n    :param step: Step size in nm\n    \n    :param corr: (Optional) Coefficient of correction (default 1.)\n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_89get_cm1_axis_step = {"get_cm1_axis_step", (PyCFunction)__pyx_pw_3orb_6cutils_89get_cm1_axis_step, METH_VARARGS|METH_KEYWORDS, __pyx_doc_3orb_6cutils_88get_cm1_axis_step};
static PyObject *__pyx_pw_3orb_6cutils_89get_cm1_axis_step(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  int __pyx_v_n;
  double __pyx_v_step;
  double __pyx_v_corr;
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("get_cm1_axis_step (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_n,&__pyx_n_s_step,&__pyx_n_s_corr,0};
    PyObject* values[3] = {0,0,0};
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
      switch (pos_args) {
        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = PyDict_Size(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_n)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        case  1:
        if (likely((values[1] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_step)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("get_cm1_axis_step", 0, 2, 3, 1); __PYX_ERR(0, 2299, __pyx_L3_error)
        }
        case  2:
        if (kw_args > 0) {
          PyObject* value = PyDict_GetItem(__pyx_kwds, __pyx_n_s_corr);
          if (value) { values[2] = value; kw_args--; }
        }
      }
      if (unlikely(kw_args > 0)) {
        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "get_cm1_axis_step") < 0)) __PYX_ERR(0, 2299, __pyx_L3_error)
      }
    } else {
      switch (PyTuple_GET_SIZE(__pyx_args)) {
        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        break;
        default: goto __pyx_L5_argtuple_error;
      }
    }
    __pyx_v_n = __Pyx_PyInt_As_int(values[0]); if (unlikely((__pyx_v_n == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 2299, __pyx_L3_error)
    __pyx_v_step = __pyx_PyFloat_AsDouble(values[1]); if (unlikely((__pyx_v_step == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 2299, __pyx_L3_error)
    if (values[2]) {
      __pyx_v_corr = __pyx_PyFloat_AsDouble(values[2]); if (unlikely((__pyx_v_corr == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 2299, __pyx_L3_error)
    } else {
      __pyx_v_corr = ((double)1.);
    }
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  __Pyx_RaiseArgtupleInvalid("get_cm1_axis_step", 0, 2, 3, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 2299, __pyx_L3_error)
  __pyx_L3_error:;
  __Pyx_AddTraceback("orb.cutils.get_cm1_axis_step", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __Pyx_RefNannyFinishContext();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  __pyx_r = __pyx_pf_3orb_6cutils_88get_cm1_axis_step(__pyx_self, __pyx_v_n, __pyx_v_step, __pyx_v_corr);

  /* function exit code */
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_88get_cm1_axis_step(CYTHON_UNUSED PyObject *__pyx_self, int __pyx_v_n, double __pyx_v_step, double __pyx_v_corr) {
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  double __pyx_t_1;
  PyObject *__pyx_t_2 = NULL;
  __Pyx_RefNannySetupContext("get_cm1_axis_step", 0);

  /* "orb/cutils.pyx":2308
 *     :param corr: (Optional) Coefficient of correction (default 1.)
 *     """
 *     return corr / (2. * <double> n * step) * 1e7             # <<<<<<<<<<<<<<
 * 
 * def get_nm_axis_min(int n, double step, int order, double corr=1.):
 */
  __Pyx_XDECREF(__pyx_r);
  __pyx_t_1 = ((2. * ((double)__pyx_v_n)) * __pyx_v_step);
  if (unlikely(__pyx_t_1 == 0)) {
    PyErr_SetString(PyExc_ZeroDivisionError, "float division");
    __PYX_ERR(0, 2308, __pyx_L1_error)
  }
  __pyx_t_2 = PyFloat_FromDouble(((__pyx_v_corr / __pyx_t_1) * 1e7)); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 2308, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_r = __pyx_t_2;
  __pyx_t_2 = 0;
  goto __pyx_L0;

  /* "orb/cutils.pyx":2299
 *     return cm1_max
 * 
 * def get_cm1_axis_step(int n, double step, double corr=1.):             # <<<<<<<<<<<<<<
 *     """Return step size of a regular wavenumber axis in cm-1.
 * 
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_AddTraceback("orb.cutils.get_cm1_axis_step", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":2310
 *     return corr / (2. * <double> n * step) * 1e7
 * 
 * def get_nm_axis_min(int n, double step, int order, double corr=1.):             # <<<<<<<<<<<<<<
 *     """Return min wavelength of regular wavelength axis in nm.
 * 
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_91get_nm_axis_min(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_3orb_6cutils_90get_nm_axis_min[] = "get_nm_axis_min(int n, double step, int order, double corr=1.0)\nReturn min wavelength of regular wavelength axis in nm.\n\n    :param n: Number of steps on the axis\n    \n    :param step: Step size in nm\n    \n    :param order: Folding order (cannot be 0)\n    \n    :param corr: (Optional) Coefficient of correction (default 1.)\n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_91get_nm_axis_min = {"get_nm_axis_min", (PyCFunction)__pyx_pw_3orb_6cutils_91get_nm_axis_min, METH_VARARGS|METH_KEYWORDS, __pyx_doc_3orb_6cutils_90get_nm_axis_min};
static PyObject *__pyx_pw_3orb_6cutils_91get_nm_axis_min(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  int __pyx_v_n;
  double __pyx_v_step;
  int __pyx_v_order;
  double __pyx_v_corr;
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("get_nm_axis_min (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_n,&__pyx_n_s_step,&__pyx_n_s_order,&__pyx_n_s_corr,0};
    PyObject* values[4] = {0,0,0,0};
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
      switch (pos_args) {
        case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = PyDict_Size(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_n)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        case  1:
        if (likely((values[1] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_step)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("get_nm_axis_min", 0, 3, 4, 1); __PYX_ERR(0, 2310, __pyx_L3_error)
        }
        case  2:
        if (likely((values[2] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_order)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("get_nm_axis_min", 0, 3, 4, 2); __PYX_ERR(0, 2310, __pyx_L3_error)
        }
        case  3:
        if (kw_args > 0) {
          PyObject* value = PyDict_GetItem(__pyx_kwds, __pyx_n_s_corr);
          if (value) { values[3] = value; kw_args--; }
        }
      }
      if (unlikely(kw_args > 0)) {
        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "get_nm_axis_min") < 0)) __PYX_ERR(0, 2310, __pyx_L3_error)
      }
    } else {
      switch (PyTuple_GET_SIZE(__pyx_args)) {
        case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        break;
        default: goto __pyx_L5_argtuple_error;
      }
    }
    __pyx_v_n = __Pyx_PyInt_As_int(values[0]); if (unlikely((__pyx_v_n == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 2310, __pyx_L3_error)
    __pyx_v_step = __pyx_PyFloat_AsDouble(values[1]); if (unlikely((__pyx_v_step == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 2310, __pyx_L3_error)
    __pyx_v_order = __Pyx_PyInt_As_int(values[2]); if (unlikely((__pyx_v_order == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 2310, __pyx_L3_error)
    if (values[3]) {
      __pyx_v_corr = __pyx_PyFloat_AsDouble(values[3]); if (unlikely((__pyx_v_corr == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 2310, __pyx_L3_error)
    } else {
      __pyx_v_corr = ((double)1.);
    }
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  __Pyx_RaiseArgtupleInvalid("get_nm_axis_min", 0, 3, 4, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 2310, __pyx_L3_error)
  __pyx_L3_error:;
  __Pyx_AddTraceback("orb.cutils.get_nm_axis_min", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __Pyx_RefNannyFinishContext();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  __pyx_r = __pyx_pf_3orb_6cutils_90get_nm_axis_min(__pyx_self, __pyx_v_n, __pyx_v_step, __pyx_v_order, __pyx_v_corr);

  /* function exit code */
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_90get_nm_axis_min(CYTHON_UNUSED PyObject *__pyx_self, int __pyx_v_n, double __pyx_v_step, int __pyx_v_order, double __pyx_v_corr) {
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  int __pyx_t_1;
  PyObject *__pyx_t_2 = NULL;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  PyObject *__pyx_t_5 = NULL;
  PyObject *__pyx_t_6 = NULL;
  __Pyx_RefNannySetupContext("get_nm_axis_min", 0);

  /* "orb/cutils.pyx":2321
 *     :param corr: (Optional) Coefficient of correction (default 1.)
 *     """
 *     if order == 0: raise ValueError('Order cannot be 0 for a nm axis (minimum wavelength is infinite), use a cm-1 axis instead')             # <<<<<<<<<<<<<<
 *     return 1. / get_cm1_axis_max(n, step, order, corr=corr) * 1e7
 * 
 */
  __pyx_t_1 = ((__pyx_v_order == 0) != 0);
  if (__pyx_t_1) {
    __pyx_t_2 = __Pyx_PyObject_Call(__pyx_builtin_ValueError, __pyx_tuple__143, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 2321, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_Raise(__pyx_t_2, 0, 0, 0);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __PYX_ERR(0, 2321, __pyx_L1_error)
  }

  /* "orb/cutils.pyx":2322
 *     """
 *     if order == 0: raise ValueError('Order cannot be 0 for a nm axis (minimum wavelength is infinite), use a cm-1 axis instead')
 *     return 1. / get_cm1_axis_max(n, step, order, corr=corr) * 1e7             # <<<<<<<<<<<<<<
 * 
 * def get_nm_axis_max(int n, double step, int order, double corr=1.):
 */
  __Pyx_XDECREF(__pyx_r);
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_get_cm1_axis_max); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 2322, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_3 = __Pyx_PyInt_From_int(__pyx_v_n); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 2322, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_4 = PyFloat_FromDouble(__pyx_v_step); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2322, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_5 = __Pyx_PyInt_From_int(__pyx_v_order); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 2322, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_6 = PyTuple_New(3); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 2322, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __Pyx_GIVEREF(__pyx_t_3);
  PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_3);
  __Pyx_GIVEREF(__pyx_t_4);
  PyTuple_SET_ITEM(__pyx_t_6, 1, __pyx_t_4);
  __Pyx_GIVEREF(__pyx_t_5);
  PyTuple_SET_ITEM(__pyx_t_6, 2, __pyx_t_5);
  __pyx_t_3 = 0;
  __pyx_t_4 = 0;
  __pyx_t_5 = 0;
  __pyx_t_5 = PyDict_New(); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 2322, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_4 = PyFloat_FromDouble(__pyx_v_corr); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2322, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  if (PyDict_SetItem(__pyx_t_5, __pyx_n_s_corr, __pyx_t_4) < 0) __PYX_ERR(0, 2322, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_6, __pyx_t_5); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2322, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_5 = __Pyx_PyFloat_DivideCObj(__pyx_float_1_, __pyx_t_4, 1., 0); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 2322, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_4 = PyNumber_Multiply(__pyx_t_5, __pyx_float_1e7); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2322, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_r = __pyx_t_4;
  __pyx_t_4 = 0;
  goto __pyx_L0;

  /* "orb/cutils.pyx":2310
 *     return corr / (2. * <double> n * step) * 1e7
 * 
 * def get_nm_axis_min(int n, double step, int order, double corr=1.):             # <<<<<<<<<<<<<<
 *     """Return min wavelength of regular wavelength axis in nm.
 * 
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_XDECREF(__pyx_t_5);
  __Pyx_XDECREF(__pyx_t_6);
  __Pyx_AddTraceback("orb.cutils.get_nm_axis_min", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":2324
 *     return 1. / get_cm1_axis_max(n, step, order, corr=corr) * 1e7
 * 
 * def get_nm_axis_max(int n, double step, int order, double corr=1.):             # <<<<<<<<<<<<<<
 *     """Return max wavelength of regular wavelength axis in nm.
 * 
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_93get_nm_axis_max(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_3orb_6cutils_92get_nm_axis_max[] = "get_nm_axis_max(int n, double step, int order, double corr=1.0)\nReturn max wavelength of regular wavelength axis in nm.\n\n    :param n: Number of steps on the axis\n\n    :param step: Step size in nm\n    \n    :param order: Folding order (cannot be 0)\n    \n    :param corr: (Optional) Coefficient of correction (default 1.)\n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_93get_nm_axis_max = {"get_nm_axis_max", (PyCFunction)__pyx_pw_3orb_6cutils_93get_nm_axis_max, METH_VARARGS|METH_KEYWORDS, __pyx_doc_3orb_6cutils_92get_nm_axis_max};
static PyObject *__pyx_pw_3orb_6cutils_93get_nm_axis_max(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  int __pyx_v_n;
  double __pyx_v_step;
  int __pyx_v_order;
  double __pyx_v_corr;
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("get_nm_axis_max (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_n,&__pyx_n_s_step,&__pyx_n_s_order,&__pyx_n_s_corr,0};
    PyObject* values[4] = {0,0,0,0};
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
      switch (pos_args) {
        case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = PyDict_Size(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_n)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        case  1:
        if (likely((values[1] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_step)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("get_nm_axis_max", 0, 3, 4, 1); __PYX_ERR(0, 2324, __pyx_L3_error)
        }
        case  2:
        if (likely((values[2] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_order)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("get_nm_axis_max", 0, 3, 4, 2); __PYX_ERR(0, 2324, __pyx_L3_error)
        }
        case  3:
        if (kw_args > 0) {
          PyObject* value = PyDict_GetItem(__pyx_kwds, __pyx_n_s_corr);
          if (value) { values[3] = value; kw_args--; }
        }
      }
      if (unlikely(kw_args > 0)) {
        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "get_nm_axis_max") < 0)) __PYX_ERR(0, 2324, __pyx_L3_error)
      }
    } else {
      switch (PyTuple_GET_SIZE(__pyx_args)) {
        case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        break;
        default: goto __pyx_L5_argtuple_error;
      }
    }
    __pyx_v_n = __Pyx_PyInt_As_int(values[0]); if (unlikely((__pyx_v_n == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 2324, __pyx_L3_error)
    __pyx_v_step = __pyx_PyFloat_AsDouble(values[1]); if (unlikely((__pyx_v_step == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 2324, __pyx_L3_error)
    __pyx_v_order = __Pyx_PyInt_As_int(values[2]); if (unlikely((__pyx_v_order == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 2324, __pyx_L3_error)
    if (values[3]) {
      __pyx_v_corr = __pyx_PyFloat_AsDouble(values[3]); if (unlikely((__pyx_v_corr == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 2324, __pyx_L3_error)
    } else {
      __pyx_v_corr = ((double)1.);
    }
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  __Pyx_RaiseArgtupleInvalid("get_nm_axis_max", 0, 3, 4, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 2324, __pyx_L3_error)
  __pyx_L3_error:;
  __Pyx_AddTraceback("orb.cutils.get_nm_axis_max", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __Pyx_RefNannyFinishContext();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  __pyx_r = __pyx_pf_3orb_6cutils_92get_nm_axis_max(__pyx_self, __pyx_v_n, __pyx_v_step, __pyx_v_order, __pyx_v_corr);

  /* function exit code */
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_92get_nm_axis_max(CYTHON_UNUSED PyObject *__pyx_self, int __pyx_v_n, double __pyx_v_step, int __pyx_v_order, double __pyx_v_corr) {
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  int __pyx_t_1;
  PyObject *__pyx_t_2 = NULL;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  PyObject *__pyx_t_5 = NULL;
  PyObject *__pyx_t_6 = NULL;
  __Pyx_RefNannySetupContext("get_nm_axis_max", 0);

  /* "orb/cutils.pyx":2335
 *     :param corr: (Optional) Coefficient of correction (default 1.)
 *     """
 *     if order == 0: raise ValueError('Order cannot be 0 for a nm axis (minimum wavelength is infinite), use a cm-1 axis instead')             # <<<<<<<<<<<<<<
 *     return 1. / get_cm1_axis_min(n, step, order, corr=corr) * 1e7
 * 
 */
  __pyx_t_1 = ((__pyx_v_order == 0) != 0);
  if (__pyx_t_1) {
    __pyx_t_2 = __Pyx_PyObject_Call(__pyx_builtin_ValueError, __pyx_tuple__144, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 2335, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_2);
    __Pyx_Raise(__pyx_t_2, 0, 0, 0);
    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
    __PYX_ERR(0, 2335, __pyx_L1_error)
  }

  /* "orb/cutils.pyx":2336
 *     """
 *     if order == 0: raise ValueError('Order cannot be 0 for a nm axis (minimum wavelength is infinite), use a cm-1 axis instead')
 *     return 1. / get_cm1_axis_min(n, step, order, corr=corr) * 1e7             # <<<<<<<<<<<<<<
 * 
 * def get_nm_axis_step(int n, double step, int order, double corr=1.):
 */
  __Pyx_XDECREF(__pyx_r);
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_get_cm1_axis_min); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 2336, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_3 = __Pyx_PyInt_From_int(__pyx_v_n); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 2336, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_4 = PyFloat_FromDouble(__pyx_v_step); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2336, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __pyx_t_5 = __Pyx_PyInt_From_int(__pyx_v_order); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 2336, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_6 = PyTuple_New(3); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 2336, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_6);
  __Pyx_GIVEREF(__pyx_t_3);
  PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_3);
  __Pyx_GIVEREF(__pyx_t_4);
  PyTuple_SET_ITEM(__pyx_t_6, 1, __pyx_t_4);
  __Pyx_GIVEREF(__pyx_t_5);
  PyTuple_SET_ITEM(__pyx_t_6, 2, __pyx_t_5);
  __pyx_t_3 = 0;
  __pyx_t_4 = 0;
  __pyx_t_5 = 0;
  __pyx_t_5 = PyDict_New(); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 2336, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_4 = PyFloat_FromDouble(__pyx_v_corr); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2336, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  if (PyDict_SetItem(__pyx_t_5, __pyx_n_s_corr, __pyx_t_4) < 0) __PYX_ERR(0, 2336, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_6, __pyx_t_5); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2336, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_5 = __Pyx_PyFloat_DivideCObj(__pyx_float_1_, __pyx_t_4, 1., 0); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 2336, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_4 = PyNumber_Multiply(__pyx_t_5, __pyx_float_1e7); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2336, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_r = __pyx_t_4;
  __pyx_t_4 = 0;
  goto __pyx_L0;

  /* "orb/cutils.pyx":2324
 *     return 1. / get_cm1_axis_max(n, step, order, corr=corr) * 1e7
 * 
 * def get_nm_axis_max(int n, double step, int order, double corr=1.):             # <<<<<<<<<<<<<<
 *     """Return max wavelength of regular wavelength axis in nm.
 * 
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_XDECREF(__pyx_t_5);
  __Pyx_XDECREF(__pyx_t_6);
  __Pyx_AddTraceback("orb.cutils.get_nm_axis_max", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":2338
 *     return 1. / get_cm1_axis_min(n, step, order, corr=corr) * 1e7
 * 
 * def get_nm_axis_step(int n, double step, int order, double corr=1.):             # <<<<<<<<<<<<<<
 *     """Return step size of a regular wavelength axis in nm.
 * 
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_95get_nm_axis_step(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_3orb_6cutils_94get_nm_axis_step[] = "get_nm_axis_step(int n, double step, int order, double corr=1.0)\nReturn step size of a regular wavelength axis in nm.\n\n    :param n: Number of steps on the axis\n    \n    :param step: Step size in nm\n    \n    :param order: Folding order (cannot be 0)\n    \n    :param corr: (Optional) Coefficient of correction (default 1.)\n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_95get_nm_axis_step = {"get_nm_axis_step", (PyCFunction)__pyx_pw_3orb_6cutils_95get_nm_axis_step, METH_VARARGS|METH_KEYWORDS, __pyx_doc_3orb_6cutils_94get_nm_axis_step};
static PyObject *__pyx_pw_3orb_6cutils_95get_nm_axis_step(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  int __pyx_v_n;
  double __pyx_v_step;
  int __pyx_v_order;
  double __pyx_v_corr;
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("get_nm_axis_step (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_n,&__pyx_n_s_step,&__pyx_n_s_order,&__pyx_n_s_corr,0};
    PyObject* values[4] = {0,0,0,0};
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
      switch (pos_args) {
        case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = PyDict_Size(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_n)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        case  1:
        if (likely((values[1] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_step)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("get_nm_axis_step", 0, 3, 4, 1); __PYX_ERR(0, 2338, __pyx_L3_error)
        }
        case  2:
        if (likely((values[2] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_order)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("get_nm_axis_step", 0, 3, 4, 2); __PYX_ERR(0, 2338, __pyx_L3_error)
        }
        case  3:
        if (kw_args > 0) {
          PyObject* value = PyDict_GetItem(__pyx_kwds, __pyx_n_s_corr);
          if (value) { values[3] = value; kw_args--; }
        }
      }
      if (unlikely(kw_args > 0)) {
        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "get_nm_axis_step") < 0)) __PYX_ERR(0, 2338, __pyx_L3_error)
      }
    } else {
      switch (PyTuple_GET_SIZE(__pyx_args)) {
        case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        break;
        default: goto __pyx_L5_argtuple_error;
      }
    }
    __pyx_v_n = __Pyx_PyInt_As_int(values[0]); if (unlikely((__pyx_v_n == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 2338, __pyx_L3_error)
    __pyx_v_step = __pyx_PyFloat_AsDouble(values[1]); if (unlikely((__pyx_v_step == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 2338, __pyx_L3_error)
    __pyx_v_order = __Pyx_PyInt_As_int(values[2]); if (unlikely((__pyx_v_order == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 2338, __pyx_L3_error)
    if (values[3]) {
      __pyx_v_corr = __pyx_PyFloat_AsDouble(values[3]); if (unlikely((__pyx_v_corr == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 2338, __pyx_L3_error)
    } else {
      __pyx_v_corr = ((double)1.);
    }
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  __Pyx_RaiseArgtupleInvalid("get_nm_axis_step", 0, 3, 4, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 2338, __pyx_L3_error)
  __pyx_L3_error:;
  __Pyx_AddTraceback("orb.cutils.get_nm_axis_step", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __Pyx_RefNannyFinishContext();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  __pyx_r = __pyx_pf_3orb_6cutils_94get_nm_axis_step(__pyx_self, __pyx_v_n, __pyx_v_step, __pyx_v_order, __pyx_v_corr);

  /* function exit code */
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_94get_nm_axis_step(CYTHON_UNUSED PyObject *__pyx_self, int __pyx_v_n, double __pyx_v_step, int __pyx_v_order, double __pyx_v_corr) {
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  int __pyx_t_1;
  double __pyx_t_2;
  double __pyx_t_3;
  double __pyx_t_4;
  PyObject *__pyx_t_5 = NULL;
  __Pyx_RefNannySetupContext("get_nm_axis_step", 0);

  /* "orb/cutils.pyx":2349
 *     :param corr: (Optional) Coefficient of correction (default 1.)
 *     """
 *     if (order > 0):             # <<<<<<<<<<<<<<
 *         return 2. * step / (<double> order * <double> (order + 1) * corr) / <double> n
 *     else: raise ValueError('Order cannot be 0 for a nm axis (stepsize is infinite), use a cm-1 axis instead')
 */
  __pyx_t_1 = ((__pyx_v_order > 0) != 0);
  if (__pyx_t_1) {

    /* "orb/cutils.pyx":2350
 *     """
 *     if (order > 0):
 *         return 2. * step / (<double> order * <double> (order + 1) * corr) / <double> n             # <<<<<<<<<<<<<<
 *     else: raise ValueError('Order cannot be 0 for a nm axis (stepsize is infinite), use a cm-1 axis instead')
 * 
 */
    __Pyx_XDECREF(__pyx_r);
    __pyx_t_2 = (2. * __pyx_v_step);
    __pyx_t_3 = ((((double)__pyx_v_order) * ((double)(__pyx_v_order + 1))) * __pyx_v_corr);
    if (unlikely(__pyx_t_3 == 0)) {
      PyErr_SetString(PyExc_ZeroDivisionError, "float division");
      __PYX_ERR(0, 2350, __pyx_L1_error)
    }
    __pyx_t_4 = (__pyx_t_2 / __pyx_t_3);
    if (unlikely(((double)__pyx_v_n) == 0)) {
      PyErr_SetString(PyExc_ZeroDivisionError, "float division");
      __PYX_ERR(0, 2350, __pyx_L1_error)
    }
    __pyx_t_5 = PyFloat_FromDouble((__pyx_t_4 / ((double)__pyx_v_n))); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 2350, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __pyx_r = __pyx_t_5;
    __pyx_t_5 = 0;
    goto __pyx_L0;

    /* "orb/cutils.pyx":2349
 *     :param corr: (Optional) Coefficient of correction (default 1.)
 *     """
 *     if (order > 0):             # <<<<<<<<<<<<<<
 *         return 2. * step / (<double> order * <double> (order + 1) * corr) / <double> n
 *     else: raise ValueError('Order cannot be 0 for a nm axis (stepsize is infinite), use a cm-1 axis instead')
 */
  }

  /* "orb/cutils.pyx":2351
 *     if (order > 0):
 *         return 2. * step / (<double> order * <double> (order + 1) * corr) / <double> n
 *     else: raise ValueError('Order cannot be 0 for a nm axis (stepsize is infinite), use a cm-1 axis instead')             # <<<<<<<<<<<<<<
 * 
 * 
 */
  /*else*/ {
    __pyx_t_5 = __Pyx_PyObject_Call(__pyx_builtin_ValueError, __pyx_tuple__145, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 2351, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_Raise(__pyx_t_5, 0, 0, 0);
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
    __PYX_ERR(0, 2351, __pyx_L1_error)
  }

  /* "orb/cutils.pyx":2338
 *     return 1. / get_cm1_axis_min(n, step, order, corr=corr) * 1e7
 * 
 * def get_nm_axis_step(int n, double step, int order, double corr=1.):             # <<<<<<<<<<<<<<
 *     """Return step size of a regular wavelength axis in nm.
 * 
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_5);
  __Pyx_AddTraceback("orb.cutils.get_nm_axis_step", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":2356
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def filter_background(np.ndarray[np.float64_t, ndim=2] frame,             # <<<<<<<<<<<<<<
 *                       int box_size, int big_box_coeff):
 *     """Replace each pixel by the value in a box around it minus the
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_97filter_background(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static char __pyx_doc_3orb_6cutils_96filter_background[] = "filter_background(ndarray frame, int box_size, int big_box_coeff)\nReplace each pixel by the value in a box around it minus the\n    median of the baclground.\n    \n    :param frame: Frame to filter\n    \n    :param box_size: Size of the box\n    \n    :param big_box_coeff: Coeff by which the bo size is multiplied to\n      get the background box size.\n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_97filter_background = {"filter_background", (PyCFunction)__pyx_pw_3orb_6cutils_97filter_background, METH_VARARGS|METH_KEYWORDS, __pyx_doc_3orb_6cutils_96filter_background};
static PyObject *__pyx_pw_3orb_6cutils_97filter_background(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  PyArrayObject *__pyx_v_frame = 0;
  int __pyx_v_box_size;
  int __pyx_v_big_box_coeff;
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("filter_background (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_frame,&__pyx_n_s_box_size,&__pyx_n_s_big_box_coeff,0};
    PyObject* values[3] = {0,0,0};
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
      switch (pos_args) {
        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = PyDict_Size(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_frame)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        case  1:
        if (likely((values[1] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_box_size)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("filter_background", 1, 3, 3, 1); __PYX_ERR(0, 2356, __pyx_L3_error)
        }
        case  2:
        if (likely((values[2] = PyDict_GetItem(__pyx_kwds, __pyx_n_s_big_box_coeff)) != 0)) kw_args--;
        else {
          __Pyx_RaiseArgtupleInvalid("filter_background", 1, 3, 3, 2); __PYX_ERR(0, 2356, __pyx_L3_error)
        }
      }
      if (unlikely(kw_args > 0)) {
        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "filter_background") < 0)) __PYX_ERR(0, 2356, __pyx_L3_error)
      }
    } else if (PyTuple_GET_SIZE(__pyx_args) != 3) {
      goto __pyx_L5_argtuple_error;
    } else {
      values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
      values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
      values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
    }
    __pyx_v_frame = ((PyArrayObject *)values[0]);
    __pyx_v_box_size = __Pyx_PyInt_As_int(values[1]); if (unlikely((__pyx_v_box_size == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 2357, __pyx_L3_error)
    __pyx_v_big_box_coeff = __Pyx_PyInt_As_int(values[2]); if (unlikely((__pyx_v_big_box_coeff == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 2357, __pyx_L3_error)
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  __Pyx_RaiseArgtupleInvalid("filter_background", 1, 3, 3, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 2356, __pyx_L3_error)
  __pyx_L3_error:;
  __Pyx_AddTraceback("orb.cutils.filter_background", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __Pyx_RefNannyFinishContext();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_frame), __pyx_ptype_5numpy_ndarray, 1, "frame", 0))) __PYX_ERR(0, 2356, __pyx_L1_error)
  __pyx_r = __pyx_pf_3orb_6cutils_96filter_background(__pyx_self, __pyx_v_frame, __pyx_v_box_size, __pyx_v_big_box_coeff);

  /* function exit code */
  goto __pyx_L0;
  __pyx_L1_error:;
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_96filter_background(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_frame, int __pyx_v_box_size, int __pyx_v_big_box_coeff) {
  PyArrayObject *__pyx_v_workframe = 0;
  PyArrayObject *__pyx_v_box = 0;
  PyArrayObject *__pyx_v_back = 0;
  int __pyx_v_ii;
  int __pyx_v_ij;
  int __pyx_v_dimx;
  int __pyx_v_dimy;
  int __pyx_v_back_size;
  float __pyx_v_mean_box;
  float __pyx_v_median_back;
  int __pyx_v_xmin;
  int __pyx_v_xmax;
  int __pyx_v_ymin;
  int __pyx_v_ymax;
  int __pyx_v_xminb;
  int __pyx_v_xmaxb;
  int __pyx_v_yminb;
  int __pyx_v_ymaxb;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_back;
  __Pyx_Buffer __pyx_pybuffer_back;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_box;
  __Pyx_Buffer __pyx_pybuffer_box;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_frame;
  __Pyx_Buffer __pyx_pybuffer_frame;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_workframe;
  __Pyx_Buffer __pyx_pybuffer_workframe;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  PyObject *__pyx_t_1 = NULL;
  PyObject *__pyx_t_2 = NULL;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  PyArrayObject *__pyx_t_5 = NULL;
  int __pyx_t_6;
  int __pyx_t_7;
  int __pyx_t_8;
  int __pyx_t_9;
  PyObject *__pyx_t_10 = NULL;
  PyObject *__pyx_t_11 = NULL;
  PyObject *__pyx_t_12 = NULL;
  PyObject *__pyx_t_13 = NULL;
  Py_ssize_t __pyx_t_14;
  PyObject *__pyx_t_15 = NULL;
  PyObject *(*__pyx_t_16)(PyObject *);
  int __pyx_t_17;
  int __pyx_t_18;
  int __pyx_t_19;
  int __pyx_t_20;
  PyArrayObject *__pyx_t_21 = NULL;
  PyObject *__pyx_t_22 = NULL;
  PyObject *__pyx_t_23 = NULL;
  PyObject *__pyx_t_24 = NULL;
  float __pyx_t_25;
  PyArrayObject *__pyx_t_26 = NULL;
  Py_ssize_t __pyx_t_27;
  Py_ssize_t __pyx_t_28;
  __Pyx_RefNannySetupContext("filter_background", 0);
  __pyx_pybuffer_workframe.pybuffer.buf = NULL;
  __pyx_pybuffer_workframe.refcount = 0;
  __pyx_pybuffernd_workframe.data = NULL;
  __pyx_pybuffernd_workframe.rcbuffer = &__pyx_pybuffer_workframe;
  __pyx_pybuffer_box.pybuffer.buf = NULL;
  __pyx_pybuffer_box.refcount = 0;
  __pyx_pybuffernd_box.data = NULL;
  __pyx_pybuffernd_box.rcbuffer = &__pyx_pybuffer_box;
  __pyx_pybuffer_back.pybuffer.buf = NULL;
  __pyx_pybuffer_back.refcount = 0;
  __pyx_pybuffernd_back.data = NULL;
  __pyx_pybuffernd_back.rcbuffer = &__pyx_pybuffer_back;
  __pyx_pybuffer_frame.pybuffer.buf = NULL;
  __pyx_pybuffer_frame.refcount = 0;
  __pyx_pybuffernd_frame.data = NULL;
  __pyx_pybuffernd_frame.rcbuffer = &__pyx_pybuffer_frame;
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_frame.rcbuffer->pybuffer, (PyObject*)__pyx_v_frame, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) __PYX_ERR(0, 2356, __pyx_L1_error)
  }
  __pyx_pybuffernd_frame.diminfo[0].strides = __pyx_pybuffernd_frame.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_frame.diminfo[0].shape = __pyx_pybuffernd_frame.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_frame.diminfo[1].strides = __pyx_pybuffernd_frame.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_frame.diminfo[1].shape = __pyx_pybuffernd_frame.rcbuffer->pybuffer.shape[1];

  /* "orb/cutils.pyx":2369
 *     """
 * 
 *     cdef np.ndarray[np.float64_t, ndim=2] workframe = np.copy(frame)             # <<<<<<<<<<<<<<
 *     cdef np.ndarray[np.float64_t, ndim=2] box
 *     cdef np.ndarray[np.float64_t, ndim=2] back
 */
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 2369, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_copy); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 2369, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_3))) {
    __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_3);
    if (likely(__pyx_t_2)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
      __Pyx_INCREF(__pyx_t_2);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_3, function);
    }
  }
  if (!__pyx_t_2) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_3, ((PyObject *)__pyx_v_frame)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2369, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_4 = PyTuple_New(1+1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2369, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_2); __pyx_t_2 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_frame));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_frame));
    PyTuple_SET_ITEM(__pyx_t_4, 0+1, ((PyObject *)__pyx_v_frame));
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_4, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2369, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  }
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 2369, __pyx_L1_error)
  __pyx_t_5 = ((PyArrayObject *)__pyx_t_1);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_workframe.rcbuffer->pybuffer, (PyObject*)__pyx_t_5, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 2, 0, __pyx_stack) == -1)) {
      __pyx_v_workframe = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_workframe.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 2369, __pyx_L1_error)
    } else {__pyx_pybuffernd_workframe.diminfo[0].strides = __pyx_pybuffernd_workframe.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_workframe.diminfo[0].shape = __pyx_pybuffernd_workframe.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_workframe.diminfo[1].strides = __pyx_pybuffernd_workframe.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_workframe.diminfo[1].shape = __pyx_pybuffernd_workframe.rcbuffer->pybuffer.shape[1];
    }
  }
  __pyx_t_5 = 0;
  __pyx_v_workframe = ((PyArrayObject *)__pyx_t_1);
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":2378
 *     cdef int xmin, xmax, ymin, ymax, xminb, xmaxb, yminb, ymaxb
 * 
 *     back_size = big_box_coeff * box_size             # <<<<<<<<<<<<<<
 * 
 *     dimx = frame.shape[0]
 */
  __pyx_v_back_size = (__pyx_v_big_box_coeff * __pyx_v_box_size);

  /* "orb/cutils.pyx":2380
 *     back_size = big_box_coeff * box_size
 * 
 *     dimx = frame.shape[0]             # <<<<<<<<<<<<<<
 *     dimy = frame.shape[1]
 * 
 */
  __pyx_v_dimx = (__pyx_v_frame->dimensions[0]);

  /* "orb/cutils.pyx":2381
 * 
 *     dimx = frame.shape[0]
 *     dimy = frame.shape[1]             # <<<<<<<<<<<<<<
 * 
 * 
 */
  __pyx_v_dimy = (__pyx_v_frame->dimensions[1]);

  /* "orb/cutils.pyx":2384
 * 
 * 
 *     for ii in range(dimx):             # <<<<<<<<<<<<<<
 *         for ij in range(dimy):
 * 
 */
  __pyx_t_6 = __pyx_v_dimx;
  for (__pyx_t_7 = 0; __pyx_t_7 < __pyx_t_6; __pyx_t_7+=1) {
    __pyx_v_ii = __pyx_t_7;

    /* "orb/cutils.pyx":2385
 * 
 *     for ii in range(dimx):
 *         for ij in range(dimy):             # <<<<<<<<<<<<<<
 * 
 *             xmin, xmax, ymin, ymax = get_box_coords(
 */
    __pyx_t_8 = __pyx_v_dimy;
    for (__pyx_t_9 = 0; __pyx_t_9 < __pyx_t_8; __pyx_t_9+=1) {
      __pyx_v_ij = __pyx_t_9;

      /* "orb/cutils.pyx":2387
 *         for ij in range(dimy):
 * 
 *             xmin, xmax, ymin, ymax = get_box_coords(             # <<<<<<<<<<<<<<
 *                 ii, ij, box_size,
 *                 0, dimx, 0, dimy)
 */
      __pyx_t_3 = __Pyx_GetModuleGlobalName(__pyx_n_s_get_box_coords); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 2387, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);

      /* "orb/cutils.pyx":2388
 * 
 *             xmin, xmax, ymin, ymax = get_box_coords(
 *                 ii, ij, box_size,             # <<<<<<<<<<<<<<
 *                 0, dimx, 0, dimy)
 *             box = frame[xmin:xmax, ymin:ymax]
 */
      __pyx_t_4 = __Pyx_PyInt_From_int(__pyx_v_ii); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2388, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __pyx_t_2 = __Pyx_PyInt_From_int(__pyx_v_ij); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 2388, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __pyx_t_10 = __Pyx_PyInt_From_int(__pyx_v_box_size); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 2388, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_10);

      /* "orb/cutils.pyx":2389
 *             xmin, xmax, ymin, ymax = get_box_coords(
 *                 ii, ij, box_size,
 *                 0, dimx, 0, dimy)             # <<<<<<<<<<<<<<
 *             box = frame[xmin:xmax, ymin:ymax]
 *             mean_box = mean2d(box)
 */
      __pyx_t_11 = __Pyx_PyInt_From_int(__pyx_v_dimx); if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 2389, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_11);
      __pyx_t_12 = __Pyx_PyInt_From_int(__pyx_v_dimy); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 2389, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_12);
      __pyx_t_13 = NULL;
      __pyx_t_14 = 0;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_3))) {
        __pyx_t_13 = PyMethod_GET_SELF(__pyx_t_3);
        if (likely(__pyx_t_13)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
          __Pyx_INCREF(__pyx_t_13);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_3, function);
          __pyx_t_14 = 1;
        }
      }
      __pyx_t_15 = PyTuple_New(7+__pyx_t_14); if (unlikely(!__pyx_t_15)) __PYX_ERR(0, 2387, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_15);
      if (__pyx_t_13) {
        __Pyx_GIVEREF(__pyx_t_13); PyTuple_SET_ITEM(__pyx_t_15, 0, __pyx_t_13); __pyx_t_13 = NULL;
      }
      __Pyx_GIVEREF(__pyx_t_4);
      PyTuple_SET_ITEM(__pyx_t_15, 0+__pyx_t_14, __pyx_t_4);
      __Pyx_GIVEREF(__pyx_t_2);
      PyTuple_SET_ITEM(__pyx_t_15, 1+__pyx_t_14, __pyx_t_2);
      __Pyx_GIVEREF(__pyx_t_10);
      PyTuple_SET_ITEM(__pyx_t_15, 2+__pyx_t_14, __pyx_t_10);
      __Pyx_INCREF(__pyx_int_0);
      __Pyx_GIVEREF(__pyx_int_0);
      PyTuple_SET_ITEM(__pyx_t_15, 3+__pyx_t_14, __pyx_int_0);
      __Pyx_GIVEREF(__pyx_t_11);
      PyTuple_SET_ITEM(__pyx_t_15, 4+__pyx_t_14, __pyx_t_11);
      __Pyx_INCREF(__pyx_int_0);
      __Pyx_GIVEREF(__pyx_int_0);
      PyTuple_SET_ITEM(__pyx_t_15, 5+__pyx_t_14, __pyx_int_0);
      __Pyx_GIVEREF(__pyx_t_12);
      PyTuple_SET_ITEM(__pyx_t_15, 6+__pyx_t_14, __pyx_t_12);
      __pyx_t_4 = 0;
      __pyx_t_2 = 0;
      __pyx_t_10 = 0;
      __pyx_t_11 = 0;
      __pyx_t_12 = 0;
      __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_15, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2387, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);
      __Pyx_DECREF(__pyx_t_15); __pyx_t_15 = 0;
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      if ((likely(PyTuple_CheckExact(__pyx_t_1))) || (PyList_CheckExact(__pyx_t_1))) {
        PyObject* sequence = __pyx_t_1;
        #if CYTHON_COMPILING_IN_CPYTHON
        Py_ssize_t size = Py_SIZE(sequence);
        #else
        Py_ssize_t size = PySequence_Size(sequence);
        #endif
        if (unlikely(size != 4)) {
          if (size > 4) __Pyx_RaiseTooManyValuesError(4);
          else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
          __PYX_ERR(0, 2387, __pyx_L1_error)
        }
        #if CYTHON_COMPILING_IN_CPYTHON
        if (likely(PyTuple_CheckExact(sequence))) {
          __pyx_t_3 = PyTuple_GET_ITEM(sequence, 0); 
          __pyx_t_15 = PyTuple_GET_ITEM(sequence, 1); 
          __pyx_t_12 = PyTuple_GET_ITEM(sequence, 2); 
          __pyx_t_11 = PyTuple_GET_ITEM(sequence, 3); 
        } else {
          __pyx_t_3 = PyList_GET_ITEM(sequence, 0); 
          __pyx_t_15 = PyList_GET_ITEM(sequence, 1); 
          __pyx_t_12 = PyList_GET_ITEM(sequence, 2); 
          __pyx_t_11 = PyList_GET_ITEM(sequence, 3); 
        }
        __Pyx_INCREF(__pyx_t_3);
        __Pyx_INCREF(__pyx_t_15);
        __Pyx_INCREF(__pyx_t_12);
        __Pyx_INCREF(__pyx_t_11);
        #else
        {
          Py_ssize_t i;
          PyObject** temps[4] = {&__pyx_t_3,&__pyx_t_15,&__pyx_t_12,&__pyx_t_11};
          for (i=0; i < 4; i++) {
            PyObject* item = PySequence_ITEM(sequence, i); if (unlikely(!item)) __PYX_ERR(0, 2387, __pyx_L1_error)
            __Pyx_GOTREF(item);
            *(temps[i]) = item;
          }
        }
        #endif
        __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
      } else {
        Py_ssize_t index = -1;
        PyObject** temps[4] = {&__pyx_t_3,&__pyx_t_15,&__pyx_t_12,&__pyx_t_11};
        __pyx_t_10 = PyObject_GetIter(__pyx_t_1); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 2387, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_10);
        __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
        __pyx_t_16 = Py_TYPE(__pyx_t_10)->tp_iternext;
        for (index=0; index < 4; index++) {
          PyObject* item = __pyx_t_16(__pyx_t_10); if (unlikely(!item)) goto __pyx_L7_unpacking_failed;
          __Pyx_GOTREF(item);
          *(temps[index]) = item;
        }
        if (__Pyx_IternextUnpackEndCheck(__pyx_t_16(__pyx_t_10), 4) < 0) __PYX_ERR(0, 2387, __pyx_L1_error)
        __pyx_t_16 = NULL;
        __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
        goto __pyx_L8_unpacking_done;
        __pyx_L7_unpacking_failed:;
        __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
        __pyx_t_16 = NULL;
        if (__Pyx_IterFinish() == 0) __Pyx_RaiseNeedMoreValuesError(index);
        __PYX_ERR(0, 2387, __pyx_L1_error)
        __pyx_L8_unpacking_done:;
      }

      /* "orb/cutils.pyx":2387
 *         for ij in range(dimy):
 * 
 *             xmin, xmax, ymin, ymax = get_box_coords(             # <<<<<<<<<<<<<<
 *                 ii, ij, box_size,
 *                 0, dimx, 0, dimy)
 */
      __pyx_t_17 = __Pyx_PyInt_As_int(__pyx_t_3); if (unlikely((__pyx_t_17 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 2387, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      __pyx_t_18 = __Pyx_PyInt_As_int(__pyx_t_15); if (unlikely((__pyx_t_18 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 2387, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_15); __pyx_t_15 = 0;
      __pyx_t_19 = __Pyx_PyInt_As_int(__pyx_t_12); if (unlikely((__pyx_t_19 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 2387, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_12); __pyx_t_12 = 0;
      __pyx_t_20 = __Pyx_PyInt_As_int(__pyx_t_11); if (unlikely((__pyx_t_20 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 2387, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_11); __pyx_t_11 = 0;
      __pyx_v_xmin = __pyx_t_17;
      __pyx_v_xmax = __pyx_t_18;
      __pyx_v_ymin = __pyx_t_19;
      __pyx_v_ymax = __pyx_t_20;

      /* "orb/cutils.pyx":2390
 *                 ii, ij, box_size,
 *                 0, dimx, 0, dimy)
 *             box = frame[xmin:xmax, ymin:ymax]             # <<<<<<<<<<<<<<
 *             mean_box = mean2d(box)
 *             xminb, xmaxb, yminb, ymaxb = (
 */
      __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_xmin); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2390, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);
      __pyx_t_11 = __Pyx_PyInt_From_int(__pyx_v_xmax); if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 2390, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_11);
      __pyx_t_12 = PySlice_New(__pyx_t_1, __pyx_t_11, Py_None); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 2390, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_12);
      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
      __Pyx_DECREF(__pyx_t_11); __pyx_t_11 = 0;
      __pyx_t_11 = __Pyx_PyInt_From_int(__pyx_v_ymin); if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 2390, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_11);
      __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_ymax); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2390, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);
      __pyx_t_15 = PySlice_New(__pyx_t_11, __pyx_t_1, Py_None); if (unlikely(!__pyx_t_15)) __PYX_ERR(0, 2390, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_15);
      __Pyx_DECREF(__pyx_t_11); __pyx_t_11 = 0;
      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
      __pyx_t_1 = PyTuple_New(2); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2390, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);
      __Pyx_GIVEREF(__pyx_t_12);
      PyTuple_SET_ITEM(__pyx_t_1, 0, __pyx_t_12);
      __Pyx_GIVEREF(__pyx_t_15);
      PyTuple_SET_ITEM(__pyx_t_1, 1, __pyx_t_15);
      __pyx_t_12 = 0;
      __pyx_t_15 = 0;
      __pyx_t_15 = PyObject_GetItem(((PyObject *)__pyx_v_frame), __pyx_t_1); if (unlikely(!__pyx_t_15)) __PYX_ERR(0, 2390, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_15);
      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
      if (!(likely(((__pyx_t_15) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_15, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 2390, __pyx_L1_error)
      __pyx_t_21 = ((PyArrayObject *)__pyx_t_15);
      {
        __Pyx_BufFmt_StackElem __pyx_stack[1];
        __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_box.rcbuffer->pybuffer);
        __pyx_t_20 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_box.rcbuffer->pybuffer, (PyObject*)__pyx_t_21, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
        if (unlikely(__pyx_t_20 < 0)) {
          PyErr_Fetch(&__pyx_t_22, &__pyx_t_23, &__pyx_t_24);
          if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_box.rcbuffer->pybuffer, (PyObject*)__pyx_v_box, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
            Py_XDECREF(__pyx_t_22); Py_XDECREF(__pyx_t_23); Py_XDECREF(__pyx_t_24);
            __Pyx_RaiseBufferFallbackError();
          } else {
            PyErr_Restore(__pyx_t_22, __pyx_t_23, __pyx_t_24);
          }
        }
        __pyx_pybuffernd_box.diminfo[0].strides = __pyx_pybuffernd_box.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_box.diminfo[0].shape = __pyx_pybuffernd_box.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_box.diminfo[1].strides = __pyx_pybuffernd_box.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_box.diminfo[1].shape = __pyx_pybuffernd_box.rcbuffer->pybuffer.shape[1];
        if (unlikely(__pyx_t_20 < 0)) __PYX_ERR(0, 2390, __pyx_L1_error)
      }
      __pyx_t_21 = 0;
      __Pyx_XDECREF_SET(__pyx_v_box, ((PyArrayObject *)__pyx_t_15));
      __pyx_t_15 = 0;

      /* "orb/cutils.pyx":2391
 *                 0, dimx, 0, dimy)
 *             box = frame[xmin:xmax, ymin:ymax]
 *             mean_box = mean2d(box)             # <<<<<<<<<<<<<<
 *             xminb, xmaxb, yminb, ymaxb = (
 *                 get_box_coords(
 */
      __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_mean2d); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2391, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);
      __pyx_t_12 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_1))) {
        __pyx_t_12 = PyMethod_GET_SELF(__pyx_t_1);
        if (likely(__pyx_t_12)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_1);
          __Pyx_INCREF(__pyx_t_12);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_1, function);
        }
      }
      if (!__pyx_t_12) {
        __pyx_t_15 = __Pyx_PyObject_CallOneArg(__pyx_t_1, ((PyObject *)__pyx_v_box)); if (unlikely(!__pyx_t_15)) __PYX_ERR(0, 2391, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_15);
      } else {
        __pyx_t_11 = PyTuple_New(1+1); if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 2391, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_11);
        __Pyx_GIVEREF(__pyx_t_12); PyTuple_SET_ITEM(__pyx_t_11, 0, __pyx_t_12); __pyx_t_12 = NULL;
        __Pyx_INCREF(((PyObject *)__pyx_v_box));
        __Pyx_GIVEREF(((PyObject *)__pyx_v_box));
        PyTuple_SET_ITEM(__pyx_t_11, 0+1, ((PyObject *)__pyx_v_box));
        __pyx_t_15 = __Pyx_PyObject_Call(__pyx_t_1, __pyx_t_11, NULL); if (unlikely(!__pyx_t_15)) __PYX_ERR(0, 2391, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_15);
        __Pyx_DECREF(__pyx_t_11); __pyx_t_11 = 0;
      }
      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
      __pyx_t_25 = __pyx_PyFloat_AsFloat(__pyx_t_15); if (unlikely((__pyx_t_25 == (float)-1) && PyErr_Occurred())) __PYX_ERR(0, 2391, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_15); __pyx_t_15 = 0;
      __pyx_v_mean_box = __pyx_t_25;

      /* "orb/cutils.pyx":2393
 *             mean_box = mean2d(box)
 *             xminb, xmaxb, yminb, ymaxb = (
 *                 get_box_coords(             # <<<<<<<<<<<<<<
 *                     ii, ij, back_size, 0, dimx,
 *                     0, dimy))
 */
      __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_get_box_coords); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2393, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);

      /* "orb/cutils.pyx":2394
 *             xminb, xmaxb, yminb, ymaxb = (
 *                 get_box_coords(
 *                     ii, ij, back_size, 0, dimx,             # <<<<<<<<<<<<<<
 *                     0, dimy))
 *             back = np.copy(frame[xminb:xmaxb, yminb:ymaxb])
 */
      __pyx_t_11 = __Pyx_PyInt_From_int(__pyx_v_ii); if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 2394, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_11);
      __pyx_t_12 = __Pyx_PyInt_From_int(__pyx_v_ij); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 2394, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_12);
      __pyx_t_3 = __Pyx_PyInt_From_int(__pyx_v_back_size); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 2394, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __pyx_t_10 = __Pyx_PyInt_From_int(__pyx_v_dimx); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 2394, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_10);

      /* "orb/cutils.pyx":2395
 *                 get_box_coords(
 *                     ii, ij, back_size, 0, dimx,
 *                     0, dimy))             # <<<<<<<<<<<<<<
 *             back = np.copy(frame[xminb:xmaxb, yminb:ymaxb])
 *             back[xmin - xminb:xmax - xminb,
 */
      __pyx_t_2 = __Pyx_PyInt_From_int(__pyx_v_dimy); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 2395, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __pyx_t_4 = NULL;
      __pyx_t_14 = 0;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_1))) {
        __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_1);
        if (likely(__pyx_t_4)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_1);
          __Pyx_INCREF(__pyx_t_4);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_1, function);
          __pyx_t_14 = 1;
        }
      }
      __pyx_t_13 = PyTuple_New(7+__pyx_t_14); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 2393, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_13);
      if (__pyx_t_4) {
        __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_13, 0, __pyx_t_4); __pyx_t_4 = NULL;
      }
      __Pyx_GIVEREF(__pyx_t_11);
      PyTuple_SET_ITEM(__pyx_t_13, 0+__pyx_t_14, __pyx_t_11);
      __Pyx_GIVEREF(__pyx_t_12);
      PyTuple_SET_ITEM(__pyx_t_13, 1+__pyx_t_14, __pyx_t_12);
      __Pyx_GIVEREF(__pyx_t_3);
      PyTuple_SET_ITEM(__pyx_t_13, 2+__pyx_t_14, __pyx_t_3);
      __Pyx_INCREF(__pyx_int_0);
      __Pyx_GIVEREF(__pyx_int_0);
      PyTuple_SET_ITEM(__pyx_t_13, 3+__pyx_t_14, __pyx_int_0);
      __Pyx_GIVEREF(__pyx_t_10);
      PyTuple_SET_ITEM(__pyx_t_13, 4+__pyx_t_14, __pyx_t_10);
      __Pyx_INCREF(__pyx_int_0);
      __Pyx_GIVEREF(__pyx_int_0);
      PyTuple_SET_ITEM(__pyx_t_13, 5+__pyx_t_14, __pyx_int_0);
      __Pyx_GIVEREF(__pyx_t_2);
      PyTuple_SET_ITEM(__pyx_t_13, 6+__pyx_t_14, __pyx_t_2);
      __pyx_t_11 = 0;
      __pyx_t_12 = 0;
      __pyx_t_3 = 0;
      __pyx_t_10 = 0;
      __pyx_t_2 = 0;
      __pyx_t_15 = __Pyx_PyObject_Call(__pyx_t_1, __pyx_t_13, NULL); if (unlikely(!__pyx_t_15)) __PYX_ERR(0, 2393, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_15);
      __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
      if ((likely(PyTuple_CheckExact(__pyx_t_15))) || (PyList_CheckExact(__pyx_t_15))) {
        PyObject* sequence = __pyx_t_15;
        #if CYTHON_COMPILING_IN_CPYTHON
        Py_ssize_t size = Py_SIZE(sequence);
        #else
        Py_ssize_t size = PySequence_Size(sequence);
        #endif
        if (unlikely(size != 4)) {
          if (size > 4) __Pyx_RaiseTooManyValuesError(4);
          else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
          __PYX_ERR(0, 2392, __pyx_L1_error)
        }
        #if CYTHON_COMPILING_IN_CPYTHON
        if (likely(PyTuple_CheckExact(sequence))) {
          __pyx_t_1 = PyTuple_GET_ITEM(sequence, 0); 
          __pyx_t_13 = PyTuple_GET_ITEM(sequence, 1); 
          __pyx_t_2 = PyTuple_GET_ITEM(sequence, 2); 
          __pyx_t_10 = PyTuple_GET_ITEM(sequence, 3); 
        } else {
          __pyx_t_1 = PyList_GET_ITEM(sequence, 0); 
          __pyx_t_13 = PyList_GET_ITEM(sequence, 1); 
          __pyx_t_2 = PyList_GET_ITEM(sequence, 2); 
          __pyx_t_10 = PyList_GET_ITEM(sequence, 3); 
        }
        __Pyx_INCREF(__pyx_t_1);
        __Pyx_INCREF(__pyx_t_13);
        __Pyx_INCREF(__pyx_t_2);
        __Pyx_INCREF(__pyx_t_10);
        #else
        {
          Py_ssize_t i;
          PyObject** temps[4] = {&__pyx_t_1,&__pyx_t_13,&__pyx_t_2,&__pyx_t_10};
          for (i=0; i < 4; i++) {
            PyObject* item = PySequence_ITEM(sequence, i); if (unlikely(!item)) __PYX_ERR(0, 2392, __pyx_L1_error)
            __Pyx_GOTREF(item);
            *(temps[i]) = item;
          }
        }
        #endif
        __Pyx_DECREF(__pyx_t_15); __pyx_t_15 = 0;
      } else {
        Py_ssize_t index = -1;
        PyObject** temps[4] = {&__pyx_t_1,&__pyx_t_13,&__pyx_t_2,&__pyx_t_10};
        __pyx_t_3 = PyObject_GetIter(__pyx_t_15); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 2392, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_3);
        __Pyx_DECREF(__pyx_t_15); __pyx_t_15 = 0;
        __pyx_t_16 = Py_TYPE(__pyx_t_3)->tp_iternext;
        for (index=0; index < 4; index++) {
          PyObject* item = __pyx_t_16(__pyx_t_3); if (unlikely(!item)) goto __pyx_L9_unpacking_failed;
          __Pyx_GOTREF(item);
          *(temps[index]) = item;
        }
        if (__Pyx_IternextUnpackEndCheck(__pyx_t_16(__pyx_t_3), 4) < 0) __PYX_ERR(0, 2392, __pyx_L1_error)
        __pyx_t_16 = NULL;
        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
        goto __pyx_L10_unpacking_done;
        __pyx_L9_unpacking_failed:;
        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
        __pyx_t_16 = NULL;
        if (__Pyx_IterFinish() == 0) __Pyx_RaiseNeedMoreValuesError(index);
        __PYX_ERR(0, 2392, __pyx_L1_error)
        __pyx_L10_unpacking_done:;
      }

      /* "orb/cutils.pyx":2392
 *             box = frame[xmin:xmax, ymin:ymax]
 *             mean_box = mean2d(box)
 *             xminb, xmaxb, yminb, ymaxb = (             # <<<<<<<<<<<<<<
 *                 get_box_coords(
 *                     ii, ij, back_size, 0, dimx,
 */
      __pyx_t_20 = __Pyx_PyInt_As_int(__pyx_t_1); if (unlikely((__pyx_t_20 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 2392, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
      __pyx_t_19 = __Pyx_PyInt_As_int(__pyx_t_13); if (unlikely((__pyx_t_19 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 2392, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
      __pyx_t_18 = __Pyx_PyInt_As_int(__pyx_t_2); if (unlikely((__pyx_t_18 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 2392, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
      __pyx_t_17 = __Pyx_PyInt_As_int(__pyx_t_10); if (unlikely((__pyx_t_17 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 2392, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
      __pyx_v_xminb = __pyx_t_20;
      __pyx_v_xmaxb = __pyx_t_19;
      __pyx_v_yminb = __pyx_t_18;
      __pyx_v_ymaxb = __pyx_t_17;

      /* "orb/cutils.pyx":2396
 *                     ii, ij, back_size, 0, dimx,
 *                     0, dimy))
 *             back = np.copy(frame[xminb:xmaxb, yminb:ymaxb])             # <<<<<<<<<<<<<<
 *             back[xmin - xminb:xmax - xminb,
 *                  ymin - yminb:ymax - yminb] = np.nan
 */
      __pyx_t_10 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 2396, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_10);
      __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_10, __pyx_n_s_copy); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 2396, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
      __pyx_t_10 = __Pyx_PyInt_From_int(__pyx_v_xminb); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 2396, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_10);
      __pyx_t_13 = __Pyx_PyInt_From_int(__pyx_v_xmaxb); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 2396, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_13);
      __pyx_t_1 = PySlice_New(__pyx_t_10, __pyx_t_13, Py_None); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2396, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);
      __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
      __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
      __pyx_t_13 = __Pyx_PyInt_From_int(__pyx_v_yminb); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 2396, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_13);
      __pyx_t_10 = __Pyx_PyInt_From_int(__pyx_v_ymaxb); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 2396, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_10);
      __pyx_t_3 = PySlice_New(__pyx_t_13, __pyx_t_10, Py_None); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 2396, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
      __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
      __pyx_t_10 = PyTuple_New(2); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 2396, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_10);
      __Pyx_GIVEREF(__pyx_t_1);
      PyTuple_SET_ITEM(__pyx_t_10, 0, __pyx_t_1);
      __Pyx_GIVEREF(__pyx_t_3);
      PyTuple_SET_ITEM(__pyx_t_10, 1, __pyx_t_3);
      __pyx_t_1 = 0;
      __pyx_t_3 = 0;
      __pyx_t_3 = PyObject_GetItem(((PyObject *)__pyx_v_frame), __pyx_t_10); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 2396, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
      __pyx_t_10 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_2))) {
        __pyx_t_10 = PyMethod_GET_SELF(__pyx_t_2);
        if (likely(__pyx_t_10)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
          __Pyx_INCREF(__pyx_t_10);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_2, function);
        }
      }
      if (!__pyx_t_10) {
        __pyx_t_15 = __Pyx_PyObject_CallOneArg(__pyx_t_2, __pyx_t_3); if (unlikely(!__pyx_t_15)) __PYX_ERR(0, 2396, __pyx_L1_error)
        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
        __Pyx_GOTREF(__pyx_t_15);
      } else {
        __pyx_t_1 = PyTuple_New(1+1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2396, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_1);
        __Pyx_GIVEREF(__pyx_t_10); PyTuple_SET_ITEM(__pyx_t_1, 0, __pyx_t_10); __pyx_t_10 = NULL;
        __Pyx_GIVEREF(__pyx_t_3);
        PyTuple_SET_ITEM(__pyx_t_1, 0+1, __pyx_t_3);
        __pyx_t_3 = 0;
        __pyx_t_15 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_1, NULL); if (unlikely(!__pyx_t_15)) __PYX_ERR(0, 2396, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_15);
        __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
      }
      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
      if (!(likely(((__pyx_t_15) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_15, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 2396, __pyx_L1_error)
      __pyx_t_26 = ((PyArrayObject *)__pyx_t_15);
      {
        __Pyx_BufFmt_StackElem __pyx_stack[1];
        __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_back.rcbuffer->pybuffer);
        __pyx_t_17 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_back.rcbuffer->pybuffer, (PyObject*)__pyx_t_26, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
        if (unlikely(__pyx_t_17 < 0)) {
          PyErr_Fetch(&__pyx_t_24, &__pyx_t_23, &__pyx_t_22);
          if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_back.rcbuffer->pybuffer, (PyObject*)__pyx_v_back, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
            Py_XDECREF(__pyx_t_24); Py_XDECREF(__pyx_t_23); Py_XDECREF(__pyx_t_22);
            __Pyx_RaiseBufferFallbackError();
          } else {
            PyErr_Restore(__pyx_t_24, __pyx_t_23, __pyx_t_22);
          }
        }
        __pyx_pybuffernd_back.diminfo[0].strides = __pyx_pybuffernd_back.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_back.diminfo[0].shape = __pyx_pybuffernd_back.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_back.diminfo[1].strides = __pyx_pybuffernd_back.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_back.diminfo[1].shape = __pyx_pybuffernd_back.rcbuffer->pybuffer.shape[1];
        if (unlikely(__pyx_t_17 < 0)) __PYX_ERR(0, 2396, __pyx_L1_error)
      }
      __pyx_t_26 = 0;
      __Pyx_XDECREF_SET(__pyx_v_back, ((PyArrayObject *)__pyx_t_15));
      __pyx_t_15 = 0;

      /* "orb/cutils.pyx":2398
 *             back = np.copy(frame[xminb:xmaxb, yminb:ymaxb])
 *             back[xmin - xminb:xmax - xminb,
 *                  ymin - yminb:ymax - yminb] = np.nan             # <<<<<<<<<<<<<<
 * 
 *             median_back = median2d(back)
 */
      __pyx_t_15 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_15)) __PYX_ERR(0, 2398, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_15);
      __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_15, __pyx_n_s_nan); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 2398, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_2);
      __Pyx_DECREF(__pyx_t_15); __pyx_t_15 = 0;

      /* "orb/cutils.pyx":2397
 *                     0, dimy))
 *             back = np.copy(frame[xminb:xmaxb, yminb:ymaxb])
 *             back[xmin - xminb:xmax - xminb,             # <<<<<<<<<<<<<<
 *                  ymin - yminb:ymax - yminb] = np.nan
 * 
 */
      __pyx_t_15 = __Pyx_PyInt_From_int((__pyx_v_xmin - __pyx_v_xminb)); if (unlikely(!__pyx_t_15)) __PYX_ERR(0, 2397, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_15);
      __pyx_t_1 = __Pyx_PyInt_From_int((__pyx_v_xmax - __pyx_v_xminb)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2397, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);
      __pyx_t_3 = PySlice_New(__pyx_t_15, __pyx_t_1, Py_None); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 2397, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __Pyx_DECREF(__pyx_t_15); __pyx_t_15 = 0;
      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

      /* "orb/cutils.pyx":2398
 *             back = np.copy(frame[xminb:xmaxb, yminb:ymaxb])
 *             back[xmin - xminb:xmax - xminb,
 *                  ymin - yminb:ymax - yminb] = np.nan             # <<<<<<<<<<<<<<
 * 
 *             median_back = median2d(back)
 */
      __pyx_t_1 = __Pyx_PyInt_From_int((__pyx_v_ymin - __pyx_v_yminb)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2398, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_1);
      __pyx_t_15 = __Pyx_PyInt_From_int((__pyx_v_ymax - __pyx_v_yminb)); if (unlikely(!__pyx_t_15)) __PYX_ERR(0, 2398, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_15);

      /* "orb/cutils.pyx":2397
 *                     0, dimy))
 *             back = np.copy(frame[xminb:xmaxb, yminb:ymaxb])
 *             back[xmin - xminb:xmax - xminb,             # <<<<<<<<<<<<<<
 *                  ymin - yminb:ymax - yminb] = np.nan
 * 
 */
      __pyx_t_10 = PySlice_New(__pyx_t_1, __pyx_t_15, Py_None); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 2397, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_10);
      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
      __Pyx_DECREF(__pyx_t_15); __pyx_t_15 = 0;
      __pyx_t_15 = PyTuple_New(2); if (unlikely(!__pyx_t_15)) __PYX_ERR(0, 2397, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_15);
      __Pyx_GIVEREF(__pyx_t_3);
      PyTuple_SET_ITEM(__pyx_t_15, 0, __pyx_t_3);
      __Pyx_GIVEREF(__pyx_t_10);
      PyTuple_SET_ITEM(__pyx_t_15, 1, __pyx_t_10);
      __pyx_t_3 = 0;
      __pyx_t_10 = 0;
      if (unlikely(PyObject_SetItem(((PyObject *)__pyx_v_back), __pyx_t_15, __pyx_t_2) < 0)) __PYX_ERR(0, 2397, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_15); __pyx_t_15 = 0;
      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;

      /* "orb/cutils.pyx":2400
 *                  ymin - yminb:ymax - yminb] = np.nan
 * 
 *             median_back = median2d(back)             # <<<<<<<<<<<<<<
 *             workframe[ii, ij] = mean_box - median_back
 * 
 */
      __pyx_t_15 = __Pyx_GetModuleGlobalName(__pyx_n_s_median2d); if (unlikely(!__pyx_t_15)) __PYX_ERR(0, 2400, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_15);
      __pyx_t_10 = NULL;
      if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_15))) {
        __pyx_t_10 = PyMethod_GET_SELF(__pyx_t_15);
        if (likely(__pyx_t_10)) {
          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_15);
          __Pyx_INCREF(__pyx_t_10);
          __Pyx_INCREF(function);
          __Pyx_DECREF_SET(__pyx_t_15, function);
        }
      }
      if (!__pyx_t_10) {
        __pyx_t_2 = __Pyx_PyObject_CallOneArg(__pyx_t_15, ((PyObject *)__pyx_v_back)); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 2400, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_2);
      } else {
        __pyx_t_3 = PyTuple_New(1+1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 2400, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_3);
        __Pyx_GIVEREF(__pyx_t_10); PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_10); __pyx_t_10 = NULL;
        __Pyx_INCREF(((PyObject *)__pyx_v_back));
        __Pyx_GIVEREF(((PyObject *)__pyx_v_back));
        PyTuple_SET_ITEM(__pyx_t_3, 0+1, ((PyObject *)__pyx_v_back));
        __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_15, __pyx_t_3, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 2400, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_2);
        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      }
      __Pyx_DECREF(__pyx_t_15); __pyx_t_15 = 0;
      __pyx_t_25 = __pyx_PyFloat_AsFloat(__pyx_t_2); if (unlikely((__pyx_t_25 == (float)-1) && PyErr_Occurred())) __PYX_ERR(0, 2400, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
      __pyx_v_median_back = __pyx_t_25;

      /* "orb/cutils.pyx":2401
 * 
 *             median_back = median2d(back)
 *             workframe[ii, ij] = mean_box - median_back             # <<<<<<<<<<<<<<
 * 
 *     return workframe
 */
      __pyx_t_27 = __pyx_v_ii;
      __pyx_t_28 = __pyx_v_ij;
      *__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_workframe.rcbuffer->pybuffer.buf, __pyx_t_27, __pyx_pybuffernd_workframe.diminfo[0].strides, __pyx_t_28, __pyx_pybuffernd_workframe.diminfo[1].strides) = (__pyx_v_mean_box - __pyx_v_median_back);
    }
  }

  /* "orb/cutils.pyx":2403
 *             workframe[ii, ij] = mean_box - median_back
 * 
 *     return workframe             # <<<<<<<<<<<<<<
 * 
 * 
 */
  __Pyx_XDECREF(__pyx_r);
  __Pyx_INCREF(((PyObject *)__pyx_v_workframe));
  __pyx_r = ((PyObject *)__pyx_v_workframe);
  goto __pyx_L0;

  /* "orb/cutils.pyx":2356
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def filter_background(np.ndarray[np.float64_t, ndim=2] frame,             # <<<<<<<<<<<<<<
 *                       int box_size, int big_box_coeff):
 *     """Replace each pixel by the value in a box around it minus the
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_1);
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_XDECREF(__pyx_t_10);
  __Pyx_XDECREF(__pyx_t_11);
  __Pyx_XDECREF(__pyx_t_12);
  __Pyx_XDECREF(__pyx_t_13);
  __Pyx_XDECREF(__pyx_t_15);
  { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
    __Pyx_PyThreadState_declare
    __Pyx_PyThreadState_assign
    __Pyx_ErrFetch(&__pyx_type, &__pyx_value, &__pyx_tb);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_back.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_box.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_frame.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_workframe.rcbuffer->pybuffer);
  __Pyx_ErrRestore(__pyx_type, __pyx_value, __pyx_tb);}
  __Pyx_AddTraceback("orb.cutils.filter_background", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  goto __pyx_L2;
  __pyx_L0:;
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_back.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_box.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_frame.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_workframe.rcbuffer->pybuffer);
  __pyx_L2:;
  __Pyx_XDECREF((PyObject *)__pyx_v_workframe);
  __Pyx_XDECREF((PyObject *)__pyx_v_box);
  __Pyx_XDECREF((PyObject *)__pyx_v_back);
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":2408
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def mean2d(np.ndarray[np.float64_t, ndim=2] box):             # <<<<<<<<<<<<<<
 *     """Return the mean of a 2d box with no GIL
 * 
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_99mean2d(PyObject *__pyx_self, PyObject *__pyx_v_box); /*proto*/
static char __pyx_doc_3orb_6cutils_98mean2d[] = "mean2d(ndarray box)\nReturn the mean of a 2d box with no GIL\n\n    :param box: 2d array\n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_99mean2d = {"mean2d", (PyCFunction)__pyx_pw_3orb_6cutils_99mean2d, METH_O, __pyx_doc_3orb_6cutils_98mean2d};
static PyObject *__pyx_pw_3orb_6cutils_99mean2d(PyObject *__pyx_self, PyObject *__pyx_v_box) {
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("mean2d (wrapper)", 0);
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_box), __pyx_ptype_5numpy_ndarray, 1, "box", 0))) __PYX_ERR(0, 2408, __pyx_L1_error)
  __pyx_r = __pyx_pf_3orb_6cutils_98mean2d(__pyx_self, ((PyArrayObject *)__pyx_v_box));

  /* function exit code */
  goto __pyx_L0;
  __pyx_L1_error:;
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_98mean2d(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_box) {
  int __pyx_v_ii;
  int __pyx_v_ij;
  int __pyx_v_dimx;
  int __pyx_v_dimy;
  int __pyx_v_nb;
  double __pyx_v_val;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_box;
  __Pyx_Buffer __pyx_pybuffer_box;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  int __pyx_t_1;
  int __pyx_t_2;
  int __pyx_t_3;
  int __pyx_t_4;
  Py_ssize_t __pyx_t_5;
  Py_ssize_t __pyx_t_6;
  int __pyx_t_7;
  Py_ssize_t __pyx_t_8;
  Py_ssize_t __pyx_t_9;
  PyObject *__pyx_t_10 = NULL;
  PyObject *__pyx_t_11 = NULL;
  __Pyx_RefNannySetupContext("mean2d", 0);
  __pyx_pybuffer_box.pybuffer.buf = NULL;
  __pyx_pybuffer_box.refcount = 0;
  __pyx_pybuffernd_box.data = NULL;
  __pyx_pybuffernd_box.rcbuffer = &__pyx_pybuffer_box;
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_box.rcbuffer->pybuffer, (PyObject*)__pyx_v_box, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) __PYX_ERR(0, 2408, __pyx_L1_error)
  }
  __pyx_pybuffernd_box.diminfo[0].strides = __pyx_pybuffernd_box.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_box.diminfo[0].shape = __pyx_pybuffernd_box.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_box.diminfo[1].strides = __pyx_pybuffernd_box.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_box.diminfo[1].shape = __pyx_pybuffernd_box.rcbuffer->pybuffer.shape[1];

  /* "orb/cutils.pyx":2416
 *     cdef int dimx, dimy, nb
 *     cdef double val
 *     dimx = box.shape[0]             # <<<<<<<<<<<<<<
 *     dimy = box.shape[1]
 *     val = 0
 */
  __pyx_v_dimx = (__pyx_v_box->dimensions[0]);

  /* "orb/cutils.pyx":2417
 *     cdef double val
 *     dimx = box.shape[0]
 *     dimy = box.shape[1]             # <<<<<<<<<<<<<<
 *     val = 0
 *     nb = 0
 */
  __pyx_v_dimy = (__pyx_v_box->dimensions[1]);

  /* "orb/cutils.pyx":2418
 *     dimx = box.shape[0]
 *     dimy = box.shape[1]
 *     val = 0             # <<<<<<<<<<<<<<
 *     nb = 0
 *     with nogil:
 */
  __pyx_v_val = 0.0;

  /* "orb/cutils.pyx":2419
 *     dimy = box.shape[1]
 *     val = 0
 *     nb = 0             # <<<<<<<<<<<<<<
 *     with nogil:
 *         for ii in range(dimx):
 */
  __pyx_v_nb = 0;

  /* "orb/cutils.pyx":2420
 *     val = 0
 *     nb = 0
 *     with nogil:             # <<<<<<<<<<<<<<
 *         for ii in range(dimx):
 *             for ij in range(dimy):
 */
  {
      #ifdef WITH_THREAD
      PyThreadState *_save;
      Py_UNBLOCK_THREADS
      #endif
      /*try:*/ {

        /* "orb/cutils.pyx":2421
 *     nb = 0
 *     with nogil:
 *         for ii in range(dimx):             # <<<<<<<<<<<<<<
 *             for ij in range(dimy):
 *                 if not isnan(box[ii,ij]):
 */
        __pyx_t_1 = __pyx_v_dimx;
        for (__pyx_t_2 = 0; __pyx_t_2 < __pyx_t_1; __pyx_t_2+=1) {
          __pyx_v_ii = __pyx_t_2;

          /* "orb/cutils.pyx":2422
 *     with nogil:
 *         for ii in range(dimx):
 *             for ij in range(dimy):             # <<<<<<<<<<<<<<
 *                 if not isnan(box[ii,ij]):
 *                     val += box[ii,ij]
 */
          __pyx_t_3 = __pyx_v_dimy;
          for (__pyx_t_4 = 0; __pyx_t_4 < __pyx_t_3; __pyx_t_4+=1) {
            __pyx_v_ij = __pyx_t_4;

            /* "orb/cutils.pyx":2423
 *         for ii in range(dimx):
 *             for ij in range(dimy):
 *                 if not isnan(box[ii,ij]):             # <<<<<<<<<<<<<<
 *                     val += box[ii,ij]
 *                     nb += 1
 */
            __pyx_t_5 = __pyx_v_ii;
            __pyx_t_6 = __pyx_v_ij;
            __pyx_t_7 = ((!(isnan((*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_box.rcbuffer->pybuffer.buf, __pyx_t_5, __pyx_pybuffernd_box.diminfo[0].strides, __pyx_t_6, __pyx_pybuffernd_box.diminfo[1].strides))) != 0)) != 0);
            if (__pyx_t_7) {

              /* "orb/cutils.pyx":2424
 *             for ij in range(dimy):
 *                 if not isnan(box[ii,ij]):
 *                     val += box[ii,ij]             # <<<<<<<<<<<<<<
 *                     nb += 1
 *     if nb == 0: return np.nan
 */
              __pyx_t_8 = __pyx_v_ii;
              __pyx_t_9 = __pyx_v_ij;
              __pyx_v_val = (__pyx_v_val + (*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_box.rcbuffer->pybuffer.buf, __pyx_t_8, __pyx_pybuffernd_box.diminfo[0].strides, __pyx_t_9, __pyx_pybuffernd_box.diminfo[1].strides)));

              /* "orb/cutils.pyx":2425
 *                 if not isnan(box[ii,ij]):
 *                     val += box[ii,ij]
 *                     nb += 1             # <<<<<<<<<<<<<<
 *     if nb == 0: return np.nan
 *     return val / <float> nb
 */
              __pyx_v_nb = (__pyx_v_nb + 1);

              /* "orb/cutils.pyx":2423
 *         for ii in range(dimx):
 *             for ij in range(dimy):
 *                 if not isnan(box[ii,ij]):             # <<<<<<<<<<<<<<
 *                     val += box[ii,ij]
 *                     nb += 1
 */
            }
          }
        }
      }

      /* "orb/cutils.pyx":2420
 *     val = 0
 *     nb = 0
 *     with nogil:             # <<<<<<<<<<<<<<
 *         for ii in range(dimx):
 *             for ij in range(dimy):
 */
      /*finally:*/ {
        /*normal exit:*/{
          #ifdef WITH_THREAD
          Py_BLOCK_THREADS
          #endif
          goto __pyx_L5;
        }
        __pyx_L5:;
      }
  }

  /* "orb/cutils.pyx":2426
 *                     val += box[ii,ij]
 *                     nb += 1
 *     if nb == 0: return np.nan             # <<<<<<<<<<<<<<
 *     return val / <float> nb
 * 
 */
  __pyx_t_7 = ((__pyx_v_nb == 0) != 0);
  if (__pyx_t_7) {
    __Pyx_XDECREF(__pyx_r);
    __pyx_t_10 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 2426, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_10);
    __pyx_t_11 = __Pyx_PyObject_GetAttrStr(__pyx_t_10, __pyx_n_s_nan); if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 2426, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_11);
    __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
    __pyx_r = __pyx_t_11;
    __pyx_t_11 = 0;
    goto __pyx_L0;
  }

  /* "orb/cutils.pyx":2427
 *                     nb += 1
 *     if nb == 0: return np.nan
 *     return val / <float> nb             # <<<<<<<<<<<<<<
 * 
 * 
 */
  __Pyx_XDECREF(__pyx_r);
  if (unlikely(((float)__pyx_v_nb) == 0)) {
    PyErr_SetString(PyExc_ZeroDivisionError, "float division");
    __PYX_ERR(0, 2427, __pyx_L1_error)
  }
  __pyx_t_11 = PyFloat_FromDouble((__pyx_v_val / ((float)__pyx_v_nb))); if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 2427, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_11);
  __pyx_r = __pyx_t_11;
  __pyx_t_11 = 0;
  goto __pyx_L0;

  /* "orb/cutils.pyx":2408
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def mean2d(np.ndarray[np.float64_t, ndim=2] box):             # <<<<<<<<<<<<<<
 *     """Return the mean of a 2d box with no GIL
 * 
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_10);
  __Pyx_XDECREF(__pyx_t_11);
  { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
    __Pyx_PyThreadState_declare
    __Pyx_PyThreadState_assign
    __Pyx_ErrFetch(&__pyx_type, &__pyx_value, &__pyx_tb);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_box.rcbuffer->pybuffer);
  __Pyx_ErrRestore(__pyx_type, __pyx_value, __pyx_tb);}
  __Pyx_AddTraceback("orb.cutils.mean2d", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  goto __pyx_L2;
  __pyx_L0:;
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_box.rcbuffer->pybuffer);
  __pyx_L2:;
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "orb/cutils.pyx":2432
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def median2d(np.ndarray[np.float64_t, ndim=2] box):             # <<<<<<<<<<<<<<
 *     """Return the median of a 2d box with no GIL
 * 
 */

/* Python wrapper */
static PyObject *__pyx_pw_3orb_6cutils_101median2d(PyObject *__pyx_self, PyObject *__pyx_v_box); /*proto*/
static char __pyx_doc_3orb_6cutils_100median2d[] = "median2d(ndarray box)\nReturn the median of a 2d box with no GIL\n\n    :param box: 2d array\n    ";
static PyMethodDef __pyx_mdef_3orb_6cutils_101median2d = {"median2d", (PyCFunction)__pyx_pw_3orb_6cutils_101median2d, METH_O, __pyx_doc_3orb_6cutils_100median2d};
static PyObject *__pyx_pw_3orb_6cutils_101median2d(PyObject *__pyx_self, PyObject *__pyx_v_box) {
  PyObject *__pyx_r = 0;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("median2d (wrapper)", 0);
  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_box), __pyx_ptype_5numpy_ndarray, 1, "box", 0))) __PYX_ERR(0, 2432, __pyx_L1_error)
  __pyx_r = __pyx_pf_3orb_6cutils_100median2d(__pyx_self, ((PyArrayObject *)__pyx_v_box));

  /* function exit code */
  goto __pyx_L0;
  __pyx_L1_error:;
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static PyObject *__pyx_pf_3orb_6cutils_100median2d(CYTHON_UNUSED PyObject *__pyx_self, PyArrayObject *__pyx_v_box) {
  int __pyx_v_ii;
  int __pyx_v_dimx;
  int __pyx_v_nb;
  PyArrayObject *__pyx_v_box_s = 0;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_box;
  __Pyx_Buffer __pyx_pybuffer_box;
  __Pyx_LocalBuf_ND __pyx_pybuffernd_box_s;
  __Pyx_Buffer __pyx_pybuffer_box_s;
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  PyObject *__pyx_t_1 = NULL;
  PyObject *__pyx_t_2 = NULL;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  PyObject *__pyx_t_5 = NULL;
  PyArrayObject *__pyx_t_6 = NULL;
  int __pyx_t_7;
  PyObject *__pyx_t_8 = NULL;
  PyObject *__pyx_t_9 = NULL;
  PyObject *__pyx_t_10 = NULL;
  int __pyx_t_11;
  Py_ssize_t __pyx_t_12;
  int __pyx_t_13;
  Py_ssize_t __pyx_t_14;
  __Pyx_RefNannySetupContext("median2d", 0);
  __pyx_pybuffer_box_s.pybuffer.buf = NULL;
  __pyx_pybuffer_box_s.refcount = 0;
  __pyx_pybuffernd_box_s.data = NULL;
  __pyx_pybuffernd_box_s.rcbuffer = &__pyx_pybuffer_box_s;
  __pyx_pybuffer_box.pybuffer.buf = NULL;
  __pyx_pybuffer_box.refcount = 0;
  __pyx_pybuffernd_box.data = NULL;
  __pyx_pybuffernd_box.rcbuffer = &__pyx_pybuffer_box;
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_box.rcbuffer->pybuffer, (PyObject*)__pyx_v_box, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) __PYX_ERR(0, 2432, __pyx_L1_error)
  }
  __pyx_pybuffernd_box.diminfo[0].strides = __pyx_pybuffernd_box.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_box.diminfo[0].shape = __pyx_pybuffernd_box.rcbuffer->pybuffer.shape[0]; __pyx_pybuffernd_box.diminfo[1].strides = __pyx_pybuffernd_box.rcbuffer->pybuffer.strides[1]; __pyx_pybuffernd_box.diminfo[1].shape = __pyx_pybuffernd_box.rcbuffer->pybuffer.shape[1];

  /* "orb/cutils.pyx":2439
 *     cdef int ii, ij
 *     cdef int dimx, dimy, nb
 *     cdef np.ndarray[np.float64_t, ndim=1] box_s = np.empty(             # <<<<<<<<<<<<<<
 *         np.size(box), dtype=float)
 * 
 */
  __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2439, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_empty); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 2439, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":2440
 *     cdef int dimx, dimy, nb
 *     cdef np.ndarray[np.float64_t, ndim=1] box_s = np.empty(
 *         np.size(box), dtype=float)             # <<<<<<<<<<<<<<
 * 
 *     box_s = np.sort(box.flatten())
 */
  __pyx_t_3 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 2440, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_3);
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_size); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2440, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_3 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_4))) {
    __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_4);
    if (likely(__pyx_t_3)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
      __Pyx_INCREF(__pyx_t_3);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_4, function);
    }
  }
  if (!__pyx_t_3) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_4, ((PyObject *)__pyx_v_box)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2440, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
  } else {
    __pyx_t_5 = PyTuple_New(1+1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 2440, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_3); __pyx_t_3 = NULL;
    __Pyx_INCREF(((PyObject *)__pyx_v_box));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_box));
    PyTuple_SET_ITEM(__pyx_t_5, 0+1, ((PyObject *)__pyx_v_box));
    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_5, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2440, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_1);
    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  }
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;

  /* "orb/cutils.pyx":2439
 *     cdef int ii, ij
 *     cdef int dimx, dimy, nb
 *     cdef np.ndarray[np.float64_t, ndim=1] box_s = np.empty(             # <<<<<<<<<<<<<<
 *         np.size(box), dtype=float)
 * 
 */
  __pyx_t_4 = PyTuple_New(1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2439, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_GIVEREF(__pyx_t_1);
  PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_1);
  __pyx_t_1 = 0;

  /* "orb/cutils.pyx":2440
 *     cdef int dimx, dimy, nb
 *     cdef np.ndarray[np.float64_t, ndim=1] box_s = np.empty(
 *         np.size(box), dtype=float)             # <<<<<<<<<<<<<<
 * 
 *     box_s = np.sort(box.flatten())
 */
  __pyx_t_1 = PyDict_New(); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2440, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if (PyDict_SetItem(__pyx_t_1, __pyx_n_s_dtype, ((PyObject *)(&PyFloat_Type))) < 0) __PYX_ERR(0, 2440, __pyx_L1_error)

  /* "orb/cutils.pyx":2439
 *     cdef int ii, ij
 *     cdef int dimx, dimy, nb
 *     cdef np.ndarray[np.float64_t, ndim=1] box_s = np.empty(             # <<<<<<<<<<<<<<
 *         np.size(box), dtype=float)
 * 
 */
  __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_4, __pyx_t_1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 2439, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  if (!(likely(((__pyx_t_5) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_5, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 2439, __pyx_L1_error)
  __pyx_t_6 = ((PyArrayObject *)__pyx_t_5);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_box_s.rcbuffer->pybuffer, (PyObject*)__pyx_t_6, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
      __pyx_v_box_s = ((PyArrayObject *)Py_None); __Pyx_INCREF(Py_None); __pyx_pybuffernd_box_s.rcbuffer->pybuffer.buf = NULL;
      __PYX_ERR(0, 2439, __pyx_L1_error)
    } else {__pyx_pybuffernd_box_s.diminfo[0].strides = __pyx_pybuffernd_box_s.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_box_s.diminfo[0].shape = __pyx_pybuffernd_box_s.rcbuffer->pybuffer.shape[0];
    }
  }
  __pyx_t_6 = 0;
  __pyx_v_box_s = ((PyArrayObject *)__pyx_t_5);
  __pyx_t_5 = 0;

  /* "orb/cutils.pyx":2442
 *         np.size(box), dtype=float)
 * 
 *     box_s = np.sort(box.flatten())             # <<<<<<<<<<<<<<
 *     dimx = box_s.shape[0]
 *     with nogil:
 */
  __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2442, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_sort); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 2442, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_box), __pyx_n_s_flatten); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 2442, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_3 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && likely(PyMethod_Check(__pyx_t_2))) {
    __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_2);
    if (likely(__pyx_t_3)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
      __Pyx_INCREF(__pyx_t_3);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_2, function);
    }
  }
  if (__pyx_t_3) {
    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_t_2, __pyx_t_3); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2442, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  } else {
    __pyx_t_1 = __Pyx_PyObject_CallNoArg(__pyx_t_2); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2442, __pyx_L1_error)
  }
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = NULL;
  if (CYTHON_COMPILING_IN_CPYTHON && unlikely(PyMethod_Check(__pyx_t_4))) {
    __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_4);
    if (likely(__pyx_t_2)) {
      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
      __Pyx_INCREF(__pyx_t_2);
      __Pyx_INCREF(function);
      __Pyx_DECREF_SET(__pyx_t_4, function);
    }
  }
  if (!__pyx_t_2) {
    __pyx_t_5 = __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 2442, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
    __Pyx_GOTREF(__pyx_t_5);
  } else {
    __pyx_t_3 = PyTuple_New(1+1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 2442, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_2); __pyx_t_2 = NULL;
    __Pyx_GIVEREF(__pyx_t_1);
    PyTuple_SET_ITEM(__pyx_t_3, 0+1, __pyx_t_1);
    __pyx_t_1 = 0;
    __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_3, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 2442, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_5);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
  }
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  if (!(likely(((__pyx_t_5) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_5, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 2442, __pyx_L1_error)
  __pyx_t_6 = ((PyArrayObject *)__pyx_t_5);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_box_s.rcbuffer->pybuffer);
    __pyx_t_7 = __Pyx_GetBufferAndValidate(&__pyx_pybuffernd_box_s.rcbuffer->pybuffer, (PyObject*)__pyx_t_6, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack);
    if (unlikely(__pyx_t_7 < 0)) {
      PyErr_Fetch(&__pyx_t_8, &__pyx_t_9, &__pyx_t_10);
      if (unlikely(__Pyx_GetBufferAndValidate(&__pyx_pybuffernd_box_s.rcbuffer->pybuffer, (PyObject*)__pyx_v_box_s, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float64_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_8); Py_XDECREF(__pyx_t_9); Py_XDECREF(__pyx_t_10);
        __Pyx_RaiseBufferFallbackError();
      } else {
        PyErr_Restore(__pyx_t_8, __pyx_t_9, __pyx_t_10);
      }
    }
    __pyx_pybuffernd_box_s.diminfo[0].strides = __pyx_pybuffernd_box_s.rcbuffer->pybuffer.strides[0]; __pyx_pybuffernd_box_s.diminfo[0].shape = __pyx_pybuffernd_box_s.rcbuffer->pybuffer.shape[0];
    if (unlikely(__pyx_t_7 < 0)) __PYX_ERR(0, 2442, __pyx_L1_error)
  }
  __pyx_t_6 = 0;
  __Pyx_DECREF_SET(__pyx_v_box_s, ((PyArrayObject *)__pyx_t_5));
  __pyx_t_5 = 0;

  /* "orb/cutils.pyx":2443
 * 
 *     box_s = np.sort(box.flatten())
 *     dimx = box_s.shape[0]             # <<<<<<<<<<<<<<
 *     with nogil:
 *         for ii in range(dimx):
 */
  __pyx_v_dimx = (__pyx_v_box_s->dimensions[0]);

  /* "orb/cutils.pyx":2444
 *     box_s = np.sort(box.flatten())
 *     dimx = box_s.shape[0]
 *     with nogil:             # <<<<<<<<<<<<<<
 *         for ii in range(dimx):
 *             if not isnan(box_s[dimx-ii-1]):
 */
  {
      #ifdef WITH_THREAD
      PyThreadState *_save;
      Py_UNBLOCK_THREADS
      #endif
      /*try:*/ {

        /* "orb/cutils.pyx":2445
 *     dimx = box_s.shape[0]
 *     with nogil:
 *         for ii in range(dimx):             # <<<<<<<<<<<<<<
 *             if not isnan(box_s[dimx-ii-1]):
 *                 nb = ii
 */
        __pyx_t_7 = __pyx_v_dimx;
        for (__pyx_t_11 = 0; __pyx_t_11 < __pyx_t_7; __pyx_t_11+=1) {
          __pyx_v_ii = __pyx_t_11;

          /* "orb/cutils.pyx":2446
 *     with nogil:
 *         for ii in range(dimx):
 *             if not isnan(box_s[dimx-ii-1]):             # <<<<<<<<<<<<<<
 *                 nb = ii
 *                 break
 */
          __pyx_t_12 = ((__pyx_v_dimx - __pyx_v_ii) - 1);
          __pyx_t_13 = ((!(isnan((*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_box_s.rcbuffer->pybuffer.buf, __pyx_t_12, __pyx_pybuffernd_box_s.diminfo[0].strides))) != 0)) != 0);
          if (__pyx_t_13) {

            /* "orb/cutils.pyx":2447
 *         for ii in range(dimx):
 *             if not isnan(box_s[dimx-ii-1]):
 *                 nb = ii             # <<<<<<<<<<<<<<
 *                 break
 *     return box_s[(dimx-nb)/2]
 */
            __pyx_v_nb = __pyx_v_ii;

            /* "orb/cutils.pyx":2448
 *             if not isnan(box_s[dimx-ii-1]):
 *                 nb = ii
 *                 break             # <<<<<<<<<<<<<<
 *     return box_s[(dimx-nb)/2]
 * 
 */
            goto __pyx_L7_break;

            /* "orb/cutils.pyx":2446
 *     with nogil:
 *         for ii in range(dimx):
 *             if not isnan(box_s[dimx-ii-1]):             # <<<<<<<<<<<<<<
 *                 nb = ii
 *                 break
 */
          }
        }
        __pyx_L7_break:;
      }

      /* "orb/cutils.pyx":2444
 *     box_s = np.sort(box.flatten())
 *     dimx = box_s.shape[0]
 *     with nogil:             # <<<<<<<<<<<<<<
 *         for ii in range(dimx):
 *             if not isnan(box_s[dimx-ii-1]):
 */
      /*finally:*/ {
        /*normal exit:*/{
          #ifdef WITH_THREAD
          Py_BLOCK_THREADS
          #endif
          goto __pyx_L5;
        }
        __pyx_L5:;
      }
  }

  /* "orb/cutils.pyx":2449
 *                 nb = ii
 *                 break
 *     return box_s[(dimx-nb)/2]             # <<<<<<<<<<<<<<
 * 
 */
  __Pyx_XDECREF(__pyx_r);
  __pyx_t_14 = __Pyx_div_long((__pyx_v_dimx - __pyx_v_nb), 2);
  __pyx_t_5 = PyFloat_FromDouble((*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float64_t *, __pyx_pybuffernd_box_s.rcbuffer->pybuffer.buf, __pyx_t_14, __pyx_pybuffernd_box_s.diminfo[0].strides))); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 2449, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_r = __pyx_t_5;
  __pyx_t_5 = 0;
  goto __pyx_L0;

  /* "orb/cutils.pyx":2432
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def median2d(np.ndarray[np.float64_t, ndim=2] box):             # <<<<<<<<<<<<<<
 *     """Return the median of a 2d box with no GIL
 * 
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_1);
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_XDECREF(__pyx_t_5);
  { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
    __Pyx_PyThreadState_declare
    __Pyx_PyThreadState_assign
    __Pyx_ErrFetch(&__pyx_type, &__pyx_value, &__pyx_tb);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_box.rcbuffer->pybuffer);
    __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_box_s.rcbuffer->pybuffer);
  __Pyx_ErrRestore(__pyx_type, __pyx_value, __pyx_tb);}
  __Pyx_AddTraceback("orb.cutils.median2d", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  goto __pyx_L2;
  __pyx_L0:;
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_box.rcbuffer->pybuffer);
  __Pyx_SafeReleaseBuffer(&__pyx_pybuffernd_box_s.rcbuffer->pybuffer);
  __pyx_L2:;
  __Pyx_XDECREF((PyObject *)__pyx_v_box_s);
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":197
 *         # experimental exception made for __getbuffer__ and __releasebuffer__
 *         # -- the details of this may change.
 *         def __getbuffer__(ndarray self, Py_buffer* info, int flags):             # <<<<<<<<<<<<<<
 *             # This implementation of getbuffer is geared towards Cython
 *             # requirements, and does not yet fullfill the PEP.
 */

/* Python wrapper */
static CYTHON_UNUSED int __pyx_pw_5numpy_7ndarray_1__getbuffer__(PyObject *__pyx_v_self, Py_buffer *__pyx_v_info, int __pyx_v_flags); /*proto*/
static CYTHON_UNUSED int __pyx_pw_5numpy_7ndarray_1__getbuffer__(PyObject *__pyx_v_self, Py_buffer *__pyx_v_info, int __pyx_v_flags) {
  int __pyx_r;
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("__getbuffer__ (wrapper)", 0);
  __pyx_r = __pyx_pf_5numpy_7ndarray___getbuffer__(((PyArrayObject *)__pyx_v_self), ((Py_buffer *)__pyx_v_info), ((int)__pyx_v_flags));

  /* function exit code */
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static int __pyx_pf_5numpy_7ndarray___getbuffer__(PyArrayObject *__pyx_v_self, Py_buffer *__pyx_v_info, int __pyx_v_flags) {
  int __pyx_v_copy_shape;
  int __pyx_v_i;
  int __pyx_v_ndim;
  int __pyx_v_endian_detector;
  int __pyx_v_little_endian;
  int __pyx_v_t;
  char *__pyx_v_f;
  PyArray_Descr *__pyx_v_descr = 0;
  int __pyx_v_offset;
  int __pyx_v_hasfields;
  int __pyx_r;
  __Pyx_RefNannyDeclarations
  int __pyx_t_1;
  int __pyx_t_2;
  PyObject *__pyx_t_3 = NULL;
  int __pyx_t_4;
  int __pyx_t_5;
  PyObject *__pyx_t_6 = NULL;
  char *__pyx_t_7;
  __Pyx_RefNannySetupContext("__getbuffer__", 0);
  if (__pyx_v_info != NULL) {
    __pyx_v_info->obj = Py_None; __Pyx_INCREF(Py_None);
    __Pyx_GIVEREF(__pyx_v_info->obj);
  }

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":203
 *             # of flags
 * 
 *             if info == NULL: return             # <<<<<<<<<<<<<<
 * 
 *             cdef int copy_shape, i, ndim
 */
  __pyx_t_1 = ((__pyx_v_info == NULL) != 0);
  if (__pyx_t_1) {
    __pyx_r = 0;
    goto __pyx_L0;
  }

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":206
 * 
 *             cdef int copy_shape, i, ndim
 *             cdef int endian_detector = 1             # <<<<<<<<<<<<<<
 *             cdef bint little_endian = ((<char*>&endian_detector)[0] != 0)
 * 
 */
  __pyx_v_endian_detector = 1;

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":207
 *             cdef int copy_shape, i, ndim
 *             cdef int endian_detector = 1
 *             cdef bint little_endian = ((<char*>&endian_detector)[0] != 0)             # <<<<<<<<<<<<<<
 * 
 *             ndim = PyArray_NDIM(self)
 */
  __pyx_v_little_endian = ((((char *)(&__pyx_v_endian_detector))[0]) != 0);

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":209
 *             cdef bint little_endian = ((<char*>&endian_detector)[0] != 0)
 * 
 *             ndim = PyArray_NDIM(self)             # <<<<<<<<<<<<<<
 * 
 *             if sizeof(npy_intp) != sizeof(Py_ssize_t):
 */
  __pyx_v_ndim = PyArray_NDIM(__pyx_v_self);

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":211
 *             ndim = PyArray_NDIM(self)
 * 
 *             if sizeof(npy_intp) != sizeof(Py_ssize_t):             # <<<<<<<<<<<<<<
 *                 copy_shape = 1
 *             else:
 */
  __pyx_t_1 = (((sizeof(npy_intp)) != (sizeof(Py_ssize_t))) != 0);
  if (__pyx_t_1) {

    /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":212
 * 
 *             if sizeof(npy_intp) != sizeof(Py_ssize_t):
 *                 copy_shape = 1             # <<<<<<<<<<<<<<
 *             else:
 *                 copy_shape = 0
 */
    __pyx_v_copy_shape = 1;

    /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":211
 *             ndim = PyArray_NDIM(self)
 * 
 *             if sizeof(npy_intp) != sizeof(Py_ssize_t):             # <<<<<<<<<<<<<<
 *                 copy_shape = 1
 *             else:
 */
    goto __pyx_L4;
  }

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":214
 *                 copy_shape = 1
 *             else:
 *                 copy_shape = 0             # <<<<<<<<<<<<<<
 * 
 *             if ((flags & pybuf.PyBUF_C_CONTIGUOUS == pybuf.PyBUF_C_CONTIGUOUS)
 */
  /*else*/ {
    __pyx_v_copy_shape = 0;
  }
  __pyx_L4:;

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":216
 *                 copy_shape = 0
 * 
 *             if ((flags & pybuf.PyBUF_C_CONTIGUOUS == pybuf.PyBUF_C_CONTIGUOUS)             # <<<<<<<<<<<<<<
 *                 and not PyArray_CHKFLAGS(self, NPY_C_CONTIGUOUS)):
 *                 raise ValueError(u"ndarray is not C contiguous")
 */
  __pyx_t_2 = (((__pyx_v_flags & PyBUF_C_CONTIGUOUS) == PyBUF_C_CONTIGUOUS) != 0);
  if (__pyx_t_2) {
  } else {
    __pyx_t_1 = __pyx_t_2;
    goto __pyx_L6_bool_binop_done;
  }

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":217
 * 
 *             if ((flags & pybuf.PyBUF_C_CONTIGUOUS == pybuf.PyBUF_C_CONTIGUOUS)
 *                 and not PyArray_CHKFLAGS(self, NPY_C_CONTIGUOUS)):             # <<<<<<<<<<<<<<
 *                 raise ValueError(u"ndarray is not C contiguous")
 * 
 */
  __pyx_t_2 = ((!(PyArray_CHKFLAGS(__pyx_v_self, NPY_C_CONTIGUOUS) != 0)) != 0);
  __pyx_t_1 = __pyx_t_2;
  __pyx_L6_bool_binop_done:;

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":216
 *                 copy_shape = 0
 * 
 *             if ((flags & pybuf.PyBUF_C_CONTIGUOUS == pybuf.PyBUF_C_CONTIGUOUS)             # <<<<<<<<<<<<<<
 *                 and not PyArray_CHKFLAGS(self, NPY_C_CONTIGUOUS)):
 *                 raise ValueError(u"ndarray is not C contiguous")
 */
  if (__pyx_t_1) {

    /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":218
 *             if ((flags & pybuf.PyBUF_C_CONTIGUOUS == pybuf.PyBUF_C_CONTIGUOUS)
 *                 and not PyArray_CHKFLAGS(self, NPY_C_CONTIGUOUS)):
 *                 raise ValueError(u"ndarray is not C contiguous")             # <<<<<<<<<<<<<<
 * 
 *             if ((flags & pybuf.PyBUF_F_CONTIGUOUS == pybuf.PyBUF_F_CONTIGUOUS)
 */
    __pyx_t_3 = __Pyx_PyObject_Call(__pyx_builtin_ValueError, __pyx_tuple__146, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 218, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_Raise(__pyx_t_3, 0, 0, 0);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __PYX_ERR(1, 218, __pyx_L1_error)

    /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":216
 *                 copy_shape = 0
 * 
 *             if ((flags & pybuf.PyBUF_C_CONTIGUOUS == pybuf.PyBUF_C_CONTIGUOUS)             # <<<<<<<<<<<<<<
 *                 and not PyArray_CHKFLAGS(self, NPY_C_CONTIGUOUS)):
 *                 raise ValueError(u"ndarray is not C contiguous")
 */
  }

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":220
 *                 raise ValueError(u"ndarray is not C contiguous")
 * 
 *             if ((flags & pybuf.PyBUF_F_CONTIGUOUS == pybuf.PyBUF_F_CONTIGUOUS)             # <<<<<<<<<<<<<<
 *                 and not PyArray_CHKFLAGS(self, NPY_F_CONTIGUOUS)):
 *                 raise ValueError(u"ndarray is not Fortran contiguous")
 */
  __pyx_t_2 = (((__pyx_v_flags & PyBUF_F_CONTIGUOUS) == PyBUF_F_CONTIGUOUS) != 0);
  if (__pyx_t_2) {
  } else {
    __pyx_t_1 = __pyx_t_2;
    goto __pyx_L9_bool_binop_done;
  }

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":221
 * 
 *             if ((flags & pybuf.PyBUF_F_CONTIGUOUS == pybuf.PyBUF_F_CONTIGUOUS)
 *                 and not PyArray_CHKFLAGS(self, NPY_F_CONTIGUOUS)):             # <<<<<<<<<<<<<<
 *                 raise ValueError(u"ndarray is not Fortran contiguous")
 * 
 */
  __pyx_t_2 = ((!(PyArray_CHKFLAGS(__pyx_v_self, NPY_F_CONTIGUOUS) != 0)) != 0);
  __pyx_t_1 = __pyx_t_2;
  __pyx_L9_bool_binop_done:;

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":220
 *                 raise ValueError(u"ndarray is not C contiguous")
 * 
 *             if ((flags & pybuf.PyBUF_F_CONTIGUOUS == pybuf.PyBUF_F_CONTIGUOUS)             # <<<<<<<<<<<<<<
 *                 and not PyArray_CHKFLAGS(self, NPY_F_CONTIGUOUS)):
 *                 raise ValueError(u"ndarray is not Fortran contiguous")
 */
  if (__pyx_t_1) {

    /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":222
 *             if ((flags & pybuf.PyBUF_F_CONTIGUOUS == pybuf.PyBUF_F_CONTIGUOUS)
 *                 and not PyArray_CHKFLAGS(self, NPY_F_CONTIGUOUS)):
 *                 raise ValueError(u"ndarray is not Fortran contiguous")             # <<<<<<<<<<<<<<
 * 
 *             info.buf = PyArray_DATA(self)
 */
    __pyx_t_3 = __Pyx_PyObject_Call(__pyx_builtin_ValueError, __pyx_tuple__147, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 222, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_Raise(__pyx_t_3, 0, 0, 0);
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __PYX_ERR(1, 222, __pyx_L1_error)

    /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":220
 *                 raise ValueError(u"ndarray is not C contiguous")
 * 
 *             if ((flags & pybuf.PyBUF_F_CONTIGUOUS == pybuf.PyBUF_F_CONTIGUOUS)             # <<<<<<<<<<<<<<
 *                 and not PyArray_CHKFLAGS(self, NPY_F_CONTIGUOUS)):
 *                 raise ValueError(u"ndarray is not Fortran contiguous")
 */
  }

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":224
 *                 raise ValueError(u"ndarray is not Fortran contiguous")
 * 
 *             info.buf = PyArray_DATA(self)             # <<<<<<<<<<<<<<
 *             info.ndim = ndim
 *             if copy_shape:
 */
  __pyx_v_info->buf = PyArray_DATA(__pyx_v_self);

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":225
 * 
 *             info.buf = PyArray_DATA(self)
 *             info.ndim = ndim             # <<<<<<<<<<<<<<
 *             if copy_shape:
 *                 # Allocate new buffer for strides and shape info.
 */
  __pyx_v_info->ndim = __pyx_v_ndim;

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":226
 *             info.buf = PyArray_DATA(self)
 *             info.ndim = ndim
 *             if copy_shape:             # <<<<<<<<<<<<<<
 *                 # Allocate new buffer for strides and shape info.
 *                 # This is allocated as one block, strides first.
 */
  __pyx_t_1 = (__pyx_v_copy_shape != 0);
  if (__pyx_t_1) {

    /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":229
 *                 # Allocate new buffer for strides and shape info.
 *                 # This is allocated as one block, strides first.
 *                 info.strides = <Py_ssize_t*>stdlib.malloc(sizeof(Py_ssize_t) * <size_t>ndim * 2)             # <<<<<<<<<<<<<<
 *                 info.shape = info.strides + ndim
 *                 for i in range(ndim):
 */
    __pyx_v_info->strides = ((Py_ssize_t *)malloc((((sizeof(Py_ssize_t)) * ((size_t)__pyx_v_ndim)) * 2)));

    /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":230
 *                 # This is allocated as one block, strides first.
 *                 info.strides = <Py_ssize_t*>stdlib.malloc(sizeof(Py_ssize_t) * <size_t>ndim * 2)
 *                 info.shape = info.strides + ndim             # <<<<<<<<<<<<<<
 *                 for i in range(ndim):
 *                     info.strides[i] = PyArray_STRIDES(self)[i]
 */
    __pyx_v_info->shape = (__pyx_v_info->strides + __pyx_v_ndim);

    /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":231
 *                 info.strides = <Py_ssize_t*>stdlib.malloc(sizeof(Py_ssize_t) * <size_t>ndim * 2)
 *                 info.shape = info.strides + ndim
 *                 for i in range(ndim):             # <<<<<<<<<<<<<<
 *                     info.strides[i] = PyArray_STRIDES(self)[i]
 *                     info.shape[i] = PyArray_DIMS(self)[i]
 */
    __pyx_t_4 = __pyx_v_ndim;
    for (__pyx_t_5 = 0; __pyx_t_5 < __pyx_t_4; __pyx_t_5+=1) {
      __pyx_v_i = __pyx_t_5;

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":232
 *                 info.shape = info.strides + ndim
 *                 for i in range(ndim):
 *                     info.strides[i] = PyArray_STRIDES(self)[i]             # <<<<<<<<<<<<<<
 *                     info.shape[i] = PyArray_DIMS(self)[i]
 *             else:
 */
      (__pyx_v_info->strides[__pyx_v_i]) = (PyArray_STRIDES(__pyx_v_self)[__pyx_v_i]);

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":233
 *                 for i in range(ndim):
 *                     info.strides[i] = PyArray_STRIDES(self)[i]
 *                     info.shape[i] = PyArray_DIMS(self)[i]             # <<<<<<<<<<<<<<
 *             else:
 *                 info.strides = <Py_ssize_t*>PyArray_STRIDES(self)
 */
      (__pyx_v_info->shape[__pyx_v_i]) = (PyArray_DIMS(__pyx_v_self)[__pyx_v_i]);
    }

    /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":226
 *             info.buf = PyArray_DATA(self)
 *             info.ndim = ndim
 *             if copy_shape:             # <<<<<<<<<<<<<<
 *                 # Allocate new buffer for strides and shape info.
 *                 # This is allocated as one block, strides first.
 */
    goto __pyx_L11;
  }

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":235
 *                     info.shape[i] = PyArray_DIMS(self)[i]
 *             else:
 *                 info.strides = <Py_ssize_t*>PyArray_STRIDES(self)             # <<<<<<<<<<<<<<
 *                 info.shape = <Py_ssize_t*>PyArray_DIMS(self)
 *             info.suboffsets = NULL
 */
  /*else*/ {
    __pyx_v_info->strides = ((Py_ssize_t *)PyArray_STRIDES(__pyx_v_self));

    /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":236
 *             else:
 *                 info.strides = <Py_ssize_t*>PyArray_STRIDES(self)
 *                 info.shape = <Py_ssize_t*>PyArray_DIMS(self)             # <<<<<<<<<<<<<<
 *             info.suboffsets = NULL
 *             info.itemsize = PyArray_ITEMSIZE(self)
 */
    __pyx_v_info->shape = ((Py_ssize_t *)PyArray_DIMS(__pyx_v_self));
  }
  __pyx_L11:;

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":237
 *                 info.strides = <Py_ssize_t*>PyArray_STRIDES(self)
 *                 info.shape = <Py_ssize_t*>PyArray_DIMS(self)
 *             info.suboffsets = NULL             # <<<<<<<<<<<<<<
 *             info.itemsize = PyArray_ITEMSIZE(self)
 *             info.readonly = not PyArray_ISWRITEABLE(self)
 */
  __pyx_v_info->suboffsets = NULL;

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":238
 *                 info.shape = <Py_ssize_t*>PyArray_DIMS(self)
 *             info.suboffsets = NULL
 *             info.itemsize = PyArray_ITEMSIZE(self)             # <<<<<<<<<<<<<<
 *             info.readonly = not PyArray_ISWRITEABLE(self)
 * 
 */
  __pyx_v_info->itemsize = PyArray_ITEMSIZE(__pyx_v_self);

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":239
 *             info.suboffsets = NULL
 *             info.itemsize = PyArray_ITEMSIZE(self)
 *             info.readonly = not PyArray_ISWRITEABLE(self)             # <<<<<<<<<<<<<<
 * 
 *             cdef int t
 */
  __pyx_v_info->readonly = (!(PyArray_ISWRITEABLE(__pyx_v_self) != 0));

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":242
 * 
 *             cdef int t
 *             cdef char* f = NULL             # <<<<<<<<<<<<<<
 *             cdef dtype descr = self.descr
 *             cdef int offset
 */
  __pyx_v_f = NULL;

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":243
 *             cdef int t
 *             cdef char* f = NULL
 *             cdef dtype descr = self.descr             # <<<<<<<<<<<<<<
 *             cdef int offset
 * 
 */
  __pyx_t_3 = ((PyObject *)__pyx_v_self->descr);
  __Pyx_INCREF(__pyx_t_3);
  __pyx_v_descr = ((PyArray_Descr *)__pyx_t_3);
  __pyx_t_3 = 0;

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":246
 *             cdef int offset
 * 
 *             cdef bint hasfields = PyDataType_HASFIELDS(descr)             # <<<<<<<<<<<<<<
 * 
 *             if not hasfields and not copy_shape:
 */
  __pyx_v_hasfields = PyDataType_HASFIELDS(__pyx_v_descr);

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":248
 *             cdef bint hasfields = PyDataType_HASFIELDS(descr)
 * 
 *             if not hasfields and not copy_shape:             # <<<<<<<<<<<<<<
 *                 # do not call releasebuffer
 *                 info.obj = None
 */
  __pyx_t_2 = ((!(__pyx_v_hasfields != 0)) != 0);
  if (__pyx_t_2) {
  } else {
    __pyx_t_1 = __pyx_t_2;
    goto __pyx_L15_bool_binop_done;
  }
  __pyx_t_2 = ((!(__pyx_v_copy_shape != 0)) != 0);
  __pyx_t_1 = __pyx_t_2;
  __pyx_L15_bool_binop_done:;
  if (__pyx_t_1) {

    /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":250
 *             if not hasfields and not copy_shape:
 *                 # do not call releasebuffer
 *                 info.obj = None             # <<<<<<<<<<<<<<
 *             else:
 *                 # need to call releasebuffer
 */
    __Pyx_INCREF(Py_None);
    __Pyx_GIVEREF(Py_None);
    __Pyx_GOTREF(__pyx_v_info->obj);
    __Pyx_DECREF(__pyx_v_info->obj);
    __pyx_v_info->obj = Py_None;

    /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":248
 *             cdef bint hasfields = PyDataType_HASFIELDS(descr)
 * 
 *             if not hasfields and not copy_shape:             # <<<<<<<<<<<<<<
 *                 # do not call releasebuffer
 *                 info.obj = None
 */
    goto __pyx_L14;
  }

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":253
 *             else:
 *                 # need to call releasebuffer
 *                 info.obj = self             # <<<<<<<<<<<<<<
 * 
 *             if not hasfields:
 */
  /*else*/ {
    __Pyx_INCREF(((PyObject *)__pyx_v_self));
    __Pyx_GIVEREF(((PyObject *)__pyx_v_self));
    __Pyx_GOTREF(__pyx_v_info->obj);
    __Pyx_DECREF(__pyx_v_info->obj);
    __pyx_v_info->obj = ((PyObject *)__pyx_v_self);
  }
  __pyx_L14:;

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":255
 *                 info.obj = self
 * 
 *             if not hasfields:             # <<<<<<<<<<<<<<
 *                 t = descr.type_num
 *                 if ((descr.byteorder == c'>' and little_endian) or
 */
  __pyx_t_1 = ((!(__pyx_v_hasfields != 0)) != 0);
  if (__pyx_t_1) {

    /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":256
 * 
 *             if not hasfields:
 *                 t = descr.type_num             # <<<<<<<<<<<<<<
 *                 if ((descr.byteorder == c'>' and little_endian) or
 *                     (descr.byteorder == c'<' and not little_endian)):
 */
    __pyx_t_4 = __pyx_v_descr->type_num;
    __pyx_v_t = __pyx_t_4;

    /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":257
 *             if not hasfields:
 *                 t = descr.type_num
 *                 if ((descr.byteorder == c'>' and little_endian) or             # <<<<<<<<<<<<<<
 *                     (descr.byteorder == c'<' and not little_endian)):
 *                     raise ValueError(u"Non-native byte order not supported")
 */
    __pyx_t_2 = ((__pyx_v_descr->byteorder == '>') != 0);
    if (!__pyx_t_2) {
      goto __pyx_L20_next_or;
    } else {
    }
    __pyx_t_2 = (__pyx_v_little_endian != 0);
    if (!__pyx_t_2) {
    } else {
      __pyx_t_1 = __pyx_t_2;
      goto __pyx_L19_bool_binop_done;
    }
    __pyx_L20_next_or:;

    /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":258
 *                 t = descr.type_num
 *                 if ((descr.byteorder == c'>' and little_endian) or
 *                     (descr.byteorder == c'<' and not little_endian)):             # <<<<<<<<<<<<<<
 *                     raise ValueError(u"Non-native byte order not supported")
 *                 if   t == NPY_BYTE:        f = "b"
 */
    __pyx_t_2 = ((__pyx_v_descr->byteorder == '<') != 0);
    if (__pyx_t_2) {
    } else {
      __pyx_t_1 = __pyx_t_2;
      goto __pyx_L19_bool_binop_done;
    }
    __pyx_t_2 = ((!(__pyx_v_little_endian != 0)) != 0);
    __pyx_t_1 = __pyx_t_2;
    __pyx_L19_bool_binop_done:;

    /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":257
 *             if not hasfields:
 *                 t = descr.type_num
 *                 if ((descr.byteorder == c'>' and little_endian) or             # <<<<<<<<<<<<<<
 *                     (descr.byteorder == c'<' and not little_endian)):
 *                     raise ValueError(u"Non-native byte order not supported")
 */
    if (__pyx_t_1) {

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":259
 *                 if ((descr.byteorder == c'>' and little_endian) or
 *                     (descr.byteorder == c'<' and not little_endian)):
 *                     raise ValueError(u"Non-native byte order not supported")             # <<<<<<<<<<<<<<
 *                 if   t == NPY_BYTE:        f = "b"
 *                 elif t == NPY_UBYTE:       f = "B"
 */
      __pyx_t_3 = __Pyx_PyObject_Call(__pyx_builtin_ValueError, __pyx_tuple__148, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 259, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __Pyx_Raise(__pyx_t_3, 0, 0, 0);
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      __PYX_ERR(1, 259, __pyx_L1_error)

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":257
 *             if not hasfields:
 *                 t = descr.type_num
 *                 if ((descr.byteorder == c'>' and little_endian) or             # <<<<<<<<<<<<<<
 *                     (descr.byteorder == c'<' and not little_endian)):
 *                     raise ValueError(u"Non-native byte order not supported")
 */
    }

    /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":260
 *                     (descr.byteorder == c'<' and not little_endian)):
 *                     raise ValueError(u"Non-native byte order not supported")
 *                 if   t == NPY_BYTE:        f = "b"             # <<<<<<<<<<<<<<
 *                 elif t == NPY_UBYTE:       f = "B"
 *                 elif t == NPY_SHORT:       f = "h"
 */
    switch (__pyx_v_t) {
      case NPY_BYTE:
      __pyx_v_f = ((char *)"b");
      break;

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":261
 *                     raise ValueError(u"Non-native byte order not supported")
 *                 if   t == NPY_BYTE:        f = "b"
 *                 elif t == NPY_UBYTE:       f = "B"             # <<<<<<<<<<<<<<
 *                 elif t == NPY_SHORT:       f = "h"
 *                 elif t == NPY_USHORT:      f = "H"
 */
      case NPY_UBYTE:
      __pyx_v_f = ((char *)"B");
      break;

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":262
 *                 if   t == NPY_BYTE:        f = "b"
 *                 elif t == NPY_UBYTE:       f = "B"
 *                 elif t == NPY_SHORT:       f = "h"             # <<<<<<<<<<<<<<
 *                 elif t == NPY_USHORT:      f = "H"
 *                 elif t == NPY_INT:         f = "i"
 */
      case NPY_SHORT:
      __pyx_v_f = ((char *)"h");
      break;

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":263
 *                 elif t == NPY_UBYTE:       f = "B"
 *                 elif t == NPY_SHORT:       f = "h"
 *                 elif t == NPY_USHORT:      f = "H"             # <<<<<<<<<<<<<<
 *                 elif t == NPY_INT:         f = "i"
 *                 elif t == NPY_UINT:        f = "I"
 */
      case NPY_USHORT:
      __pyx_v_f = ((char *)"H");
      break;

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":264
 *                 elif t == NPY_SHORT:       f = "h"
 *                 elif t == NPY_USHORT:      f = "H"
 *                 elif t == NPY_INT:         f = "i"             # <<<<<<<<<<<<<<
 *                 elif t == NPY_UINT:        f = "I"
 *                 elif t == NPY_LONG:        f = "l"
 */
      case NPY_INT:
      __pyx_v_f = ((char *)"i");
      break;

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":265
 *                 elif t == NPY_USHORT:      f = "H"
 *                 elif t == NPY_INT:         f = "i"
 *                 elif t == NPY_UINT:        f = "I"             # <<<<<<<<<<<<<<
 *                 elif t == NPY_LONG:        f = "l"
 *                 elif t == NPY_ULONG:       f = "L"
 */
      case NPY_UINT:
      __pyx_v_f = ((char *)"I");
      break;

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":266
 *                 elif t == NPY_INT:         f = "i"
 *                 elif t == NPY_UINT:        f = "I"
 *                 elif t == NPY_LONG:        f = "l"             # <<<<<<<<<<<<<<
 *                 elif t == NPY_ULONG:       f = "L"
 *                 elif t == NPY_LONGLONG:    f = "q"
 */
      case NPY_LONG:
      __pyx_v_f = ((char *)"l");
      break;

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":267
 *                 elif t == NPY_UINT:        f = "I"
 *                 elif t == NPY_LONG:        f = "l"
 *                 elif t == NPY_ULONG:       f = "L"             # <<<<<<<<<<<<<<
 *                 elif t == NPY_LONGLONG:    f = "q"
 *                 elif t == NPY_ULONGLONG:   f = "Q"
 */
      case NPY_ULONG:
      __pyx_v_f = ((char *)"L");
      break;

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":268
 *                 elif t == NPY_LONG:        f = "l"
 *                 elif t == NPY_ULONG:       f = "L"
 *                 elif t == NPY_LONGLONG:    f = "q"             # <<<<<<<<<<<<<<
 *                 elif t == NPY_ULONGLONG:   f = "Q"
 *                 elif t == NPY_FLOAT:       f = "f"
 */
      case NPY_LONGLONG:
      __pyx_v_f = ((char *)"q");
      break;

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":269
 *                 elif t == NPY_ULONG:       f = "L"
 *                 elif t == NPY_LONGLONG:    f = "q"
 *                 elif t == NPY_ULONGLONG:   f = "Q"             # <<<<<<<<<<<<<<
 *                 elif t == NPY_FLOAT:       f = "f"
 *                 elif t == NPY_DOUBLE:      f = "d"
 */
      case NPY_ULONGLONG:
      __pyx_v_f = ((char *)"Q");
      break;

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":270
 *                 elif t == NPY_LONGLONG:    f = "q"
 *                 elif t == NPY_ULONGLONG:   f = "Q"
 *                 elif t == NPY_FLOAT:       f = "f"             # <<<<<<<<<<<<<<
 *                 elif t == NPY_DOUBLE:      f = "d"
 *                 elif t == NPY_LONGDOUBLE:  f = "g"
 */
      case NPY_FLOAT:
      __pyx_v_f = ((char *)"f");
      break;

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":271
 *                 elif t == NPY_ULONGLONG:   f = "Q"
 *                 elif t == NPY_FLOAT:       f = "f"
 *                 elif t == NPY_DOUBLE:      f = "d"             # <<<<<<<<<<<<<<
 *                 elif t == NPY_LONGDOUBLE:  f = "g"
 *                 elif t == NPY_CFLOAT:      f = "Zf"
 */
      case NPY_DOUBLE:
      __pyx_v_f = ((char *)"d");
      break;

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":272
 *                 elif t == NPY_FLOAT:       f = "f"
 *                 elif t == NPY_DOUBLE:      f = "d"
 *                 elif t == NPY_LONGDOUBLE:  f = "g"             # <<<<<<<<<<<<<<
 *                 elif t == NPY_CFLOAT:      f = "Zf"
 *                 elif t == NPY_CDOUBLE:     f = "Zd"
 */
      case NPY_LONGDOUBLE:
      __pyx_v_f = ((char *)"g");
      break;

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":273
 *                 elif t == NPY_DOUBLE:      f = "d"
 *                 elif t == NPY_LONGDOUBLE:  f = "g"
 *                 elif t == NPY_CFLOAT:      f = "Zf"             # <<<<<<<<<<<<<<
 *                 elif t == NPY_CDOUBLE:     f = "Zd"
 *                 elif t == NPY_CLONGDOUBLE: f = "Zg"
 */
      case NPY_CFLOAT:
      __pyx_v_f = ((char *)"Zf");
      break;

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":274
 *                 elif t == NPY_LONGDOUBLE:  f = "g"
 *                 elif t == NPY_CFLOAT:      f = "Zf"
 *                 elif t == NPY_CDOUBLE:     f = "Zd"             # <<<<<<<<<<<<<<
 *                 elif t == NPY_CLONGDOUBLE: f = "Zg"
 *                 elif t == NPY_OBJECT:      f = "O"
 */
      case NPY_CDOUBLE:
      __pyx_v_f = ((char *)"Zd");
      break;

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":275
 *                 elif t == NPY_CFLOAT:      f = "Zf"
 *                 elif t == NPY_CDOUBLE:     f = "Zd"
 *                 elif t == NPY_CLONGDOUBLE: f = "Zg"             # <<<<<<<<<<<<<<
 *                 elif t == NPY_OBJECT:      f = "O"
 *                 else:
 */
      case NPY_CLONGDOUBLE:
      __pyx_v_f = ((char *)"Zg");
      break;

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":276
 *                 elif t == NPY_CDOUBLE:     f = "Zd"
 *                 elif t == NPY_CLONGDOUBLE: f = "Zg"
 *                 elif t == NPY_OBJECT:      f = "O"             # <<<<<<<<<<<<<<
 *                 else:
 *                     raise ValueError(u"unknown dtype code in numpy.pxd (%d)" % t)
 */
      case NPY_OBJECT:
      __pyx_v_f = ((char *)"O");
      break;
      default:

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":278
 *                 elif t == NPY_OBJECT:      f = "O"
 *                 else:
 *                     raise ValueError(u"unknown dtype code in numpy.pxd (%d)" % t)             # <<<<<<<<<<<<<<
 *                 info.format = f
 *                 return
 */
      __pyx_t_3 = __Pyx_PyInt_From_int(__pyx_v_t); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 278, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __pyx_t_6 = PyUnicode_Format(__pyx_kp_u_unknown_dtype_code_in_numpy_pxd, __pyx_t_3); if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 278, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_6);
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 278, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __Pyx_GIVEREF(__pyx_t_6);
      PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_6);
      __pyx_t_6 = 0;
      __pyx_t_6 = __Pyx_PyObject_Call(__pyx_builtin_ValueError, __pyx_t_3, NULL); if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 278, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_6);
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      __Pyx_Raise(__pyx_t_6, 0, 0, 0);
      __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
      __PYX_ERR(1, 278, __pyx_L1_error)
      break;
    }

    /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":279
 *                 else:
 *                     raise ValueError(u"unknown dtype code in numpy.pxd (%d)" % t)
 *                 info.format = f             # <<<<<<<<<<<<<<
 *                 return
 *             else:
 */
    __pyx_v_info->format = __pyx_v_f;

    /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":280
 *                     raise ValueError(u"unknown dtype code in numpy.pxd (%d)" % t)
 *                 info.format = f
 *                 return             # <<<<<<<<<<<<<<
 *             else:
 *                 info.format = <char*>stdlib.malloc(_buffer_format_string_len)
 */
    __pyx_r = 0;
    goto __pyx_L0;

    /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":255
 *                 info.obj = self
 * 
 *             if not hasfields:             # <<<<<<<<<<<<<<
 *                 t = descr.type_num
 *                 if ((descr.byteorder == c'>' and little_endian) or
 */
  }

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":282
 *                 return
 *             else:
 *                 info.format = <char*>stdlib.malloc(_buffer_format_string_len)             # <<<<<<<<<<<<<<
 *                 info.format[0] = c'^' # Native data types, manual alignment
 *                 offset = 0
 */
  /*else*/ {
    __pyx_v_info->format = ((char *)malloc(0xFF));

    /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":283
 *             else:
 *                 info.format = <char*>stdlib.malloc(_buffer_format_string_len)
 *                 info.format[0] = c'^' # Native data types, manual alignment             # <<<<<<<<<<<<<<
 *                 offset = 0
 *                 f = _util_dtypestring(descr, info.format + 1,
 */
    (__pyx_v_info->format[0]) = '^';

    /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":284
 *                 info.format = <char*>stdlib.malloc(_buffer_format_string_len)
 *                 info.format[0] = c'^' # Native data types, manual alignment
 *                 offset = 0             # <<<<<<<<<<<<<<
 *                 f = _util_dtypestring(descr, info.format + 1,
 *                                       info.format + _buffer_format_string_len,
 */
    __pyx_v_offset = 0;

    /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":285
 *                 info.format[0] = c'^' # Native data types, manual alignment
 *                 offset = 0
 *                 f = _util_dtypestring(descr, info.format + 1,             # <<<<<<<<<<<<<<
 *                                       info.format + _buffer_format_string_len,
 *                                       &offset)
 */
    __pyx_t_7 = __pyx_f_5numpy__util_dtypestring(__pyx_v_descr, (__pyx_v_info->format + 1), (__pyx_v_info->format + 0xFF), (&__pyx_v_offset)); if (unlikely(__pyx_t_7 == NULL)) __PYX_ERR(1, 285, __pyx_L1_error)
    __pyx_v_f = __pyx_t_7;

    /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":288
 *                                       info.format + _buffer_format_string_len,
 *                                       &offset)
 *                 f[0] = c'\0' # Terminate format string             # <<<<<<<<<<<<<<
 * 
 *         def __releasebuffer__(ndarray self, Py_buffer* info):
 */
    (__pyx_v_f[0]) = '\x00';
  }

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":197
 *         # experimental exception made for __getbuffer__ and __releasebuffer__
 *         # -- the details of this may change.
 *         def __getbuffer__(ndarray self, Py_buffer* info, int flags):             # <<<<<<<<<<<<<<
 *             # This implementation of getbuffer is geared towards Cython
 *             # requirements, and does not yet fullfill the PEP.
 */

  /* function exit code */
  __pyx_r = 0;
  goto __pyx_L0;
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_6);
  __Pyx_AddTraceback("numpy.ndarray.__getbuffer__", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = -1;
  if (__pyx_v_info != NULL && __pyx_v_info->obj != NULL) {
    __Pyx_GOTREF(__pyx_v_info->obj);
    __Pyx_DECREF(__pyx_v_info->obj); __pyx_v_info->obj = NULL;
  }
  goto __pyx_L2;
  __pyx_L0:;
  if (__pyx_v_info != NULL && __pyx_v_info->obj == Py_None) {
    __Pyx_GOTREF(Py_None);
    __Pyx_DECREF(Py_None); __pyx_v_info->obj = NULL;
  }
  __pyx_L2:;
  __Pyx_XDECREF((PyObject *)__pyx_v_descr);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":290
 *                 f[0] = c'\0' # Terminate format string
 * 
 *         def __releasebuffer__(ndarray self, Py_buffer* info):             # <<<<<<<<<<<<<<
 *             if PyArray_HASFIELDS(self):
 *                 stdlib.free(info.format)
 */

/* Python wrapper */
static CYTHON_UNUSED void __pyx_pw_5numpy_7ndarray_3__releasebuffer__(PyObject *__pyx_v_self, Py_buffer *__pyx_v_info); /*proto*/
static CYTHON_UNUSED void __pyx_pw_5numpy_7ndarray_3__releasebuffer__(PyObject *__pyx_v_self, Py_buffer *__pyx_v_info) {
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("__releasebuffer__ (wrapper)", 0);
  __pyx_pf_5numpy_7ndarray_2__releasebuffer__(((PyArrayObject *)__pyx_v_self), ((Py_buffer *)__pyx_v_info));

  /* function exit code */
  __Pyx_RefNannyFinishContext();
}

static void __pyx_pf_5numpy_7ndarray_2__releasebuffer__(PyArrayObject *__pyx_v_self, Py_buffer *__pyx_v_info) {
  __Pyx_RefNannyDeclarations
  int __pyx_t_1;
  __Pyx_RefNannySetupContext("__releasebuffer__", 0);

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":291
 * 
 *         def __releasebuffer__(ndarray self, Py_buffer* info):
 *             if PyArray_HASFIELDS(self):             # <<<<<<<<<<<<<<
 *                 stdlib.free(info.format)
 *             if sizeof(npy_intp) != sizeof(Py_ssize_t):
 */
  __pyx_t_1 = (PyArray_HASFIELDS(__pyx_v_self) != 0);
  if (__pyx_t_1) {

    /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":292
 *         def __releasebuffer__(ndarray self, Py_buffer* info):
 *             if PyArray_HASFIELDS(self):
 *                 stdlib.free(info.format)             # <<<<<<<<<<<<<<
 *             if sizeof(npy_intp) != sizeof(Py_ssize_t):
 *                 stdlib.free(info.strides)
 */
    free(__pyx_v_info->format);

    /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":291
 * 
 *         def __releasebuffer__(ndarray self, Py_buffer* info):
 *             if PyArray_HASFIELDS(self):             # <<<<<<<<<<<<<<
 *                 stdlib.free(info.format)
 *             if sizeof(npy_intp) != sizeof(Py_ssize_t):
 */
  }

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":293
 *             if PyArray_HASFIELDS(self):
 *                 stdlib.free(info.format)
 *             if sizeof(npy_intp) != sizeof(Py_ssize_t):             # <<<<<<<<<<<<<<
 *                 stdlib.free(info.strides)
 *                 # info.shape was stored after info.strides in the same block
 */
  __pyx_t_1 = (((sizeof(npy_intp)) != (sizeof(Py_ssize_t))) != 0);
  if (__pyx_t_1) {

    /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":294
 *                 stdlib.free(info.format)
 *             if sizeof(npy_intp) != sizeof(Py_ssize_t):
 *                 stdlib.free(info.strides)             # <<<<<<<<<<<<<<
 *                 # info.shape was stored after info.strides in the same block
 * 
 */
    free(__pyx_v_info->strides);

    /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":293
 *             if PyArray_HASFIELDS(self):
 *                 stdlib.free(info.format)
 *             if sizeof(npy_intp) != sizeof(Py_ssize_t):             # <<<<<<<<<<<<<<
 *                 stdlib.free(info.strides)
 *                 # info.shape was stored after info.strides in the same block
 */
  }

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":290
 *                 f[0] = c'\0' # Terminate format string
 * 
 *         def __releasebuffer__(ndarray self, Py_buffer* info):             # <<<<<<<<<<<<<<
 *             if PyArray_HASFIELDS(self):
 *                 stdlib.free(info.format)
 */

  /* function exit code */
  __Pyx_RefNannyFinishContext();
}

/* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":770
 * ctypedef npy_cdouble     complex_t
 * 
 * cdef inline object PyArray_MultiIterNew1(a):             # <<<<<<<<<<<<<<
 *     return PyArray_MultiIterNew(1, <void*>a)
 * 
 */

static CYTHON_INLINE PyObject *__pyx_f_5numpy_PyArray_MultiIterNew1(PyObject *__pyx_v_a) {
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  PyObject *__pyx_t_1 = NULL;
  __Pyx_RefNannySetupContext("PyArray_MultiIterNew1", 0);

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":771
 * 
 * cdef inline object PyArray_MultiIterNew1(a):
 *     return PyArray_MultiIterNew(1, <void*>a)             # <<<<<<<<<<<<<<
 * 
 * cdef inline object PyArray_MultiIterNew2(a, b):
 */
  __Pyx_XDECREF(__pyx_r);
  __pyx_t_1 = PyArray_MultiIterNew(1, ((void *)__pyx_v_a)); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 771, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_r = __pyx_t_1;
  __pyx_t_1 = 0;
  goto __pyx_L0;

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":770
 * ctypedef npy_cdouble     complex_t
 * 
 * cdef inline object PyArray_MultiIterNew1(a):             # <<<<<<<<<<<<<<
 *     return PyArray_MultiIterNew(1, <void*>a)
 * 
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_1);
  __Pyx_AddTraceback("numpy.PyArray_MultiIterNew1", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = 0;
  __pyx_L0:;
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":773
 *     return PyArray_MultiIterNew(1, <void*>a)
 * 
 * cdef inline object PyArray_MultiIterNew2(a, b):             # <<<<<<<<<<<<<<
 *     return PyArray_MultiIterNew(2, <void*>a, <void*>b)
 * 
 */

static CYTHON_INLINE PyObject *__pyx_f_5numpy_PyArray_MultiIterNew2(PyObject *__pyx_v_a, PyObject *__pyx_v_b) {
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  PyObject *__pyx_t_1 = NULL;
  __Pyx_RefNannySetupContext("PyArray_MultiIterNew2", 0);

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":774
 * 
 * cdef inline object PyArray_MultiIterNew2(a, b):
 *     return PyArray_MultiIterNew(2, <void*>a, <void*>b)             # <<<<<<<<<<<<<<
 * 
 * cdef inline object PyArray_MultiIterNew3(a, b, c):
 */
  __Pyx_XDECREF(__pyx_r);
  __pyx_t_1 = PyArray_MultiIterNew(2, ((void *)__pyx_v_a), ((void *)__pyx_v_b)); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 774, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_r = __pyx_t_1;
  __pyx_t_1 = 0;
  goto __pyx_L0;

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":773
 *     return PyArray_MultiIterNew(1, <void*>a)
 * 
 * cdef inline object PyArray_MultiIterNew2(a, b):             # <<<<<<<<<<<<<<
 *     return PyArray_MultiIterNew(2, <void*>a, <void*>b)
 * 
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_1);
  __Pyx_AddTraceback("numpy.PyArray_MultiIterNew2", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = 0;
  __pyx_L0:;
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":776
 *     return PyArray_MultiIterNew(2, <void*>a, <void*>b)
 * 
 * cdef inline object PyArray_MultiIterNew3(a, b, c):             # <<<<<<<<<<<<<<
 *     return PyArray_MultiIterNew(3, <void*>a, <void*>b, <void*> c)
 * 
 */

static CYTHON_INLINE PyObject *__pyx_f_5numpy_PyArray_MultiIterNew3(PyObject *__pyx_v_a, PyObject *__pyx_v_b, PyObject *__pyx_v_c) {
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  PyObject *__pyx_t_1 = NULL;
  __Pyx_RefNannySetupContext("PyArray_MultiIterNew3", 0);

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":777
 * 
 * cdef inline object PyArray_MultiIterNew3(a, b, c):
 *     return PyArray_MultiIterNew(3, <void*>a, <void*>b, <void*> c)             # <<<<<<<<<<<<<<
 * 
 * cdef inline object PyArray_MultiIterNew4(a, b, c, d):
 */
  __Pyx_XDECREF(__pyx_r);
  __pyx_t_1 = PyArray_MultiIterNew(3, ((void *)__pyx_v_a), ((void *)__pyx_v_b), ((void *)__pyx_v_c)); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 777, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_r = __pyx_t_1;
  __pyx_t_1 = 0;
  goto __pyx_L0;

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":776
 *     return PyArray_MultiIterNew(2, <void*>a, <void*>b)
 * 
 * cdef inline object PyArray_MultiIterNew3(a, b, c):             # <<<<<<<<<<<<<<
 *     return PyArray_MultiIterNew(3, <void*>a, <void*>b, <void*> c)
 * 
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_1);
  __Pyx_AddTraceback("numpy.PyArray_MultiIterNew3", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = 0;
  __pyx_L0:;
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":779
 *     return PyArray_MultiIterNew(3, <void*>a, <void*>b, <void*> c)
 * 
 * cdef inline object PyArray_MultiIterNew4(a, b, c, d):             # <<<<<<<<<<<<<<
 *     return PyArray_MultiIterNew(4, <void*>a, <void*>b, <void*>c, <void*> d)
 * 
 */

static CYTHON_INLINE PyObject *__pyx_f_5numpy_PyArray_MultiIterNew4(PyObject *__pyx_v_a, PyObject *__pyx_v_b, PyObject *__pyx_v_c, PyObject *__pyx_v_d) {
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  PyObject *__pyx_t_1 = NULL;
  __Pyx_RefNannySetupContext("PyArray_MultiIterNew4", 0);

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":780
 * 
 * cdef inline object PyArray_MultiIterNew4(a, b, c, d):
 *     return PyArray_MultiIterNew(4, <void*>a, <void*>b, <void*>c, <void*> d)             # <<<<<<<<<<<<<<
 * 
 * cdef inline object PyArray_MultiIterNew5(a, b, c, d, e):
 */
  __Pyx_XDECREF(__pyx_r);
  __pyx_t_1 = PyArray_MultiIterNew(4, ((void *)__pyx_v_a), ((void *)__pyx_v_b), ((void *)__pyx_v_c), ((void *)__pyx_v_d)); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 780, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_r = __pyx_t_1;
  __pyx_t_1 = 0;
  goto __pyx_L0;

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":779
 *     return PyArray_MultiIterNew(3, <void*>a, <void*>b, <void*> c)
 * 
 * cdef inline object PyArray_MultiIterNew4(a, b, c, d):             # <<<<<<<<<<<<<<
 *     return PyArray_MultiIterNew(4, <void*>a, <void*>b, <void*>c, <void*> d)
 * 
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_1);
  __Pyx_AddTraceback("numpy.PyArray_MultiIterNew4", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = 0;
  __pyx_L0:;
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":782
 *     return PyArray_MultiIterNew(4, <void*>a, <void*>b, <void*>c, <void*> d)
 * 
 * cdef inline object PyArray_MultiIterNew5(a, b, c, d, e):             # <<<<<<<<<<<<<<
 *     return PyArray_MultiIterNew(5, <void*>a, <void*>b, <void*>c, <void*> d, <void*> e)
 * 
 */

static CYTHON_INLINE PyObject *__pyx_f_5numpy_PyArray_MultiIterNew5(PyObject *__pyx_v_a, PyObject *__pyx_v_b, PyObject *__pyx_v_c, PyObject *__pyx_v_d, PyObject *__pyx_v_e) {
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  PyObject *__pyx_t_1 = NULL;
  __Pyx_RefNannySetupContext("PyArray_MultiIterNew5", 0);

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":783
 * 
 * cdef inline object PyArray_MultiIterNew5(a, b, c, d, e):
 *     return PyArray_MultiIterNew(5, <void*>a, <void*>b, <void*>c, <void*> d, <void*> e)             # <<<<<<<<<<<<<<
 * 
 * cdef inline char* _util_dtypestring(dtype descr, char* f, char* end, int* offset) except NULL:
 */
  __Pyx_XDECREF(__pyx_r);
  __pyx_t_1 = PyArray_MultiIterNew(5, ((void *)__pyx_v_a), ((void *)__pyx_v_b), ((void *)__pyx_v_c), ((void *)__pyx_v_d), ((void *)__pyx_v_e)); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 783, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_r = __pyx_t_1;
  __pyx_t_1 = 0;
  goto __pyx_L0;

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":782
 *     return PyArray_MultiIterNew(4, <void*>a, <void*>b, <void*>c, <void*> d)
 * 
 * cdef inline object PyArray_MultiIterNew5(a, b, c, d, e):             # <<<<<<<<<<<<<<
 *     return PyArray_MultiIterNew(5, <void*>a, <void*>b, <void*>c, <void*> d, <void*> e)
 * 
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_1);
  __Pyx_AddTraceback("numpy.PyArray_MultiIterNew5", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = 0;
  __pyx_L0:;
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":785
 *     return PyArray_MultiIterNew(5, <void*>a, <void*>b, <void*>c, <void*> d, <void*> e)
 * 
 * cdef inline char* _util_dtypestring(dtype descr, char* f, char* end, int* offset) except NULL:             # <<<<<<<<<<<<<<
 *     # Recursive utility function used in __getbuffer__ to get format
 *     # string. The new location in the format string is returned.
 */

static CYTHON_INLINE char *__pyx_f_5numpy__util_dtypestring(PyArray_Descr *__pyx_v_descr, char *__pyx_v_f, char *__pyx_v_end, int *__pyx_v_offset) {
  PyArray_Descr *__pyx_v_child = 0;
  int __pyx_v_endian_detector;
  int __pyx_v_little_endian;
  PyObject *__pyx_v_fields = 0;
  PyObject *__pyx_v_childname = NULL;
  PyObject *__pyx_v_new_offset = NULL;
  PyObject *__pyx_v_t = NULL;
  char *__pyx_r;
  __Pyx_RefNannyDeclarations
  PyObject *__pyx_t_1 = NULL;
  Py_ssize_t __pyx_t_2;
  PyObject *__pyx_t_3 = NULL;
  PyObject *__pyx_t_4 = NULL;
  int __pyx_t_5;
  int __pyx_t_6;
  int __pyx_t_7;
  long __pyx_t_8;
  char *__pyx_t_9;
  __Pyx_RefNannySetupContext("_util_dtypestring", 0);

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":790
 * 
 *     cdef dtype child
 *     cdef int endian_detector = 1             # <<<<<<<<<<<<<<
 *     cdef bint little_endian = ((<char*>&endian_detector)[0] != 0)
 *     cdef tuple fields
 */
  __pyx_v_endian_detector = 1;

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":791
 *     cdef dtype child
 *     cdef int endian_detector = 1
 *     cdef bint little_endian = ((<char*>&endian_detector)[0] != 0)             # <<<<<<<<<<<<<<
 *     cdef tuple fields
 * 
 */
  __pyx_v_little_endian = ((((char *)(&__pyx_v_endian_detector))[0]) != 0);

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":794
 *     cdef tuple fields
 * 
 *     for childname in descr.names:             # <<<<<<<<<<<<<<
 *         fields = descr.fields[childname]
 *         child, new_offset = fields
 */
  if (unlikely(__pyx_v_descr->names == Py_None)) {
    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not iterable");
    __PYX_ERR(1, 794, __pyx_L1_error)
  }
  __pyx_t_1 = __pyx_v_descr->names; __Pyx_INCREF(__pyx_t_1); __pyx_t_2 = 0;
  for (;;) {
    if (__pyx_t_2 >= PyTuple_GET_SIZE(__pyx_t_1)) break;
    #if CYTHON_COMPILING_IN_CPYTHON
    __pyx_t_3 = PyTuple_GET_ITEM(__pyx_t_1, __pyx_t_2); __Pyx_INCREF(__pyx_t_3); __pyx_t_2++; if (unlikely(0 < 0)) __PYX_ERR(1, 794, __pyx_L1_error)
    #else
    __pyx_t_3 = PySequence_ITEM(__pyx_t_1, __pyx_t_2); __pyx_t_2++; if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 794, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    #endif
    __Pyx_XDECREF_SET(__pyx_v_childname, __pyx_t_3);
    __pyx_t_3 = 0;

    /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":795
 * 
 *     for childname in descr.names:
 *         fields = descr.fields[childname]             # <<<<<<<<<<<<<<
 *         child, new_offset = fields
 * 
 */
    if (unlikely(__pyx_v_descr->fields == Py_None)) {
      PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
      __PYX_ERR(1, 795, __pyx_L1_error)
    }
    __pyx_t_3 = __Pyx_PyDict_GetItem(__pyx_v_descr->fields, __pyx_v_childname); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 795, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    if (!(likely(PyTuple_CheckExact(__pyx_t_3))||((__pyx_t_3) == Py_None)||(PyErr_Format(PyExc_TypeError, "Expected %.16s, got %.200s", "tuple", Py_TYPE(__pyx_t_3)->tp_name), 0))) __PYX_ERR(1, 795, __pyx_L1_error)
    __Pyx_XDECREF_SET(__pyx_v_fields, ((PyObject*)__pyx_t_3));
    __pyx_t_3 = 0;

    /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":796
 *     for childname in descr.names:
 *         fields = descr.fields[childname]
 *         child, new_offset = fields             # <<<<<<<<<<<<<<
 * 
 *         if (end - f) - <int>(new_offset - offset[0]) < 15:
 */
    if (likely(__pyx_v_fields != Py_None)) {
      PyObject* sequence = __pyx_v_fields;
      #if CYTHON_COMPILING_IN_CPYTHON
      Py_ssize_t size = Py_SIZE(sequence);
      #else
      Py_ssize_t size = PySequence_Size(sequence);
      #endif
      if (unlikely(size != 2)) {
        if (size > 2) __Pyx_RaiseTooManyValuesError(2);
        else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
        __PYX_ERR(1, 796, __pyx_L1_error)
      }
      #if CYTHON_COMPILING_IN_CPYTHON
      __pyx_t_3 = PyTuple_GET_ITEM(sequence, 0); 
      __pyx_t_4 = PyTuple_GET_ITEM(sequence, 1); 
      __Pyx_INCREF(__pyx_t_3);
      __Pyx_INCREF(__pyx_t_4);
      #else
      __pyx_t_3 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 796, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __pyx_t_4 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 796, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      #endif
    } else {
      __Pyx_RaiseNoneNotIterableError(); __PYX_ERR(1, 796, __pyx_L1_error)
    }
    if (!(likely(((__pyx_t_3) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_3, __pyx_ptype_5numpy_dtype))))) __PYX_ERR(1, 796, __pyx_L1_error)
    __Pyx_XDECREF_SET(__pyx_v_child, ((PyArray_Descr *)__pyx_t_3));
    __pyx_t_3 = 0;
    __Pyx_XDECREF_SET(__pyx_v_new_offset, __pyx_t_4);
    __pyx_t_4 = 0;

    /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":798
 *         child, new_offset = fields
 * 
 *         if (end - f) - <int>(new_offset - offset[0]) < 15:             # <<<<<<<<<<<<<<
 *             raise RuntimeError(u"Format string allocated too short, see comment in numpy.pxd")
 * 
 */
    __pyx_t_4 = __Pyx_PyInt_From_int((__pyx_v_offset[0])); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 798, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_4);
    __pyx_t_3 = PyNumber_Subtract(__pyx_v_new_offset, __pyx_t_4); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 798, __pyx_L1_error)
    __Pyx_GOTREF(__pyx_t_3);
    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_t_5 = __Pyx_PyInt_As_int(__pyx_t_3); if (unlikely((__pyx_t_5 == (int)-1) && PyErr_Occurred())) __PYX_ERR(1, 798, __pyx_L1_error)
    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
    __pyx_t_6 = ((((__pyx_v_end - __pyx_v_f) - ((int)__pyx_t_5)) < 15) != 0);
    if (__pyx_t_6) {

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":799
 * 
 *         if (end - f) - <int>(new_offset - offset[0]) < 15:
 *             raise RuntimeError(u"Format string allocated too short, see comment in numpy.pxd")             # <<<<<<<<<<<<<<
 * 
 *         if ((child.byteorder == c'>' and little_endian) or
 */
      __pyx_t_3 = __Pyx_PyObject_Call(__pyx_builtin_RuntimeError, __pyx_tuple__149, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 799, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __Pyx_Raise(__pyx_t_3, 0, 0, 0);
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      __PYX_ERR(1, 799, __pyx_L1_error)

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":798
 *         child, new_offset = fields
 * 
 *         if (end - f) - <int>(new_offset - offset[0]) < 15:             # <<<<<<<<<<<<<<
 *             raise RuntimeError(u"Format string allocated too short, see comment in numpy.pxd")
 * 
 */
    }

    /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":801
 *             raise RuntimeError(u"Format string allocated too short, see comment in numpy.pxd")
 * 
 *         if ((child.byteorder == c'>' and little_endian) or             # <<<<<<<<<<<<<<
 *             (child.byteorder == c'<' and not little_endian)):
 *             raise ValueError(u"Non-native byte order not supported")
 */
    __pyx_t_7 = ((__pyx_v_child->byteorder == '>') != 0);
    if (!__pyx_t_7) {
      goto __pyx_L8_next_or;
    } else {
    }
    __pyx_t_7 = (__pyx_v_little_endian != 0);
    if (!__pyx_t_7) {
    } else {
      __pyx_t_6 = __pyx_t_7;
      goto __pyx_L7_bool_binop_done;
    }
    __pyx_L8_next_or:;

    /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":802
 * 
 *         if ((child.byteorder == c'>' and little_endian) or
 *             (child.byteorder == c'<' and not little_endian)):             # <<<<<<<<<<<<<<
 *             raise ValueError(u"Non-native byte order not supported")
 *             # One could encode it in the format string and have Cython
 */
    __pyx_t_7 = ((__pyx_v_child->byteorder == '<') != 0);
    if (__pyx_t_7) {
    } else {
      __pyx_t_6 = __pyx_t_7;
      goto __pyx_L7_bool_binop_done;
    }
    __pyx_t_7 = ((!(__pyx_v_little_endian != 0)) != 0);
    __pyx_t_6 = __pyx_t_7;
    __pyx_L7_bool_binop_done:;

    /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":801
 *             raise RuntimeError(u"Format string allocated too short, see comment in numpy.pxd")
 * 
 *         if ((child.byteorder == c'>' and little_endian) or             # <<<<<<<<<<<<<<
 *             (child.byteorder == c'<' and not little_endian)):
 *             raise ValueError(u"Non-native byte order not supported")
 */
    if (__pyx_t_6) {

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":803
 *         if ((child.byteorder == c'>' and little_endian) or
 *             (child.byteorder == c'<' and not little_endian)):
 *             raise ValueError(u"Non-native byte order not supported")             # <<<<<<<<<<<<<<
 *             # One could encode it in the format string and have Cython
 *             # complain instead, BUT: < and > in format strings also imply
 */
      __pyx_t_3 = __Pyx_PyObject_Call(__pyx_builtin_ValueError, __pyx_tuple__150, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 803, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __Pyx_Raise(__pyx_t_3, 0, 0, 0);
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      __PYX_ERR(1, 803, __pyx_L1_error)

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":801
 *             raise RuntimeError(u"Format string allocated too short, see comment in numpy.pxd")
 * 
 *         if ((child.byteorder == c'>' and little_endian) or             # <<<<<<<<<<<<<<
 *             (child.byteorder == c'<' and not little_endian)):
 *             raise ValueError(u"Non-native byte order not supported")
 */
    }

    /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":813
 * 
 *         # Output padding bytes
 *         while offset[0] < new_offset:             # <<<<<<<<<<<<<<
 *             f[0] = 120 # "x"; pad byte
 *             f += 1
 */
    while (1) {
      __pyx_t_3 = __Pyx_PyInt_From_int((__pyx_v_offset[0])); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 813, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __pyx_t_4 = PyObject_RichCompare(__pyx_t_3, __pyx_v_new_offset, Py_LT); __Pyx_XGOTREF(__pyx_t_4); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 813, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      __pyx_t_6 = __Pyx_PyObject_IsTrue(__pyx_t_4); if (unlikely(__pyx_t_6 < 0)) __PYX_ERR(1, 813, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      if (!__pyx_t_6) break;

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":814
 *         # Output padding bytes
 *         while offset[0] < new_offset:
 *             f[0] = 120 # "x"; pad byte             # <<<<<<<<<<<<<<
 *             f += 1
 *             offset[0] += 1
 */
      (__pyx_v_f[0]) = 0x78;

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":815
 *         while offset[0] < new_offset:
 *             f[0] = 120 # "x"; pad byte
 *             f += 1             # <<<<<<<<<<<<<<
 *             offset[0] += 1
 * 
 */
      __pyx_v_f = (__pyx_v_f + 1);

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":816
 *             f[0] = 120 # "x"; pad byte
 *             f += 1
 *             offset[0] += 1             # <<<<<<<<<<<<<<
 * 
 *         offset[0] += child.itemsize
 */
      __pyx_t_8 = 0;
      (__pyx_v_offset[__pyx_t_8]) = ((__pyx_v_offset[__pyx_t_8]) + 1);
    }

    /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":818
 *             offset[0] += 1
 * 
 *         offset[0] += child.itemsize             # <<<<<<<<<<<<<<
 * 
 *         if not PyDataType_HASFIELDS(child):
 */
    __pyx_t_8 = 0;
    (__pyx_v_offset[__pyx_t_8]) = ((__pyx_v_offset[__pyx_t_8]) + __pyx_v_child->elsize);

    /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":820
 *         offset[0] += child.itemsize
 * 
 *         if not PyDataType_HASFIELDS(child):             # <<<<<<<<<<<<<<
 *             t = child.type_num
 *             if end - f < 5:
 */
    __pyx_t_6 = ((!(PyDataType_HASFIELDS(__pyx_v_child) != 0)) != 0);
    if (__pyx_t_6) {

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":821
 * 
 *         if not PyDataType_HASFIELDS(child):
 *             t = child.type_num             # <<<<<<<<<<<<<<
 *             if end - f < 5:
 *                 raise RuntimeError(u"Format string allocated too short.")
 */
      __pyx_t_4 = __Pyx_PyInt_From_int(__pyx_v_child->type_num); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 821, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __Pyx_XDECREF_SET(__pyx_v_t, __pyx_t_4);
      __pyx_t_4 = 0;

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":822
 *         if not PyDataType_HASFIELDS(child):
 *             t = child.type_num
 *             if end - f < 5:             # <<<<<<<<<<<<<<
 *                 raise RuntimeError(u"Format string allocated too short.")
 * 
 */
      __pyx_t_6 = (((__pyx_v_end - __pyx_v_f) < 5) != 0);
      if (__pyx_t_6) {

        /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":823
 *             t = child.type_num
 *             if end - f < 5:
 *                 raise RuntimeError(u"Format string allocated too short.")             # <<<<<<<<<<<<<<
 * 
 *             # Until ticket #99 is fixed, use integers to avoid warnings
 */
        __pyx_t_4 = __Pyx_PyObject_Call(__pyx_builtin_RuntimeError, __pyx_tuple__151, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 823, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_4);
        __Pyx_Raise(__pyx_t_4, 0, 0, 0);
        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
        __PYX_ERR(1, 823, __pyx_L1_error)

        /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":822
 *         if not PyDataType_HASFIELDS(child):
 *             t = child.type_num
 *             if end - f < 5:             # <<<<<<<<<<<<<<
 *                 raise RuntimeError(u"Format string allocated too short.")
 * 
 */
      }

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":826
 * 
 *             # Until ticket #99 is fixed, use integers to avoid warnings
 *             if   t == NPY_BYTE:        f[0] =  98 #"b"             # <<<<<<<<<<<<<<
 *             elif t == NPY_UBYTE:       f[0] =  66 #"B"
 *             elif t == NPY_SHORT:       f[0] = 104 #"h"
 */
      __pyx_t_4 = __Pyx_PyInt_From_enum__NPY_TYPES(NPY_BYTE); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 826, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __pyx_t_3 = PyObject_RichCompare(__pyx_v_t, __pyx_t_4, Py_EQ); __Pyx_XGOTREF(__pyx_t_3); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 826, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __pyx_t_6 = __Pyx_PyObject_IsTrue(__pyx_t_3); if (unlikely(__pyx_t_6 < 0)) __PYX_ERR(1, 826, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      if (__pyx_t_6) {
        (__pyx_v_f[0]) = 98;
        goto __pyx_L15;
      }

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":827
 *             # Until ticket #99 is fixed, use integers to avoid warnings
 *             if   t == NPY_BYTE:        f[0] =  98 #"b"
 *             elif t == NPY_UBYTE:       f[0] =  66 #"B"             # <<<<<<<<<<<<<<
 *             elif t == NPY_SHORT:       f[0] = 104 #"h"
 *             elif t == NPY_USHORT:      f[0] =  72 #"H"
 */
      __pyx_t_3 = __Pyx_PyInt_From_enum__NPY_TYPES(NPY_UBYTE); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 827, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __pyx_t_4 = PyObject_RichCompare(__pyx_v_t, __pyx_t_3, Py_EQ); __Pyx_XGOTREF(__pyx_t_4); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 827, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      __pyx_t_6 = __Pyx_PyObject_IsTrue(__pyx_t_4); if (unlikely(__pyx_t_6 < 0)) __PYX_ERR(1, 827, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      if (__pyx_t_6) {
        (__pyx_v_f[0]) = 66;
        goto __pyx_L15;
      }

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":828
 *             if   t == NPY_BYTE:        f[0] =  98 #"b"
 *             elif t == NPY_UBYTE:       f[0] =  66 #"B"
 *             elif t == NPY_SHORT:       f[0] = 104 #"h"             # <<<<<<<<<<<<<<
 *             elif t == NPY_USHORT:      f[0] =  72 #"H"
 *             elif t == NPY_INT:         f[0] = 105 #"i"
 */
      __pyx_t_4 = __Pyx_PyInt_From_enum__NPY_TYPES(NPY_SHORT); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 828, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __pyx_t_3 = PyObject_RichCompare(__pyx_v_t, __pyx_t_4, Py_EQ); __Pyx_XGOTREF(__pyx_t_3); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 828, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __pyx_t_6 = __Pyx_PyObject_IsTrue(__pyx_t_3); if (unlikely(__pyx_t_6 < 0)) __PYX_ERR(1, 828, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      if (__pyx_t_6) {
        (__pyx_v_f[0]) = 0x68;
        goto __pyx_L15;
      }

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":829
 *             elif t == NPY_UBYTE:       f[0] =  66 #"B"
 *             elif t == NPY_SHORT:       f[0] = 104 #"h"
 *             elif t == NPY_USHORT:      f[0] =  72 #"H"             # <<<<<<<<<<<<<<
 *             elif t == NPY_INT:         f[0] = 105 #"i"
 *             elif t == NPY_UINT:        f[0] =  73 #"I"
 */
      __pyx_t_3 = __Pyx_PyInt_From_enum__NPY_TYPES(NPY_USHORT); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 829, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __pyx_t_4 = PyObject_RichCompare(__pyx_v_t, __pyx_t_3, Py_EQ); __Pyx_XGOTREF(__pyx_t_4); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 829, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      __pyx_t_6 = __Pyx_PyObject_IsTrue(__pyx_t_4); if (unlikely(__pyx_t_6 < 0)) __PYX_ERR(1, 829, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      if (__pyx_t_6) {
        (__pyx_v_f[0]) = 72;
        goto __pyx_L15;
      }

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":830
 *             elif t == NPY_SHORT:       f[0] = 104 #"h"
 *             elif t == NPY_USHORT:      f[0] =  72 #"H"
 *             elif t == NPY_INT:         f[0] = 105 #"i"             # <<<<<<<<<<<<<<
 *             elif t == NPY_UINT:        f[0] =  73 #"I"
 *             elif t == NPY_LONG:        f[0] = 108 #"l"
 */
      __pyx_t_4 = __Pyx_PyInt_From_enum__NPY_TYPES(NPY_INT); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 830, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __pyx_t_3 = PyObject_RichCompare(__pyx_v_t, __pyx_t_4, Py_EQ); __Pyx_XGOTREF(__pyx_t_3); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 830, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __pyx_t_6 = __Pyx_PyObject_IsTrue(__pyx_t_3); if (unlikely(__pyx_t_6 < 0)) __PYX_ERR(1, 830, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      if (__pyx_t_6) {
        (__pyx_v_f[0]) = 0x69;
        goto __pyx_L15;
      }

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":831
 *             elif t == NPY_USHORT:      f[0] =  72 #"H"
 *             elif t == NPY_INT:         f[0] = 105 #"i"
 *             elif t == NPY_UINT:        f[0] =  73 #"I"             # <<<<<<<<<<<<<<
 *             elif t == NPY_LONG:        f[0] = 108 #"l"
 *             elif t == NPY_ULONG:       f[0] = 76  #"L"
 */
      __pyx_t_3 = __Pyx_PyInt_From_enum__NPY_TYPES(NPY_UINT); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 831, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __pyx_t_4 = PyObject_RichCompare(__pyx_v_t, __pyx_t_3, Py_EQ); __Pyx_XGOTREF(__pyx_t_4); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 831, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      __pyx_t_6 = __Pyx_PyObject_IsTrue(__pyx_t_4); if (unlikely(__pyx_t_6 < 0)) __PYX_ERR(1, 831, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      if (__pyx_t_6) {
        (__pyx_v_f[0]) = 73;
        goto __pyx_L15;
      }

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":832
 *             elif t == NPY_INT:         f[0] = 105 #"i"
 *             elif t == NPY_UINT:        f[0] =  73 #"I"
 *             elif t == NPY_LONG:        f[0] = 108 #"l"             # <<<<<<<<<<<<<<
 *             elif t == NPY_ULONG:       f[0] = 76  #"L"
 *             elif t == NPY_LONGLONG:    f[0] = 113 #"q"
 */
      __pyx_t_4 = __Pyx_PyInt_From_enum__NPY_TYPES(NPY_LONG); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 832, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __pyx_t_3 = PyObject_RichCompare(__pyx_v_t, __pyx_t_4, Py_EQ); __Pyx_XGOTREF(__pyx_t_3); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 832, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __pyx_t_6 = __Pyx_PyObject_IsTrue(__pyx_t_3); if (unlikely(__pyx_t_6 < 0)) __PYX_ERR(1, 832, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      if (__pyx_t_6) {
        (__pyx_v_f[0]) = 0x6C;
        goto __pyx_L15;
      }

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":833
 *             elif t == NPY_UINT:        f[0] =  73 #"I"
 *             elif t == NPY_LONG:        f[0] = 108 #"l"
 *             elif t == NPY_ULONG:       f[0] = 76  #"L"             # <<<<<<<<<<<<<<
 *             elif t == NPY_LONGLONG:    f[0] = 113 #"q"
 *             elif t == NPY_ULONGLONG:   f[0] = 81  #"Q"
 */
      __pyx_t_3 = __Pyx_PyInt_From_enum__NPY_TYPES(NPY_ULONG); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 833, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __pyx_t_4 = PyObject_RichCompare(__pyx_v_t, __pyx_t_3, Py_EQ); __Pyx_XGOTREF(__pyx_t_4); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 833, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      __pyx_t_6 = __Pyx_PyObject_IsTrue(__pyx_t_4); if (unlikely(__pyx_t_6 < 0)) __PYX_ERR(1, 833, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      if (__pyx_t_6) {
        (__pyx_v_f[0]) = 76;
        goto __pyx_L15;
      }

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":834
 *             elif t == NPY_LONG:        f[0] = 108 #"l"
 *             elif t == NPY_ULONG:       f[0] = 76  #"L"
 *             elif t == NPY_LONGLONG:    f[0] = 113 #"q"             # <<<<<<<<<<<<<<
 *             elif t == NPY_ULONGLONG:   f[0] = 81  #"Q"
 *             elif t == NPY_FLOAT:       f[0] = 102 #"f"
 */
      __pyx_t_4 = __Pyx_PyInt_From_enum__NPY_TYPES(NPY_LONGLONG); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 834, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __pyx_t_3 = PyObject_RichCompare(__pyx_v_t, __pyx_t_4, Py_EQ); __Pyx_XGOTREF(__pyx_t_3); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 834, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __pyx_t_6 = __Pyx_PyObject_IsTrue(__pyx_t_3); if (unlikely(__pyx_t_6 < 0)) __PYX_ERR(1, 834, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      if (__pyx_t_6) {
        (__pyx_v_f[0]) = 0x71;
        goto __pyx_L15;
      }

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":835
 *             elif t == NPY_ULONG:       f[0] = 76  #"L"
 *             elif t == NPY_LONGLONG:    f[0] = 113 #"q"
 *             elif t == NPY_ULONGLONG:   f[0] = 81  #"Q"             # <<<<<<<<<<<<<<
 *             elif t == NPY_FLOAT:       f[0] = 102 #"f"
 *             elif t == NPY_DOUBLE:      f[0] = 100 #"d"
 */
      __pyx_t_3 = __Pyx_PyInt_From_enum__NPY_TYPES(NPY_ULONGLONG); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 835, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __pyx_t_4 = PyObject_RichCompare(__pyx_v_t, __pyx_t_3, Py_EQ); __Pyx_XGOTREF(__pyx_t_4); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 835, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      __pyx_t_6 = __Pyx_PyObject_IsTrue(__pyx_t_4); if (unlikely(__pyx_t_6 < 0)) __PYX_ERR(1, 835, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      if (__pyx_t_6) {
        (__pyx_v_f[0]) = 81;
        goto __pyx_L15;
      }

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":836
 *             elif t == NPY_LONGLONG:    f[0] = 113 #"q"
 *             elif t == NPY_ULONGLONG:   f[0] = 81  #"Q"
 *             elif t == NPY_FLOAT:       f[0] = 102 #"f"             # <<<<<<<<<<<<<<
 *             elif t == NPY_DOUBLE:      f[0] = 100 #"d"
 *             elif t == NPY_LONGDOUBLE:  f[0] = 103 #"g"
 */
      __pyx_t_4 = __Pyx_PyInt_From_enum__NPY_TYPES(NPY_FLOAT); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 836, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __pyx_t_3 = PyObject_RichCompare(__pyx_v_t, __pyx_t_4, Py_EQ); __Pyx_XGOTREF(__pyx_t_3); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 836, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __pyx_t_6 = __Pyx_PyObject_IsTrue(__pyx_t_3); if (unlikely(__pyx_t_6 < 0)) __PYX_ERR(1, 836, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      if (__pyx_t_6) {
        (__pyx_v_f[0]) = 0x66;
        goto __pyx_L15;
      }

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":837
 *             elif t == NPY_ULONGLONG:   f[0] = 81  #"Q"
 *             elif t == NPY_FLOAT:       f[0] = 102 #"f"
 *             elif t == NPY_DOUBLE:      f[0] = 100 #"d"             # <<<<<<<<<<<<<<
 *             elif t == NPY_LONGDOUBLE:  f[0] = 103 #"g"
 *             elif t == NPY_CFLOAT:      f[0] = 90; f[1] = 102; f += 1 # Zf
 */
      __pyx_t_3 = __Pyx_PyInt_From_enum__NPY_TYPES(NPY_DOUBLE); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 837, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __pyx_t_4 = PyObject_RichCompare(__pyx_v_t, __pyx_t_3, Py_EQ); __Pyx_XGOTREF(__pyx_t_4); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 837, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      __pyx_t_6 = __Pyx_PyObject_IsTrue(__pyx_t_4); if (unlikely(__pyx_t_6 < 0)) __PYX_ERR(1, 837, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      if (__pyx_t_6) {
        (__pyx_v_f[0]) = 0x64;
        goto __pyx_L15;
      }

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":838
 *             elif t == NPY_FLOAT:       f[0] = 102 #"f"
 *             elif t == NPY_DOUBLE:      f[0] = 100 #"d"
 *             elif t == NPY_LONGDOUBLE:  f[0] = 103 #"g"             # <<<<<<<<<<<<<<
 *             elif t == NPY_CFLOAT:      f[0] = 90; f[1] = 102; f += 1 # Zf
 *             elif t == NPY_CDOUBLE:     f[0] = 90; f[1] = 100; f += 1 # Zd
 */
      __pyx_t_4 = __Pyx_PyInt_From_enum__NPY_TYPES(NPY_LONGDOUBLE); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 838, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __pyx_t_3 = PyObject_RichCompare(__pyx_v_t, __pyx_t_4, Py_EQ); __Pyx_XGOTREF(__pyx_t_3); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 838, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __pyx_t_6 = __Pyx_PyObject_IsTrue(__pyx_t_3); if (unlikely(__pyx_t_6 < 0)) __PYX_ERR(1, 838, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      if (__pyx_t_6) {
        (__pyx_v_f[0]) = 0x67;
        goto __pyx_L15;
      }

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":839
 *             elif t == NPY_DOUBLE:      f[0] = 100 #"d"
 *             elif t == NPY_LONGDOUBLE:  f[0] = 103 #"g"
 *             elif t == NPY_CFLOAT:      f[0] = 90; f[1] = 102; f += 1 # Zf             # <<<<<<<<<<<<<<
 *             elif t == NPY_CDOUBLE:     f[0] = 90; f[1] = 100; f += 1 # Zd
 *             elif t == NPY_CLONGDOUBLE: f[0] = 90; f[1] = 103; f += 1 # Zg
 */
      __pyx_t_3 = __Pyx_PyInt_From_enum__NPY_TYPES(NPY_CFLOAT); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 839, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __pyx_t_4 = PyObject_RichCompare(__pyx_v_t, __pyx_t_3, Py_EQ); __Pyx_XGOTREF(__pyx_t_4); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 839, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      __pyx_t_6 = __Pyx_PyObject_IsTrue(__pyx_t_4); if (unlikely(__pyx_t_6 < 0)) __PYX_ERR(1, 839, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      if (__pyx_t_6) {
        (__pyx_v_f[0]) = 90;
        (__pyx_v_f[1]) = 0x66;
        __pyx_v_f = (__pyx_v_f + 1);
        goto __pyx_L15;
      }

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":840
 *             elif t == NPY_LONGDOUBLE:  f[0] = 103 #"g"
 *             elif t == NPY_CFLOAT:      f[0] = 90; f[1] = 102; f += 1 # Zf
 *             elif t == NPY_CDOUBLE:     f[0] = 90; f[1] = 100; f += 1 # Zd             # <<<<<<<<<<<<<<
 *             elif t == NPY_CLONGDOUBLE: f[0] = 90; f[1] = 103; f += 1 # Zg
 *             elif t == NPY_OBJECT:      f[0] = 79 #"O"
 */
      __pyx_t_4 = __Pyx_PyInt_From_enum__NPY_TYPES(NPY_CDOUBLE); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 840, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __pyx_t_3 = PyObject_RichCompare(__pyx_v_t, __pyx_t_4, Py_EQ); __Pyx_XGOTREF(__pyx_t_3); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 840, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __pyx_t_6 = __Pyx_PyObject_IsTrue(__pyx_t_3); if (unlikely(__pyx_t_6 < 0)) __PYX_ERR(1, 840, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      if (__pyx_t_6) {
        (__pyx_v_f[0]) = 90;
        (__pyx_v_f[1]) = 0x64;
        __pyx_v_f = (__pyx_v_f + 1);
        goto __pyx_L15;
      }

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":841
 *             elif t == NPY_CFLOAT:      f[0] = 90; f[1] = 102; f += 1 # Zf
 *             elif t == NPY_CDOUBLE:     f[0] = 90; f[1] = 100; f += 1 # Zd
 *             elif t == NPY_CLONGDOUBLE: f[0] = 90; f[1] = 103; f += 1 # Zg             # <<<<<<<<<<<<<<
 *             elif t == NPY_OBJECT:      f[0] = 79 #"O"
 *             else:
 */
      __pyx_t_3 = __Pyx_PyInt_From_enum__NPY_TYPES(NPY_CLONGDOUBLE); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 841, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_3);
      __pyx_t_4 = PyObject_RichCompare(__pyx_v_t, __pyx_t_3, Py_EQ); __Pyx_XGOTREF(__pyx_t_4); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 841, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      __pyx_t_6 = __Pyx_PyObject_IsTrue(__pyx_t_4); if (unlikely(__pyx_t_6 < 0)) __PYX_ERR(1, 841, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      if (__pyx_t_6) {
        (__pyx_v_f[0]) = 90;
        (__pyx_v_f[1]) = 0x67;
        __pyx_v_f = (__pyx_v_f + 1);
        goto __pyx_L15;
      }

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":842
 *             elif t == NPY_CDOUBLE:     f[0] = 90; f[1] = 100; f += 1 # Zd
 *             elif t == NPY_CLONGDOUBLE: f[0] = 90; f[1] = 103; f += 1 # Zg
 *             elif t == NPY_OBJECT:      f[0] = 79 #"O"             # <<<<<<<<<<<<<<
 *             else:
 *                 raise ValueError(u"unknown dtype code in numpy.pxd (%d)" % t)
 */
      __pyx_t_4 = __Pyx_PyInt_From_enum__NPY_TYPES(NPY_OBJECT); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 842, __pyx_L1_error)
      __Pyx_GOTREF(__pyx_t_4);
      __pyx_t_3 = PyObject_RichCompare(__pyx_v_t, __pyx_t_4, Py_EQ); __Pyx_XGOTREF(__pyx_t_3); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 842, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
      __pyx_t_6 = __Pyx_PyObject_IsTrue(__pyx_t_3); if (unlikely(__pyx_t_6 < 0)) __PYX_ERR(1, 842, __pyx_L1_error)
      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
      if (__pyx_t_6) {
        (__pyx_v_f[0]) = 79;
        goto __pyx_L15;
      }

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":844
 *             elif t == NPY_OBJECT:      f[0] = 79 #"O"
 *             else:
 *                 raise ValueError(u"unknown dtype code in numpy.pxd (%d)" % t)             # <<<<<<<<<<<<<<
 *             f += 1
 *         else:
 */
      /*else*/ {
        __pyx_t_3 = PyUnicode_Format(__pyx_kp_u_unknown_dtype_code_in_numpy_pxd, __pyx_v_t); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 844, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_3);
        __pyx_t_4 = PyTuple_New(1); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 844, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_4);
        __Pyx_GIVEREF(__pyx_t_3);
        PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_3);
        __pyx_t_3 = 0;
        __pyx_t_3 = __Pyx_PyObject_Call(__pyx_builtin_ValueError, __pyx_t_4, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 844, __pyx_L1_error)
        __Pyx_GOTREF(__pyx_t_3);
        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
        __Pyx_Raise(__pyx_t_3, 0, 0, 0);
        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
        __PYX_ERR(1, 844, __pyx_L1_error)
      }
      __pyx_L15:;

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":845
 *             else:
 *                 raise ValueError(u"unknown dtype code in numpy.pxd (%d)" % t)
 *             f += 1             # <<<<<<<<<<<<<<
 *         else:
 *             # Cython ignores struct boundary information ("T{...}"),
 */
      __pyx_v_f = (__pyx_v_f + 1);

      /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":820
 *         offset[0] += child.itemsize
 * 
 *         if not PyDataType_HASFIELDS(child):             # <<<<<<<<<<<<<<
 *             t = child.type_num
 *             if end - f < 5:
 */
      goto __pyx_L13;
    }

    /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":849
 *             # Cython ignores struct boundary information ("T{...}"),
 *             # so don't output it
 *             f = _util_dtypestring(child, f, end, offset)             # <<<<<<<<<<<<<<
 *     return f
 * 
 */
    /*else*/ {
      __pyx_t_9 = __pyx_f_5numpy__util_dtypestring(__pyx_v_child, __pyx_v_f, __pyx_v_end, __pyx_v_offset); if (unlikely(__pyx_t_9 == NULL)) __PYX_ERR(1, 849, __pyx_L1_error)
      __pyx_v_f = __pyx_t_9;
    }
    __pyx_L13:;

    /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":794
 *     cdef tuple fields
 * 
 *     for childname in descr.names:             # <<<<<<<<<<<<<<
 *         fields = descr.fields[childname]
 *         child, new_offset = fields
 */
  }
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":850
 *             # so don't output it
 *             f = _util_dtypestring(child, f, end, offset)
 *     return f             # <<<<<<<<<<<<<<
 * 
 * 
 */
  __pyx_r = __pyx_v_f;
  goto __pyx_L0;

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":785
 *     return PyArray_MultiIterNew(5, <void*>a, <void*>b, <void*>c, <void*> d, <void*> e)
 * 
 * cdef inline char* _util_dtypestring(dtype descr, char* f, char* end, int* offset) except NULL:             # <<<<<<<<<<<<<<
 *     # Recursive utility function used in __getbuffer__ to get format
 *     # string. The new location in the format string is returned.
 */

  /* function exit code */
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_1);
  __Pyx_XDECREF(__pyx_t_3);
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_AddTraceback("numpy._util_dtypestring", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  __pyx_L0:;
  __Pyx_XDECREF((PyObject *)__pyx_v_child);
  __Pyx_XDECREF(__pyx_v_fields);
  __Pyx_XDECREF(__pyx_v_childname);
  __Pyx_XDECREF(__pyx_v_new_offset);
  __Pyx_XDECREF(__pyx_v_t);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

/* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":966
 * 
 * 
 * cdef inline void set_array_base(ndarray arr, object base):             # <<<<<<<<<<<<<<
 *      cdef PyObject* baseptr
 *      if base is None:
 */

static CYTHON_INLINE void __pyx_f_5numpy_set_array_base(PyArrayObject *__pyx_v_arr, PyObject *__pyx_v_base) {
  PyObject *__pyx_v_baseptr;
  __Pyx_RefNannyDeclarations
  int __pyx_t_1;
  int __pyx_t_2;
  __Pyx_RefNannySetupContext("set_array_base", 0);

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":968
 * cdef inline void set_array_base(ndarray arr, object base):
 *      cdef PyObject* baseptr
 *      if base is None:             # <<<<<<<<<<<<<<
 *          baseptr = NULL
 *      else:
 */
  __pyx_t_1 = (__pyx_v_base == Py_None);
  __pyx_t_2 = (__pyx_t_1 != 0);
  if (__pyx_t_2) {

    /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":969
 *      cdef PyObject* baseptr
 *      if base is None:
 *          baseptr = NULL             # <<<<<<<<<<<<<<
 *      else:
 *          Py_INCREF(base) # important to do this before decref below!
 */
    __pyx_v_baseptr = NULL;

    /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":968
 * cdef inline void set_array_base(ndarray arr, object base):
 *      cdef PyObject* baseptr
 *      if base is None:             # <<<<<<<<<<<<<<
 *          baseptr = NULL
 *      else:
 */
    goto __pyx_L3;
  }

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":971
 *          baseptr = NULL
 *      else:
 *          Py_INCREF(base) # important to do this before decref below!             # <<<<<<<<<<<<<<
 *          baseptr = <PyObject*>base
 *      Py_XDECREF(arr.base)
 */
  /*else*/ {
    Py_INCREF(__pyx_v_base);

    /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":972
 *      else:
 *          Py_INCREF(base) # important to do this before decref below!
 *          baseptr = <PyObject*>base             # <<<<<<<<<<<<<<
 *      Py_XDECREF(arr.base)
 *      arr.base = baseptr
 */
    __pyx_v_baseptr = ((PyObject *)__pyx_v_base);
  }
  __pyx_L3:;

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":973
 *          Py_INCREF(base) # important to do this before decref below!
 *          baseptr = <PyObject*>base
 *      Py_XDECREF(arr.base)             # <<<<<<<<<<<<<<
 *      arr.base = baseptr
 * 
 */
  Py_XDECREF(__pyx_v_arr->base);

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":974
 *          baseptr = <PyObject*>base
 *      Py_XDECREF(arr.base)
 *      arr.base = baseptr             # <<<<<<<<<<<<<<
 * 
 * cdef inline object get_array_base(ndarray arr):
 */
  __pyx_v_arr->base = __pyx_v_baseptr;

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":966
 * 
 * 
 * cdef inline void set_array_base(ndarray arr, object base):             # <<<<<<<<<<<<<<
 *      cdef PyObject* baseptr
 *      if base is None:
 */

  /* function exit code */
  __Pyx_RefNannyFinishContext();
}

/* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":976
 *      arr.base = baseptr
 * 
 * cdef inline object get_array_base(ndarray arr):             # <<<<<<<<<<<<<<
 *     if arr.base is NULL:
 *         return None
 */

static CYTHON_INLINE PyObject *__pyx_f_5numpy_get_array_base(PyArrayObject *__pyx_v_arr) {
  PyObject *__pyx_r = NULL;
  __Pyx_RefNannyDeclarations
  int __pyx_t_1;
  __Pyx_RefNannySetupContext("get_array_base", 0);

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":977
 * 
 * cdef inline object get_array_base(ndarray arr):
 *     if arr.base is NULL:             # <<<<<<<<<<<<<<
 *         return None
 *     else:
 */
  __pyx_t_1 = ((__pyx_v_arr->base == NULL) != 0);
  if (__pyx_t_1) {

    /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":978
 * cdef inline object get_array_base(ndarray arr):
 *     if arr.base is NULL:
 *         return None             # <<<<<<<<<<<<<<
 *     else:
 *         return <object>arr.base
 */
    __Pyx_XDECREF(__pyx_r);
    __Pyx_INCREF(Py_None);
    __pyx_r = Py_None;
    goto __pyx_L0;

    /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":977
 * 
 * cdef inline object get_array_base(ndarray arr):
 *     if arr.base is NULL:             # <<<<<<<<<<<<<<
 *         return None
 *     else:
 */
  }

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":980
 *         return None
 *     else:
 *         return <object>arr.base             # <<<<<<<<<<<<<<
 */
  /*else*/ {
    __Pyx_XDECREF(__pyx_r);
    __Pyx_INCREF(((PyObject *)__pyx_v_arr->base));
    __pyx_r = ((PyObject *)__pyx_v_arr->base);
    goto __pyx_L0;
  }

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":976
 *      arr.base = baseptr
 * 
 * cdef inline object get_array_base(ndarray arr):             # <<<<<<<<<<<<<<
 *     if arr.base is NULL:
 *         return None
 */

  /* function exit code */
  __pyx_L0:;
  __Pyx_XGIVEREF(__pyx_r);
  __Pyx_RefNannyFinishContext();
  return __pyx_r;
}

static struct __pyx_obj_3orb_6cutils___pyx_scope_struct__multi_fit_stars *__pyx_freelist_3orb_6cutils___pyx_scope_struct__multi_fit_stars[8];
static int __pyx_freecount_3orb_6cutils___pyx_scope_struct__multi_fit_stars = 0;

static PyObject *__pyx_tp_new_3orb_6cutils___pyx_scope_struct__multi_fit_stars(PyTypeObject *t, CYTHON_UNUSED PyObject *a, CYTHON_UNUSED PyObject *k) {
  PyObject *o;
  if (CYTHON_COMPILING_IN_CPYTHON && likely((__pyx_freecount_3orb_6cutils___pyx_scope_struct__multi_fit_stars > 0) & (t->tp_basicsize == sizeof(struct __pyx_obj_3orb_6cutils___pyx_scope_struct__multi_fit_stars)))) {
    o = (PyObject*)__pyx_freelist_3orb_6cutils___pyx_scope_struct__multi_fit_stars[--__pyx_freecount_3orb_6cutils___pyx_scope_struct__multi_fit_stars];
    memset(o, 0, sizeof(struct __pyx_obj_3orb_6cutils___pyx_scope_struct__multi_fit_stars));
    (void) PyObject_INIT(o, t);
    PyObject_GC_Track(o);
  } else {
    o = (*t->tp_alloc)(t, 0);
    if (unlikely(!o)) return 0;
  }
  return o;
}

static void __pyx_tp_dealloc_3orb_6cutils___pyx_scope_struct__multi_fit_stars(PyObject *o) {
  struct __pyx_obj_3orb_6cutils___pyx_scope_struct__multi_fit_stars *p = (struct __pyx_obj_3orb_6cutils___pyx_scope_struct__multi_fit_stars *)o;
  PyObject_GC_UnTrack(o);
  Py_CLEAR(p->__pyx_v_model_diff);
  Py_CLEAR(p->__pyx_v_params_vect2arrays);
  if (CYTHON_COMPILING_IN_CPYTHON && ((__pyx_freecount_3orb_6cutils___pyx_scope_struct__multi_fit_stars < 8) & (Py_TYPE(o)->tp_basicsize == sizeof(struct __pyx_obj_3orb_6cutils___pyx_scope_struct__multi_fit_stars)))) {
    __pyx_freelist_3orb_6cutils___pyx_scope_struct__multi_fit_stars[__pyx_freecount_3orb_6cutils___pyx_scope_struct__multi_fit_stars++] = ((struct __pyx_obj_3orb_6cutils___pyx_scope_struct__multi_fit_stars *)o);
  } else {
    (*Py_TYPE(o)->tp_free)(o);
  }
}

static int __pyx_tp_traverse_3orb_6cutils___pyx_scope_struct__multi_fit_stars(PyObject *o, visitproc v, void *a) {
  int e;
  struct __pyx_obj_3orb_6cutils___pyx_scope_struct__multi_fit_stars *p = (struct __pyx_obj_3orb_6cutils___pyx_scope_struct__multi_fit_stars *)o;
  if (p->__pyx_v_model_diff) {
    e = (*v)(p->__pyx_v_model_diff, a); if (e) return e;
  }
  if (p->__pyx_v_params_vect2arrays) {
    e = (*v)(p->__pyx_v_params_vect2arrays, a); if (e) return e;
  }
  return 0;
}

static int __pyx_tp_clear_3orb_6cutils___pyx_scope_struct__multi_fit_stars(PyObject *o) {
  PyObject* tmp;
  struct __pyx_obj_3orb_6cutils___pyx_scope_struct__multi_fit_stars *p = (struct __pyx_obj_3orb_6cutils___pyx_scope_struct__multi_fit_stars *)o;
  tmp = ((PyObject*)p->__pyx_v_model_diff);
  p->__pyx_v_model_diff = Py_None; Py_INCREF(Py_None);
  Py_XDECREF(tmp);
  tmp = ((PyObject*)p->__pyx_v_params_vect2arrays);
  p->__pyx_v_params_vect2arrays = Py_None; Py_INCREF(Py_None);
  Py_XDECREF(tmp);
  return 0;
}

static PyTypeObject __pyx_type_3orb_6cutils___pyx_scope_struct__multi_fit_stars = {
  PyVarObject_HEAD_INIT(0, 0)
  "orb.cutils.__pyx_scope_struct__multi_fit_stars", /*tp_name*/
  sizeof(struct __pyx_obj_3orb_6cutils___pyx_scope_struct__multi_fit_stars), /*tp_basicsize*/
  0, /*tp_itemsize*/
  __pyx_tp_dealloc_3orb_6cutils___pyx_scope_struct__multi_fit_stars, /*tp_dealloc*/
  0, /*tp_print*/
  0, /*tp_getattr*/
  0, /*tp_setattr*/
  #if PY_MAJOR_VERSION < 3
  0, /*tp_compare*/
  #endif
  #if PY_MAJOR_VERSION >= 3
  0, /*tp_as_async*/
  #endif
  0, /*tp_repr*/
  0, /*tp_as_number*/
  0, /*tp_as_sequence*/
  0, /*tp_as_mapping*/
  0, /*tp_hash*/
  0, /*tp_call*/
  0, /*tp_str*/
  0, /*tp_getattro*/
  0, /*tp_setattro*/
  0, /*tp_as_buffer*/
  Py_TPFLAGS_DEFAULT|Py_TPFLAGS_HAVE_VERSION_TAG|Py_TPFLAGS_CHECKTYPES|Py_TPFLAGS_HAVE_NEWBUFFER|Py_TPFLAGS_HAVE_GC, /*tp_flags*/
  0, /*tp_doc*/
  __pyx_tp_traverse_3orb_6cutils___pyx_scope_struct__multi_fit_stars, /*tp_traverse*/
  __pyx_tp_clear_3orb_6cutils___pyx_scope_struct__multi_fit_stars, /*tp_clear*/
  0, /*tp_richcompare*/
  0, /*tp_weaklistoffset*/
  0, /*tp_iter*/
  0, /*tp_iternext*/
  0, /*tp_methods*/
  0, /*tp_members*/
  0, /*tp_getset*/
  0, /*tp_base*/
  0, /*tp_dict*/
  0, /*tp_descr_get*/
  0, /*tp_descr_set*/
  0, /*tp_dictoffset*/
  0, /*tp_init*/
  0, /*tp_alloc*/
  __pyx_tp_new_3orb_6cutils___pyx_scope_struct__multi_fit_stars, /*tp_new*/
  0, /*tp_free*/
  0, /*tp_is_gc*/
  0, /*tp_bases*/
  0, /*tp_mro*/
  0, /*tp_cache*/
  0, /*tp_subclasses*/
  0, /*tp_weaklist*/
  0, /*tp_del*/
  0, /*tp_version_tag*/
  #if PY_VERSION_HEX >= 0x030400a1
  0, /*tp_finalize*/
  #endif
};

static PyMethodDef __pyx_methods[] = {
  {0, 0, 0, 0}
};

#if PY_MAJOR_VERSION >= 3
static struct PyModuleDef __pyx_moduledef = {
  #if PY_VERSION_HEX < 0x03020000
    { PyObject_HEAD_INIT(NULL) NULL, 0, NULL },
  #else
    PyModuleDef_HEAD_INIT,
  #endif
    "cutils",
    __pyx_k_CUtils_is_a_set_of_C_functions, /* m_doc */
    -1, /* m_size */
    __pyx_methods /* m_methods */,
    NULL, /* m_reload */
    NULL, /* m_traverse */
    NULL, /* m_clear */
    NULL /* m_free */
};
#endif

static __Pyx_StringTabEntry __pyx_string_tab[] = {
  {&__pyx_kp_s_Array_and_weights_must_have_same, __pyx_k_Array_and_weights_must_have_same, sizeof(__pyx_k_Array_and_weights_must_have_same), 0, 0, 1, 0},
  {&__pyx_kp_s_Array_and_weights_must_have_same_2, __pyx_k_Array_and_weights_must_have_same_2, sizeof(__pyx_k_Array_and_weights_must_have_same_2), 0, 0, 1, 0},
  {&__pyx_kp_s_Bad_combining_mode_Must_be_0_or, __pyx_k_Bad_combining_mode_Must_be_0_or, sizeof(__pyx_k_Bad_combining_mode_Must_be_0_or), 0, 0, 1, 0},
  {&__pyx_kp_s_Bad_rejection_mode_Must_be_0_1_o, __pyx_k_Bad_rejection_mode_Must_be_0_1_o, sizeof(__pyx_k_Bad_rejection_mode_Must_be_0_1_o), 0, 0, 1, 0},
  {&__pyx_n_s_Exception, __pyx_k_Exception, sizeof(__pyx_k_Exception), 0, 0, 1, 1},
  {&__pyx_kp_s_Exception_raised_during_least_sq, __pyx_k_Exception_raised_during_least_sq, sizeof(__pyx_k_Exception_raised_during_least_sq), 0, 0, 1, 0},
  {&__pyx_n_s_FWHM_SKY_COEFF, __pyx_k_FWHM_SKY_COEFF, sizeof(__pyx_k_FWHM_SKY_COEFF), 0, 0, 1, 1},
  {&__pyx_kp_u_Format_string_allocated_too_shor, __pyx_k_Format_string_allocated_too_shor, sizeof(__pyx_k_Format_string_allocated_too_shor), 0, 1, 0, 0},
  {&__pyx_kp_u_Format_string_allocated_too_shor_2, __pyx_k_Format_string_allocated_too_shor_2, sizeof(__pyx_k_Format_string_allocated_too_shor_2), 0, 1, 0, 0},
  {&__pyx_n_s_M, __pyx_k_M, sizeof(__pyx_k_M), 0, 0, 1, 1},
  {&__pyx_n_s_N, __pyx_k_N, sizeof(__pyx_k_N), 0, 0, 1, 1},
  {&__pyx_kp_u_Non_native_byte_order_not_suppor, __pyx_k_Non_native_byte_order_not_suppor, sizeof(__pyx_k_Non_native_byte_order_not_suppor), 0, 1, 0, 0},
  {&__pyx_kp_s_Order_cannot_be_0_for_a_nm_axis, __pyx_k_Order_cannot_be_0_for_a_nm_axis, sizeof(__pyx_k_Order_cannot_be_0_for_a_nm_axis), 0, 0, 1, 0},
  {&__pyx_kp_s_Order_cannot_be_0_for_a_nm_axis_2, __pyx_k_Order_cannot_be_0_for_a_nm_axis_2, sizeof(__pyx_k_Order_cannot_be_0_for_a_nm_axis_2), 0, 0, 1, 0},
  {&__pyx_n_s_PARAMS_NB, __pyx_k_PARAMS_NB, sizeof(__pyx_k_PARAMS_NB), 0, 0, 1, 1},
  {&__pyx_n_s_PRECISION_COEFF, __pyx_k_PRECISION_COEFF, sizeof(__pyx_k_PRECISION_COEFF), 0, 0, 1, 1},
  {&__pyx_n_s_RuntimeError, __pyx_k_RuntimeError, sizeof(__pyx_k_RuntimeError), 0, 0, 1, 1},
  {&__pyx_n_s_S, __pyx_k_S, sizeof(__pyx_k_S), 0, 0, 1, 1},
  {&__pyx_n_s_SUB_DIV, __pyx_k_SUB_DIV, sizeof(__pyx_k_SUB_DIV), 0, 0, 1, 1},
  {&__pyx_n_s_S_sky, __pyx_k_S_sky, sizeof(__pyx_k_S_sky), 0, 0, 1, 1},
  {&__pyx_n_s_T, __pyx_k_T, sizeof(__pyx_k_T), 0, 0, 1, 1},
  {&__pyx_kp_s_There_must_be_more_than_2_frames, __pyx_k_There_must_be_more_than_2_frames, sizeof(__pyx_k_There_must_be_more_than_2_frames), 0, 0, 1, 0},
  {&__pyx_n_s_ValueError, __pyx_k_ValueError, sizeof(__pyx_k_ValueError), 0, 0, 1, 1},
  {&__pyx_n_s_X, __pyx_k_X, sizeof(__pyx_k_X), 0, 0, 1, 1},
  {&__pyx_kp_s__45, __pyx_k__45, sizeof(__pyx_k__45), 0, 0, 1, 0},
  {&__pyx_n_s_a, __pyx_k_a, sizeof(__pyx_k_a), 0, 0, 1, 1},
  {&__pyx_n_s_a_err, __pyx_k_a_err, sizeof(__pyx_k_a_err), 0, 0, 1, 1},
  {&__pyx_n_s_abs, __pyx_k_abs, sizeof(__pyx_k_abs), 0, 0, 1, 1},
  {&__pyx_n_s_added_height, __pyx_k_added_height, sizeof(__pyx_k_added_height), 0, 0, 1, 1},
  {&__pyx_n_s_all, __pyx_k_all, sizeof(__pyx_k_all), 0, 0, 1, 1},
  {&__pyx_n_s_all_pix2world, __pyx_k_all_pix2world, sizeof(__pyx_k_all_pix2world), 0, 0, 1, 1},
  {&__pyx_n_s_all_world2pix, __pyx_k_all_world2pix, sizeof(__pyx_k_all_world2pix), 0, 0, 1, 1},
  {&__pyx_n_s_alpha, __pyx_k_alpha, sizeof(__pyx_k_alpha), 0, 0, 1, 1},
  {&__pyx_n_s_amp_guess, __pyx_k_amp_guess, sizeof(__pyx_k_amp_guess), 0, 0, 1, 1},
  {&__pyx_n_s_angle, __pyx_k_angle, sizeof(__pyx_k_angle), 0, 0, 1, 1},
  {&__pyx_n_s_any, __pyx_k_any, sizeof(__pyx_k_any), 0, 0, 1, 1},
  {&__pyx_n_s_anynan, __pyx_k_anynan, sizeof(__pyx_k_anynan), 0, 0, 1, 1},
  {&__pyx_n_s_arange, __pyx_k_arange, sizeof(__pyx_k_arange), 0, 0, 1, 1},
  {&__pyx_n_s_argmax, __pyx_k_argmax, sizeof(__pyx_k_argmax), 0, 0, 1, 1},
  {&__pyx_n_s_argmax2d, __pyx_k_argmax2d, sizeof(__pyx_k_argmax2d), 0, 0, 1, 1},
  {&__pyx_n_s_args, __pyx_k_args, sizeof(__pyx_k_args), 0, 0, 1, 1},
  {&__pyx_n_s_arr, __pyx_k_arr, sizeof(__pyx_k_arr), 0, 0, 1, 1},
  {&__pyx_n_s_arr8, __pyx_k_arr8, sizeof(__pyx_k_arr8), 0, 0, 1, 1},
  {&__pyx_n_s_array, __pyx_k_array, sizeof(__pyx_k_array), 0, 0, 1, 1},
  {&__pyx_n_s_astype, __pyx_k_astype, sizeof(__pyx_k_astype), 0, 0, 1, 1},
  {&__pyx_n_s_axis, __pyx_k_axis, sizeof(__pyx_k_axis), 0, 0, 1, 1},
  {&__pyx_n_s_axis_min, __pyx_k_axis_min, sizeof(__pyx_k_axis_min), 0, 0, 1, 1},
  {&__pyx_n_s_axis_step, __pyx_k_axis_step, sizeof(__pyx_k_axis_step), 0, 0, 1, 1},
  {&__pyx_n_s_b, __pyx_k_b, sizeof(__pyx_k_b), 0, 0, 1, 1},
  {&__pyx_n_s_b_err, __pyx_k_b_err, sizeof(__pyx_k_b_err), 0, 0, 1, 1},
  {&__pyx_n_s_back, __pyx_k_back, sizeof(__pyx_k_back), 0, 0, 1, 1},
  {&__pyx_n_s_back_size, __pyx_k_back_size, sizeof(__pyx_k_back_size), 0, 0, 1, 1},
  {&__pyx_n_s_beta, __pyx_k_beta, sizeof(__pyx_k_beta), 0, 0, 1, 1},
  {&__pyx_n_s_big_box_coeff, __pyx_k_big_box_coeff, sizeof(__pyx_k_big_box_coeff), 0, 0, 1, 1},
  {&__pyx_n_s_binning, __pyx_k_binning, sizeof(__pyx_k_binning), 0, 0, 1, 1},
  {&__pyx_n_s_binx, __pyx_k_binx, sizeof(__pyx_k_binx), 0, 0, 1, 1},
  {&__pyx_n_s_biny, __pyx_k_biny, sizeof(__pyx_k_biny), 0, 0, 1, 1},
  {&__pyx_n_s_bn, __pyx_k_bn, sizeof(__pyx_k_bn), 0, 0, 1, 1},
  {&__pyx_n_s_bottleneck, __pyx_k_bottleneck, sizeof(__pyx_k_bottleneck), 0, 0, 1, 1},
  {&__pyx_n_s_box, __pyx_k_box, sizeof(__pyx_k_box), 0, 0, 1, 1},
  {&__pyx_n_s_box_s, __pyx_k_box_s, sizeof(__pyx_k_box_s), 0, 0, 1, 1},
  {&__pyx_n_s_box_size, __pyx_k_box_size, sizeof(__pyx_k_box_size), 0, 0, 1, 1},
  {&__pyx_n_s_boxmed, __pyx_k_boxmed, sizeof(__pyx_k_boxmed), 0, 0, 1, 1},
  {&__pyx_n_s_boxstd, __pyx_k_boxstd, sizeof(__pyx_k_boxstd), 0, 0, 1, 1},
  {&__pyx_n_s_brute_photometry, __pyx_k_brute_photometry, sizeof(__pyx_k_brute_photometry), 0, 0, 1, 1},
  {&__pyx_n_s_byteorder, __pyx_k_byteorder, sizeof(__pyx_k_byteorder), 0, 0, 1, 1},
  {&__pyx_n_s_bytes, __pyx_k_bytes, sizeof(__pyx_k_bytes), 0, 0, 1, 1},
  {&__pyx_n_s_c, __pyx_k_c, sizeof(__pyx_k_c), 0, 0, 1, 1},
  {&__pyx_n_s_c_err, __pyx_k_c_err, sizeof(__pyx_k_c_err), 0, 0, 1, 1},
  {&__pyx_n_s_central_value, __pyx_k_central_value, sizeof(__pyx_k_central_value), 0, 0, 1, 1},
  {&__pyx_n_s_central_x, __pyx_k_central_x, sizeof(__pyx_k_central_x), 0, 0, 1, 1},
  {&__pyx_n_s_check_cosmic_rays_neighbourhood, __pyx_k_check_cosmic_rays_neighbourhood, sizeof(__pyx_k_check_cosmic_rays_neighbourhood), 0, 0, 1, 1},
  {&__pyx_kp_s_chi_square, __pyx_k_chi_square, sizeof(__pyx_k_chi_square), 0, 0, 1, 0},
  {&__pyx_n_s_chisq, __pyx_k_chisq, sizeof(__pyx_k_chisq), 0, 0, 1, 1},
  {&__pyx_n_s_cleaned_distrib, __pyx_k_cleaned_distrib, sizeof(__pyx_k_cleaned_distrib), 0, 0, 1, 1},
  {&__pyx_n_s_cm1_max, __pyx_k_cm1_max, sizeof(__pyx_k_cm1_max), 0, 0, 1, 1},
  {&__pyx_n_s_cm1_min, __pyx_k_cm1_min, sizeof(__pyx_k_cm1_min), 0, 0, 1, 1},
  {&__pyx_n_s_coaxis, __pyx_k_coaxis, sizeof(__pyx_k_coaxis), 0, 0, 1, 1},
  {&__pyx_n_s_coeff, __pyx_k_coeff, sizeof(__pyx_k_coeff), 0, 0, 1, 1},
  {&__pyx_n_s_color_mapper, __pyx_k_color_mapper, sizeof(__pyx_k_color_mapper), 0, 0, 1, 1},
  {&__pyx_n_s_color_values, __pyx_k_color_values, sizeof(__pyx_k_color_values), 0, 0, 1, 1},
  {&__pyx_n_s_combine_mode, __pyx_k_combine_mode, sizeof(__pyx_k_combine_mode), 0, 0, 1, 1},
  {&__pyx_n_s_complexflag, __pyx_k_complexflag, sizeof(__pyx_k_complexflag), 0, 0, 1, 1},
  {&__pyx_n_s_complexflagw, __pyx_k_complexflagw, sizeof(__pyx_k_complexflagw), 0, 0, 1, 1},
  {&__pyx_n_s_complexflagx, __pyx_k_complexflagx, sizeof(__pyx_k_complexflagx), 0, 0, 1, 1},
  {&__pyx_n_s_complexresult, __pyx_k_complexresult, sizeof(__pyx_k_complexresult), 0, 0, 1, 1},
  {&__pyx_n_s_computed_pixels, __pyx_k_computed_pixels, sizeof(__pyx_k_computed_pixels), 0, 0, 1, 1},
  {&__pyx_n_s_concatenate, __pyx_k_concatenate, sizeof(__pyx_k_concatenate), 0, 0, 1, 1},
  {&__pyx_n_s_constants, __pyx_k_constants, sizeof(__pyx_k_constants), 0, 0, 1, 1},
  {&__pyx_n_s_convolve, __pyx_k_convolve, sizeof(__pyx_k_convolve), 0, 0, 1, 1},
  {&__pyx_n_s_coords, __pyx_k_coords, sizeof(__pyx_k_coords), 0, 0, 1, 1},
  {&__pyx_n_s_copy, __pyx_k_copy, sizeof(__pyx_k_copy), 0, 0, 1, 1},
  {&__pyx_n_s_corr, __pyx_k_corr, sizeof(__pyx_k_corr), 0, 0, 1, 1},
  {&__pyx_n_s_cov_angle, __pyx_k_cov_angle, sizeof(__pyx_k_cov_angle), 0, 0, 1, 1},
  {&__pyx_n_s_cov_diag, __pyx_k_cov_diag, sizeof(__pyx_k_cov_diag), 0, 0, 1, 1},
  {&__pyx_n_s_cov_dx, __pyx_k_cov_dx, sizeof(__pyx_k_cov_dx), 0, 0, 1, 1},
  {&__pyx_n_s_cov_dy, __pyx_k_cov_dy, sizeof(__pyx_k_cov_dy), 0, 0, 1, 1},
  {&__pyx_n_s_cov_err, __pyx_k_cov_err, sizeof(__pyx_k_cov_err), 0, 0, 1, 1},
  {&__pyx_n_s_cov_free_p_nb, __pyx_k_cov_free_p_nb, sizeof(__pyx_k_cov_free_p_nb), 0, 0, 1, 1},
  {&__pyx_n_s_cov_fwhm, __pyx_k_cov_fwhm, sizeof(__pyx_k_cov_fwhm), 0, 0, 1, 1},
  {&__pyx_n_s_cov_height, __pyx_k_cov_height, sizeof(__pyx_k_cov_height), 0, 0, 1, 1},
  {&__pyx_n_s_cov_matrix, __pyx_k_cov_matrix, sizeof(__pyx_k_cov_matrix), 0, 0, 1, 1},
  {&__pyx_n_s_cov_p, __pyx_k_cov_p, sizeof(__pyx_k_cov_p), 0, 0, 1, 1},
  {&__pyx_n_s_cov_p_mask, __pyx_k_cov_p_mask, sizeof(__pyx_k_cov_p_mask), 0, 0, 1, 1},
  {&__pyx_n_s_cov_pos, __pyx_k_cov_pos, sizeof(__pyx_k_cov_pos), 0, 0, 1, 1},
  {&__pyx_n_s_cov_zx, __pyx_k_cov_zx, sizeof(__pyx_k_cov_zx), 0, 0, 1, 1},
  {&__pyx_n_s_cov_zy, __pyx_k_cov_zy, sizeof(__pyx_k_cov_zy), 0, 0, 1, 1},
  {&__pyx_n_s_cr_list_len, __pyx_k_cr_list_len, sizeof(__pyx_k_cr_list_len), 0, 0, 1, 1},
  {&__pyx_n_s_cr_map, __pyx_k_cr_map, sizeof(__pyx_k_cr_map), 0, 0, 1, 1},
  {&__pyx_n_s_create_transform_maps, __pyx_k_create_transform_maps, sizeof(__pyx_k_create_transform_maps), 0, 0, 1, 1},
  {&__pyx_n_s_crs_list, __pyx_k_crs_list, sizeof(__pyx_k_crs_list), 0, 0, 1, 1},
  {&__pyx_n_s_cutoff, __pyx_k_cutoff, sizeof(__pyx_k_cutoff), 0, 0, 1, 1},
  {&__pyx_kp_s_cutoff_must_be_between_0_and_1, __pyx_k_cutoff_must_be_between_0_and_1, sizeof(__pyx_k_cutoff_must_be_between_0_and_1), 0, 0, 1, 0},
  {&__pyx_n_s_d, __pyx_k_d, sizeof(__pyx_k_d), 0, 0, 1, 1},
  {&__pyx_n_s_d_err, __pyx_k_d_err, sizeof(__pyx_k_d_err), 0, 0, 1, 1},
  {&__pyx_n_s_da, __pyx_k_da, sizeof(__pyx_k_da), 0, 0, 1, 1},
  {&__pyx_n_s_data, __pyx_k_data, sizeof(__pyx_k_data), 0, 0, 1, 1},
  {&__pyx_n_s_db, __pyx_k_db, sizeof(__pyx_k_db), 0, 0, 1, 1},
  {&__pyx_n_s_dcl, __pyx_k_dcl, sizeof(__pyx_k_dcl), 0, 0, 1, 1},
  {&__pyx_n_s_ddeg, __pyx_k_ddeg, sizeof(__pyx_k_ddeg), 0, 0, 1, 1},
  {&__pyx_n_s_deg, __pyx_k_deg, sizeof(__pyx_k_deg), 0, 0, 1, 1},
  {&__pyx_kp_s_deg_must_be_0, __pyx_k_deg_must_be_0, sizeof(__pyx_k_deg_must_be_0), 0, 0, 1, 0},
  {&__pyx_n_s_detect_coeff, __pyx_k_detect_coeff, sizeof(__pyx_k_detect_coeff), 0, 0, 1, 1},
  {&__pyx_n_s_detect_cosmic_rays, __pyx_k_detect_cosmic_rays, sizeof(__pyx_k_detect_cosmic_rays), 0, 0, 1, 1},
  {&__pyx_n_s_dft, __pyx_k_dft, sizeof(__pyx_k_dft), 0, 0, 1, 1},
  {&__pyx_n_s_diff, __pyx_k_diff, sizeof(__pyx_k_diff), 0, 0, 1, 1},
  {&__pyx_n_s_dimx, __pyx_k_dimx, sizeof(__pyx_k_dimx), 0, 0, 1, 1},
  {&__pyx_n_s_dimy, __pyx_k_dimy, sizeof(__pyx_k_dimy), 0, 0, 1, 1},
  {&__pyx_n_s_dimz, __pyx_k_dimz, sizeof(__pyx_k_dimz), 0, 0, 1, 1},
  {&__pyx_n_s_distrib, __pyx_k_distrib, sizeof(__pyx_k_distrib), 0, 0, 1, 1},
  {&__pyx_n_s_dr, __pyx_k_dr, sizeof(__pyx_k_dr), 0, 0, 1, 1},
  {&__pyx_n_s_dr_err, __pyx_k_dr_err, sizeof(__pyx_k_dr_err), 0, 0, 1, 1},
  {&__pyx_n_s_dsub_div, __pyx_k_dsub_div, sizeof(__pyx_k_dsub_div), 0, 0, 1, 1},
  {&__pyx_n_s_dtype, __pyx_k_dtype, sizeof(__pyx_k_dtype), 0, 0, 1, 1},
  {&__pyx_n_s_dx, __pyx_k_dx, sizeof(__pyx_k_dx), 0, 0, 1, 1},
  {&__pyx_n_s_dx_err, __pyx_k_dx_err, sizeof(__pyx_k_dx_err), 0, 0, 1, 1},
  {&__pyx_n_s_dx_guess, __pyx_k_dx_guess, sizeof(__pyx_k_dx_guess), 0, 0, 1, 1},
  {&__pyx_n_s_dx_guess_arg, __pyx_k_dx_guess_arg, sizeof(__pyx_k_dx_guess_arg), 0, 0, 1, 1},
  {&__pyx_n_s_dy, __pyx_k_dy, sizeof(__pyx_k_dy), 0, 0, 1, 1},
  {&__pyx_n_s_dy_err, __pyx_k_dy_err, sizeof(__pyx_k_dy_err), 0, 0, 1, 1},
  {&__pyx_n_s_dy_guess, __pyx_k_dy_guess, sizeof(__pyx_k_dy_guess), 0, 0, 1, 1},
  {&__pyx_n_s_dy_guess_arg, __pyx_k_dy_guess_arg, sizeof(__pyx_k_dy_guess_arg), 0, 0, 1, 1},
  {&__pyx_n_s_e, __pyx_k_e, sizeof(__pyx_k_e), 0, 0, 1, 1},
  {&__pyx_n_s_empty, __pyx_k_empty, sizeof(__pyx_k_empty), 0, 0, 1, 1},
  {&__pyx_n_s_empty_like, __pyx_k_empty_like, sizeof(__pyx_k_empty_like), 0, 0, 1, 1},
  {&__pyx_n_s_enable_rotation, __pyx_k_enable_rotation, sizeof(__pyx_k_enable_rotation), 0, 0, 1, 1},
  {&__pyx_n_s_enable_zoom, __pyx_k_enable_zoom, sizeof(__pyx_k_enable_zoom), 0, 0, 1, 1},
  {&__pyx_n_s_end, __pyx_k_end, sizeof(__pyx_k_end), 0, 0, 1, 1},
  {&__pyx_n_s_energy_sum, __pyx_k_energy_sum, sizeof(__pyx_k_energy_sum), 0, 0, 1, 1},
  {&__pyx_n_s_estimate_local_noise, __pyx_k_estimate_local_noise, sizeof(__pyx_k_estimate_local_noise), 0, 0, 1, 1},
  {&__pyx_n_s_exp, __pyx_k_exp, sizeof(__pyx_k_exp), 0, 0, 1, 1},
  {&__pyx_n_s_f, __pyx_k_f, sizeof(__pyx_k_f), 0, 0, 1, 1},
  {&__pyx_n_s_fast_gaussian_kernel, __pyx_k_fast_gaussian_kernel, sizeof(__pyx_k_fast_gaussian_kernel), 0, 0, 1, 1},
  {&__pyx_n_s_fast_pix2w, __pyx_k_fast_pix2w, sizeof(__pyx_k_fast_pix2w), 0, 0, 1, 1},
  {&__pyx_n_s_fast_w2pix, __pyx_k_fast_w2pix, sizeof(__pyx_k_fast_w2pix), 0, 0, 1, 1},
  {&__pyx_n_s_fft, __pyx_k_fft, sizeof(__pyx_k_fft), 0, 0, 1, 1},
  {&__pyx_n_s_fft_filter, __pyx_k_fft_filter, sizeof(__pyx_k_fft_filter), 0, 0, 1, 1},
  {&__pyx_n_s_file, __pyx_k_file, sizeof(__pyx_k_file), 0, 0, 1, 1},
  {&__pyx_n_s_fill, __pyx_k_fill, sizeof(__pyx_k_fill), 0, 0, 1, 1},
  {&__pyx_n_s_filter_background, __pyx_k_filter_background, sizeof(__pyx_k_filter_background), 0, 0, 1, 1},
  {&__pyx_n_s_filters, __pyx_k_filters, sizeof(__pyx_k_filters), 0, 0, 1, 1},
  {&__pyx_n_s_fimag, __pyx_k_fimag, sizeof(__pyx_k_fimag), 0, 0, 1, 1},
  {&__pyx_n_s_final_im, __pyx_k_final_im, sizeof(__pyx_k_final_im), 0, 0, 1, 1},
  {&__pyx_n_s_fit, __pyx_k_fit, sizeof(__pyx_k_fit), 0, 0, 1, 1},
  {&__pyx_n_s_fit_tol, __pyx_k_fit_tol, sizeof(__pyx_k_fit_tol), 0, 0, 1, 1},
  {&__pyx_n_s_fix_fwhm, __pyx_k_fix_fwhm, sizeof(__pyx_k_fix_fwhm), 0, 0, 1, 1},
  {&__pyx_n_s_fix_height, __pyx_k_fix_height, sizeof(__pyx_k_fix_height), 0, 0, 1, 1},
  {&__pyx_n_s_fix_pos, __pyx_k_fix_pos, sizeof(__pyx_k_fix_pos), 0, 0, 1, 1},
  {&__pyx_n_s_fixed_p, __pyx_k_fixed_p, sizeof(__pyx_k_fixed_p), 0, 0, 1, 1},
  {&__pyx_n_s_flag, __pyx_k_flag, sizeof(__pyx_k_flag), 0, 0, 1, 1},
  {&__pyx_n_s_flagw, __pyx_k_flagw, sizeof(__pyx_k_flagw), 0, 0, 1, 1},
  {&__pyx_n_s_flagx, __pyx_k_flagx, sizeof(__pyx_k_flagx), 0, 0, 1, 1},
  {&__pyx_n_s_flatten, __pyx_k_flatten, sizeof(__pyx_k_flatten), 0, 0, 1, 1},
  {&__pyx_n_s_float64, __pyx_k_float64, sizeof(__pyx_k_float64), 0, 0, 1, 1},
  {&__pyx_n_s_fn, __pyx_k_fn, sizeof(__pyx_k_fn), 0, 0, 1, 1},
  {&__pyx_n_s_frame, __pyx_k_frame, sizeof(__pyx_k_frame), 0, 0, 1, 1},
  {&__pyx_n_s_frame_mask, __pyx_k_frame_mask, sizeof(__pyx_k_frame_mask), 0, 0, 1, 1},
  {&__pyx_n_s_frame_min, __pyx_k_frame_min, sizeof(__pyx_k_frame_min), 0, 0, 1, 1},
  {&__pyx_n_s_frames, __pyx_k_frames, sizeof(__pyx_k_frames), 0, 0, 1, 1},
  {&__pyx_n_s_framesdiff, __pyx_k_framesdiff, sizeof(__pyx_k_framesdiff), 0, 0, 1, 1},
  {&__pyx_n_s_freal, __pyx_k_freal, sizeof(__pyx_k_freal), 0, 0, 1, 1},
  {&__pyx_n_s_free_p, __pyx_k_free_p, sizeof(__pyx_k_free_p), 0, 0, 1, 1},
  {&__pyx_n_s_full_output, __pyx_k_full_output, sizeof(__pyx_k_full_output), 0, 0, 1, 1},
  {&__pyx_n_s_fvec, __pyx_k_fvec, sizeof(__pyx_k_fvec), 0, 0, 1, 1},
  {&__pyx_n_s_fwhm, __pyx_k_fwhm, sizeof(__pyx_k_fwhm), 0, 0, 1, 1},
  {&__pyx_n_s_fwhm_guess, __pyx_k_fwhm_guess, sizeof(__pyx_k_fwhm_guess), 0, 0, 1, 1},
  {&__pyx_n_s_fwhm_pix, __pyx_k_fwhm_pix, sizeof(__pyx_k_fwhm_pix), 0, 0, 1, 1},
  {&__pyx_n_s_gaussian1d, __pyx_k_gaussian1d, sizeof(__pyx_k_gaussian1d), 0, 0, 1, 1},
  {&__pyx_n_s_gaussian_array2d, __pyx_k_gaussian_array2d, sizeof(__pyx_k_gaussian_array2d), 0, 0, 1, 1},
  {&__pyx_n_s_gaussian_kernel, __pyx_k_gaussian_kernel, sizeof(__pyx_k_gaussian_kernel), 0, 0, 1, 1},
  {&__pyx_n_s_get_box_coords, __pyx_k_get_box_coords, sizeof(__pyx_k_get_box_coords), 0, 0, 1, 1},
  {&__pyx_n_s_get_cm1_axis_max, __pyx_k_get_cm1_axis_max, sizeof(__pyx_k_get_cm1_axis_max), 0, 0, 1, 1},
  {&__pyx_n_s_get_cm1_axis_min, __pyx_k_get_cm1_axis_min, sizeof(__pyx_k_get_cm1_axis_min), 0, 0, 1, 1},
  {&__pyx_n_s_get_cm1_axis_step, __pyx_k_get_cm1_axis_step, sizeof(__pyx_k_get_cm1_axis_step), 0, 0, 1, 1},
  {&__pyx_n_s_get_nm_axis_max, __pyx_k_get_nm_axis_max, sizeof(__pyx_k_get_nm_axis_max), 0, 0, 1, 1},
  {&__pyx_n_s_get_nm_axis_min, __pyx_k_get_nm_axis_min, sizeof(__pyx_k_get_nm_axis_min), 0, 0, 1, 1},
  {&__pyx_n_s_get_nm_axis_step, __pyx_k_get_nm_axis_step, sizeof(__pyx_k_get_nm_axis_step), 0, 0, 1, 1},
  {&__pyx_n_s_gradient, __pyx_k_gradient, sizeof(__pyx_k_gradient), 0, 0, 1, 1},
  {&__pyx_n_s_h, __pyx_k_h, sizeof(__pyx_k_h), 0, 0, 1, 1},
  {&__pyx_n_s_height_guess, __pyx_k_height_guess, sizeof(__pyx_k_height_guess), 0, 0, 1, 1},
  {&__pyx_n_s_hstack, __pyx_k_hstack, sizeof(__pyx_k_hstack), 0, 0, 1, 1},
  {&__pyx_n_s_hsz, __pyx_k_hsz, sizeof(__pyx_k_hsz), 0, 0, 1, 1},
  {&__pyx_n_s_hwindow, __pyx_k_hwindow, sizeof(__pyx_k_hwindow), 0, 0, 1, 1},
  {&__pyx_n_s_i, __pyx_k_i, sizeof(__pyx_k_i), 0, 0, 1, 1},
  {&__pyx_n_s_icol, __pyx_k_icol, sizeof(__pyx_k_icol), 0, 0, 1, 1},
  {&__pyx_n_s_icr, __pyx_k_icr, sizeof(__pyx_k_icr), 0, 0, 1, 1},
  {&__pyx_n_s_icut, __pyx_k_icut, sizeof(__pyx_k_icut), 0, 0, 1, 1},
  {&__pyx_n_s_ideg, __pyx_k_ideg, sizeof(__pyx_k_ideg), 0, 0, 1, 1},
  {&__pyx_n_s_ifft, __pyx_k_ifft, sizeof(__pyx_k_ifft), 0, 0, 1, 1},
  {&__pyx_n_s_ii, __pyx_k_ii, sizeof(__pyx_k_ii), 0, 0, 1, 1},
  {&__pyx_n_s_ij, __pyx_k_ij, sizeof(__pyx_k_ij), 0, 0, 1, 1},
  {&__pyx_n_s_ik, __pyx_k_ik, sizeof(__pyx_k_ik), 0, 0, 1, 1},
  {&__pyx_n_s_iline, __pyx_k_iline, sizeof(__pyx_k_iline), 0, 0, 1, 1},
  {&__pyx_n_s_im, __pyx_k_im, sizeof(__pyx_k_im), 0, 0, 1, 1},
  {&__pyx_n_s_im2rgba, __pyx_k_im2rgba, sizeof(__pyx_k_im2rgba), 0, 0, 1, 1},
  {&__pyx_n_s_im_coords, __pyx_k_im_coords, sizeof(__pyx_k_im_coords), 0, 0, 1, 1},
  {&__pyx_n_s_imag, __pyx_k_imag, sizeof(__pyx_k_imag), 0, 0, 1, 1},
  {&__pyx_n_s_imax, __pyx_k_imax, sizeof(__pyx_k_imax), 0, 0, 1, 1},
  {&__pyx_n_s_imin, __pyx_k_imin, sizeof(__pyx_k_imin), 0, 0, 1, 1},
  {&__pyx_n_s_import, __pyx_k_import, sizeof(__pyx_k_import), 0, 0, 1, 1},
  {&__pyx_n_s_inan, __pyx_k_inan, sizeof(__pyx_k_inan), 0, 0, 1, 1},
  {&__pyx_n_s_index, __pyx_k_index, sizeof(__pyx_k_index), 0, 0, 1, 1},
  {&__pyx_n_s_index_list, __pyx_k_index_list, sizeof(__pyx_k_index_list), 0, 0, 1, 1},
  {&__pyx_n_s_indft, __pyx_k_indft, sizeof(__pyx_k_indft), 0, 0, 1, 1},
  {&__pyx_n_s_inewcr, __pyx_k_inewcr, sizeof(__pyx_k_inewcr), 0, 0, 1, 1},
  {&__pyx_n_s_inside, __pyx_k_inside, sizeof(__pyx_k_inside), 0, 0, 1, 1},
  {&__pyx_n_s_int64, __pyx_k_int64, sizeof(__pyx_k_int64), 0, 0, 1, 1},
  {&__pyx_n_s_int8, __pyx_k_int8, sizeof(__pyx_k_int8), 0, 0, 1, 1},
  {&__pyx_n_s_int_posx, __pyx_k_int_posx, sizeof(__pyx_k_int_posx), 0, 0, 1, 1},
  {&__pyx_n_s_int_posy, __pyx_k_int_posy, sizeof(__pyx_k_int_posy), 0, 0, 1, 1},
  {&__pyx_n_s_interf, __pyx_k_interf, sizeof(__pyx_k_interf), 0, 0, 1, 1},
  {&__pyx_n_s_interf_mean_energy, __pyx_k_interf_mean_energy, sizeof(__pyx_k_interf_mean_energy), 0, 0, 1, 1},
  {&__pyx_n_s_ip, __pyx_k_ip, sizeof(__pyx_k_ip), 0, 0, 1, 1},
  {&__pyx_n_s_ir, __pyx_k_ir, sizeof(__pyx_k_ir), 0, 0, 1, 1},
  {&__pyx_n_s_iscomplexobj, __pyx_k_iscomplexobj, sizeof(__pyx_k_iscomplexobj), 0, 0, 1, 1},
  {&__pyx_n_s_isinf, __pyx_k_isinf, sizeof(__pyx_k_isinf), 0, 0, 1, 1},
  {&__pyx_n_s_isnan, __pyx_k_isnan, sizeof(__pyx_k_isnan), 0, 0, 1, 1},
  {&__pyx_n_s_istar, __pyx_k_istar, sizeof(__pyx_k_istar), 0, 0, 1, 1},
  {&__pyx_n_s_isub, __pyx_k_isub, sizeof(__pyx_k_isub), 0, 0, 1, 1},
  {&__pyx_n_s_ix, __pyx_k_ix, sizeof(__pyx_k_ix), 0, 0, 1, 1},
  {&__pyx_n_s_iy, __pyx_k_iy, sizeof(__pyx_k_iy), 0, 0, 1, 1},
  {&__pyx_n_s_j, __pyx_k_j, sizeof(__pyx_k_j), 0, 0, 1, 1},
  {&__pyx_n_s_jsub, __pyx_k_jsub, sizeof(__pyx_k_jsub), 0, 0, 1, 1},
  {&__pyx_n_s_k, __pyx_k_k, sizeof(__pyx_k_k), 0, 0, 1, 1},
  {&__pyx_n_s_kernel, __pyx_k_kernel, sizeof(__pyx_k_kernel), 0, 0, 1, 1},
  {&__pyx_n_s_kernel_mod, __pyx_k_kernel_mod, sizeof(__pyx_k_kernel_mod), 0, 0, 1, 1},
  {&__pyx_n_s_large_kernel, __pyx_k_large_kernel, sizeof(__pyx_k_large_kernel), 0, 0, 1, 1},
  {&__pyx_n_s_large_sz, __pyx_k_large_sz, sizeof(__pyx_k_large_sz), 0, 0, 1, 1},
  {&__pyx_n_s_last_arr8, __pyx_k_last_arr8, sizeof(__pyx_k_last_arr8), 0, 0, 1, 1},
  {&__pyx_n_s_last_diff, __pyx_k_last_diff, sizeof(__pyx_k_last_diff), 0, 0, 1, 1},
  {&__pyx_n_s_leastsq, __pyx_k_leastsq, sizeof(__pyx_k_leastsq), 0, 0, 1, 1},
  {&__pyx_n_s_line, __pyx_k_line, sizeof(__pyx_k_line), 0, 0, 1, 1},
  {&__pyx_n_s_linspace, __pyx_k_linspace, sizeof(__pyx_k_linspace), 0, 0, 1, 1},
  {&__pyx_n_s_logical_and, __pyx_k_logical_and, sizeof(__pyx_k_logical_and), 0, 0, 1, 1},
  {&__pyx_n_s_low_pass_image_filter, __pyx_k_low_pass_image_filter, sizeof(__pyx_k_low_pass_image_filter), 0, 0, 1, 1},
  {&__pyx_n_s_lowpass, __pyx_k_lowpass, sizeof(__pyx_k_lowpass), 0, 0, 1, 1},
  {&__pyx_n_s_m, __pyx_k_m, sizeof(__pyx_k_m), 0, 0, 1, 1},
  {&__pyx_n_s_main, __pyx_k_main, sizeof(__pyx_k_main), 0, 0, 1, 1},
  {&__pyx_n_s_map_me, __pyx_k_map_me, sizeof(__pyx_k_map_me), 0, 0, 1, 1},
  {&__pyx_n_s_mask2d, __pyx_k_mask2d, sizeof(__pyx_k_mask2d), 0, 0, 1, 1},
  {&__pyx_n_s_master_combine, __pyx_k_master_combine, sizeof(__pyx_k_master_combine), 0, 0, 1, 1},
  {&__pyx_n_s_max, __pyx_k_max, sizeof(__pyx_k_max), 0, 0, 1, 1},
  {&__pyx_n_s_max2d, __pyx_k_max2d, sizeof(__pyx_k_max2d), 0, 0, 1, 1},
  {&__pyx_n_s_max_mask, __pyx_k_max_mask, sizeof(__pyx_k_max_mask), 0, 0, 1, 1},
  {&__pyx_n_s_maxfev, __pyx_k_maxfev, sizeof(__pyx_k_maxfev), 0, 0, 1, 1},
  {&__pyx_n_s_maxs, __pyx_k_maxs, sizeof(__pyx_k_maxs), 0, 0, 1, 1},
  {&__pyx_n_s_maxx, __pyx_k_maxx, sizeof(__pyx_k_maxx), 0, 0, 1, 1},
  {&__pyx_n_s_me, __pyx_k_me, sizeof(__pyx_k_me), 0, 0, 1, 1},
  {&__pyx_n_s_mean2d, __pyx_k_mean2d, sizeof(__pyx_k_mean2d), 0, 0, 1, 1},
  {&__pyx_n_s_mean_box, __pyx_k_mean_box, sizeof(__pyx_k_mean_box), 0, 0, 1, 1},
  {&__pyx_n_s_meansigcut2d, __pyx_k_meansigcut2d, sizeof(__pyx_k_meansigcut2d), 0, 0, 1, 1},
  {&__pyx_n_s_med, __pyx_k_med, sizeof(__pyx_k_med), 0, 0, 1, 1},
  {&__pyx_n_s_median, __pyx_k_median, sizeof(__pyx_k_median), 0, 0, 1, 1},
  {&__pyx_n_s_median2d, __pyx_k_median2d, sizeof(__pyx_k_median2d), 0, 0, 1, 1},
  {&__pyx_n_s_median_a, __pyx_k_median_a, sizeof(__pyx_k_median_a), 0, 0, 1, 1},
  {&__pyx_n_s_median_back, __pyx_k_median_back, sizeof(__pyx_k_median_back), 0, 0, 1, 1},
  {&__pyx_n_s_mgrid, __pyx_k_mgrid, sizeof(__pyx_k_mgrid), 0, 0, 1, 1},
  {&__pyx_n_s_min, __pyx_k_min, sizeof(__pyx_k_min), 0, 0, 1, 1},
  {&__pyx_n_s_min_mask, __pyx_k_min_mask, sizeof(__pyx_k_min_mask), 0, 0, 1, 1},
  {&__pyx_n_s_min_values, __pyx_k_min_values, sizeof(__pyx_k_min_values), 0, 0, 1, 1},
  {&__pyx_n_s_minx, __pyx_k_minx, sizeof(__pyx_k_minx), 0, 0, 1, 1},
  {&__pyx_n_s_mode, __pyx_k_mode, sizeof(__pyx_k_mode), 0, 0, 1, 1},
  {&__pyx_n_s_model_diff, __pyx_k_model_diff, sizeof(__pyx_k_model_diff), 0, 0, 1, 1},
  {&__pyx_n_s_moffat_array2d, __pyx_k_moffat_array2d, sizeof(__pyx_k_moffat_array2d), 0, 0, 1, 1},
  {&__pyx_n_s_mpl_colorbar, __pyx_k_mpl_colorbar, sizeof(__pyx_k_mpl_colorbar), 0, 0, 1, 1},
  {&__pyx_n_s_multi_fit_stars, __pyx_k_multi_fit_stars, sizeof(__pyx_k_multi_fit_stars), 0, 0, 1, 1},
  {&__pyx_n_s_multi_fit_stars_locals_diff, __pyx_k_multi_fit_stars_locals_diff, sizeof(__pyx_k_multi_fit_stars_locals_diff), 0, 0, 1, 1},
  {&__pyx_n_s_multi_fit_stars_locals_model_dif, __pyx_k_multi_fit_stars_locals_model_dif, sizeof(__pyx_k_multi_fit_stars_locals_model_dif), 0, 0, 1, 1},
  {&__pyx_n_s_multi_fit_stars_locals_params_ar, __pyx_k_multi_fit_stars_locals_params_ar, sizeof(__pyx_k_multi_fit_stars_locals_params_ar), 0, 0, 1, 1},
  {&__pyx_n_s_multi_fit_stars_locals_params_ve, __pyx_k_multi_fit_stars_locals_params_ve, sizeof(__pyx_k_multi_fit_stars_locals_params_ve), 0, 0, 1, 1},
  {&__pyx_n_s_multi_fit_stars_locals_sigma, __pyx_k_multi_fit_stars_locals_sigma, sizeof(__pyx_k_multi_fit_stars_locals_sigma), 0, 0, 1, 1},
  {&__pyx_n_s_n, __pyx_k_n, sizeof(__pyx_k_n), 0, 0, 1, 1},
  {&__pyx_n_s_nan, __pyx_k_nan, sizeof(__pyx_k_nan), 0, 0, 1, 1},
  {&__pyx_n_s_nanargmax, __pyx_k_nanargmax, sizeof(__pyx_k_nanargmax), 0, 0, 1, 1},
  {&__pyx_n_s_nanbin_image, __pyx_k_nanbin_image, sizeof(__pyx_k_nanbin_image), 0, 0, 1, 1},
  {&__pyx_n_s_nanmax, __pyx_k_nanmax, sizeof(__pyx_k_nanmax), 0, 0, 1, 1},
  {&__pyx_n_s_nanmean, __pyx_k_nanmean, sizeof(__pyx_k_nanmean), 0, 0, 1, 1},
  {&__pyx_n_s_nanmedian, __pyx_k_nanmedian, sizeof(__pyx_k_nanmedian), 0, 0, 1, 1},
  {&__pyx_n_s_nanmin, __pyx_k_nanmin, sizeof(__pyx_k_nanmin), 0, 0, 1, 1},
  {&__pyx_n_s_nans, __pyx_k_nans, sizeof(__pyx_k_nans), 0, 0, 1, 1},
  {&__pyx_n_s_nanstd, __pyx_k_nanstd, sizeof(__pyx_k_nanstd), 0, 0, 1, 1},
  {&__pyx_n_s_nansum, __pyx_k_nansum, sizeof(__pyx_k_nansum), 0, 0, 1, 1},
  {&__pyx_n_s_nb, __pyx_k_nb, sizeof(__pyx_k_nb), 0, 0, 1, 1},
  {&__pyx_kp_u_ndarray_is_not_C_contiguous, __pyx_k_ndarray_is_not_C_contiguous, sizeof(__pyx_k_ndarray_is_not_C_contiguous), 0, 1, 0, 0},
  {&__pyx_kp_u_ndarray_is_not_Fortran_contiguou, __pyx_k_ndarray_is_not_Fortran_contiguou, sizeof(__pyx_k_ndarray_is_not_Fortran_contiguou), 0, 1, 0, 0},
  {&__pyx_n_s_ndimage, __pyx_k_ndimage, sizeof(__pyx_k_ndimage), 0, 0, 1, 1},
  {&__pyx_n_s_nearest, __pyx_k_nearest, sizeof(__pyx_k_nearest), 0, 0, 1, 1},
  {&__pyx_n_s_new_nans, __pyx_k_new_nans, sizeof(__pyx_k_new_nans), 0, 0, 1, 1},
  {&__pyx_n_s_new_pos, __pyx_k_new_pos, sizeof(__pyx_k_new_pos), 0, 0, 1, 1},
  {&__pyx_n_s_new_rejects2d, __pyx_k_new_rejects2d, sizeof(__pyx_k_new_rejects2d), 0, 0, 1, 1},
  {&__pyx_n_s_new_stars_err, __pyx_k_new_stars_err, sizeof(__pyx_k_new_stars_err), 0, 0, 1, 1},
  {&__pyx_n_s_new_stars_p, __pyx_k_new_stars_p, sizeof(__pyx_k_new_stars_p), 0, 0, 1, 1},
  {&__pyx_n_s_new_sz, __pyx_k_new_sz, sizeof(__pyx_k_new_sz), 0, 0, 1, 1},
  {&__pyx_n_s_new_x, __pyx_k_new_x, sizeof(__pyx_k_new_x), 0, 0, 1, 1},
  {&__pyx_n_s_newbyteorder, __pyx_k_newbyteorder, sizeof(__pyx_k_newbyteorder), 0, 0, 1, 1},
  {&__pyx_n_s_nkeep, __pyx_k_nkeep, sizeof(__pyx_k_nkeep), 0, 0, 1, 1},
  {&__pyx_n_s_noise, __pyx_k_noise, sizeof(__pyx_k_noise), 0, 0, 1, 1},
  {&__pyx_n_s_noise_guess, __pyx_k_noise_guess, sizeof(__pyx_k_noise_guess), 0, 0, 1, 1},
  {&__pyx_n_s_nonzero, __pyx_k_nonzero, sizeof(__pyx_k_nonzero), 0, 0, 1, 1},
  {&__pyx_n_s_normalize, __pyx_k_normalize, sizeof(__pyx_k_normalize), 0, 0, 1, 1},
  {&__pyx_n_s_np, __pyx_k_np, sizeof(__pyx_k_np), 0, 0, 1, 1},
  {&__pyx_n_s_numpy, __pyx_k_numpy, sizeof(__pyx_k_numpy), 0, 0, 1, 1},
  {&__pyx_n_s_nx, __pyx_k_nx, sizeof(__pyx_k_nx), 0, 0, 1, 1},
  {&__pyx_n_s_ny, __pyx_k_ny, sizeof(__pyx_k_ny), 0, 0, 1, 1},
  {&__pyx_n_s_nzi, __pyx_k_nzi, sizeof(__pyx_k_nzi), 0, 0, 1, 1},
  {&__pyx_n_s_nzj, __pyx_k_nzj, sizeof(__pyx_k_nzj), 0, 0, 1, 1},
  {&__pyx_n_s_ones, __pyx_k_ones, sizeof(__pyx_k_ones), 0, 0, 1, 1},
  {&__pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_k_opt_orbs_orb_orb_code_orb_cutil, sizeof(__pyx_k_opt_orbs_orb_orb_code_orb_cutil), 0, 0, 1, 0},
  {&__pyx_n_s_optimize, __pyx_k_optimize, sizeof(__pyx_k_optimize), 0, 0, 1, 1},
  {&__pyx_n_s_orb_cutils, __pyx_k_orb_cutils, sizeof(__pyx_k_orb_cutils), 0, 0, 1, 1},
  {&__pyx_n_s_order, __pyx_k_order, sizeof(__pyx_k_order), 0, 0, 1, 1},
  {&__pyx_n_s_out, __pyx_k_out, sizeof(__pyx_k_out), 0, 0, 1, 1},
  {&__pyx_n_s_outx, __pyx_k_outx, sizeof(__pyx_k_outx), 0, 0, 1, 1},
  {&__pyx_n_s_outy, __pyx_k_outy, sizeof(__pyx_k_outy), 0, 0, 1, 1},
  {&__pyx_n_s_p1x, __pyx_k_p1x, sizeof(__pyx_k_p1x), 0, 0, 1, 1},
  {&__pyx_n_s_p1y, __pyx_k_p1y, sizeof(__pyx_k_p1y), 0, 0, 1, 1},
  {&__pyx_n_s_p2x, __pyx_k_p2x, sizeof(__pyx_k_p2x), 0, 0, 1, 1},
  {&__pyx_n_s_p2y, __pyx_k_p2y, sizeof(__pyx_k_p2y), 0, 0, 1, 1},
  {&__pyx_n_s_params, __pyx_k_params, sizeof(__pyx_k_params), 0, 0, 1, 1},
  {&__pyx_n_s_params_arrays2vect, __pyx_k_params_arrays2vect, sizeof(__pyx_k_params_arrays2vect), 0, 0, 1, 1},
  {&__pyx_n_s_params_vect2arrays, __pyx_k_params_vect2arrays, sizeof(__pyx_k_params_vect2arrays), 0, 0, 1, 1},
  {&__pyx_n_s_part_value, __pyx_k_part_value, sizeof(__pyx_k_part_value), 0, 0, 1, 1},
  {&__pyx_n_s_partition, __pyx_k_partition, sizeof(__pyx_k_partition), 0, 0, 1, 1},
  {&__pyx_n_s_pix, __pyx_k_pix, sizeof(__pyx_k_pix), 0, 0, 1, 1},
  {&__pyx_n_s_pix_coords, __pyx_k_pix_coords, sizeof(__pyx_k_pix_coords), 0, 0, 1, 1},
  {&__pyx_n_s_pix_to_compute, __pyx_k_pix_to_compute, sizeof(__pyx_k_pix_to_compute), 0, 0, 1, 1},
  {&__pyx_n_s_plx, __pyx_k_plx, sizeof(__pyx_k_plx), 0, 0, 1, 1},
  {&__pyx_n_s_ply, __pyx_k_ply, sizeof(__pyx_k_ply), 0, 0, 1, 1},
  {&__pyx_n_s_point_inside_polygon, __pyx_k_point_inside_polygon, sizeof(__pyx_k_point_inside_polygon), 0, 0, 1, 1},
  {&__pyx_n_s_poly, __pyx_k_poly, sizeof(__pyx_k_poly), 0, 0, 1, 1},
  {&__pyx_n_s_pos, __pyx_k_pos, sizeof(__pyx_k_pos), 0, 0, 1, 1},
  {&__pyx_n_s_pos_mask, __pyx_k_pos_mask, sizeof(__pyx_k_pos_mask), 0, 0, 1, 1},
  {&__pyx_n_s_print, __pyx_k_print, sizeof(__pyx_k_print), 0, 0, 1, 1},
  {&__pyx_n_s_q11, __pyx_k_q11, sizeof(__pyx_k_q11), 0, 0, 1, 1},
  {&__pyx_n_s_q12, __pyx_k_q12, sizeof(__pyx_k_q12), 0, 0, 1, 1},
  {&__pyx_n_s_q21, __pyx_k_q21, sizeof(__pyx_k_q21), 0, 0, 1, 1},
  {&__pyx_n_s_q22, __pyx_k_q22, sizeof(__pyx_k_q22), 0, 0, 1, 1},
  {&__pyx_n_s_r, __pyx_k_r, sizeof(__pyx_k_r), 0, 0, 1, 1},
  {&__pyx_n_s_radians, __pyx_k_radians, sizeof(__pyx_k_radians), 0, 0, 1, 1},
  {&__pyx_n_s_range, __pyx_k_range, sizeof(__pyx_k_range), 0, 0, 1, 1},
  {&__pyx_n_s_rcx, __pyx_k_rcx, sizeof(__pyx_k_rcx), 0, 0, 1, 1},
  {&__pyx_n_s_rcy, __pyx_k_rcy, sizeof(__pyx_k_rcy), 0, 0, 1, 1},
  {&__pyx_n_s_real, __pyx_k_real, sizeof(__pyx_k_real), 0, 0, 1, 1},
  {&__pyx_n_s_real_nans, __pyx_k_real_nans, sizeof(__pyx_k_real_nans), 0, 0, 1, 1},
  {&__pyx_n_s_red_chisq, __pyx_k_red_chisq, sizeof(__pyx_k_red_chisq), 0, 0, 1, 1},
  {&__pyx_kp_s_reduced_chi_square, __pyx_k_reduced_chi_square, sizeof(__pyx_k_reduced_chi_square), 0, 0, 1, 0},
  {&__pyx_n_s_reject_mode, __pyx_k_reject_mode, sizeof(__pyx_k_reject_mode), 0, 0, 1, 1},
  {&__pyx_n_s_rejects2d, __pyx_k_rejects2d, sizeof(__pyx_k_rejects2d), 0, 0, 1, 1},
  {&__pyx_n_s_rejpix, __pyx_k_rejpix, sizeof(__pyx_k_rejpix), 0, 0, 1, 1},
  {&__pyx_n_s_res, __pyx_k_res, sizeof(__pyx_k_res), 0, 0, 1, 1},
  {&__pyx_n_s_reshape, __pyx_k_reshape, sizeof(__pyx_k_reshape), 0, 0, 1, 1},
  {&__pyx_n_s_result, __pyx_k_result, sizeof(__pyx_k_result), 0, 0, 1, 1},
  {&__pyx_n_s_return_err, __pyx_k_return_err, sizeof(__pyx_k_return_err), 0, 0, 1, 1},
  {&__pyx_n_s_return_index_list, __pyx_k_return_index_list, sizeof(__pyx_k_return_index_list), 0, 0, 1, 1},
  {&__pyx_n_s_return_std_frame, __pyx_k_return_std_frame, sizeof(__pyx_k_return_std_frame), 0, 0, 1, 1},
  {&__pyx_n_s_returned_data, __pyx_k_returned_data, sizeof(__pyx_k_returned_data), 0, 0, 1, 1},
  {&__pyx_n_s_rmax, __pyx_k_rmax, sizeof(__pyx_k_rmax), 0, 0, 1, 1},
  {&__pyx_n_s_rmin, __pyx_k_rmin, sizeof(__pyx_k_rmin), 0, 0, 1, 1},
  {&__pyx_n_s_robust_average, __pyx_k_robust_average, sizeof(__pyx_k_robust_average), 0, 0, 1, 1},
  {&__pyx_n_s_robust_format, __pyx_k_robust_format, sizeof(__pyx_k_robust_format), 0, 0, 1, 1},
  {&__pyx_n_s_robust_mean, __pyx_k_robust_mean, sizeof(__pyx_k_robust_mean), 0, 0, 1, 1},
  {&__pyx_n_s_robust_median, __pyx_k_robust_median, sizeof(__pyx_k_robust_median), 0, 0, 1, 1},
  {&__pyx_n_s_robust_std, __pyx_k_robust_std, sizeof(__pyx_k_robust_std), 0, 0, 1, 1},
  {&__pyx_n_s_robust_sum, __pyx_k_robust_sum, sizeof(__pyx_k_robust_sum), 0, 0, 1, 1},
  {&__pyx_n_s_ron, __pyx_k_ron, sizeof(__pyx_k_ron), 0, 0, 1, 1},
  {&__pyx_n_s_saturation, __pyx_k_saturation, sizeof(__pyx_k_saturation), 0, 0, 1, 1},
  {&__pyx_n_s_scipy, __pyx_k_scipy, sizeof(__pyx_k_scipy), 0, 0, 1, 1},
  {&__pyx_n_s_scipy_interpolate, __pyx_k_scipy_interpolate, sizeof(__pyx_k_scipy_interpolate), 0, 0, 1, 1},
  {&__pyx_n_s_scipy_ndimage_filters, __pyx_k_scipy_ndimage_filters, sizeof(__pyx_k_scipy_ndimage_filters), 0, 0, 1, 1},
  {&__pyx_n_s_scipy_optimize, __pyx_k_scipy_optimize, sizeof(__pyx_k_scipy_optimize), 0, 0, 1, 1},
  {&__pyx_n_s_scipy_special, __pyx_k_scipy_special, sizeof(__pyx_k_scipy_special), 0, 0, 1, 1},
  {&__pyx_n_s_shape, __pyx_k_shape, sizeof(__pyx_k_shape), 0, 0, 1, 1},
  {&__pyx_n_s_sigma, __pyx_k_sigma, sizeof(__pyx_k_sigma), 0, 0, 1, 1},
  {&__pyx_n_s_sigmaclip, __pyx_k_sigmaclip, sizeof(__pyx_k_sigmaclip), 0, 0, 1, 1},
  {&__pyx_n_s_sigmacut, __pyx_k_sigmacut, sizeof(__pyx_k_sigmacut), 0, 0, 1, 1},
  {&__pyx_n_s_sign, __pyx_k_sign, sizeof(__pyx_k_sign), 0, 0, 1, 1},
  {&__pyx_n_s_sinc, __pyx_k_sinc, sizeof(__pyx_k_sinc), 0, 0, 1, 1},
  {&__pyx_n_s_sinc1d, __pyx_k_sinc1d, sizeof(__pyx_k_sinc1d), 0, 0, 1, 1},
  {&__pyx_n_s_sip, __pyx_k_sip, sizeof(__pyx_k_sip), 0, 0, 1, 1},
  {&__pyx_n_s_sip_A, __pyx_k_sip_A, sizeof(__pyx_k_sip_A), 0, 0, 1, 1},
  {&__pyx_n_s_sip_B, __pyx_k_sip_B, sizeof(__pyx_k_sip_B), 0, 0, 1, 1},
  {&__pyx_n_s_sip_im2pix, __pyx_k_sip_im2pix, sizeof(__pyx_k_sip_im2pix), 0, 0, 1, 1},
  {&__pyx_n_s_sip_pix2im, __pyx_k_sip_pix2im, sizeof(__pyx_k_sip_pix2im), 0, 0, 1, 1},
  {&__pyx_n_s_size, __pyx_k_size, sizeof(__pyx_k_size), 0, 0, 1, 1},
  {&__pyx_n_s_sky_pixels, __pyx_k_sky_pixels, sizeof(__pyx_k_sky_pixels), 0, 0, 1, 1},
  {&__pyx_n_s_sort, __pyx_k_sort, sizeof(__pyx_k_sort), 0, 0, 1, 1},
  {&__pyx_n_s_spectrum, __pyx_k_spectrum, sizeof(__pyx_k_spectrum), 0, 0, 1, 1},
  {&__pyx_n_s_spectrum_mean_energy, __pyx_k_spectrum_mean_energy, sizeof(__pyx_k_spectrum_mean_energy), 0, 0, 1, 1},
  {&__pyx_n_s_sqrt, __pyx_k_sqrt, sizeof(__pyx_k_sqrt), 0, 0, 1, 1},
  {&__pyx_n_s_sqrtmean2d, __pyx_k_sqrtmean2d, sizeof(__pyx_k_sqrtmean2d), 0, 0, 1, 1},
  {&__pyx_n_s_star, __pyx_k_star, sizeof(__pyx_k_star), 0, 0, 1, 1},
  {&__pyx_n_s_star_list, __pyx_k_star_list, sizeof(__pyx_k_star_list), 0, 0, 1, 1},
  {&__pyx_n_s_star_nb, __pyx_k_star_nb, sizeof(__pyx_k_star_nb), 0, 0, 1, 1},
  {&__pyx_n_s_stars_err, __pyx_k_stars_err, sizeof(__pyx_k_stars_err), 0, 0, 1, 1},
  {&__pyx_n_s_stars_free_p_nb, __pyx_k_stars_free_p_nb, sizeof(__pyx_k_stars_free_p_nb), 0, 0, 1, 1},
  {&__pyx_n_s_stars_p, __pyx_k_stars_p, sizeof(__pyx_k_stars_p), 0, 0, 1, 1},
  {&__pyx_n_s_stars_p_mask, __pyx_k_stars_p_mask, sizeof(__pyx_k_stars_p_mask), 0, 0, 1, 1},
  {&__pyx_kp_s_stars_params, __pyx_k_stars_params, sizeof(__pyx_k_stars_params), 0, 0, 1, 0},
  {&__pyx_kp_s_stars_params_err, __pyx_k_stars_params_err, sizeof(__pyx_k_stars_params_err), 0, 0, 1, 0},
  {&__pyx_n_s_std, __pyx_k_std, sizeof(__pyx_k_std), 0, 0, 1, 1},
  {&__pyx_n_s_std2d, __pyx_k_std2d, sizeof(__pyx_k_std2d), 0, 0, 1, 1},
  {&__pyx_n_s_std_x, __pyx_k_std_x, sizeof(__pyx_k_std_x), 0, 0, 1, 1},
  {&__pyx_n_s_step, __pyx_k_step, sizeof(__pyx_k_step), 0, 0, 1, 1},
  {&__pyx_n_s_still_rejection, __pyx_k_still_rejection, sizeof(__pyx_k_still_rejection), 0, 0, 1, 1},
  {&__pyx_n_s_stop_rejection, __pyx_k_stop_rejection, sizeof(__pyx_k_stop_rejection), 0, 0, 1, 1},
  {&__pyx_n_s_sub_dimx, __pyx_k_sub_dimx, sizeof(__pyx_k_sub_dimx), 0, 0, 1, 1},
  {&__pyx_n_s_sub_dimy, __pyx_k_sub_dimy, sizeof(__pyx_k_sub_dimy), 0, 0, 1, 1},
  {&__pyx_n_s_sub_div, __pyx_k_sub_div, sizeof(__pyx_k_sub_div), 0, 0, 1, 1},
  {&__pyx_n_s_sum, __pyx_k_sum, sizeof(__pyx_k_sum), 0, 0, 1, 1},
  {&__pyx_n_s_surface_value, __pyx_k_surface_value, sizeof(__pyx_k_surface_value), 0, 0, 1, 1},
  {&__pyx_n_s_sz, __pyx_k_sz, sizeof(__pyx_k_sz), 0, 0, 1, 1},
  {&__pyx_n_s_test, __pyx_k_test, sizeof(__pyx_k_test), 0, 0, 1, 1},
  {&__pyx_n_s_test_p, __pyx_k_test_p, sizeof(__pyx_k_test_p), 0, 0, 1, 1},
  {&__pyx_n_s_test_x, __pyx_k_test_x, sizeof(__pyx_k_test_x), 0, 0, 1, 1},
  {&__pyx_n_s_test_y, __pyx_k_test_y, sizeof(__pyx_k_test_y), 0, 0, 1, 1},
  {&__pyx_n_s_time, __pyx_k_time, sizeof(__pyx_k_time), 0, 0, 1, 1},
  {&__pyx_n_s_to_rgba, __pyx_k_to_rgba, sizeof(__pyx_k_to_rgba), 0, 0, 1, 1},
  {&__pyx_n_s_tolerance, __pyx_k_tolerance, sizeof(__pyx_k_tolerance), 0, 0, 1, 1},
  {&__pyx_n_s_total_flux, __pyx_k_total_flux, sizeof(__pyx_k_total_flux), 0, 0, 1, 1},
  {&__pyx_n_s_transform_A_to_B, __pyx_k_transform_A_to_B, sizeof(__pyx_k_transform_A_to_B), 0, 0, 1, 1},
  {&__pyx_n_s_transform_B_to_A, __pyx_k_transform_B_to_A, sizeof(__pyx_k_transform_B_to_A), 0, 0, 1, 1},
  {&__pyx_n_s_transpose, __pyx_k_transpose, sizeof(__pyx_k_transpose), 0, 0, 1, 1},
  {&__pyx_n_s_uint16, __pyx_k_uint16, sizeof(__pyx_k_uint16), 0, 0, 1, 1},
  {&__pyx_n_s_uint8, __pyx_k_uint8, sizeof(__pyx_k_uint8), 0, 0, 1, 1},
  {&__pyx_n_s_unbin_image, __pyx_k_unbin_image, sizeof(__pyx_k_unbin_image), 0, 0, 1, 1},
  {&__pyx_kp_u_unknown_dtype_code_in_numpy_pxd, __pyx_k_unknown_dtype_code_in_numpy_pxd, sizeof(__pyx_k_unknown_dtype_code_in_numpy_pxd), 0, 1, 0, 0},
  {&__pyx_n_s_use_central_value, __pyx_k_use_central_value, sizeof(__pyx_k_use_central_value), 0, 0, 1, 1},
  {&__pyx_n_s_val, __pyx_k_val, sizeof(__pyx_k_val), 0, 0, 1, 1},
  {&__pyx_n_s_value, __pyx_k_value, sizeof(__pyx_k_value), 0, 0, 1, 1},
  {&__pyx_n_s_vmax, __pyx_k_vmax, sizeof(__pyx_k_vmax), 0, 0, 1, 1},
  {&__pyx_n_s_vmin, __pyx_k_vmin, sizeof(__pyx_k_vmin), 0, 0, 1, 1},
  {&__pyx_n_s_w, __pyx_k_w, sizeof(__pyx_k_w), 0, 0, 1, 1},
  {&__pyx_n_s_wcs_pix2world, __pyx_k_wcs_pix2world, sizeof(__pyx_k_wcs_pix2world), 0, 0, 1, 1},
  {&__pyx_n_s_wcs_world2pix, __pyx_k_wcs_world2pix, sizeof(__pyx_k_wcs_world2pix), 0, 0, 1, 1},
  {&__pyx_n_s_width, __pyx_k_width, sizeof(__pyx_k_width), 0, 0, 1, 1},
  {&__pyx_kp_s_width_must_be_between_0_and_1, __pyx_k_width_must_be_between_0_and_1, sizeof(__pyx_k_width_must_be_between_0_and_1), 0, 0, 1, 0},
  {&__pyx_n_s_window, __pyx_k_window, sizeof(__pyx_k_window), 0, 0, 1, 1},
  {&__pyx_n_s_wlen, __pyx_k_wlen, sizeof(__pyx_k_wlen), 0, 0, 1, 1},
  {&__pyx_n_s_workframe, __pyx_k_workframe, sizeof(__pyx_k_workframe), 0, 0, 1, 1},
  {&__pyx_n_s_wsize, __pyx_k_wsize, sizeof(__pyx_k_wsize), 0, 0, 1, 1},
  {&__pyx_n_s_x, __pyx_k_x, sizeof(__pyx_k_x), 0, 0, 1, 1},
  {&__pyx_n_s_x1, __pyx_k_x1, sizeof(__pyx_k_x1), 0, 0, 1, 1},
  {&__pyx_n_s_x1_err, __pyx_k_x1_err, sizeof(__pyx_k_x1_err), 0, 0, 1, 1},
  {&__pyx_n_s_x1_orig, __pyx_k_x1_orig, sizeof(__pyx_k_x1_orig), 0, 0, 1, 1},
  {&__pyx_n_s_x1d, __pyx_k_x1d, sizeof(__pyx_k_x1d), 0, 0, 1, 1},
  {&__pyx_n_s_x2, __pyx_k_x2, sizeof(__pyx_k_x2), 0, 0, 1, 1},
  {&__pyx_n_s_x2_err, __pyx_k_x2_err, sizeof(__pyx_k_x2_err), 0, 0, 1, 1},
  {&__pyx_n_s_x2d, __pyx_k_x2d, sizeof(__pyx_k_x2d), 0, 0, 1, 1},
  {&__pyx_n_s_x_lim_max, __pyx_k_x_lim_max, sizeof(__pyx_k_x_lim_max), 0, 0, 1, 1},
  {&__pyx_n_s_x_lim_min, __pyx_k_x_lim_min, sizeof(__pyx_k_x_lim_min), 0, 0, 1, 1},
  {&__pyx_n_s_x_max, __pyx_k_x_max, sizeof(__pyx_k_x_max), 0, 0, 1, 1},
  {&__pyx_n_s_x_min, __pyx_k_x_min, sizeof(__pyx_k_x_min), 0, 0, 1, 1},
  {&__pyx_n_s_x_range, __pyx_k_x_range, sizeof(__pyx_k_x_range), 0, 0, 1, 1},
  {&__pyx_n_s_xaxis, __pyx_k_xaxis, sizeof(__pyx_k_xaxis), 0, 0, 1, 1},
  {&__pyx_n_s_xc, __pyx_k_xc, sizeof(__pyx_k_xc), 0, 0, 1, 1},
  {&__pyx_n_s_xcoord, __pyx_k_xcoord, sizeof(__pyx_k_xcoord), 0, 0, 1, 1},
  {&__pyx_n_s_xinters, __pyx_k_xinters, sizeof(__pyx_k_xinters), 0, 0, 1, 1},
  {&__pyx_n_s_xmax, __pyx_k_xmax, sizeof(__pyx_k_xmax), 0, 0, 1, 1},
  {&__pyx_n_s_xmaxb, __pyx_k_xmaxb, sizeof(__pyx_k_xmaxb), 0, 0, 1, 1},
  {&__pyx_n_s_xmin, __pyx_k_xmin, sizeof(__pyx_k_xmin), 0, 0, 1, 1},
  {&__pyx_n_s_xminb, __pyx_k_xminb, sizeof(__pyx_k_xminb), 0, 0, 1, 1},
  {&__pyx_n_s_xrange, __pyx_k_xrange, sizeof(__pyx_k_xrange), 0, 0, 1, 1},
  {&__pyx_n_s_xrc, __pyx_k_xrc, sizeof(__pyx_k_xrc), 0, 0, 1, 1},
  {&__pyx_n_s_xtol, __pyx_k_xtol, sizeof(__pyx_k_xtol), 0, 0, 1, 1},
  {&__pyx_n_s_y, __pyx_k_y, sizeof(__pyx_k_y), 0, 0, 1, 1},
  {&__pyx_n_s_y1, __pyx_k_y1, sizeof(__pyx_k_y1), 0, 0, 1, 1},
  {&__pyx_n_s_y1_err, __pyx_k_y1_err, sizeof(__pyx_k_y1_err), 0, 0, 1, 1},
  {&__pyx_n_s_y1_orig, __pyx_k_y1_orig, sizeof(__pyx_k_y1_orig), 0, 0, 1, 1},
  {&__pyx_n_s_y1d, __pyx_k_y1d, sizeof(__pyx_k_y1d), 0, 0, 1, 1},
  {&__pyx_n_s_y2, __pyx_k_y2, sizeof(__pyx_k_y2), 0, 0, 1, 1},
  {&__pyx_n_s_y2_err, __pyx_k_y2_err, sizeof(__pyx_k_y2_err), 0, 0, 1, 1},
  {&__pyx_n_s_y2d, __pyx_k_y2d, sizeof(__pyx_k_y2d), 0, 0, 1, 1},
  {&__pyx_n_s_y_lim_max, __pyx_k_y_lim_max, sizeof(__pyx_k_y_lim_max), 0, 0, 1, 1},
  {&__pyx_n_s_y_lim_min, __pyx_k_y_lim_min, sizeof(__pyx_k_y_lim_min), 0, 0, 1, 1},
  {&__pyx_n_s_y_max, __pyx_k_y_max, sizeof(__pyx_k_y_max), 0, 0, 1, 1},
  {&__pyx_n_s_y_min, __pyx_k_y_min, sizeof(__pyx_k_y_min), 0, 0, 1, 1},
  {&__pyx_n_s_y_range, __pyx_k_y_range, sizeof(__pyx_k_y_range), 0, 0, 1, 1},
  {&__pyx_n_s_yaxis, __pyx_k_yaxis, sizeof(__pyx_k_yaxis), 0, 0, 1, 1},
  {&__pyx_n_s_yc, __pyx_k_yc, sizeof(__pyx_k_yc), 0, 0, 1, 1},
  {&__pyx_n_s_ycoord, __pyx_k_ycoord, sizeof(__pyx_k_ycoord), 0, 0, 1, 1},
  {&__pyx_n_s_ymax, __pyx_k_ymax, sizeof(__pyx_k_ymax), 0, 0, 1, 1},
  {&__pyx_n_s_ymaxb, __pyx_k_ymaxb, sizeof(__pyx_k_ymaxb), 0, 0, 1, 1},
  {&__pyx_n_s_ymin, __pyx_k_ymin, sizeof(__pyx_k_ymin), 0, 0, 1, 1},
  {&__pyx_n_s_yminb, __pyx_k_yminb, sizeof(__pyx_k_yminb), 0, 0, 1, 1},
  {&__pyx_n_s_yrc, __pyx_k_yrc, sizeof(__pyx_k_yrc), 0, 0, 1, 1},
  {&__pyx_n_s_zeros, __pyx_k_zeros, sizeof(__pyx_k_zeros), 0, 0, 1, 1},
  {&__pyx_n_s_zeros_like, __pyx_k_zeros_like, sizeof(__pyx_k_zeros_like), 0, 0, 1, 1},
  {&__pyx_n_s_zx, __pyx_k_zx, sizeof(__pyx_k_zx), 0, 0, 1, 1},
  {&__pyx_n_s_zx_err, __pyx_k_zx_err, sizeof(__pyx_k_zx_err), 0, 0, 1, 1},
  {&__pyx_n_s_zy, __pyx_k_zy, sizeof(__pyx_k_zy), 0, 0, 1, 1},
  {&__pyx_n_s_zy_err, __pyx_k_zy_err, sizeof(__pyx_k_zy_err), 0, 0, 1, 1},
  {0, 0, 0, 0, 0, 0, 0}
};
static int __Pyx_InitCachedBuiltins(void) {
  __pyx_builtin_range = __Pyx_GetBuiltinName(__pyx_n_s_range); if (!__pyx_builtin_range) __PYX_ERR(0, 296, __pyx_L1_error)
  __pyx_builtin_Exception = __Pyx_GetBuiltinName(__pyx_n_s_Exception); if (!__pyx_builtin_Exception) __PYX_ERR(0, 617, __pyx_L1_error)
  __pyx_builtin_ValueError = __Pyx_GetBuiltinName(__pyx_n_s_ValueError); if (!__pyx_builtin_ValueError) __PYX_ERR(0, 972, __pyx_L1_error)
  #if PY_MAJOR_VERSION >= 3
  __pyx_builtin_xrange = __Pyx_GetBuiltinName(__pyx_n_s_range); if (!__pyx_builtin_xrange) __PYX_ERR(0, 1860, __pyx_L1_error)
  #else
  __pyx_builtin_xrange = __Pyx_GetBuiltinName(__pyx_n_s_xrange); if (!__pyx_builtin_xrange) __PYX_ERR(0, 1860, __pyx_L1_error)
  #endif
  __pyx_builtin_RuntimeError = __Pyx_GetBuiltinName(__pyx_n_s_RuntimeError); if (!__pyx_builtin_RuntimeError) __PYX_ERR(1, 799, __pyx_L1_error)
  return 0;
  __pyx_L1_error:;
  return -1;
}

static int __Pyx_InitCachedConstants(void) {
  __Pyx_RefNannyDeclarations
  __Pyx_RefNannySetupContext("__Pyx_InitCachedConstants", 0);

  /* "orb/cutils.pyx":227
 *         im_coords.shape[0], dtype=np.float64)
 * 
 *     xcoord, ycoord = sip.wcs_pix2world(im_coords[:,1], im_coords[:,0], 0)             # <<<<<<<<<<<<<<
 *     xcoord, ycoord = sip.all_world2pix(xcoord, ycoord, 0, tolerance=tolerance)
 * 
 */
  __pyx_slice_ = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice_)) __PYX_ERR(0, 227, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice_);
  __Pyx_GIVEREF(__pyx_slice_);
  __pyx_tuple__2 = PyTuple_Pack(2, __pyx_slice_, __pyx_int_1); if (unlikely(!__pyx_tuple__2)) __PYX_ERR(0, 227, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__2);
  __Pyx_GIVEREF(__pyx_tuple__2);
  __pyx_slice__3 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__3)) __PYX_ERR(0, 227, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__3);
  __Pyx_GIVEREF(__pyx_slice__3);
  __pyx_tuple__4 = PyTuple_Pack(2, __pyx_slice__3, __pyx_int_0); if (unlikely(!__pyx_tuple__4)) __PYX_ERR(0, 227, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__4);
  __Pyx_GIVEREF(__pyx_tuple__4);

  /* "orb/cutils.pyx":245
 *         pix_coords.shape[0], dtype=np.float64)
 * 
 *     xcoord, ycoord = sip.all_pix2world(pix_coords[:,1], pix_coords[:,0], 0)             # <<<<<<<<<<<<<<
 *     xcoord, ycoord = sip.wcs_world2pix(xcoord, ycoord, 0)
 * 
 */
  __pyx_slice__5 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__5)) __PYX_ERR(0, 245, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__5);
  __Pyx_GIVEREF(__pyx_slice__5);
  __pyx_tuple__6 = PyTuple_Pack(2, __pyx_slice__5, __pyx_int_1); if (unlikely(!__pyx_tuple__6)) __PYX_ERR(0, 245, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__6);
  __Pyx_GIVEREF(__pyx_tuple__6);
  __pyx_slice__7 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__7)) __PYX_ERR(0, 245, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__7);
  __Pyx_GIVEREF(__pyx_slice__7);
  __pyx_tuple__8 = PyTuple_Pack(2, __pyx_slice__7, __pyx_int_0); if (unlikely(!__pyx_tuple__8)) __PYX_ERR(0, 245, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__8);
  __Pyx_GIVEREF(__pyx_tuple__8);

  /* "orb/cutils.pyx":289
 *     if sip_A is not None:
 *         outx, outy = np.mgrid[0:nx:1, 0:ny:1].astype(np.float64)
 *         coords[:,0] = outx.flatten()             # <<<<<<<<<<<<<<
 *         coords[:,1] = outy.flatten()
 *         coords = sip_pix2im(coords, sip_A)
 */
  __pyx_slice__9 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__9)) __PYX_ERR(0, 289, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__9);
  __Pyx_GIVEREF(__pyx_slice__9);
  __pyx_tuple__10 = PyTuple_Pack(2, __pyx_slice__9, __pyx_int_0); if (unlikely(!__pyx_tuple__10)) __PYX_ERR(0, 289, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__10);
  __Pyx_GIVEREF(__pyx_tuple__10);

  /* "orb/cutils.pyx":290
 *         outx, outy = np.mgrid[0:nx:1, 0:ny:1].astype(np.float64)
 *         coords[:,0] = outx.flatten()
 *         coords[:,1] = outy.flatten()             # <<<<<<<<<<<<<<
 *         coords = sip_pix2im(coords, sip_A)
 *         outx = np.reshape(coords[:,0], [outx.shape[0], outx.shape[1]])
 */
  __pyx_slice__11 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__11)) __PYX_ERR(0, 290, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__11);
  __Pyx_GIVEREF(__pyx_slice__11);
  __pyx_tuple__12 = PyTuple_Pack(2, __pyx_slice__11, __pyx_int_1); if (unlikely(!__pyx_tuple__12)) __PYX_ERR(0, 290, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__12);
  __Pyx_GIVEREF(__pyx_tuple__12);

  /* "orb/cutils.pyx":292
 *         coords[:,1] = outy.flatten()
 *         coords = sip_pix2im(coords, sip_A)
 *         outx = np.reshape(coords[:,0], [outx.shape[0], outx.shape[1]])             # <<<<<<<<<<<<<<
 *         outy = np.reshape(coords[:,1], [outy.shape[0], outy.shape[1]])
 * 
 */
  __pyx_slice__13 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__13)) __PYX_ERR(0, 292, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__13);
  __Pyx_GIVEREF(__pyx_slice__13);
  __pyx_tuple__14 = PyTuple_Pack(2, __pyx_slice__13, __pyx_int_0); if (unlikely(!__pyx_tuple__14)) __PYX_ERR(0, 292, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__14);
  __Pyx_GIVEREF(__pyx_tuple__14);

  /* "orb/cutils.pyx":293
 *         coords = sip_pix2im(coords, sip_A)
 *         outx = np.reshape(coords[:,0], [outx.shape[0], outx.shape[1]])
 *         outy = np.reshape(coords[:,1], [outy.shape[0], outy.shape[1]])             # <<<<<<<<<<<<<<
 * 
 * 
 */
  __pyx_slice__15 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__15)) __PYX_ERR(0, 293, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__15);
  __Pyx_GIVEREF(__pyx_slice__15);
  __pyx_tuple__16 = PyTuple_Pack(2, __pyx_slice__15, __pyx_int_1); if (unlikely(!__pyx_tuple__16)) __PYX_ERR(0, 293, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__16);
  __Pyx_GIVEREF(__pyx_tuple__16);

  /* "orb/cutils.pyx":307
 * 
 *     if sip_B is not None:
 *         coords[:,0] = outx.flatten()             # <<<<<<<<<<<<<<
 *         coords[:,1] = outy.flatten()
 *         coords = sip_im2pix(coords, sip_B)
 */
  __pyx_slice__17 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__17)) __PYX_ERR(0, 307, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__17);
  __Pyx_GIVEREF(__pyx_slice__17);
  __pyx_tuple__18 = PyTuple_Pack(2, __pyx_slice__17, __pyx_int_0); if (unlikely(!__pyx_tuple__18)) __PYX_ERR(0, 307, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__18);
  __Pyx_GIVEREF(__pyx_tuple__18);

  /* "orb/cutils.pyx":308
 *     if sip_B is not None:
 *         coords[:,0] = outx.flatten()
 *         coords[:,1] = outy.flatten()             # <<<<<<<<<<<<<<
 *         coords = sip_im2pix(coords, sip_B)
 *         outx = np.reshape(coords[:,0], [outx.shape[0], outx.shape[1]])
 */
  __pyx_slice__19 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__19)) __PYX_ERR(0, 308, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__19);
  __Pyx_GIVEREF(__pyx_slice__19);
  __pyx_tuple__20 = PyTuple_Pack(2, __pyx_slice__19, __pyx_int_1); if (unlikely(!__pyx_tuple__20)) __PYX_ERR(0, 308, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__20);
  __Pyx_GIVEREF(__pyx_tuple__20);

  /* "orb/cutils.pyx":310
 *         coords[:,1] = outy.flatten()
 *         coords = sip_im2pix(coords, sip_B)
 *         outx = np.reshape(coords[:,0], [outx.shape[0], outx.shape[1]])             # <<<<<<<<<<<<<<
 *         outy = np.reshape(coords[:,1], [outy.shape[0], outy.shape[1]])
 * 
 */
  __pyx_slice__21 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__21)) __PYX_ERR(0, 310, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__21);
  __Pyx_GIVEREF(__pyx_slice__21);
  __pyx_tuple__22 = PyTuple_Pack(2, __pyx_slice__21, __pyx_int_0); if (unlikely(!__pyx_tuple__22)) __PYX_ERR(0, 310, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__22);
  __Pyx_GIVEREF(__pyx_tuple__22);

  /* "orb/cutils.pyx":311
 *         coords = sip_im2pix(coords, sip_B)
 *         outx = np.reshape(coords[:,0], [outx.shape[0], outx.shape[1]])
 *         outy = np.reshape(coords[:,1], [outy.shape[0], outy.shape[1]])             # <<<<<<<<<<<<<<
 * 
 *     return outx, outy
 */
  __pyx_slice__23 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__23)) __PYX_ERR(0, 311, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__23);
  __Pyx_GIVEREF(__pyx_slice__23);
  __pyx_tuple__24 = PyTuple_Pack(2, __pyx_slice__23, __pyx_int_1); if (unlikely(!__pyx_tuple__24)) __PYX_ERR(0, 311, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__24);
  __Pyx_GIVEREF(__pyx_tuple__24);

  /* "orb/cutils.pyx":507
 *     for i in range(n):
 *         if axis == 0:
 *             iline = x[:,i]             # <<<<<<<<<<<<<<
 *         else:
 *             iline = x[i,:]
 */
  __pyx_slice__25 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__25)) __PYX_ERR(0, 507, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__25);
  __Pyx_GIVEREF(__pyx_slice__25);

  /* "orb/cutils.pyx":509
 *             iline = x[:,i]
 *         else:
 *             iline = x[i,:]             # <<<<<<<<<<<<<<
 *         line[i] = bn.nanmean(sigmacut(iline, 0, False,
 *                                       sigma, min_values,
 */
  __pyx_slice__26 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__26)) __PYX_ERR(0, 509, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__26);
  __Pyx_GIVEREF(__pyx_slice__26);

  /* "orb/cutils.pyx":542
 * 
 *     # compute first median without min and max
 *     med = bn.median(x[1:-1])             # <<<<<<<<<<<<<<
 *     std = bn.nanstd(x[1:-1])
 * 
 */
  __pyx_slice__27 = PySlice_New(__pyx_int_1, __pyx_int_neg_1, Py_None); if (unlikely(!__pyx_slice__27)) __PYX_ERR(0, 542, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__27);
  __Pyx_GIVEREF(__pyx_slice__27);

  /* "orb/cutils.pyx":543
 *     # compute first median without min and max
 *     med = bn.median(x[1:-1])
 *     std = bn.nanstd(x[1:-1])             # <<<<<<<<<<<<<<
 * 
 *     while still_rejection:
 */
  __pyx_slice__28 = PySlice_New(__pyx_int_1, __pyx_int_neg_1, Py_None); if (unlikely(!__pyx_slice__28)) __PYX_ERR(0, 543, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__28);
  __Pyx_GIVEREF(__pyx_slice__28);

  /* "orb/cutils.pyx":617
 *     cdef int dimy = frames.shape[1]
 *     cdef int dimz = frames.shape[2]
 *     if dimz < 3: raise Exception('There must be more than 2 frames to combine')             # <<<<<<<<<<<<<<
 * 
 *     cdef np.ndarray[np.float64_t, ndim=3] framesdiff = np.zeros(
 */
  __pyx_tuple__29 = PyTuple_Pack(1, __pyx_kp_s_There_must_be_more_than_2_frames); if (unlikely(!__pyx_tuple__29)) __PYX_ERR(0, 617, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__29);
  __Pyx_GIVEREF(__pyx_tuple__29);

  /* "orb/cutils.pyx":638
 * 
 *     frames = np.sort(frames, axis=2)
 *     mean2d = bn.nanmean(frames[:,:,1:-1], axis=2)             # <<<<<<<<<<<<<<
 *     std2d = bn.nanstd(frames[:,:,1:-1], axis=2)
 * 
 */
  __pyx_slice__30 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__30)) __PYX_ERR(0, 638, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__30);
  __Pyx_GIVEREF(__pyx_slice__30);
  __pyx_slice__31 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__31)) __PYX_ERR(0, 638, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__31);
  __Pyx_GIVEREF(__pyx_slice__31);
  __pyx_slice__32 = PySlice_New(__pyx_int_1, __pyx_int_neg_1, Py_None); if (unlikely(!__pyx_slice__32)) __PYX_ERR(0, 638, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__32);
  __Pyx_GIVEREF(__pyx_slice__32);
  __pyx_tuple__33 = PyTuple_Pack(3, __pyx_slice__30, __pyx_slice__31, __pyx_slice__32); if (unlikely(!__pyx_tuple__33)) __PYX_ERR(0, 638, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__33);
  __Pyx_GIVEREF(__pyx_tuple__33);

  /* "orb/cutils.pyx":639
 *     frames = np.sort(frames, axis=2)
 *     mean2d = bn.nanmean(frames[:,:,1:-1], axis=2)
 *     std2d = bn.nanstd(frames[:,:,1:-1], axis=2)             # <<<<<<<<<<<<<<
 * 
 *     ## Rejection
 */
  __pyx_slice__34 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__34)) __PYX_ERR(0, 639, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__34);
  __Pyx_GIVEREF(__pyx_slice__34);
  __pyx_slice__35 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__35)) __PYX_ERR(0, 639, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__35);
  __Pyx_GIVEREF(__pyx_slice__35);
  __pyx_slice__36 = PySlice_New(__pyx_int_1, __pyx_int_neg_1, Py_None); if (unlikely(!__pyx_slice__36)) __PYX_ERR(0, 639, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__36);
  __Pyx_GIVEREF(__pyx_slice__36);
  __pyx_tuple__37 = PyTuple_Pack(3, __pyx_slice__34, __pyx_slice__35, __pyx_slice__36); if (unlikely(!__pyx_tuple__37)) __PYX_ERR(0, 639, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__37);
  __Pyx_GIVEREF(__pyx_tuple__37);

  /* "orb/cutils.pyx":678
 *     # minmax
 *     elif reject_mode == 2:
 *         frames = frames[:,:,1:-1]             # <<<<<<<<<<<<<<
 *         rejects2d.fill(2)
 *     else: raise Exception('Bad rejection mode. Must be 0, 1 or 2.')
 */
  __pyx_slice__38 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__38)) __PYX_ERR(0, 678, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__38);
  __Pyx_GIVEREF(__pyx_slice__38);
  __pyx_slice__39 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__39)) __PYX_ERR(0, 678, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__39);
  __Pyx_GIVEREF(__pyx_slice__39);
  __pyx_slice__40 = PySlice_New(__pyx_int_1, __pyx_int_neg_1, Py_None); if (unlikely(!__pyx_slice__40)) __PYX_ERR(0, 678, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__40);
  __Pyx_GIVEREF(__pyx_slice__40);
  __pyx_tuple__41 = PyTuple_Pack(3, __pyx_slice__38, __pyx_slice__39, __pyx_slice__40); if (unlikely(!__pyx_tuple__41)) __PYX_ERR(0, 678, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__41);
  __Pyx_GIVEREF(__pyx_tuple__41);

  /* "orb/cutils.pyx":679
 *     elif reject_mode == 2:
 *         frames = frames[:,:,1:-1]
 *         rejects2d.fill(2)             # <<<<<<<<<<<<<<
 *     else: raise Exception('Bad rejection mode. Must be 0, 1 or 2.')
 * 
 */
  __pyx_tuple__42 = PyTuple_Pack(1, __pyx_int_2); if (unlikely(!__pyx_tuple__42)) __PYX_ERR(0, 679, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__42);
  __Pyx_GIVEREF(__pyx_tuple__42);

  /* "orb/cutils.pyx":680
 *         frames = frames[:,:,1:-1]
 *         rejects2d.fill(2)
 *     else: raise Exception('Bad rejection mode. Must be 0, 1 or 2.')             # <<<<<<<<<<<<<<
 * 
 *     ## Combination
 */
  __pyx_tuple__43 = PyTuple_Pack(1, __pyx_kp_s_Bad_rejection_mode_Must_be_0_1_o); if (unlikely(!__pyx_tuple__43)) __PYX_ERR(0, 680, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__43);
  __Pyx_GIVEREF(__pyx_tuple__43);

  /* "orb/cutils.pyx":687
 *     elif combine_mode == 1:
 *         result = bn.nanmedian(frames, axis=2)
 *     else: raise Exception('Bad combining mode. Must be 0 or 1')             # <<<<<<<<<<<<<<
 *     if not return_std_frame:
 *         return result, rejects2d
 */
  __pyx_tuple__44 = PyTuple_Pack(1, __pyx_kp_s_Bad_combining_mode_Must_be_0_or); if (unlikely(!__pyx_tuple__44)) __PYX_ERR(0, 687, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__44);
  __Pyx_GIVEREF(__pyx_tuple__44);

  /* "orb/cutils.pyx":714
 * 
 *     if x.dtype.byteorder != '|' or '=':
 *         x = x.astype(x.dtype.newbyteorder('N'))             # <<<<<<<<<<<<<<
 * 
 *     if x.dtype == np.dtype(float) or x.dtype == np.dtype(complex):
 */
  __pyx_tuple__46 = PyTuple_Pack(1, __pyx_n_s_N); if (unlikely(!__pyx_tuple__46)) __PYX_ERR(0, 714, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__46);
  __Pyx_GIVEREF(__pyx_tuple__46);

  /* "orb/cutils.pyx":830
 *         for i in range(x.ndim):
 *             if x.shape[i] != w.shape[i]:
 *                 raise Exception('Array and weights must have same shape')             # <<<<<<<<<<<<<<
 *     else:
 *         raise Exception('Array and weights must have same number of dimensions')
 */
  __pyx_tuple__47 = PyTuple_Pack(1, __pyx_kp_s_Array_and_weights_must_have_same); if (unlikely(!__pyx_tuple__47)) __PYX_ERR(0, 830, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__47);
  __Pyx_GIVEREF(__pyx_tuple__47);

  /* "orb/cutils.pyx":832
 *                 raise Exception('Array and weights must have same shape')
 *     else:
 *         raise Exception('Array and weights must have same number of dimensions')             # <<<<<<<<<<<<<<
 * 
 *     if flagx and flagw:
 */
  __pyx_tuple__48 = PyTuple_Pack(1, __pyx_kp_s_Array_and_weights_must_have_same_2); if (unlikely(!__pyx_tuple__48)) __PYX_ERR(0, 832, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__48);
  __Pyx_GIVEREF(__pyx_tuple__48);

  /* "orb/cutils.pyx":972
 *     """
 *     if cutoff > 1. or cutoff < 0.:
 *         raise ValueError('cutoff must be between 0. and 1.')             # <<<<<<<<<<<<<<
 *     if width > 1. or width < 0.:
 *         raise ValueError('width must be between 0. and 1.')
 */
  __pyx_tuple__49 = PyTuple_Pack(1, __pyx_kp_s_cutoff_must_be_between_0_and_1); if (unlikely(!__pyx_tuple__49)) __PYX_ERR(0, 972, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__49);
  __Pyx_GIVEREF(__pyx_tuple__49);

  /* "orb/cutils.pyx":974
 *         raise ValueError('cutoff must be between 0. and 1.')
 *     if width > 1. or width < 0.:
 *         raise ValueError('width must be between 0. and 1.')             # <<<<<<<<<<<<<<
 * 
 *     cdef int n = a.shape[0]
 */
  __pyx_tuple__50 = PyTuple_Pack(1, __pyx_kp_s_width_must_be_between_0_and_1); if (unlikely(!__pyx_tuple__50)) __PYX_ERR(0, 974, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__50);
  __Pyx_GIVEREF(__pyx_tuple__50);

  /* "orb/cutils.pyx":1013
 * 
 *     if not n%2:
 *         window = np.hstack((hwindow, hwindow[::-1]))             # <<<<<<<<<<<<<<
 *     else:
 *         window = np.hstack((hwindow, hwindow[-1], hwindow[::-1]))
 */
  __pyx_slice__51 = PySlice_New(Py_None, Py_None, __pyx_int_neg_1); if (unlikely(!__pyx_slice__51)) __PYX_ERR(0, 1013, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__51);
  __Pyx_GIVEREF(__pyx_slice__51);

  /* "orb/cutils.pyx":1015
 *         window = np.hstack((hwindow, hwindow[::-1]))
 *     else:
 *         window = np.hstack((hwindow, hwindow[-1], hwindow[::-1]))             # <<<<<<<<<<<<<<
 * 
 *     if bn.anynan(a):
 */
  __pyx_slice__52 = PySlice_New(Py_None, Py_None, __pyx_int_neg_1); if (unlikely(!__pyx_slice__52)) __PYX_ERR(0, 1015, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__52);
  __Pyx_GIVEREF(__pyx_slice__52);

  /* "orb/cutils.pyx":1087
 *         (sz, sz), dtype=np.float64)
 * 
 *     if deg < 0: raise ValueError('deg must be >= 0')             # <<<<<<<<<<<<<<
 *     if deg > 0:
 *         kernel = gaussian_array2d(0., 1., ddeg, ddeg, fwhm, sz, sz)
 */
  __pyx_tuple__53 = PyTuple_Pack(1, __pyx_kp_s_deg_must_be_0); if (unlikely(!__pyx_tuple__53)) __PYX_ERR(0, 1087, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__53);
  __Pyx_GIVEREF(__pyx_tuple__53);

  /* "orb/cutils.pyx":1093
 *         return kernel
 *     else:
 *         kernel.fill(1.)             # <<<<<<<<<<<<<<
 *         return kernel
 * 
 */
  __pyx_tuple__54 = PyTuple_Pack(1, __pyx_float_1_); if (unlikely(!__pyx_tuple__54)) __PYX_ERR(0, 1093, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__54);
  __Pyx_GIVEREF(__pyx_tuple__54);

  /* "orb/cutils.pyx":1124
 * 
 * 
 *     if deg < 0: raise Exception('deg must be >= 0')             # <<<<<<<<<<<<<<
 * 
 *     large_kernel = gaussian_array2d(0., 1.,
 */
  __pyx_tuple__55 = PyTuple_Pack(1, __pyx_kp_s_deg_must_be_0); if (unlikely(!__pyx_tuple__55)) __PYX_ERR(0, 1124, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__55);
  __Pyx_GIVEREF(__pyx_tuple__55);

  /* "orb/cutils.pyx":1318
 *             if stars_p_mask[ip] == 1:
 *                 free_p[i*stars_p.shape[0]:
 *                        (i+1)*stars_p.shape[0]] = stars_p[:,ip]             # <<<<<<<<<<<<<<
 *                 i += 1
 *             else:
 */
  __pyx_slice__60 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__60)) __PYX_ERR(0, 1318, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__60);
  __Pyx_GIVEREF(__pyx_slice__60);

  /* "orb/cutils.pyx":1322
 *             else:
 *                 fixed_p[j*stars_p.shape[0]:
 *                        (j+1)*stars_p.shape[0]] = stars_p[:,ip]             # <<<<<<<<<<<<<<
 *                 j += 1
 * 
 */
  __pyx_slice__61 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__61)) __PYX_ERR(0, 1322, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__61);
  __Pyx_GIVEREF(__pyx_slice__61);

  /* "orb/cutils.pyx":1352
 *         for ip in range(np.size(stars_p_mask)):
 *             if stars_p_mask[ip] == 1:
 *                 stars_p[:,ip] = free_p[i*stars_p.shape[0]:             # <<<<<<<<<<<<<<
 *                                        (i+1)*stars_p.shape[0]]
 *                 i += 1
 */
  __pyx_slice__62 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__62)) __PYX_ERR(0, 1352, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__62);
  __Pyx_GIVEREF(__pyx_slice__62);

  /* "orb/cutils.pyx":1356
 *                 i += 1
 *             else:
 *                 stars_p[:,ip] =  fixed_p[j*stars_p.shape[0]:             # <<<<<<<<<<<<<<
 *                                          (j+1)*stars_p.shape[0]]
 *                 j += 1
 */
  __pyx_slice__63 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__63)) __PYX_ERR(0, 1356, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__63);
  __Pyx_GIVEREF(__pyx_slice__63);

  /* "orb/cutils.pyx":1424
 *             hsz = <int> (<double> box_size / 2.)
 *             if int_posx - x_min != hsz:
 *                 star = star[hsz - (int_posx - x_min):,:]             # <<<<<<<<<<<<<<
 *             if x_max - int_posx != hsz + 1:
 *                 star = star[:-(hsz + 1 - (x_max - int_posx)), :]
 */
  __pyx_slice__64 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__64)) __PYX_ERR(0, 1424, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__64);
  __Pyx_GIVEREF(__pyx_slice__64);

  /* "orb/cutils.pyx":1426
 *                 star = star[hsz - (int_posx - x_min):,:]
 *             if x_max - int_posx != hsz + 1:
 *                 star = star[:-(hsz + 1 - (x_max - int_posx)), :]             # <<<<<<<<<<<<<<
 *             if int_posy - y_min != hsz:
 *                 star = star[:, hsz - (int_posy - y_min):]
 */
  __pyx_slice__65 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__65)) __PYX_ERR(0, 1426, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__65);
  __Pyx_GIVEREF(__pyx_slice__65);

  /* "orb/cutils.pyx":1428
 *                 star = star[:-(hsz + 1 - (x_max - int_posx)), :]
 *             if int_posy - y_min != hsz:
 *                 star = star[:, hsz - (int_posy - y_min):]             # <<<<<<<<<<<<<<
 *             if y_max - int_posy != hsz + 1:
 *                 star = star[:, :-(hsz + 1 - (y_max - int_posy))]
 */
  __pyx_slice__66 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__66)) __PYX_ERR(0, 1428, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__66);
  __Pyx_GIVEREF(__pyx_slice__66);

  /* "orb/cutils.pyx":1430
 *                 star = star[:, hsz - (int_posy - y_min):]
 *             if y_max - int_posy != hsz + 1:
 *                 star = star[:, :-(hsz + 1 - (y_max - int_posy))]             # <<<<<<<<<<<<<<
 * 
 *             if star.shape[0] > 1 and star.shape[1] > 1:
 */
  __pyx_slice__67 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__67)) __PYX_ERR(0, 1430, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__67);
  __Pyx_GIVEREF(__pyx_slice__67);

  /* "orb/cutils.pyx":1477
 * 
 *         params = np.copy(stars_p)
 *         params[:,0] += cov_p[0] # COV HEIGHT             # <<<<<<<<<<<<<<
 * 
 *         # COV FWHM: here FWHM covariance is best interpreted as the
 */
  __pyx_slice__68 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__68)) __PYX_ERR(0, 1477, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__68);
  __Pyx_GIVEREF(__pyx_slice__68);
  __pyx_tuple__69 = PyTuple_Pack(2, __pyx_slice__68, __pyx_int_0); if (unlikely(!__pyx_tuple__69)) __PYX_ERR(0, 1477, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__69);
  __Pyx_GIVEREF(__pyx_tuple__69);

  /* "orb/cutils.pyx":1484
 *         # the quadratic sum of the psf's.
 *         #params[:,4] += cov_p[3] # COV FWHM
 *         params[:,4] = np.sqrt(params[:,4]**2. + cov_p[3]**2.)             # <<<<<<<<<<<<<<
 * 
 *         # dx, dy & zoom & rotation
 */
  __pyx_slice__70 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__70)) __PYX_ERR(0, 1484, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__70);
  __Pyx_GIVEREF(__pyx_slice__70);
  __pyx_tuple__71 = PyTuple_Pack(2, __pyx_slice__70, __pyx_int_4); if (unlikely(!__pyx_tuple__71)) __PYX_ERR(0, 1484, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__71);
  __Pyx_GIVEREF(__pyx_tuple__71);
  __pyx_slice__72 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__72)) __PYX_ERR(0, 1484, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__72);
  __Pyx_GIVEREF(__pyx_slice__72);
  __pyx_tuple__73 = PyTuple_Pack(2, __pyx_slice__72, __pyx_int_4); if (unlikely(!__pyx_tuple__73)) __PYX_ERR(0, 1484, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__73);
  __Pyx_GIVEREF(__pyx_tuple__73);

  /* "orb/cutils.pyx":1493
 * 
 *         if sip is not None:
 *             params[:,2:4] = sip_im2pix(params[:,2:4], sip)             # <<<<<<<<<<<<<<
 * 
 *         res = model_diff(frame.shape[0], frame.shape[1],
 */
  __pyx_slice__74 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__74)) __PYX_ERR(0, 1493, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__74);
  __Pyx_GIVEREF(__pyx_slice__74);
  __pyx_slice__75 = PySlice_New(__pyx_int_2, __pyx_int_4, Py_None); if (unlikely(!__pyx_slice__75)) __PYX_ERR(0, 1493, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__75);
  __Pyx_GIVEREF(__pyx_slice__75);
  __pyx_tuple__76 = PyTuple_Pack(2, __pyx_slice__74, __pyx_slice__75); if (unlikely(!__pyx_tuple__76)) __PYX_ERR(0, 1493, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__76);
  __Pyx_GIVEREF(__pyx_tuple__76);
  __pyx_slice__77 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__77)) __PYX_ERR(0, 1493, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__77);
  __Pyx_GIVEREF(__pyx_slice__77);
  __pyx_slice__78 = PySlice_New(__pyx_int_2, __pyx_int_4, Py_None); if (unlikely(!__pyx_slice__78)) __PYX_ERR(0, 1493, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__78);
  __Pyx_GIVEREF(__pyx_slice__78);
  __pyx_tuple__79 = PyTuple_Pack(2, __pyx_slice__77, __pyx_slice__78); if (unlikely(!__pyx_tuple__79)) __PYX_ERR(0, 1493, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__79);
  __Pyx_GIVEREF(__pyx_tuple__79);

  /* "orb/cutils.pyx":1297
 *       distorsion correction (default None).
 *     """
 *     def params_arrays2vect(np.ndarray[np.float64_t, ndim=2] stars_p,             # <<<<<<<<<<<<<<
 *                            np.ndarray[np.float64_t, ndim=1] stars_p_mask,
 *                            np.ndarray[np.float64_t, ndim=1] cov_p,
 */
  __pyx_tuple__80 = PyTuple_Pack(11, __pyx_n_s_stars_p, __pyx_n_s_stars_p_mask, __pyx_n_s_cov_p, __pyx_n_s_cov_p_mask, __pyx_n_s_stars_free_p_nb, __pyx_n_s_cov_free_p_nb, __pyx_n_s_free_p, __pyx_n_s_fixed_p, __pyx_n_s_ip, __pyx_n_s_i, __pyx_n_s_j); if (unlikely(!__pyx_tuple__80)) __PYX_ERR(0, 1297, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__80);
  __Pyx_GIVEREF(__pyx_tuple__80);
  __pyx_codeobj__81 = (PyObject*)__Pyx_PyCode_New(4, 0, 11, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__80, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_params_arrays2vect, 1297, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__81)) __PYX_ERR(0, 1297, __pyx_L1_error)

  /* "orb/cutils.pyx":1334
 *         return free_p, fixed_p
 * 
 *     def params_vect2arrays(np.ndarray[np.float64_t, ndim=1] free_p,             # <<<<<<<<<<<<<<
 *                            np.ndarray[np.float64_t, ndim=1] fixed_p,
 *                            np.ndarray[np.float64_t, ndim=1] stars_p_mask,
 */
  __pyx_tuple__82 = PyTuple_Pack(12, __pyx_n_s_free_p, __pyx_n_s_fixed_p, __pyx_n_s_stars_p_mask, __pyx_n_s_cov_p_mask, __pyx_n_s_star_nb, __pyx_n_s_stars_free_p_nb, __pyx_n_s_cov_free_p_nb, __pyx_n_s_stars_p, __pyx_n_s_cov_p, __pyx_n_s_ip, __pyx_n_s_i, __pyx_n_s_j); if (unlikely(!__pyx_tuple__82)) __PYX_ERR(0, 1334, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__82);
  __Pyx_GIVEREF(__pyx_tuple__82);
  __pyx_codeobj__83 = (PyObject*)__Pyx_PyCode_New(5, 0, 12, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__82, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_params_vect2arrays, 1334, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__83)) __PYX_ERR(0, 1334, __pyx_L1_error)

  /* "orb/cutils.pyx":1367
 *         return stars_p, cov_p
 * 
 *     def sigma(np.ndarray[np.float64_t, ndim=2] data,             # <<<<<<<<<<<<<<
 *               double noise, double dcl):
 *         """guess sigma as sqrt(photon noise + readout noise^2 + dark
 */
  __pyx_tuple__84 = PyTuple_Pack(3, __pyx_n_s_data, __pyx_n_s_noise, __pyx_n_s_dcl); if (unlikely(!__pyx_tuple__84)) __PYX_ERR(0, 1367, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__84);
  __Pyx_GIVEREF(__pyx_tuple__84);
  __pyx_codeobj__85 = (PyObject*)__Pyx_PyCode_New(3, 0, 3, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__84, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_sigma, 1367, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__85)) __PYX_ERR(0, 1367, __pyx_L1_error)

  /* "orb/cutils.pyx":1373
 *         return np.sqrt(np.abs(data) + (noise)**2. + dcl)
 * 
 *     def model_diff(int dimx, int dimy, np.ndarray[np.float64_t, ndim=2] params,             # <<<<<<<<<<<<<<
 *                    int box_size, np.ndarray[np.float64_t, ndim=2] frame,
 *                    np.ndarray[np.float64_t, ndim=1] noise, double dcl,
 */
  __pyx_tuple__86 = PyTuple_Pack(23, __pyx_n_s_dimx, __pyx_n_s_dimy, __pyx_n_s_params, __pyx_n_s_box_size, __pyx_n_s_frame, __pyx_n_s_noise, __pyx_n_s_dcl, __pyx_n_s_saturation, __pyx_n_s_transpose, __pyx_n_s_normalize, __pyx_n_s_int_posx, __pyx_n_s_int_posy, __pyx_n_s_istar, __pyx_n_s_star, __pyx_n_s_data, __pyx_n_s_res, __pyx_n_s_dx, __pyx_n_s_dy, __pyx_n_s_x_min, __pyx_n_s_x_max, __pyx_n_s_y_min, __pyx_n_s_y_max, __pyx_n_s_hsz); if (unlikely(!__pyx_tuple__86)) __PYX_ERR(0, 1373, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__86);
  __Pyx_GIVEREF(__pyx_tuple__86);
  __pyx_codeobj__87 = (PyObject*)__Pyx_PyCode_New(10, 0, 23, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__86, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_model_diff, 1373, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__87)) __PYX_ERR(0, 1373, __pyx_L1_error)
  __pyx_tuple__88 = PyTuple_Pack(2, ((PyObject *)Py_False), ((PyObject *)Py_False)); if (unlikely(!__pyx_tuple__88)) __PYX_ERR(0, 1373, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__88);
  __Pyx_GIVEREF(__pyx_tuple__88);

  /* "orb/cutils.pyx":1452
 *         return res
 * 
 *     def diff(np.ndarray[np.float64_t, ndim=1] free_p,             # <<<<<<<<<<<<<<
 *              np.ndarray[np.float64_t, ndim=1] fixed_p,
 *              np.ndarray[np.float64_t, ndim=1] stars_p_mask,
 */
  __pyx_tuple__89 = PyTuple_Pack(18, __pyx_n_s_free_p, __pyx_n_s_fixed_p, __pyx_n_s_stars_p_mask, __pyx_n_s_cov_p_mask, __pyx_n_s_frame, __pyx_n_s_box_size, __pyx_n_s_star_nb, __pyx_n_s_noise, __pyx_n_s_dcl, __pyx_n_s_saturation, __pyx_n_s_sip, __pyx_n_s_params, __pyx_n_s_stars_p, __pyx_n_s_cov_p, __pyx_n_s_res, __pyx_n_s_rcx, __pyx_n_s_rcy, __pyx_n_s_istar); if (unlikely(!__pyx_tuple__89)) __PYX_ERR(0, 1452, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__89);
  __Pyx_GIVEREF(__pyx_tuple__89);
  __pyx_codeobj__90 = (PyObject*)__Pyx_PyCode_New(11, 0, 18, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__89, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_diff, 1452, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__90)) __PYX_ERR(0, 1452, __pyx_L1_error)

  /* "orb/cutils.pyx":1539
 *     cdef np.ndarray[np.float64_t, ndim=2] test_p = np.zeros_like(
 *         stars_p, dtype=float)
 *     cdef np.ndarray[np.float64_t, ndim=1] cov_p = np.zeros(             # <<<<<<<<<<<<<<
 *         7, dtype=float) # COV_P: HEIGHT, POSX, POSY, FWHM, ZOOMX, ZOOMY, ROT
 *     cdef np.ndarray[np.float64_t, ndim=1] cov_err = np.zeros_like(
 */
  __pyx_tuple__91 = PyTuple_Pack(1, __pyx_int_7); if (unlikely(!__pyx_tuple__91)) __PYX_ERR(0, 1539, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__91);
  __Pyx_GIVEREF(__pyx_tuple__91);

  /* "orb/cutils.pyx":1585
 * 
 *     # initial parameters
 *     stars_p[:,4] = fwhm_guess             # <<<<<<<<<<<<<<
 *     stars_p[:,2:4] = new_pos
 * 
 */
  __pyx_slice__92 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__92)) __PYX_ERR(0, 1585, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__92);
  __Pyx_GIVEREF(__pyx_slice__92);
  __pyx_tuple__93 = PyTuple_Pack(2, __pyx_slice__92, __pyx_int_4); if (unlikely(!__pyx_tuple__93)) __PYX_ERR(0, 1585, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__93);
  __Pyx_GIVEREF(__pyx_tuple__93);

  /* "orb/cutils.pyx":1586
 *     # initial parameters
 *     stars_p[:,4] = fwhm_guess
 *     stars_p[:,2:4] = new_pos             # <<<<<<<<<<<<<<
 * 
 *     # precise determination of the initial shift from the marginal
 */
  __pyx_slice__94 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__94)) __PYX_ERR(0, 1586, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__94);
  __Pyx_GIVEREF(__pyx_slice__94);
  __pyx_slice__95 = PySlice_New(__pyx_int_2, __pyx_int_4, Py_None); if (unlikely(!__pyx_slice__95)) __PYX_ERR(0, 1586, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__95);
  __Pyx_GIVEREF(__pyx_slice__95);
  __pyx_tuple__96 = PyTuple_Pack(2, __pyx_slice__94, __pyx_slice__95); if (unlikely(!__pyx_tuple__96)) __PYX_ERR(0, 1586, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__96);
  __Pyx_GIVEREF(__pyx_tuple__96);

  /* "orb/cutils.pyx":1591
 *     # distribution of the psf [e.g. Howell 2006]
 *     test_p = np.copy(stars_p)
 *     test_p[:,1] = 0.             # <<<<<<<<<<<<<<
 *     test_x = np.abs(bn.nansum(model_diff(frame.shape[0], frame.shape[1],
 *                                          test_p, box_size, frame,
 */
  __pyx_slice__97 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__97)) __PYX_ERR(0, 1591, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__97);
  __Pyx_GIVEREF(__pyx_slice__97);
  __pyx_tuple__98 = PyTuple_Pack(2, __pyx_slice__97, __pyx_int_1); if (unlikely(!__pyx_tuple__98)) __PYX_ERR(0, 1591, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__98);
  __Pyx_GIVEREF(__pyx_tuple__98);

  /* "orb/cutils.pyx":1636
 *         cov_p[2] = dy_guess
 *     else:
 *         stars_p[:,2] += dx_guess             # <<<<<<<<<<<<<<
 *         stars_p[:,3] += dy_guess
 * 
 */
  __pyx_slice__99 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__99)) __PYX_ERR(0, 1636, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__99);
  __Pyx_GIVEREF(__pyx_slice__99);
  __pyx_tuple__100 = PyTuple_Pack(2, __pyx_slice__99, __pyx_int_2); if (unlikely(!__pyx_tuple__100)) __PYX_ERR(0, 1636, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__100);
  __Pyx_GIVEREF(__pyx_tuple__100);

  /* "orb/cutils.pyx":1637
 *     else:
 *         stars_p[:,2] += dx_guess
 *         stars_p[:,3] += dy_guess             # <<<<<<<<<<<<<<
 * 
 *     # background and noise guess
 */
  __pyx_slice__101 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__101)) __PYX_ERR(0, 1637, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__101);
  __Pyx_GIVEREF(__pyx_slice__101);
  __pyx_tuple__102 = PyTuple_Pack(2, __pyx_slice__101, __pyx_int_3); if (unlikely(!__pyx_tuple__102)) __PYX_ERR(0, 1637, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__102);
  __Pyx_GIVEREF(__pyx_tuple__102);

  /* "orb/cutils.pyx":1650
 *         # in the box to avoid errors due to a cosmic ray.
 *         amp_guess[istar] = bn.nanmax(
 *             (np.sort(box.flatten()))[:-3])             # <<<<<<<<<<<<<<
 * 
 *         # define 'sky pixels'
 */
  __pyx_slice__103 = PySlice_New(Py_None, __pyx_int_neg_3, Py_None); if (unlikely(!__pyx_slice__103)) __PYX_ERR(0, 1650, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__103);
  __Pyx_GIVEREF(__pyx_slice__103);

  /* "orb/cutils.pyx":1662
 * 
 *         sky_pixels = box * S_sky
 *         sky_pixels = np.sort(sky_pixels[np.nonzero(sky_pixels)])[1:-1]             # <<<<<<<<<<<<<<
 *         # guess background
 *         stars_p[istar,0] = bn.nanmedian(sky_pixels)
 */
  __pyx_slice__104 = PySlice_New(__pyx_int_1, __pyx_int_neg_1, Py_None); if (unlikely(!__pyx_slice__104)) __PYX_ERR(0, 1662, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__104);
  __Pyx_GIVEREF(__pyx_slice__104);

  /* "orb/cutils.pyx":1671
 * 
 *     if not np.isnan(height_guess):
 *         stars_p[:,0] = height_guess             # <<<<<<<<<<<<<<
 * 
 *     # height guess
 */
  __pyx_slice__105 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__105)) __PYX_ERR(0, 1671, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__105);
  __Pyx_GIVEREF(__pyx_slice__105);
  __pyx_tuple__106 = PyTuple_Pack(2, __pyx_slice__105, __pyx_int_0); if (unlikely(!__pyx_tuple__106)) __PYX_ERR(0, 1671, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__106);
  __Pyx_GIVEREF(__pyx_tuple__106);

  /* "orb/cutils.pyx":1675
 *     # height guess
 *     amp_guess[np.isnan(amp_guess)] = 1.
 *     stars_p[:,1] = amp_guess - stars_p[:,0]             # <<<<<<<<<<<<<<
 * 
 *     if bn.anynan(stars_p): return []
 */
  __pyx_slice__107 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__107)) __PYX_ERR(0, 1675, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__107);
  __Pyx_GIVEREF(__pyx_slice__107);
  __pyx_tuple__108 = PyTuple_Pack(2, __pyx_slice__107, __pyx_int_0); if (unlikely(!__pyx_tuple__108)) __PYX_ERR(0, 1675, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__108);
  __Pyx_GIVEREF(__pyx_tuple__108);
  __pyx_slice__109 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__109)) __PYX_ERR(0, 1675, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__109);
  __Pyx_GIVEREF(__pyx_slice__109);
  __pyx_tuple__110 = PyTuple_Pack(2, __pyx_slice__109, __pyx_int_1); if (unlikely(!__pyx_tuple__110)) __PYX_ERR(0, 1675, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__110);
  __Pyx_GIVEREF(__pyx_tuple__110);

  /* "orb/cutils.pyx":1687
 * 
 *     # define masks and init cov_p
 *     cov_p_mask.fill(0)             # <<<<<<<<<<<<<<
 *     stars_p_mask.fill(1)
 *     cov_p[3] = 1. # cov fwhm starts at 1 for a quadratic sum
 */
  __pyx_tuple__111 = PyTuple_Pack(1, __pyx_int_0); if (unlikely(!__pyx_tuple__111)) __PYX_ERR(0, 1687, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__111);
  __Pyx_GIVEREF(__pyx_tuple__111);

  /* "orb/cutils.pyx":1688
 *     # define masks and init cov_p
 *     cov_p_mask.fill(0)
 *     stars_p_mask.fill(1)             # <<<<<<<<<<<<<<
 *     cov_p[3] = 1. # cov fwhm starts at 1 for a quadratic sum
 *     cov_p[4] = 1.
 */
  __pyx_tuple__112 = PyTuple_Pack(1, __pyx_int_1); if (unlikely(!__pyx_tuple__112)) __PYX_ERR(0, 1688, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__112);
  __Pyx_GIVEREF(__pyx_tuple__112);

  /* "orb/cutils.pyx":1698
 *         stars_p_mask[0] = 0
 *     if cov_pos and not fix_pos:
 *         cov_p_mask[1:3] = 1             # <<<<<<<<<<<<<<
 *         stars_p_mask[2:4] = 0
 *     if cov_fwhm and not fix_fwhm:
 */
  __pyx_slice__113 = PySlice_New(__pyx_int_1, __pyx_int_3, Py_None); if (unlikely(!__pyx_slice__113)) __PYX_ERR(0, 1698, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__113);
  __Pyx_GIVEREF(__pyx_slice__113);

  /* "orb/cutils.pyx":1699
 *     if cov_pos and not fix_pos:
 *         cov_p_mask[1:3] = 1
 *         stars_p_mask[2:4] = 0             # <<<<<<<<<<<<<<
 *     if cov_fwhm and not fix_fwhm:
 *         cov_p_mask[3] = 1
 */
  __pyx_slice__114 = PySlice_New(__pyx_int_2, __pyx_int_4, Py_None); if (unlikely(!__pyx_slice__114)) __PYX_ERR(0, 1699, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__114);
  __Pyx_GIVEREF(__pyx_slice__114);

  /* "orb/cutils.pyx":1704
 *         stars_p_mask[4] = 0
 *     if fix_height:  stars_p_mask[0] = 0
 *     if fix_pos: stars_p_mask[2:4] = 0             # <<<<<<<<<<<<<<
 *     if fix_fwhm: stars_p_mask[4] = 0
 *     if enable_zoom: cov_p_mask[4:6] = 1
 */
  __pyx_slice__115 = PySlice_New(__pyx_int_2, __pyx_int_4, Py_None); if (unlikely(!__pyx_slice__115)) __PYX_ERR(0, 1704, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__115);
  __Pyx_GIVEREF(__pyx_slice__115);

  /* "orb/cutils.pyx":1706
 *     if fix_pos: stars_p_mask[2:4] = 0
 *     if fix_fwhm: stars_p_mask[4] = 0
 *     if enable_zoom: cov_p_mask[4:6] = 1             # <<<<<<<<<<<<<<
 *     if enable_rotation: cov_p_mask[6] = 1
 * 
 */
  __pyx_slice__116 = PySlice_New(__pyx_int_4, __pyx_int_6, Py_None); if (unlikely(!__pyx_slice__116)) __PYX_ERR(0, 1706, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__116);
  __Pyx_GIVEREF(__pyx_slice__116);

  /* "orb/cutils.pyx":1743
 * 
 *         # cov height and fwhm
 *         stars_p[:,0] += cov_p[0] - added_height # HEIGHT             # <<<<<<<<<<<<<<
 *         stars_p[:,4] = np.sqrt(stars_p[:,4]**2. + cov_p[3]**2.) # FWHM
 *         # compute least square fit errors and add cov dx, dy and zoom
 */
  __pyx_slice__117 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__117)) __PYX_ERR(0, 1743, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__117);
  __Pyx_GIVEREF(__pyx_slice__117);
  __pyx_tuple__118 = PyTuple_Pack(2, __pyx_slice__117, __pyx_int_0); if (unlikely(!__pyx_tuple__118)) __PYX_ERR(0, 1743, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__118);
  __Pyx_GIVEREF(__pyx_tuple__118);

  /* "orb/cutils.pyx":1744
 *         # cov height and fwhm
 *         stars_p[:,0] += cov_p[0] - added_height # HEIGHT
 *         stars_p[:,4] = np.sqrt(stars_p[:,4]**2. + cov_p[3]**2.) # FWHM             # <<<<<<<<<<<<<<
 *         # compute least square fit errors and add cov dx, dy and zoom
 *         rcx = <double> frame.shape[0] / 2.
 */
  __pyx_slice__119 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__119)) __PYX_ERR(0, 1744, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__119);
  __Pyx_GIVEREF(__pyx_slice__119);
  __pyx_tuple__120 = PyTuple_Pack(2, __pyx_slice__119, __pyx_int_4); if (unlikely(!__pyx_tuple__120)) __PYX_ERR(0, 1744, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__120);
  __Pyx_GIVEREF(__pyx_tuple__120);
  __pyx_slice__121 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__121)) __PYX_ERR(0, 1744, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__121);
  __Pyx_GIVEREF(__pyx_slice__121);
  __pyx_tuple__122 = PyTuple_Pack(2, __pyx_slice__121, __pyx_int_4); if (unlikely(!__pyx_tuple__122)) __PYX_ERR(0, 1744, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__122);
  __Pyx_GIVEREF(__pyx_tuple__122);

  /* "orb/cutils.pyx":1758
 *                     cov_p[6], 0., 0., rcx, rcy, cov_p[4], cov_p[5])
 *             if sip is not None:
 *                 stars_p[:,2:4] = sip_im2pix(stars_p[:,2:4], sip)             # <<<<<<<<<<<<<<
 * 
 * 
 */
  __pyx_slice__123 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__123)) __PYX_ERR(0, 1758, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__123);
  __Pyx_GIVEREF(__pyx_slice__123);
  __pyx_slice__124 = PySlice_New(__pyx_int_2, __pyx_int_4, Py_None); if (unlikely(!__pyx_slice__124)) __PYX_ERR(0, 1758, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__124);
  __Pyx_GIVEREF(__pyx_slice__124);
  __pyx_tuple__125 = PyTuple_Pack(2, __pyx_slice__123, __pyx_slice__124); if (unlikely(!__pyx_tuple__125)) __PYX_ERR(0, 1758, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__125);
  __Pyx_GIVEREF(__pyx_tuple__125);
  __pyx_slice__126 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__126)) __PYX_ERR(0, 1758, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__126);
  __Pyx_GIVEREF(__pyx_slice__126);
  __pyx_slice__127 = PySlice_New(__pyx_int_2, __pyx_int_4, Py_None); if (unlikely(!__pyx_slice__127)) __PYX_ERR(0, 1758, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__127);
  __Pyx_GIVEREF(__pyx_slice__127);
  __pyx_tuple__128 = PyTuple_Pack(2, __pyx_slice__126, __pyx_slice__127); if (unlikely(!__pyx_tuple__128)) __PYX_ERR(0, 1758, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__128);
  __Pyx_GIVEREF(__pyx_tuple__128);

  /* "orb/cutils.pyx":1767
 *                           for i in range(cov_matrix.shape[0])])))
 * 
 *             fixed_p.fill(0.)             # <<<<<<<<<<<<<<
 *             stars_err, cov_err = params_vect2arrays(
 *                 cov_diag, fixed_p, stars_p_mask, cov_p_mask, star_nb)
 */
  __pyx_tuple__129 = PyTuple_Pack(1, __pyx_float_0_); if (unlikely(!__pyx_tuple__129)) __PYX_ERR(0, 1767, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__129);
  __Pyx_GIVEREF(__pyx_tuple__129);

  /* "orb/cutils.pyx":1771
 *                 cov_diag, fixed_p, stars_p_mask, cov_p_mask, star_nb)
 * 
 *             stars_err[:,0] += cov_err[0] # HEIGHT             # <<<<<<<<<<<<<<
 *             stars_err[:,4] += cov_err[3] # FWHM
 * 
 */
  __pyx_slice__130 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__130)) __PYX_ERR(0, 1771, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__130);
  __Pyx_GIVEREF(__pyx_slice__130);
  __pyx_tuple__131 = PyTuple_Pack(2, __pyx_slice__130, __pyx_int_0); if (unlikely(!__pyx_tuple__131)) __PYX_ERR(0, 1771, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__131);
  __Pyx_GIVEREF(__pyx_tuple__131);

  /* "orb/cutils.pyx":1772
 * 
 *             stars_err[:,0] += cov_err[0] # HEIGHT
 *             stars_err[:,4] += cov_err[3] # FWHM             # <<<<<<<<<<<<<<
 * 
 *             # compute transformed positions + error
 */
  __pyx_slice__132 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__132)) __PYX_ERR(0, 1772, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__132);
  __Pyx_GIVEREF(__pyx_slice__132);
  __pyx_tuple__133 = PyTuple_Pack(2, __pyx_slice__132, __pyx_int_4); if (unlikely(!__pyx_tuple__133)) __PYX_ERR(0, 1772, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__133);
  __Pyx_GIVEREF(__pyx_tuple__133);

  /* "orb/cutils.pyx":1789
 *                     return_err=True)
 *             if sip is not None:
 *                 stars_p[:,2:4] = sip_im2pix(stars_p[:,2:4], sip)             # <<<<<<<<<<<<<<
 * 
 *         # put nan in place of filtered stars
 */
  __pyx_slice__134 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__134)) __PYX_ERR(0, 1789, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__134);
  __Pyx_GIVEREF(__pyx_slice__134);
  __pyx_slice__135 = PySlice_New(__pyx_int_2, __pyx_int_4, Py_None); if (unlikely(!__pyx_slice__135)) __PYX_ERR(0, 1789, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__135);
  __Pyx_GIVEREF(__pyx_slice__135);
  __pyx_tuple__136 = PyTuple_Pack(2, __pyx_slice__134, __pyx_slice__135); if (unlikely(!__pyx_tuple__136)) __PYX_ERR(0, 1789, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__136);
  __Pyx_GIVEREF(__pyx_tuple__136);
  __pyx_slice__137 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__137)) __PYX_ERR(0, 1789, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__137);
  __Pyx_GIVEREF(__pyx_slice__137);
  __pyx_slice__138 = PySlice_New(__pyx_int_2, __pyx_int_4, Py_None); if (unlikely(!__pyx_slice__138)) __PYX_ERR(0, 1789, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__138);
  __Pyx_GIVEREF(__pyx_slice__138);
  __pyx_tuple__139 = PyTuple_Pack(2, __pyx_slice__137, __pyx_slice__138); if (unlikely(!__pyx_tuple__139)) __PYX_ERR(0, 1789, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__139);
  __Pyx_GIVEREF(__pyx_tuple__139);

  /* "orb/cutils.pyx":1797
 *         for istar in range(pos.shape[0]):
 *             if pos_mask[istar] == 1:
 *                 new_stars_p[istar,:] = stars_p[i]             # <<<<<<<<<<<<<<
 *                 new_stars_err[istar,:] = stars_err[i]
 *                 i += 1
 */
  __pyx_slice__140 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__140)) __PYX_ERR(0, 1797, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__140);
  __Pyx_GIVEREF(__pyx_slice__140);

  /* "orb/cutils.pyx":1798
 *             if pos_mask[istar] == 1:
 *                 new_stars_p[istar,:] = stars_p[i]
 *                 new_stars_err[istar,:] = stars_err[i]             # <<<<<<<<<<<<<<
 *                 i += 1
 *         stars_err = np.copy(new_stars_err)
 */
  __pyx_slice__141 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__141)) __PYX_ERR(0, 1798, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__141);
  __Pyx_GIVEREF(__pyx_slice__141);

  /* "orb/cutils.pyx":1922
 * 
 *     for ii in range(frame.shape[0]):
 *         icol = frame[ii,:]             # <<<<<<<<<<<<<<
 *         sign = np.sign(np.gradient(icol))
 *         diff = np.diff(sign)
 */
  __pyx_slice__142 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__142)) __PYX_ERR(0, 1922, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_slice__142);
  __Pyx_GIVEREF(__pyx_slice__142);

  /* "orb/cutils.pyx":2321
 *     :param corr: (Optional) Coefficient of correction (default 1.)
 *     """
 *     if order == 0: raise ValueError('Order cannot be 0 for a nm axis (minimum wavelength is infinite), use a cm-1 axis instead')             # <<<<<<<<<<<<<<
 *     return 1. / get_cm1_axis_max(n, step, order, corr=corr) * 1e7
 * 
 */
  __pyx_tuple__143 = PyTuple_Pack(1, __pyx_kp_s_Order_cannot_be_0_for_a_nm_axis); if (unlikely(!__pyx_tuple__143)) __PYX_ERR(0, 2321, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__143);
  __Pyx_GIVEREF(__pyx_tuple__143);

  /* "orb/cutils.pyx":2335
 *     :param corr: (Optional) Coefficient of correction (default 1.)
 *     """
 *     if order == 0: raise ValueError('Order cannot be 0 for a nm axis (minimum wavelength is infinite), use a cm-1 axis instead')             # <<<<<<<<<<<<<<
 *     return 1. / get_cm1_axis_min(n, step, order, corr=corr) * 1e7
 * 
 */
  __pyx_tuple__144 = PyTuple_Pack(1, __pyx_kp_s_Order_cannot_be_0_for_a_nm_axis); if (unlikely(!__pyx_tuple__144)) __PYX_ERR(0, 2335, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__144);
  __Pyx_GIVEREF(__pyx_tuple__144);

  /* "orb/cutils.pyx":2351
 *     if (order > 0):
 *         return 2. * step / (<double> order * <double> (order + 1) * corr) / <double> n
 *     else: raise ValueError('Order cannot be 0 for a nm axis (stepsize is infinite), use a cm-1 axis instead')             # <<<<<<<<<<<<<<
 * 
 * 
 */
  __pyx_tuple__145 = PyTuple_Pack(1, __pyx_kp_s_Order_cannot_be_0_for_a_nm_axis_2); if (unlikely(!__pyx_tuple__145)) __PYX_ERR(0, 2351, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__145);
  __Pyx_GIVEREF(__pyx_tuple__145);

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":218
 *             if ((flags & pybuf.PyBUF_C_CONTIGUOUS == pybuf.PyBUF_C_CONTIGUOUS)
 *                 and not PyArray_CHKFLAGS(self, NPY_C_CONTIGUOUS)):
 *                 raise ValueError(u"ndarray is not C contiguous")             # <<<<<<<<<<<<<<
 * 
 *             if ((flags & pybuf.PyBUF_F_CONTIGUOUS == pybuf.PyBUF_F_CONTIGUOUS)
 */
  __pyx_tuple__146 = PyTuple_Pack(1, __pyx_kp_u_ndarray_is_not_C_contiguous); if (unlikely(!__pyx_tuple__146)) __PYX_ERR(1, 218, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__146);
  __Pyx_GIVEREF(__pyx_tuple__146);

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":222
 *             if ((flags & pybuf.PyBUF_F_CONTIGUOUS == pybuf.PyBUF_F_CONTIGUOUS)
 *                 and not PyArray_CHKFLAGS(self, NPY_F_CONTIGUOUS)):
 *                 raise ValueError(u"ndarray is not Fortran contiguous")             # <<<<<<<<<<<<<<
 * 
 *             info.buf = PyArray_DATA(self)
 */
  __pyx_tuple__147 = PyTuple_Pack(1, __pyx_kp_u_ndarray_is_not_Fortran_contiguou); if (unlikely(!__pyx_tuple__147)) __PYX_ERR(1, 222, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__147);
  __Pyx_GIVEREF(__pyx_tuple__147);

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":259
 *                 if ((descr.byteorder == c'>' and little_endian) or
 *                     (descr.byteorder == c'<' and not little_endian)):
 *                     raise ValueError(u"Non-native byte order not supported")             # <<<<<<<<<<<<<<
 *                 if   t == NPY_BYTE:        f = "b"
 *                 elif t == NPY_UBYTE:       f = "B"
 */
  __pyx_tuple__148 = PyTuple_Pack(1, __pyx_kp_u_Non_native_byte_order_not_suppor); if (unlikely(!__pyx_tuple__148)) __PYX_ERR(1, 259, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__148);
  __Pyx_GIVEREF(__pyx_tuple__148);

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":799
 * 
 *         if (end - f) - <int>(new_offset - offset[0]) < 15:
 *             raise RuntimeError(u"Format string allocated too short, see comment in numpy.pxd")             # <<<<<<<<<<<<<<
 * 
 *         if ((child.byteorder == c'>' and little_endian) or
 */
  __pyx_tuple__149 = PyTuple_Pack(1, __pyx_kp_u_Format_string_allocated_too_shor); if (unlikely(!__pyx_tuple__149)) __PYX_ERR(1, 799, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__149);
  __Pyx_GIVEREF(__pyx_tuple__149);

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":803
 *         if ((child.byteorder == c'>' and little_endian) or
 *             (child.byteorder == c'<' and not little_endian)):
 *             raise ValueError(u"Non-native byte order not supported")             # <<<<<<<<<<<<<<
 *             # One could encode it in the format string and have Cython
 *             # complain instead, BUT: < and > in format strings also imply
 */
  __pyx_tuple__150 = PyTuple_Pack(1, __pyx_kp_u_Non_native_byte_order_not_suppor); if (unlikely(!__pyx_tuple__150)) __PYX_ERR(1, 803, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__150);
  __Pyx_GIVEREF(__pyx_tuple__150);

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":823
 *             t = child.type_num
 *             if end - f < 5:
 *                 raise RuntimeError(u"Format string allocated too short.")             # <<<<<<<<<<<<<<
 * 
 *             # Until ticket #99 is fixed, use integers to avoid warnings
 */
  __pyx_tuple__151 = PyTuple_Pack(1, __pyx_kp_u_Format_string_allocated_too_shor_2); if (unlikely(!__pyx_tuple__151)) __PYX_ERR(1, 823, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__151);
  __Pyx_GIVEREF(__pyx_tuple__151);

  /* "orb/cutils.pyx":66
 * ctypedef long double float128_t
 * 
 * def radians(double deg):             # <<<<<<<<<<<<<<
 *     """Convert degrees to radians
 *     """
 */
  __pyx_tuple__152 = PyTuple_Pack(2, __pyx_n_s_deg, __pyx_n_s_deg); if (unlikely(!__pyx_tuple__152)) __PYX_ERR(0, 66, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__152);
  __Pyx_GIVEREF(__pyx_tuple__152);
  __pyx_codeobj__153 = (PyObject*)__Pyx_PyCode_New(1, 0, 2, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__152, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_radians, 66, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__153)) __PYX_ERR(0, 66, __pyx_L1_error)

  /* "orb/cutils.pyx":72
 * 
 * 
 * def transform_B_to_A(double x1, double y1, double dx, double dy, double dr,             # <<<<<<<<<<<<<<
 *                      double da, double db, double xrc, double yrc, double zx,
 *                      double zy):
 */
  __pyx_tuple__154 = PyTuple_Pack(25, __pyx_n_s_x1, __pyx_n_s_y1, __pyx_n_s_dx, __pyx_n_s_dy, __pyx_n_s_dr, __pyx_n_s_da, __pyx_n_s_db, __pyx_n_s_xrc, __pyx_n_s_yrc, __pyx_n_s_zx, __pyx_n_s_zy, __pyx_n_s_x1_orig, __pyx_n_s_y1_orig, __pyx_n_s_x2_err, __pyx_n_s_y2_err, __pyx_n_s_a, __pyx_n_s_b, __pyx_n_s_c, __pyx_n_s_d, __pyx_n_s_a_err, __pyx_n_s_b_err, __pyx_n_s_c_err, __pyx_n_s_d_err, __pyx_n_s_x2, __pyx_n_s_y2); if (unlikely(!__pyx_tuple__154)) __PYX_ERR(0, 72, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__154);
  __Pyx_GIVEREF(__pyx_tuple__154);
  __pyx_codeobj__155 = (PyObject*)__Pyx_PyCode_New(11, 0, 25, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__154, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_transform_B_to_A, 72, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__155)) __PYX_ERR(0, 72, __pyx_L1_error)

  /* "orb/cutils.pyx":122
 *     return x2, y2
 * 
 * def transform_A_to_B(double x1, double y1, double dx, double dy, double dr,             # <<<<<<<<<<<<<<
 *                      double da, double db, double xrc, double yrc, double zx,
 *                      double zy,
 */
  __pyx_tuple__156 = PyTuple_Pack(33, __pyx_n_s_x1, __pyx_n_s_y1, __pyx_n_s_dx, __pyx_n_s_dy, __pyx_n_s_dr, __pyx_n_s_da, __pyx_n_s_db, __pyx_n_s_xrc, __pyx_n_s_yrc, __pyx_n_s_zx, __pyx_n_s_zy, __pyx_n_s_x1_err, __pyx_n_s_y1_err, __pyx_n_s_dx_err, __pyx_n_s_dy_err, __pyx_n_s_dr_err, __pyx_n_s_zx_err, __pyx_n_s_zy_err, __pyx_n_s_return_err, __pyx_n_s_x1_orig, __pyx_n_s_y1_orig, __pyx_n_s_x2_err, __pyx_n_s_y2_err, __pyx_n_s_a, __pyx_n_s_b, __pyx_n_s_c, __pyx_n_s_d, __pyx_n_s_a_err, __pyx_n_s_b_err, __pyx_n_s_c_err, __pyx_n_s_d_err, __pyx_n_s_x2, __pyx_n_s_y2); if (unlikely(!__pyx_tuple__156)) __PYX_ERR(0, 122, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__156);
  __Pyx_GIVEREF(__pyx_tuple__156);
  __pyx_codeobj__157 = (PyObject*)__Pyx_PyCode_New(19, 0, 33, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__156, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_transform_A_to_B, 122, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__157)) __PYX_ERR(0, 122, __pyx_L1_error)

  /* "orb/cutils.pyx":212
 *     return x2, y2
 * 
 * def sip_im2pix(np.ndarray[np.float64_t, ndim=2] im_coords, sip,             # <<<<<<<<<<<<<<
 *                tolerance=1e-8):
 *     """Transform perfect pixel positions to distorded pixels positions
 */
  __pyx_tuple__158 = PyTuple_Pack(5, __pyx_n_s_im_coords, __pyx_n_s_sip, __pyx_n_s_tolerance, __pyx_n_s_xcoord, __pyx_n_s_ycoord); if (unlikely(!__pyx_tuple__158)) __PYX_ERR(0, 212, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__158);
  __Pyx_GIVEREF(__pyx_tuple__158);
  __pyx_codeobj__159 = (PyObject*)__Pyx_PyCode_New(3, 0, 5, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__158, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_sip_im2pix, 212, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__159)) __PYX_ERR(0, 212, __pyx_L1_error)

  /* "orb/cutils.pyx":232
 *     return np.array([ycoord, xcoord]).T
 * 
 * def sip_pix2im(np.ndarray[np.float64_t, ndim=2] pix_coords, sip):             # <<<<<<<<<<<<<<
 *     """Transform distorded pixel positions to perfect pixels positions
 * 
 */
  __pyx_tuple__160 = PyTuple_Pack(4, __pyx_n_s_pix_coords, __pyx_n_s_sip, __pyx_n_s_xcoord, __pyx_n_s_ycoord); if (unlikely(!__pyx_tuple__160)) __PYX_ERR(0, 232, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__160);
  __Pyx_GIVEREF(__pyx_tuple__160);
  __pyx_codeobj__161 = (PyObject*)__Pyx_PyCode_New(2, 0, 4, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__160, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_sip_pix2im, 232, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__161)) __PYX_ERR(0, 232, __pyx_L1_error)

  /* "orb/cutils.pyx":252
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def create_transform_maps(int nx, int ny, double dx, double dy,             # <<<<<<<<<<<<<<
 *                           double dr, double da, double db, double xrc,
 *                           double yrc, double zx, double zy, sip_A, sip_B):
 */
  __pyx_tuple__162 = PyTuple_Pack(18, __pyx_n_s_nx, __pyx_n_s_ny, __pyx_n_s_dx, __pyx_n_s_dy, __pyx_n_s_dr, __pyx_n_s_da, __pyx_n_s_db, __pyx_n_s_xrc, __pyx_n_s_yrc, __pyx_n_s_zx, __pyx_n_s_zy, __pyx_n_s_sip_A, __pyx_n_s_sip_B, __pyx_n_s_outx, __pyx_n_s_outy, __pyx_n_s_coords, __pyx_n_s_ii, __pyx_n_s_ij); if (unlikely(!__pyx_tuple__162)) __PYX_ERR(0, 252, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__162);
  __Pyx_GIVEREF(__pyx_tuple__162);
  __pyx_codeobj__163 = (PyObject*)__Pyx_PyCode_New(13, 0, 18, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__162, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_create_transform_maps, 252, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__163)) __PYX_ERR(0, 252, __pyx_L1_error)

  /* "orb/cutils.pyx":318
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def gaussian_array2d(double h, double a, double dx, double dy, double fwhm,             # <<<<<<<<<<<<<<
 *                      int nx, int ny):
 *     """Return the 2D profile of a gaussian
 */
  __pyx_tuple__164 = PyTuple_Pack(12, __pyx_n_s_h, __pyx_n_s_a, __pyx_n_s_dx, __pyx_n_s_dy, __pyx_n_s_fwhm, __pyx_n_s_nx, __pyx_n_s_ny, __pyx_n_s_arr, __pyx_n_s_r, __pyx_n_s_w, __pyx_n_s_ii, __pyx_n_s_ij); if (unlikely(!__pyx_tuple__164)) __PYX_ERR(0, 318, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__164);
  __Pyx_GIVEREF(__pyx_tuple__164);
  __pyx_codeobj__165 = (PyObject*)__Pyx_PyCode_New(7, 0, 12, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__164, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_gaussian_array2d, 318, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__165)) __PYX_ERR(0, 318, __pyx_L1_error)

  /* "orb/cutils.pyx":344
 *     return arr
 * 
 * def moffat_array2d(double h, double a, double dx, double dy,             # <<<<<<<<<<<<<<
 *                    double fwhm, double beta, int nx, int ny):
 * 
 */
  __pyx_tuple__166 = PyTuple_Pack(14, __pyx_n_s_h, __pyx_n_s_a, __pyx_n_s_dx, __pyx_n_s_dy, __pyx_n_s_fwhm, __pyx_n_s_beta, __pyx_n_s_nx, __pyx_n_s_ny, __pyx_n_s_arr, __pyx_n_s_r, __pyx_n_s_w, __pyx_n_s_alpha, __pyx_n_s_ii, __pyx_n_s_ij); if (unlikely(!__pyx_tuple__166)) __PYX_ERR(0, 344, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__166);
  __Pyx_GIVEREF(__pyx_tuple__166);
  __pyx_codeobj__167 = (PyObject*)__Pyx_PyCode_New(8, 0, 14, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__166, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_moffat_array2d, 344, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__167)) __PYX_ERR(0, 344, __pyx_L1_error)

  /* "orb/cutils.pyx":377
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def surface_value(int dimx, int dimy, double xc, double yc, double rmin,             # <<<<<<<<<<<<<<
 *                   double rmax, long sub_div):
 *     """Return an approximation of the surface value of a pixel given
 */
  __pyx_tuple__168 = PyTuple_Pack(15, __pyx_n_s_dimx, __pyx_n_s_dimy, __pyx_n_s_xc, __pyx_n_s_yc, __pyx_n_s_rmin, __pyx_n_s_rmax, __pyx_n_s_sub_div, __pyx_n_s_dsub_div, __pyx_n_s_value, __pyx_n_s_isub, __pyx_n_s_jsub, __pyx_n_s_r, __pyx_n_s_sub_dimx, __pyx_n_s_sub_dimy, __pyx_n_s_S); if (unlikely(!__pyx_tuple__168)) __PYX_ERR(0, 377, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__168);
  __Pyx_GIVEREF(__pyx_tuple__168);
  __pyx_codeobj__169 = (PyObject*)__Pyx_PyCode_New(7, 0, 15, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__168, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_surface_value, 377, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__169)) __PYX_ERR(0, 377, __pyx_L1_error)

  /* "orb/cutils.pyx":421
 * 
 * 
 * def sigmacut(np.ndarray[np.float64_t, ndim=1] x, double central_value,             # <<<<<<<<<<<<<<
 *              int use_central_value, double sigma, int min_values,
 *              return_index_list=False):
 */
  __pyx_tuple__170 = PyTuple_Pack(13, __pyx_n_s_x, __pyx_n_s_central_value, __pyx_n_s_use_central_value, __pyx_n_s_sigma, __pyx_n_s_min_values, __pyx_n_s_return_index_list, __pyx_n_s_still_rejection, __pyx_n_s_central_x, __pyx_n_s_new_sz, __pyx_n_s_sz, __pyx_n_s_index_list, __pyx_n_s_std_x, __pyx_n_s_new_x); if (unlikely(!__pyx_tuple__170)) __PYX_ERR(0, 421, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__170);
  __Pyx_GIVEREF(__pyx_tuple__170);
  __pyx_codeobj__171 = (PyObject*)__Pyx_PyCode_New(6, 0, 13, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__170, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_sigmacut, 421, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__171)) __PYX_ERR(0, 421, __pyx_L1_error)

  /* "orb/cutils.pyx":482
 *         return x, index_list
 * 
 * def meansigcut2d(np.ndarray[np.float64_t, ndim=2] x, double sigma=3,             # <<<<<<<<<<<<<<
 *                  int min_values=3, int axis=0):
 *     """Return the sigma cut mean of a 2d array along a given axis.
 */
  __pyx_tuple__172 = PyTuple_Pack(9, __pyx_n_s_x, __pyx_n_s_sigma, __pyx_n_s_min_values, __pyx_n_s_axis, __pyx_n_s_i, __pyx_n_s_coaxis, __pyx_n_s_n, __pyx_n_s_line, __pyx_n_s_iline); if (unlikely(!__pyx_tuple__172)) __PYX_ERR(0, 482, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__172);
  __Pyx_GIVEREF(__pyx_tuple__172);
  __pyx_codeobj__173 = (PyObject*)__Pyx_PyCode_New(4, 0, 9, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__172, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_meansigcut2d, 482, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__173)) __PYX_ERR(0, 482, __pyx_L1_error)

  /* "orb/cutils.pyx":516
 * 
 * 
 * def sigmaclip(np.ndarray[np.float64_t, ndim=1] x, double sigma,             # <<<<<<<<<<<<<<
 *               int min_values):
 *     """Return a distribution after a sigma clipping rejection
 */
  __pyx_tuple__174 = PyTuple_Pack(11, __pyx_n_s_x, __pyx_n_s_sigma, __pyx_n_s_min_values, __pyx_n_s_still_rejection, __pyx_n_s_central_x, __pyx_n_s_sz, __pyx_n_s_new_sz, __pyx_n_s_med, __pyx_n_s_std, __pyx_n_s_min_mask, __pyx_n_s_max_mask); if (unlikely(!__pyx_tuple__174)) __PYX_ERR(0, 516, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__174);
  __Pyx_GIVEREF(__pyx_tuple__174);
  __pyx_codeobj__175 = (PyObject*)__Pyx_PyCode_New(3, 0, 11, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__174, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_sigmaclip, 516, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__175)) __PYX_ERR(0, 516, __pyx_L1_error)

  /* "orb/cutils.pyx":564
 *     return x[min_mask:max_mask+1]
 * 
 * def master_combine(np.ndarray[np.float64_t, ndim=3] frames, double sigma,             # <<<<<<<<<<<<<<
 *                    int nkeep, int combine_mode, int reject_mode,
 *                    return_std_frame=False):
 */
  __pyx_tuple__176 = PyTuple_Pack(22, __pyx_n_s_frames, __pyx_n_s_sigma, __pyx_n_s_nkeep, __pyx_n_s_combine_mode, __pyx_n_s_reject_mode, __pyx_n_s_return_std_frame, __pyx_n_s_stop_rejection, __pyx_n_s_dimx, __pyx_n_s_dimy, __pyx_n_s_dimz, __pyx_n_s_framesdiff, __pyx_n_s_argmax2d, __pyx_n_s_max2d, __pyx_n_s_sqrtmean2d, __pyx_n_s_rejects2d, __pyx_n_s_new_rejects2d, __pyx_n_s_mean2d, __pyx_n_s_std2d, __pyx_n_s_nans, __pyx_n_s_mask2d, __pyx_n_s_rejpix, __pyx_n_s_result); if (unlikely(!__pyx_tuple__176)) __PYX_ERR(0, 564, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__176);
  __Pyx_GIVEREF(__pyx_tuple__176);
  __pyx_codeobj__177 = (PyObject*)__Pyx_PyCode_New(6, 0, 22, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__176, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_master_combine, 564, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__177)) __PYX_ERR(0, 564, __pyx_L1_error)

  /* "orb/cutils.pyx":694
 * 
 * 
 * def _robust_format(np.ndarray x):             # <<<<<<<<<<<<<<
 *     """Format data and check if it can be computed by bottleneck module.
 * 
 */
  __pyx_tuple__178 = PyTuple_Pack(3, __pyx_n_s_x, __pyx_n_s_flag, __pyx_n_s_complexflag); if (unlikely(!__pyx_tuple__178)) __PYX_ERR(0, 694, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__178);
  __Pyx_GIVEREF(__pyx_tuple__178);
  __pyx_codeobj__179 = (PyObject*)__Pyx_PyCode_New(1, 0, 3, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__178, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_robust_format, 694, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__179)) __PYX_ERR(0, 694, __pyx_L1_error)

  /* "orb/cutils.pyx":722
 *     return x, flag, complexflag
 * 
 * def robust_mean(np.ndarray x):             # <<<<<<<<<<<<<<
 *     """Compute robust mean of a numpy ndarray (NaNs are skipped)
 * 
 */
  __pyx_tuple__180 = PyTuple_Pack(4, __pyx_n_s_x, __pyx_n_s_flag, __pyx_n_s_complexflag, __pyx_n_s_complexresult); if (unlikely(!__pyx_tuple__180)) __PYX_ERR(0, 722, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__180);
  __Pyx_GIVEREF(__pyx_tuple__180);
  __pyx_codeobj__181 = (PyObject*)__Pyx_PyCode_New(1, 0, 4, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__180, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_robust_mean, 722, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__181)) __PYX_ERR(0, 722, __pyx_L1_error)

  /* "orb/cutils.pyx":744
 * 
 * 
 * def robust_median(np.ndarray x):             # <<<<<<<<<<<<<<
 *     """Compute robust median of a numpy ndarray (NaNs are skipped)
 * 
 */
  __pyx_tuple__182 = PyTuple_Pack(4, __pyx_n_s_x, __pyx_n_s_flag, __pyx_n_s_complexflag, __pyx_n_s_complexresult); if (unlikely(!__pyx_tuple__182)) __PYX_ERR(0, 744, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__182);
  __Pyx_GIVEREF(__pyx_tuple__182);
  __pyx_codeobj__183 = (PyObject*)__Pyx_PyCode_New(1, 0, 4, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__182, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_robust_median, 744, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__183)) __PYX_ERR(0, 744, __pyx_L1_error)

  /* "orb/cutils.pyx":765
 *         return np.median(x)
 * 
 * def robust_sum(np.ndarray x):             # <<<<<<<<<<<<<<
 *     """Compute robust sum of a numpy ndarray (NaNs are skipped)
 * 
 */
  __pyx_tuple__184 = PyTuple_Pack(4, __pyx_n_s_x, __pyx_n_s_flag, __pyx_n_s_complexflag, __pyx_n_s_complexresult); if (unlikely(!__pyx_tuple__184)) __PYX_ERR(0, 765, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__184);
  __Pyx_GIVEREF(__pyx_tuple__184);
  __pyx_codeobj__185 = (PyObject*)__Pyx_PyCode_New(1, 0, 4, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__184, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_robust_sum, 765, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__185)) __PYX_ERR(0, 765, __pyx_L1_error)

  /* "orb/cutils.pyx":786
 *         return np.nansum(x)
 * 
 * def robust_std(np.ndarray x):             # <<<<<<<<<<<<<<
 *     """Compute robust std of a numpy ndarray (NaNs are skipped)
 * 
 */
  __pyx_tuple__186 = PyTuple_Pack(4, __pyx_n_s_x, __pyx_n_s_flag, __pyx_n_s_complexflag, __pyx_n_s_complexresult); if (unlikely(!__pyx_tuple__186)) __PYX_ERR(0, 786, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__186);
  __Pyx_GIVEREF(__pyx_tuple__186);
  __pyx_codeobj__187 = (PyObject*)__Pyx_PyCode_New(1, 0, 4, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__186, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_robust_std, 786, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__187)) __PYX_ERR(0, 786, __pyx_L1_error)

  /* "orb/cutils.pyx":807
 *         return np.nanstd(x)
 * 
 * def robust_average(np.ndarray x,             # <<<<<<<<<<<<<<
 *                    np.ndarray w):
 *     """Compute robust average of a numpy ndarray (NaNs are skipped)
 */
  __pyx_tuple__188 = PyTuple_Pack(8, __pyx_n_s_x, __pyx_n_s_w, __pyx_n_s_flagx, __pyx_n_s_flagw, __pyx_n_s_complexflagx, __pyx_n_s_complexflagw, __pyx_n_s_complexresult, __pyx_n_s_i); if (unlikely(!__pyx_tuple__188)) __PYX_ERR(0, 807, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__188);
  __Pyx_GIVEREF(__pyx_tuple__188);
  __pyx_codeobj__189 = (PyObject*)__Pyx_PyCode_New(2, 0, 8, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__188, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_robust_average, 807, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__189)) __PYX_ERR(0, 807, __pyx_L1_error)

  /* "orb/cutils.pyx":844
 *         return np.nanmean(x * w)
 * 
 * def gaussian1d(np.ndarray[np.float64_t, ndim=1] x,             # <<<<<<<<<<<<<<
 *                double h, double a, double dx, double fwhm):
 *     """Return a 1D gaussian given a set of parameters.
 */
  __pyx_tuple__190 = PyTuple_Pack(6, __pyx_n_s_x, __pyx_n_s_h, __pyx_n_s_a, __pyx_n_s_dx, __pyx_n_s_fwhm, __pyx_n_s_w); if (unlikely(!__pyx_tuple__190)) __PYX_ERR(0, 844, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__190);
  __Pyx_GIVEREF(__pyx_tuple__190);
  __pyx_codeobj__191 = (PyObject*)__Pyx_PyCode_New(5, 0, 6, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__190, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_gaussian1d, 844, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__191)) __PYX_ERR(0, 844, __pyx_L1_error)

  /* "orb/cutils.pyx":859
 *     return  h + a * np.exp(-(x - dx)**2. / (2. * w**2.))
 * 
 * def sinc1d(np.ndarray[np.float64_t, ndim=1] x,             # <<<<<<<<<<<<<<
 *            double h, double a, double dx, double fwhm):
 *     """Return a 1D sinc given a set of parameters.
 */
  __pyx_tuple__192 = PyTuple_Pack(6, __pyx_n_s_x, __pyx_n_s_h, __pyx_n_s_a, __pyx_n_s_dx, __pyx_n_s_fwhm, __pyx_n_s_X); if (unlikely(!__pyx_tuple__192)) __PYX_ERR(0, 859, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__192);
  __Pyx_GIVEREF(__pyx_tuple__192);
  __pyx_codeobj__193 = (PyObject*)__Pyx_PyCode_New(5, 0, 6, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__192, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_sinc1d, 859, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__193)) __PYX_ERR(0, 859, __pyx_L1_error)

  /* "orb/cutils.pyx":911
 * ##     return (h + a * e * (dawson1 - dawson2)).real
 * 
 * def interf_mean_energy(np.ndarray interf):             # <<<<<<<<<<<<<<
 *     """Return the mean energy of an interferogram by step.
 * 
 */
  __pyx_tuple__194 = PyTuple_Pack(2, __pyx_n_s_interf, __pyx_n_s_energy_sum); if (unlikely(!__pyx_tuple__194)) __PYX_ERR(0, 911, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__194);
  __Pyx_GIVEREF(__pyx_tuple__194);
  __pyx_codeobj__195 = (PyObject*)__Pyx_PyCode_New(1, 0, 2, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__194, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_interf_mean_energy, 911, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__195)) __PYX_ERR(0, 911, __pyx_L1_error)

  /* "orb/cutils.pyx":936
 *     return sqrt(energy_sum / <float> np.size(interf))
 * 
 * def spectrum_mean_energy(np.ndarray spectrum):             # <<<<<<<<<<<<<<
 *     """Return the mean energy of a spectrum by channel.
 * 
 */
  __pyx_tuple__196 = PyTuple_Pack(2, __pyx_n_s_spectrum, __pyx_n_s_energy_sum); if (unlikely(!__pyx_tuple__196)) __PYX_ERR(0, 936, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__196);
  __Pyx_GIVEREF(__pyx_tuple__196);
  __pyx_codeobj__197 = (PyObject*)__Pyx_PyCode_New(1, 0, 2, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__196, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_spectrum_mean_energy, 936, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__197)) __PYX_ERR(0, 936, __pyx_L1_error)

  /* "orb/cutils.pyx":952
 *     return sqrt(energy_sum) / <float> np.size(spectrum)
 * 
 * def fft_filter(np.ndarray[np.float64_t, ndim=1] a,             # <<<<<<<<<<<<<<
 *                 double cutoff, double width, bool lowpass):
 *     """
 */
  __pyx_tuple__198 = PyTuple_Pack(16, __pyx_n_s_a, __pyx_n_s_cutoff, __pyx_n_s_width, __pyx_n_s_lowpass, __pyx_n_s_n, __pyx_n_s_fn, __pyx_n_s_hwindow, __pyx_n_s_window, __pyx_n_s_icut, __pyx_n_s_wlen, __pyx_n_s_wsize, __pyx_n_s_w, __pyx_n_s_dx, __pyx_n_s_minx, __pyx_n_s_maxx, __pyx_n_s_median_a); if (unlikely(!__pyx_tuple__198)) __PYX_ERR(0, 952, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__198);
  __Pyx_GIVEREF(__pyx_tuple__198);
  __pyx_codeobj__199 = (PyObject*)__Pyx_PyCode_New(4, 0, 16, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__198, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_fft_filter, 952, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__199)) __PYX_ERR(0, 952, __pyx_L1_error)

  /* "orb/cutils.pyx":1025
 * 
 * 
 * def low_pass_image_filter(np.ndarray[np.float64_t, ndim=2] im, int deg):             # <<<<<<<<<<<<<<
 *     """Low pass image filter by convolution with a gaussian kernel.
 * 
 */
  __pyx_tuple__200 = PyTuple_Pack(12, __pyx_n_s_im, __pyx_n_s_deg, __pyx_n_s_real_nans, __pyx_n_s_new_nans, __pyx_n_s_final_im, __pyx_n_s_kernel, __pyx_n_s_kernel_mod, __pyx_n_s_box, __pyx_n_s_inan, __pyx_n_s_ix, __pyx_n_s_iy, __pyx_n_s_nans); if (unlikely(!__pyx_tuple__200)) __PYX_ERR(0, 1025, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__200);
  __Pyx_GIVEREF(__pyx_tuple__200);
  __pyx_codeobj__201 = (PyObject*)__Pyx_PyCode_New(2, 0, 12, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__200, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_low_pass_image_filter, 1025, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__201)) __PYX_ERR(0, 1025, __pyx_L1_error)

  /* "orb/cutils.pyx":1071
 *     return np.copy(final_im)
 * 
 * def fast_gaussian_kernel(int deg):             # <<<<<<<<<<<<<<
 *     """Return a fast gaussian kernel.
 * 
 */
  __pyx_tuple__202 = PyTuple_Pack(6, __pyx_n_s_deg, __pyx_n_s_deg, __pyx_n_s_ddeg, __pyx_n_s_sz, __pyx_n_s_fwhm, __pyx_n_s_kernel); if (unlikely(!__pyx_tuple__202)) __PYX_ERR(0, 1071, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__202);
  __Pyx_GIVEREF(__pyx_tuple__202);
  __pyx_codeobj__203 = (PyObject*)__Pyx_PyCode_New(1, 0, 6, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__202, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_fast_gaussian_kernel, 1071, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__203)) __PYX_ERR(0, 1071, __pyx_L1_error)

  /* "orb/cutils.pyx":1099
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def gaussian_kernel(double deg):             # <<<<<<<<<<<<<<
 *     """Return a gaussian kernel.
 * 
 */
  __pyx_tuple__204 = PyTuple_Pack(13, __pyx_n_s_deg, __pyx_n_s_deg, __pyx_n_s_ideg, __pyx_n_s_sz, __pyx_n_s_PRECISION_COEFF, __pyx_n_s_large_sz, __pyx_n_s_large_kernel, __pyx_n_s_fwhm, __pyx_n_s_kernel, __pyx_n_s_ii, __pyx_n_s_ij, __pyx_n_s_i, __pyx_n_s_j); if (unlikely(!__pyx_tuple__204)) __PYX_ERR(0, 1099, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__204);
  __Pyx_GIVEREF(__pyx_tuple__204);
  __pyx_codeobj__205 = (PyObject*)__Pyx_PyCode_New(1, 0, 13, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__204, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_gaussian_kernel, 1099, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__205)) __PYX_ERR(0, 1099, __pyx_L1_error)

  /* "orb/cutils.pyx":1142
 * 
 * 
 * def get_box_coords(int ix, int iy, int box_size,             # <<<<<<<<<<<<<<
 *                    int x_lim_min, int x_lim_max,
 *                    int y_lim_min, int y_lim_max):
 */
  __pyx_tuple__206 = PyTuple_Pack(11, __pyx_n_s_ix, __pyx_n_s_iy, __pyx_n_s_box_size, __pyx_n_s_x_lim_min, __pyx_n_s_x_lim_max, __pyx_n_s_y_lim_min, __pyx_n_s_y_lim_max, __pyx_n_s_x_min, __pyx_n_s_x_max, __pyx_n_s_y_min, __pyx_n_s_y_max); if (unlikely(!__pyx_tuple__206)) __PYX_ERR(0, 1142, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__206);
  __Pyx_GIVEREF(__pyx_tuple__206);
  __pyx_codeobj__207 = (PyObject*)__Pyx_PyCode_New(7, 0, 11, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__206, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_get_box_coords, 1142, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__207)) __PYX_ERR(0, 1142, __pyx_L1_error)

  /* "orb/cutils.pyx":1180
 * 
 * 
 * def point_inside_polygon(double x, double y, list poly):             # <<<<<<<<<<<<<<
 *     """ Determine if a point is inside a given polygon or not
 *     Polygon is a list of (x,y) pairs.
 */
  __pyx_tuple__208 = PyTuple_Pack(13, __pyx_n_s_x, __pyx_n_s_y, __pyx_n_s_poly, __pyx_n_s_n, __pyx_n_s_inside, __pyx_n_s_i, __pyx_n_s_p1x, __pyx_n_s_p1y, __pyx_n_s_p2x, __pyx_n_s_p2y, __pyx_n_s_xinters, __pyx_n_s_plx, __pyx_n_s_ply); if (unlikely(!__pyx_tuple__208)) __PYX_ERR(0, 1180, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__208);
  __Pyx_GIVEREF(__pyx_tuple__208);
  __pyx_codeobj__209 = (PyObject*)__Pyx_PyCode_New(3, 0, 13, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__208, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_point_inside_polygon, 1180, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__209)) __PYX_ERR(0, 1180, __pyx_L1_error)

  /* "orb/cutils.pyx":1208
 *     return inside
 * 
 * def multi_fit_stars(np.ndarray[np.float64_t, ndim=2] frame,             # <<<<<<<<<<<<<<
 *                     np.ndarray[np.float64_t, ndim=2] pos,
 *                     int box_size,
 */
  __pyx_tuple__210 = PyTuple_Pack(79, __pyx_n_s_frame, __pyx_n_s_pos, __pyx_n_s_box_size, __pyx_n_s_height_guess, __pyx_n_s_fwhm_guess, __pyx_n_s_cov_height, __pyx_n_s_cov_pos, __pyx_n_s_cov_fwhm, __pyx_n_s_fix_height, __pyx_n_s_fix_pos, __pyx_n_s_fix_fwhm, __pyx_n_s_fit_tol, __pyx_n_s_ron, __pyx_n_s_dcl, __pyx_n_s_enable_zoom, __pyx_n_s_enable_rotation, __pyx_n_s_estimate_local_noise, __pyx_n_s_saturation, __pyx_n_s_sip, __pyx_n_s_params_arrays2vect, __pyx_n_s_params_arrays2vect, __pyx_n_s_params_vect2arrays, __pyx_n_s_params_vect2arrays, __pyx_n_s_sigma, __pyx_n_s_sigma, __pyx_n_s_model_diff, __pyx_n_s_model_diff, __pyx_n_s_diff, __pyx_n_s_diff, __pyx_n_s_pos_mask, __pyx_n_s_istar, __pyx_n_s_new_pos, __pyx_n_s_PARAMS_NB, __pyx_n_s_star_nb, __pyx_n_s_stars_p, __pyx_n_s_fwhm_pix, __pyx_n_s_stars_err, __pyx_n_s_new_stars_p, __pyx_n_s_new_stars_err, __pyx_n_s_stars_p_mask, __pyx_n_s_test_p, __pyx_n_s_cov_p, __pyx_n_s_cov_err, __pyx_n_s_cov_p_mask, __pyx_n_s_frame_mask, __pyx_n_s_amp_guess, __pyx_n_s_free_p, __pyx_n_s_fixed_p, __pyx_n_s_test_x, __pyx_n_s_test_y, __pyx_n_s_x_min, __pyx_n_s_x_max, __pyx_n_s_y_min, __pyx_n_s_y_max, __pyx_n_s_rcx, __pyx_n_s_rcy, __pyx_n_s_noise_guess, __pyx_n_s_cov_matrix, __pyx_n_s_box, __pyx_n_s_dx_guess, __pyx_n_s_dy_guess, __pyx_n_s_dx_guess_arg, __pyx_n_s_dy_guess_arg, __pyx_n_s_added_height, __pyx_n_s_frame_min, __pyx_n_s_FWHM_SKY_COEFF, __pyx_n_s_SUB_DIV, __pyx_n_s_nzi, __pyx_n_s_nzj, __pyx_n_s_S_sky, __pyx_n_s_sky_pixels, __pyx_n_s_fit, __pyx_n_s_e, __pyx_n_s_returned_data, __pyx_n_s_last_diff, __pyx_n_s_chisq, __pyx_n_s_red_chisq, __pyx_n_s_cov_diag, __pyx_n_s_i); if (unlikely(!__pyx_tuple__210)) __PYX_ERR(0, 1208, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__210);
  __Pyx_GIVEREF(__pyx_tuple__210);
  __pyx_codeobj__211 = (PyObject*)__Pyx_PyCode_New(19, 0, 79, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__210, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_multi_fit_stars, 1208, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__211)) __PYX_ERR(0, 1208, __pyx_L1_error)

  /* "orb/cutils.pyx":1811
 * 
 * 
 * def part_value(np.ndarray[np.float64_t, ndim=1] distrib, double coeff):             # <<<<<<<<<<<<<<
 *     """Return the value lying between two parts of a partition
 * 
 */
  __pyx_tuple__212 = PyTuple_Pack(4, __pyx_n_s_distrib, __pyx_n_s_coeff, __pyx_n_s_cleaned_distrib, __pyx_n_s_k); if (unlikely(!__pyx_tuple__212)) __PYX_ERR(0, 1811, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__212);
  __Pyx_GIVEREF(__pyx_tuple__212);
  __pyx_codeobj__213 = (PyObject*)__Pyx_PyCode_New(2, 0, 4, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__212, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_part_value, 1811, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__213)) __PYX_ERR(0, 1811, __pyx_L1_error)

  /* "orb/cutils.pyx":1838
 *     return bn.partition(cleaned_distrib, k)[k]
 * 
 * def indft(np.ndarray[np.float64_t, ndim=1] a,             # <<<<<<<<<<<<<<
 *           np.ndarray[np.float64_t, ndim=1] x):
 *     """Inverse Non-uniform Discret Fourier Transform.
 */
  __pyx_tuple__214 = PyTuple_Pack(10, __pyx_n_s_a, __pyx_n_s_x, __pyx_n_s_N, __pyx_n_s_M, __pyx_n_s_angle, __pyx_n_s_m, __pyx_n_s_n, __pyx_n_s_f, __pyx_n_s_freal, __pyx_n_s_fimag); if (unlikely(!__pyx_tuple__214)) __PYX_ERR(0, 1838, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__214);
  __Pyx_GIVEREF(__pyx_tuple__214);
  __pyx_codeobj__215 = (PyObject*)__Pyx_PyCode_New(2, 0, 10, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__214, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_indft, 1838, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__215)) __PYX_ERR(0, 1838, __pyx_L1_error)

  /* "orb/cutils.pyx":1869
 *     return f / N
 * 
 * def dft(np.ndarray[np.float64_t, ndim=1] a,             # <<<<<<<<<<<<<<
 *         np.ndarray[np.float64_t, ndim=1] x):
 *     """Discret Fourier Transform.
 */
  __pyx_tuple__216 = PyTuple_Pack(10, __pyx_n_s_a, __pyx_n_s_x, __pyx_n_s_N, __pyx_n_s_M, __pyx_n_s_angle, __pyx_n_s_m, __pyx_n_s_n, __pyx_n_s_f, __pyx_n_s_freal, __pyx_n_s_fimag); if (unlikely(!__pyx_tuple__216)) __PYX_ERR(0, 1869, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__216);
  __Pyx_GIVEREF(__pyx_tuple__216);
  __pyx_codeobj__217 = (PyObject*)__Pyx_PyCode_New(2, 0, 10, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__216, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_dft, 1869, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__217)) __PYX_ERR(0, 1869, __pyx_L1_error)

  /* "orb/cutils.pyx":1901
 * 
 * 
 * def map_me(np.ndarray[np.float64_t, ndim=2] frame):             # <<<<<<<<<<<<<<
 *     """Create a map of the modulation efficiency from a laser frame.
 * 
 */
  __pyx_tuple__218 = PyTuple_Pack(13, __pyx_n_s_frame, __pyx_n_s_me, __pyx_n_s_icol, __pyx_n_s_sign, __pyx_n_s_diff, __pyx_n_s_ii, __pyx_n_s_ij, __pyx_n_s_imin, __pyx_n_s_imax, __pyx_n_s_vmin, __pyx_n_s_vmax, __pyx_n_s_nans, __pyx_n_s_maxs); if (unlikely(!__pyx_tuple__218)) __PYX_ERR(0, 1901, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__218);
  __Pyx_GIVEREF(__pyx_tuple__218);
  __pyx_codeobj__219 = (PyObject*)__Pyx_PyCode_New(1, 0, 13, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__218, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_map_me, 1901, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__219)) __PYX_ERR(0, 1901, __pyx_L1_error)

  /* "orb/cutils.pyx":1942
 * 
 * 
 * def nanbin_image(np.ndarray[np.float64_t, ndim=2] im, int binning):             # <<<<<<<<<<<<<<
 *     """Mean image binning robust to NaNs.
 * 
 */
  __pyx_tuple__220 = PyTuple_Pack(11, __pyx_n_s_im, __pyx_n_s_binning, __pyx_n_s_out, __pyx_n_s_x_range, __pyx_n_s_y_range, __pyx_n_s_ii, __pyx_n_s_ij, __pyx_n_s_xmin, __pyx_n_s_xmax, __pyx_n_s_ymin, __pyx_n_s_ymax); if (unlikely(!__pyx_tuple__220)) __PYX_ERR(0, 1942, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__220);
  __Pyx_GIVEREF(__pyx_tuple__220);
  __pyx_codeobj__221 = (PyObject*)__Pyx_PyCode_New(2, 0, 11, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__220, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_nanbin_image, 1942, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__221)) __PYX_ERR(0, 1942, __pyx_L1_error)

  /* "orb/cutils.pyx":1974
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def unbin_image(np.ndarray[np.float64_t, ndim=2] im,             # <<<<<<<<<<<<<<
 *                 int nx, int ny):
 *     """Unbin a binned image (restore the image binned with the
 */
  __pyx_tuple__222 = PyTuple_Pack(26, __pyx_n_s_im, __pyx_n_s_nx, __pyx_n_s_ny, __pyx_n_s_out, __pyx_n_s_xaxis, __pyx_n_s_yaxis, __pyx_n_s_binx, __pyx_n_s_biny, __pyx_n_s_ii, __pyx_n_s_ij, __pyx_n_s_x1, __pyx_n_s_x2, __pyx_n_s_y1, __pyx_n_s_y2, __pyx_n_s_q11, __pyx_n_s_q12, __pyx_n_s_q21, __pyx_n_s_q22, __pyx_n_s_x, __pyx_n_s_y, __pyx_n_s_dimx, __pyx_n_s_dimy, __pyx_n_s_x1d, __pyx_n_s_y1d, __pyx_n_s_x2d, __pyx_n_s_y2d); if (unlikely(!__pyx_tuple__222)) __PYX_ERR(0, 1974, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__222);
  __Pyx_GIVEREF(__pyx_tuple__222);
  __pyx_codeobj__223 = (PyObject*)__Pyx_PyCode_New(3, 0, 26, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__222, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_unbin_image, 1974, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__223)) __PYX_ERR(0, 1974, __pyx_L1_error)

  /* "orb/cutils.pyx":2034
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def im2rgba(np.ndarray[np.float64_t, ndim=2] im,             # <<<<<<<<<<<<<<
 *             mpl_colorbar,
 *             double vmin, double vmax,
 */
  __pyx_tuple__224 = PyTuple_Pack(23, __pyx_n_s_im, __pyx_n_s_mpl_colorbar, __pyx_n_s_vmin, __pyx_n_s_vmax, __pyx_n_s_xmin, __pyx_n_s_xmax, __pyx_n_s_ymin, __pyx_n_s_ymax, __pyx_n_s_computed_pixels, __pyx_n_s_last_arr8, __pyx_n_s_res, __pyx_n_s_color_values, __pyx_n_s_color_mapper, __pyx_n_s_arr8, __pyx_n_s_x_range, __pyx_n_s_y_range, __pyx_n_s_ii, __pyx_n_s_ij, __pyx_n_s_index, __pyx_n_s_ir, __pyx_n_s_n, __pyx_n_s_pix_to_compute, __pyx_n_s_ik); if (unlikely(!__pyx_tuple__224)) __PYX_ERR(0, 2034, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__224);
  __Pyx_GIVEREF(__pyx_tuple__224);
  __pyx_codeobj__225 = (PyObject*)__Pyx_PyCode_New(11, 0, 23, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__224, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_im2rgba, 2034, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__225)) __PYX_ERR(0, 2034, __pyx_L1_error)

  /* "orb/cutils.pyx":2101
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def brute_photometry(np.ndarray[np.float64_t, ndim=2] im,             # <<<<<<<<<<<<<<
 *                      np.ndarray[np.float64_t, ndim=2] star_list,
 *                      np.ndarray[np.float64_t, ndim=2] kernel,
 */
  __pyx_tuple__226 = PyTuple_Pack(18, __pyx_n_s_im, __pyx_n_s_star_list, __pyx_n_s_kernel, __pyx_n_s_box_size, __pyx_n_s_total_flux, __pyx_n_s_star_nb, __pyx_n_s_istar, __pyx_n_s_x_min, __pyx_n_s_x_max, __pyx_n_s_y_min, __pyx_n_s_y_max, __pyx_n_s_dimx, __pyx_n_s_dimy, __pyx_n_s_ii, __pyx_n_s_ij, __pyx_n_s_ix, __pyx_n_s_iy, __pyx_n_s_val); if (unlikely(!__pyx_tuple__226)) __PYX_ERR(0, 2101, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__226);
  __Pyx_GIVEREF(__pyx_tuple__226);
  __pyx_codeobj__227 = (PyObject*)__Pyx_PyCode_New(4, 0, 18, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__226, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_brute_photometry, 2101, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__227)) __PYX_ERR(0, 2101, __pyx_L1_error)

  /* "orb/cutils.pyx":2138
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def detect_cosmic_rays(np.ndarray[np.float64_t, ndim=2] frame,             # <<<<<<<<<<<<<<
 *                        crs_list, int box_size, double detect_coeff):
 *     """Check if a given pixel is a cosmic ray (classic detection).
 */
  __pyx_tuple__228 = PyTuple_Pack(17, __pyx_n_s_frame, __pyx_n_s_crs_list, __pyx_n_s_box_size, __pyx_n_s_detect_coeff, __pyx_n_s_workframe, __pyx_n_s_cr_map, __pyx_n_s_cr_list_len, __pyx_n_s_icr, __pyx_n_s_ix, __pyx_n_s_iy, __pyx_n_s_xmin, __pyx_n_s_xmax, __pyx_n_s_ymin, __pyx_n_s_ymax, __pyx_n_s_boxmed, __pyx_n_s_boxstd, __pyx_n_s_box); if (unlikely(!__pyx_tuple__228)) __PYX_ERR(0, 2138, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__228);
  __Pyx_GIVEREF(__pyx_tuple__228);
  __pyx_codeobj__229 = (PyObject*)__Pyx_PyCode_New(4, 0, 17, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__228, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_detect_cosmic_rays, 2138, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__229)) __PYX_ERR(0, 2138, __pyx_L1_error)

  /* "orb/cutils.pyx":2187
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def check_cosmic_rays_neighbourhood(             # <<<<<<<<<<<<<<
 *     np.ndarray[np.float64_t, ndim=2] frame,
 *     np.ndarray[np.uint8_t, ndim=2] cr_map,
 */
  __pyx_tuple__230 = PyTuple_Pack(19, __pyx_n_s_frame, __pyx_n_s_cr_map, __pyx_n_s_box_size, __pyx_n_s_detect_coeff, __pyx_n_s_workframe, __pyx_n_s_inewcr, __pyx_n_s_icr, __pyx_n_s_ix, __pyx_n_s_iy, __pyx_n_s_xmin, __pyx_n_s_xmax, __pyx_n_s_ymin, __pyx_n_s_ymax, __pyx_n_s_ii, __pyx_n_s_ij, __pyx_n_s_box, __pyx_n_s_boxmed, __pyx_n_s_boxstd, __pyx_n_s_crs_list); if (unlikely(!__pyx_tuple__230)) __PYX_ERR(0, 2187, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__230);
  __Pyx_GIVEREF(__pyx_tuple__230);
  __pyx_codeobj__231 = (PyObject*)__Pyx_PyCode_New(4, 0, 19, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__230, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_check_cosmic_rays_neighbourhood, 2187, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__231)) __PYX_ERR(0, 2187, __pyx_L1_error)

  /* "orb/cutils.pyx":2234
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def fast_w2pix(np.ndarray[np.float64_t, ndim=1] w,             # <<<<<<<<<<<<<<
 *                double axis_min, double axis_step):
 *     """Fast conversion of wavelength/wavenumber to pixel
 */
  __pyx_tuple__232 = PyTuple_Pack(3, __pyx_n_s_w, __pyx_n_s_axis_min, __pyx_n_s_axis_step); if (unlikely(!__pyx_tuple__232)) __PYX_ERR(0, 2234, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__232);
  __Pyx_GIVEREF(__pyx_tuple__232);
  __pyx_codeobj__233 = (PyObject*)__Pyx_PyCode_New(3, 0, 3, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__232, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_fast_w2pix, 2234, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__233)) __PYX_ERR(0, 2234, __pyx_L1_error)

  /* "orb/cutils.pyx":2248
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def fast_pix2w(np.ndarray[np.float64_t, ndim=1] pix,             # <<<<<<<<<<<<<<
 *                double axis_min, double axis_step):
 *     """Fast conversion of pixel to wavelength/wavenumber
 */
  __pyx_tuple__234 = PyTuple_Pack(3, __pyx_n_s_pix, __pyx_n_s_axis_min, __pyx_n_s_axis_step); if (unlikely(!__pyx_tuple__234)) __PYX_ERR(0, 2248, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__234);
  __Pyx_GIVEREF(__pyx_tuple__234);
  __pyx_codeobj__235 = (PyObject*)__Pyx_PyCode_New(3, 0, 3, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__234, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_fast_pix2w, 2248, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__235)) __PYX_ERR(0, 2248, __pyx_L1_error)

  /* "orb/cutils.pyx":2261
 * 
 * 
 * def get_cm1_axis_min(int n, double step, int order, double corr=1.):             # <<<<<<<<<<<<<<
 *     """Return min wavenumber of a regular wavenumber axis in cm-1.
 * 
 */
  __pyx_tuple__236 = PyTuple_Pack(5, __pyx_n_s_n, __pyx_n_s_step, __pyx_n_s_order, __pyx_n_s_corr, __pyx_n_s_cm1_min); if (unlikely(!__pyx_tuple__236)) __PYX_ERR(0, 2261, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__236);
  __Pyx_GIVEREF(__pyx_tuple__236);
  __pyx_codeobj__237 = (PyObject*)__Pyx_PyCode_New(4, 0, 5, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__236, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_get_cm1_axis_min, 2261, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__237)) __PYX_ERR(0, 2261, __pyx_L1_error)

  /* "orb/cutils.pyx":2280
 *     return cm1_min
 * 
 * def get_cm1_axis_max(int n, double step, int order, double corr=1.):             # <<<<<<<<<<<<<<
 *     """Return max wavenumber of a regular wavenumber axis in cm-1.
 * 
 */
  __pyx_tuple__238 = PyTuple_Pack(5, __pyx_n_s_n, __pyx_n_s_step, __pyx_n_s_order, __pyx_n_s_corr, __pyx_n_s_cm1_max); if (unlikely(!__pyx_tuple__238)) __PYX_ERR(0, 2280, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__238);
  __Pyx_GIVEREF(__pyx_tuple__238);
  __pyx_codeobj__239 = (PyObject*)__Pyx_PyCode_New(4, 0, 5, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__238, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_get_cm1_axis_max, 2280, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__239)) __PYX_ERR(0, 2280, __pyx_L1_error)

  /* "orb/cutils.pyx":2299
 *     return cm1_max
 * 
 * def get_cm1_axis_step(int n, double step, double corr=1.):             # <<<<<<<<<<<<<<
 *     """Return step size of a regular wavenumber axis in cm-1.
 * 
 */
  __pyx_tuple__240 = PyTuple_Pack(3, __pyx_n_s_n, __pyx_n_s_step, __pyx_n_s_corr); if (unlikely(!__pyx_tuple__240)) __PYX_ERR(0, 2299, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__240);
  __Pyx_GIVEREF(__pyx_tuple__240);
  __pyx_codeobj__241 = (PyObject*)__Pyx_PyCode_New(3, 0, 3, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__240, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_get_cm1_axis_step, 2299, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__241)) __PYX_ERR(0, 2299, __pyx_L1_error)

  /* "orb/cutils.pyx":2310
 *     return corr / (2. * <double> n * step) * 1e7
 * 
 * def get_nm_axis_min(int n, double step, int order, double corr=1.):             # <<<<<<<<<<<<<<
 *     """Return min wavelength of regular wavelength axis in nm.
 * 
 */
  __pyx_tuple__242 = PyTuple_Pack(4, __pyx_n_s_n, __pyx_n_s_step, __pyx_n_s_order, __pyx_n_s_corr); if (unlikely(!__pyx_tuple__242)) __PYX_ERR(0, 2310, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__242);
  __Pyx_GIVEREF(__pyx_tuple__242);
  __pyx_codeobj__243 = (PyObject*)__Pyx_PyCode_New(4, 0, 4, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__242, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_get_nm_axis_min, 2310, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__243)) __PYX_ERR(0, 2310, __pyx_L1_error)

  /* "orb/cutils.pyx":2324
 *     return 1. / get_cm1_axis_max(n, step, order, corr=corr) * 1e7
 * 
 * def get_nm_axis_max(int n, double step, int order, double corr=1.):             # <<<<<<<<<<<<<<
 *     """Return max wavelength of regular wavelength axis in nm.
 * 
 */
  __pyx_tuple__244 = PyTuple_Pack(4, __pyx_n_s_n, __pyx_n_s_step, __pyx_n_s_order, __pyx_n_s_corr); if (unlikely(!__pyx_tuple__244)) __PYX_ERR(0, 2324, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__244);
  __Pyx_GIVEREF(__pyx_tuple__244);
  __pyx_codeobj__245 = (PyObject*)__Pyx_PyCode_New(4, 0, 4, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__244, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_get_nm_axis_max, 2324, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__245)) __PYX_ERR(0, 2324, __pyx_L1_error)

  /* "orb/cutils.pyx":2338
 *     return 1. / get_cm1_axis_min(n, step, order, corr=corr) * 1e7
 * 
 * def get_nm_axis_step(int n, double step, int order, double corr=1.):             # <<<<<<<<<<<<<<
 *     """Return step size of a regular wavelength axis in nm.
 * 
 */
  __pyx_tuple__246 = PyTuple_Pack(4, __pyx_n_s_n, __pyx_n_s_step, __pyx_n_s_order, __pyx_n_s_corr); if (unlikely(!__pyx_tuple__246)) __PYX_ERR(0, 2338, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__246);
  __Pyx_GIVEREF(__pyx_tuple__246);
  __pyx_codeobj__247 = (PyObject*)__Pyx_PyCode_New(4, 0, 4, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__246, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_get_nm_axis_step, 2338, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__247)) __PYX_ERR(0, 2338, __pyx_L1_error)

  /* "orb/cutils.pyx":2356
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def filter_background(np.ndarray[np.float64_t, ndim=2] frame,             # <<<<<<<<<<<<<<
 *                       int box_size, int big_box_coeff):
 *     """Replace each pixel by the value in a box around it minus the
 */
  __pyx_tuple__248 = PyTuple_Pack(23, __pyx_n_s_frame, __pyx_n_s_box_size, __pyx_n_s_big_box_coeff, __pyx_n_s_workframe, __pyx_n_s_box, __pyx_n_s_back, __pyx_n_s_ii, __pyx_n_s_ij, __pyx_n_s_dimx, __pyx_n_s_dimy, __pyx_n_s_back_size, __pyx_n_s_nans, __pyx_n_s_ik, __pyx_n_s_mean_box, __pyx_n_s_median_back, __pyx_n_s_xmin, __pyx_n_s_xmax, __pyx_n_s_ymin, __pyx_n_s_ymax, __pyx_n_s_xminb, __pyx_n_s_xmaxb, __pyx_n_s_yminb, __pyx_n_s_ymaxb); if (unlikely(!__pyx_tuple__248)) __PYX_ERR(0, 2356, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__248);
  __Pyx_GIVEREF(__pyx_tuple__248);
  __pyx_codeobj__249 = (PyObject*)__Pyx_PyCode_New(3, 0, 23, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__248, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_filter_background, 2356, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__249)) __PYX_ERR(0, 2356, __pyx_L1_error)

  /* "orb/cutils.pyx":2408
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def mean2d(np.ndarray[np.float64_t, ndim=2] box):             # <<<<<<<<<<<<<<
 *     """Return the mean of a 2d box with no GIL
 * 
 */
  __pyx_tuple__250 = PyTuple_Pack(7, __pyx_n_s_box, __pyx_n_s_ii, __pyx_n_s_ij, __pyx_n_s_dimx, __pyx_n_s_dimy, __pyx_n_s_nb, __pyx_n_s_val); if (unlikely(!__pyx_tuple__250)) __PYX_ERR(0, 2408, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__250);
  __Pyx_GIVEREF(__pyx_tuple__250);
  __pyx_codeobj__251 = (PyObject*)__Pyx_PyCode_New(1, 0, 7, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__250, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_mean2d, 2408, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__251)) __PYX_ERR(0, 2408, __pyx_L1_error)

  /* "orb/cutils.pyx":2432
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def median2d(np.ndarray[np.float64_t, ndim=2] box):             # <<<<<<<<<<<<<<
 *     """Return the median of a 2d box with no GIL
 * 
 */
  __pyx_tuple__252 = PyTuple_Pack(7, __pyx_n_s_box, __pyx_n_s_ii, __pyx_n_s_ij, __pyx_n_s_dimx, __pyx_n_s_dimy, __pyx_n_s_nb, __pyx_n_s_box_s); if (unlikely(!__pyx_tuple__252)) __PYX_ERR(0, 2432, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_tuple__252);
  __Pyx_GIVEREF(__pyx_tuple__252);
  __pyx_codeobj__253 = (PyObject*)__Pyx_PyCode_New(1, 0, 7, 0, 0, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__252, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_opt_orbs_orb_orb_code_orb_cutil, __pyx_n_s_median2d, 2432, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__253)) __PYX_ERR(0, 2432, __pyx_L1_error)
  __Pyx_RefNannyFinishContext();
  return 0;
  __pyx_L1_error:;
  __Pyx_RefNannyFinishContext();
  return -1;
}

static int __Pyx_InitGlobals(void) {
  if (__Pyx_InitStrings(__pyx_string_tab) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
  __pyx_float_0_ = PyFloat_FromDouble(0.); if (unlikely(!__pyx_float_0_)) __PYX_ERR(0, 1, __pyx_L1_error)
  __pyx_float_1_ = PyFloat_FromDouble(1.); if (unlikely(!__pyx_float_1_)) __PYX_ERR(0, 1, __pyx_L1_error)
  __pyx_float_2_ = PyFloat_FromDouble(2.); if (unlikely(!__pyx_float_2_)) __PYX_ERR(0, 1, __pyx_L1_error)
  __pyx_float_1e7 = PyFloat_FromDouble(1e7); if (unlikely(!__pyx_float_1e7)) __PYX_ERR(0, 1, __pyx_L1_error)
  __pyx_float_1eneg_8 = PyFloat_FromDouble(1e-8); if (unlikely(!__pyx_float_1eneg_8)) __PYX_ERR(0, 1, __pyx_L1_error)
  __pyx_int_0 = PyInt_FromLong(0); if (unlikely(!__pyx_int_0)) __PYX_ERR(0, 1, __pyx_L1_error)
  __pyx_int_1 = PyInt_FromLong(1); if (unlikely(!__pyx_int_1)) __PYX_ERR(0, 1, __pyx_L1_error)
  __pyx_int_2 = PyInt_FromLong(2); if (unlikely(!__pyx_int_2)) __PYX_ERR(0, 1, __pyx_L1_error)
  __pyx_int_3 = PyInt_FromLong(3); if (unlikely(!__pyx_int_3)) __PYX_ERR(0, 1, __pyx_L1_error)
  __pyx_int_4 = PyInt_FromLong(4); if (unlikely(!__pyx_int_4)) __PYX_ERR(0, 1, __pyx_L1_error)
  __pyx_int_5 = PyInt_FromLong(5); if (unlikely(!__pyx_int_5)) __PYX_ERR(0, 1, __pyx_L1_error)
  __pyx_int_6 = PyInt_FromLong(6); if (unlikely(!__pyx_int_6)) __PYX_ERR(0, 1, __pyx_L1_error)
  __pyx_int_7 = PyInt_FromLong(7); if (unlikely(!__pyx_int_7)) __PYX_ERR(0, 1, __pyx_L1_error)
  __pyx_int_255 = PyInt_FromLong(255); if (unlikely(!__pyx_int_255)) __PYX_ERR(0, 1, __pyx_L1_error)
  __pyx_int_500 = PyInt_FromLong(500); if (unlikely(!__pyx_int_500)) __PYX_ERR(0, 1, __pyx_L1_error)
  __pyx_int_neg_1 = PyInt_FromLong(-1); if (unlikely(!__pyx_int_neg_1)) __PYX_ERR(0, 1, __pyx_L1_error)
  __pyx_int_neg_3 = PyInt_FromLong(-3); if (unlikely(!__pyx_int_neg_3)) __PYX_ERR(0, 1, __pyx_L1_error)
  return 0;
  __pyx_L1_error:;
  return -1;
}

#if PY_MAJOR_VERSION < 3
PyMODINIT_FUNC initcutils(void); /*proto*/
PyMODINIT_FUNC initcutils(void)
#else
PyMODINIT_FUNC PyInit_cutils(void); /*proto*/
PyMODINIT_FUNC PyInit_cutils(void)
#endif
{
  PyObject *__pyx_t_1 = NULL;
  PyObject *__pyx_t_2 = NULL;
  double __pyx_t_3;
  PyObject *__pyx_t_4 = NULL;
  PyObject *__pyx_t_5 = NULL;
  __Pyx_RefNannyDeclarations
  #if CYTHON_REFNANNY
  __Pyx_RefNanny = __Pyx_RefNannyImportAPI("refnanny");
  if (!__Pyx_RefNanny) {
      PyErr_Clear();
      __Pyx_RefNanny = __Pyx_RefNannyImportAPI("Cython.Runtime.refnanny");
      if (!__Pyx_RefNanny)
          Py_FatalError("failed to import 'refnanny' module");
  }
  #endif
  __Pyx_RefNannySetupContext("PyMODINIT_FUNC PyInit_cutils(void)", 0);
  if (__Pyx_check_binary_version() < 0) __PYX_ERR(0, 1, __pyx_L1_error)
  __pyx_empty_tuple = PyTuple_New(0); if (unlikely(!__pyx_empty_tuple)) __PYX_ERR(0, 1, __pyx_L1_error)
  __pyx_empty_bytes = PyBytes_FromStringAndSize("", 0); if (unlikely(!__pyx_empty_bytes)) __PYX_ERR(0, 1, __pyx_L1_error)
  __pyx_empty_unicode = PyUnicode_FromStringAndSize("", 0); if (unlikely(!__pyx_empty_unicode)) __PYX_ERR(0, 1, __pyx_L1_error)
  #ifdef __Pyx_CyFunction_USED
  if (__pyx_CyFunction_init() < 0) __PYX_ERR(0, 1, __pyx_L1_error)
  #endif
  #ifdef __Pyx_FusedFunction_USED
  if (__pyx_FusedFunction_init() < 0) __PYX_ERR(0, 1, __pyx_L1_error)
  #endif
  #ifdef __Pyx_Coroutine_USED
  if (__pyx_Coroutine_init() < 0) __PYX_ERR(0, 1, __pyx_L1_error)
  #endif
  #ifdef __Pyx_Generator_USED
  if (__pyx_Generator_init() < 0) __PYX_ERR(0, 1, __pyx_L1_error)
  #endif
  #ifdef __Pyx_StopAsyncIteration_USED
  if (__pyx_StopAsyncIteration_init() < 0) __PYX_ERR(0, 1, __pyx_L1_error)
  #endif
  /*--- Library function declarations ---*/
  /*--- Threads initialization code ---*/
  #if defined(__PYX_FORCE_INIT_THREADS) && __PYX_FORCE_INIT_THREADS
  #ifdef WITH_THREAD /* Python build with threading support? */
  PyEval_InitThreads();
  #endif
  #endif
  /*--- Module creation code ---*/
  #if PY_MAJOR_VERSION < 3
  __pyx_m = Py_InitModule4("cutils", __pyx_methods, __pyx_k_CUtils_is_a_set_of_C_functions, 0, PYTHON_API_VERSION); Py_XINCREF(__pyx_m);
  #else
  __pyx_m = PyModule_Create(&__pyx_moduledef);
  #endif
  if (unlikely(!__pyx_m)) __PYX_ERR(0, 1, __pyx_L1_error)
  __pyx_d = PyModule_GetDict(__pyx_m); if (unlikely(!__pyx_d)) __PYX_ERR(0, 1, __pyx_L1_error)
  Py_INCREF(__pyx_d);
  __pyx_b = PyImport_AddModule(__Pyx_BUILTIN_MODULE_NAME); if (unlikely(!__pyx_b)) __PYX_ERR(0, 1, __pyx_L1_error)
  #if CYTHON_COMPILING_IN_PYPY
  Py_INCREF(__pyx_b);
  #endif
  if (PyObject_SetAttrString(__pyx_m, "__builtins__", __pyx_b) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
  /*--- Initialize various global constants etc. ---*/
  if (__Pyx_InitGlobals() < 0) __PYX_ERR(0, 1, __pyx_L1_error)
  #if PY_MAJOR_VERSION < 3 && (__PYX_DEFAULT_STRING_ENCODING_IS_ASCII || __PYX_DEFAULT_STRING_ENCODING_IS_DEFAULT)
  if (__Pyx_init_sys_getdefaultencoding_params() < 0) __PYX_ERR(0, 1, __pyx_L1_error)
  #endif
  if (__pyx_module_is_main_orb__cutils) {
    if (PyObject_SetAttrString(__pyx_m, "__name__", __pyx_n_s_main) < 0) __PYX_ERR(0, 1, __pyx_L1_error)
  }
  #if PY_MAJOR_VERSION >= 3
  {
    PyObject *modules = PyImport_GetModuleDict(); if (unlikely(!modules)) __PYX_ERR(0, 1, __pyx_L1_error)
    if (!PyDict_GetItemString(modules, "orb.cutils")) {
      if (unlikely(PyDict_SetItemString(modules, "orb.cutils", __pyx_m) < 0)) __PYX_ERR(0, 1, __pyx_L1_error)
    }
  }
  #endif
  /*--- Builtin init code ---*/
  if (__Pyx_InitCachedBuiltins() < 0) __PYX_ERR(0, 1, __pyx_L1_error)
  /*--- Constants init code ---*/
  if (__Pyx_InitCachedConstants() < 0) __PYX_ERR(0, 1, __pyx_L1_error)
  /*--- Global init code ---*/
  /*--- Variable export code ---*/
  /*--- Function export code ---*/
  /*--- Type init code ---*/
  if (PyType_Ready(&__pyx_type_3orb_6cutils___pyx_scope_struct__multi_fit_stars) < 0) __PYX_ERR(0, 1208, __pyx_L1_error)
  __pyx_type_3orb_6cutils___pyx_scope_struct__multi_fit_stars.tp_print = 0;
  __pyx_ptype_3orb_6cutils___pyx_scope_struct__multi_fit_stars = &__pyx_type_3orb_6cutils___pyx_scope_struct__multi_fit_stars;
  /*--- Type import code ---*/
  __pyx_ptype_7cpython_4type_type = __Pyx_ImportType(__Pyx_BUILTIN_MODULE_NAME, "type", 
  #if CYTHON_COMPILING_IN_PYPY
  sizeof(PyTypeObject),
  #else
  sizeof(PyHeapTypeObject),
  #endif
  0); if (unlikely(!__pyx_ptype_7cpython_4type_type)) __PYX_ERR(2, 9, __pyx_L1_error)
  __pyx_ptype_7cpython_4bool_bool = __Pyx_ImportType(__Pyx_BUILTIN_MODULE_NAME, "bool", sizeof(PyBoolObject), 0); if (unlikely(!__pyx_ptype_7cpython_4bool_bool)) __PYX_ERR(3, 8, __pyx_L1_error)
  __pyx_ptype_7cpython_7complex_complex = __Pyx_ImportType(__Pyx_BUILTIN_MODULE_NAME, "complex", sizeof(PyComplexObject), 0); if (unlikely(!__pyx_ptype_7cpython_7complex_complex)) __PYX_ERR(4, 15, __pyx_L1_error)
  __pyx_ptype_5numpy_dtype = __Pyx_ImportType("numpy", "dtype", sizeof(PyArray_Descr), 0); if (unlikely(!__pyx_ptype_5numpy_dtype)) __PYX_ERR(1, 155, __pyx_L1_error)
  __pyx_ptype_5numpy_flatiter = __Pyx_ImportType("numpy", "flatiter", sizeof(PyArrayIterObject), 0); if (unlikely(!__pyx_ptype_5numpy_flatiter)) __PYX_ERR(1, 168, __pyx_L1_error)
  __pyx_ptype_5numpy_broadcast = __Pyx_ImportType("numpy", "broadcast", sizeof(PyArrayMultiIterObject), 0); if (unlikely(!__pyx_ptype_5numpy_broadcast)) __PYX_ERR(1, 172, __pyx_L1_error)
  __pyx_ptype_5numpy_ndarray = __Pyx_ImportType("numpy", "ndarray", sizeof(PyArrayObject), 0); if (unlikely(!__pyx_ptype_5numpy_ndarray)) __PYX_ERR(1, 181, __pyx_L1_error)
  __pyx_ptype_5numpy_ufunc = __Pyx_ImportType("numpy", "ufunc", sizeof(PyUFuncObject), 0); if (unlikely(!__pyx_ptype_5numpy_ufunc)) __PYX_ERR(1, 861, __pyx_L1_error)
  /*--- Variable import code ---*/
  /*--- Function import code ---*/
  /*--- Execution code ---*/
  #if defined(__Pyx_Generator_USED) || defined(__Pyx_Coroutine_USED)
  if (__Pyx_patch_abc() < 0) __PYX_ERR(0, 1, __pyx_L1_error)
  #endif

  /* "orb/cutils.pyx":39
 * """
 * cimport cython
 * import numpy as np             # <<<<<<<<<<<<<<
 * cimport numpy as np
 * import time
 */
  __pyx_t_1 = __Pyx_Import(__pyx_n_s_numpy, 0, -1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 39, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_np, __pyx_t_1) < 0) __PYX_ERR(0, 39, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":41
 * import numpy as np
 * cimport numpy as np
 * import time             # <<<<<<<<<<<<<<
 * import scipy.ndimage.filters
 * import scipy.optimize
 */
  __pyx_t_1 = __Pyx_Import(__pyx_n_s_time, 0, -1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 41, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_time, __pyx_t_1) < 0) __PYX_ERR(0, 41, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":42
 * cimport numpy as np
 * import time
 * import scipy.ndimage.filters             # <<<<<<<<<<<<<<
 * import scipy.optimize
 * import scipy.interpolate
 */
  __pyx_t_1 = __Pyx_Import(__pyx_n_s_scipy_ndimage_filters, 0, -1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 42, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_scipy, __pyx_t_1) < 0) __PYX_ERR(0, 42, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":43
 * import time
 * import scipy.ndimage.filters
 * import scipy.optimize             # <<<<<<<<<<<<<<
 * import scipy.interpolate
 * import scipy.special
 */
  __pyx_t_1 = __Pyx_Import(__pyx_n_s_scipy_optimize, 0, -1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 43, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_scipy, __pyx_t_1) < 0) __PYX_ERR(0, 43, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":44
 * import scipy.ndimage.filters
 * import scipy.optimize
 * import scipy.interpolate             # <<<<<<<<<<<<<<
 * import scipy.special
 * import constants
 */
  __pyx_t_1 = __Pyx_Import(__pyx_n_s_scipy_interpolate, 0, -1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 44, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_scipy, __pyx_t_1) < 0) __PYX_ERR(0, 44, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":45
 * import scipy.optimize
 * import scipy.interpolate
 * import scipy.special             # <<<<<<<<<<<<<<
 * import constants
 * 
 */
  __pyx_t_1 = __Pyx_Import(__pyx_n_s_scipy_special, 0, -1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 45, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_scipy, __pyx_t_1) < 0) __PYX_ERR(0, 45, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":46
 * import scipy.interpolate
 * import scipy.special
 * import constants             # <<<<<<<<<<<<<<
 * 
 * import bottleneck as bn # https://pypi.python.org/pypi/Bottleneck
 */
  __pyx_t_1 = __Pyx_Import(__pyx_n_s_constants, 0, -1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 46, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_constants, __pyx_t_1) < 0) __PYX_ERR(0, 46, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":48
 * import constants
 * 
 * import bottleneck as bn # https://pypi.python.org/pypi/Bottleneck             # <<<<<<<<<<<<<<
 * from cpython cimport bool
 * 
 */
  __pyx_t_1 = __Pyx_Import(__pyx_n_s_bottleneck, 0, -1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 48, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_bn, __pyx_t_1) < 0) __PYX_ERR(0, 48, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":66
 * ctypedef long double float128_t
 * 
 * def radians(double deg):             # <<<<<<<<<<<<<<
 *     """Convert degrees to radians
 *     """
 */
  __pyx_t_1 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_1radians, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 66, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_radians, __pyx_t_1) < 0) __PYX_ERR(0, 66, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":72
 * 
 * 
 * def transform_B_to_A(double x1, double y1, double dx, double dy, double dr,             # <<<<<<<<<<<<<<
 *                      double da, double db, double xrc, double yrc, double zx,
 *                      double zy):
 */
  __pyx_t_1 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_3transform_B_to_A, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 72, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_transform_B_to_A, __pyx_t_1) < 0) __PYX_ERR(0, 72, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":122
 *     return x2, y2
 * 
 * def transform_A_to_B(double x1, double y1, double dx, double dy, double dr,             # <<<<<<<<<<<<<<
 *                      double da, double db, double xrc, double yrc, double zx,
 *                      double zy,
 */
  __pyx_t_1 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_5transform_A_to_B, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 122, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_transform_A_to_B, __pyx_t_1) < 0) __PYX_ERR(0, 122, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":212
 *     return x2, y2
 * 
 * def sip_im2pix(np.ndarray[np.float64_t, ndim=2] im_coords, sip,             # <<<<<<<<<<<<<<
 *                tolerance=1e-8):
 *     """Transform perfect pixel positions to distorded pixels positions
 */
  __pyx_t_1 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_7sip_im2pix, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 212, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_sip_im2pix, __pyx_t_1) < 0) __PYX_ERR(0, 212, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":232
 *     return np.array([ycoord, xcoord]).T
 * 
 * def sip_pix2im(np.ndarray[np.float64_t, ndim=2] pix_coords, sip):             # <<<<<<<<<<<<<<
 *     """Transform distorded pixel positions to perfect pixels positions
 * 
 */
  __pyx_t_1 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_9sip_pix2im, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 232, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_sip_pix2im, __pyx_t_1) < 0) __PYX_ERR(0, 232, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":252
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def create_transform_maps(int nx, int ny, double dx, double dy,             # <<<<<<<<<<<<<<
 *                           double dr, double da, double db, double xrc,
 *                           double yrc, double zx, double zy, sip_A, sip_B):
 */
  __pyx_t_1 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_11create_transform_maps, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 252, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_create_transform_maps, __pyx_t_1) < 0) __PYX_ERR(0, 252, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":318
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def gaussian_array2d(double h, double a, double dx, double dy, double fwhm,             # <<<<<<<<<<<<<<
 *                      int nx, int ny):
 *     """Return the 2D profile of a gaussian
 */
  __pyx_t_1 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_13gaussian_array2d, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 318, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_gaussian_array2d, __pyx_t_1) < 0) __PYX_ERR(0, 318, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":344
 *     return arr
 * 
 * def moffat_array2d(double h, double a, double dx, double dy,             # <<<<<<<<<<<<<<
 *                    double fwhm, double beta, int nx, int ny):
 * 
 */
  __pyx_t_1 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_15moffat_array2d, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 344, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_moffat_array2d, __pyx_t_1) < 0) __PYX_ERR(0, 344, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":377
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def surface_value(int dimx, int dimy, double xc, double yc, double rmin,             # <<<<<<<<<<<<<<
 *                   double rmax, long sub_div):
 *     """Return an approximation of the surface value of a pixel given
 */
  __pyx_t_1 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_17surface_value, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 377, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_surface_value, __pyx_t_1) < 0) __PYX_ERR(0, 377, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":421
 * 
 * 
 * def sigmacut(np.ndarray[np.float64_t, ndim=1] x, double central_value,             # <<<<<<<<<<<<<<
 *              int use_central_value, double sigma, int min_values,
 *              return_index_list=False):
 */
  __pyx_t_1 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_19sigmacut, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 421, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_sigmacut, __pyx_t_1) < 0) __PYX_ERR(0, 421, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":482
 *         return x, index_list
 * 
 * def meansigcut2d(np.ndarray[np.float64_t, ndim=2] x, double sigma=3,             # <<<<<<<<<<<<<<
 *                  int min_values=3, int axis=0):
 *     """Return the sigma cut mean of a 2d array along a given axis.
 */
  __pyx_t_1 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_21meansigcut2d, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 482, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_meansigcut2d, __pyx_t_1) < 0) __PYX_ERR(0, 482, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":516
 * 
 * 
 * def sigmaclip(np.ndarray[np.float64_t, ndim=1] x, double sigma,             # <<<<<<<<<<<<<<
 *               int min_values):
 *     """Return a distribution after a sigma clipping rejection
 */
  __pyx_t_1 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_23sigmaclip, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 516, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_sigmaclip, __pyx_t_1) < 0) __PYX_ERR(0, 516, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":564
 *     return x[min_mask:max_mask+1]
 * 
 * def master_combine(np.ndarray[np.float64_t, ndim=3] frames, double sigma,             # <<<<<<<<<<<<<<
 *                    int nkeep, int combine_mode, int reject_mode,
 *                    return_std_frame=False):
 */
  __pyx_t_1 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_25master_combine, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 564, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_master_combine, __pyx_t_1) < 0) __PYX_ERR(0, 564, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":694
 * 
 * 
 * def _robust_format(np.ndarray x):             # <<<<<<<<<<<<<<
 *     """Format data and check if it can be computed by bottleneck module.
 * 
 */
  __pyx_t_1 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_27_robust_format, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 694, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_robust_format, __pyx_t_1) < 0) __PYX_ERR(0, 694, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":722
 *     return x, flag, complexflag
 * 
 * def robust_mean(np.ndarray x):             # <<<<<<<<<<<<<<
 *     """Compute robust mean of a numpy ndarray (NaNs are skipped)
 * 
 */
  __pyx_t_1 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_29robust_mean, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 722, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_robust_mean, __pyx_t_1) < 0) __PYX_ERR(0, 722, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":744
 * 
 * 
 * def robust_median(np.ndarray x):             # <<<<<<<<<<<<<<
 *     """Compute robust median of a numpy ndarray (NaNs are skipped)
 * 
 */
  __pyx_t_1 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_31robust_median, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 744, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_robust_median, __pyx_t_1) < 0) __PYX_ERR(0, 744, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":765
 *         return np.median(x)
 * 
 * def robust_sum(np.ndarray x):             # <<<<<<<<<<<<<<
 *     """Compute robust sum of a numpy ndarray (NaNs are skipped)
 * 
 */
  __pyx_t_1 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_33robust_sum, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 765, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_robust_sum, __pyx_t_1) < 0) __PYX_ERR(0, 765, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":786
 *         return np.nansum(x)
 * 
 * def robust_std(np.ndarray x):             # <<<<<<<<<<<<<<
 *     """Compute robust std of a numpy ndarray (NaNs are skipped)
 * 
 */
  __pyx_t_1 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_35robust_std, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 786, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_robust_std, __pyx_t_1) < 0) __PYX_ERR(0, 786, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":807
 *         return np.nanstd(x)
 * 
 * def robust_average(np.ndarray x,             # <<<<<<<<<<<<<<
 *                    np.ndarray w):
 *     """Compute robust average of a numpy ndarray (NaNs are skipped)
 */
  __pyx_t_1 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_37robust_average, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 807, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_robust_average, __pyx_t_1) < 0) __PYX_ERR(0, 807, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":844
 *         return np.nanmean(x * w)
 * 
 * def gaussian1d(np.ndarray[np.float64_t, ndim=1] x,             # <<<<<<<<<<<<<<
 *                double h, double a, double dx, double fwhm):
 *     """Return a 1D gaussian given a set of parameters.
 */
  __pyx_t_1 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_39gaussian1d, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 844, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_gaussian1d, __pyx_t_1) < 0) __PYX_ERR(0, 844, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":859
 *     return  h + a * np.exp(-(x - dx)**2. / (2. * w**2.))
 * 
 * def sinc1d(np.ndarray[np.float64_t, ndim=1] x,             # <<<<<<<<<<<<<<
 *            double h, double a, double dx, double fwhm):
 *     """Return a 1D sinc given a set of parameters.
 */
  __pyx_t_1 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_41sinc1d, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 859, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_sinc1d, __pyx_t_1) < 0) __PYX_ERR(0, 859, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":911
 * ##     return (h + a * e * (dawson1 - dawson2)).real
 * 
 * def interf_mean_energy(np.ndarray interf):             # <<<<<<<<<<<<<<
 *     """Return the mean energy of an interferogram by step.
 * 
 */
  __pyx_t_1 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_43interf_mean_energy, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 911, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_interf_mean_energy, __pyx_t_1) < 0) __PYX_ERR(0, 911, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":936
 *     return sqrt(energy_sum / <float> np.size(interf))
 * 
 * def spectrum_mean_energy(np.ndarray spectrum):             # <<<<<<<<<<<<<<
 *     """Return the mean energy of a spectrum by channel.
 * 
 */
  __pyx_t_1 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_45spectrum_mean_energy, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 936, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_spectrum_mean_energy, __pyx_t_1) < 0) __PYX_ERR(0, 936, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":952
 *     return sqrt(energy_sum) / <float> np.size(spectrum)
 * 
 * def fft_filter(np.ndarray[np.float64_t, ndim=1] a,             # <<<<<<<<<<<<<<
 *                 double cutoff, double width, bool lowpass):
 *     """
 */
  __pyx_t_1 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_47fft_filter, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 952, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_fft_filter, __pyx_t_1) < 0) __PYX_ERR(0, 952, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1025
 * 
 * 
 * def low_pass_image_filter(np.ndarray[np.float64_t, ndim=2] im, int deg):             # <<<<<<<<<<<<<<
 *     """Low pass image filter by convolution with a gaussian kernel.
 * 
 */
  __pyx_t_1 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_49low_pass_image_filter, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1025, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_low_pass_image_filter, __pyx_t_1) < 0) __PYX_ERR(0, 1025, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1071
 *     return np.copy(final_im)
 * 
 * def fast_gaussian_kernel(int deg):             # <<<<<<<<<<<<<<
 *     """Return a fast gaussian kernel.
 * 
 */
  __pyx_t_1 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_51fast_gaussian_kernel, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1071, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_fast_gaussian_kernel, __pyx_t_1) < 0) __PYX_ERR(0, 1071, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1099
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def gaussian_kernel(double deg):             # <<<<<<<<<<<<<<
 *     """Return a gaussian kernel.
 * 
 */
  __pyx_t_1 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_53gaussian_kernel, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1099, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_gaussian_kernel, __pyx_t_1) < 0) __PYX_ERR(0, 1099, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1142
 * 
 * 
 * def get_box_coords(int ix, int iy, int box_size,             # <<<<<<<<<<<<<<
 *                    int x_lim_min, int x_lim_max,
 *                    int y_lim_min, int y_lim_max):
 */
  __pyx_t_1 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_55get_box_coords, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1142, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_get_box_coords, __pyx_t_1) < 0) __PYX_ERR(0, 1142, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1180
 * 
 * 
 * def point_inside_polygon(double x, double y, list poly):             # <<<<<<<<<<<<<<
 *     """ Determine if a point is inside a given polygon or not
 *     Polygon is a list of (x,y) pairs.
 */
  __pyx_t_1 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_57point_inside_polygon, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1180, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_point_inside_polygon, __pyx_t_1) < 0) __PYX_ERR(0, 1180, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;

  /* "orb/cutils.pyx":1211
 *                     np.ndarray[np.float64_t, ndim=2] pos,
 *                     int box_size,
 *                     double height_guess=np.nan,             # <<<<<<<<<<<<<<
 *                     np.ndarray[np.float64_t, ndim=1] fwhm_guess=np.array(
 *                         [np.nan], dtype=float),
 */
  __pyx_t_1 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1211, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_nan); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1211, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_3 = __pyx_PyFloat_AsDouble(__pyx_t_2); if (unlikely((__pyx_t_3 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 1211, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_k__57 = __pyx_t_3;

  /* "orb/cutils.pyx":1212
 *                     int box_size,
 *                     double height_guess=np.nan,
 *                     np.ndarray[np.float64_t, ndim=1] fwhm_guess=np.array(             # <<<<<<<<<<<<<<
 *                         [np.nan], dtype=float),
 *                     bool cov_height=False,
 */
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1212, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_array); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1212, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_1);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;

  /* "orb/cutils.pyx":1213
 *                     double height_guess=np.nan,
 *                     np.ndarray[np.float64_t, ndim=1] fwhm_guess=np.array(
 *                         [np.nan], dtype=float),             # <<<<<<<<<<<<<<
 *                     bool cov_height=False,
 *                     bool cov_pos=True,
 */
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1213, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_nan); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1213, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = PyList_New(1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1213, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_GIVEREF(__pyx_t_4);
  PyList_SET_ITEM(__pyx_t_2, 0, __pyx_t_4);
  __pyx_t_4 = 0;

  /* "orb/cutils.pyx":1212
 *                     int box_size,
 *                     double height_guess=np.nan,
 *                     np.ndarray[np.float64_t, ndim=1] fwhm_guess=np.array(             # <<<<<<<<<<<<<<
 *                         [np.nan], dtype=float),
 *                     bool cov_height=False,
 */
  __pyx_t_4 = PyTuple_New(1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1212, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_4);
  __Pyx_GIVEREF(__pyx_t_2);
  PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_2);
  __pyx_t_2 = 0;

  /* "orb/cutils.pyx":1213
 *                     double height_guess=np.nan,
 *                     np.ndarray[np.float64_t, ndim=1] fwhm_guess=np.array(
 *                         [np.nan], dtype=float),             # <<<<<<<<<<<<<<
 *                     bool cov_height=False,
 *                     bool cov_pos=True,
 */
  __pyx_t_2 = PyDict_New(); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1213, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  if (PyDict_SetItem(__pyx_t_2, __pyx_n_s_dtype, ((PyObject *)(&PyFloat_Type))) < 0) __PYX_ERR(0, 1213, __pyx_L1_error)

  /* "orb/cutils.pyx":1212
 *                     int box_size,
 *                     double height_guess=np.nan,
 *                     np.ndarray[np.float64_t, ndim=1] fwhm_guess=np.array(             # <<<<<<<<<<<<<<
 *                         [np.nan], dtype=float),
 *                     bool cov_height=False,
 */
  __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_1, __pyx_t_4, __pyx_t_2); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1212, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  if (!(likely(((__pyx_t_5) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_5, __pyx_ptype_5numpy_ndarray))))) __PYX_ERR(0, 1212, __pyx_L1_error)
  __pyx_k__56 = ((PyArrayObject *)__pyx_t_5);
  __Pyx_GIVEREF(__pyx_t_5);
  __pyx_t_5 = 0;

  /* "orb/cutils.pyx":1221
 *                     bool fix_fwhm=False,
 *                     double fit_tol=1e-3,
 *                     double ron=np.nan,             # <<<<<<<<<<<<<<
 *                     double dcl=np.nan,
 *                     bool enable_zoom=False,
 */
  __pyx_t_5 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1221, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_nan); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1221, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_t_3 = __pyx_PyFloat_AsDouble(__pyx_t_2); if (unlikely((__pyx_t_3 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 1221, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_k__58 = __pyx_t_3;

  /* "orb/cutils.pyx":1222
 *                     double fit_tol=1e-3,
 *                     double ron=np.nan,
 *                     double dcl=np.nan,             # <<<<<<<<<<<<<<
 *                     bool enable_zoom=False,
 *                     bool enable_rotation=False,
 */
  __pyx_t_2 = __Pyx_GetModuleGlobalName(__pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1222, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_2);
  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_nan); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1222, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_3 = __pyx_PyFloat_AsDouble(__pyx_t_5); if (unlikely((__pyx_t_3 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 1222, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_k__59 = __pyx_t_3;

  /* "orb/cutils.pyx":1208
 *     return inside
 * 
 * def multi_fit_stars(np.ndarray[np.float64_t, ndim=2] frame,             # <<<<<<<<<<<<<<
 *                     np.ndarray[np.float64_t, ndim=2] pos,
 *                     int box_size,
 */
  __pyx_t_5 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_59multi_fit_stars, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1208, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_multi_fit_stars, __pyx_t_5) < 0) __PYX_ERR(0, 1208, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

  /* "orb/cutils.pyx":1811
 * 
 * 
 * def part_value(np.ndarray[np.float64_t, ndim=1] distrib, double coeff):             # <<<<<<<<<<<<<<
 *     """Return the value lying between two parts of a partition
 * 
 */
  __pyx_t_5 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_61part_value, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1811, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_part_value, __pyx_t_5) < 0) __PYX_ERR(0, 1811, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

  /* "orb/cutils.pyx":1838
 *     return bn.partition(cleaned_distrib, k)[k]
 * 
 * def indft(np.ndarray[np.float64_t, ndim=1] a,             # <<<<<<<<<<<<<<
 *           np.ndarray[np.float64_t, ndim=1] x):
 *     """Inverse Non-uniform Discret Fourier Transform.
 */
  __pyx_t_5 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_63indft, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1838, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_indft, __pyx_t_5) < 0) __PYX_ERR(0, 1838, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

  /* "orb/cutils.pyx":1869
 *     return f / N
 * 
 * def dft(np.ndarray[np.float64_t, ndim=1] a,             # <<<<<<<<<<<<<<
 *         np.ndarray[np.float64_t, ndim=1] x):
 *     """Discret Fourier Transform.
 */
  __pyx_t_5 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_65dft, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1869, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_dft, __pyx_t_5) < 0) __PYX_ERR(0, 1869, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

  /* "orb/cutils.pyx":1901
 * 
 * 
 * def map_me(np.ndarray[np.float64_t, ndim=2] frame):             # <<<<<<<<<<<<<<
 *     """Create a map of the modulation efficiency from a laser frame.
 * 
 */
  __pyx_t_5 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_67map_me, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1901, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_map_me, __pyx_t_5) < 0) __PYX_ERR(0, 1901, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

  /* "orb/cutils.pyx":1942
 * 
 * 
 * def nanbin_image(np.ndarray[np.float64_t, ndim=2] im, int binning):             # <<<<<<<<<<<<<<
 *     """Mean image binning robust to NaNs.
 * 
 */
  __pyx_t_5 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_69nanbin_image, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1942, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_nanbin_image, __pyx_t_5) < 0) __PYX_ERR(0, 1942, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

  /* "orb/cutils.pyx":1974
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def unbin_image(np.ndarray[np.float64_t, ndim=2] im,             # <<<<<<<<<<<<<<
 *                 int nx, int ny):
 *     """Unbin a binned image (restore the image binned with the
 */
  __pyx_t_5 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_71unbin_image, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1974, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_unbin_image, __pyx_t_5) < 0) __PYX_ERR(0, 1974, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

  /* "orb/cutils.pyx":2034
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def im2rgba(np.ndarray[np.float64_t, ndim=2] im,             # <<<<<<<<<<<<<<
 *             mpl_colorbar,
 *             double vmin, double vmax,
 */
  __pyx_t_5 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_73im2rgba, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 2034, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_im2rgba, __pyx_t_5) < 0) __PYX_ERR(0, 2034, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

  /* "orb/cutils.pyx":2101
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def brute_photometry(np.ndarray[np.float64_t, ndim=2] im,             # <<<<<<<<<<<<<<
 *                      np.ndarray[np.float64_t, ndim=2] star_list,
 *                      np.ndarray[np.float64_t, ndim=2] kernel,
 */
  __pyx_t_5 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_75brute_photometry, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 2101, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_brute_photometry, __pyx_t_5) < 0) __PYX_ERR(0, 2101, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

  /* "orb/cutils.pyx":2138
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def detect_cosmic_rays(np.ndarray[np.float64_t, ndim=2] frame,             # <<<<<<<<<<<<<<
 *                        crs_list, int box_size, double detect_coeff):
 *     """Check if a given pixel is a cosmic ray (classic detection).
 */
  __pyx_t_5 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_77detect_cosmic_rays, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 2138, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_detect_cosmic_rays, __pyx_t_5) < 0) __PYX_ERR(0, 2138, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

  /* "orb/cutils.pyx":2187
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def check_cosmic_rays_neighbourhood(             # <<<<<<<<<<<<<<
 *     np.ndarray[np.float64_t, ndim=2] frame,
 *     np.ndarray[np.uint8_t, ndim=2] cr_map,
 */
  __pyx_t_5 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_79check_cosmic_rays_neighbourhood, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 2187, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_check_cosmic_rays_neighbourhood, __pyx_t_5) < 0) __PYX_ERR(0, 2187, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

  /* "orb/cutils.pyx":2234
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def fast_w2pix(np.ndarray[np.float64_t, ndim=1] w,             # <<<<<<<<<<<<<<
 *                double axis_min, double axis_step):
 *     """Fast conversion of wavelength/wavenumber to pixel
 */
  __pyx_t_5 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_81fast_w2pix, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 2234, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_fast_w2pix, __pyx_t_5) < 0) __PYX_ERR(0, 2234, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

  /* "orb/cutils.pyx":2248
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def fast_pix2w(np.ndarray[np.float64_t, ndim=1] pix,             # <<<<<<<<<<<<<<
 *                double axis_min, double axis_step):
 *     """Fast conversion of pixel to wavelength/wavenumber
 */
  __pyx_t_5 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_83fast_pix2w, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 2248, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_fast_pix2w, __pyx_t_5) < 0) __PYX_ERR(0, 2248, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

  /* "orb/cutils.pyx":2261
 * 
 * 
 * def get_cm1_axis_min(int n, double step, int order, double corr=1.):             # <<<<<<<<<<<<<<
 *     """Return min wavenumber of a regular wavenumber axis in cm-1.
 * 
 */
  __pyx_t_5 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_85get_cm1_axis_min, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 2261, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_get_cm1_axis_min, __pyx_t_5) < 0) __PYX_ERR(0, 2261, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

  /* "orb/cutils.pyx":2280
 *     return cm1_min
 * 
 * def get_cm1_axis_max(int n, double step, int order, double corr=1.):             # <<<<<<<<<<<<<<
 *     """Return max wavenumber of a regular wavenumber axis in cm-1.
 * 
 */
  __pyx_t_5 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_87get_cm1_axis_max, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 2280, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_get_cm1_axis_max, __pyx_t_5) < 0) __PYX_ERR(0, 2280, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

  /* "orb/cutils.pyx":2299
 *     return cm1_max
 * 
 * def get_cm1_axis_step(int n, double step, double corr=1.):             # <<<<<<<<<<<<<<
 *     """Return step size of a regular wavenumber axis in cm-1.
 * 
 */
  __pyx_t_5 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_89get_cm1_axis_step, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 2299, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_get_cm1_axis_step, __pyx_t_5) < 0) __PYX_ERR(0, 2299, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

  /* "orb/cutils.pyx":2310
 *     return corr / (2. * <double> n * step) * 1e7
 * 
 * def get_nm_axis_min(int n, double step, int order, double corr=1.):             # <<<<<<<<<<<<<<
 *     """Return min wavelength of regular wavelength axis in nm.
 * 
 */
  __pyx_t_5 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_91get_nm_axis_min, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 2310, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_get_nm_axis_min, __pyx_t_5) < 0) __PYX_ERR(0, 2310, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

  /* "orb/cutils.pyx":2324
 *     return 1. / get_cm1_axis_max(n, step, order, corr=corr) * 1e7
 * 
 * def get_nm_axis_max(int n, double step, int order, double corr=1.):             # <<<<<<<<<<<<<<
 *     """Return max wavelength of regular wavelength axis in nm.
 * 
 */
  __pyx_t_5 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_93get_nm_axis_max, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 2324, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_get_nm_axis_max, __pyx_t_5) < 0) __PYX_ERR(0, 2324, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

  /* "orb/cutils.pyx":2338
 *     return 1. / get_cm1_axis_min(n, step, order, corr=corr) * 1e7
 * 
 * def get_nm_axis_step(int n, double step, int order, double corr=1.):             # <<<<<<<<<<<<<<
 *     """Return step size of a regular wavelength axis in nm.
 * 
 */
  __pyx_t_5 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_95get_nm_axis_step, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 2338, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_get_nm_axis_step, __pyx_t_5) < 0) __PYX_ERR(0, 2338, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

  /* "orb/cutils.pyx":2356
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def filter_background(np.ndarray[np.float64_t, ndim=2] frame,             # <<<<<<<<<<<<<<
 *                       int box_size, int big_box_coeff):
 *     """Replace each pixel by the value in a box around it minus the
 */
  __pyx_t_5 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_97filter_background, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 2356, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_filter_background, __pyx_t_5) < 0) __PYX_ERR(0, 2356, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

  /* "orb/cutils.pyx":2408
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def mean2d(np.ndarray[np.float64_t, ndim=2] box):             # <<<<<<<<<<<<<<
 *     """Return the mean of a 2d box with no GIL
 * 
 */
  __pyx_t_5 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_99mean2d, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 2408, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_mean2d, __pyx_t_5) < 0) __PYX_ERR(0, 2408, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

  /* "orb/cutils.pyx":2432
 * @cython.boundscheck(False)
 * @cython.wraparound(False)
 * def median2d(np.ndarray[np.float64_t, ndim=2] box):             # <<<<<<<<<<<<<<
 *     """Return the median of a 2d box with no GIL
 * 
 */
  __pyx_t_5 = PyCFunction_NewEx(&__pyx_mdef_3orb_6cutils_101median2d, NULL, __pyx_n_s_orb_cutils); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 2432, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_median2d, __pyx_t_5) < 0) __PYX_ERR(0, 2432, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

  /* "orb/cutils.pyx":1
 * # cython: embedsignature=True             # <<<<<<<<<<<<<<
 * # *-* coding: utf-8 *-*
 * # Author: Thomas Martin <thomas.martin.1@ulaval.ca>
 */
  __pyx_t_5 = PyDict_New(); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 1, __pyx_L1_error)
  __Pyx_GOTREF(__pyx_t_5);
  if (PyDict_SetItem(__pyx_d, __pyx_n_s_test, __pyx_t_5) < 0) __PYX_ERR(0, 1, __pyx_L1_error)
  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;

  /* "../../../../usr/local/lib/python2.7/dist-packages/Cython/Includes/numpy/__init__.pxd":976
 *      arr.base = baseptr
 * 
 * cdef inline object get_array_base(ndarray arr):             # <<<<<<<<<<<<<<
 *     if arr.base is NULL:
 *         return None
 */

  /*--- Wrapped vars code ---*/

  goto __pyx_L0;
  __pyx_L1_error:;
  __Pyx_XDECREF(__pyx_t_1);
  __Pyx_XDECREF(__pyx_t_2);
  __Pyx_XDECREF(__pyx_t_4);
  __Pyx_XDECREF(__pyx_t_5);
  if (__pyx_m) {
    if (__pyx_d) {
      __Pyx_AddTraceback("init orb.cutils", __pyx_clineno, __pyx_lineno, __pyx_filename);
    }
    Py_DECREF(__pyx_m); __pyx_m = 0;
  } else if (!PyErr_Occurred()) {
    PyErr_SetString(PyExc_ImportError, "init orb.cutils");
  }
  __pyx_L0:;
  __Pyx_RefNannyFinishContext();
  #if PY_MAJOR_VERSION < 3
  return;
  #else
  return __pyx_m;
  #endif
}

/* --- Runtime support code --- */
/* Refnanny */
#if CYTHON_REFNANNY
static __Pyx_RefNannyAPIStruct *__Pyx_RefNannyImportAPI(const char *modname) {
    PyObject *m = NULL, *p = NULL;
    void *r = NULL;
    m = PyImport_ImportModule((char *)modname);
    if (!m) goto end;
    p = PyObject_GetAttrString(m, (char *)"RefNannyAPI");
    if (!p) goto end;
    r = PyLong_AsVoidPtr(p);
end:
    Py_XDECREF(p);
    Py_XDECREF(m);
    return (__Pyx_RefNannyAPIStruct *)r;
}
#endif

/* GetBuiltinName */
static PyObject *__Pyx_GetBuiltinName(PyObject *name) {
    PyObject* result = __Pyx_PyObject_GetAttrStr(__pyx_b, name);
    if (unlikely(!result)) {
        PyErr_Format(PyExc_NameError,
#if PY_MAJOR_VERSION >= 3
            "name '%U' is not defined", name);
#else
            "name '%.200s' is not defined", PyString_AS_STRING(name));
#endif
    }
    return result;
}

/* RaiseArgTupleInvalid */
static void __Pyx_RaiseArgtupleInvalid(
    const char* func_name,
    int exact,
    Py_ssize_t num_min,
    Py_ssize_t num_max,
    Py_ssize_t num_found)
{
    Py_ssize_t num_expected;
    const char *more_or_less;
    if (num_found < num_min) {
        num_expected = num_min;
        more_or_less = "at least";
    } else {
        num_expected = num_max;
        more_or_less = "at most";
    }
    if (exact) {
        more_or_less = "exactly";
    }
    PyErr_Format(PyExc_TypeError,
                 "%.200s() takes %.8s %" CYTHON_FORMAT_SSIZE_T "d positional argument%.1s (%" CYTHON_FORMAT_SSIZE_T "d given)",
                 func_name, more_or_less, num_expected,
                 (num_expected == 1) ? "" : "s", num_found);
}

/* RaiseDoubleKeywords */
static void __Pyx_RaiseDoubleKeywordsError(
    const char* func_name,
    PyObject* kw_name)
{
    PyErr_Format(PyExc_TypeError,
        #if PY_MAJOR_VERSION >= 3
        "%s() got multiple values for keyword argument '%U'", func_name, kw_name);
        #else
        "%s() got multiple values for keyword argument '%s'", func_name,
        PyString_AsString(kw_name));
        #endif
}

/* ParseKeywords */
static int __Pyx_ParseOptionalKeywords(
    PyObject *kwds,
    PyObject **argnames[],
    PyObject *kwds2,
    PyObject *values[],
    Py_ssize_t num_pos_args,
    const char* function_name)
{
    PyObject *key = 0, *value = 0;
    Py_ssize_t pos = 0;
    PyObject*** name;
    PyObject*** first_kw_arg = argnames + num_pos_args;
    while (PyDict_Next(kwds, &pos, &key, &value)) {
        name = first_kw_arg;
        while (*name && (**name != key)) name++;
        if (*name) {
            values[name-argnames] = value;
            continue;
        }
        name = first_kw_arg;
        #if PY_MAJOR_VERSION < 3
        if (likely(PyString_CheckExact(key)) || likely(PyString_Check(key))) {
            while (*name) {
                if ((CYTHON_COMPILING_IN_PYPY || PyString_GET_SIZE(**name) == PyString_GET_SIZE(key))
                        && _PyString_Eq(**name, key)) {
                    values[name-argnames] = value;
                    break;
                }
                name++;
            }
            if (*name) continue;
            else {
                PyObject*** argname = argnames;
                while (argname != first_kw_arg) {
                    if ((**argname == key) || (
                            (CYTHON_COMPILING_IN_PYPY || PyString_GET_SIZE(**argname) == PyString_GET_SIZE(key))
                             && _PyString_Eq(**argname, key))) {
                        goto arg_passed_twice;
                    }
                    argname++;
                }
            }
        } else
        #endif
        if (likely(PyUnicode_Check(key))) {
            while (*name) {
                int cmp = (**name == key) ? 0 :
                #if !CYTHON_COMPILING_IN_PYPY && PY_MAJOR_VERSION >= 3
                    (PyUnicode_GET_SIZE(**name) != PyUnicode_GET_SIZE(key)) ? 1 :
                #endif
                    PyUnicode_Compare(**name, key);
                if (cmp < 0 && unlikely(PyErr_Occurred())) goto bad;
                if (cmp == 0) {
                    values[name-argnames] = value;
                    break;
                }
                name++;
            }
            if (*name) continue;
            else {
                PyObject*** argname = argnames;
                while (argname != first_kw_arg) {
                    int cmp = (**argname == key) ? 0 :
                    #if !CYTHON_COMPILING_IN_PYPY && PY_MAJOR_VERSION >= 3
                        (PyUnicode_GET_SIZE(**argname) != PyUnicode_GET_SIZE(key)) ? 1 :
                    #endif
                        PyUnicode_Compare(**argname, key);
                    if (cmp < 0 && unlikely(PyErr_Occurred())) goto bad;
                    if (cmp == 0) goto arg_passed_twice;
                    argname++;
                }
            }
        } else
            goto invalid_keyword_type;
        if (kwds2) {
            if (unlikely(PyDict_SetItem(kwds2, key, value))) goto bad;
        } else {
            goto invalid_keyword;
        }
    }
    return 0;
arg_passed_twice:
    __Pyx_RaiseDoubleKeywordsError(function_name, key);
    goto bad;
invalid_keyword_type:
    PyErr_Format(PyExc_TypeError,
        "%.200s() keywords must be strings", function_name);
    goto bad;
invalid_keyword:
    PyErr_Format(PyExc_TypeError,
    #if PY_MAJOR_VERSION < 3
        "%.200s() got an unexpected keyword argument '%.200s'",
        function_name, PyString_AsString(key));
    #else
        "%s() got an unexpected keyword argument '%U'",
        function_name, key);
    #endif
bad:
    return -1;
}

/* GetModuleGlobalName */
static CYTHON_INLINE PyObject *__Pyx_GetModuleGlobalName(PyObject *name) {
    PyObject *result;
#if CYTHON_COMPILING_IN_CPYTHON
    result = PyDict_GetItem(__pyx_d, name);
    if (likely(result)) {
        Py_INCREF(result);
    } else {
#else
    result = PyObject_GetItem(__pyx_d, name);
    if (!result) {
        PyErr_Clear();
#endif
        result = __Pyx_GetBuiltinName(name);
    }
    return result;
}

/* PyObjectCall */
  #if CYTHON_COMPILING_IN_CPYTHON
static CYTHON_INLINE PyObject* __Pyx_PyObject_Call(PyObject *func, PyObject *arg, PyObject *kw) {
    PyObject *result;
    ternaryfunc call = func->ob_type->tp_call;
    if (unlikely(!call))
        return PyObject_Call(func, arg, kw);
    if (unlikely(Py_EnterRecursiveCall((char*)" while calling a Python object")))
        return NULL;
    result = (*call)(func, arg, kw);
    Py_LeaveRecursiveCall();
    if (unlikely(!result) && unlikely(!PyErr_Occurred())) {
        PyErr_SetString(
            PyExc_SystemError,
            "NULL result without error in PyObject_Call");
    }
    return result;
}
#endif

/* PyObjectCallMethO */
  #if CYTHON_COMPILING_IN_CPYTHON
static CYTHON_INLINE PyObject* __Pyx_PyObject_CallMethO(PyObject *func, PyObject *arg) {
    PyObject *self, *result;
    PyCFunction cfunc;
    cfunc = PyCFunction_GET_FUNCTION(func);
    self = PyCFunction_GET_SELF(func);
    if (unlikely(Py_EnterRecursiveCall((char*)" while calling a Python object")))
        return NULL;
    result = cfunc(self, arg);
    Py_LeaveRecursiveCall();
    if (unlikely(!result) && unlikely(!PyErr_Occurred())) {
        PyErr_SetString(
            PyExc_SystemError,
            "NULL result without error in PyObject_Call");
    }
    return result;
}
#endif

/* PyObjectCallOneArg */
  #if CYTHON_COMPILING_IN_CPYTHON
static PyObject* __Pyx__PyObject_CallOneArg(PyObject *func, PyObject *arg) {
    PyObject *result;
    PyObject *args = PyTuple_New(1);
    if (unlikely(!args)) return NULL;
    Py_INCREF(arg);
    PyTuple_SET_ITEM(args, 0, arg);
    result = __Pyx_PyObject_Call(func, args, NULL);
    Py_DECREF(args);
    return result;
}
static CYTHON_INLINE PyObject* __Pyx_PyObject_CallOneArg(PyObject *func, PyObject *arg) {
#ifdef __Pyx_CyFunction_USED
    if (likely(PyCFunction_Check(func) || PyObject_TypeCheck(func, __pyx_CyFunctionType))) {
#else
    if (likely(PyCFunction_Check(func))) {
#endif
        if (likely(PyCFunction_GET_FLAGS(func) & METH_O)) {
            return __Pyx_PyObject_CallMethO(func, arg);
        }
    }
    return __Pyx__PyObject_CallOneArg(func, arg);
}
#else
static CYTHON_INLINE PyObject* __Pyx_PyObject_CallOneArg(PyObject *func, PyObject *arg) {
    PyObject *result;
    PyObject *args = PyTuple_Pack(1, arg);
    if (unlikely(!args)) return NULL;
    result = __Pyx_PyObject_Call(func, args, NULL);
    Py_DECREF(args);
    return result;
}
#endif

/* ArgTypeTest */
    static void __Pyx_RaiseArgumentTypeInvalid(const char* name, PyObject *obj, PyTypeObject *type) {
    PyErr_Format(PyExc_TypeError,
        "Argument '%.200s' has incorrect type (expected %.200s, got %.200s)",
        name, type->tp_name, Py_TYPE(obj)->tp_name);
}
static CYTHON_INLINE int __Pyx_ArgTypeTest(PyObject *obj, PyTypeObject *type, int none_allowed,
    const char *name, int exact)
{
    if (unlikely(!type)) {
        PyErr_SetString(PyExc_SystemError, "Missing type object");
        return 0;
    }
    if (none_allowed && obj == Py_None) return 1;
    else if (exact) {
        if (likely(Py_TYPE(obj) == type)) return 1;
        #if PY_MAJOR_VERSION == 2
        else if ((type == &PyBaseString_Type) && likely(__Pyx_PyBaseString_CheckExact(obj))) return 1;
        #endif
    }
    else {
        if (likely(PyObject_TypeCheck(obj, type))) return 1;
    }
    __Pyx_RaiseArgumentTypeInvalid(name, obj, type);
    return 0;
}

/* BufferFormatCheck */
    static CYTHON_INLINE int __Pyx_IsLittleEndian(void) {
  unsigned int n = 1;
  return *(unsigned char*)(&n) != 0;
}
static void __Pyx_BufFmt_Init(__Pyx_BufFmt_Context* ctx,
                              __Pyx_BufFmt_StackElem* stack,
                              __Pyx_TypeInfo* type) {
  stack[0].field = &ctx->root;
  stack[0].parent_offset = 0;
  ctx->root.type = type;
  ctx->root.name = "buffer dtype";
  ctx->root.offset = 0;
  ctx->head = stack;
  ctx->head->field = &ctx->root;
  ctx->fmt_offset = 0;
  ctx->head->parent_offset = 0;
  ctx->new_packmode = '@';
  ctx->enc_packmode = '@';
  ctx->new_count = 1;
  ctx->enc_count = 0;
  ctx->enc_type = 0;
  ctx->is_complex = 0;
  ctx->is_valid_array = 0;
  ctx->struct_alignment = 0;
  while (type->typegroup == 'S') {
    ++ctx->head;
    ctx->head->field = type->fields;
    ctx->head->parent_offset = 0;
    type = type->fields->type;
  }
}
static int __Pyx_BufFmt_ParseNumber(const char** ts) {
    int count;
    const char* t = *ts;
    if (*t < '0' || *t > '9') {
      return -1;
    } else {
        count = *t++ - '0';
        while (*t >= '0' && *t < '9') {
            count *= 10;
            count += *t++ - '0';
        }
    }
    *ts = t;
    return count;
}
static int __Pyx_BufFmt_ExpectNumber(const char **ts) {
    int number = __Pyx_BufFmt_ParseNumber(ts);
    if (number == -1)
        PyErr_Format(PyExc_ValueError,\
                     "Does not understand character buffer dtype format string ('%c')", **ts);
    return number;
}
static void __Pyx_BufFmt_RaiseUnexpectedChar(char ch) {
  PyErr_Format(PyExc_ValueError,
               "Unexpected format string character: '%c'", ch);
}
static const char* __Pyx_BufFmt_DescribeTypeChar(char ch, int is_complex) {
  switch (ch) {
    case 'c': return "'char'";
    case 'b': return "'signed char'";
    case 'B': return "'unsigned char'";
    case 'h': return "'short'";
    case 'H': return "'unsigned short'";
    case 'i': return "'int'";
    case 'I': return "'unsigned int'";
    case 'l': return "'long'";
    case 'L': return "'unsigned long'";
    case 'q': return "'long long'";
    case 'Q': return "'unsigned long long'";
    case 'f': return (is_complex ? "'complex float'" : "'float'");
    case 'd': return (is_complex ? "'complex double'" : "'double'");
    case 'g': return (is_complex ? "'complex long double'" : "'long double'");
    case 'T': return "a struct";
    case 'O': return "Python object";
    case 'P': return "a pointer";
    case 's': case 'p': return "a string";
    case 0: return "end";
    default: return "unparseable format string";
  }
}
static size_t __Pyx_BufFmt_TypeCharToStandardSize(char ch, int is_complex) {
  switch (ch) {
    case '?': case 'c': case 'b': case 'B': case 's': case 'p': return 1;
    case 'h': case 'H': return 2;
    case 'i': case 'I': case 'l': case 'L': return 4;
    case 'q': case 'Q': return 8;
    case 'f': return (is_complex ? 8 : 4);
    case 'd': return (is_complex ? 16 : 8);
    case 'g': {
      PyErr_SetString(PyExc_ValueError, "Python does not define a standard format string size for long double ('g')..");
      return 0;
    }
    case 'O': case 'P': return sizeof(void*);
    default:
      __Pyx_BufFmt_RaiseUnexpectedChar(ch);
      return 0;
    }
}
static size_t __Pyx_BufFmt_TypeCharToNativeSize(char ch, int is_complex) {
  switch (ch) {
    case 'c': case 'b': case 'B': case 's': case 'p': return 1;
    case 'h': case 'H': return sizeof(short);
    case 'i': case 'I': return sizeof(int);
    case 'l': case 'L': return sizeof(long);
    #ifdef HAVE_LONG_LONG
    case 'q': case 'Q': return sizeof(PY_LONG_LONG);
    #endif
    case 'f': return sizeof(float) * (is_complex ? 2 : 1);
    case 'd': return sizeof(double) * (is_complex ? 2 : 1);
    case 'g': return sizeof(long double) * (is_complex ? 2 : 1);
    case 'O': case 'P': return sizeof(void*);
    default: {
      __Pyx_BufFmt_RaiseUnexpectedChar(ch);
      return 0;
    }
  }
}
typedef struct { char c; short x; } __Pyx_st_short;
typedef struct { char c; int x; } __Pyx_st_int;
typedef struct { char c; long x; } __Pyx_st_long;
typedef struct { char c; float x; } __Pyx_st_float;
typedef struct { char c; double x; } __Pyx_st_double;
typedef struct { char c; long double x; } __Pyx_st_longdouble;
typedef struct { char c; void *x; } __Pyx_st_void_p;
#ifdef HAVE_LONG_LONG
typedef struct { char c; PY_LONG_LONG x; } __Pyx_st_longlong;
#endif
static size_t __Pyx_BufFmt_TypeCharToAlignment(char ch, CYTHON_UNUSED int is_complex) {
  switch (ch) {
    case '?': case 'c': case 'b': case 'B': case 's': case 'p': return 1;
    case 'h': case 'H': return sizeof(__Pyx_st_short) - sizeof(short);
    case 'i': case 'I': return sizeof(__Pyx_st_int) - sizeof(int);
    case 'l': case 'L': return sizeof(__Pyx_st_long) - sizeof(long);
#ifdef HAVE_LONG_LONG
    case 'q': case 'Q': return sizeof(__Pyx_st_longlong) - sizeof(PY_LONG_LONG);
#endif
    case 'f': return sizeof(__Pyx_st_float) - sizeof(float);
    case 'd': return sizeof(__Pyx_st_double) - sizeof(double);
    case 'g': return sizeof(__Pyx_st_longdouble) - sizeof(long double);
    case 'P': case 'O': return sizeof(__Pyx_st_void_p) - sizeof(void*);
    default:
      __Pyx_BufFmt_RaiseUnexpectedChar(ch);
      return 0;
    }
}
/* These are for computing the padding at the end of the struct to align
   on the first member of the struct. This will probably the same as above,
   but we don't have any guarantees.
 */
typedef struct { short x; char c; } __Pyx_pad_short;
typedef struct { int x; char c; } __Pyx_pad_int;
typedef struct { long x; char c; } __Pyx_pad_long;
typedef struct { float x; char c; } __Pyx_pad_float;
typedef struct { double x; char c; } __Pyx_pad_double;
typedef struct { long double x; char c; } __Pyx_pad_longdouble;
typedef struct { void *x; char c; } __Pyx_pad_void_p;
#ifdef HAVE_LONG_LONG
typedef struct { PY_LONG_LONG x; char c; } __Pyx_pad_longlong;
#endif
static size_t __Pyx_BufFmt_TypeCharToPadding(char ch, CYTHON_UNUSED int is_complex) {
  switch (ch) {
    case '?': case 'c': case 'b': case 'B': case 's': case 'p': return 1;
    case 'h': case 'H': return sizeof(__Pyx_pad_short) - sizeof(short);
    case 'i': case 'I': return sizeof(__Pyx_pad_int) - sizeof(int);
    case 'l': case 'L': return sizeof(__Pyx_pad_long) - sizeof(long);
#ifdef HAVE_LONG_LONG
    case 'q': case 'Q': return sizeof(__Pyx_pad_longlong) - sizeof(PY_LONG_LONG);
#endif
    case 'f': return sizeof(__Pyx_pad_float) - sizeof(float);
    case 'd': return sizeof(__Pyx_pad_double) - sizeof(double);
    case 'g': return sizeof(__Pyx_pad_longdouble) - sizeof(long double);
    case 'P': case 'O': return sizeof(__Pyx_pad_void_p) - sizeof(void*);
    default:
      __Pyx_BufFmt_RaiseUnexpectedChar(ch);
      return 0;
    }
}
static char __Pyx_BufFmt_TypeCharToGroup(char ch, int is_complex) {
  switch (ch) {
    case 'c':
        return 'H';
    case 'b': case 'h': case 'i':
    case 'l': case 'q': case 's': case 'p':
        return 'I';
    case 'B': case 'H': case 'I': case 'L': case 'Q':
        return 'U';
    case 'f': case 'd': case 'g':
        return (is_complex ? 'C' : 'R');
    case 'O':
        return 'O';
    case 'P':
        return 'P';
    default: {
      __Pyx_BufFmt_RaiseUnexpectedChar(ch);
      return 0;
    }
  }
}
static void __Pyx_BufFmt_RaiseExpected(__Pyx_BufFmt_Context* ctx) {
  if (ctx->head == NULL || ctx->head->field == &ctx->root) {
    const char* expected;
    const char* quote;
    if (ctx->head == NULL) {
      expected = "end";
      quote = "";
    } else {
      expected = ctx->head->field->type->name;
      quote = "'";
    }
    PyErr_Format(PyExc_ValueError,
                 "Buffer dtype mismatch, expected %s%s%s but got %s",
                 quote, expected, quote,
                 __Pyx_BufFmt_DescribeTypeChar(ctx->enc_type, ctx->is_complex));
  } else {
    __Pyx_StructField* field = ctx->head->field;
    __Pyx_StructField* parent = (ctx->head - 1)->field;
    PyErr_Format(PyExc_ValueError,
                 "Buffer dtype mismatch, expected '%s' but got %s in '%s.%s'",
                 field->type->name, __Pyx_BufFmt_DescribeTypeChar(ctx->enc_type, ctx->is_complex),
                 parent->type->name, field->name);
  }
}
static int __Pyx_BufFmt_ProcessTypeChunk(__Pyx_BufFmt_Context* ctx) {
  char group;
  size_t size, offset, arraysize = 1;
  if (ctx->enc_type == 0) return 0;
  if (ctx->head->field->type->arraysize[0]) {
    int i, ndim = 0;
    if (ctx->enc_type == 's' || ctx->enc_type == 'p') {
        ctx->is_valid_array = ctx->head->field->type->ndim == 1;
        ndim = 1;
        if (ctx->enc_count != ctx->head->field->type->arraysize[0]) {
            PyErr_Format(PyExc_ValueError,
                         "Expected a dimension of size %zu, got %zu",
                         ctx->head->field->type->arraysize[0], ctx->enc_count);
            return -1;
        }
    }
    if (!ctx->is_valid_array) {
      PyErr_Format(PyExc_ValueError, "Expected %d dimensions, got %d",
                   ctx->head->field->type->ndim, ndim);
      return -1;
    }
    for (i = 0; i < ctx->head->field->type->ndim; i++) {
      arraysize *= ctx->head->field->type->arraysize[i];
    }
    ctx->is_valid_array = 0;
    ctx->enc_count = 1;
  }
  group = __Pyx_BufFmt_TypeCharToGroup(ctx->enc_type, ctx->is_complex);
  do {
    __Pyx_StructField* field = ctx->head->field;
    __Pyx_TypeInfo* type = field->type;
    if (ctx->enc_packmode == '@' || ctx->enc_packmode == '^') {
      size = __Pyx_BufFmt_TypeCharToNativeSize(ctx->enc_type, ctx->is_complex);
    } else {
      size = __Pyx_BufFmt_TypeCharToStandardSize(ctx->enc_type, ctx->is_complex);
    }
    if (ctx->enc_packmode == '@') {
      size_t align_at = __Pyx_BufFmt_TypeCharToAlignment(ctx->enc_type, ctx->is_complex);
      size_t align_mod_offset;
      if (align_at == 0) return -1;
      align_mod_offset = ctx->fmt_offset % align_at;
      if (align_mod_offset > 0) ctx->fmt_offset += align_at - align_mod_offset;
      if (ctx->struct_alignment == 0)
          ctx->struct_alignment = __Pyx_BufFmt_TypeCharToPadding(ctx->enc_type,
                                                                 ctx->is_complex);
    }
    if (type->size != size || type->typegroup != group) {
      if (type->typegroup == 'C' && type->fields != NULL) {
        size_t parent_offset = ctx->head->parent_offset + field->offset;
        ++ctx->head;
        ctx->head->field = type->fields;
        ctx->head->parent_offset = parent_offset;
        continue;
      }
      if ((type->typegroup == 'H' || group == 'H') && type->size == size) {
      } else {
          __Pyx_BufFmt_RaiseExpected(ctx);
          return -1;
      }
    }
    offset = ctx->head->parent_offset + field->offset;
    if (ctx->fmt_offset != offset) {
      PyErr_Format(PyExc_ValueError,
                   "Buffer dtype mismatch; next field is at offset %" CYTHON_FORMAT_SSIZE_T "d but %" CYTHON_FORMAT_SSIZE_T "d expected",
                   (Py_ssize_t)ctx->fmt_offset, (Py_ssize_t)offset);
      return -1;
    }
    ctx->fmt_offset += size;
    if (arraysize)
      ctx->fmt_offset += (arraysize - 1) * size;
    --ctx->enc_count;
    while (1) {
      if (field == &ctx->root) {
        ctx->head = NULL;
        if (ctx->enc_count != 0) {
          __Pyx_BufFmt_RaiseExpected(ctx);
          return -1;
        }
        break;
      }
      ctx->head->field = ++field;
      if (field->type == NULL) {
        --ctx->head;
        field = ctx->head->field;
        continue;
      } else if (field->type->typegroup == 'S') {
        size_t parent_offset = ctx->head->parent_offset + field->offset;
        if (field->type->fields->type == NULL) continue;
        field = field->type->fields;
        ++ctx->head;
        ctx->head->field = field;
        ctx->head->parent_offset = parent_offset;
        break;
      } else {
        break;
      }
    }
  } while (ctx->enc_count);
  ctx->enc_type = 0;
  ctx->is_complex = 0;
  return 0;
}
static CYTHON_INLINE PyObject *
__pyx_buffmt_parse_array(__Pyx_BufFmt_Context* ctx, const char** tsp)
{
    const char *ts = *tsp;
    int i = 0, number;
    int ndim = ctx->head->field->type->ndim;
;
    ++ts;
    if (ctx->new_count != 1) {
        PyErr_SetString(PyExc_ValueError,
                        "Cannot handle repeated arrays in format string");
        return NULL;
    }
    if (__Pyx_BufFmt_ProcessTypeChunk(ctx) == -1) return NULL;
    while (*ts && *ts != ')') {
        switch (*ts) {
            case ' ': case '\f': case '\r': case '\n': case '\t': case '\v':  continue;
            default:  break;
        }
        number = __Pyx_BufFmt_ExpectNumber(&ts);
        if (number == -1) return NULL;
        if (i < ndim && (size_t) number != ctx->head->field->type->arraysize[i])
            return PyErr_Format(PyExc_ValueError,
                        "Expected a dimension of size %zu, got %d",
                        ctx->head->field->type->arraysize[i], number);
        if (*ts != ',' && *ts != ')')
            return PyErr_Format(PyExc_ValueError,
                                "Expected a comma in format string, got '%c'", *ts);
        if (*ts == ',') ts++;
        i++;
    }
    if (i != ndim)
        return PyErr_Format(PyExc_ValueError, "Expected %d dimension(s), got %d",
                            ctx->head->field->type->ndim, i);
    if (!*ts) {
        PyErr_SetString(PyExc_ValueError,
                        "Unexpected end of format string, expected ')'");
        return NULL;
    }
    ctx->is_valid_array = 1;
    ctx->new_count = 1;
    *tsp = ++ts;
    return Py_None;
}
static const char* __Pyx_BufFmt_CheckString(__Pyx_BufFmt_Context* ctx, const char* ts) {
  int got_Z = 0;
  while (1) {
    switch(*ts) {
      case 0:
        if (ctx->enc_type != 0 && ctx->head == NULL) {
          __Pyx_BufFmt_RaiseExpected(ctx);
          return NULL;
        }
        if (__Pyx_BufFmt_ProcessTypeChunk(ctx) == -1) return NULL;
        if (ctx->head != NULL) {
          __Pyx_BufFmt_RaiseExpected(ctx);
          return NULL;
        }
        return ts;
      case ' ':
      case '\r':
      case '\n':
        ++ts;
        break;
      case '<':
        if (!__Pyx_IsLittleEndian()) {
          PyErr_SetString(PyExc_ValueError, "Little-endian buffer not supported on big-endian compiler");
          return NULL;
        }
        ctx->new_packmode = '=';
        ++ts;
        break;
      case '>':
      case '!':
        if (__Pyx_IsLittleEndian()) {
          PyErr_SetString(PyExc_ValueError, "Big-endian buffer not supported on little-endian compiler");
          return NULL;
        }
        ctx->new_packmode = '=';
        ++ts;
        break;
      case '=':
      case '@':
      case '^':
        ctx->new_packmode = *ts++;
        break;
      case 'T':
        {
          const char* ts_after_sub;
          size_t i, struct_count = ctx->new_count;
          size_t struct_alignment = ctx->struct_alignment;
          ctx->new_count = 1;
          ++ts;
          if (*ts != '{') {
            PyErr_SetString(PyExc_ValueError, "Buffer acquisition: Expected '{' after 'T'");
            return NULL;
          }
          if (__Pyx_BufFmt_ProcessTypeChunk(ctx) == -1) return NULL;
          ctx->enc_type = 0;
          ctx->enc_count = 0;
          ctx->struct_alignment = 0;
          ++ts;
          ts_after_sub = ts;
          for (i = 0; i != struct_count; ++i) {
            ts_after_sub = __Pyx_BufFmt_CheckString(ctx, ts);
            if (!ts_after_sub) return NULL;
          }
          ts = ts_after_sub;
          if (struct_alignment) ctx->struct_alignment = struct_alignment;
        }
        break;
      case '}':
        {
          size_t alignment = ctx->struct_alignment;
          ++ts;
          if (__Pyx_BufFmt_ProcessTypeChunk(ctx) == -1) return NULL;
          ctx->enc_type = 0;
          if (alignment && ctx->fmt_offset % alignment) {
            ctx->fmt_offset += alignment - (ctx->fmt_offset % alignment);
          }
        }
        return ts;
      case 'x':
        if (__Pyx_BufFmt_ProcessTypeChunk(ctx) == -1) return NULL;
        ctx->fmt_offset += ctx->new_count;
        ctx->new_count = 1;
        ctx->enc_count = 0;
        ctx->enc_type = 0;
        ctx->enc_packmode = ctx->new_packmode;
        ++ts;
        break;
      case 'Z':
        got_Z = 1;
        ++ts;
        if (*ts != 'f' && *ts != 'd' && *ts != 'g') {
          __Pyx_BufFmt_RaiseUnexpectedChar('Z');
          return NULL;
        }
      case 'c': case 'b': case 'B': case 'h': case 'H': case 'i': case 'I':
      case 'l': case 'L': case 'q': case 'Q':
      case 'f': case 'd': case 'g':
      case 'O': case 'p':
        if (ctx->enc_type == *ts && got_Z == ctx->is_complex &&
            ctx->enc_packmode == ctx->new_packmode) {
          ctx->enc_count += ctx->new_count;
          ctx->new_count = 1;
          got_Z = 0;
          ++ts;
          break;
        }
      case 's':
        if (__Pyx_BufFmt_ProcessTypeChunk(ctx) == -1) return NULL;
        ctx->enc_count = ctx->new_count;
        ctx->enc_packmode = ctx->new_packmode;
        ctx->enc_type = *ts;
        ctx->is_complex = got_Z;
        ++ts;
        ctx->new_count = 1;
        got_Z = 0;
        break;
      case ':':
        ++ts;
        while(*ts != ':') ++ts;
        ++ts;
        break;
      case '(':
        if (!__pyx_buffmt_parse_array(ctx, &ts)) return NULL;
        break;
      default:
        {
          int number = __Pyx_BufFmt_ExpectNumber(&ts);
          if (number == -1) return NULL;
          ctx->new_count = (size_t)number;
        }
    }
  }
}
static CYTHON_INLINE void __Pyx_ZeroBuffer(Py_buffer* buf) {
  buf->buf = NULL;
  buf->obj = NULL;
  buf->strides = __Pyx_zeros;
  buf->shape = __Pyx_zeros;
  buf->suboffsets = __Pyx_minusones;
}
static CYTHON_INLINE int __Pyx_GetBufferAndValidate(
        Py_buffer* buf, PyObject* obj,  __Pyx_TypeInfo* dtype, int flags,
        int nd, int cast, __Pyx_BufFmt_StackElem* stack)
{
  if (obj == Py_None || obj == NULL) {
    __Pyx_ZeroBuffer(buf);
    return 0;
  }
  buf->buf = NULL;
  if (__Pyx_GetBuffer(obj, buf, flags) == -1) goto fail;
  if (buf->ndim != nd) {
    PyErr_Format(PyExc_ValueError,
                 "Buffer has wrong number of dimensions (expected %d, got %d)",
                 nd, buf->ndim);
    goto fail;
  }
  if (!cast) {
    __Pyx_BufFmt_Context ctx;
    __Pyx_BufFmt_Init(&ctx, stack, dtype);
    if (!__Pyx_BufFmt_CheckString(&ctx, buf->format)) goto fail;
  }
  if ((unsigned)buf->itemsize != dtype->size) {
    PyErr_Format(PyExc_ValueError,
      "Item size of buffer (%" CYTHON_FORMAT_SSIZE_T "d byte%s) does not match size of '%s' (%" CYTHON_FORMAT_SSIZE_T "d byte%s)",
      buf->itemsize, (buf->itemsize > 1) ? "s" : "",
      dtype->name, (Py_ssize_t)dtype->size, (dtype->size > 1) ? "s" : "");
    goto fail;
  }
  if (buf->suboffsets == NULL) buf->suboffsets = __Pyx_minusones;
  return 0;
fail:;
  __Pyx_ZeroBuffer(buf);
  return -1;
}
static CYTHON_INLINE void __Pyx_SafeReleaseBuffer(Py_buffer* info) {
  if (info->buf == NULL) return;
  if (info->suboffsets == __Pyx_minusones) info->suboffsets = NULL;
  __Pyx_ReleaseBuffer(info);
}

/* ExtTypeTest */
      static CYTHON_INLINE int __Pyx_TypeTest(PyObject *obj, PyTypeObject *type) {
    if (unlikely(!type)) {
        PyErr_SetString(PyExc_SystemError, "Missing type object");
        return 0;
    }
    if (likely(PyObject_TypeCheck(obj, type)))
        return 1;
    PyErr_Format(PyExc_TypeError, "Cannot convert %.200s to %.200s",
                 Py_TYPE(obj)->tp_name, type->tp_name);
    return 0;
}

/* RaiseTooManyValuesToUnpack */
      static CYTHON_INLINE void __Pyx_RaiseTooManyValuesError(Py_ssize_t expected) {
    PyErr_Format(PyExc_ValueError,
                 "too many values to unpack (expected %" CYTHON_FORMAT_SSIZE_T "d)", expected);
}

/* RaiseNeedMoreValuesToUnpack */
      static CYTHON_INLINE void __Pyx_RaiseNeedMoreValuesError(Py_ssize_t index) {
    PyErr_Format(PyExc_ValueError,
                 "need more than %" CYTHON_FORMAT_SSIZE_T "d value%.1s to unpack",
                 index, (index == 1) ? "" : "s");
}

/* IterFinish */
      static CYTHON_INLINE int __Pyx_IterFinish(void) {
#if CYTHON_COMPILING_IN_CPYTHON
    PyThreadState *tstate = PyThreadState_GET();
    PyObject* exc_type = tstate->curexc_type;
    if (unlikely(exc_type)) {
        if (likely(exc_type == PyExc_StopIteration) || PyErr_GivenExceptionMatches(exc_type, PyExc_StopIteration)) {
            PyObject *exc_value, *exc_tb;
            exc_value = tstate->curexc_value;
            exc_tb = tstate->curexc_traceback;
            tstate->curexc_type = 0;
            tstate->curexc_value = 0;
            tstate->curexc_traceback = 0;
            Py_DECREF(exc_type);
            Py_XDECREF(exc_value);
            Py_XDECREF(exc_tb);
            return 0;
        } else {
            return -1;
        }
    }
    return 0;
#else
    if (unlikely(PyErr_Occurred())) {
        if (likely(PyErr_ExceptionMatches(PyExc_StopIteration))) {
            PyErr_Clear();
            return 0;
        } else {
            return -1;
        }
    }
    return 0;
#endif
}

/* UnpackItemEndCheck */
      static int __Pyx_IternextUnpackEndCheck(PyObject *retval, Py_ssize_t expected) {
    if (unlikely(retval)) {
        Py_DECREF(retval);
        __Pyx_RaiseTooManyValuesError(expected);
        return -1;
    } else {
        return __Pyx_IterFinish();
    }
    return 0;
}

/* BufferFallbackError */
      static void __Pyx_RaiseBufferFallbackError(void) {
  PyErr_SetString(PyExc_ValueError,
     "Buffer acquisition failed on assignment; and then reacquiring the old buffer failed too!");
}

/* PyErrFetchRestore */
      #if CYTHON_COMPILING_IN_CPYTHON
static CYTHON_INLINE void __Pyx_ErrRestoreInState(PyThreadState *tstate, PyObject *type, PyObject *value, PyObject *tb) {
    PyObject *tmp_type, *tmp_value, *tmp_tb;
    tmp_type = tstate->curexc_type;
    tmp_value = tstate->curexc_value;
    tmp_tb = tstate->curexc_traceback;
    tstate->curexc_type = type;
    tstate->curexc_value = value;
    tstate->curexc_traceback = tb;
    Py_XDECREF(tmp_type);
    Py_XDECREF(tmp_value);
    Py_XDECREF(tmp_tb);
}
static CYTHON_INLINE void __Pyx_ErrFetchInState(PyThreadState *tstate, PyObject **type, PyObject **value, PyObject **tb) {
    *type = tstate->curexc_type;
    *value = tstate->curexc_value;
    *tb = tstate->curexc_traceback;
    tstate->curexc_type = 0;
    tstate->curexc_value = 0;
    tstate->curexc_traceback = 0;
}
#endif

/* PyObjectCallNoArg */
      #if CYTHON_COMPILING_IN_CPYTHON
static CYTHON_INLINE PyObject* __Pyx_PyObject_CallNoArg(PyObject *func) {
#ifdef __Pyx_CyFunction_USED
    if (likely(PyCFunction_Check(func) || PyObject_TypeCheck(func, __pyx_CyFunctionType))) {
#else
    if (likely(PyCFunction_Check(func))) {
#endif
        if (likely(PyCFunction_GET_FLAGS(func) & METH_NOARGS)) {
            return __Pyx_PyObject_CallMethO(func, NULL);
        }
    }
    return __Pyx_PyObject_Call(func, __pyx_empty_tuple, NULL);
}
#endif

/* None */
        static CYTHON_INLINE void __Pyx_RaiseUnboundLocalError(const char *varname) {
    PyErr_Format(PyExc_UnboundLocalError, "local variable '%s' referenced before assignment", varname);
}

/* BufferIndexError */
        static void __Pyx_RaiseBufferIndexError(int axis) {
  PyErr_Format(PyExc_IndexError,
     "Out of bounds on buffer access (axis %d)", axis);
}

/* SliceObject */
        static CYTHON_INLINE PyObject* __Pyx_PyObject_GetSlice(PyObject* obj,
        Py_ssize_t cstart, Py_ssize_t cstop,
        PyObject** _py_start, PyObject** _py_stop, PyObject** _py_slice,
        int has_cstart, int has_cstop, CYTHON_UNUSED int wraparound) {
#if CYTHON_COMPILING_IN_CPYTHON
    PyMappingMethods* mp;
#if PY_MAJOR_VERSION < 3
    PySequenceMethods* ms = Py_TYPE(obj)->tp_as_sequence;
    if (likely(ms && ms->sq_slice)) {
        if (!has_cstart) {
            if (_py_start && (*_py_start != Py_None)) {
                cstart = __Pyx_PyIndex_AsSsize_t(*_py_start);
                if ((cstart == (Py_ssize_t)-1) && PyErr_Occurred()) goto bad;
            } else
                cstart = 0;
        }
        if (!has_cstop) {
            if (_py_stop && (*_py_stop != Py_None)) {
                cstop = __Pyx_PyIndex_AsSsize_t(*_py_stop);
                if ((cstop == (Py_ssize_t)-1) && PyErr_Occurred()) goto bad;
            } else
                cstop = PY_SSIZE_T_MAX;
        }
        if (wraparound && unlikely((cstart < 0) | (cstop < 0)) && likely(ms->sq_length)) {
            Py_ssize_t l = ms->sq_length(obj);
            if (likely(l >= 0)) {
                if (cstop < 0) {
                    cstop += l;
                    if (cstop < 0) cstop = 0;
                }
                if (cstart < 0) {
                    cstart += l;
                    if (cstart < 0) cstart = 0;
                }
            } else {
                if (!PyErr_ExceptionMatches(PyExc_OverflowError))
                    goto bad;
                PyErr_Clear();
            }
        }
        return ms->sq_slice(obj, cstart, cstop);
    }
#endif
    mp = Py_TYPE(obj)->tp_as_mapping;
    if (likely(mp && mp->mp_subscript))
#endif
    {
        PyObject* result;
        PyObject *py_slice, *py_start, *py_stop;
        if (_py_slice) {
            py_slice = *_py_slice;
        } else {
            PyObject* owned_start = NULL;
            PyObject* owned_stop = NULL;
            if (_py_start) {
                py_start = *_py_start;
            } else {
                if (has_cstart) {
                    owned_start = py_start = PyInt_FromSsize_t(cstart);
                    if (unlikely(!py_start)) goto bad;
                } else
                    py_start = Py_None;
            }
            if (_py_stop) {
                py_stop = *_py_stop;
            } else {
                if (has_cstop) {
                    owned_stop = py_stop = PyInt_FromSsize_t(cstop);
                    if (unlikely(!py_stop)) {
                        Py_XDECREF(owned_start);
                        goto bad;
                    }
                } else
                    py_stop = Py_None;
            }
            py_slice = PySlice_New(py_start, py_stop, Py_None);
            Py_XDECREF(owned_start);
            Py_XDECREF(owned_stop);
            if (unlikely(!py_slice)) goto bad;
        }
#if CYTHON_COMPILING_IN_CPYTHON
        result = mp->mp_subscript(obj, py_slice);
#else
        result = PyObject_GetItem(obj, py_slice);
#endif
        if (!_py_slice) {
            Py_DECREF(py_slice);
        }
        return result;
    }
    PyErr_Format(PyExc_TypeError,
        "'%.200s' object is unsliceable", Py_TYPE(obj)->tp_name);
bad:
    return NULL;
}

/* RaiseException */
        #if PY_MAJOR_VERSION < 3
static void __Pyx_Raise(PyObject *type, PyObject *value, PyObject *tb,
                        CYTHON_UNUSED PyObject *cause) {
    __Pyx_PyThreadState_declare
    Py_XINCREF(type);
    if (!value || value == Py_None)
        value = NULL;
    else
        Py_INCREF(value);
    if (!tb || tb == Py_None)
        tb = NULL;
    else {
        Py_INCREF(tb);
        if (!PyTraceBack_Check(tb)) {
            PyErr_SetString(PyExc_TypeError,
                "raise: arg 3 must be a traceback or None");
            goto raise_error;
        }
    }
    if (PyType_Check(type)) {
#if CYTHON_COMPILING_IN_PYPY
        if (!value) {
            Py_INCREF(Py_None);
            value = Py_None;
        }
#endif
        PyErr_NormalizeException(&type, &value, &tb);
    } else {
        if (value) {
            PyErr_SetString(PyExc_TypeError,
                "instance exception may not have a separate value");
            goto raise_error;
        }
        value = type;
        type = (PyObject*) Py_TYPE(type);
        Py_INCREF(type);
        if (!PyType_IsSubtype((PyTypeObject *)type, (PyTypeObject *)PyExc_BaseException)) {
            PyErr_SetString(PyExc_TypeError,
                "raise: exception class must be a subclass of BaseException");
            goto raise_error;
        }
    }
    __Pyx_PyThreadState_assign
    __Pyx_ErrRestore(type, value, tb);
    return;
raise_error:
    Py_XDECREF(value);
    Py_XDECREF(type);
    Py_XDECREF(tb);
    return;
}
#else
static void __Pyx_Raise(PyObject *type, PyObject *value, PyObject *tb, PyObject *cause) {
    PyObject* owned_instance = NULL;
    if (tb == Py_None) {
        tb = 0;
    } else if (tb && !PyTraceBack_Check(tb)) {
        PyErr_SetString(PyExc_TypeError,
            "raise: arg 3 must be a traceback or None");
        goto bad;
    }
    if (value == Py_None)
        value = 0;
    if (PyExceptionInstance_Check(type)) {
        if (value) {
            PyErr_SetString(PyExc_TypeError,
                "instance exception may not have a separate value");
            goto bad;
        }
        value = type;
        type = (PyObject*) Py_TYPE(value);
    } else if (PyExceptionClass_Check(type)) {
        PyObject *instance_class = NULL;
        if (value && PyExceptionInstance_Check(value)) {
            instance_class = (PyObject*) Py_TYPE(value);
            if (instance_class != type) {
                int is_subclass = PyObject_IsSubclass(instance_class, type);
                if (!is_subclass) {
                    instance_class = NULL;
                } else if (unlikely(is_subclass == -1)) {
                    goto bad;
                } else {
                    type = instance_class;
                }
            }
        }
        if (!instance_class) {
            PyObject *args;
            if (!value)
                args = PyTuple_New(0);
            else if (PyTuple_Check(value)) {
                Py_INCREF(value);
                args = value;
            } else
                args = PyTuple_Pack(1, value);
            if (!args)
                goto bad;
            owned_instance = PyObject_Call(type, args, NULL);
            Py_DECREF(args);
            if (!owned_instance)
                goto bad;
            value = owned_instance;
            if (!PyExceptionInstance_Check(value)) {
                PyErr_Format(PyExc_TypeError,
                             "calling %R should have returned an instance of "
                             "BaseException, not %R",
                             type, Py_TYPE(value));
                goto bad;
            }
        }
    } else {
        PyErr_SetString(PyExc_TypeError,
            "raise: exception class must be a subclass of BaseException");
        goto bad;
    }
#if PY_VERSION_HEX >= 0x03030000
    if (cause) {
#else
    if (cause && cause != Py_None) {
#endif
        PyObject *fixed_cause;
        if (cause == Py_None) {
            fixed_cause = NULL;
        } else if (PyExceptionClass_Check(cause)) {
            fixed_cause = PyObject_CallObject(cause, NULL);
            if (fixed_cause == NULL)
                goto bad;
        } else if (PyExceptionInstance_Check(cause)) {
            fixed_cause = cause;
            Py_INCREF(fixed_cause);
        } else {
            PyErr_SetString(PyExc_TypeError,
                            "exception causes must derive from "
                            "BaseException");
            goto bad;
        }
        PyException_SetCause(value, fixed_cause);
    }
    PyErr_SetObject(type, value);
    if (tb) {
#if CYTHON_COMPILING_IN_PYPY
        PyObject *tmp_type, *tmp_value, *tmp_tb;
        PyErr_Fetch(&tmp_type, &tmp_value, &tmp_tb);
        Py_INCREF(tb);
        PyErr_Restore(tmp_type, tmp_value, tb);
        Py_XDECREF(tmp_tb);
#else
        PyThreadState *tstate = PyThreadState_GET();
        PyObject* tmp_tb = tstate->curexc_traceback;
        if (tb != tmp_tb) {
            Py_INCREF(tb);
            tstate->curexc_traceback = tb;
            Py_XDECREF(tmp_tb);
        }
#endif
    }
bad:
    Py_XDECREF(owned_instance);
    return;
}
#endif

/* GetItemInt */
          static CYTHON_INLINE PyObject *__Pyx_GetItemInt_Generic(PyObject *o, PyObject* j) {
    PyObject *r;
    if (!j) return NULL;
    r = PyObject_GetItem(o, j);
    Py_DECREF(j);
    return r;
}
static CYTHON_INLINE PyObject *__Pyx_GetItemInt_List_Fast(PyObject *o, Py_ssize_t i,
                                                              CYTHON_NCP_UNUSED int wraparound,
                                                              CYTHON_NCP_UNUSED int boundscheck) {
#if CYTHON_COMPILING_IN_CPYTHON
    if (wraparound & unlikely(i < 0)) i += PyList_GET_SIZE(o);
    if ((!boundscheck) || likely((0 <= i) & (i < PyList_GET_SIZE(o)))) {
        PyObject *r = PyList_GET_ITEM(o, i);
        Py_INCREF(r);
        return r;
    }
    return __Pyx_GetItemInt_Generic(o, PyInt_FromSsize_t(i));
#else
    return PySequence_GetItem(o, i);
#endif
}
static CYTHON_INLINE PyObject *__Pyx_GetItemInt_Tuple_Fast(PyObject *o, Py_ssize_t i,
                                                              CYTHON_NCP_UNUSED int wraparound,
                                                              CYTHON_NCP_UNUSED int boundscheck) {
#if CYTHON_COMPILING_IN_CPYTHON
    if (wraparound & unlikely(i < 0)) i += PyTuple_GET_SIZE(o);
    if ((!boundscheck) || likely((0 <= i) & (i < PyTuple_GET_SIZE(o)))) {
        PyObject *r = PyTuple_GET_ITEM(o, i);
        Py_INCREF(r);
        return r;
    }
    return __Pyx_GetItemInt_Generic(o, PyInt_FromSsize_t(i));
#else
    return PySequence_GetItem(o, i);
#endif
}
static CYTHON_INLINE PyObject *__Pyx_GetItemInt_Fast(PyObject *o, Py_ssize_t i, int is_list,
                                                     CYTHON_NCP_UNUSED int wraparound,
                                                     CYTHON_NCP_UNUSED int boundscheck) {
#if CYTHON_COMPILING_IN_CPYTHON
    if (is_list || PyList_CheckExact(o)) {
        Py_ssize_t n = ((!wraparound) | likely(i >= 0)) ? i : i + PyList_GET_SIZE(o);
        if ((!boundscheck) || (likely((n >= 0) & (n < PyList_GET_SIZE(o))))) {
            PyObject *r = PyList_GET_ITEM(o, n);
            Py_INCREF(r);
            return r;
        }
    }
    else if (PyTuple_CheckExact(o)) {
        Py_ssize_t n = ((!wraparound) | likely(i >= 0)) ? i : i + PyTuple_GET_SIZE(o);
        if ((!boundscheck) || likely((n >= 0) & (n < PyTuple_GET_SIZE(o)))) {
            PyObject *r = PyTuple_GET_ITEM(o, n);
            Py_INCREF(r);
            return r;
        }
    } else {
        PySequenceMethods *m = Py_TYPE(o)->tp_as_sequence;
        if (likely(m && m->sq_item)) {
            if (wraparound && unlikely(i < 0) && likely(m->sq_length)) {
                Py_ssize_t l = m->sq_length(o);
                if (likely(l >= 0)) {
                    i += l;
                } else {
                    if (!PyErr_ExceptionMatches(PyExc_OverflowError))
                        return NULL;
                    PyErr_Clear();
                }
            }
            return m->sq_item(o, i);
        }
    }
#else
    if (is_list || PySequence_Check(o)) {
        return PySequence_GetItem(o, i);
    }
#endif
    return __Pyx_GetItemInt_Generic(o, PyInt_FromSsize_t(i));
}

/* PyIntBinop */
          #if CYTHON_COMPILING_IN_CPYTHON
static PyObject* __Pyx_PyInt_AddObjC(PyObject *op1, PyObject *op2, CYTHON_UNUSED long intval, CYTHON_UNUSED int inplace) {
    #if PY_MAJOR_VERSION < 3
    if (likely(PyInt_CheckExact(op1))) {
        const long b = intval;
        long x;
        long a = PyInt_AS_LONG(op1);
            x = (long)((unsigned long)a + b);
            if (likely((x^a) >= 0 || (x^b) >= 0))
                return PyInt_FromLong(x);
            return PyLong_Type.tp_as_number->nb_add(op1, op2);
    }
    #endif
    #if CYTHON_USE_PYLONG_INTERNALS && PY_MAJOR_VERSION >= 3
    if (likely(PyLong_CheckExact(op1))) {
        const long b = intval;
        long a, x;
        const PY_LONG_LONG llb = intval;
        PY_LONG_LONG lla, llx;
        const digit* digits = ((PyLongObject*)op1)->ob_digit;
        const Py_ssize_t size = Py_SIZE(op1);
        if (likely(__Pyx_sst_abs(size) <= 1)) {
            a = likely(size) ? digits[0] : 0;
            if (size == -1) a = -a;
        } else {
            switch (size) {
                case -2:
                    if (8 * sizeof(long) - 1 > 2 * PyLong_SHIFT) {
                        a = -(long) (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
                        break;
                    } else if (8 * sizeof(PY_LONG_LONG) - 1 > 2 * PyLong_SHIFT) {
                        lla = -(PY_LONG_LONG) (((((unsigned PY_LONG_LONG)digits[1]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[0]));
                        goto long_long;
                    }
                case 2:
                    if (8 * sizeof(long) - 1 > 2 * PyLong_SHIFT) {
                        a = (long) (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
                        break;
                    } else if (8 * sizeof(PY_LONG_LONG) - 1 > 2 * PyLong_SHIFT) {
                        lla = (PY_LONG_LONG) (((((unsigned PY_LONG_LONG)digits[1]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[0]));
                        goto long_long;
                    }
                case -3:
                    if (8 * sizeof(long) - 1 > 3 * PyLong_SHIFT) {
                        a = -(long) (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
                        break;
                    } else if (8 * sizeof(PY_LONG_LONG) - 1 > 3 * PyLong_SHIFT) {
                        lla = -(PY_LONG_LONG) (((((((unsigned PY_LONG_LONG)digits[2]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[1]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[0]));
                        goto long_long;
                    }
                case 3:
                    if (8 * sizeof(long) - 1 > 3 * PyLong_SHIFT) {
                        a = (long) (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
                        break;
                    } else if (8 * sizeof(PY_LONG_LONG) - 1 > 3 * PyLong_SHIFT) {
                        lla = (PY_LONG_LONG) (((((((unsigned PY_LONG_LONG)digits[2]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[1]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[0]));
                        goto long_long;
                    }
                case -4:
                    if (8 * sizeof(long) - 1 > 4 * PyLong_SHIFT) {
                        a = -(long) (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
                        break;
                    } else if (8 * sizeof(PY_LONG_LONG) - 1 > 4 * PyLong_SHIFT) {
                        lla = -(PY_LONG_LONG) (((((((((unsigned PY_LONG_LONG)digits[3]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[2]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[1]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[0]));
                        goto long_long;
                    }
                case 4:
                    if (8 * sizeof(long) - 1 > 4 * PyLong_SHIFT) {
                        a = (long) (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
                        break;
                    } else if (8 * sizeof(PY_LONG_LONG) - 1 > 4 * PyLong_SHIFT) {
                        lla = (PY_LONG_LONG) (((((((((unsigned PY_LONG_LONG)digits[3]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[2]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[1]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[0]));
                        goto long_long;
                    }
                default: return PyLong_Type.tp_as_number->nb_add(op1, op2);
            }
        }
                x = a + b;
            return PyLong_FromLong(x);
        long_long:
                llx = lla + llb;
            return PyLong_FromLongLong(llx);
    }
    #endif
    if (PyFloat_CheckExact(op1)) {
        const long b = intval;
        double a = PyFloat_AS_DOUBLE(op1);
            double result;
            PyFPE_START_PROTECT("add", return NULL)
            result = ((double)a) + (double)b;
            PyFPE_END_PROTECT(result)
            return PyFloat_FromDouble(result);
    }
    return (inplace ? PyNumber_InPlaceAdd : PyNumber_Add)(op1, op2);
}
#endif

/* BytesEquals */
          static CYTHON_INLINE int __Pyx_PyBytes_Equals(PyObject* s1, PyObject* s2, int equals) {
#if CYTHON_COMPILING_IN_PYPY
    return PyObject_RichCompareBool(s1, s2, equals);
#else
    if (s1 == s2) {
        return (equals == Py_EQ);
    } else if (PyBytes_CheckExact(s1) & PyBytes_CheckExact(s2)) {
        const char *ps1, *ps2;
        Py_ssize_t length = PyBytes_GET_SIZE(s1);
        if (length != PyBytes_GET_SIZE(s2))
            return (equals == Py_NE);
        ps1 = PyBytes_AS_STRING(s1);
        ps2 = PyBytes_AS_STRING(s2);
        if (ps1[0] != ps2[0]) {
            return (equals == Py_NE);
        } else if (length == 1) {
            return (equals == Py_EQ);
        } else {
            int result = memcmp(ps1, ps2, (size_t)length);
            return (equals == Py_EQ) ? (result == 0) : (result != 0);
        }
    } else if ((s1 == Py_None) & PyBytes_CheckExact(s2)) {
        return (equals == Py_NE);
    } else if ((s2 == Py_None) & PyBytes_CheckExact(s1)) {
        return (equals == Py_NE);
    } else {
        int result;
        PyObject* py_result = PyObject_RichCompare(s1, s2, equals);
        if (!py_result)
            return -1;
        result = __Pyx_PyObject_IsTrue(py_result);
        Py_DECREF(py_result);
        return result;
    }
#endif
}

/* UnicodeEquals */
          static CYTHON_INLINE int __Pyx_PyUnicode_Equals(PyObject* s1, PyObject* s2, int equals) {
#if CYTHON_COMPILING_IN_PYPY
    return PyObject_RichCompareBool(s1, s2, equals);
#else
#if PY_MAJOR_VERSION < 3
    PyObject* owned_ref = NULL;
#endif
    int s1_is_unicode, s2_is_unicode;
    if (s1 == s2) {
        goto return_eq;
    }
    s1_is_unicode = PyUnicode_CheckExact(s1);
    s2_is_unicode = PyUnicode_CheckExact(s2);
#if PY_MAJOR_VERSION < 3
    if ((s1_is_unicode & (!s2_is_unicode)) && PyString_CheckExact(s2)) {
        owned_ref = PyUnicode_FromObject(s2);
        if (unlikely(!owned_ref))
            return -1;
        s2 = owned_ref;
        s2_is_unicode = 1;
    } else if ((s2_is_unicode & (!s1_is_unicode)) && PyString_CheckExact(s1)) {
        owned_ref = PyUnicode_FromObject(s1);
        if (unlikely(!owned_ref))
            return -1;
        s1 = owned_ref;
        s1_is_unicode = 1;
    } else if (((!s2_is_unicode) & (!s1_is_unicode))) {
        return __Pyx_PyBytes_Equals(s1, s2, equals);
    }
#endif
    if (s1_is_unicode & s2_is_unicode) {
        Py_ssize_t length;
        int kind;
        void *data1, *data2;
        if (unlikely(__Pyx_PyUnicode_READY(s1) < 0) || unlikely(__Pyx_PyUnicode_READY(s2) < 0))
            return -1;
        length = __Pyx_PyUnicode_GET_LENGTH(s1);
        if (length != __Pyx_PyUnicode_GET_LENGTH(s2)) {
            goto return_ne;
        }
        kind = __Pyx_PyUnicode_KIND(s1);
        if (kind != __Pyx_PyUnicode_KIND(s2)) {
            goto return_ne;
        }
        data1 = __Pyx_PyUnicode_DATA(s1);
        data2 = __Pyx_PyUnicode_DATA(s2);
        if (__Pyx_PyUnicode_READ(kind, data1, 0) != __Pyx_PyUnicode_READ(kind, data2, 0)) {
            goto return_ne;
        } else if (length == 1) {
            goto return_eq;
        } else {
            int result = memcmp(data1, data2, (size_t)(length * kind));
            #if PY_MAJOR_VERSION < 3
            Py_XDECREF(owned_ref);
            #endif
            return (equals == Py_EQ) ? (result == 0) : (result != 0);
        }
    } else if ((s1 == Py_None) & s2_is_unicode) {
        goto return_ne;
    } else if ((s2 == Py_None) & s1_is_unicode) {
        goto return_ne;
    } else {
        int result;
        PyObject* py_result = PyObject_RichCompare(s1, s2, equals);
        if (!py_result)
            return -1;
        result = __Pyx_PyObject_IsTrue(py_result);
        Py_DECREF(py_result);
        return result;
    }
return_eq:
    #if PY_MAJOR_VERSION < 3
    Py_XDECREF(owned_ref);
    #endif
    return (equals == Py_EQ);
return_ne:
    #if PY_MAJOR_VERSION < 3
    Py_XDECREF(owned_ref);
    #endif
    return (equals == Py_NE);
#endif
}

/* SliceObject */
          static CYTHON_INLINE int __Pyx_PyObject_SetSlice(PyObject* obj, PyObject* value,
        Py_ssize_t cstart, Py_ssize_t cstop,
        PyObject** _py_start, PyObject** _py_stop, PyObject** _py_slice,
        int has_cstart, int has_cstop, CYTHON_UNUSED int wraparound) {
#if CYTHON_COMPILING_IN_CPYTHON
    PyMappingMethods* mp;
#if PY_MAJOR_VERSION < 3
    PySequenceMethods* ms = Py_TYPE(obj)->tp_as_sequence;
    if (likely(ms && ms->sq_ass_slice)) {
        if (!has_cstart) {
            if (_py_start && (*_py_start != Py_None)) {
                cstart = __Pyx_PyIndex_AsSsize_t(*_py_start);
                if ((cstart == (Py_ssize_t)-1) && PyErr_Occurred()) goto bad;
            } else
                cstart = 0;
        }
        if (!has_cstop) {
            if (_py_stop && (*_py_stop != Py_None)) {
                cstop = __Pyx_PyIndex_AsSsize_t(*_py_stop);
                if ((cstop == (Py_ssize_t)-1) && PyErr_Occurred()) goto bad;
            } else
                cstop = PY_SSIZE_T_MAX;
        }
        if (wraparound && unlikely((cstart < 0) | (cstop < 0)) && likely(ms->sq_length)) {
            Py_ssize_t l = ms->sq_length(obj);
            if (likely(l >= 0)) {
                if (cstop < 0) {
                    cstop += l;
                    if (cstop < 0) cstop = 0;
                }
                if (cstart < 0) {
                    cstart += l;
                    if (cstart < 0) cstart = 0;
                }
            } else {
                if (!PyErr_ExceptionMatches(PyExc_OverflowError))
                    goto bad;
                PyErr_Clear();
            }
        }
        return ms->sq_ass_slice(obj, cstart, cstop, value);
    }
#endif
    mp = Py_TYPE(obj)->tp_as_mapping;
    if (likely(mp && mp->mp_ass_subscript))
#endif
    {
        int result;
        PyObject *py_slice, *py_start, *py_stop;
        if (_py_slice) {
            py_slice = *_py_slice;
        } else {
            PyObject* owned_start = NULL;
            PyObject* owned_stop = NULL;
            if (_py_start) {
                py_start = *_py_start;
            } else {
                if (has_cstart) {
                    owned_start = py_start = PyInt_FromSsize_t(cstart);
                    if (unlikely(!py_start)) goto bad;
                } else
                    py_start = Py_None;
            }
            if (_py_stop) {
                py_stop = *_py_stop;
            } else {
                if (has_cstop) {
                    owned_stop = py_stop = PyInt_FromSsize_t(cstop);
                    if (unlikely(!py_stop)) {
                        Py_XDECREF(owned_start);
                        goto bad;
                    }
                } else
                    py_stop = Py_None;
            }
            py_slice = PySlice_New(py_start, py_stop, Py_None);
            Py_XDECREF(owned_start);
            Py_XDECREF(owned_stop);
            if (unlikely(!py_slice)) goto bad;
        }
#if CYTHON_COMPILING_IN_CPYTHON
        result = mp->mp_ass_subscript(obj, py_slice, value);
#else
        result = value ? PyObject_SetItem(obj, py_slice, value) : PyObject_DelItem(obj, py_slice);
#endif
        if (!_py_slice) {
            Py_DECREF(py_slice);
        }
        return result;
    }
    PyErr_Format(PyExc_TypeError,
        "'%.200s' object does not support slice %.10s",
        Py_TYPE(obj)->tp_name, value ? "assignment" : "deletion");
bad:
    return -1;
}

/* PyFloatBinop */
          #if CYTHON_COMPILING_IN_CPYTHON
static PyObject* __Pyx_PyFloat_AddObjC(PyObject *op1, PyObject *op2, double floatval, CYTHON_UNUSED int inplace) {
    const double b = floatval;
    double a, result;
    if (likely(PyFloat_CheckExact(op1))) {
        a = PyFloat_AS_DOUBLE(op1);
    } else
    #if PY_MAJOR_VERSION < 3
    if (likely(PyInt_CheckExact(op1))) {
        a = (double) PyInt_AS_LONG(op1);
    } else
    #endif
    if (likely(PyLong_CheckExact(op1))) {
        #if CYTHON_USE_PYLONG_INTERNALS && PY_MAJOR_VERSION >= 3
        const digit* digits = ((PyLongObject*)op1)->ob_digit;
        const Py_ssize_t size = Py_SIZE(op1);
        switch (size) {
            case  0: a = 0.0; break;
            case -1: a = -(double) digits[0]; break;
            case  1: a = (double) digits[0]; break;
            case -2:
            case 2:
                if (8 * sizeof(unsigned long) > 2 * PyLong_SHIFT && ((8 * sizeof(unsigned long) < 53) || (1 * PyLong_SHIFT < 53))) {
                    a = (double) (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
                    if ((8 * sizeof(unsigned long) < 53) || (2 * PyLong_SHIFT < 53) || (a < (double) (1L<<53))) {
                        if (size == -2)
                            a = -a;
                        break;
                    }
                }
            case -3:
            case 3:
                if (8 * sizeof(unsigned long) > 3 * PyLong_SHIFT && ((8 * sizeof(unsigned long) < 53) || (2 * PyLong_SHIFT < 53))) {
                    a = (double) (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
                    if ((8 * sizeof(unsigned long) < 53) || (3 * PyLong_SHIFT < 53) || (a < (double) (1L<<53))) {
                        if (size == -3)
                            a = -a;
                        break;
                    }
                }
            case -4:
            case 4:
                if (8 * sizeof(unsigned long) > 4 * PyLong_SHIFT && ((8 * sizeof(unsigned long) < 53) || (3 * PyLong_SHIFT < 53))) {
                    a = (double) (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
                    if ((8 * sizeof(unsigned long) < 53) || (4 * PyLong_SHIFT < 53) || (a < (double) (1L<<53))) {
                        if (size == -4)
                            a = -a;
                        break;
                    }
                }
            default:
        #else
        {
        #endif
            a = PyLong_AsDouble(op1);
            if (unlikely(a == -1.0 && PyErr_Occurred())) return NULL;
        }
    } else {
        return (inplace ? PyNumber_InPlaceAdd : PyNumber_Add)(op1, op2);
    }
        PyFPE_START_PROTECT("add", return NULL)
        result = a + b;
        PyFPE_END_PROTECT(result)
        return PyFloat_FromDouble(result);
}
#endif

/* None */
            static CYTHON_INLINE long __Pyx_mod_long(long a, long b) {
    long r = a % b;
    r += ((r != 0) & ((r ^ b) < 0)) * b;
    return r;
}

/* None */
            static CYTHON_INLINE int __Pyx_mod_int(int a, int b) {
    int r = a % b;
    r += ((r != 0) & ((r ^ b) < 0)) * b;
    return r;
}

/* None */
            static CYTHON_INLINE void __Pyx_RaiseClosureNameError(const char *varname) {
    PyErr_Format(PyExc_NameError, "free variable '%s' referenced before assignment in enclosing scope", varname);
}

/* FetchCommonType */
            static PyTypeObject* __Pyx_FetchCommonType(PyTypeObject* type) {
    PyObject* fake_module;
    PyTypeObject* cached_type = NULL;
    fake_module = PyImport_AddModule((char*) "_cython_" CYTHON_ABI);
    if (!fake_module) return NULL;
    Py_INCREF(fake_module);
    cached_type = (PyTypeObject*) PyObject_GetAttrString(fake_module, type->tp_name);
    if (cached_type) {
        if (!PyType_Check((PyObject*)cached_type)) {
            PyErr_Format(PyExc_TypeError,
                "Shared Cython type %.200s is not a type object",
                type->tp_name);
            goto bad;
        }
        if (cached_type->tp_basicsize != type->tp_basicsize) {
            PyErr_Format(PyExc_TypeError,
                "Shared Cython type %.200s has the wrong size, try recompiling",
                type->tp_name);
            goto bad;
        }
    } else {
        if (!PyErr_ExceptionMatches(PyExc_AttributeError)) goto bad;
        PyErr_Clear();
        if (PyType_Ready(type) < 0) goto bad;
        if (PyObject_SetAttrString(fake_module, type->tp_name, (PyObject*) type) < 0)
            goto bad;
        Py_INCREF(type);
        cached_type = type;
    }
done:
    Py_DECREF(fake_module);
    return cached_type;
bad:
    Py_XDECREF(cached_type);
    cached_type = NULL;
    goto done;
}

/* CythonFunction */
            static PyObject *
__Pyx_CyFunction_get_doc(__pyx_CyFunctionObject *op, CYTHON_UNUSED void *closure)
{
    if (unlikely(op->func_doc == NULL)) {
        if (op->func.m_ml->ml_doc) {
#if PY_MAJOR_VERSION >= 3
            op->func_doc = PyUnicode_FromString(op->func.m_ml->ml_doc);
#else
            op->func_doc = PyString_FromString(op->func.m_ml->ml_doc);
#endif
            if (unlikely(op->func_doc == NULL))
                return NULL;
        } else {
            Py_INCREF(Py_None);
            return Py_None;
        }
    }
    Py_INCREF(op->func_doc);
    return op->func_doc;
}
static int
__Pyx_CyFunction_set_doc(__pyx_CyFunctionObject *op, PyObject *value)
{
    PyObject *tmp = op->func_doc;
    if (value == NULL) {
        value = Py_None;
    }
    Py_INCREF(value);
    op->func_doc = value;
    Py_XDECREF(tmp);
    return 0;
}
static PyObject *
__Pyx_CyFunction_get_name(__pyx_CyFunctionObject *op)
{
    if (unlikely(op->func_name == NULL)) {
#if PY_MAJOR_VERSION >= 3
        op->func_name = PyUnicode_InternFromString(op->func.m_ml->ml_name);
#else
        op->func_name = PyString_InternFromString(op->func.m_ml->ml_name);
#endif
        if (unlikely(op->func_name == NULL))
            return NULL;
    }
    Py_INCREF(op->func_name);
    return op->func_name;
}
static int
__Pyx_CyFunction_set_name(__pyx_CyFunctionObject *op, PyObject *value)
{
    PyObject *tmp;
#if PY_MAJOR_VERSION >= 3
    if (unlikely(value == NULL || !PyUnicode_Check(value))) {
#else
    if (unlikely(value == NULL || !PyString_Check(value))) {
#endif
        PyErr_SetString(PyExc_TypeError,
                        "__name__ must be set to a string object");
        return -1;
    }
    tmp = op->func_name;
    Py_INCREF(value);
    op->func_name = value;
    Py_XDECREF(tmp);
    return 0;
}
static PyObject *
__Pyx_CyFunction_get_qualname(__pyx_CyFunctionObject *op)
{
    Py_INCREF(op->func_qualname);
    return op->func_qualname;
}
static int
__Pyx_CyFunction_set_qualname(__pyx_CyFunctionObject *op, PyObject *value)
{
    PyObject *tmp;
#if PY_MAJOR_VERSION >= 3
    if (unlikely(value == NULL || !PyUnicode_Check(value))) {
#else
    if (unlikely(value == NULL || !PyString_Check(value))) {
#endif
        PyErr_SetString(PyExc_TypeError,
                        "__qualname__ must be set to a string object");
        return -1;
    }
    tmp = op->func_qualname;
    Py_INCREF(value);
    op->func_qualname = value;
    Py_XDECREF(tmp);
    return 0;
}
static PyObject *
__Pyx_CyFunction_get_self(__pyx_CyFunctionObject *m, CYTHON_UNUSED void *closure)
{
    PyObject *self;
    self = m->func_closure;
    if (self == NULL)
        self = Py_None;
    Py_INCREF(self);
    return self;
}
static PyObject *
__Pyx_CyFunction_get_dict(__pyx_CyFunctionObject *op)
{
    if (unlikely(op->func_dict == NULL)) {
        op->func_dict = PyDict_New();
        if (unlikely(op->func_dict == NULL))
            return NULL;
    }
    Py_INCREF(op->func_dict);
    return op->func_dict;
}
static int
__Pyx_CyFunction_set_dict(__pyx_CyFunctionObject *op, PyObject *value)
{
    PyObject *tmp;
    if (unlikely(value == NULL)) {
        PyErr_SetString(PyExc_TypeError,
               "function's dictionary may not be deleted");
        return -1;
    }
    if (unlikely(!PyDict_Check(value))) {
        PyErr_SetString(PyExc_TypeError,
               "setting function's dictionary to a non-dict");
        return -1;
    }
    tmp = op->func_dict;
    Py_INCREF(value);
    op->func_dict = value;
    Py_XDECREF(tmp);
    return 0;
}
static PyObject *
__Pyx_CyFunction_get_globals(__pyx_CyFunctionObject *op)
{
    Py_INCREF(op->func_globals);
    return op->func_globals;
}
static PyObject *
__Pyx_CyFunction_get_closure(CYTHON_UNUSED __pyx_CyFunctionObject *op)
{
    Py_INCREF(Py_None);
    return Py_None;
}
static PyObject *
__Pyx_CyFunction_get_code(__pyx_CyFunctionObject *op)
{
    PyObject* result = (op->func_code) ? op->func_code : Py_None;
    Py_INCREF(result);
    return result;
}
static int
__Pyx_CyFunction_init_defaults(__pyx_CyFunctionObject *op) {
    int result = 0;
    PyObject *res = op->defaults_getter((PyObject *) op);
    if (unlikely(!res))
        return -1;
    #if CYTHON_COMPILING_IN_CPYTHON
    op->defaults_tuple = PyTuple_GET_ITEM(res, 0);
    Py_INCREF(op->defaults_tuple);
    op->defaults_kwdict = PyTuple_GET_ITEM(res, 1);
    Py_INCREF(op->defaults_kwdict);
    #else
    op->defaults_tuple = PySequence_ITEM(res, 0);
    if (unlikely(!op->defaults_tuple)) result = -1;
    else {
        op->defaults_kwdict = PySequence_ITEM(res, 1);
        if (unlikely(!op->defaults_kwdict)) result = -1;
    }
    #endif
    Py_DECREF(res);
    return result;
}
static int
__Pyx_CyFunction_set_defaults(__pyx_CyFunctionObject *op, PyObject* value) {
    PyObject* tmp;
    if (!value) {
        value = Py_None;
    } else if (value != Py_None && !PyTuple_Check(value)) {
        PyErr_SetString(PyExc_TypeError,
                        "__defaults__ must be set to a tuple object");
        return -1;
    }
    Py_INCREF(value);
    tmp = op->defaults_tuple;
    op->defaults_tuple = value;
    Py_XDECREF(tmp);
    return 0;
}
static PyObject *
__Pyx_CyFunction_get_defaults(__pyx_CyFunctionObject *op) {
    PyObject* result = op->defaults_tuple;
    if (unlikely(!result)) {
        if (op->defaults_getter) {
            if (__Pyx_CyFunction_init_defaults(op) < 0) return NULL;
            result = op->defaults_tuple;
        } else {
            result = Py_None;
        }
    }
    Py_INCREF(result);
    return result;
}
static int
__Pyx_CyFunction_set_kwdefaults(__pyx_CyFunctionObject *op, PyObject* value) {
    PyObject* tmp;
    if (!value) {
        value = Py_None;
    } else if (value != Py_None && !PyDict_Check(value)) {
        PyErr_SetString(PyExc_TypeError,
                        "__kwdefaults__ must be set to a dict object");
        return -1;
    }
    Py_INCREF(value);
    tmp = op->defaults_kwdict;
    op->defaults_kwdict = value;
    Py_XDECREF(tmp);
    return 0;
}
static PyObject *
__Pyx_CyFunction_get_kwdefaults(__pyx_CyFunctionObject *op) {
    PyObject* result = op->defaults_kwdict;
    if (unlikely(!result)) {
        if (op->defaults_getter) {
            if (__Pyx_CyFunction_init_defaults(op) < 0) return NULL;
            result = op->defaults_kwdict;
        } else {
            result = Py_None;
        }
    }
    Py_INCREF(result);
    return result;
}
static int
__Pyx_CyFunction_set_annotations(__pyx_CyFunctionObject *op, PyObject* value) {
    PyObject* tmp;
    if (!value || value == Py_None) {
        value = NULL;
    } else if (!PyDict_Check(value)) {
        PyErr_SetString(PyExc_TypeError,
                        "__annotations__ must be set to a dict object");
        return -1;
    }
    Py_XINCREF(value);
    tmp = op->func_annotations;
    op->func_annotations = value;
    Py_XDECREF(tmp);
    return 0;
}
static PyObject *
__Pyx_CyFunction_get_annotations(__pyx_CyFunctionObject *op) {
    PyObject* result = op->func_annotations;
    if (unlikely(!result)) {
        result = PyDict_New();
        if (unlikely(!result)) return NULL;
        op->func_annotations = result;
    }
    Py_INCREF(result);
    return result;
}
static PyGetSetDef __pyx_CyFunction_getsets[] = {
    {(char *) "func_doc", (getter)__Pyx_CyFunction_get_doc, (setter)__Pyx_CyFunction_set_doc, 0, 0},
    {(char *) "__doc__",  (getter)__Pyx_CyFunction_get_doc, (setter)__Pyx_CyFunction_set_doc, 0, 0},
    {(char *) "func_name", (getter)__Pyx_CyFunction_get_name, (setter)__Pyx_CyFunction_set_name, 0, 0},
    {(char *) "__name__", (getter)__Pyx_CyFunction_get_name, (setter)__Pyx_CyFunction_set_name, 0, 0},
    {(char *) "__qualname__", (getter)__Pyx_CyFunction_get_qualname, (setter)__Pyx_CyFunction_set_qualname, 0, 0},
    {(char *) "__self__", (getter)__Pyx_CyFunction_get_self, 0, 0, 0},
    {(char *) "func_dict", (getter)__Pyx_CyFunction_get_dict, (setter)__Pyx_CyFunction_set_dict, 0, 0},
    {(char *) "__dict__", (getter)__Pyx_CyFunction_get_dict, (setter)__Pyx_CyFunction_set_dict, 0, 0},
    {(char *) "func_globals", (getter)__Pyx_CyFunction_get_globals, 0, 0, 0},
    {(char *) "__globals__", (getter)__Pyx_CyFunction_get_globals, 0, 0, 0},
    {(char *) "func_closure", (getter)__Pyx_CyFunction_get_closure, 0, 0, 0},
    {(char *) "__closure__", (getter)__Pyx_CyFunction_get_closure, 0, 0, 0},
    {(char *) "func_code", (getter)__Pyx_CyFunction_get_code, 0, 0, 0},
    {(char *) "__code__", (getter)__Pyx_CyFunction_get_code, 0, 0, 0},
    {(char *) "func_defaults", (getter)__Pyx_CyFunction_get_defaults, (setter)__Pyx_CyFunction_set_defaults, 0, 0},
    {(char *) "__defaults__", (getter)__Pyx_CyFunction_get_defaults, (setter)__Pyx_CyFunction_set_defaults, 0, 0},
    {(char *) "__kwdefaults__", (getter)__Pyx_CyFunction_get_kwdefaults, (setter)__Pyx_CyFunction_set_kwdefaults, 0, 0},
    {(char *) "__annotations__", (getter)__Pyx_CyFunction_get_annotations, (setter)__Pyx_CyFunction_set_annotations, 0, 0},
    {0, 0, 0, 0, 0}
};
static PyMemberDef __pyx_CyFunction_members[] = {
    {(char *) "__module__", T_OBJECT, offsetof(__pyx_CyFunctionObject, func.m_module), PY_WRITE_RESTRICTED, 0},
    {0, 0, 0,  0, 0}
};
static PyObject *
__Pyx_CyFunction_reduce(__pyx_CyFunctionObject *m, CYTHON_UNUSED PyObject *args)
{
#if PY_MAJOR_VERSION >= 3
    return PyUnicode_FromString(m->func.m_ml->ml_name);
#else
    return PyString_FromString(m->func.m_ml->ml_name);
#endif
}
static PyMethodDef __pyx_CyFunction_methods[] = {
    {"__reduce__", (PyCFunction)__Pyx_CyFunction_reduce, METH_VARARGS, 0},
    {0, 0, 0, 0}
};
#if PY_VERSION_HEX < 0x030500A0
#define __Pyx_CyFunction_weakreflist(cyfunc) ((cyfunc)->func_weakreflist)
#else
#define __Pyx_CyFunction_weakreflist(cyfunc) ((cyfunc)->func.m_weakreflist)
#endif
static PyObject *__Pyx_CyFunction_New(PyTypeObject *type, PyMethodDef *ml, int flags, PyObject* qualname,
                                      PyObject *closure, PyObject *module, PyObject* globals, PyObject* code) {
    __pyx_CyFunctionObject *op = PyObject_GC_New(__pyx_CyFunctionObject, type);
    if (op == NULL)
        return NULL;
    op->flags = flags;
    __Pyx_CyFunction_weakreflist(op) = NULL;
    op->func.m_ml = ml;
    op->func.m_self = (PyObject *) op;
    Py_XINCREF(closure);
    op->func_closure = closure;
    Py_XINCREF(module);
    op->func.m_module = module;
    op->func_dict = NULL;
    op->func_name = NULL;
    Py_INCREF(qualname);
    op->func_qualname = qualname;
    op->func_doc = NULL;
    op->func_classobj = NULL;
    op->func_globals = globals;
    Py_INCREF(op->func_globals);
    Py_XINCREF(code);
    op->func_code = code;
    op->defaults_pyobjects = 0;
    op->defaults = NULL;
    op->defaults_tuple = NULL;
    op->defaults_kwdict = NULL;
    op->defaults_getter = NULL;
    op->func_annotations = NULL;
    PyObject_GC_Track(op);
    return (PyObject *) op;
}
static int
__Pyx_CyFunction_clear(__pyx_CyFunctionObject *m)
{
    Py_CLEAR(m->func_closure);
    Py_CLEAR(m->func.m_module);
    Py_CLEAR(m->func_dict);
    Py_CLEAR(m->func_name);
    Py_CLEAR(m->func_qualname);
    Py_CLEAR(m->func_doc);
    Py_CLEAR(m->func_globals);
    Py_CLEAR(m->func_code);
    Py_CLEAR(m->func_classobj);
    Py_CLEAR(m->defaults_tuple);
    Py_CLEAR(m->defaults_kwdict);
    Py_CLEAR(m->func_annotations);
    if (m->defaults) {
        PyObject **pydefaults = __Pyx_CyFunction_Defaults(PyObject *, m);
        int i;
        for (i = 0; i < m->defaults_pyobjects; i++)
            Py_XDECREF(pydefaults[i]);
        PyObject_Free(m->defaults);
        m->defaults = NULL;
    }
    return 0;
}
static void __Pyx_CyFunction_dealloc(__pyx_CyFunctionObject *m)
{
    PyObject_GC_UnTrack(m);
    if (__Pyx_CyFunction_weakreflist(m) != NULL)
        PyObject_ClearWeakRefs((PyObject *) m);
    __Pyx_CyFunction_clear(m);
    PyObject_GC_Del(m);
}
static int __Pyx_CyFunction_traverse(__pyx_CyFunctionObject *m, visitproc visit, void *arg)
{
    Py_VISIT(m->func_closure);
    Py_VISIT(m->func.m_module);
    Py_VISIT(m->func_dict);
    Py_VISIT(m->func_name);
    Py_VISIT(m->func_qualname);
    Py_VISIT(m->func_doc);
    Py_VISIT(m->func_globals);
    Py_VISIT(m->func_code);
    Py_VISIT(m->func_classobj);
    Py_VISIT(m->defaults_tuple);
    Py_VISIT(m->defaults_kwdict);
    if (m->defaults) {
        PyObject **pydefaults = __Pyx_CyFunction_Defaults(PyObject *, m);
        int i;
        for (i = 0; i < m->defaults_pyobjects; i++)
            Py_VISIT(pydefaults[i]);
    }
    return 0;
}
static PyObject *__Pyx_CyFunction_descr_get(PyObject *func, PyObject *obj, PyObject *type)
{
    __pyx_CyFunctionObject *m = (__pyx_CyFunctionObject *) func;
    if (m->flags & __Pyx_CYFUNCTION_STATICMETHOD) {
        Py_INCREF(func);
        return func;
    }
    if (m->flags & __Pyx_CYFUNCTION_CLASSMETHOD) {
        if (type == NULL)
            type = (PyObject *)(Py_TYPE(obj));
        return __Pyx_PyMethod_New(func, type, (PyObject *)(Py_TYPE(type)));
    }
    if (obj == Py_None)
        obj = NULL;
    return __Pyx_PyMethod_New(func, obj, type);
}
static PyObject*
__Pyx_CyFunction_repr(__pyx_CyFunctionObject *op)
{
#if PY_MAJOR_VERSION >= 3
    return PyUnicode_FromFormat("<cyfunction %U at %p>",
                                op->func_qualname, (void *)op);
#else
    return PyString_FromFormat("<cyfunction %s at %p>",
                               PyString_AsString(op->func_qualname), (void *)op);
#endif
}
#if CYTHON_COMPILING_IN_PYPY
static PyObject * __Pyx_CyFunction_Call(PyObject *func, PyObject *arg, PyObject *kw) {
    PyCFunctionObject* f = (PyCFunctionObject*)func;
    PyCFunction meth = f->m_ml->ml_meth;
    PyObject *self = f->m_self;
    Py_ssize_t size;
    switch (f->m_ml->ml_flags & (METH_VARARGS | METH_KEYWORDS | METH_NOARGS | METH_O)) {
    case METH_VARARGS:
        if (likely(kw == NULL || PyDict_Size(kw) == 0))
            return (*meth)(self, arg);
        break;
    case METH_VARARGS | METH_KEYWORDS:
        return (*(PyCFunctionWithKeywords)meth)(self, arg, kw);
    case METH_NOARGS:
        if (likely(kw == NULL || PyDict_Size(kw) == 0)) {
            size = PyTuple_GET_SIZE(arg);
            if (likely(size == 0))
                return (*meth)(self, NULL);
            PyErr_Format(PyExc_TypeError,
                "%.200s() takes no arguments (%" CYTHON_FORMAT_SSIZE_T "d given)",
                f->m_ml->ml_name, size);
            return NULL;
        }
        break;
    case METH_O:
        if (likely(kw == NULL || PyDict_Size(kw) == 0)) {
            size = PyTuple_GET_SIZE(arg);
            if (likely(size == 1)) {
                PyObject *result, *arg0 = PySequence_ITEM(arg, 0);
                if (unlikely(!arg0)) return NULL;
                result = (*meth)(self, arg0);
                Py_DECREF(arg0);
                return result;
            }
            PyErr_Format(PyExc_TypeError,
                "%.200s() takes exactly one argument (%" CYTHON_FORMAT_SSIZE_T "d given)",
                f->m_ml->ml_name, size);
            return NULL;
        }
        break;
    default:
        PyErr_SetString(PyExc_SystemError, "Bad call flags in "
                        "__Pyx_CyFunction_Call. METH_OLDARGS is no "
                        "longer supported!");
        return NULL;
    }
    PyErr_Format(PyExc_TypeError, "%.200s() takes no keyword arguments",
                 f->m_ml->ml_name);
    return NULL;
}
#else
static PyObject * __Pyx_CyFunction_Call(PyObject *func, PyObject *arg, PyObject *kw) {
	return PyCFunction_Call(func, arg, kw);
}
#endif
static PyTypeObject __pyx_CyFunctionType_type = {
    PyVarObject_HEAD_INIT(0, 0)
    "cython_function_or_method",
    sizeof(__pyx_CyFunctionObject),
    0,
    (destructor) __Pyx_CyFunction_dealloc,
    0,
    0,
    0,
#if PY_MAJOR_VERSION < 3
    0,
#else
    0,
#endif
    (reprfunc) __Pyx_CyFunction_repr,
    0,
    0,
    0,
    0,
    __Pyx_CyFunction_Call,
    0,
    0,
    0,
    0,
    Py_TPFLAGS_DEFAULT | Py_TPFLAGS_HAVE_GC,
    0,
    (traverseproc) __Pyx_CyFunction_traverse,
    (inquiry) __Pyx_CyFunction_clear,
    0,
#if PY_VERSION_HEX < 0x030500A0
    offsetof(__pyx_CyFunctionObject, func_weakreflist),
#else
    offsetof(PyCFunctionObject, m_weakreflist),
#endif
    0,
    0,
    __pyx_CyFunction_methods,
    __pyx_CyFunction_members,
    __pyx_CyFunction_getsets,
    0,
    0,
    __Pyx_CyFunction_descr_get,
    0,
    offsetof(__pyx_CyFunctionObject, func_dict),
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
    0,
#if PY_VERSION_HEX >= 0x030400a1
    0,
#endif
};
static int __pyx_CyFunction_init(void) {
#if !CYTHON_COMPILING_IN_PYPY
    __pyx_CyFunctionType_type.tp_call = PyCFunction_Call;
#endif
    __pyx_CyFunctionType = __Pyx_FetchCommonType(&__pyx_CyFunctionType_type);
    if (__pyx_CyFunctionType == NULL) {
        return -1;
    }
    return 0;
}
static CYTHON_INLINE void *__Pyx_CyFunction_InitDefaults(PyObject *func, size_t size, int pyobjects) {
    __pyx_CyFunctionObject *m = (__pyx_CyFunctionObject *) func;
    m->defaults = PyObject_Malloc(size);
    if (!m->defaults)
        return PyErr_NoMemory();
    memset(m->defaults, 0, size);
    m->defaults_pyobjects = pyobjects;
    return m->defaults;
}
static CYTHON_INLINE void __Pyx_CyFunction_SetDefaultsTuple(PyObject *func, PyObject *tuple) {
    __pyx_CyFunctionObject *m = (__pyx_CyFunctionObject *) func;
    m->defaults_tuple = tuple;
    Py_INCREF(tuple);
}
static CYTHON_INLINE void __Pyx_CyFunction_SetDefaultsKwDict(PyObject *func, PyObject *dict) {
    __pyx_CyFunctionObject *m = (__pyx_CyFunctionObject *) func;
    m->defaults_kwdict = dict;
    Py_INCREF(dict);
}
static CYTHON_INLINE void __Pyx_CyFunction_SetAnnotationsDict(PyObject *func, PyObject *dict) {
    __pyx_CyFunctionObject *m = (__pyx_CyFunctionObject *) func;
    m->func_annotations = dict;
    Py_INCREF(dict);
}

/* PyIntBinop */
                #if CYTHON_COMPILING_IN_CPYTHON
static PyObject* __Pyx_PyInt_EqObjC(PyObject *op1, PyObject *op2, CYTHON_UNUSED long intval, CYTHON_UNUSED int inplace) {
    if (op1 == op2) {
        Py_RETURN_TRUE;
    }
    #if PY_MAJOR_VERSION < 3
    if (likely(PyInt_CheckExact(op1))) {
        const long b = intval;
        long a = PyInt_AS_LONG(op1);
        if (a == b) {
            Py_RETURN_TRUE;
        } else {
            Py_RETURN_FALSE;
        }
    }
    #endif
    #if CYTHON_USE_PYLONG_INTERNALS && PY_MAJOR_VERSION >= 3
    if (likely(PyLong_CheckExact(op1))) {
        const long b = intval;
        long a;
        const digit* digits = ((PyLongObject*)op1)->ob_digit;
        const Py_ssize_t size = Py_SIZE(op1);
        if (likely(__Pyx_sst_abs(size) <= 1)) {
            a = likely(size) ? digits[0] : 0;
            if (size == -1) a = -a;
        } else {
            switch (size) {
                case -2:
                    if (8 * sizeof(long) - 1 > 2 * PyLong_SHIFT) {
                        a = -(long) (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
                        break;
                    }
                case 2:
                    if (8 * sizeof(long) - 1 > 2 * PyLong_SHIFT) {
                        a = (long) (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
                        break;
                    }
                case -3:
                    if (8 * sizeof(long) - 1 > 3 * PyLong_SHIFT) {
                        a = -(long) (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
                        break;
                    }
                case 3:
                    if (8 * sizeof(long) - 1 > 3 * PyLong_SHIFT) {
                        a = (long) (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
                        break;
                    }
                case -4:
                    if (8 * sizeof(long) - 1 > 4 * PyLong_SHIFT) {
                        a = -(long) (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
                        break;
                    }
                case 4:
                    if (8 * sizeof(long) - 1 > 4 * PyLong_SHIFT) {
                        a = (long) (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
                        break;
                    }
                #if PyLong_SHIFT < 30 && PyLong_SHIFT != 15
                default: return PyLong_Type.tp_richcompare(op1, op2, Py_EQ);
                #else
                default: Py_RETURN_FALSE;
                #endif
            }
        }
            if (a == b) {
                Py_RETURN_TRUE;
            } else {
                Py_RETURN_FALSE;
            }
    }
    #endif
    if (PyFloat_CheckExact(op1)) {
        const long b = intval;
        double a = PyFloat_AS_DOUBLE(op1);
            if ((double)a == (double)b) {
                Py_RETURN_TRUE;
            } else {
                Py_RETURN_FALSE;
            }
    }
    return PyObject_RichCompare(op1, op2, Py_EQ);
}
#endif

/* SaveResetException */
                #if CYTHON_COMPILING_IN_CPYTHON
static CYTHON_INLINE void __Pyx__ExceptionSave(PyThreadState *tstate, PyObject **type, PyObject **value, PyObject **tb) {
    *type = tstate->exc_type;
    *value = tstate->exc_value;
    *tb = tstate->exc_traceback;
    Py_XINCREF(*type);
    Py_XINCREF(*value);
    Py_XINCREF(*tb);
}
static CYTHON_INLINE void __Pyx__ExceptionReset(PyThreadState *tstate, PyObject *type, PyObject *value, PyObject *tb) {
    PyObject *tmp_type, *tmp_value, *tmp_tb;
    tmp_type = tstate->exc_type;
    tmp_value = tstate->exc_value;
    tmp_tb = tstate->exc_traceback;
    tstate->exc_type = type;
    tstate->exc_value = value;
    tstate->exc_traceback = tb;
    Py_XDECREF(tmp_type);
    Py_XDECREF(tmp_value);
    Py_XDECREF(tmp_tb);
}
#endif

/* PyErrExceptionMatches */
                #if CYTHON_COMPILING_IN_CPYTHON
static CYTHON_INLINE int __Pyx_PyErr_ExceptionMatchesInState(PyThreadState* tstate, PyObject* err) {
    PyObject *exc_type = tstate->curexc_type;
    if (exc_type == err) return 1;
    if (unlikely(!exc_type)) return 0;
    return PyErr_GivenExceptionMatches(exc_type, err);
}
#endif

/* GetException */
                #if CYTHON_COMPILING_IN_CPYTHON
static int __Pyx__GetException(PyThreadState *tstate, PyObject **type, PyObject **value, PyObject **tb) {
#else
static int __Pyx_GetException(PyObject **type, PyObject **value, PyObject **tb) {
#endif
    PyObject *local_type, *local_value, *local_tb;
#if CYTHON_COMPILING_IN_CPYTHON
    PyObject *tmp_type, *tmp_value, *tmp_tb;
    local_type = tstate->curexc_type;
    local_value = tstate->curexc_value;
    local_tb = tstate->curexc_traceback;
    tstate->curexc_type = 0;
    tstate->curexc_value = 0;
    tstate->curexc_traceback = 0;
#else
    PyErr_Fetch(&local_type, &local_value, &local_tb);
#endif
    PyErr_NormalizeException(&local_type, &local_value, &local_tb);
#if CYTHON_COMPILING_IN_CPYTHON
    if (unlikely(tstate->curexc_type))
#else
    if (unlikely(PyErr_Occurred()))
#endif
        goto bad;
    #if PY_MAJOR_VERSION >= 3
    if (local_tb) {
        if (unlikely(PyException_SetTraceback(local_value, local_tb) < 0))
            goto bad;
    }
    #endif
    Py_XINCREF(local_tb);
    Py_XINCREF(local_type);
    Py_XINCREF(local_value);
    *type = local_type;
    *value = local_value;
    *tb = local_tb;
#if CYTHON_COMPILING_IN_CPYTHON
    tmp_type = tstate->exc_type;
    tmp_value = tstate->exc_value;
    tmp_tb = tstate->exc_traceback;
    tstate->exc_type = local_type;
    tstate->exc_value = local_value;
    tstate->exc_traceback = local_tb;
    Py_XDECREF(tmp_type);
    Py_XDECREF(tmp_value);
    Py_XDECREF(tmp_tb);
#else
    PyErr_SetExcInfo(local_type, local_value, local_tb);
#endif
    return 0;
bad:
    *type = 0;
    *value = 0;
    *tb = 0;
    Py_XDECREF(local_type);
    Py_XDECREF(local_value);
    Py_XDECREF(local_tb);
    return -1;
}

/* PyIntBinop */
                  #if CYTHON_COMPILING_IN_CPYTHON
static PyObject* __Pyx_PyInt_SubtractObjC(PyObject *op1, PyObject *op2, CYTHON_UNUSED long intval, CYTHON_UNUSED int inplace) {
    #if PY_MAJOR_VERSION < 3
    if (likely(PyInt_CheckExact(op1))) {
        const long b = intval;
        long x;
        long a = PyInt_AS_LONG(op1);
            x = (long)((unsigned long)a - b);
            if (likely((x^a) >= 0 || (x^~b) >= 0))
                return PyInt_FromLong(x);
            return PyLong_Type.tp_as_number->nb_subtract(op1, op2);
    }
    #endif
    #if CYTHON_USE_PYLONG_INTERNALS && PY_MAJOR_VERSION >= 3
    if (likely(PyLong_CheckExact(op1))) {
        const long b = intval;
        long a, x;
        const PY_LONG_LONG llb = intval;
        PY_LONG_LONG lla, llx;
        const digit* digits = ((PyLongObject*)op1)->ob_digit;
        const Py_ssize_t size = Py_SIZE(op1);
        if (likely(__Pyx_sst_abs(size) <= 1)) {
            a = likely(size) ? digits[0] : 0;
            if (size == -1) a = -a;
        } else {
            switch (size) {
                case -2:
                    if (8 * sizeof(long) - 1 > 2 * PyLong_SHIFT) {
                        a = -(long) (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
                        break;
                    } else if (8 * sizeof(PY_LONG_LONG) - 1 > 2 * PyLong_SHIFT) {
                        lla = -(PY_LONG_LONG) (((((unsigned PY_LONG_LONG)digits[1]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[0]));
                        goto long_long;
                    }
                case 2:
                    if (8 * sizeof(long) - 1 > 2 * PyLong_SHIFT) {
                        a = (long) (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
                        break;
                    } else if (8 * sizeof(PY_LONG_LONG) - 1 > 2 * PyLong_SHIFT) {
                        lla = (PY_LONG_LONG) (((((unsigned PY_LONG_LONG)digits[1]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[0]));
                        goto long_long;
                    }
                case -3:
                    if (8 * sizeof(long) - 1 > 3 * PyLong_SHIFT) {
                        a = -(long) (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
                        break;
                    } else if (8 * sizeof(PY_LONG_LONG) - 1 > 3 * PyLong_SHIFT) {
                        lla = -(PY_LONG_LONG) (((((((unsigned PY_LONG_LONG)digits[2]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[1]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[0]));
                        goto long_long;
                    }
                case 3:
                    if (8 * sizeof(long) - 1 > 3 * PyLong_SHIFT) {
                        a = (long) (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
                        break;
                    } else if (8 * sizeof(PY_LONG_LONG) - 1 > 3 * PyLong_SHIFT) {
                        lla = (PY_LONG_LONG) (((((((unsigned PY_LONG_LONG)digits[2]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[1]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[0]));
                        goto long_long;
                    }
                case -4:
                    if (8 * sizeof(long) - 1 > 4 * PyLong_SHIFT) {
                        a = -(long) (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
                        break;
                    } else if (8 * sizeof(PY_LONG_LONG) - 1 > 4 * PyLong_SHIFT) {
                        lla = -(PY_LONG_LONG) (((((((((unsigned PY_LONG_LONG)digits[3]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[2]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[1]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[0]));
                        goto long_long;
                    }
                case 4:
                    if (8 * sizeof(long) - 1 > 4 * PyLong_SHIFT) {
                        a = (long) (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
                        break;
                    } else if (8 * sizeof(PY_LONG_LONG) - 1 > 4 * PyLong_SHIFT) {
                        lla = (PY_LONG_LONG) (((((((((unsigned PY_LONG_LONG)digits[3]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[2]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[1]) << PyLong_SHIFT) | (unsigned PY_LONG_LONG)digits[0]));
                        goto long_long;
                    }
                default: return PyLong_Type.tp_as_number->nb_subtract(op1, op2);
            }
        }
                x = a - b;
            return PyLong_FromLong(x);
        long_long:
                llx = lla - llb;
            return PyLong_FromLongLong(llx);
    }
    #endif
    if (PyFloat_CheckExact(op1)) {
        const long b = intval;
        double a = PyFloat_AS_DOUBLE(op1);
            double result;
            PyFPE_START_PROTECT("subtract", return NULL)
            result = ((double)a) - (double)b;
            PyFPE_END_PROTECT(result)
            return PyFloat_FromDouble(result);
    }
    return (inplace ? PyNumber_InPlaceSubtract : PyNumber_Subtract)(op1, op2);
}
#endif

/* None */
                  static CYTHON_INLINE npy_intp __Pyx_div_npy_intp(npy_intp a, npy_intp b) {
    npy_intp q = a / b;
    npy_intp r = a - q*b;
    q -= ((r != 0) & ((r ^ b) < 0));
    return q;
}

/* None */
                  static CYTHON_INLINE int __Pyx_div_int(int a, int b) {
    int q = a / b;
    int r = a - q*b;
    q -= ((r != 0) & ((r ^ b) < 0));
    return q;
}

/* None */
                  static CYTHON_INLINE long __Pyx_div_long(long a, long b) {
    long q = a / b;
    long r = a - q*b;
    q -= ((r != 0) & ((r ^ b) < 0));
    return q;
}

/* PyFloatBinop */
                  #if CYTHON_COMPILING_IN_CPYTHON
static PyObject* __Pyx_PyFloat_DivideCObj(PyObject *op1, PyObject *op2, double floatval, CYTHON_UNUSED int inplace) {
    const double a = floatval;
    double b, result;
    if (likely(PyFloat_CheckExact(op2))) {
        b = PyFloat_AS_DOUBLE(op2);
    } else
    #if PY_MAJOR_VERSION < 3
    if (likely(PyInt_CheckExact(op2))) {
        b = (double) PyInt_AS_LONG(op2);
    } else
    #endif
    if (likely(PyLong_CheckExact(op2))) {
        #if CYTHON_USE_PYLONG_INTERNALS && PY_MAJOR_VERSION >= 3
        const digit* digits = ((PyLongObject*)op2)->ob_digit;
        const Py_ssize_t size = Py_SIZE(op2);
        switch (size) {
            case  0: b = 0.0; break;
            case -1: b = -(double) digits[0]; break;
            case  1: b = (double) digits[0]; break;
            case -2:
            case 2:
                if (8 * sizeof(unsigned long) > 2 * PyLong_SHIFT && ((8 * sizeof(unsigned long) < 53) || (1 * PyLong_SHIFT < 53))) {
                    b = (double) (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
                    if ((8 * sizeof(unsigned long) < 53) || (2 * PyLong_SHIFT < 53) || (b < (double) (1L<<53))) {
                        if (size == -2)
                            b = -b;
                        break;
                    }
                }
            case -3:
            case 3:
                if (8 * sizeof(unsigned long) > 3 * PyLong_SHIFT && ((8 * sizeof(unsigned long) < 53) || (2 * PyLong_SHIFT < 53))) {
                    b = (double) (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
                    if ((8 * sizeof(unsigned long) < 53) || (3 * PyLong_SHIFT < 53) || (b < (double) (1L<<53))) {
                        if (size == -3)
                            b = -b;
                        break;
                    }
                }
            case -4:
            case 4:
                if (8 * sizeof(unsigned long) > 4 * PyLong_SHIFT && ((8 * sizeof(unsigned long) < 53) || (3 * PyLong_SHIFT < 53))) {
                    b = (double) (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0]));
                    if ((8 * sizeof(unsigned long) < 53) || (4 * PyLong_SHIFT < 53) || (b < (double) (1L<<53))) {
                        if (size == -4)
                            b = -b;
                        break;
                    }
                }
            default:
        #else
        {
        #endif
            b = PyLong_AsDouble(op2);
            if (unlikely(b == -1.0 && PyErr_Occurred())) return NULL;
        }
    } else {
        return (inplace ? __Pyx_PyNumber_InPlaceDivide(op1, op2) : __Pyx_PyNumber_Divide(op1, op2));
    }
        PyFPE_START_PROTECT("divide", return NULL)
        result = a / b;
        PyFPE_END_PROTECT(result)
        return PyFloat_FromDouble(result);
}
#endif

/* RaiseNoneIterError */
                    static CYTHON_INLINE void __Pyx_RaiseNoneNotIterableError(void) {
    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not iterable");
}

/* Import */
                    static PyObject *__Pyx_Import(PyObject *name, PyObject *from_list, int level) {
    PyObject *empty_list = 0;
    PyObject *module = 0;
    PyObject *global_dict = 0;
    PyObject *empty_dict = 0;
    PyObject *list;
    #if PY_VERSION_HEX < 0x03030000
    PyObject *py_import;
    py_import = __Pyx_PyObject_GetAttrStr(__pyx_b, __pyx_n_s_import);
    if (!py_import)
        goto bad;
    #endif
    if (from_list)
        list = from_list;
    else {
        empty_list = PyList_New(0);
        if (!empty_list)
            goto bad;
        list = empty_list;
    }
    global_dict = PyModule_GetDict(__pyx_m);
    if (!global_dict)
        goto bad;
    empty_dict = PyDict_New();
    if (!empty_dict)
        goto bad;
    {
        #if PY_MAJOR_VERSION >= 3
        if (level == -1) {
            if (strchr(__Pyx_MODULE_NAME, '.')) {
                #if PY_VERSION_HEX < 0x03030000
                PyObject *py_level = PyInt_FromLong(1);
                if (!py_level)
                    goto bad;
                module = PyObject_CallFunctionObjArgs(py_import,
                    name, global_dict, empty_dict, list, py_level, NULL);
                Py_DECREF(py_level);
                #else
                module = PyImport_ImportModuleLevelObject(
                    name, global_dict, empty_dict, list, 1);
                #endif
                if (!module) {
                    if (!PyErr_ExceptionMatches(PyExc_ImportError))
                        goto bad;
                    PyErr_Clear();
                }
            }
            level = 0;
        }
        #endif
        if (!module) {
            #if PY_VERSION_HEX < 0x03030000
            PyObject *py_level = PyInt_FromLong(level);
            if (!py_level)
                goto bad;
            module = PyObject_CallFunctionObjArgs(py_import,
                name, global_dict, empty_dict, list, py_level, NULL);
            Py_DECREF(py_level);
            #else
            module = PyImport_ImportModuleLevelObject(
                name, global_dict, empty_dict, list, level);
            #endif
        }
    }
bad:
    #if PY_VERSION_HEX < 0x03030000
    Py_XDECREF(py_import);
    #endif
    Py_XDECREF(empty_list);
    Py_XDECREF(empty_dict);
    return module;
}

/* CodeObjectCache */
                    static int __pyx_bisect_code_objects(__Pyx_CodeObjectCacheEntry* entries, int count, int code_line) {
    int start = 0, mid = 0, end = count - 1;
    if (end >= 0 && code_line > entries[end].code_line) {
        return count;
    }
    while (start < end) {
        mid = start + (end - start) / 2;
        if (code_line < entries[mid].code_line) {
            end = mid;
        } else if (code_line > entries[mid].code_line) {
             start = mid + 1;
        } else {
            return mid;
        }
    }
    if (code_line <= entries[mid].code_line) {
        return mid;
    } else {
        return mid + 1;
    }
}
static PyCodeObject *__pyx_find_code_object(int code_line) {
    PyCodeObject* code_object;
    int pos;
    if (unlikely(!code_line) || unlikely(!__pyx_code_cache.entries)) {
        return NULL;
    }
    pos = __pyx_bisect_code_objects(__pyx_code_cache.entries, __pyx_code_cache.count, code_line);
    if (unlikely(pos >= __pyx_code_cache.count) || unlikely(__pyx_code_cache.entries[pos].code_line != code_line)) {
        return NULL;
    }
    code_object = __pyx_code_cache.entries[pos].code_object;
    Py_INCREF(code_object);
    return code_object;
}
static void __pyx_insert_code_object(int code_line, PyCodeObject* code_object) {
    int pos, i;
    __Pyx_CodeObjectCacheEntry* entries = __pyx_code_cache.entries;
    if (unlikely(!code_line)) {
        return;
    }
    if (unlikely(!entries)) {
        entries = (__Pyx_CodeObjectCacheEntry*)PyMem_Malloc(64*sizeof(__Pyx_CodeObjectCacheEntry));
        if (likely(entries)) {
            __pyx_code_cache.entries = entries;
            __pyx_code_cache.max_count = 64;
            __pyx_code_cache.count = 1;
            entries[0].code_line = code_line;
            entries[0].code_object = code_object;
            Py_INCREF(code_object);
        }
        return;
    }
    pos = __pyx_bisect_code_objects(__pyx_code_cache.entries, __pyx_code_cache.count, code_line);
    if ((pos < __pyx_code_cache.count) && unlikely(__pyx_code_cache.entries[pos].code_line == code_line)) {
        PyCodeObject* tmp = entries[pos].code_object;
        entries[pos].code_object = code_object;
        Py_DECREF(tmp);
        return;
    }
    if (__pyx_code_cache.count == __pyx_code_cache.max_count) {
        int new_max = __pyx_code_cache.max_count + 64;
        entries = (__Pyx_CodeObjectCacheEntry*)PyMem_Realloc(
            __pyx_code_cache.entries, (size_t)new_max*sizeof(__Pyx_CodeObjectCacheEntry));
        if (unlikely(!entries)) {
            return;
        }
        __pyx_code_cache.entries = entries;
        __pyx_code_cache.max_count = new_max;
    }
    for (i=__pyx_code_cache.count; i>pos; i--) {
        entries[i] = entries[i-1];
    }
    entries[pos].code_line = code_line;
    entries[pos].code_object = code_object;
    __pyx_code_cache.count++;
    Py_INCREF(code_object);
}

/* AddTraceback */
                    #include "compile.h"
#include "frameobject.h"
#include "traceback.h"
static PyCodeObject* __Pyx_CreateCodeObjectForTraceback(
            const char *funcname, int c_line,
            int py_line, const char *filename) {
    PyCodeObject *py_code = 0;
    PyObject *py_srcfile = 0;
    PyObject *py_funcname = 0;
    #if PY_MAJOR_VERSION < 3
    py_srcfile = PyString_FromString(filename);
    #else
    py_srcfile = PyUnicode_FromString(filename);
    #endif
    if (!py_srcfile) goto bad;
    if (c_line) {
        #if PY_MAJOR_VERSION < 3
        py_funcname = PyString_FromFormat( "%s (%s:%d)", funcname, __pyx_cfilenm, c_line);
        #else
        py_funcname = PyUnicode_FromFormat( "%s (%s:%d)", funcname, __pyx_cfilenm, c_line);
        #endif
    }
    else {
        #if PY_MAJOR_VERSION < 3
        py_funcname = PyString_FromString(funcname);
        #else
        py_funcname = PyUnicode_FromString(funcname);
        #endif
    }
    if (!py_funcname) goto bad;
    py_code = __Pyx_PyCode_New(
        0,
        0,
        0,
        0,
        0,
        __pyx_empty_bytes, /*PyObject *code,*/
        __pyx_empty_tuple, /*PyObject *consts,*/
        __pyx_empty_tuple, /*PyObject *names,*/
        __pyx_empty_tuple, /*PyObject *varnames,*/
        __pyx_empty_tuple, /*PyObject *freevars,*/
        __pyx_empty_tuple, /*PyObject *cellvars,*/
        py_srcfile,   /*PyObject *filename,*/
        py_funcname,  /*PyObject *name,*/
        py_line,
        __pyx_empty_bytes  /*PyObject *lnotab*/
    );
    Py_DECREF(py_srcfile);
    Py_DECREF(py_funcname);
    return py_code;
bad:
    Py_XDECREF(py_srcfile);
    Py_XDECREF(py_funcname);
    return NULL;
}
static void __Pyx_AddTraceback(const char *funcname, int c_line,
                               int py_line, const char *filename) {
    PyCodeObject *py_code = 0;
    PyFrameObject *py_frame = 0;
    py_code = __pyx_find_code_object(c_line ? c_line : py_line);
    if (!py_code) {
        py_code = __Pyx_CreateCodeObjectForTraceback(
            funcname, c_line, py_line, filename);
        if (!py_code) goto bad;
        __pyx_insert_code_object(c_line ? c_line : py_line, py_code);
    }
    py_frame = PyFrame_New(
        PyThreadState_GET(), /*PyThreadState *tstate,*/
        py_code,             /*PyCodeObject *code,*/
        __pyx_d,      /*PyObject *globals,*/
        0                    /*PyObject *locals*/
    );
    if (!py_frame) goto bad;
    py_frame->f_lineno = py_line;
    PyTraceBack_Here(py_frame);
bad:
    Py_XDECREF(py_code);
    Py_XDECREF(py_frame);
}

/* None */
                    #if CYTHON_CCOMPLEX
  #ifdef __cplusplus
    static CYTHON_INLINE __pyx_t_double_complex __pyx_t_double_complex_from_parts(double x, double y) {
      return ::std::complex< double >(x, y);
    }
  #else
    static CYTHON_INLINE __pyx_t_double_complex __pyx_t_double_complex_from_parts(double x, double y) {
      return x + y*(__pyx_t_double_complex)_Complex_I;
    }
  #endif
#else
    static CYTHON_INLINE __pyx_t_double_complex __pyx_t_double_complex_from_parts(double x, double y) {
      __pyx_t_double_complex z;
      z.real = x;
      z.imag = y;
      return z;
    }
#endif

/* None */
                    #if CYTHON_CCOMPLEX
#else
    static CYTHON_INLINE int __Pyx_c_eq(__pyx_t_double_complex a, __pyx_t_double_complex b) {
       return (a.real == b.real) && (a.imag == b.imag);
    }
    static CYTHON_INLINE __pyx_t_double_complex __Pyx_c_sum(__pyx_t_double_complex a, __pyx_t_double_complex b) {
        __pyx_t_double_complex z;
        z.real = a.real + b.real;
        z.imag = a.imag + b.imag;
        return z;
    }
    static CYTHON_INLINE __pyx_t_double_complex __Pyx_c_diff(__pyx_t_double_complex a, __pyx_t_double_complex b) {
        __pyx_t_double_complex z;
        z.real = a.real - b.real;
        z.imag = a.imag - b.imag;
        return z;
    }
    static CYTHON_INLINE __pyx_t_double_complex __Pyx_c_prod(__pyx_t_double_complex a, __pyx_t_double_complex b) {
        __pyx_t_double_complex z;
        z.real = a.real * b.real - a.imag * b.imag;
        z.imag = a.real * b.imag + a.imag * b.real;
        return z;
    }
    static CYTHON_INLINE __pyx_t_double_complex __Pyx_c_quot(__pyx_t_double_complex a, __pyx_t_double_complex b) {
        __pyx_t_double_complex z;
        double denom = b.real * b.real + b.imag * b.imag;
        z.real = (a.real * b.real + a.imag * b.imag) / denom;
        z.imag = (a.imag * b.real - a.real * b.imag) / denom;
        return z;
    }
    static CYTHON_INLINE __pyx_t_double_complex __Pyx_c_neg(__pyx_t_double_complex a) {
        __pyx_t_double_complex z;
        z.real = -a.real;
        z.imag = -a.imag;
        return z;
    }
    static CYTHON_INLINE int __Pyx_c_is_zero(__pyx_t_double_complex a) {
       return (a.real == 0) && (a.imag == 0);
    }
    static CYTHON_INLINE __pyx_t_double_complex __Pyx_c_conj(__pyx_t_double_complex a) {
        __pyx_t_double_complex z;
        z.real =  a.real;
        z.imag = -a.imag;
        return z;
    }
    #if 1
        static CYTHON_INLINE double __Pyx_c_abs(__pyx_t_double_complex z) {
          #if !defined(HAVE_HYPOT) || defined(_MSC_VER)
            return sqrt(z.real*z.real + z.imag*z.imag);
          #else
            return hypot(z.real, z.imag);
          #endif
        }
        static CYTHON_INLINE __pyx_t_double_complex __Pyx_c_pow(__pyx_t_double_complex a, __pyx_t_double_complex b) {
            __pyx_t_double_complex z;
            double r, lnr, theta, z_r, z_theta;
            if (b.imag == 0 && b.real == (int)b.real) {
                if (b.real < 0) {
                    double denom = a.real * a.real + a.imag * a.imag;
                    a.real = a.real / denom;
                    a.imag = -a.imag / denom;
                    b.real = -b.real;
                }
                switch ((int)b.real) {
                    case 0:
                        z.real = 1;
                        z.imag = 0;
                        return z;
                    case 1:
                        return a;
                    case 2:
                        z = __Pyx_c_prod(a, a);
                        return __Pyx_c_prod(a, a);
                    case 3:
                        z = __Pyx_c_prod(a, a);
                        return __Pyx_c_prod(z, a);
                    case 4:
                        z = __Pyx_c_prod(a, a);
                        return __Pyx_c_prod(z, z);
                }
            }
            if (a.imag == 0) {
                if (a.real == 0) {
                    return a;
                }
                r = a.real;
                theta = 0;
            } else {
                r = __Pyx_c_abs(a);
                theta = atan2(a.imag, a.real);
            }
            lnr = log(r);
            z_r = exp(lnr * b.real - theta * b.imag);
            z_theta = theta * b.real + lnr * b.imag;
            z.real = z_r * cos(z_theta);
            z.imag = z_r * sin(z_theta);
            return z;
        }
    #endif
#endif

#if PY_MAJOR_VERSION < 3
static int __Pyx_GetBuffer(PyObject *obj, Py_buffer *view, int flags) {
    if (PyObject_CheckBuffer(obj)) return PyObject_GetBuffer(obj, view, flags);
        if (PyObject_TypeCheck(obj, __pyx_ptype_5numpy_ndarray)) return __pyx_pw_5numpy_7ndarray_1__getbuffer__(obj, view, flags);
    PyErr_Format(PyExc_TypeError, "'%.200s' does not have the buffer interface", Py_TYPE(obj)->tp_name);
    return -1;
}
static void __Pyx_ReleaseBuffer(Py_buffer *view) {
    PyObject *obj = view->obj;
    if (!obj) return;
    if (PyObject_CheckBuffer(obj)) {
        PyBuffer_Release(view);
        return;
    }
        if (PyObject_TypeCheck(obj, __pyx_ptype_5numpy_ndarray)) { __pyx_pw_5numpy_7ndarray_3__releasebuffer__(obj, view); return; }
    Py_DECREF(obj);
    view->obj = NULL;
}
#endif


                    /* CIntFromPyVerify */
                    #define __PYX_VERIFY_RETURN_INT(target_type, func_type, func_value)\
    __PYX__VERIFY_RETURN_INT(target_type, func_type, func_value, 0)
#define __PYX_VERIFY_RETURN_INT_EXC(target_type, func_type, func_value)\
    __PYX__VERIFY_RETURN_INT(target_type, func_type, func_value, 1)
#define __PYX__VERIFY_RETURN_INT(target_type, func_type, func_value, exc)\
    {\
        func_type value = func_value;\
        if (sizeof(target_type) < sizeof(func_type)) {\
            if (unlikely(value != (func_type) (target_type) value)) {\
                func_type zero = 0;\
                if (exc && unlikely(value == (func_type)-1 && PyErr_Occurred()))\
                    return (target_type) -1;\
                if (is_unsigned && unlikely(value < zero))\
                    goto raise_neg_overflow;\
                else\
                    goto raise_overflow;\
            }\
        }\
        return (target_type) value;\
    }

/* CIntToPy */
                    static CYTHON_INLINE PyObject* __Pyx_PyInt_From_Py_intptr_t(Py_intptr_t value) {
    const Py_intptr_t neg_one = (Py_intptr_t) -1, const_zero = (Py_intptr_t) 0;
    const int is_unsigned = neg_one > const_zero;
    if (is_unsigned) {
        if (sizeof(Py_intptr_t) < sizeof(long)) {
            return PyInt_FromLong((long) value);
        } else if (sizeof(Py_intptr_t) <= sizeof(unsigned long)) {
            return PyLong_FromUnsignedLong((unsigned long) value);
        } else if (sizeof(Py_intptr_t) <= sizeof(unsigned PY_LONG_LONG)) {
            return PyLong_FromUnsignedLongLong((unsigned PY_LONG_LONG) value);
        }
    } else {
        if (sizeof(Py_intptr_t) <= sizeof(long)) {
            return PyInt_FromLong((long) value);
        } else if (sizeof(Py_intptr_t) <= sizeof(PY_LONG_LONG)) {
            return PyLong_FromLongLong((PY_LONG_LONG) value);
        }
    }
    {
        int one = 1; int little = (int)*(unsigned char *)&one;
        unsigned char *bytes = (unsigned char *)&value;
        return _PyLong_FromByteArray(bytes, sizeof(Py_intptr_t),
                                     little, !is_unsigned);
    }
}

/* CIntToPy */
                    static CYTHON_INLINE PyObject* __Pyx_PyInt_From_int(int value) {
    const int neg_one = (int) -1, const_zero = (int) 0;
    const int is_unsigned = neg_one > const_zero;
    if (is_unsigned) {
        if (sizeof(int) < sizeof(long)) {
            return PyInt_FromLong((long) value);
        } else if (sizeof(int) <= sizeof(unsigned long)) {
            return PyLong_FromUnsignedLong((unsigned long) value);
        } else if (sizeof(int) <= sizeof(unsigned PY_LONG_LONG)) {
            return PyLong_FromUnsignedLongLong((unsigned PY_LONG_LONG) value);
        }
    } else {
        if (sizeof(int) <= sizeof(long)) {
            return PyInt_FromLong((long) value);
        } else if (sizeof(int) <= sizeof(PY_LONG_LONG)) {
            return PyLong_FromLongLong((PY_LONG_LONG) value);
        }
    }
    {
        int one = 1; int little = (int)*(unsigned char *)&one;
        unsigned char *bytes = (unsigned char *)&value;
        return _PyLong_FromByteArray(bytes, sizeof(int),
                                     little, !is_unsigned);
    }
}

/* CIntToPy */
                    static CYTHON_INLINE PyObject* __Pyx_PyInt_From_long(long value) {
    const long neg_one = (long) -1, const_zero = (long) 0;
    const int is_unsigned = neg_one > const_zero;
    if (is_unsigned) {
        if (sizeof(long) < sizeof(long)) {
            return PyInt_FromLong((long) value);
        } else if (sizeof(long) <= sizeof(unsigned long)) {
            return PyLong_FromUnsignedLong((unsigned long) value);
        } else if (sizeof(long) <= sizeof(unsigned PY_LONG_LONG)) {
            return PyLong_FromUnsignedLongLong((unsigned PY_LONG_LONG) value);
        }
    } else {
        if (sizeof(long) <= sizeof(long)) {
            return PyInt_FromLong((long) value);
        } else if (sizeof(long) <= sizeof(PY_LONG_LONG)) {
            return PyLong_FromLongLong((PY_LONG_LONG) value);
        }
    }
    {
        int one = 1; int little = (int)*(unsigned char *)&one;
        unsigned char *bytes = (unsigned char *)&value;
        return _PyLong_FromByteArray(bytes, sizeof(long),
                                     little, !is_unsigned);
    }
}

/* Print */
                    #if !CYTHON_COMPILING_IN_PYPY && PY_MAJOR_VERSION < 3
static PyObject *__Pyx_GetStdout(void) {
    PyObject *f = PySys_GetObject((char *)"stdout");
    if (!f) {
        PyErr_SetString(PyExc_RuntimeError, "lost sys.stdout");
    }
    return f;
}
static int __Pyx_Print(PyObject* f, PyObject *arg_tuple, int newline) {
    int i;
    if (!f) {
        if (!(f = __Pyx_GetStdout()))
            return -1;
    }
    Py_INCREF(f);
    for (i=0; i < PyTuple_GET_SIZE(arg_tuple); i++) {
        PyObject* v;
        if (PyFile_SoftSpace(f, 1)) {
            if (PyFile_WriteString(" ", f) < 0)
                goto error;
        }
        v = PyTuple_GET_ITEM(arg_tuple, i);
        if (PyFile_WriteObject(v, f, Py_PRINT_RAW) < 0)
            goto error;
        if (PyString_Check(v)) {
            char *s = PyString_AsString(v);
            Py_ssize_t len = PyString_Size(v);
            if (len > 0) {
                switch (s[len-1]) {
                    case ' ': break;
                    case '\f': case '\r': case '\n': case '\t': case '\v':
                        PyFile_SoftSpace(f, 0);
                        break;
                    default:  break;
                }
            }
        }
    }
    if (newline) {
        if (PyFile_WriteString("\n", f) < 0)
            goto error;
        PyFile_SoftSpace(f, 0);
    }
    Py_DECREF(f);
    return 0;
error:
    Py_DECREF(f);
    return -1;
}
#else
static int __Pyx_Print(PyObject* stream, PyObject *arg_tuple, int newline) {
    PyObject* kwargs = 0;
    PyObject* result = 0;
    PyObject* end_string;
    if (unlikely(!__pyx_print)) {
        __pyx_print = PyObject_GetAttr(__pyx_b, __pyx_n_s_print);
        if (!__pyx_print)
            return -1;
    }
    if (stream) {
        kwargs = PyDict_New();
        if (unlikely(!kwargs))
            return -1;
        if (unlikely(PyDict_SetItem(kwargs, __pyx_n_s_file, stream) < 0))
            goto bad;
        if (!newline) {
            end_string = PyUnicode_FromStringAndSize(" ", 1);
            if (unlikely(!end_string))
                goto bad;
            if (PyDict_SetItem(kwargs, __pyx_n_s_end, end_string) < 0) {
                Py_DECREF(end_string);
                goto bad;
            }
            Py_DECREF(end_string);
        }
    } else if (!newline) {
        if (unlikely(!__pyx_print_kwargs)) {
            __pyx_print_kwargs = PyDict_New();
            if (unlikely(!__pyx_print_kwargs))
                return -1;
            end_string = PyUnicode_FromStringAndSize(" ", 1);
            if (unlikely(!end_string))
                return -1;
            if (PyDict_SetItem(__pyx_print_kwargs, __pyx_n_s_end, end_string) < 0) {
                Py_DECREF(end_string);
                return -1;
            }
            Py_DECREF(end_string);
        }
        kwargs = __pyx_print_kwargs;
    }
    result = PyObject_Call(__pyx_print, arg_tuple, kwargs);
    if (unlikely(kwargs) && (kwargs != __pyx_print_kwargs))
        Py_DECREF(kwargs);
    if (!result)
        return -1;
    Py_DECREF(result);
    return 0;
bad:
    if (kwargs != __pyx_print_kwargs)
        Py_XDECREF(kwargs);
    return -1;
}
#endif

/* None */
                    #if CYTHON_CCOMPLEX
  #ifdef __cplusplus
    static CYTHON_INLINE __pyx_t_float_complex __pyx_t_float_complex_from_parts(float x, float y) {
      return ::std::complex< float >(x, y);
    }
  #else
    static CYTHON_INLINE __pyx_t_float_complex __pyx_t_float_complex_from_parts(float x, float y) {
      return x + y*(__pyx_t_float_complex)_Complex_I;
    }
  #endif
#else
    static CYTHON_INLINE __pyx_t_float_complex __pyx_t_float_complex_from_parts(float x, float y) {
      __pyx_t_float_complex z;
      z.real = x;
      z.imag = y;
      return z;
    }
#endif

/* None */
                    #if CYTHON_CCOMPLEX
#else
    static CYTHON_INLINE int __Pyx_c_eqf(__pyx_t_float_complex a, __pyx_t_float_complex b) {
       return (a.real == b.real) && (a.imag == b.imag);
    }
    static CYTHON_INLINE __pyx_t_float_complex __Pyx_c_sumf(__pyx_t_float_complex a, __pyx_t_float_complex b) {
        __pyx_t_float_complex z;
        z.real = a.real + b.real;
        z.imag = a.imag + b.imag;
        return z;
    }
    static CYTHON_INLINE __pyx_t_float_complex __Pyx_c_difff(__pyx_t_float_complex a, __pyx_t_float_complex b) {
        __pyx_t_float_complex z;
        z.real = a.real - b.real;
        z.imag = a.imag - b.imag;
        return z;
    }
    static CYTHON_INLINE __pyx_t_float_complex __Pyx_c_prodf(__pyx_t_float_complex a, __pyx_t_float_complex b) {
        __pyx_t_float_complex z;
        z.real = a.real * b.real - a.imag * b.imag;
        z.imag = a.real * b.imag + a.imag * b.real;
        return z;
    }
    static CYTHON_INLINE __pyx_t_float_complex __Pyx_c_quotf(__pyx_t_float_complex a, __pyx_t_float_complex b) {
        __pyx_t_float_complex z;
        float denom = b.real * b.real + b.imag * b.imag;
        z.real = (a.real * b.real + a.imag * b.imag) / denom;
        z.imag = (a.imag * b.real - a.real * b.imag) / denom;
        return z;
    }
    static CYTHON_INLINE __pyx_t_float_complex __Pyx_c_negf(__pyx_t_float_complex a) {
        __pyx_t_float_complex z;
        z.real = -a.real;
        z.imag = -a.imag;
        return z;
    }
    static CYTHON_INLINE int __Pyx_c_is_zerof(__pyx_t_float_complex a) {
       return (a.real == 0) && (a.imag == 0);
    }
    static CYTHON_INLINE __pyx_t_float_complex __Pyx_c_conjf(__pyx_t_float_complex a) {
        __pyx_t_float_complex z;
        z.real =  a.real;
        z.imag = -a.imag;
        return z;
    }
    #if 1
        static CYTHON_INLINE float __Pyx_c_absf(__pyx_t_float_complex z) {
          #if !defined(HAVE_HYPOT) || defined(_MSC_VER)
            return sqrtf(z.real*z.real + z.imag*z.imag);
          #else
            return hypotf(z.real, z.imag);
          #endif
        }
        static CYTHON_INLINE __pyx_t_float_complex __Pyx_c_powf(__pyx_t_float_complex a, __pyx_t_float_complex b) {
            __pyx_t_float_complex z;
            float r, lnr, theta, z_r, z_theta;
            if (b.imag == 0 && b.real == (int)b.real) {
                if (b.real < 0) {
                    float denom = a.real * a.real + a.imag * a.imag;
                    a.real = a.real / denom;
                    a.imag = -a.imag / denom;
                    b.real = -b.real;
                }
                switch ((int)b.real) {
                    case 0:
                        z.real = 1;
                        z.imag = 0;
                        return z;
                    case 1:
                        return a;
                    case 2:
                        z = __Pyx_c_prodf(a, a);
                        return __Pyx_c_prodf(a, a);
                    case 3:
                        z = __Pyx_c_prodf(a, a);
                        return __Pyx_c_prodf(z, a);
                    case 4:
                        z = __Pyx_c_prodf(a, a);
                        return __Pyx_c_prodf(z, z);
                }
            }
            if (a.imag == 0) {
                if (a.real == 0) {
                    return a;
                }
                r = a.real;
                theta = 0;
            } else {
                r = __Pyx_c_absf(a);
                theta = atan2f(a.imag, a.real);
            }
            lnr = logf(r);
            z_r = expf(lnr * b.real - theta * b.imag);
            z_theta = theta * b.real + lnr * b.imag;
            z.real = z_r * cosf(z_theta);
            z.imag = z_r * sinf(z_theta);
            return z;
        }
    #endif
#endif

/* CIntToPy */
                    static CYTHON_INLINE PyObject* __Pyx_PyInt_From_enum__NPY_TYPES(enum NPY_TYPES value) {
    const enum NPY_TYPES neg_one = (enum NPY_TYPES) -1, const_zero = (enum NPY_TYPES) 0;
    const int is_unsigned = neg_one > const_zero;
    if (is_unsigned) {
        if (sizeof(enum NPY_TYPES) < sizeof(long)) {
            return PyInt_FromLong((long) value);
        } else if (sizeof(enum NPY_TYPES) <= sizeof(unsigned long)) {
            return PyLong_FromUnsignedLong((unsigned long) value);
        } else if (sizeof(enum NPY_TYPES) <= sizeof(unsigned PY_LONG_LONG)) {
            return PyLong_FromUnsignedLongLong((unsigned PY_LONG_LONG) value);
        }
    } else {
        if (sizeof(enum NPY_TYPES) <= sizeof(long)) {
            return PyInt_FromLong((long) value);
        } else if (sizeof(enum NPY_TYPES) <= sizeof(PY_LONG_LONG)) {
            return PyLong_FromLongLong((PY_LONG_LONG) value);
        }
    }
    {
        int one = 1; int little = (int)*(unsigned char *)&one;
        unsigned char *bytes = (unsigned char *)&value;
        return _PyLong_FromByteArray(bytes, sizeof(enum NPY_TYPES),
                                     little, !is_unsigned);
    }
}

/* CIntFromPy */
                    static CYTHON_INLINE int __Pyx_PyInt_As_int(PyObject *x) {
    const int neg_one = (int) -1, const_zero = (int) 0;
    const int is_unsigned = neg_one > const_zero;
#if PY_MAJOR_VERSION < 3
    if (likely(PyInt_Check(x))) {
        if (sizeof(int) < sizeof(long)) {
            __PYX_VERIFY_RETURN_INT(int, long, PyInt_AS_LONG(x))
        } else {
            long val = PyInt_AS_LONG(x);
            if (is_unsigned && unlikely(val < 0)) {
                goto raise_neg_overflow;
            }
            return (int) val;
        }
    } else
#endif
    if (likely(PyLong_Check(x))) {
        if (is_unsigned) {
#if CYTHON_USE_PYLONG_INTERNALS
            const digit* digits = ((PyLongObject*)x)->ob_digit;
            switch (Py_SIZE(x)) {
                case  0: return (int) 0;
                case  1: __PYX_VERIFY_RETURN_INT(int, digit, digits[0])
                case 2:
                    if (8 * sizeof(int) > 1 * PyLong_SHIFT) {
                        if (8 * sizeof(unsigned long) > 2 * PyLong_SHIFT) {
                            __PYX_VERIFY_RETURN_INT(int, unsigned long, (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
                        } else if (8 * sizeof(int) >= 2 * PyLong_SHIFT) {
                            return (int) (((((int)digits[1]) << PyLong_SHIFT) | (int)digits[0]));
                        }
                    }
                    break;
                case 3:
                    if (8 * sizeof(int) > 2 * PyLong_SHIFT) {
                        if (8 * sizeof(unsigned long) > 3 * PyLong_SHIFT) {
                            __PYX_VERIFY_RETURN_INT(int, unsigned long, (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
                        } else if (8 * sizeof(int) >= 3 * PyLong_SHIFT) {
                            return (int) (((((((int)digits[2]) << PyLong_SHIFT) | (int)digits[1]) << PyLong_SHIFT) | (int)digits[0]));
                        }
                    }
                    break;
                case 4:
                    if (8 * sizeof(int) > 3 * PyLong_SHIFT) {
                        if (8 * sizeof(unsigned long) > 4 * PyLong_SHIFT) {
                            __PYX_VERIFY_RETURN_INT(int, unsigned long, (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
                        } else if (8 * sizeof(int) >= 4 * PyLong_SHIFT) {
                            return (int) (((((((((int)digits[3]) << PyLong_SHIFT) | (int)digits[2]) << PyLong_SHIFT) | (int)digits[1]) << PyLong_SHIFT) | (int)digits[0]));
                        }
                    }
                    break;
            }
#endif
#if CYTHON_COMPILING_IN_CPYTHON
            if (unlikely(Py_SIZE(x) < 0)) {
                goto raise_neg_overflow;
            }
#else
            {
                int result = PyObject_RichCompareBool(x, Py_False, Py_LT);
                if (unlikely(result < 0))
                    return (int) -1;
                if (unlikely(result == 1))
                    goto raise_neg_overflow;
            }
#endif
            if (sizeof(int) <= sizeof(unsigned long)) {
                __PYX_VERIFY_RETURN_INT_EXC(int, unsigned long, PyLong_AsUnsignedLong(x))
            } else if (sizeof(int) <= sizeof(unsigned PY_LONG_LONG)) {
                __PYX_VERIFY_RETURN_INT_EXC(int, unsigned PY_LONG_LONG, PyLong_AsUnsignedLongLong(x))
            }
        } else {
#if CYTHON_USE_PYLONG_INTERNALS
            const digit* digits = ((PyLongObject*)x)->ob_digit;
            switch (Py_SIZE(x)) {
                case  0: return (int) 0;
                case -1: __PYX_VERIFY_RETURN_INT(int, sdigit, (sdigit) (-(sdigit)digits[0]))
                case  1: __PYX_VERIFY_RETURN_INT(int,  digit, +digits[0])
                case -2:
                    if (8 * sizeof(int) - 1 > 1 * PyLong_SHIFT) {
                        if (8 * sizeof(unsigned long) > 2 * PyLong_SHIFT) {
                            __PYX_VERIFY_RETURN_INT(int, long, -(long) (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
                        } else if (8 * sizeof(int) - 1 > 2 * PyLong_SHIFT) {
                            return (int) (((int)-1)*(((((int)digits[1]) << PyLong_SHIFT) | (int)digits[0])));
                        }
                    }
                    break;
                case 2:
                    if (8 * sizeof(int) > 1 * PyLong_SHIFT) {
                        if (8 * sizeof(unsigned long) > 2 * PyLong_SHIFT) {
                            __PYX_VERIFY_RETURN_INT(int, unsigned long, (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
                        } else if (8 * sizeof(int) - 1 > 2 * PyLong_SHIFT) {
                            return (int) ((((((int)digits[1]) << PyLong_SHIFT) | (int)digits[0])));
                        }
                    }
                    break;
                case -3:
                    if (8 * sizeof(int) - 1 > 2 * PyLong_SHIFT) {
                        if (8 * sizeof(unsigned long) > 3 * PyLong_SHIFT) {
                            __PYX_VERIFY_RETURN_INT(int, long, -(long) (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
                        } else if (8 * sizeof(int) - 1 > 3 * PyLong_SHIFT) {
                            return (int) (((int)-1)*(((((((int)digits[2]) << PyLong_SHIFT) | (int)digits[1]) << PyLong_SHIFT) | (int)digits[0])));
                        }
                    }
                    break;
                case 3:
                    if (8 * sizeof(int) > 2 * PyLong_SHIFT) {
                        if (8 * sizeof(unsigned long) > 3 * PyLong_SHIFT) {
                            __PYX_VERIFY_RETURN_INT(int, unsigned long, (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
                        } else if (8 * sizeof(int) - 1 > 3 * PyLong_SHIFT) {
                            return (int) ((((((((int)digits[2]) << PyLong_SHIFT) | (int)digits[1]) << PyLong_SHIFT) | (int)digits[0])));
                        }
                    }
                    break;
                case -4:
                    if (8 * sizeof(int) - 1 > 3 * PyLong_SHIFT) {
                        if (8 * sizeof(unsigned long) > 4 * PyLong_SHIFT) {
                            __PYX_VERIFY_RETURN_INT(int, long, -(long) (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
                        } else if (8 * sizeof(int) - 1 > 4 * PyLong_SHIFT) {
                            return (int) (((int)-1)*(((((((((int)digits[3]) << PyLong_SHIFT) | (int)digits[2]) << PyLong_SHIFT) | (int)digits[1]) << PyLong_SHIFT) | (int)digits[0])));
                        }
                    }
                    break;
                case 4:
                    if (8 * sizeof(int) > 3 * PyLong_SHIFT) {
                        if (8 * sizeof(unsigned long) > 4 * PyLong_SHIFT) {
                            __PYX_VERIFY_RETURN_INT(int, unsigned long, (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
                        } else if (8 * sizeof(int) - 1 > 4 * PyLong_SHIFT) {
                            return (int) ((((((((((int)digits[3]) << PyLong_SHIFT) | (int)digits[2]) << PyLong_SHIFT) | (int)digits[1]) << PyLong_SHIFT) | (int)digits[0])));
                        }
                    }
                    break;
            }
#endif
            if (sizeof(int) <= sizeof(long)) {
                __PYX_VERIFY_RETURN_INT_EXC(int, long, PyLong_AsLong(x))
            } else if (sizeof(int) <= sizeof(PY_LONG_LONG)) {
                __PYX_VERIFY_RETURN_INT_EXC(int, PY_LONG_LONG, PyLong_AsLongLong(x))
            }
        }
        {
#if CYTHON_COMPILING_IN_PYPY && !defined(_PyLong_AsByteArray)
            PyErr_SetString(PyExc_RuntimeError,
                            "_PyLong_AsByteArray() not available in PyPy, cannot convert large numbers");
#else
            int val;
            PyObject *v = __Pyx_PyNumber_IntOrLong(x);
 #if PY_MAJOR_VERSION < 3
            if (likely(v) && !PyLong_Check(v)) {
                PyObject *tmp = v;
                v = PyNumber_Long(tmp);
                Py_DECREF(tmp);
            }
 #endif
            if (likely(v)) {
                int one = 1; int is_little = (int)*(unsigned char *)&one;
                unsigned char *bytes = (unsigned char *)&val;
                int ret = _PyLong_AsByteArray((PyLongObject *)v,
                                              bytes, sizeof(val),
                                              is_little, !is_unsigned);
                Py_DECREF(v);
                if (likely(!ret))
                    return val;
            }
#endif
            return (int) -1;
        }
    } else {
        int val;
        PyObject *tmp = __Pyx_PyNumber_IntOrLong(x);
        if (!tmp) return (int) -1;
        val = __Pyx_PyInt_As_int(tmp);
        Py_DECREF(tmp);
        return val;
    }
raise_overflow:
    PyErr_SetString(PyExc_OverflowError,
        "value too large to convert to int");
    return (int) -1;
raise_neg_overflow:
    PyErr_SetString(PyExc_OverflowError,
        "can't convert negative value to int");
    return (int) -1;
}

/* CIntFromPy */
                    static CYTHON_INLINE long __Pyx_PyInt_As_long(PyObject *x) {
    const long neg_one = (long) -1, const_zero = (long) 0;
    const int is_unsigned = neg_one > const_zero;
#if PY_MAJOR_VERSION < 3
    if (likely(PyInt_Check(x))) {
        if (sizeof(long) < sizeof(long)) {
            __PYX_VERIFY_RETURN_INT(long, long, PyInt_AS_LONG(x))
        } else {
            long val = PyInt_AS_LONG(x);
            if (is_unsigned && unlikely(val < 0)) {
                goto raise_neg_overflow;
            }
            return (long) val;
        }
    } else
#endif
    if (likely(PyLong_Check(x))) {
        if (is_unsigned) {
#if CYTHON_USE_PYLONG_INTERNALS
            const digit* digits = ((PyLongObject*)x)->ob_digit;
            switch (Py_SIZE(x)) {
                case  0: return (long) 0;
                case  1: __PYX_VERIFY_RETURN_INT(long, digit, digits[0])
                case 2:
                    if (8 * sizeof(long) > 1 * PyLong_SHIFT) {
                        if (8 * sizeof(unsigned long) > 2 * PyLong_SHIFT) {
                            __PYX_VERIFY_RETURN_INT(long, unsigned long, (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
                        } else if (8 * sizeof(long) >= 2 * PyLong_SHIFT) {
                            return (long) (((((long)digits[1]) << PyLong_SHIFT) | (long)digits[0]));
                        }
                    }
                    break;
                case 3:
                    if (8 * sizeof(long) > 2 * PyLong_SHIFT) {
                        if (8 * sizeof(unsigned long) > 3 * PyLong_SHIFT) {
                            __PYX_VERIFY_RETURN_INT(long, unsigned long, (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
                        } else if (8 * sizeof(long) >= 3 * PyLong_SHIFT) {
                            return (long) (((((((long)digits[2]) << PyLong_SHIFT) | (long)digits[1]) << PyLong_SHIFT) | (long)digits[0]));
                        }
                    }
                    break;
                case 4:
                    if (8 * sizeof(long) > 3 * PyLong_SHIFT) {
                        if (8 * sizeof(unsigned long) > 4 * PyLong_SHIFT) {
                            __PYX_VERIFY_RETURN_INT(long, unsigned long, (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
                        } else if (8 * sizeof(long) >= 4 * PyLong_SHIFT) {
                            return (long) (((((((((long)digits[3]) << PyLong_SHIFT) | (long)digits[2]) << PyLong_SHIFT) | (long)digits[1]) << PyLong_SHIFT) | (long)digits[0]));
                        }
                    }
                    break;
            }
#endif
#if CYTHON_COMPILING_IN_CPYTHON
            if (unlikely(Py_SIZE(x) < 0)) {
                goto raise_neg_overflow;
            }
#else
            {
                int result = PyObject_RichCompareBool(x, Py_False, Py_LT);
                if (unlikely(result < 0))
                    return (long) -1;
                if (unlikely(result == 1))
                    goto raise_neg_overflow;
            }
#endif
            if (sizeof(long) <= sizeof(unsigned long)) {
                __PYX_VERIFY_RETURN_INT_EXC(long, unsigned long, PyLong_AsUnsignedLong(x))
            } else if (sizeof(long) <= sizeof(unsigned PY_LONG_LONG)) {
                __PYX_VERIFY_RETURN_INT_EXC(long, unsigned PY_LONG_LONG, PyLong_AsUnsignedLongLong(x))
            }
        } else {
#if CYTHON_USE_PYLONG_INTERNALS
            const digit* digits = ((PyLongObject*)x)->ob_digit;
            switch (Py_SIZE(x)) {
                case  0: return (long) 0;
                case -1: __PYX_VERIFY_RETURN_INT(long, sdigit, (sdigit) (-(sdigit)digits[0]))
                case  1: __PYX_VERIFY_RETURN_INT(long,  digit, +digits[0])
                case -2:
                    if (8 * sizeof(long) - 1 > 1 * PyLong_SHIFT) {
                        if (8 * sizeof(unsigned long) > 2 * PyLong_SHIFT) {
                            __PYX_VERIFY_RETURN_INT(long, long, -(long) (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
                        } else if (8 * sizeof(long) - 1 > 2 * PyLong_SHIFT) {
                            return (long) (((long)-1)*(((((long)digits[1]) << PyLong_SHIFT) | (long)digits[0])));
                        }
                    }
                    break;
                case 2:
                    if (8 * sizeof(long) > 1 * PyLong_SHIFT) {
                        if (8 * sizeof(unsigned long) > 2 * PyLong_SHIFT) {
                            __PYX_VERIFY_RETURN_INT(long, unsigned long, (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
                        } else if (8 * sizeof(long) - 1 > 2 * PyLong_SHIFT) {
                            return (long) ((((((long)digits[1]) << PyLong_SHIFT) | (long)digits[0])));
                        }
                    }
                    break;
                case -3:
                    if (8 * sizeof(long) - 1 > 2 * PyLong_SHIFT) {
                        if (8 * sizeof(unsigned long) > 3 * PyLong_SHIFT) {
                            __PYX_VERIFY_RETURN_INT(long, long, -(long) (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
                        } else if (8 * sizeof(long) - 1 > 3 * PyLong_SHIFT) {
                            return (long) (((long)-1)*(((((((long)digits[2]) << PyLong_SHIFT) | (long)digits[1]) << PyLong_SHIFT) | (long)digits[0])));
                        }
                    }
                    break;
                case 3:
                    if (8 * sizeof(long) > 2 * PyLong_SHIFT) {
                        if (8 * sizeof(unsigned long) > 3 * PyLong_SHIFT) {
                            __PYX_VERIFY_RETURN_INT(long, unsigned long, (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
                        } else if (8 * sizeof(long) - 1 > 3 * PyLong_SHIFT) {
                            return (long) ((((((((long)digits[2]) << PyLong_SHIFT) | (long)digits[1]) << PyLong_SHIFT) | (long)digits[0])));
                        }
                    }
                    break;
                case -4:
                    if (8 * sizeof(long) - 1 > 3 * PyLong_SHIFT) {
                        if (8 * sizeof(unsigned long) > 4 * PyLong_SHIFT) {
                            __PYX_VERIFY_RETURN_INT(long, long, -(long) (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
                        } else if (8 * sizeof(long) - 1 > 4 * PyLong_SHIFT) {
                            return (long) (((long)-1)*(((((((((long)digits[3]) << PyLong_SHIFT) | (long)digits[2]) << PyLong_SHIFT) | (long)digits[1]) << PyLong_SHIFT) | (long)digits[0])));
                        }
                    }
                    break;
                case 4:
                    if (8 * sizeof(long) > 3 * PyLong_SHIFT) {
                        if (8 * sizeof(unsigned long) > 4 * PyLong_SHIFT) {
                            __PYX_VERIFY_RETURN_INT(long, unsigned long, (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
                        } else if (8 * sizeof(long) - 1 > 4 * PyLong_SHIFT) {
                            return (long) ((((((((((long)digits[3]) << PyLong_SHIFT) | (long)digits[2]) << PyLong_SHIFT) | (long)digits[1]) << PyLong_SHIFT) | (long)digits[0])));
                        }
                    }
                    break;
            }
#endif
            if (sizeof(long) <= sizeof(long)) {
                __PYX_VERIFY_RETURN_INT_EXC(long, long, PyLong_AsLong(x))
            } else if (sizeof(long) <= sizeof(PY_LONG_LONG)) {
                __PYX_VERIFY_RETURN_INT_EXC(long, PY_LONG_LONG, PyLong_AsLongLong(x))
            }
        }
        {
#if CYTHON_COMPILING_IN_PYPY && !defined(_PyLong_AsByteArray)
            PyErr_SetString(PyExc_RuntimeError,
                            "_PyLong_AsByteArray() not available in PyPy, cannot convert large numbers");
#else
            long val;
            PyObject *v = __Pyx_PyNumber_IntOrLong(x);
 #if PY_MAJOR_VERSION < 3
            if (likely(v) && !PyLong_Check(v)) {
                PyObject *tmp = v;
                v = PyNumber_Long(tmp);
                Py_DECREF(tmp);
            }
 #endif
            if (likely(v)) {
                int one = 1; int is_little = (int)*(unsigned char *)&one;
                unsigned char *bytes = (unsigned char *)&val;
                int ret = _PyLong_AsByteArray((PyLongObject *)v,
                                              bytes, sizeof(val),
                                              is_little, !is_unsigned);
                Py_DECREF(v);
                if (likely(!ret))
                    return val;
            }
#endif
            return (long) -1;
        }
    } else {
        long val;
        PyObject *tmp = __Pyx_PyNumber_IntOrLong(x);
        if (!tmp) return (long) -1;
        val = __Pyx_PyInt_As_long(tmp);
        Py_DECREF(tmp);
        return val;
    }
raise_overflow:
    PyErr_SetString(PyExc_OverflowError,
        "value too large to convert to long");
    return (long) -1;
raise_neg_overflow:
    PyErr_SetString(PyExc_OverflowError,
        "can't convert negative value to long");
    return (long) -1;
}

/* CheckBinaryVersion */
                    static int __Pyx_check_binary_version(void) {
    char ctversion[4], rtversion[4];
    PyOS_snprintf(ctversion, 4, "%d.%d", PY_MAJOR_VERSION, PY_MINOR_VERSION);
    PyOS_snprintf(rtversion, 4, "%s", Py_GetVersion());
    if (ctversion[0] != rtversion[0] || ctversion[2] != rtversion[2]) {
        char message[200];
        PyOS_snprintf(message, sizeof(message),
                      "compiletime version %s of module '%.100s' "
                      "does not match runtime version %s",
                      ctversion, __Pyx_MODULE_NAME, rtversion);
        return PyErr_WarnEx(NULL, message, 1);
    }
    return 0;
}

/* ModuleImport */
                    #ifndef __PYX_HAVE_RT_ImportModule
#define __PYX_HAVE_RT_ImportModule
static PyObject *__Pyx_ImportModule(const char *name) {
    PyObject *py_name = 0;
    PyObject *py_module = 0;
    py_name = __Pyx_PyIdentifier_FromString(name);
    if (!py_name)
        goto bad;
    py_module = PyImport_Import(py_name);
    Py_DECREF(py_name);
    return py_module;
bad:
    Py_XDECREF(py_name);
    return 0;
}
#endif

/* TypeImport */
                    #ifndef __PYX_HAVE_RT_ImportType
#define __PYX_HAVE_RT_ImportType
static PyTypeObject *__Pyx_ImportType(const char *module_name, const char *class_name,
    size_t size, int strict)
{
    PyObject *py_module = 0;
    PyObject *result = 0;
    PyObject *py_name = 0;
    char warning[200];
    Py_ssize_t basicsize;
#ifdef Py_LIMITED_API
    PyObject *py_basicsize;
#endif
    py_module = __Pyx_ImportModule(module_name);
    if (!py_module)
        goto bad;
    py_name = __Pyx_PyIdentifier_FromString(class_name);
    if (!py_name)
        goto bad;
    result = PyObject_GetAttr(py_module, py_name);
    Py_DECREF(py_name);
    py_name = 0;
    Py_DECREF(py_module);
    py_module = 0;
    if (!result)
        goto bad;
    if (!PyType_Check(result)) {
        PyErr_Format(PyExc_TypeError,
            "%.200s.%.200s is not a type object",
            module_name, class_name);
        goto bad;
    }
#ifndef Py_LIMITED_API
    basicsize = ((PyTypeObject *)result)->tp_basicsize;
#else
    py_basicsize = PyObject_GetAttrString(result, "__basicsize__");
    if (!py_basicsize)
        goto bad;
    basicsize = PyLong_AsSsize_t(py_basicsize);
    Py_DECREF(py_basicsize);
    py_basicsize = 0;
    if (basicsize == (Py_ssize_t)-1 && PyErr_Occurred())
        goto bad;
#endif
    if (!strict && (size_t)basicsize > size) {
        PyOS_snprintf(warning, sizeof(warning),
            "%s.%s size changed, may indicate binary incompatibility. Expected %zd, got %zd",
            module_name, class_name, basicsize, size);
        if (PyErr_WarnEx(NULL, warning, 0) < 0) goto bad;
    }
    else if ((size_t)basicsize != size) {
        PyErr_Format(PyExc_ValueError,
            "%.200s.%.200s has the wrong size, try recompiling. Expected %zd, got %zd",
            module_name, class_name, basicsize, size);
        goto bad;
    }
    return (PyTypeObject *)result;
bad:
    Py_XDECREF(py_module);
    Py_XDECREF(result);
    return NULL;
}
#endif

/* InitStrings */
                    static int __Pyx_InitStrings(__Pyx_StringTabEntry *t) {
    while (t->p) {
        #if PY_MAJOR_VERSION < 3
        if (t->is_unicode) {
            *t->p = PyUnicode_DecodeUTF8(t->s, t->n - 1, NULL);
        } else if (t->intern) {
            *t->p = PyString_InternFromString(t->s);
        } else {
            *t->p = PyString_FromStringAndSize(t->s, t->n - 1);
        }
        #else
        if (t->is_unicode | t->is_str) {
            if (t->intern) {
                *t->p = PyUnicode_InternFromString(t->s);
            } else if (t->encoding) {
                *t->p = PyUnicode_Decode(t->s, t->n - 1, t->encoding, NULL);
            } else {
                *t->p = PyUnicode_FromStringAndSize(t->s, t->n - 1);
            }
        } else {
            *t->p = PyBytes_FromStringAndSize(t->s, t->n - 1);
        }
        #endif
        if (!*t->p)
            return -1;
        ++t;
    }
    return 0;
}

static CYTHON_INLINE PyObject* __Pyx_PyUnicode_FromString(const char* c_str) {
    return __Pyx_PyUnicode_FromStringAndSize(c_str, (Py_ssize_t)strlen(c_str));
}
static CYTHON_INLINE char* __Pyx_PyObject_AsString(PyObject* o) {
    Py_ssize_t ignore;
    return __Pyx_PyObject_AsStringAndSize(o, &ignore);
}
static CYTHON_INLINE char* __Pyx_PyObject_AsStringAndSize(PyObject* o, Py_ssize_t *length) {
#if CYTHON_COMPILING_IN_CPYTHON && (__PYX_DEFAULT_STRING_ENCODING_IS_ASCII || __PYX_DEFAULT_STRING_ENCODING_IS_DEFAULT)
    if (
#if PY_MAJOR_VERSION < 3 && __PYX_DEFAULT_STRING_ENCODING_IS_ASCII
            __Pyx_sys_getdefaultencoding_not_ascii &&
#endif
            PyUnicode_Check(o)) {
#if PY_VERSION_HEX < 0x03030000
        char* defenc_c;
        PyObject* defenc = _PyUnicode_AsDefaultEncodedString(o, NULL);
        if (!defenc) return NULL;
        defenc_c = PyBytes_AS_STRING(defenc);
#if __PYX_DEFAULT_STRING_ENCODING_IS_ASCII
        {
            char* end = defenc_c + PyBytes_GET_SIZE(defenc);
            char* c;
            for (c = defenc_c; c < end; c++) {
                if ((unsigned char) (*c) >= 128) {
                    PyUnicode_AsASCIIString(o);
                    return NULL;
                }
            }
        }
#endif
        *length = PyBytes_GET_SIZE(defenc);
        return defenc_c;
#else
        if (__Pyx_PyUnicode_READY(o) == -1) return NULL;
#if __PYX_DEFAULT_STRING_ENCODING_IS_ASCII
        if (PyUnicode_IS_ASCII(o)) {
            *length = PyUnicode_GET_LENGTH(o);
            return PyUnicode_AsUTF8(o);
        } else {
            PyUnicode_AsASCIIString(o);
            return NULL;
        }
#else
        return PyUnicode_AsUTF8AndSize(o, length);
#endif
#endif
    } else
#endif
#if (!CYTHON_COMPILING_IN_PYPY) || (defined(PyByteArray_AS_STRING) && defined(PyByteArray_GET_SIZE))
    if (PyByteArray_Check(o)) {
        *length = PyByteArray_GET_SIZE(o);
        return PyByteArray_AS_STRING(o);
    } else
#endif
    {
        char* result;
        int r = PyBytes_AsStringAndSize(o, &result, length);
        if (unlikely(r < 0)) {
            return NULL;
        } else {
            return result;
        }
    }
}
static CYTHON_INLINE int __Pyx_PyObject_IsTrue(PyObject* x) {
   int is_true = x == Py_True;
   if (is_true | (x == Py_False) | (x == Py_None)) return is_true;
   else return PyObject_IsTrue(x);
}
static CYTHON_INLINE PyObject* __Pyx_PyNumber_IntOrLong(PyObject* x) {
  PyNumberMethods *m;
  const char *name = NULL;
  PyObject *res = NULL;
#if PY_MAJOR_VERSION < 3
  if (PyInt_Check(x) || PyLong_Check(x))
#else
  if (PyLong_Check(x))
#endif
    return __Pyx_NewRef(x);
  m = Py_TYPE(x)->tp_as_number;
#if PY_MAJOR_VERSION < 3
  if (m && m->nb_int) {
    name = "int";
    res = PyNumber_Int(x);
  }
  else if (m && m->nb_long) {
    name = "long";
    res = PyNumber_Long(x);
  }
#else
  if (m && m->nb_int) {
    name = "int";
    res = PyNumber_Long(x);
  }
#endif
  if (res) {
#if PY_MAJOR_VERSION < 3
    if (!PyInt_Check(res) && !PyLong_Check(res)) {
#else
    if (!PyLong_Check(res)) {
#endif
      PyErr_Format(PyExc_TypeError,
                   "__%.4s__ returned non-%.4s (type %.200s)",
                   name, name, Py_TYPE(res)->tp_name);
      Py_DECREF(res);
      return NULL;
    }
  }
  else if (!PyErr_Occurred()) {
    PyErr_SetString(PyExc_TypeError,
                    "an integer is required");
  }
  return res;
}
static CYTHON_INLINE Py_ssize_t __Pyx_PyIndex_AsSsize_t(PyObject* b) {
  Py_ssize_t ival;
  PyObject *x;
#if PY_MAJOR_VERSION < 3
  if (likely(PyInt_CheckExact(b))) {
    if (sizeof(Py_ssize_t) >= sizeof(long))
        return PyInt_AS_LONG(b);
    else
        return PyInt_AsSsize_t(x);
  }
#endif
  if (likely(PyLong_CheckExact(b))) {
    #if CYTHON_USE_PYLONG_INTERNALS
    const digit* digits = ((PyLongObject*)b)->ob_digit;
    const Py_ssize_t size = Py_SIZE(b);
    if (likely(__Pyx_sst_abs(size) <= 1)) {
        ival = likely(size) ? digits[0] : 0;
        if (size == -1) ival = -ival;
        return ival;
    } else {
      switch (size) {
         case 2:
           if (8 * sizeof(Py_ssize_t) > 2 * PyLong_SHIFT) {
             return (Py_ssize_t) (((((size_t)digits[1]) << PyLong_SHIFT) | (size_t)digits[0]));
           }
           break;
         case -2:
           if (8 * sizeof(Py_ssize_t) > 2 * PyLong_SHIFT) {
             return -(Py_ssize_t) (((((size_t)digits[1]) << PyLong_SHIFT) | (size_t)digits[0]));
           }
           break;
         case 3:
           if (8 * sizeof(Py_ssize_t) > 3 * PyLong_SHIFT) {
             return (Py_ssize_t) (((((((size_t)digits[2]) << PyLong_SHIFT) | (size_t)digits[1]) << PyLong_SHIFT) | (size_t)digits[0]));
           }
           break;
         case -3:
           if (8 * sizeof(Py_ssize_t) > 3 * PyLong_SHIFT) {
             return -(Py_ssize_t) (((((((size_t)digits[2]) << PyLong_SHIFT) | (size_t)digits[1]) << PyLong_SHIFT) | (size_t)digits[0]));
           }
           break;
         case 4:
           if (8 * sizeof(Py_ssize_t) > 4 * PyLong_SHIFT) {
             return (Py_ssize_t) (((((((((size_t)digits[3]) << PyLong_SHIFT) | (size_t)digits[2]) << PyLong_SHIFT) | (size_t)digits[1]) << PyLong_SHIFT) | (size_t)digits[0]));
           }
           break;
         case -4:
           if (8 * sizeof(Py_ssize_t) > 4 * PyLong_SHIFT) {
             return -(Py_ssize_t) (((((((((size_t)digits[3]) << PyLong_SHIFT) | (size_t)digits[2]) << PyLong_SHIFT) | (size_t)digits[1]) << PyLong_SHIFT) | (size_t)digits[0]));
           }
           break;
      }
    }
    #endif
    return PyLong_AsSsize_t(b);
  }
  x = PyNumber_Index(b);
  if (!x) return -1;
  ival = PyInt_AsSsize_t(x);
  Py_DECREF(x);
  return ival;
}
static CYTHON_INLINE PyObject * __Pyx_PyInt_FromSize_t(size_t ival) {
    return PyInt_FromSize_t(ival);
}


#endif /* Py_PYTHON_H */
